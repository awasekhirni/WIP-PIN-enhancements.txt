-- =============================================
-- PostgreSQL Schema for Social Networking Platform
-- Version: 2.0
-- Copyright 2025 All rights reserved Î² ORI Inc.
-- Created: 2025-08-15
-- Last Updated: 2025-08-15
--Author: Awase Khirni Syed
-- Description: Comprehensive schema for a Facebook-like social networking platform
--              with advanced features for data governance, analytics, and compliance
-- =============================================
-- Todo more
--- Activitypub integration
-- views, materialize views

-- Create the main schema
CREATE SCHEMA IF NOT EXISTS socialcandor_schema AUTHORIZATION CURRENT_USER;
COMMENT ON SCHEMA social IS 'Comprehensive social media platform database schema with advanced analytics, privacy, and moderation capabilities';


-- ========================================================================
-- Extensions
-- ========================================================================

CREATE EXTENSION IF NOT EXISTS "btree_gin";
COMMENT ON EXTENSION btree_gin IS 'Provides GIN index operator classes for B-tree equivalent behavior';

-- Geospatial capabilities for location-based features
CREATE EXTENSION IF NOT EXISTS "postgis" WITH SCHEMA public;
COMMENT ON EXTENSION "postgis" IS 'Adds geospatial data types and functions for location-based services, geo-fencing, proximity search, and spatial analytics';

CREATE EXTENSION IF NOT EXISTS "hstore";
COMMENT ON EXTENSION hstore IS 'Key-value store for flexible data storage';

CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";
COMMENT ON EXTENSION pg_stat_statements IS 'Tracks execution statistics of all SQL statements';


-- UUID Generation for distributed systems
CREATE EXTENSION IF NOT EXISTS "uuid-ossp" WITH SCHEMA pg_catalog;
COMMENT ON EXTENSION "uuid-ossp" IS 'Generates universally unique identifiers (UUIDs) for distributed systems requiring globally unique keys without coordination';

-- Cryptographic functions for security compliance
CREATE EXTENSION IF NOT EXISTS "pgcrypto" WITH SCHEMA pg_catalog;
COMMENT ON EXTENSION "pgcrypto" IS 'Provides cryptographic functions for password hashing (bcrypt), data encryption (PGP), and secure random number generation required for GDPR/CCPA compliance';

-- Trigram similarity for fuzzy search and typo tolerance
CREATE EXTENSION IF NOT EXISTS "pg_trgm" WITH SCHEMA pg_catalog;
COMMENT ON EXTENSION "pg_trgm" IS 'Enables fuzzy text matching using trigram similarity algorithms for robust search experiences tolerant of typos and partial matches';

-- GIN indexing for complex data types
CREATE EXTENSION IF NOT EXISTS "btree_gin" WITH SCHEMA pg_catalog;
COMMENT ON EXTENSION "btree_gin" IS 'Extends GIN indexes to support B-tree equivalent operations on composite types, critical for JSONB and array column indexing';

------------------------------------------------------------------------------------------------
-- Extension: Enable ltree for hierarchical path operations
-- Description: Provides hierarchical tree operations and path queries
-- Required for: posts_comments.thread_path column
-- Installation: Requires superuser privileges or extension whitelisting
-- Reference: PostgreSQL Documentation - ltree Extension
------------------------------------------------------------------------------------------------
CREATE EXTENSION IF NOT EXISTS ltree;

-- Key-value storage for flexible metadata
CREATE EXTENSION IF NOT EXISTS "hstore" WITH SCHEMA public;
COMMENT ON EXTENSION "hstore" IS 'Provides efficient key-value storage within single columns for flexible metadata schemas without rigid table structures';

-- Query performance analysis
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements" WITH SCHEMA pg_catalog;
COMMENT ON EXTENSION "pg_stat_statements" IS 'Tracks execution statistics of all SQL statements for performance tuning, query optimization, and identifying N+1 query patterns';

-- Time-series optimization for analytics
CREATE EXTENSION IF NOT EXISTS "timescaledb" WITH SCHEMA public;
COMMENT ON EXTENSION "timescaledb" IS 'Transforms PostgreSQL into a scalable time-series database with automatic partitioning, compression, and continuous aggregates for high-volume metrics';
--# Find where Homebrew installed TimescaleDB
-- brew install postgresql@17 timescaledb
-- # Edit postgresql.conf (located in your Postgres.app data directory)

-- # You'll need to add the TimescaleDB library to Postgres.app's configuration
-- # Edit postgresql.conf (located in your Postgres.app data directory)

---=========================================================================================================================================================

-- ========================================================================
-- ENUMERATED TYPES
-- ========================================================================

-- ========================================================================
-- Purpose: Enforce domain integrity and prevent invalid state transitions
-- Strategy: DROP/CREATE pattern with versioned naming for safe evolution
-- ========================================================================

-- Data classification levels per NIST SP 800-53
DO $$
BEGIN
  CREATE TYPE socialcandor_schema.data_classification AS ENUM (
    'PUBLIC',        -- No restrictions; freely shareable
    'INTERNAL',      -- For internal use only; no external distribution
    'CONFIDENTIAL',  -- Sensitive business information; limited distribution
    'RESTRICTED',    -- Highly sensitive; strict need-to-know basis
    'SECRET',        -- Critical assets; compartmentalized access
    'PII',           -- Personally Identifiable Information (GDPR/CCPA)
    'PHI',           -- Protected Health Information (HIPAA)
    'FINANCIAL'      -- Payment card/financial data (PCI-DSS)
  );
  EXCEPTION WHEN duplicate_object THEN NULL;
END $$;
COMMENT ON TYPE socialcandor_schema.data_classification IS 'NIST-aligned data classification framework governing access controls, retention policies, and breach notification requirements';

-- -- User engagement types with analytics dimensions
-- DO $$
-- BEGIN
--   CREATE TYPE socialcandor_schema.engagement_type AS ENUM (
--     'VIEW',          -- Content impression (passive consumption)
--     'LIKE',          -- Positive sentiment indicator
--     'COMMENT',       -- Active participation requiring cognitive effort
--     'SHARE',         -- Viral amplification signal
--     'SAVE',          -- Intent to revisit (high-value signal)
--     'CLICK',         -- Call-to-action conversion
--     'REPLY',         -- Conversation continuation
--     'MENTION',       -- Social graph expansion
--     'TAG',           -- Content categorization by users
--     'REACT'          -- Nuanced sentiment beyond binary like
--   );
--   EXCEPTION WHEN duplicate_object THEN NULL;
-- END $$;
-- COMMENT ON TYPE socialcandor_schema.engagement_type IS 'Standardized engagement taxonomy enabling cross-platform analytics, attribution modeling, and algorithmic weighting';

-- Incident severity levels aligned with ITIL framework
DO $$
BEGIN
  CREATE TYPE socialcandor_schema.incident_severity AS ENUM (
    'SEV1_CRITICAL',   -- Complete platform outage; revenue impact >$10k/hr
    'SEV2_MAJOR',      -- Significant degradation; core features impaired
    'SEV3_MODERATE',   -- Partial degradation; workaround available
    'SEV4_MINOR',      -- Cosmetic/non-critical issue; no user impact
    'SEV5_INFORMATIONAL' -- Monitoring alert requiring investigation
  );
  EXCEPTION WHEN duplicate_object THEN NULL;
END $$;
COMMENT ON TYPE socialcandor_schema.incident_severity IS 'ITIL-aligned severity framework driving SLA compliance, on-call escalation, and executive notification protocols';

------------------------------------------------------------------------------------------------
-- Enum: user_status
-- Description: Defines possible states of user accounts
-- Business Case: Manages user account lifecycle from registration to deletion
-- Feature Reference: US01 (User Management), GDPR01 (Data Subject Rights)
------------------------------------------------------------------------------------------------
CREATE TYPE socialcandor_schema.user_status AS ENUM (
    'PENDING_ACTIVATION',      -- Registered but not activated
    'ACTIVE',                  -- Active user
    'SUSPENDED',               -- Temporarily suspended
    'DEACTIVATED',             -- User deactivated account
    'BANNED',                  -- Permanently banned
    'ANONYMIZED',              -- GDPR-compliant anonymization
    'DELETED'                  -- Marked for deletion
);
COMMENT ON TYPE socialcandor_schema.user_status IS 'Defines user account lifecycle states';

------------------------------------------------------------------------------------------------
-- Enum: content_visibility
-- Description: Defines visibility levels for user-generated content
-- Business Case: Enables granular privacy controls for content sharing
-- Feature Reference: PRV01 (Privacy Controls), CNT01 (Content Management)
------------------------------------------------------------------------------------------------
CREATE TYPE socialcandor_schema.content_visibility AS ENUM (
    'PUBLIC',                  -- Visible to everyone
    'FRIENDS',                 -- Visible to friends only
    'FRIENDS_OF_FRIENDS',      -- Extended network
    'CUSTOM',                  -- Custom audience list
    'PRIVATE',                 -- Only the creator
    'UNLISTED'                 -- Accessible via direct link only
);
COMMENT ON TYPE socialcandor_schema.content_visibility IS 'Defines privacy levels for content sharing';

------------------------------------------------------------------------------------------------
-- Enum: notification_channel
-- Description: Defines delivery channels for notifications
-- Business Case: Supports multi-channel notification delivery with user preferences
-- Feature Reference: NTFC01 (Notification System), ENG01 (User Engagement)
------------------------------------------------------------------------------------------------
CREATE TYPE socialcandor_schema.notification_channel AS ENUM (
    'IN_APP',                  -- In-app notifications
    'EMAIL',                   -- Email delivery
    'PUSH',                    -- Mobile push notifications
    'SMS',                     -- Text messages
    'WHATSAPP',                -- WhatsApp messages
    'TELEGRAM'                 -- Telegram messages
);
COMMENT ON TYPE socialcandor_schema.notification_channel IS 'Defines notification delivery channels';

------------------------------------------------------------------------------------------------
-- Enum: moderation_severity
-- Description: Defines severity levels for content moderation
-- Business Case: Enables risk-based prioritization of moderation actions
-- Feature Reference: MOD01 (Content Moderation), SAF01 (Safety & Compliance)
------------------------------------------------------------------------------------------------
CREATE TYPE socialcandor_schema.moderation_severity AS ENUM (
    'LOW',                     -- Minor policy violation
    'MEDIUM',                  -- Moderate violation
    'HIGH',                    -- Serious violation
    'CRITICAL',                -- Emergency/illegal content
    'IMMEDIATE'                -- Requires immediate action
);
COMMENT ON TYPE socialcandor_schema.moderation_severity IS 'Defines severity levels for content moderation';

------------------------------------------------------------------------------------------------
-- Enum: relationship_type
-- Description: Defines types of social relationships between users
-- Business Case: Supports complex social graphs beyond simple friendships
-- Feature Reference: REL01 (Relationship Management), NET01 (Network Effects)
------------------------------------------------------------------------------------------------
CREATE TYPE socialcandor_schema.relationship_type AS ENUM (
    'FRIEND',                  -- Mutual friendship
    'FOLLOWER',                -- One-way following
    'FAMILY',                  -- Family relationship
    'COLLEAGUE',               -- Professional colleague
    'CLASSMATE',               -- Educational connection
    'MENTOR',                  -- Mentor-mentee relationship
    'BLOCKED',                 -- Blocked relationship
    'MUTED'                    -- Muted (no notifications)
);
COMMENT ON TYPE socialcandor_schema.relationship_type IS 'Defines types of social relationships between users';



------------------------------------------------------------------------------------------------
-- Enum: consent_status
-- Description: Defines GDPR-compliant consent states
-- Business Case: Manages user consent for data processing activities
-- Feature Reference: GDPR01 (Consent Management), PRV01 (Privacy Compliance)
------------------------------------------------------------------------------------------------
CREATE TYPE socialcandor_schema.consent_status AS ENUM (
    'GRANTED',                 -- Explicit consent given
    'DENIED',                  -- Explicit consent denied
    'WITHDRAWN',               -- Previously granted, now withdrawn
    'EXPIRED',                 -- Consent has expired
    'PENDING',                 -- Consent request pending
    'IMPLICIT',                -- Implied consent (legitimate interest)
    'NOT_REQUIRED'             -- Consent not required by law
);
COMMENT ON TYPE socialcandor_schema.consent_status IS 'Defines GDPR-compliant consent statuses';

------------------------------------------------------------------------------------------------
-- Enum: content_type
-- Description: Defines types of user-generated content
-- Business Case: Enables type-specific processing and rendering
-- Feature Reference: CNT01 (Content Management), MED01 (Media Processing)
------------------------------------------------------------------------------------------------
CREATE TYPE socialcandor_schema.content_type AS ENUM (
    'TEXT',                    -- Text-only content
    'IMAGE',                   -- Image post
    'VIDEO',                   -- Video content
    'LINK',                    -- Shared link
    'POLL',                    -- Interactive poll
    'EVENT',                   -- Event announcement
    'LIVE',                    -- Live stream
    'AUDIO',                   -- Audio content
    'STORY',                   -- Ephemeral content (24h)
    'REEL',                    -- Short-form video
    'ARTICLE',                 -- Long-form article
    'QUESTION',                -- Q&A format
    'JOB_POSTING'              -- Job opportunity
);
COMMENT ON TYPE socialcandor_schema.content_type IS 'Defines types of user-generated content';

------------------------------------------------------------------------------------------------
-- Enum: session_status
-- Description: Defines authentication session states
-- Business Case: Manages user authentication lifecycle and security
-- Feature Reference: AUTH01 (Authentication), SEC01 (Session Security)
------------------------------------------------------------------------------------------------
CREATE TYPE socialcandor_schema.session_status AS ENUM (
    'ACTIVE',                  -- Currently active session
    'EXPIRED',                 -- Session expired naturally
    'REVOKED',                 -- Manually revoked
    'COMPROMISED',             -- Suspected compromise
    'REFRESHED',               -- Token refreshed
    'IDLE'                     -- Inactive but valid
);
COMMENT ON TYPE socialcandor_schema.session_status IS 'Defines authentication session states';
--------------------------------------------
-- Ensure the content_visibility enum type exists 
--------------------------------------------
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'content_visibility') THEN
        CREATE TYPE socialcandor_schema.content_visibility AS ENUM (
            'PUBLIC', 'PRIVATE', 'FRIENDS', 'FOLLOWERS', 'CUSTOM'
        );
    END IF;
END $$;

------------------------------------------------------------------------------------------------
-- Enum: engagement_type
-- Description: Defines types of user engagement with content
-- Business Case: Tracks detailed engagement metrics for analytics
-- Feature Reference: ENG01 (Engagement Analytics), REC01 (Recommendation System)
------------------------------------------------------------------------------------------------
CREATE TYPE socialcandor_schema.engagement_type AS ENUM (
    'VIEW',                    -- Content viewed
    'LIKE',                    -- Positive reaction
    'COMMENT',                 -- Comment posted
    'SHARE',                   -- Content shared
    'SAVE',                    -- Content saved/bookmarked
    'CLICK',                   -- Link/CTR clicked
    'FOLLOW',                  -- Creator followed
    'REPORT',                  -- Content reported
    'HIDE',                    -- Content hidden
    'MUTE',                    -- Creator muted
    'BLOCK',                   -- Creator blocked
    'TIP',                     -- Financial tip
    'PAID SUBSCRIBE',          -- Paid subscription
    'REACTION',                 -- Emoji reaction
	'VULGAR COMMENT',           -- Vulgar Comment
	'UNPAID SUBSCRIBE',         -- Unpaid subscription
	'LOL',        			   -- Laugh out aloud
	'STAN',        			   -- Stalker and fan
	'DANK',        			   -- Excellent or very high quality
	'GHOSTING',        		   -- GHOSTING
	'SALTY',        			   -- FEELING JEALOUS
	'FINNA',        			   -- I AM GOING TO
	'YIKES',        			   -- EMBARRASSED
	'BOUJEE',        		   -- Extravagant or fancy
	'CAP',        			   -- MEANS TO LIE
	'HIGH-KEY',        			-- HIGH-KEY
	'LOW-KEY',        			-- LOW-KEY
	'CHEUGY',        			-- NOT ALL TRENDY
	'SIMP',        			    -- Someone who does way too much for the person they have crush on
	'CAMP',        			    -- Something that is ironically trendy
	'WOKE',        			    -- Politically Aware
	'TFW',        			    -- That feeling when 
	'SNACK',        			    -- A person that you find attractive
	'SIP-TEA',        			-- Sitting back and listening to gossip "spilling the tea"
	'L',        					-- LOSER
	'TSS',        				-- If someone is really getting on your nerves
	'DRIP',        				-- COOL or Sexy trend style 
	'SWAG',        				-- COOL
	'BOP',        				-- When a song or album is exceptionally good
	'SHEESH',					-- hype someone up if they are looking good or doing something good 
	'IYKYK',						-- reference to an inside joke or something only a specific community might understand 
	'LIVE-RENT-FREE',			-- LIVING RENT FREE IN YOUR HEAD, YOU CANT STOP THINKING ABOUT IT
	'BET',						-- YES
	'VIBE CHECK',				-- TO CHECK SOMEONE'S ENERGY OR MOOD 
	'CATCH THESE HANDS',			-- CONTENTIOUS MATTER 
	'DRAG',						-- CRITICIZING OR MAKING FUN OF THEM 
	'FINESSE',					-- TO TRICK OR MANIPULATE SOMEONE OR A SITUATION IN ORDER TO GET WHAT YOU WANT 
	'IM-WEAK',					-- USED WHEN YOU FIND SOMETHING HILARIOUS 
	'SLAPS',						-- USED TO DESCRIBE HOW EXCEPTIONAL SOMETHING IS 
	'BUSSIN',					-- WHEN YOU TASTE SOMETHING DELICIOUS 
	'SUS',						-- SUSPICIOUS
	'GUAP',						-- MONEY AND LOTS OF IT 
	'SMOL',						-- SMALL AND EXCEPTIONALLY ADORABLE
	'CLAPBACK',					-- A RESPONSE OR COMEBACK AFTER YOU HAVE BEEN CALLED OUT FOR SOMETHING 
	'GOAT'						-- THE GREATEST OF ALL TIM
);
COMMENT ON TYPE socialcandor_schema.engagement_type IS 'Defines types of user engagement with content';

-- ========================================================================
-- TABLE DEFINITIONS
-- ========================================================================

------------------------------------------------------------------------------------------------
-- Table: 1 - users
-- Description: Core identity repository storing authenticated user profiles
-- Business Case: Central user identity management system supporting GDPR compliance, consent
-- tracking, and secure account lifecycle management. Enables personalized experiences while
-- maintaining regulatory compliance across global markets (EU GDPR, UK DPA, CCPA). Supports
-- user data sovereignty with location-based retention policies and consent management.
-- Feature Reference: US01 (User Management), GDPR01 (Data Subject Rights), PRV01 (Privacy)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.users (
    -- Primary identifier
    user_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Identity information
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    email_verified BOOLEAN DEFAULT FALSE,
    phone VARCHAR(20),
    phone_verified BOOLEAN DEFAULT FALSE,
    display_name VARCHAR(100),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    full_name VARCHAR(200) GENERATED ALWAYS AS (first_name || ' ' || last_name) STORED,

    -- Authentication and security
    password_hash VARCHAR(255) NOT NULL,
    password_changed_at TIMESTAMP WITH TIME ZONE,
    mfa_enabled BOOLEAN DEFAULT FALSE,
    mfa_type VARCHAR(20) CHECK (mfa_type IN ('NONE', 'SMS', 'EMAIL', 'TOTP', 'FIDO2')),
    recovery_email VARCHAR(255),
    security_question_hash VARCHAR(255),

    -- Profile information
    profile_image_url VARCHAR(500),
    cover_image_url VARCHAR(500),
    bio TEXT,
    website VARCHAR(500),
    date_of_birth DATE,
    gender VARCHAR(50),
    preferred_language VARCHAR(10) DEFAULT 'en',
    timezone VARCHAR(50) DEFAULT 'UTC',

    -- GDPR and privacy
    gdpr_consent_status socialcandor_schema.consent_status DEFAULT 'PENDING',
    data_processing_consent BOOLEAN DEFAULT FALSE,
    marketing_consent BOOLEAN DEFAULT FALSE,
    third_party_sharing_consent BOOLEAN DEFAULT FALSE,
    data_retention_preference VARCHAR(20) DEFAULT 'STANDARD',
    auto_delete_period INTEGER DEFAULT 730, -- days

    -- Account status
    status socialcandor_schema.user_status DEFAULT 'PENDING_ACTIVATION',
    is_deleted BOOLEAN DEFAULT FALSE,
    deletion_requested_at TIMESTAMP WITH TIME ZONE,
    scheduled_deletion_date TIMESTAMP WITH TIME ZONE,

    -- Account security
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMP WITH TIME ZONE,
    last_password_reset TIMESTAMP WITH TIME ZONE,
    last_security_alert TIMESTAMP WITH TIME ZONE,

    -- Engagement tracking
    last_login_at TIMESTAMP WITH TIME ZONE,
    last_active_at TIMESTAMP WITH TIME ZONE,
    total_login_count INTEGER DEFAULT 0,
    
    -- Removed: account_age_days INTEGER GENERATED ALWAYS AS (EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))) STORED,
    -- Will be calculated at query time instead

    -- Monetization
    is_premium_user BOOLEAN DEFAULT FALSE,
    premium_since TIMESTAMP WITH TIME ZONE,
    premium_expires_at TIMESTAMP WITH TIME ZONE,
    virtual_currency_balance NUMERIC(15,2) DEFAULT 0,

    -- Verification and trust
    verified BOOLEAN DEFAULT FALSE,
    verification_level VARCHAR(20) DEFAULT 'BASIC',
    trust_score NUMERIC(5,2) DEFAULT 50.00 CHECK (trust_score >= 0 AND trust_score <= 100),
    spam_score NUMERIC(5,2) DEFAULT 0.00 CHECK (spam_score >= 0 AND spam_score <= 100),

    -- Location and jurisdiction
    registration_ip INET,
    registration_country VARCHAR(3),
    registration_user_agent TEXT,
    primary_country VARCHAR(3),
    legal_jurisdiction VARCHAR(50),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID DEFAULT uuid_nil(),
    updated_by UUID DEFAULT uuid_nil(),

    -- Indexes for performance
    CONSTRAINT users_email_lowercase CHECK (email = LOWER(email)),
    CONSTRAINT users_username_pattern CHECK (username ~ '^[a-zA-Z0-9_]{3,50}$'),
    CONSTRAINT users_valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'),
    CONSTRAINT users_age_check CHECK (
        date_of_birth IS NULL OR
        date_of_birth <= CURRENT_DATE - INTERVAL '13 years'
    )
);

-- Create sequence for legacy ID if needed
CREATE SEQUENCE IF NOT EXISTS socialcandor_schema.user_legacy_id_seq START WITH 100000;

-- Comments for users table
COMMENT ON TABLE socialcandor_schema.users IS 'Core identity repository for authenticated user profiles with GDPR-compliant consent tracking and account lifecycle management';
COMMENT ON COLUMN socialcandor_schema.users.user_id IS 'Universally unique identifier for the user';
COMMENT ON COLUMN socialcandor_schema.users.gdpr_consent_status IS 'GDPR consent status for data processing';
COMMENT ON COLUMN socialcandor_schema.users.trust_score IS 'Composite trust score based on behavior, verification, and reputation';
COMMENT ON COLUMN socialcandor_schema.users.auto_delete_period IS 'Number of days after deactivation before permanent deletion';

-- Indexes for users table
CREATE INDEX IF NOT EXISTS idx_users_email ON socialcandor_schema.users(email);
CREATE INDEX IF NOT EXISTS idx_users_username ON socialcandor_schema.users(username);
CREATE INDEX IF NOT EXISTS idx_users_status ON socialcandor_schema.users(status);
CREATE INDEX IF NOT EXISTS idx_users_created_at ON socialcandor_schema.users(created_at);
CREATE INDEX IF NOT EXISTS idx_users_last_active ON socialcandor_schema.users(last_active_at DESC);
CREATE INDEX IF NOT EXISTS idx_users_country_status ON socialcandor_schema.users(registration_country, status);
CREATE INDEX IF NOT EXISTS idx_users_trust_score ON socialcandor_schema.users(trust_score DESC) WHERE trust_score > 70;
CREATE INDEX IF NOT EXISTS idx_users_premium ON socialcandor_schema.users(premium_expires_at DESC) WHERE is_premium_user = TRUE;

-- Trigger for updated_at
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_users_updated_at
    BEFORE UPDATE ON socialcandor_schema.users
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();
	
	
	
------------------------------------------------------------------------------------------------
-- Table: 2 - users_sessions
-- Description: Manages active authentication sessions with security features
-- Business Case: Secure session management system preventing session hijacking and enabling
-- real-time security monitoring. Supports cross-device experiences while maintaining
-- compliance with session management best practices (OWASP). Includes device fingerprinting,
-- IP tracking, and automatic expiration for enhanced security.
-- Feature Reference: AUTH01 (Authentication), SEC01 (Session Security), COMP01 (Compliance)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.users_sessions (
    session_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Session information
    session_token VARCHAR(512) NOT NULL UNIQUE,
    refresh_token VARCHAR(512),
    session_status socialcandor_schema.session_status DEFAULT 'ACTIVE',
    device_id VARCHAR(255),
    device_name VARCHAR(100),
    device_type VARCHAR(50) CHECK (device_type IN ('WEB', 'MOBILE_IOS', 'MOBILE_ANDROID', 'DESKTOP', 'TABLET')),
    device_fingerprint TEXT,
    device_trust_score NUMERIC(5,2) DEFAULT 50.00 CHECK (device_trust_score >= 0 AND device_trust_score <= 100),

    -- Location and network
    ip_address INET NOT NULL,
    user_agent TEXT,
    browser VARCHAR(100),
    os VARCHAR(100),
    location_country VARCHAR(3),
    location_city VARCHAR(100),
    location_coordinates GEOGRAPHY(POINT, 4326),

    -- Session timing
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    last_activity_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    revoked_at TIMESTAMP WITH TIME ZONE,

    -- Security metrics
    is_compromised BOOLEAN DEFAULT FALSE,
    compromise_reason TEXT,
    failed_token_refresh_attempts INTEGER DEFAULT 0,
    mfa_used BOOLEAN DEFAULT FALSE,

    -- Activity tracking
    request_count INTEGER DEFAULT 0,
    last_request_path VARCHAR(500),
    last_request_method VARCHAR(10),

    -- Session metadata
    app_version VARCHAR(50),
    sdk_version VARCHAR(50),
    additional_metadata JSONB DEFAULT '{}',

    -- Audit fields
    created_by UUID DEFAULT uuid_nil(),
    updated_by UUID DEFAULT uuid_nil(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- Foreign key constraint
    CONSTRAINT fk_users_sessions_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_session_expiry CHECK (expires_at > created_at),
    CONSTRAINT chk_refresh_token_required CHECK (
        (session_status = 'ACTIVE' AND refresh_token IS NOT NULL) OR
        session_status != 'ACTIVE'
    )
);

COMMENT ON TABLE socialcandor_schema.users_sessions IS 'Manages active authentication sessions with device fingerprinting and security monitoring';
COMMENT ON COLUMN socialcandor_schema.users_sessions.device_fingerprint IS 'Cryptographic hash of device characteristics for fingerprinting';
COMMENT ON COLUMN socialcandor_schema.users_sessions.device_trust_score IS 'Risk assessment score based on device behavior and history';

-- Indexes for users_sessions
CREATE INDEX IF NOT EXISTS idx_users_sessions_user_id ON socialcandor_schema.users_sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_users_sessions_expires_at ON socialcandor_schema.users_sessions(expires_at) WHERE session_status = 'ACTIVE';
CREATE INDEX IF NOT EXISTS idx_users_sessions_token ON socialcandor_schema.users_sessions(session_token);
CREATE INDEX IF NOT EXISTS idx_users_sessions_device ON socialcandor_schema.users_sessions(device_id, device_type);
CREATE INDEX IF NOT EXISTS idx_users_sessions_last_activity ON socialcandor_schema.users_sessions(last_activity_at DESC);
CREATE INDEX IF NOT EXISTS idx_users_sessions_ip_user ON socialcandor_schema.users_sessions(ip_address, user_id);
CREATE INDEX IF NOT EXISTS idx_users_sessions_compromised ON socialcandor_schema.users_sessions(is_compromised) WHERE is_compromised = TRUE;

-- Trigger for session activity updates
CREATE TRIGGER trg_users_sessions_updated_at
    BEFORE UPDATE ON socialcandor_schema.users_sessions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();
------------------------------------------------------------------------------------------------
-- Table: 3 - posts
-- Description: Primary content repository for user-generated content
-- Business Case: Centralized content management system supporting rich media, privacy controls,
-- and engagement tracking. Enables algorithmic feed ranking, content monetization, and
-- viral content detection. Supports creator economy through trending scores and
-- engagement velocity metrics for content discovery and promotion.
-- Feature Reference: CNT01 (Content Management), ENG01 (Engagement), REC01 (Recommendations)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.posts (
    post_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Content information
    content_type socialcandor_schema.content_type NOT NULL,
    content_text TEXT,
    content_html TEXT,
    language_code VARCHAR(10) DEFAULT 'en',
    
    -- Media flag (needed for the content check constraint)
    has_media BOOLEAN DEFAULT FALSE,

    -- Privacy and visibility
    visibility socialcandor_schema.content_visibility DEFAULT 'PUBLIC',
    custom_visibility_rule JSONB,
    is_encrypted BOOLEAN DEFAULT FALSE,
    encryption_key_id UUID,

    -- Location context
    location_name VARCHAR(255),
    location_coordinates GEOGRAPHY(POINT, 4326),
    location_precision INTEGER CHECK (location_precision >= 1 AND location_precision <= 100),

    -- Engagement metrics
    like_count INTEGER DEFAULT 0 CHECK (like_count >= 0),
    comment_count INTEGER DEFAULT 0 CHECK (comment_count >= 0),
    share_count INTEGER DEFAULT 0 CHECK (share_count >= 0),
    view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
    save_count INTEGER DEFAULT 0 CHECK (save_count >= 0),
    tip_amount_total NUMERIC(15,2) DEFAULT 0 CHECK (tip_amount_total >= 0),

    -- Algorithmic scores
    trending_score NUMERIC(10,6) DEFAULT 0.0,
    quality_score NUMERIC(5,2) DEFAULT 50.0 CHECK (quality_score >= 0 AND quality_score <= 100),
    engagement_velocity NUMERIC(10,2) DEFAULT 0.0,
    viral_coefficient NUMERIC(5,2) DEFAULT 0.0,

    -- Moderation status
    moderation_status VARCHAR(20) DEFAULT 'PENDING_REVIEW' CHECK (
        moderation_status IN ('PENDING_REVIEW', 'APPROVED', 'REJECTED', 'FLAGGED', 'UNDER_REVIEW', 'AUTO_APPROVED')
    ),
    moderation_score NUMERIC(5,2) DEFAULT 0.0 CHECK (moderation_score >= 0 AND moderation_score <= 100),
    last_moderated_at TIMESTAMP WITH TIME ZONE,

    -- Monetization
    is_monetized BOOLEAN DEFAULT FALSE,
    monetization_type VARCHAR(20) CHECK (monetization_type IN ('NONE', 'ADS', 'SUBSCRIPTION', 'TIP_JAR', 'SPONSORED')),
    revenue_share_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (revenue_share_percentage >= 0 AND revenue_share_percentage <= 100),

    -- Scheduling
    is_scheduled BOOLEAN DEFAULT FALSE,
    scheduled_for TIMESTAMP WITH TIME ZONE,
    published_at TIMESTAMP WITH TIME ZONE,

    -- Content lifecycle
    is_edited BOOLEAN DEFAULT FALSE,
    edit_count INTEGER DEFAULT 0,
    last_edited_at TIMESTAMP WITH TIME ZONE,
    is_pinned BOOLEAN DEFAULT FALSE,
    pinned_until TIMESTAMP WITH TIME ZONE,

    -- Expiration and archiving
    expires_at TIMESTAMP WITH TIME ZONE,
    is_archived BOOLEAN DEFAULT FALSE,
    archived_at TIMESTAMP WITH TIME ZONE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_posts_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_content_not_empty CHECK (
        content_text IS NOT NULL OR has_media = TRUE
    ),
    CONSTRAINT chk_schedule_validity CHECK (
        (is_scheduled = TRUE AND scheduled_for > created_at) OR
        is_scheduled = FALSE
    ),
    CONSTRAINT chk_publish_state CHECK (
        (published_at IS NULL AND scheduled_for IS NULL) OR
        published_at IS NOT NULL
    )
);

-- Create index for performance
CREATE INDEX IF NOT EXISTS idx_posts_user_id ON socialcandor_schema.posts(user_id);
CREATE INDEX IF NOT EXISTS idx_posts_created_at ON socialcandor_schema.posts(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_posts_trending_score ON socialcandor_schema.posts(trending_score DESC);
CREATE INDEX IF NOT EXISTS idx_posts_visibility ON socialcandor_schema.posts(visibility);
CREATE INDEX IF NOT EXISTS idx_posts_moderation_status ON socialcandor_schema.posts(moderation_status);
CREATE INDEX IF NOT EXISTS idx_posts_published_at ON socialcandor_schema.posts(published_at DESC) WHERE published_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_posts_scheduled_for ON socialcandor_schema.posts(scheduled_for) WHERE is_scheduled = TRUE;

-- Create spatial index for location queries
CREATE INDEX IF NOT EXISTS idx_posts_location ON socialcandor_schema.posts USING GIST(location_coordinates);

-- Create trigger function to update updated_at timestamp
CREATE OR REPLACE FUNCTION socialcandor_schema.update_posts_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger to automatically update updated_at
CREATE TRIGGER tr_posts_update_timestamp
    BEFORE UPDATE ON socialcandor_schema.posts
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_posts_updated_at();

-- Create trigger to update has_media flag when media is added/removed
-- (This would require a separate trigger function on the posts_media table)
CREATE OR REPLACE FUNCTION socialcandor_schema.update_post_has_media()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE socialcandor_schema.posts 
        SET has_media = TRUE 
        WHERE post_id = NEW.post_id;
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        UPDATE socialcandor_schema.posts 
        SET has_media = EXISTS (
            SELECT 1 FROM socialcandor_schema.posts_media 
            WHERE post_id = OLD.post_id
        )
        WHERE post_id = OLD.post_id;
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;



------------------------------------------------------------------------------------------------
-- Table: 4 - posts_media
-- Description: Stores multimedia attachments linked to posts
-- Business Case: Centralized media management system supporting format normalization,
-- thumbnail generation, and CDN integration. Optimizes media delivery performance
-- while maintaining content integrity for accessibility compliance and
-- cross-platform rendering consistency.
-- Feature Reference: MED01 (Media Processing), ACC01 (Accessibility), CDN01 (Content Delivery)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.posts_media (
    media_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    post_id UUID NOT NULL,
    user_id UUID NOT NULL,

    -- Media identification
    media_type VARCHAR(50) NOT NULL CHECK (
        media_type IN ('IMAGE', 'VIDEO', 'AUDIO', 'GIF', 'DOCUMENT', 'ARCHIVE')
    ),
    mime_type VARCHAR(100) NOT NULL,
    file_extension VARCHAR(10),
    original_filename VARCHAR(255),

    -- Storage information
    storage_provider VARCHAR(50) DEFAULT 'S3' CHECK (
        storage_provider IN ('S3', 'GCS', 'AZURE', 'CDN', 'LOCAL')
    ),
    storage_bucket VARCHAR(255),
    storage_key VARCHAR(500) NOT NULL,
    storage_region VARCHAR(50),

    -- Media metadata
    file_size_bytes BIGINT CHECK (file_size_bytes >= 0),
    duration_seconds NUMERIC(10,3) CHECK (duration_seconds >= 0),
    width_pixels INTEGER CHECK (width_pixels >= 0),
    height_pixels INTEGER CHECK (height_pixels >= 0),
    aspect_ratio NUMERIC(5,2),
    frame_rate NUMERIC(6,2) CHECK (frame_rate >= 0),
    bitrate_kbps INTEGER CHECK (bitrate_kbps >= 0),

    -- Processing status
    processing_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
        processing_status IN ('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'QUEUED')
    ),
    processing_attempts INTEGER DEFAULT 0,
    processing_error TEXT,

    -- Transformed versions
    thumbnail_url VARCHAR(500),
    preview_url VARCHAR(500),
    optimized_url VARCHAR(500),
    original_url VARCHAR(500),

    -- CDN information
    cdn_url VARCHAR(500),
    cdn_path VARCHAR(500),
    cdn_cache_key VARCHAR(255),

    -- Accessibility features
    alt_text VARCHAR(500),
    caption TEXT,
    transcript TEXT,
    language_code VARCHAR(10) DEFAULT 'en',

    -- Copyright and licensing
    copyright_holder VARCHAR(255),
    license_type VARCHAR(50),
    attribution_required BOOLEAN DEFAULT FALSE,
    commercial_use_allowed BOOLEAN DEFAULT FALSE,

    -- Security and privacy
    is_encrypted BOOLEAN DEFAULT FALSE,
    encryption_key_id UUID,
    watermark_applied BOOLEAN DEFAULT FALSE,
    nsfw_score NUMERIC(5,2) DEFAULT 0.0 CHECK (nsfw_score >= 0 AND nsfw_score <= 100),

    -- Analytics
    view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
    download_count INTEGER DEFAULT 0 CHECK (download_count >= 0),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    deleted_at TIMESTAMP WITH TIME ZONE,

    -- Foreign key constraints
    CONSTRAINT fk_posts_media_post FOREIGN KEY (post_id)
        REFERENCES socialcandor_schema.posts(post_id) ON DELETE CASCADE,
    CONSTRAINT fk_posts_media_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_media_dimensions CHECK (
        (media_type != 'IMAGE' AND media_type != 'VIDEO') OR
        (width_pixels > 0 AND height_pixels > 0)
    ),
    CONSTRAINT chk_file_size_limit CHECK (file_size_bytes <= 10737418240) -- 10GB limit
);

COMMENT ON TABLE socialcandor_schema.posts_media IS 'Stores multimedia attachments with processing metadata and CDN integration';
COMMENT ON COLUMN socialcandor_schema.posts_media.nsfw_score IS 'AI-generated score indicating Not Safe For Work content probability';

-- Indexes for posts_media
CREATE INDEX IF NOT EXISTS idx_posts_media_post_id ON socialcandor_schema.posts_media(post_id);
CREATE INDEX IF NOT EXISTS idx_posts_media_user_id ON socialcandor_schema.posts_media(user_id);
CREATE INDEX IF NOT EXISTS idx_posts_media_type ON socialcandor_schema.posts_media(media_type);
CREATE INDEX IF NOT EXISTS idx_posts_media_processing ON socialcandor_schema.posts_media(processing_status);
CREATE INDEX IF NOT EXISTS idx_posts_media_created_at ON socialcandor_schema.posts_media(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_posts_media_size_type ON socialcandor_schema.posts_media(media_type, file_size_bytes);
CREATE INDEX IF NOT EXISTS idx_posts_media_cdn ON socialcandor_schema.posts_media(cdn_url) WHERE cdn_url IS NOT NULL;

-- Trigger for posts_media updated_at
CREATE TRIGGER trg_posts_media_updated_at
    BEFORE UPDATE ON socialcandor_schema.posts_media
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();


------------------------------------------------------------------------------------------------
-- Table: 5 - posts_comments
-- Description: Hierarchical comment system with moderation support
-- Business Case: Enables threaded conversations and community engagement while
-- supporting toxicity detection through AI moderation pipelines. Maintains
-- edit history tracking for accountability and supports nested discussions
-- for complex conversations.
-- Feature Reference: COM01 (Comment System), MOD01 (Moderation), ENG01 (Engagement)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.posts_comments (
    comment_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    post_id UUID NOT NULL,
    user_id UUID NOT NULL,
    parent_comment_id UUID,

    -- Content
    comment_text TEXT NOT NULL,
    comment_html TEXT,
    language_code VARCHAR(10) DEFAULT 'en',

    -- Hierarchy management
    comment_depth INTEGER DEFAULT 0 CHECK (comment_depth >= 0),
    thread_path LTREE,
    child_count INTEGER DEFAULT 0 CHECK (child_count >= 0),

    -- Engagement metrics
    like_count INTEGER DEFAULT 0 CHECK (like_count >= 0),
    reply_count INTEGER DEFAULT 0 CHECK (reply_count >= 0),
    report_count INTEGER DEFAULT 0 CHECK (report_count >= 0),
    sentiment_score NUMERIC(5,2) CHECK (sentiment_score >= -1 AND sentiment_score <= 1),

    -- Moderation
    moderation_status VARCHAR(20) DEFAULT 'PENDING_REVIEW' CHECK (
        moderation_status IN ('PENDING_REVIEW', 'APPROVED', 'REJECTED', 'FLAGGED', 'HIDDEN', 'DELETED')
    ),
    moderation_score NUMERIC(5,2) DEFAULT 0.0 CHECK (moderation_score >= 0 AND moderation_score <= 100),
    toxicity_score NUMERIC(5,2) DEFAULT 0.0 CHECK (toxicity_score >= 0 AND toxicity_score <= 100),
    spam_score NUMERIC(5,2) DEFAULT 0.0 CHECK (spam_score >= 0 AND spam_score <= 100),
    last_moderated_at TIMESTAMP WITH TIME ZONE,

    -- Edit history
    is_edited BOOLEAN DEFAULT FALSE,
    edit_count INTEGER DEFAULT 0,
    last_edited_at TIMESTAMP WITH TIME ZONE,
    previous_versions JSONB DEFAULT '[]',

    -- Mentions and references
    mentioned_users UUID[] DEFAULT '{}',
    referenced_comments UUID[] DEFAULT '{}',

    -- Pinning and highlighting
    is_pinned BOOLEAN DEFAULT FALSE,
    is_highlighted BOOLEAN DEFAULT FALSE,
    pinned_by UUID,
    highlighted_by UUID,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    deleted_at TIMESTAMP WITH TIME ZONE,
    deleted_by UUID,

    -- Foreign key constraints
    CONSTRAINT fk_posts_comments_post FOREIGN KEY (post_id)
        REFERENCES socialcandor_schema.posts(post_id) ON DELETE CASCADE,
    CONSTRAINT fk_posts_comments_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_posts_comments_parent FOREIGN KEY (parent_comment_id)
        REFERENCES socialcandor_schema.posts_comments(comment_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_comment_not_empty CHECK (LENGTH(TRIM(comment_text)) > 0),
    CONSTRAINT chk_depth_limit CHECK (comment_depth <= 20),
    CONSTRAINT chk_sentiment_range CHECK (sentiment_score >= -1 AND sentiment_score <= 1)
);

------------------------------------------------------------------------------------------------
-- Table Documentation
------------------------------------------------------------------------------------------------
COMMENT ON TABLE socialcandor_schema.posts_comments IS 
'Hierarchical comment system supporting threaded conversations with AI-powered moderation.
Supports nested discussions up to 20 levels deep with efficient path-based queries.
Maintains comprehensive engagement metrics and edit history for content accountability.';

COMMENT ON COLUMN socialcandor_schema.posts_comments.comment_id IS 'Primary identifier for the comment';
COMMENT ON COLUMN socialcandor_schema.posts_comments.post_id IS 'Reference to parent post for content context';
COMMENT ON COLUMN socialcandor_schema.posts_comments.user_id IS 'Author of the comment';
COMMENT ON COLUMN socialcandor_schema.posts_comments.parent_comment_id IS 'Parent comment ID for threaded discussions (NULL for top-level comments)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.comment_text IS 'Plain text content of the comment (required)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.comment_html IS 'HTML formatted content with rich media support';
COMMENT ON COLUMN socialcandor_schema.posts_comments.language_code IS 'ISO language code for content classification (default: en)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.comment_depth IS 'Nesting depth from root comment (0 for top-level)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.thread_path IS 'LTREE path for efficient hierarchical queries and tree operations';
COMMENT ON COLUMN socialcandor_schema.posts_comments.child_count IS 'Number of direct child replies for performance optimization';
COMMENT ON COLUMN socialcandor_schema.posts_comments.like_count IS 'Total likes received on this comment';
COMMENT ON COLUMN socialcandor_schema.posts_comments.reply_count IS 'Total direct replies to this comment';
COMMENT ON COLUMN socialcandor_schema.posts_comments.report_count IS 'Number of times this comment has been reported';
COMMENT ON COLUMN socialcandor_schema.posts_comments.sentiment_score IS 'AI-generated sentiment analysis score (-1 to 1)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.moderation_status IS 'Current moderation state (PENDING_REVIEW, APPROVED, etc.)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.moderation_score IS 'Confidence score from moderation AI (0-100)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.toxicity_score IS 'Probability score indicating toxic content (0-100)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.spam_score IS 'Probability score indicating spam content (0-100)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.last_moderated_at IS 'Timestamp of last moderation action';
COMMENT ON COLUMN socialcandor_schema.posts_comments.is_edited IS 'Flag indicating if comment has been edited';
COMMENT ON COLUMN socialcandor_schema.posts_comments.edit_count IS 'Total number of edits made to this comment';
COMMENT ON COLUMN socialcandor_schema.posts_comments.last_edited_at IS 'Timestamp of most recent edit';
COMMENT ON COLUMN socialcandor_schema.posts_comments.previous_versions IS 'JSON array storing previous comment versions for audit trail';
COMMENT ON COLUMN socialcandor_schema.posts_comments.mentioned_users IS 'Array of user IDs mentioned in this comment';
COMMENT ON COLUMN socialcandor_schema.posts_comments.referenced_comments IS 'Array of comment IDs referenced in this comment';
COMMENT ON COLUMN socialcandor_schema.posts_comments.is_pinned IS 'Flag indicating if comment is pinned by post author';
COMMENT ON COLUMN socialcandor_schema.posts_comments.is_highlighted IS 'Flag indicating if comment is highlighted by moderators';
COMMENT ON COLUMN socialcandor_schema.posts_comments.pinned_by IS 'User ID who pinned this comment (typically post author)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.highlighted_by IS 'User ID who highlighted this comment (moderator/admin)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.created_at IS 'Timestamp when comment was created';
COMMENT ON COLUMN socialcandor_schema.posts_comments.updated_at IS 'Timestamp when comment was last updated';
COMMENT ON COLUMN socialcandor_schema.posts_comments.created_by IS 'User ID who created the comment (matches user_id)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.updated_by IS 'User ID who last updated the comment';
COMMENT ON COLUMN socialcandor_schema.posts_comments.deleted_at IS 'Soft delete timestamp (NULL for active comments)';
COMMENT ON COLUMN socialcandor_schema.posts_comments.deleted_by IS 'User ID who soft-deleted the comment';

------------------------------------------------------------------------------------------------
-- Indexes for posts_comments
-- Performance optimization for common query patterns
------------------------------------------------------------------------------------------------
-- Primary key index (automatically created with PRIMARY KEY constraint)

-- Foreign key indexes for join operations
CREATE INDEX IF NOT EXISTS idx_posts_comments_post_id 
    ON socialcandor_schema.posts_comments(post_id);

CREATE INDEX IF NOT EXISTS idx_posts_comments_user_id 
    ON socialcandor_schema.posts_comments(user_id);

CREATE INDEX IF NOT EXISTS idx_posts_comments_parent_id 
    ON socialcandor_schema.posts_comments(parent_comment_id) 
    WHERE parent_comment_id IS NOT NULL;

-- Temporal indexes for chronological queries
CREATE INDEX IF NOT EXISTS idx_posts_comments_created_at 
    ON socialcandor_schema.posts_comments(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_posts_comments_post_created 
    ON socialcandor_schema.posts_comments(post_id, created_at DESC);

-- Hierarchy indexes for tree operations
CREATE INDEX IF NOT EXISTS idx_posts_comments_thread_path 
    ON socialcandor_schema.posts_comments USING GIST(thread_path);

CREATE INDEX IF NOT EXISTS idx_posts_comments_depth 
    ON socialcandor_schema.posts_comments(comment_depth)
    WHERE comment_depth > 0;

-- Moderation indexes for content review workflows
CREATE INDEX IF NOT EXISTS idx_posts_comments_moderation 
    ON socialcandor_schema.posts_comments(moderation_status, moderation_score DESC)
    WHERE moderation_status IN ('PENDING_REVIEW', 'FLAGGED', 'UNDER_REVIEW');

CREATE INDEX IF NOT EXISTS idx_posts_comments_toxicity 
    ON socialcandor_schema.posts_comments(toxicity_score DESC)
    WHERE toxicity_score > 70;

CREATE INDEX IF NOT EXISTS idx_posts_comments_spam 
    ON socialcandor_schema.posts_comments(spam_score DESC)
    WHERE spam_score > 70;

-- Engagement indexes for sorting and filtering
CREATE INDEX IF NOT EXISTS idx_posts_comments_sentiment 
    ON socialcandor_schema.posts_comments(sentiment_score DESC)
    WHERE sentiment_score IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_posts_comments_engagement 
    ON socialcandor_schema.posts_comments(like_count DESC, created_at DESC)
    WHERE moderation_status = 'APPROVED';

CREATE INDEX IF NOT EXISTS idx_posts_comments_reports 
    ON socialcandor_schema.posts_comments(report_count DESC)
    WHERE report_count > 0;

-- Soft delete index for cleanup operations
CREATE INDEX IF NOT EXISTS idx_posts_comments_deleted 
    ON socialcandor_schema.posts_comments(deleted_at)
    WHERE deleted_at IS NOT NULL;

-- Language index for localization
CREATE INDEX IF NOT EXISTS idx_posts_comments_language 
    ON socialcandor_schema.posts_comments(language_code, post_id)
    WHERE language_code != 'en';

------------------------------------------------------------------------------------------------
-- Trigger: trg_update_comment_thread_path
-- Description: Automatically manages thread_path and comment_depth for hierarchical comments
-- Business Case: Ensures consistent hierarchical structure for nested conversations
-- Supports efficient tree-based queries and path operations using LTREE extension
-- Execution: BEFORE INSERT on posts_comments table
-- Time Complexity: O(1) with proper indexing on parent_comment_id
-- Feature Reference: COM01 (Comment System), PER01 (Performance)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION socialcandor_schema.update_comment_thread_path()
RETURNS TRIGGER
SECURITY DEFINER
SET search_path = socialcandor_schema, public
LANGUAGE plpgsql
AS $$
DECLARE
    parent_path LTREE;
    parent_depth INTEGER;
BEGIN
    -- For root comments (no parent)
    IF NEW.parent_comment_id IS NULL THEN
        NEW.thread_path := text2ltree(NEW.comment_id::text);
        NEW.comment_depth := 0;
    ELSE
        -- Get parent's thread_path and depth
        SELECT thread_path, comment_depth + 1
        INTO parent_path, parent_depth
        FROM socialcandor_schema.posts_comments
        WHERE comment_id = NEW.parent_comment_id
          AND deleted_at IS NULL;
        
        -- Check if parent exists and is not deleted
        IF parent_path IS NULL THEN
            RAISE EXCEPTION 
                'Parent comment % does not exist or has been deleted', 
                NEW.parent_comment_id;
        END IF;
        
        -- Check depth limit
        IF parent_depth > 19 THEN
            RAISE EXCEPTION 
                'Comment hierarchy depth limit exceeded. Maximum depth is 20 levels';
        END IF;
        
        -- Build thread_path: parent_path.comment_id
        NEW.thread_path := parent_path || text2ltree(NEW.comment_id::text);
        NEW.comment_depth := parent_depth;
        
        -- Increment parent's child count (handled by separate trigger for performance)
    END IF;
    
    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        RAISE LOG 'Thread path update failed for comment: %, parent: %, error: %',
            NEW.comment_id, NEW.parent_comment_id, SQLERRM;
        RAISE;
END;
$$;

CREATE TRIGGER trg_posts_comments_thread_path
    BEFORE INSERT ON socialcandor_schema.posts_comments
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_comment_thread_path();

------------------------------------------------------------------------------------------------
-- Trigger: trg_update_parent_child_count
-- Description: Maintains child_count on parent comments for performance optimization
-- Business Case: Eliminates COUNT() queries when displaying comment threads
-- Provides immediate child count for UI rendering without expensive aggregation
-- Execution: AFTER INSERT OR DELETE on posts_comments table
-- Time Complexity: O(1) with proper indexing
-- Feature Reference: COM01 (Comment System), PER01 (Performance)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION socialcandor_schema.update_parent_child_count()
RETURNS TRIGGER
SECURITY DEFINER
SET search_path = socialcandor_schema, public
LANGUAGE plpgsql
AS $$
BEGIN
    -- Increment parent's child_count on INSERT
    IF TG_OP = 'INSERT' AND NEW.parent_comment_id IS NOT NULL THEN
        UPDATE socialcandor_schema.posts_comments
        SET child_count = child_count + 1,
            reply_count = reply_count + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE comment_id = NEW.parent_comment_id
          AND deleted_at IS NULL;
    
    -- Decrement parent's child_count on DELETE
    ELSIF TG_OP = 'DELETE' AND OLD.parent_comment_id IS NOT NULL THEN
        UPDATE socialcandor_schema.posts_comments
        SET child_count = GREATEST(child_count - 1, 0),
            reply_count = GREATEST(reply_count - 1, 0),
            updated_at = CURRENT_TIMESTAMP
        WHERE comment_id = OLD.parent_comment_id
          AND deleted_at IS NULL;
    END IF;
    
    RETURN NULL;
EXCEPTION
    WHEN OTHERS THEN
        RAISE LOG 'Child count update failed for operation: %, comment: %, error: %',
            TG_OP, COALESCE(NEW.comment_id, OLD.comment_id), SQLERRM;
        RETURN NULL;
END;
$$;

CREATE TRIGGER trg_posts_comments_child_count
    AFTER INSERT OR DELETE ON socialcandor_schema.posts_comments
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_parent_child_count();

------------------------------------------------------------------------------------------------
-- Trigger: trg_posts_comments_updated_at
-- Description: Standard timestamp updater for audit trail
-- Business Case: Maintains accurate last-modified timestamps for data consistency
-- Execution: BEFORE UPDATE on posts_comments table
-- Time Complexity: O(1)
-- Feature Reference: AUD01 (Audit Trail)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER
SECURITY DEFINER
SET search_path = socialcandor_schema, public
LANGUAGE plpgsql
AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$;

CREATE TRIGGER trg_posts_comments_updated_at
    BEFORE UPDATE ON socialcandor_schema.posts_comments
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Trigger: trg_posts_comments_edit_history
-- Description: Maintains edit history for accountability and compliance
-- Business Case: Supports content transparency and user trust through version tracking
-- Execution: BEFORE UPDATE on posts_comments table (when comment_text changes)
-- Storage: Previous versions stored as JSONB array for efficient querying
-- Feature Reference: AUD01 (Audit Trail), COM01 (Comment System)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION socialcandor_schema.update_comment_edit_history()
RETURNS TRIGGER
SECURITY DEFINER
SET search_path = socialcandor_schema, public
LANGUAGE plpgsql
AS $$
DECLARE
    version_entry JSONB;
BEGIN
    -- Check if comment_text was actually modified
    IF OLD.comment_text IS DISTINCT FROM NEW.comment_text THEN
        -- Create version entry
        version_entry := jsonb_build_object(
            'comment_text', OLD.comment_text,
            'comment_html', OLD.comment_html,
            'edited_at', OLD.updated_at,
            'edited_by', OLD.updated_by
        );
        
        -- Append to previous_versions array (limit to last 10 edits)
        NEW.previous_versions := (
            CASE 
                WHEN jsonb_array_length(OLD.previous_versions) >= 10 THEN
                    version_entry || OLD.previous_versions[1:9]
                ELSE
                    version_entry || OLD.previous_versions
            END
        );
        
        -- Update edit metadata
        NEW.is_edited := TRUE;
        NEW.edit_count := OLD.edit_count + 1;
        NEW.last_edited_at := CURRENT_TIMESTAMP;
    END IF;
    
    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        RAISE LOG 'Edit history update failed for comment: %, error: %',
            NEW.comment_id, SQLERRM;
        RETURN NEW;
END;
$$;

CREATE TRIGGER trg_posts_comments_edit_history
    BEFORE UPDATE OF comment_text, comment_html 
    ON socialcandor_schema.posts_comments
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_comment_edit_history();

------------------------------------------------------------------------------------------------
-- Table: 6 - friends
-- Description: Bidirectional friendship graph with mutual confirmation
-- Business Case: Manages reciprocal relationships forming the foundation for
-- privacy-aware content distribution. Supports network-based recommendations
-- while preventing asymmetric relationship exploitation through mutual
-- confirmation workflows.
-- Feature Reference: REL01 (Relationships), PRV01 (Privacy), REC01 (Recommendations)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.friends (
    friendship_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,
    friend_user_id UUID NOT NULL,

    -- Relationship status
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (
        status IN ('PENDING', 'ACCEPTED', 'REJECTED', 'BLOCKED', 'UNFRIENDED', 'EXPIRED')
    ),
    is_mutual BOOLEAN DEFAULT FALSE,

    -- Confirmation workflow
    requested_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    accepted_at TIMESTAMP WITH TIME ZONE,
    rejected_at TIMESTAMP WITH TIME ZONE,

    -- Relationship metadata
    relationship_strength NUMERIC(5,2) DEFAULT 50.0 CHECK (relationship_strength >= 0 AND relationship_strength <= 100),
    interaction_frequency INTEGER DEFAULT 0 CHECK (interaction_frequency >= 0),
    last_interaction_at TIMESTAMP WITH TIME ZONE,

    -- Privacy settings
    can_see_posts BOOLEAN DEFAULT TRUE,
    can_see_friends BOOLEAN DEFAULT TRUE,
    can_see_online_status BOOLEAN DEFAULT TRUE,
    can_send_messages BOOLEAN DEFAULT TRUE,

    -- Groups and categories
    friend_category VARCHAR(50),
    friend_group_id UUID,

    -- Notes and metadata
    personal_note TEXT,
    tags VARCHAR(50)[] DEFAULT '{}',

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_friends_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_friends_friend_user FOREIGN KEY (friend_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT uk_friends_relationship UNIQUE (user_id, friend_user_id),
    CONSTRAINT chk_friends_not_self CHECK (user_id != friend_user_id),
    CONSTRAINT chk_mutual_requires_accepted CHECK (
        (is_mutual = TRUE AND status = 'ACCEPTED') OR
        is_mutual = FALSE
    )
);

COMMENT ON TABLE socialcandor_schema.friends IS 'Bidirectional friendship graph with mutual confirmation workflow';
COMMENT ON COLUMN socialcandor_schema.friends.relationship_strength IS 'Algorithmic score based on interaction frequency and recency';

-- Indexes for friends table
CREATE INDEX IF NOT EXISTS idx_friends_user_id ON socialcandor_schema.friends(user_id);
CREATE INDEX IF NOT EXISTS idx_friends_friend_id ON socialcandor_schema.friends(friend_user_id);
CREATE INDEX IF NOT EXISTS idx_friends_status ON socialcandor_schema.friends(status);
CREATE INDEX IF NOT EXISTS idx_friends_mutual ON socialcandor_schema.friends(is_mutual) WHERE is_mutual = TRUE;
CREATE INDEX IF NOT EXISTS idx_friends_interaction ON socialcandor_schema.friends(last_interaction_at DESC);
CREATE INDEX IF NOT EXISTS idx_friends_strength ON socialcandor_schema.friends(relationship_strength DESC);
CREATE INDEX IF NOT EXISTS idx_friends_relationship ON socialcandor_schema.friends(user_id, friend_user_id, status);

-- Trigger for mutual friendship creation
CREATE OR REPLACE FUNCTION socialcandor_schema.create_mutual_friendship()
RETURNS TRIGGER AS $$
BEGIN
    -- When a friendship is accepted, create or update the reciprocal relationship
    IF NEW.status = 'ACCEPTED' AND NOT EXISTS (
        SELECT 1 FROM socialcandor_schema.friends
        WHERE user_id = NEW.friend_user_id
        AND friend_user_id = NEW.user_id
    ) THEN
        INSERT INTO socialcandor_schema.friends (
            user_id,
            friend_user_id,
            status,
            is_mutual,
            requested_at,
            accepted_at,
            created_by,
            updated_by
        ) VALUES (
            NEW.friend_user_id,
            NEW.user_id,
            'ACCEPTED',
            TRUE,
            NEW.requested_at,
            CURRENT_TIMESTAMP,
            NEW.created_by,
            NEW.updated_by
        );
    END IF;

    -- Update mutual flag on both sides
    IF NEW.status = 'ACCEPTED' THEN
        UPDATE socialcandor_schema.friends
        SET is_mutual = TRUE,
            updated_at = CURRENT_TIMESTAMP
        WHERE user_id = NEW.friend_user_id
        AND friend_user_id = NEW.user_id;

        NEW.is_mutual = TRUE;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_friends_mutual_creation
    AFTER UPDATE OF status ON socialcandor_schema.friends
    FOR EACH ROW
    WHEN (NEW.status = 'ACCEPTED')
    EXECUTE FUNCTION socialcandor_schema.create_mutual_friendship();

-- Trigger for updated_at
CREATE TRIGGER trg_friends_updated_at
    BEFORE UPDATE ON socialcandor_schema.friends
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 7 - followings
-- Description: Asymmetric follower graph for creator-audience relationships
-- Business Case: Supports influencer marketing ecosystems and content discovery
-- through asymmetric social dynamics distinct from reciprocal friendships.
-- Enables granular notification preferences and audience segmentation.
-- Feature Reference: REL02 (Following), CRE01 (Creator Economy), NTFC01 (Notifications)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.followings (
    following_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    follower_user_id UUID NOT NULL,  -- The user who is following
    following_user_id UUID NOT NULL,  -- The user being followed

    -- Following status
    is_active BOOLEAN DEFAULT TRUE,
    muted BOOLEAN DEFAULT FALSE,
    blocked BOOLEAN DEFAULT FALSE,

    -- Notification preferences
    notify_on_posts BOOLEAN DEFAULT TRUE,
    notify_on_stories BOOLEAN DEFAULT TRUE,
    notify_on_lives BOOLEAN DEFAULT TRUE,
    notification_frequency VARCHAR(20) DEFAULT 'REAL_TIME' CHECK (
        notification_frequency IN ('REAL_TIME', 'DAILY_DIGEST', 'WEEKLY_DIGEST', 'NONE')
    ),

    -- Engagement metrics
    engagement_score NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_score >= 0 AND engagement_score <= 100),
    posts_viewed INTEGER DEFAULT 0 CHECK (posts_viewed >= 0),
    stories_viewed INTEGER DEFAULT 0 CHECK (stories_viewed >= 0),
    last_engagement_at TIMESTAMP WITH TIME ZONE,

    -- Following metadata
    followed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    unfollowed_at TIMESTAMP WITH TIME ZONE,
    following_reason VARCHAR(100),
    source_channel VARCHAR(50) CHECK (
        source_channel IN ('SEARCH', 'RECOMMENDATION', 'SHARE', 'TRENDING', 'AD', 'ORGANIC')
    ),

    -- Categories and lists
    list_name VARCHAR(100),
    list_position INTEGER DEFAULT 0 CHECK (list_position >= 0),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_followings_follower FOREIGN KEY (follower_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_followings_following FOREIGN KEY (following_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT uk_followings_relationship UNIQUE (follower_user_id, following_user_id),
    CONSTRAINT chk_followings_not_self CHECK (follower_user_id != following_user_id),
    CONSTRAINT chk_following_timestamps CHECK (
        (unfollowed_at IS NULL) OR
        (unfollowed_at > followed_at)
    )
);

COMMENT ON TABLE socialcandor_schema.followings IS 'Asymmetric follower graph supporting creator-audience relationships';
COMMENT ON COLUMN socialcandor_schema.followings.engagement_score IS 'Metric measuring follower engagement with creator content';

-- Indexes for followings table
CREATE INDEX IF NOT EXISTS idx_followings_follower ON socialcandor_schema.followings(follower_user_id);
CREATE INDEX IF NOT EXISTS idx_followings_following ON socialcandor_schema.followings(following_user_id);
CREATE INDEX IF NOT EXISTS idx_followings_active ON socialcandor_schema.followings(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_followings_engagement ON socialcandor_schema.followings(engagement_score DESC);
CREATE INDEX IF NOT EXISTS idx_followings_followed_at ON socialcandor_schema.followings(followed_at DESC);
CREATE INDEX IF NOT EXISTS idx_followings_muted ON socialcandor_schema.followings(muted) WHERE muted = TRUE;

-- Materialized view for follower counts
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_user_follower_counts AS
SELECT
    following_user_id AS user_id,
    COUNT(*) AS follower_count,
    COUNT(*) FILTER (WHERE engagement_score > 70) AS engaged_follower_count,
    COUNT(*) FILTER (WHERE muted = FALSE) AS active_follower_count,
    MAX(followed_at) AS latest_follower_at
FROM socialcandor_schema.followings
WHERE is_active = TRUE
GROUP BY following_user_id
WITH DATA;

CREATE UNIQUE INDEX idx_mv_user_follower_counts_user ON socialcandor_schema.mv_user_follower_counts(user_id);

-- Trigger for updated_at
CREATE TRIGGER trg_followings_updated_at
    BEFORE UPDATE ON socialcandor_schema.followings
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 8 - conversations
-- Description: Unified messaging container for chats
-- Business Case: Supports both 1:1 and group chats with rich metadata and
-- synchronization capabilities. Provides foundation for real-time messaging
-- infrastructure with end-to-end encryption key management.
-- Feature Reference: MSG01 (Messaging), ENC01 (Encryption), SYNC01 (Synchronization)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.conversations (
    conversation_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Conversation identification
    conversation_type VARCHAR(20) NOT NULL DEFAULT 'DIRECT' CHECK (
        conversation_type IN ('DIRECT', 'GROUP', 'CHANNEL', 'BROADCAST')
    ),
    conversation_uuid VARCHAR(36) UNIQUE NOT NULL DEFAULT uuid_generate_v4()::text,

    -- Basic information
    title VARCHAR(255),
    description TEXT,
    avatar_url VARCHAR(500),

    -- Encryption and security
    is_encrypted BOOLEAN DEFAULT FALSE,
    encryption_key_id UUID,
    encryption_protocol VARCHAR(50),
    forward_secrecy_enabled BOOLEAN DEFAULT FALSE,

    -- Moderation settings
    is_moderated BOOLEAN DEFAULT FALSE,
    moderation_level VARCHAR(20) DEFAULT 'NONE' CHECK (
        moderation_level IN ('NONE', 'LIGHT', 'MODERATE', 'STRICT', 'LOCKED')
    ),
    slow_mode_delay_seconds INTEGER DEFAULT 0 CHECK (slow_mode_delay_seconds >= 0),

    -- Metadata and preferences
    theme_color VARCHAR(7),
    custom_emoji_set JSONB DEFAULT '[]',
    pinned_messages UUID[] DEFAULT '{}',
    last_message_preview TEXT,

    -- Activity tracking
    last_message_at TIMESTAMP WITH TIME ZONE,
    last_message_id UUID,
    total_message_count INTEGER DEFAULT 0 CHECK (total_message_count >= 0),
    total_participant_count INTEGER DEFAULT 0 CHECK (total_participant_count >= 0),

    -- Group-specific fields
    is_public BOOLEAN DEFAULT FALSE,
    invite_link VARCHAR(500),
    invite_link_expires_at TIMESTAMP WITH TIME ZONE,
    max_participants INTEGER DEFAULT 100 CHECK (max_participants >= 1 AND max_participants <= 100000),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    archived_at TIMESTAMP WITH TIME ZONE,

    -- Constraints
    CONSTRAINT chk_conversation_title CHECK (
        (conversation_type != 'DIRECT' AND title IS NOT NULL) OR
        conversation_type = 'DIRECT'
    ),
    CONSTRAINT chk_invite_link_validity CHECK (
        (invite_link IS NULL) OR
        (invite_link_expires_at IS NULL) OR
        (invite_link_expires_at > created_at)
    )
);

COMMENT ON TABLE socialcandor_schema.conversations IS 'Unified messaging container supporting both 1:1 and group chats';
COMMENT ON COLUMN socialcandor_schema.conversations.conversation_uuid IS 'Public UUID for external reference and API access';

-- Indexes for conversations table
CREATE INDEX IF NOT EXISTS idx_conversations_type ON socialcandor_schema.conversations(conversation_type);
CREATE INDEX IF NOT EXISTS idx_conversations_last_message ON socialcandor_schema.conversations(last_message_at DESC);
CREATE INDEX IF NOT EXISTS idx_conversations_created_by ON socialcandor_schema.conversations(created_by);
CREATE INDEX IF NOT EXISTS idx_conversations_encrypted ON socialcandor_schema.conversations(is_encrypted) WHERE is_encrypted = TRUE;
CREATE INDEX IF NOT EXISTS idx_conversations_public ON socialcandor_schema.conversations(is_public) WHERE is_public = TRUE;

-- Trigger for updated_at
CREATE TRIGGER trg_conversations_updated_at
    BEFORE UPDATE ON socialcandor_schema.conversations
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 9 - conversations_messages
-- Description: Message content storage with delivery tracking
-- Business Case: Stores message content with delivery/read receipts, edit history,
-- and media attachments. Supports message searchability through full-text indexing
-- while maintaining GDPR-compliant deletion capabilities.
-- Feature Reference: MSG02 (Message Storage), SRCH01 (Search), GDPR01 (Data Deletion)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.conversations_messages (
    message_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    conversation_id UUID NOT NULL,
    sender_user_id UUID NOT NULL,

    -- Message content
    message_type VARCHAR(20) NOT NULL DEFAULT 'TEXT' CHECK (
        message_type IN ('TEXT', 'IMAGE', 'VIDEO', 'AUDIO', 'FILE', 'LOCATION', 'CONTACT', 'POLL', 'SYSTEM')
    ),
    message_text TEXT,
    message_html TEXT,
    language_code VARCHAR(10) DEFAULT 'en',

    -- Media attachments
    media_ids UUID[] DEFAULT '{}',
    thumbnail_url VARCHAR(500),
    file_size_bytes BIGINT CHECK (file_size_bytes >= 0),

    -- Delivery status
    delivery_status VARCHAR(20) DEFAULT 'SENT' CHECK (
        delivery_status IN ('SENDING', 'SENT', 'DELIVERED', 'READ', 'FAILED')
    ),
    sent_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    delivered_at TIMESTAMP WITH TIME ZONE,
    read_at TIMESTAMP WITH TIME ZONE,

    -- Read receipts tracking (for group chats)
    read_by_users UUID[] DEFAULT '{}',
    delivered_to_users UUID[] DEFAULT '{}',

    -- Message threading
    parent_message_id UUID,
    reply_to_message_id UUID,
    thread_id UUID,

    -- Edit history
    is_edited BOOLEAN DEFAULT FALSE,
    edit_count INTEGER DEFAULT 0,
    last_edited_at TIMESTAMP WITH TIME ZONE,
    previous_versions JSONB DEFAULT '[]',
    edit_reason VARCHAR(200),

    -- Reactions
    reactions JSONB DEFAULT '{}',
    reaction_count INTEGER DEFAULT 0 CHECK (reaction_count >= 0),

    -- Moderation
    moderation_status VARCHAR(20) DEFAULT 'PENDING_REVIEW' CHECK (
        moderation_status IN ('PENDING_REVIEW', 'APPROVED', 'REJECTED', 'FLAGGED', 'DELETED')
    ),
    moderation_score NUMERIC(5,2) DEFAULT 0.0 CHECK (moderation_score >= 0 AND moderation_score <= 100),
    last_moderated_at TIMESTAMP WITH TIME ZONE,

    -- Pinning and highlighting
    is_pinned BOOLEAN DEFAULT FALSE,
    pinned_by UUID,
    pinned_at TIMESTAMP WITH TIME ZONE,

    -- Expiration
    expires_at TIMESTAMP WITH TIME ZONE,
    is_ephemeral BOOLEAN DEFAULT FALSE,
    ephemeral_duration_seconds INTEGER DEFAULT 0 CHECK (ephemeral_duration_seconds >= 0),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    deleted_at TIMESTAMP WITH TIME ZONE,
    deleted_by UUID,

    -- Foreign key constraints
    CONSTRAINT fk_conversations_messages_conversation FOREIGN KEY (conversation_id)
        REFERENCES socialcandor_schema.conversations(conversation_id) ON DELETE CASCADE,
    CONSTRAINT fk_conversations_messages_sender FOREIGN KEY (sender_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_conversations_messages_parent FOREIGN KEY (parent_message_id)
        REFERENCES socialcandor_schema.conversations_messages(message_id) ON DELETE SET NULL,
    CONSTRAINT fk_conversations_messages_reply FOREIGN KEY (reply_to_message_id)
        REFERENCES socialcandor_schema.conversations_messages(message_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_message_content CHECK (
        message_text IS NOT NULL OR
        CARDINALITY(media_ids) > 0 OR
        message_type = 'SYSTEM'
    ),
    CONSTRAINT chk_delivery_timestamps CHECK (
        (sent_at IS NOT NULL) AND
        (delivered_at IS NULL OR delivered_at >= sent_at) AND
        (read_at IS NULL OR read_at >= delivered_at)
    ),
    CONSTRAINT chk_ephemeral_duration CHECK (
        (is_ephemeral = FALSE) OR
        (ephemeral_duration_seconds > 0 AND expires_at IS NOT NULL)
    )
);

COMMENT ON TABLE socialcandor_schema.conversations_messages IS 'Message content storage with delivery/read receipts and edit history';
COMMENT ON COLUMN socialcandor_schema.conversations_messages.reactions IS 'JSON object mapping reaction emoji to user IDs';

-- Indexes for conversations_messages
CREATE INDEX IF NOT EXISTS idx_conversations_messages_conversation ON socialcandor_schema.conversations_messages(conversation_id);
CREATE INDEX IF NOT EXISTS idx_conversations_messages_sender ON socialcandor_schema.conversations_messages(sender_user_id);
CREATE INDEX IF NOT EXISTS idx_conversations_messages_sent_at ON socialcandor_schema.conversations_messages(sent_at DESC);
CREATE INDEX IF NOT EXISTS idx_conversations_messages_parent ON socialcandor_schema.conversations_messages(parent_message_id) WHERE parent_message_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_conversations_messages_thread ON socialcandor_schema.conversations_messages(thread_id) WHERE thread_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_conversations_messages_delivery ON socialcandor_schema.conversations_messages(delivery_status);
CREATE INDEX IF NOT EXISTS idx_conversations_messages_search ON socialcandor_schema.conversations_messages USING gin(to_tsvector('english', message_text));

-- Trigger to update conversation last message
CREATE OR REPLACE FUNCTION socialcandor_schema.update_conversation_last_message()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.delivery_status = 'SENT' THEN
        UPDATE socialcandor_schema.conversations
        SET last_message_at = NEW.sent_at,
            last_message_id = NEW.message_id,
            last_message_preview = LEFT(NEW.message_text, 100),
            total_message_count = total_message_count + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE conversation_id = NEW.conversation_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_conversations_messages_last_message
    AFTER INSERT OR UPDATE OF delivery_status ON socialcandor_schema.conversations_messages
    FOR EACH ROW
    WHEN (NEW.delivery_status = 'SENT')
    EXECUTE FUNCTION socialcandor_schema.update_conversation_last_message();

-- Trigger for updated_at
CREATE TRIGGER trg_conversations_messages_updated_at
    BEFORE UPDATE ON socialcandor_schema.conversations_messages
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 10 - conversations_users
-- Description: Participant management for group conversations
-- Business Case: Manages group membership with admin roles and notification controls.
-- Enables dynamic group membership changes and role-based moderation capabilities
-- critical for community management at scale.
-- Feature Reference: MSG03 (Group Management), MOD02 (Moderation), NTFC02 (Notification Controls)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.conversations_users (
    conversation_user_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    conversation_id UUID NOT NULL,
    user_id UUID NOT NULL,

    -- Membership status
    membership_status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE' CHECK (
        membership_status IN ('ACTIVE', 'PENDING', 'INVITED', 'LEFT', 'REMOVED', 'BANNED', 'MUTED')
    ),
    joined_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    left_at TIMESTAMP WITH TIME ZONE,
    invited_by UUID,

    -- Role and permissions
    user_role VARCHAR(20) DEFAULT 'MEMBER' CHECK (
        user_role IN ('OWNER', 'ADMIN', 'MODERATOR', 'MEMBER', 'VIEWER')
    ),
    permissions JSONB DEFAULT '{
        "can_send_messages": true,
        "can_send_media": true,
        "can_add_participants": false,
        "can_remove_participants": false,
        "can_change_settings": false,
        "can_pin_messages": false,
        "can_mention_all": false
    }',

    -- Notification preferences
    notification_preferences JSONB DEFAULT '{
        "mute_until": null,
        "mute_mentions": false,
        "mute_reactions": false,
        "notification_sound": "default",
        "notification_vibrate": true,
        "show_preview": true
    }',

    -- User settings in conversation
    custom_nickname VARCHAR(100),
    custom_color VARCHAR(7),
    is_favorite BOOLEAN DEFAULT FALSE,
    is_archived BOOLEAN DEFAULT FALSE,

    -- Engagement metrics
    last_read_message_id UUID,
    last_read_at TIMESTAMP WITH TIME ZONE,
    unread_message_count INTEGER DEFAULT 0 CHECK (unread_message_count >= 0),
    total_messages_sent INTEGER DEFAULT 0 CHECK (total_messages_sent >= 0),

    -- Moderation actions
    muted_until TIMESTAMP WITH TIME ZONE,
    mute_reason VARCHAR(200),
    warning_count INTEGER DEFAULT 0 CHECK (warning_count >= 0),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_conversations_users_conversation FOREIGN KEY (conversation_id)
        REFERENCES socialcandor_schema.conversations(conversation_id) ON DELETE CASCADE,
    CONSTRAINT fk_conversations_users_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_conversations_users_invited_by FOREIGN KEY (invited_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT uk_conversations_users UNIQUE (conversation_id, user_id),
    CONSTRAINT chk_membership_timestamps CHECK (
        (left_at IS NULL) OR
        (left_at > joined_at)
    ),
    CONSTRAINT chk_role_permissions CHECK (
        (user_role = 'OWNER' AND permissions->>'can_change_settings' = 'true') OR
        user_role != 'OWNER'
    )
);

COMMENT ON TABLE socialcandor_schema.conversations_users IS 'Participant management for group conversations with admin roles and notification controls';
COMMENT ON COLUMN socialcandor_schema.conversations_users.permissions IS 'JSON object defining user permissions within the conversation';

-- Indexes for conversations_users
CREATE INDEX IF NOT EXISTS idx_conversations_users_conversation ON socialcandor_schema.conversations_users(conversation_id);
CREATE INDEX IF NOT EXISTS idx_conversations_users_user ON socialcandor_schema.conversations_users(user_id);
CREATE INDEX IF NOT EXISTS idx_conversations_users_status ON socialcandor_schema.conversations_users(membership_status);
CREATE INDEX IF NOT EXISTS idx_conversations_users_role ON socialcandor_schema.conversations_users(user_role);
CREATE INDEX IF NOT EXISTS idx_conversations_users_unread ON socialcandor_schema.conversations_users(unread_message_count DESC) WHERE unread_message_count > 0;
CREATE INDEX IF NOT EXISTS idx_conversations_users_favorite ON socialcandor_schema.conversations_users(is_favorite) WHERE is_favorite = TRUE;

-- Trigger to update conversation participant count
CREATE OR REPLACE FUNCTION socialcandor_schema.update_conversation_participant_count()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' AND NEW.membership_status = 'ACTIVE' THEN
        UPDATE socialcandor_schema.conversations
        SET total_participant_count = total_participant_count + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE conversation_id = NEW.conversation_id;
    ELSIF TG_OP = 'UPDATE' AND OLD.membership_status = 'ACTIVE' AND NEW.membership_status != 'ACTIVE' THEN
        UPDATE socialcandor_schema.conversations
        SET total_participant_count = GREATEST(0, total_participant_count - 1),
            updated_at = CURRENT_TIMESTAMP
        WHERE conversation_id = NEW.conversation_id;
    ELSIF TG_OP = 'UPDATE' AND OLD.membership_status != 'ACTIVE' AND NEW.membership_status = 'ACTIVE' THEN
        UPDATE socialcandor_schema.conversations
        SET total_participant_count = total_participant_count + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE conversation_id = NEW.conversation_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_conversations_users_participant_count
    AFTER INSERT OR UPDATE OF membership_status ON socialcandor_schema.conversations_users
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_conversation_participant_count();

-- Trigger for updated_at
CREATE TRIGGER trg_conversations_users_updated_at
    BEFORE UPDATE ON socialcandor_schema.conversations_users
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 11 - notifications
-- Description: Centralized notification delivery system
-- Business Case: Multi-channel notification system decoupling generation from delivery
-- to handle traffic spikes while maintaining delivery guarantees. Supports priority
-- queuing for critical alerts and retry logic for reliable delivery.
-- Feature Reference: NTFC01 (Notification System), ENG01 (Engagement), REL01 (Real-time)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.notifications (
    notification_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Notification content
    notification_type VARCHAR(50) NOT NULL,
    notification_subtype VARCHAR(50),
    title VARCHAR(200) NOT NULL,
    body TEXT NOT NULL,
    data_payload JSONB DEFAULT '{}',

    -- Delivery configuration
    delivery_channels socialcandor_schema.notification_channel[] NOT NULL DEFAULT ARRAY['IN_APP']::socialcandor_schema.notification_channel[],
    priority_level VARCHAR(20) DEFAULT 'NORMAL' CHECK (
        priority_level IN ('LOW', 'NORMAL', 'HIGH', 'CRITICAL', 'EMERGENCY')
    ),
    delivery_strategy VARCHAR(20) DEFAULT 'ALL_CHANNELS' CHECK (
        delivery_strategy IN ('ALL_CHANNELS', 'FIRST_SUCCESS', 'FALLBACK')
    ),

    -- Delivery status tracking
    delivery_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
        delivery_status IN ('PENDING', 'QUEUED', 'PROCESSING', 'DELIVERED', 'FAILED', 'BOUNCED', 'RECEIVED')
    ),
    delivery_attempts INTEGER DEFAULT 0 CHECK (delivery_attempts >= 0),
    max_attempts INTEGER DEFAULT 3 CHECK (max_attempts >= 1 AND max_attempts <= 10),

    -- Timing and scheduling
    scheduled_for TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE,
    delivered_at TIMESTAMP WITH TIME ZONE,
    read_at TIMESTAMP WITH TIME ZONE,
    clicked_at TIMESTAMP WITH TIME ZONE,

    -- Channel-specific delivery tracking
    in_app_delivered BOOLEAN DEFAULT FALSE,
    in_app_delivered_at TIMESTAMP WITH TIME ZONE,
    email_delivered BOOLEAN DEFAULT FALSE,
    email_delivered_at TIMESTAMP WITH TIME ZONE,
    push_delivered BOOLEAN DEFAULT FALSE,
    push_delivered_at TIMESTAMP WITH TIME ZONE,

    -- Engagement tracking
    is_interactive BOOLEAN DEFAULT FALSE,
    action_buttons JSONB DEFAULT '[]',
    selected_action VARCHAR(50),

    -- Batching and grouping
    batch_id UUID,
    group_key VARCHAR(100),
    collapse_key VARCHAR(100),

    -- Source and context
    source_type VARCHAR(50),
    source_id UUID,
    source_user_id UUID,
    context_url VARCHAR(500),

    -- Personalization
    locale VARCHAR(10) DEFAULT 'en',
    template_variables JSONB DEFAULT '{}',

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_notifications_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_notifications_source_user FOREIGN KEY (source_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_notification_timestamps CHECK (
        scheduled_for >= created_at AND
        (expires_at IS NULL OR expires_at > scheduled_for) AND
        (delivered_at IS NULL OR delivered_at >= scheduled_for)
    ),
    CONSTRAINT chk_delivery_channels_not_empty CHECK (
        CARDINALITY(delivery_channels) > 0
    )
);

COMMENT ON TABLE socialcandor_schema.notifications IS 'Centralized notification delivery system with multi-channel support';
COMMENT ON COLUMN socialcandor_schema.notifications.collapse_key IS 'Key for collapsing similar notifications on mobile devices';

-- Indexes for notifications table
CREATE INDEX IF NOT EXISTS idx_notifications_user_id ON socialcandor_schema.notifications(user_id);
CREATE INDEX IF NOT EXISTS idx_notifications_delivery_status ON socialcandor_schema.notifications(delivery_status);
CREATE INDEX IF NOT EXISTS idx_notifications_scheduled_for ON socialcandor_schema.notifications(scheduled_for);
CREATE INDEX IF NOT EXISTS idx_notifications_type_user ON socialcandor_schema.notifications(notification_type, user_id);
CREATE INDEX IF NOT EXISTS idx_notifications_source ON socialcandor_schema.notifications(source_type, source_id);
CREATE INDEX IF NOT EXISTS idx_notifications_priority ON socialcandor_schema.notifications(priority_level DESC, scheduled_for);
CREATE INDEX IF NOT EXISTS idx_notifications_unread ON socialcandor_schema.notifications(user_id) WHERE read_at IS NULL;
CREATE INDEX IF NOT EXISTS idx_notifications_expires ON socialcandor_schema.notifications(expires_at) WHERE expires_at IS NOT NULL;

-- Materialized view for notification analytics
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_notification_metrics AS
SELECT
    user_id,
    COUNT(*) AS total_notifications,
    COUNT(*) FILTER (WHERE read_at IS NOT NULL) AS read_notifications,
    COUNT(*) FILTER (WHERE clicked_at IS NOT NULL) AS clicked_notifications,
    COUNT(*) FILTER (WHERE delivery_status = 'DELIVERED') AS delivered_notifications,
    COUNT(*) FILTER (WHERE delivery_status = 'FAILED') AS failed_notifications,
    AVG(EXTRACT(EPOCH FROM (read_at - delivered_at))) FILTER (WHERE read_at IS NOT NULL) AS avg_read_time_seconds,
    MAX(delivered_at) AS last_notification_at
FROM socialcandor_schema.notifications
WHERE delivered_at >= CURRENT_TIMESTAMP - INTERVAL '30 days'
GROUP BY user_id
WITH DATA;

CREATE UNIQUE INDEX idx_mv_notification_metrics_user ON socialcandor_schema.mv_notification_metrics(user_id);

-- Trigger for updated_at
CREATE TRIGGER trg_notifications_updated_at
    BEFORE UPDATE ON socialcandor_schema.notifications
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 12 - notification_preferences
-- Description: Granular user-controlled notification settings
-- Business Case: Reduces notification fatigue while increasing engagement by allowing
-- users to customize communication frequency. Critical for retention in saturated
-- social media markets with JSONB flexibility for feature-specific toggles.
-- Feature Reference: NTFC02 (Notification Preferences), ENG02 (Engagement Optimization)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.notification_preferences (
    preference_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL UNIQUE,

    -- Global notification settings
    global_notification_enabled BOOLEAN DEFAULT TRUE,
    quiet_hours_start TIME DEFAULT '22:00',
    quiet_hours_end TIME DEFAULT '08:00',
    quiet_hours_enabled BOOLEAN DEFAULT FALSE,
    do_not_disturb_until TIMESTAMP WITH TIME ZONE,

    -- Channel preferences
    channel_preferences JSONB DEFAULT '{
        "in_app": true,
        "email": true,
        "push": true,
        "sms": false,
        "whatsapp": false,
        "telegram": false
    }',

    -- Category preferences
    category_preferences JSONB DEFAULT '{
        "likes_and_reactions": true,
        "comments_and_replies": true,
        "friend_requests": true,
        "new_followers": true,
        "direct_messages": true,
        "group_messages": true,
        "event_invites": true,
        "birthday_reminders": true,
        "security_alerts": true,
        "marketing_emails": false,
        "newsletter": false,
        "product_updates": true,
        "promotional_offers": false
    }',

    -- Frequency settings
    frequency_settings JSONB DEFAULT '{
        "digest_frequency": "DAILY",
        "digest_time": "18:00",
        "batch_notifications": true,
        "batch_interval_minutes": 15,
        "real_time_for_important": true
    }',

    -- Content filtering
    content_filters JSONB DEFAULT '{
        "muted_keywords": [],
        "muted_users": [],
        "muted_groups": [],
        "show_content_warnings": true,
        "sensitive_content_filter": "MODERATE",
        "political_content_filter": "STANDARD"
    }',

    -- Sound and visual preferences
    sound_settings JSONB DEFAULT '{
        "notification_sound": "default",
        "message_sound": "message",
        "vibration_enabled": true,
        "led_color": "blue",
        "badge_enabled": true
    }',

    -- Device-specific preferences
    device_preferences JSONB DEFAULT '{
        "mobile": {"enabled": true, "sounds": true, "vibration": true},
        "desktop": {"enabled": true, "sounds": false},
        "tablet": {"enabled": true, "sounds": true, "vibration": true}
    }',

    -- Privacy preferences
    privacy_preferences JSONB DEFAULT '{
        "show_typing_indicator": true,
        "show_read_receipts": true,
        "show_online_status": true,
        "show_last_seen": true,
        "show_profile_picture": true
    }',

    -- Learning preferences
    learning_enabled BOOLEAN DEFAULT TRUE,
    last_learned_at TIMESTAMP WITH TIME ZONE,
    learned_preferences JSONB DEFAULT '{}',

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_notification_preferences_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_quiet_hours_valid CHECK (
        (quiet_hours_enabled = FALSE) OR
        (quiet_hours_start < quiet_hours_end)
    ),
    CONSTRAINT chk_dnd_future CHECK (
        do_not_disturb_until IS NULL OR
        do_not_disturb_until > CURRENT_TIMESTAMP
    )
);

COMMENT ON TABLE socialcandor_schema.notification_preferences IS 'Granular user-controlled notification settings with JSONB flexibility';
COMMENT ON COLUMN socialcandor_schema.notification_preferences.learned_preferences IS 'ML-learned preferences based on user interaction patterns';

-- Indexes for notification_preferences
CREATE INDEX IF NOT EXISTS idx_notification_preferences_user ON socialcandor_schema.notification_preferences(user_id);
CREATE INDEX IF NOT EXISTS idx_notification_preferences_global ON socialcandor_schema.notification_preferences(global_notification_enabled) WHERE global_notification_enabled = FALSE;
CREATE INDEX IF NOT EXISTS idx_notification_preferences_quiet_hours ON socialcandor_schema.notification_preferences(quiet_hours_enabled) WHERE quiet_hours_enabled = TRUE;

-- Trigger for updated_at
CREATE TRIGGER trg_notification_preferences_updated_at
    BEFORE UPDATE ON socialcandor_schema.notification_preferences
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 13 - groups
-- Description: Community container supporting public/private groups
-- Business Case: Enables niche community formation around shared interests while
-- providing monetization pathways through group subscriptions and targeted
-- advertising within community contexts. Supports verification badges and
-- member management at scale.
-- Feature Reference: GRP01 (Group Management), COM01 (Community), MON01 (Monetization)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.groups (
    group_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    owner_user_id UUID NOT NULL,

    -- Group identification
    group_name VARCHAR(200) NOT NULL,
    group_slug VARCHAR(200) UNIQUE NOT NULL,
    group_type VARCHAR(30) NOT NULL DEFAULT 'PUBLIC' CHECK (
        group_type IN ('PUBLIC', 'PRIVATE', 'SECRET', 'RESTRICTED')
    ),

    -- Description and branding
    description TEXT,
    tagline VARCHAR(500),
    avatar_url VARCHAR(500),
    cover_image_url VARCHAR(500),
    banner_url VARCHAR(500),

    -- Category and tags
    primary_category VARCHAR(100),
    secondary_categories VARCHAR(100)[] DEFAULT '{}',
    tags VARCHAR(50)[] DEFAULT '{}',
    industry VARCHAR(100),

    -- Location information
    location_type VARCHAR(20) DEFAULT 'GLOBAL' CHECK (
        location_type IN ('GLOBAL', 'LOCAL', 'REGIONAL', 'NATIONAL')
    ),
    location_country VARCHAR(3),
    location_city VARCHAR(100),
    location_coordinates GEOGRAPHY(POINT, 4326),
    location_radius_km INTEGER DEFAULT 100 CHECK (location_radius_km >= 0),

    -- Membership settings
    membership_policy VARCHAR(20) DEFAULT 'OPEN' CHECK (
        membership_policy IN ('OPEN', 'APPROVAL_REQUIRED', 'INVITE_ONLY', 'CLOSED')
    ),
    max_members INTEGER DEFAULT 100000 CHECK (max_members >= 0),
    current_member_count INTEGER DEFAULT 0 CHECK (current_member_count >= 0),

    -- Content and posting settings
    posting_permissions VARCHAR(20) DEFAULT 'ALL_MEMBERS' CHECK (
        posting_permissions IN ('ADMINS_ONLY', 'MODERATORS_ONLY', 'ALL_MEMBERS', 'APPROVAL_REQUIRED')
    ),
    content_moderation_level VARCHAR(20) DEFAULT 'STANDARD' CHECK (
        content_moderation_level IN ('NONE', 'LIGHT', 'STANDARD', 'STRICT', 'VERY_STRICT')
    ),
    nsfw_content_allowed BOOLEAN DEFAULT FALSE,

    -- Monetization
    is_monetized BOOLEAN DEFAULT FALSE,
    monetization_model VARCHAR(30) CHECK (
        monetization_model IN ('FREE', 'SUBSCRIPTION', 'DONATION', 'PAID_POSTS', 'SPONSORED', 'HYBRID')
    ),
    subscription_price NUMERIC(10,2) CHECK (subscription_price >= 0),
    subscription_currency CHAR(3) DEFAULT 'USD',
    revenue_share_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (revenue_share_percentage >= 0 AND revenue_share_percentage <= 100),

    -- Verification and trust
    is_verified BOOLEAN DEFAULT FALSE,
    verification_level VARCHAR(20) DEFAULT 'UNVERIFIED',
    verification_badge_url VARCHAR(500),
    trust_score NUMERIC(5,2) DEFAULT 50.0 CHECK (trust_score >= 0 AND trust_score <= 100),

    -- Activity metrics
    total_posts INTEGER DEFAULT 0 CHECK (total_posts >= 0),
    total_comments INTEGER DEFAULT 0 CHECK (total_comments >= 0),
    engagement_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_rate >= 0 AND engagement_rate <= 100),
    last_activity_at TIMESTAMP WITH TIME ZONE,

    -- Group status
    is_active BOOLEAN DEFAULT TRUE,
    is_featured BOOLEAN DEFAULT FALSE,
    featured_until TIMESTAMP WITH TIME ZONE,
    is_archived BOOLEAN DEFAULT FALSE,
    archived_at TIMESTAMP WITH TIME ZONE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_groups_owner FOREIGN KEY (owner_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE RESTRICT,

    -- Constraints
    CONSTRAINT chk_group_slug_format CHECK (group_slug ~ '^[a-z0-9-]{3,200}$'),
    CONSTRAINT chk_member_counts CHECK (current_member_count <= max_members),
    CONSTRAINT chk_subscription_price CHECK (
        (monetization_model != 'SUBSCRIPTION' AND subscription_price IS NULL) OR
        (monetization_model = 'SUBSCRIPTION' AND subscription_price > 0)
    )
);

COMMENT ON TABLE socialcandor_schema.groups IS 'Community container supporting public/private groups with verification and monetization';
COMMENT ON COLUMN socialcandor_schema.groups.engagement_rate IS 'Percentage of active members engaging with group content';

-- Indexes for groups table
CREATE INDEX IF NOT EXISTS idx_groups_owner ON socialcandor_schema.groups(owner_user_id);
CREATE INDEX IF NOT EXISTS idx_groups_slug ON socialcandor_schema.groups(group_slug);
CREATE INDEX IF NOT EXISTS idx_groups_type ON socialcandor_schema.groups(group_type);
CREATE INDEX IF NOT EXISTS idx_groups_category ON socialcandor_schema.groups(primary_category);
CREATE INDEX IF NOT EXISTS idx_groups_location ON socialcandor_schema.groups USING GIST(location_coordinates);
CREATE INDEX IF NOT EXISTS idx_groups_activity ON socialcandor_schema.groups(last_activity_at DESC);
CREATE INDEX IF NOT EXISTS idx_groups_trust ON socialcandor_schema.groups(trust_score DESC);
CREATE INDEX IF NOT EXISTS idx_groups_member_count ON socialcandor_schema.groups(current_member_count DESC);

-- Full-text search index for group discovery
CREATE INDEX IF NOT EXISTS idx_groups_search ON socialcandor_schema.groups
USING gin(to_tsvector('english', group_name || ' ' || COALESCE(description, '') || ' ' || COALESCE(tagline, '')));

-- Trigger for updated_at
CREATE TRIGGER trg_groups_updated_at
    BEFORE UPDATE ON socialcandor_schema.groups
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 14 - groups_members
-- Description: Group membership tracking with role assignments
-- Business Case: Supports scalable community moderation through delegated admin rights
-- and automated membership approval workflows based on user reputation scores.
-- Enables member lifecycle management from pending to removed status.
-- Feature Reference: GRP02 (Membership Management), MOD02 (Moderation), REP01 (Reputation)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.groups_members (
    group_membership_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    group_id UUID NOT NULL,
    user_id UUID NOT NULL,

    -- Membership status
    membership_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (
        membership_status IN ('PENDING', 'APPROVED', 'INVITED', 'REJECTED', 'SUSPENDED', 'BANNED', 'LEFT')
    ),

    -- Role and permissions
    member_role VARCHAR(20) DEFAULT 'MEMBER' CHECK (
        member_role IN ('OWNER', 'ADMIN', 'MODERATOR', 'MEMBER', 'VIEWER')
    ),
    permissions JSONB DEFAULT '{
        "can_post": true,
        "can_comment": true,
        "can_invite": false,
        "can_approve": false,
        "can_moderate": false,
        "can_edit_group": false,
        "can_delete_posts": false
    }',

    -- Membership timeline
    applied_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    invited_at TIMESTAMP WITH TIME ZONE,
    invited_by UUID,
    approved_at TIMESTAMP WITH TIME ZONE,
    approved_by UUID,
    joined_at TIMESTAMP WITH TIME ZONE,
    left_at TIMESTAMP WITH TIME ZONE,
    banned_at TIMESTAMP WITH TIME ZONE,
    banned_by UUID,
    ban_reason TEXT,
    ban_expires_at TIMESTAMP WITH TIME ZONE,

    -- Member settings
    notification_preferences JSONB DEFAULT '{
        "new_posts": true,
        "new_comments": true,
        "member_requests": false,
        "event_reminders": true,
        "digest_frequency": "DAILY"
    }',
    display_name_in_group VARCHAR(100),
    custom_title VARCHAR(100),

    -- Engagement metrics
    posts_count INTEGER DEFAULT 0 CHECK (posts_count >= 0),
    comments_count INTEGER DEFAULT 0 CHECK (comments_count >= 0),
    likes_given INTEGER DEFAULT 0 CHECK (likes_given >= 0),
    last_activity_at TIMESTAMP WITH TIME ZONE,
    total_time_spent_minutes INTEGER DEFAULT 0 CHECK (total_time_spent_minutes >= 0),

    -- Reputation and contribution
    reputation_score INTEGER DEFAULT 0,
    contribution_score NUMERIC(5,2) DEFAULT 0.0 CHECK (contribution_score >= 0 AND contribution_score <= 100),
    is_valued_member BOOLEAN DEFAULT FALSE,
    badges_awarded VARCHAR(50)[] DEFAULT '{}',

    -- Moderation history
    warning_count INTEGER DEFAULT 0 CHECK (warning_count >= 0),
    last_warning_at TIMESTAMP WITH TIME ZONE,
    mute_until TIMESTAMP WITH TIME ZONE,
    mute_reason VARCHAR(200),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_groups_members_group FOREIGN KEY (group_id)
        REFERENCES socialcandor_schema.groups(group_id) ON DELETE CASCADE,
    CONSTRAINT fk_groups_members_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_groups_members_invited_by FOREIGN KEY (invited_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_groups_members_approved_by FOREIGN KEY (approved_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_groups_members_banned_by FOREIGN KEY (banned_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT uk_groups_members UNIQUE (group_id, user_id),
    CONSTRAINT chk_membership_timeline CHECK (
        (applied_at <= COALESCE(approved_at, applied_at)) AND
        (approved_at <= COALESCE(joined_at, approved_at)) AND
        (joined_at <= COALESCE(left_at, joined_at)) AND
        (ban_expires_at IS NULL OR ban_expires_at > banned_at)
    ),
    CONSTRAINT chk_role_permissions_consistency CHECK (
        (member_role IN ('OWNER', 'ADMIN') AND permissions->>'can_edit_group' = 'true') OR
        member_role NOT IN ('OWNER', 'ADMIN')
    )
);

COMMENT ON TABLE socialcandor_schema.groups_members IS 'Group membership tracking with status lifecycle and role assignments';
COMMENT ON COLUMN socialcandor_schema.groups_members.contribution_score IS 'Algorithmic score measuring member contribution quality';

-- Indexes for groups_members
CREATE INDEX IF NOT EXISTS idx_groups_members_group ON socialcandor_schema.groups_members(group_id);
CREATE INDEX IF NOT EXISTS idx_groups_members_user ON socialcandor_schema.groups_members(user_id);
CREATE INDEX IF NOT EXISTS idx_groups_members_status ON socialcandor_schema.groups_members(membership_status);
CREATE INDEX IF NOT EXISTS idx_groups_members_role ON socialcandor_schema.groups_members(member_role);
CREATE INDEX IF NOT EXISTS idx_groups_members_activity ON socialcandor_schema.groups_members(last_activity_at DESC);
CREATE INDEX IF NOT EXISTS idx_groups_members_contribution ON socialcandor_schema.groups_members(contribution_score DESC);
CREATE INDEX IF NOT EXISTS idx_groups_members_approved ON socialcandor_schema.groups_members(approved_at DESC) WHERE membership_status = 'APPROVED';

-- Trigger to update group member count
CREATE OR REPLACE FUNCTION socialcandor_schema.update_group_member_count()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' AND NEW.membership_status = 'APPROVED' THEN
        UPDATE socialcandor_schema.groups
        SET current_member_count = current_member_count + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE group_id = NEW.group_id;
    ELSIF TG_OP = 'UPDATE' THEN
        IF OLD.membership_status = 'APPROVED' AND NEW.membership_status != 'APPROVED' THEN
            UPDATE socialcandor_schema.groups
            SET current_member_count = GREATEST(0, current_member_count - 1),
                updated_at = CURRENT_TIMESTAMP
            WHERE group_id = NEW.group_id;
        ELSIF OLD.membership_status != 'APPROVED' AND NEW.membership_status = 'APPROVED' THEN
            UPDATE socialcandor_schema.groups
            SET current_member_count = current_member_count + 1,
                updated_at = CURRENT_TIMESTAMP
            WHERE group_id = NEW.group_id;
        END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_groups_members_member_count
    AFTER INSERT OR UPDATE OF membership_status ON socialcandor_schema.groups_members
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_group_member_count();

-- Trigger for updated_at
CREATE TRIGGER trg_groups_members_updated_at
    BEFORE UPDATE ON socialcandor_schema.groups_members
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 15 - pages
-- Description: Business/organization profiles with verification workflows
-- Business Case: Creates B2C engagement channel for brands while enabling verified
-- identity markers to combat impersonation. Critical revenue stream through
-- promoted page features, analytics subscriptions, and business tools integration.
-- Feature Reference: BIZ01 (Business Pages), VER01 (Verification), MON02 (Business Monetization)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.pages (
    page_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    owner_user_id UUID NOT NULL,

    -- Page identification
    page_name VARCHAR(200) NOT NULL,
    page_slug VARCHAR(200) UNIQUE NOT NULL,
    page_type VARCHAR(30) NOT NULL DEFAULT 'BUSINESS' CHECK (
        page_type IN ('BUSINESS', 'BRAND', 'ORGANIZATION', 'PUBLIC_FIGURE', 'COMMUNITY', 'PRODUCT', 'SERVICE')
    ),

    -- Basic information
    description TEXT,
    tagline VARCHAR(500),
    mission_statement TEXT,
    founding_date DATE,
    industry VARCHAR(100),
    subindustry VARCHAR(100),

    -- Contact information
    website_url VARCHAR(500),
    contact_email VARCHAR(255),
    contact_phone VARCHAR(20),
    business_hours JSONB DEFAULT '{}',
    address_line1 VARCHAR(255),
    address_line2 VARCHAR(255),
    city VARCHAR(100),
    state VARCHAR(100),
    country VARCHAR(3),
    postal_code VARCHAR(20),
    location_coordinates GEOGRAPHY(POINT, 4326),

    -- Branding and visuals
    logo_url VARCHAR(500),
    cover_image_url VARCHAR(500),
    banner_url VARCHAR(500),
    primary_color VARCHAR(7),
    secondary_color VARCHAR(7),
    brand_guidelines_url VARCHAR(500),

    -- Verification and trust
    verification_status VARCHAR(20) DEFAULT 'UNVERIFIED' CHECK (
        verification_status IN ('UNVERIFIED', 'PENDING', 'VERIFIED', 'BLUE_TICK', 'GOLD_TICK', 'GOVERNMENT')
    ),
    verification_requested_at TIMESTAMP WITH TIME ZONE,
    verification_approved_at TIMESTAMP WITH TIME ZONE,
    verification_badge_url VARCHAR(500),
    verification_documents JSONB DEFAULT '[]',

    -- Social media links
    social_links JSONB DEFAULT '{
        "facebook": null,
        "twitter": null,
        "instagram": null,
        "linkedin": null,
        "youtube": null,
        "tiktok": null
    }',

    -- Team and structure
    team_members JSONB DEFAULT '[]',
    organizational_structure JSONB DEFAULT '{}',
    departments JSONB DEFAULT '[]',

    -- Metrics and analytics
    follower_count INTEGER DEFAULT 0 CHECK (follower_count >= 0),
    engagement_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_rate >= 0 AND engagement_rate <= 100),
    page_views INTEGER DEFAULT 0 CHECK (page_views >= 0),
    avg_response_time_minutes INTEGER,

    -- Monetization features
    is_monetized BOOLEAN DEFAULT FALSE,
    monetization_features JSONB DEFAULT '{
        "premium_analytics": false,
        "promoted_posts": false,
        "shopping_enabled": false,
        "booking_enabled": false,
        "donations_enabled": false
    }',
    subscription_tier VARCHAR(20) DEFAULT 'FREE' CHECK (
        subscription_tier IN ('FREE', 'BASIC', 'PRO', 'BUSINESS', 'ENTERPRISE')
    ),
    subscription_expires_at TIMESTAMP WITH TIME ZONE,

    -- Content settings
    content_strategy JSONB DEFAULT '{
        "posting_frequency": "DAILY",
        "content_categories": [],
        "automated_posting": false,
        "content_calendar": false
    }',
    auto_reply_enabled BOOLEAN DEFAULT FALSE,
    auto_reply_message TEXT,

    -- Page status
    is_active BOOLEAN DEFAULT TRUE,
    is_featured BOOLEAN DEFAULT FALSE,
    featured_until TIMESTAMP WITH TIME ZONE,
    is_under_review BOOLEAN DEFAULT FALSE,
    review_reason TEXT,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_pages_owner FOREIGN KEY (owner_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE RESTRICT,

    -- Constraints
    CONSTRAINT chk_page_slug_format CHECK (page_slug ~ '^[a-z0-9-]{3,200}$'),
    CONSTRAINT chk_verification_dates CHECK (
        (verification_approved_at IS NULL) OR
        (verification_requested_at IS NOT NULL AND verification_approved_at >= verification_requested_at)
    ),
    CONSTRAINT chk_business_hours_valid CHECK (
        jsonb_typeof(business_hours) = 'object' OR business_hours IS NULL
    )
);

COMMENT ON TABLE socialcandor_schema.pages IS 'Business/organization profiles with verification workflows and public-facing content streams';
COMMENT ON COLUMN socialcandor_schema.pages.verification_documents IS 'JSON array of uploaded verification documents with metadata';

-- Indexes for pages table
CREATE INDEX IF NOT EXISTS idx_pages_owner ON socialcandor_schema.pages(owner_user_id);
CREATE INDEX IF NOT EXISTS idx_pages_slug ON socialcandor_schema.pages(page_slug);
CREATE INDEX IF NOT EXISTS idx_pages_type ON socialcandor_schema.pages(page_type);
CREATE INDEX IF NOT EXISTS idx_pages_industry ON socialcandor_schema.pages(industry);
CREATE INDEX IF NOT EXISTS idx_pages_verification ON socialcandor_schema.pages(verification_status);
CREATE INDEX IF NOT EXISTS idx_pages_location ON socialcandor_schema.pages USING GIST(location_coordinates);
CREATE INDEX IF NOT EXISTS idx_pages_follower_count ON socialcandor_schema.pages(follower_count DESC);
CREATE INDEX IF NOT EXISTS idx_pages_created_at ON socialcandor_schema.pages(created_at DESC);

-- Full-text search index for page discovery
CREATE INDEX IF NOT EXISTS idx_pages_search ON socialcandor_schema.pages
USING gin(to_tsvector('english', page_name || ' ' || COALESCE(description, '') || ' ' || COALESCE(tagline, '')));

-- Trigger for updated_at
CREATE TRIGGER trg_pages_updated_at
    BEFORE UPDATE ON socialcandor_schema.pages
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();



------------------------------------------------------------------------------------------------
-- Table: 16 - photo_albums (created first to avoid circular dependency)
-- Description: Logical grouping of photos with collaborative capabilities
------------------------------------------------------------------------------------------------
-- Table: 16 - photo_albums
-- Description: Logical grouping of photos with collaborative capabilities
-- Business Case: Enables memory preservation features ("On This Day") and social sharing
-- workflows while supporting bulk operations (download/delete) for user data
-- portability compliance. Supports collaborative albums for shared experiences.
-- Feature Reference: ALB01 (Album Management), COL01 (Collaboration), DPP01 (Data Portability)
------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.photo_albums (
    album_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Album information
    album_name VARCHAR(200) NOT NULL,
    album_slug VARCHAR(200) UNIQUE,
    description TEXT,
    album_type VARCHAR(30) DEFAULT 'PERSONAL' CHECK (
        album_type IN ('PERSONAL', 'EVENT', 'TRIP', 'PROJECT', 'MEMORY', 'COLLABORATIVE')
    ),

    -- Cover and appearance
    cover_photo_id UUID, -- Foreign key constraint added later
    cover_color VARCHAR(7),
    layout_style VARCHAR(20) DEFAULT 'GRID' CHECK (
        layout_style IN ('GRID', 'MASONRY', 'CAROUSEL', 'STACK', 'TIMELINE')
    ),

    -- Privacy and sharing
    visibility socialcandor_schema.content_visibility DEFAULT 'PRIVATE',
    sharing_enabled BOOLEAN DEFAULT FALSE,
    invite_link VARCHAR(500),
    invite_link_expires_at TIMESTAMP WITH TIME ZONE,
    download_enabled BOOLEAN DEFAULT TRUE,
    allow_comments BOOLEAN DEFAULT TRUE,
    allow_reactions BOOLEAN DEFAULT TRUE,

    -- Organization
    sort_order INTEGER DEFAULT 0 CHECK (sort_order >= 0),
    is_featured BOOLEAN DEFAULT FALSE,
    is_pinned BOOLEAN DEFAULT FALSE,
    is_archived BOOLEAN DEFAULT FALSE,
    archived_at TIMESTAMP WITH TIME ZONE,

    -- Time-based features
    start_date DATE,
    end_date DATE,
    is_time_bound BOOLEAN DEFAULT FALSE,
    recurrence_pattern VARCHAR(100), -- For "On This Day" type albums
    memory_notification_enabled BOOLEAN DEFAULT FALSE,

    -- Collaborative features
    is_collaborative BOOLEAN DEFAULT FALSE,
    collaboration_mode VARCHAR(20) DEFAULT 'VIEW_ONLY' CHECK (
        collaboration_mode IN ('VIEW_ONLY', 'CAN_ADD', 'CAN_EDIT', 'CAN_MANAGE')
    ),
    collaborator_count INTEGER DEFAULT 0 CHECK (collaborator_count >= 0),

    -- Statistics
    photo_count INTEGER DEFAULT 0 CHECK (photo_count >= 0),
    total_views INTEGER DEFAULT 0 CHECK (total_views >= 0),
    total_downloads INTEGER DEFAULT 0 CHECK (total_downloads >= 0),
    total_size_bytes BIGINT DEFAULT 0 CHECK (total_size_bytes >= 0),
    last_photo_added_at TIMESTAMP WITH TIME ZONE,

    -- Location context
    location_name VARCHAR(255),
    location_coordinates GEOGRAPHY(POINT, 4326),
    location_radius_km INTEGER,

    -- Metadata and tags
    tags VARCHAR(50)[] DEFAULT '{}',
    categories VARCHAR(50)[] DEFAULT '{}',
    custom_metadata JSONB DEFAULT '{}',

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    deleted_at TIMESTAMP WITH TIME ZONE,
    deleted_by UUID,

    -- Foreign key constraints (users constraint only - photos constraint added later)
    CONSTRAINT fk_photo_albums_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_album_dates CHECK (
        (start_date IS NULL AND end_date IS NULL) OR
        (start_date IS NOT NULL AND (end_date IS NULL OR end_date >= start_date))
    ),
    CONSTRAINT chk_invite_link_validity CHECK (
        (invite_link IS NULL) OR
        (invite_link_expires_at IS NULL) OR
        (invite_link_expires_at > created_at)
    ),
    CONSTRAINT chk_album_slug_format CHECK (
        album_slug IS NULL OR
        album_slug ~ '^[a-z0-9-]{3,200}$'
    )
);

COMMENT ON TABLE socialcandor_schema.photo_albums IS 'Logical grouping of photos with cover image selection and collaborative capabilities';
COMMENT ON COLUMN socialcandor_schema.photo_albums.recurrence_pattern IS 'Cron-like pattern for automatic album updates (e.g., yearly memory albums)';

-- Indexes for photo_albums table
CREATE INDEX IF NOT EXISTS idx_photo_albums_user_id ON socialcandor_schema.photo_albums(user_id);
CREATE INDEX IF NOT EXISTS idx_photo_albums_album_type ON socialcandor_schema.photo_albums(album_type);
CREATE INDEX IF NOT EXISTS idx_photo_albums_visibility ON socialcandor_schema.photo_albums(visibility);
CREATE INDEX IF NOT EXISTS idx_photo_albums_created_at ON socialcandor_schema.photo_albums(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_photo_albums_collaborative ON socialcandor_schema.photo_albums(is_collaborative) WHERE is_collaborative = TRUE;
CREATE INDEX IF NOT EXISTS idx_photo_albums_location ON socialcandor_schema.photo_albums USING GIST(location_coordinates);
CREATE INDEX IF NOT EXISTS idx_photo_albums_dates ON socialcandor_schema.photo_albums(start_date, end_date) WHERE is_time_bound = TRUE;

------------------------------------------------------------------------------------------------
-- Table: 17 - photos (created after photo_albums)
-- Description: Dedicated photo storage with EXIF metadata preservation
------------------------------------------------------------------------------------------------
-- Table: 16 - photos
-- Description: Dedicated photo storage with EXIF metadata preservation
-- Business Case: Supports photo-centric experiences (albums, galleries) with geotagging
-- and privacy controls distinct from post attachments. Maintains metadata integrity
-- for accessibility compliance and copyright attribution while enabling advanced
-- photo management features.
-- Feature Reference: MED02 (Photo Management), GEO01 (Geotagging), ACC02 (Accessibility)
------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.photos (
    photo_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,
    album_id UUID,

    -- Photo information
    photo_type VARCHAR(20) DEFAULT 'PHOTO' CHECK (
        photo_type IN ('PHOTO', 'PANORAMA', 'PORTRAIT', 'LANDSCAPE', 'MACRO', 'SPHERICAL')
    ),
    original_filename VARCHAR(255),
    file_extension VARCHAR(10),
    mime_type VARCHAR(100),

    -- Storage information
    storage_provider VARCHAR(50) DEFAULT 'S3' CHECK (
        storage_provider IN ('S3', 'GCS', 'AZURE', 'CDN', 'LOCAL')
    ),
    storage_key VARCHAR(500) NOT NULL,
    storage_bucket VARCHAR(255),
    storage_region VARCHAR(50),

    -- Image metadata
    file_size_bytes BIGINT CHECK (file_size_bytes >= 0),
    width_pixels INTEGER CHECK (width_pixels >= 0),
    height_pixels INTEGER CHECK (height_pixels >= 0),
    aspect_ratio NUMERIC(5,2),
    resolution_dpi INTEGER,
    color_space VARCHAR(50),
    bit_depth INTEGER CHECK (bit_depth IN (8, 16, 24, 32)),

    -- EXIF metadata (preserved from camera)
    exif_data JSONB DEFAULT '{}',
    camera_make VARCHAR(100),
    camera_model VARCHAR(100),
    lens_model VARCHAR(100),
    focal_length NUMERIC(5,1),
    aperture VARCHAR(10),
    shutter_speed VARCHAR(20),
    iso_speed INTEGER,
    exposure_bias VARCHAR(10),
    flash_used BOOLEAN,
    metering_mode VARCHAR(50),

    -- Geolocation data
    geotag_enabled BOOLEAN DEFAULT FALSE,
    latitude NUMERIC(10,8),
    longitude NUMERIC(11,8),
    altitude NUMERIC(8,2),
    location_accuracy INTEGER,
    location_name VARCHAR(255),
    location_address TEXT,
    location_coordinates GEOGRAPHY(POINT, 4326),

    -- Date and time
    taken_at TIMESTAMP WITH TIME ZONE,
    digitized_at TIMESTAMP WITH TIME ZONE,
    timezone_offset VARCHAR(10),

    -- Processing information
    processing_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
        processing_status IN ('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'OPTIMIZED')
    ),
    processing_attempts INTEGER DEFAULT 0,
    processing_error TEXT,
    optimized_version_url VARCHAR(500),
    thumbnail_url VARCHAR(500),
    preview_url VARCHAR(500),
    watermark_applied BOOLEAN DEFAULT FALSE,

    -- Accessibility features
    alt_text VARCHAR(500),
    generated_alt_text VARCHAR(500),
    alt_text_confidence NUMERIC(5,2) CHECK (alt_text_confidence >= 0 AND alt_text_confidence <= 100),
    caption TEXT,
    keywords VARCHAR(100)[] DEFAULT '{}',

    -- Copyright and licensing
    copyright_notice TEXT,
    copyright_holder VARCHAR(255),
    usage_rights VARCHAR(50) CHECK (
        usage_rights IN ('ALL_RIGHTS_RESERVED', 'CREATIVE_COMMONS', 'PUBLIC_DOMAIN', 'ROYALTY_FREE', 'RIGHTS_MANAGED')
    ),
    license_type VARCHAR(100),
    attribution_required BOOLEAN DEFAULT FALSE,
    commercial_use_allowed BOOLEAN DEFAULT FALSE,
    modification_allowed BOOLEAN DEFAULT FALSE,

    -- Content safety
    nsfw_score NUMERIC(5,2) DEFAULT 0.0 CHECK (nsfw_score >= 0 AND nsfw_score <= 100),
    explicit_content_detected BOOLEAN DEFAULT FALSE,
    blur_hash VARCHAR(100),

    -- Privacy and sharing
    visibility socialcandor_schema.content_visibility DEFAULT 'PRIVATE',
    sharing_enabled BOOLEAN DEFAULT FALSE,
    download_enabled BOOLEAN DEFAULT TRUE,
    can_be_shared BOOLEAN DEFAULT TRUE,

    -- Engagement metrics
    view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
    download_count INTEGER DEFAULT 0 CHECK (download_count >= 0),
    like_count INTEGER DEFAULT 0 CHECK (like_count >= 0),
    share_count INTEGER DEFAULT 0 CHECK (share_count >= 0),

    -- Organization
    sort_order INTEGER DEFAULT 0 CHECK (sort_order >= 0),
    is_favorite BOOLEAN DEFAULT FALSE,
    is_archived BOOLEAN DEFAULT FALSE,
    archived_at TIMESTAMP WITH TIME ZONE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    deleted_at TIMESTAMP WITH TIME ZONE,
    deleted_by UUID,

    -- Foreign key constraints
    CONSTRAINT fk_photos_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_photos_album FOREIGN KEY (album_id)
        REFERENCES socialcandor_schema.photo_albums(album_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_photo_dimensions CHECK (width_pixels > 0 AND height_pixels > 0),
    CONSTRAINT chk_file_size_limit CHECK (file_size_bytes <= 5368709120), -- 5GB limit
    CONSTRAINT chk_latitude_range CHECK (latitude IS NULL OR (latitude >= -90 AND latitude <= 90)),
    CONSTRAINT chk_longitude_range CHECK (longitude IS NULL OR (longitude >= -180 AND longitude <= 180)),
    CONSTRAINT chk_taken_date CHECK (taken_at IS NULL OR taken_at <= CURRENT_TIMESTAMP)
);

COMMENT ON TABLE socialcandor_schema.photos IS 'Dedicated photo storage with EXIF metadata preservation and geotagging';
COMMENT ON COLUMN socialcandor_schema.photos.exif_data IS 'Complete EXIF metadata preserved from original photo';
COMMENT ON COLUMN socialcandor_schema.photos.blur_hash IS 'Compact representation of image for blurry placeholder';

-- Indexes for photos table
CREATE INDEX IF NOT EXISTS idx_photos_user_id ON socialcandor_schema.photos(user_id);
CREATE INDEX IF NOT EXISTS idx_photos_album_id ON socialcandor_schema.photos(album_id);
CREATE INDEX IF NOT EXISTS idx_photos_taken_at ON socialcandor_schema.photos(taken_at DESC);
CREATE INDEX IF NOT EXISTS idx_photos_location ON socialcandor_schema.photos USING GIST(location_coordinates);
CREATE INDEX IF NOT EXISTS idx_photos_visibility ON socialcandor_schema.photos(visibility);
CREATE INDEX IF NOT EXISTS idx_photos_camera_make ON socialcandor_schema.photos(camera_make);
CREATE INDEX IF NOT EXISTS idx_photos_created_at ON socialcandor_schema.photos(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_photos_exif_data ON socialcandor_schema.photos USING gin(exif_data);

-- Full-text search index for photo metadata
CREATE INDEX IF NOT EXISTS idx_photos_search ON socialcandor_schema.photos
USING gin(to_tsvector('english', COALESCE(alt_text, '') || ' ' || COALESCE(caption, '') || ' ' || COALESCE(location_name, '')));

------------------------------------------------------------------------------------------------
-- Now add the circular foreign key constraint to photo_albums using ALTER TABLE
------------------------------------------------------------------------------------------------
ALTER TABLE socialcandor_schema.photo_albums
ADD CONSTRAINT fk_photo_albums_cover FOREIGN KEY (cover_photo_id)
    REFERENCES socialcandor_schema.photos(photo_id) ON DELETE SET NULL;
------------------------------------------------------------------------------------------------
-- Create triggers after all tables and constraints are established
------------------------------------------------------------------------------------------------
-- Create or replace the update_updated_at_column function if it doesn't exist
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for photos updated_at
CREATE OR REPLACE TRIGGER trg_photos_updated_at
    BEFORE UPDATE ON socialcandor_schema.photos
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Trigger for photo_albums updated_at
CREATE OR REPLACE TRIGGER trg_photo_albums_updated_at
    BEFORE UPDATE ON socialcandor_schema.photo_albums
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Function to update album statistics when photos are added
CREATE OR REPLACE FUNCTION socialcandor_schema.update_album_statistics_on_insert()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.album_id IS NOT NULL THEN
        UPDATE socialcandor_schema.photo_albums
        SET
            photo_count = photo_count + 1,
            total_size_bytes = total_size_bytes + COALESCE(NEW.file_size_bytes, 0),
            last_photo_added_at = NEW.created_at,
            updated_at = CURRENT_TIMESTAMP
        WHERE album_id = NEW.album_id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function to update album statistics when photos are deleted
CREATE OR REPLACE FUNCTION socialcandor_schema.update_album_statistics_on_delete()
RETURNS TRIGGER AS $$
BEGIN
    IF OLD.album_id IS NOT NULL THEN
        UPDATE socialcandor_schema.photo_albums
        SET
            photo_count = GREATEST(0, photo_count - 1),
            total_size_bytes = GREATEST(0, total_size_bytes - COALESCE(OLD.file_size_bytes, 0)),
            updated_at = CURRENT_TIMESTAMP
        WHERE album_id = OLD.album_id;

        -- If the deleted photo was the cover, clear the cover
        IF OLD.photo_id = (SELECT cover_photo_id FROM socialcandor_schema.photo_albums WHERE album_id = OLD.album_id) THEN
            UPDATE socialcandor_schema.photo_albums
            SET cover_photo_id = NULL,
                updated_at = CURRENT_TIMESTAMP
            WHERE album_id = OLD.album_id;
        END IF;
    END IF;
    
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

-- Trigger for album statistics on INSERT
CREATE OR REPLACE TRIGGER trg_photos_album_stats_insert
    AFTER INSERT ON socialcandor_schema.photos
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_album_statistics_on_insert();

-- Trigger for album statistics on DELETE
CREATE OR REPLACE TRIGGER trg_photos_album_stats_delete
    AFTER DELETE ON socialcandor_schema.photos
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_album_statistics_on_delete();


------------------------------------------------------------------------------------------------
-- Table: 18 - videos
-- Description: Video content repository with streaming metadata
-- Business Case: Optimizes video delivery through adaptive bitrate selection while
-- enabling creator monetization via view-based revenue sharing and content ID
-- matching for copyright protection. Supports rich video analytics and engagement tracking.
-- Feature Reference: VID01 (Video Management), STR01 (Streaming), MON04 (Video Monetization)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.videos (
    video_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Video identification
    video_type VARCHAR(20) DEFAULT 'REGULAR' CHECK (
        video_type IN ('REGULAR', 'SHORT', 'LIVE_RECORDING', 'STORY', 'REEL', 'TUTORIAL')
    ),
    original_filename VARCHAR(255),
    file_extension VARCHAR(10),
    mime_type VARCHAR(100),

    -- Storage and delivery
    storage_provider VARCHAR(50) DEFAULT 'S3' CHECK (
        storage_provider IN ('S3', 'GCS', 'AZURE', 'CDN', 'LOCAL')
    ),
    storage_key VARCHAR(500) NOT NULL,
    storage_bucket VARCHAR(255),
    storage_region VARCHAR(50),
    cdn_enabled BOOLEAN DEFAULT TRUE,
    cdn_urls JSONB DEFAULT '{}',

    -- Video metadata
    file_size_bytes BIGINT CHECK (file_size_bytes >= 0),
    duration_seconds NUMERIC(10,3) CHECK (duration_seconds >= 0),
    width_pixels INTEGER CHECK (width_pixels >= 0),
    height_pixels INTEGER CHECK (height_pixels >= 0),
    aspect_ratio VARCHAR(10),
    frame_rate NUMERIC(6,2) CHECK (frame_rate >= 0),
    bitrate_kbps INTEGER CHECK (bitrate_kbps >= 0),
    video_codec VARCHAR(50),
    audio_codec VARCHAR(50),
    audio_channels INTEGER CHECK (audio_channels >= 0),
    audio_sample_rate INTEGER CHECK (audio_sample_rate >= 0),

    -- Adaptive bitrate streaming
    abr_enabled BOOLEAN DEFAULT TRUE,
    abr_profiles JSONB DEFAULT '[]', -- Array of quality profiles
    hls_manifest_url VARCHAR(500),
    dash_manifest_url VARCHAR(500),

    -- Thumbnails and previews
    thumbnail_url VARCHAR(500),
    thumbnail_generated_at TIMESTAMP WITH TIME ZONE,
    preview_url VARCHAR(500),
    preview_duration_seconds INTEGER DEFAULT 10 CHECK (preview_duration_seconds >= 0),

    -- Content information
    title VARCHAR(200),
    description TEXT,
    language_code VARCHAR(10) DEFAULT 'en',
    category VARCHAR(100),
    tags VARCHAR(50)[] DEFAULT '{}',

    -- Copyright and licensing
    copyright_holder VARCHAR(255),
    license_type VARCHAR(100),
    content_id VARCHAR(100), -- For copyright fingerprinting
    content_id_match_score NUMERIC(5,2) DEFAULT 0.0 CHECK (content_id_match_score >= 0 AND content_id_match_score <= 100),
    monetization_policy VARCHAR(50) CHECK (
        monetization_policy IN ('MONETIZE', 'DEMONETIZE', 'CLAIM', 'TRACK', 'BLOCK')
    ),

    -- Accessibility features
    caption_track_url VARCHAR(500),
    caption_language VARCHAR(10),
    caption_generated BOOLEAN DEFAULT FALSE,
    audio_description_url VARCHAR(500),
    sign_language_url VARCHAR(500),

    -- Content safety
    nsfw_score NUMERIC(5,2) DEFAULT 0.0 CHECK (nsfw_score >= 0 AND nsfw_score <= 100),
    age_restriction VARCHAR(20) DEFAULT 'NONE' CHECK (
        age_restriction IN ('NONE', 'TEEN', 'MATURE', 'ADULT', 'RESTRICTED')
    ),
    content_warnings VARCHAR(100)[] DEFAULT '{}',

    -- Privacy and sharing
    visibility socialcandor_schema.content_visibility DEFAULT 'PUBLIC',
    embed_allowed BOOLEAN DEFAULT TRUE,
    download_allowed BOOLEAN DEFAULT FALSE,
    comments_enabled BOOLEAN DEFAULT TRUE,
    ratings_enabled BOOLEAN DEFAULT TRUE,

    -- Engagement metrics
    view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
    unique_viewers INTEGER DEFAULT 0 CHECK (unique_viewers >= 0),
    watch_time_seconds BIGINT DEFAULT 0 CHECK (watch_time_seconds >= 0),
    average_view_duration NUMERIC(10,3) DEFAULT 0 CHECK (average_view_duration >= 0),
    like_count INTEGER DEFAULT 0 CHECK (like_count >= 0),
    dislike_count INTEGER DEFAULT 0 CHECK (dislike_count >= 0),
    comment_count INTEGER DEFAULT 0 CHECK (comment_count >= 0),
    share_count INTEGER DEFAULT 0 CHECK (share_count >= 0),

    -- Monetization metrics
    revenue_generated NUMERIC(15,2) DEFAULT 0.0 CHECK (revenue_generated >= 0),
    revenue_share_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (revenue_share_percentage >= 0 AND revenue_share_percentage <= 100),
    cpm_rate NUMERIC(10,2) DEFAULT 0.0 CHECK (cpm_rate >= 0),

    -- Processing status
    processing_status VARCHAR(20) DEFAULT 'UPLOADING' CHECK (
        processing_status IN ('UPLOADING', 'QUEUED', 'PROCESSING', 'COMPLETED', 'FAILED', 'OPTIMIZING')
    ),
    processing_progress NUMERIC(5,2) DEFAULT 0.0 CHECK (processing_progress >= 0 AND processing_progress <= 100),
    processing_error TEXT,
    processing_started_at TIMESTAMP WITH TIME ZONE,
    processing_completed_at TIMESTAMP WITH TIME ZONE,

    -- Live stream metadata (if applicable)
    was_live_stream BOOLEAN DEFAULT FALSE,
    live_stream_id UUID,
    recording_started_at TIMESTAMP WITH TIME ZONE,
    recording_ended_at TIMESTAMP WITH TIME ZONE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    deleted_at TIMESTAMP WITH TIME ZONE,
    deleted_by UUID,

    -- Foreign key constraint
    CONSTRAINT fk_videos_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_video_dimensions CHECK (width_pixels > 0 AND height_pixels > 0),
    CONSTRAINT chk_duration_limit CHECK (duration_seconds <= 86400), -- 24 hours max
    CONSTRAINT chk_file_size_limit CHECK (file_size_bytes <= 107374182400), -- 100GB limit
    CONSTRAINT chk_view_metrics CHECK (unique_viewers <= view_count),
    CONSTRAINT chk_watch_time CHECK (watch_time_seconds <= view_count * duration_seconds)
);

COMMENT ON TABLE socialcandor_schema.videos IS 'Video content repository with duration tracking, view counters, and streaming metadata';
COMMENT ON COLUMN socialcandor_schema.videos.content_id IS 'Digital fingerprint for copyright content ID matching';
COMMENT ON COLUMN socialcandor_schema.videos.abr_profiles IS 'JSON array of adaptive bitrate profiles for different quality levels';

-- Indexes for videos table
CREATE INDEX IF NOT EXISTS idx_videos_user_id ON socialcandor_schema.videos(user_id);
CREATE INDEX IF NOT EXISTS idx_videos_created_at ON socialcandor_schema.videos(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_videos_view_count ON socialcandor_schema.videos(view_count DESC);
CREATE INDEX IF NOT EXISTS idx_videos_duration ON socialcandor_schema.videos(duration_seconds);
CREATE INDEX IF NOT EXISTS idx_videos_processing_status ON socialcandor_schema.videos(processing_status);
CREATE INDEX IF NOT EXISTS idx_videos_category ON socialcandor_schema.videos(category);
CREATE INDEX IF NOT EXISTS idx_videos_monetization ON socialcandor_schema.videos(monetization_policy) WHERE monetization_policy = 'MONETIZE';
CREATE INDEX IF NOT EXISTS idx_videos_content_id ON socialcandor_schema.videos(content_id) WHERE content_id IS NOT NULL;

-- Materialized view for trending videos
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_trending_videos AS
SELECT
    v.video_id,
    v.user_id,
    v.title,
    v.duration_seconds,
    v.view_count,
    v.like_count,
    v.comment_count,
    v.share_count,
    v.watch_time_seconds,
    v.created_at,
    -- Trending score calculation
    (
        (v.view_count * 1.0) +
        (v.like_count * 2.0) +
        (v.comment_count * 3.0) +
        (v.share_count * 5.0) +
        (LOG(GREATEST(v.watch_time_seconds / NULLIF(v.duration_seconds, 0), 1)) * 10.0)
    ) / POWER(EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - v.created_at)) / 3600 + 2, 1.8) AS trending_score,
    -- Engagement rate
    CASE
        WHEN v.view_count > 0
        THEN ROUND(((v.like_count + v.comment_count + v.share_count)::NUMERIC / v.view_count) * 100, 2)
        ELSE 0
    END AS engagement_rate
FROM socialcandor_schema.videos v
WHERE v.processing_status = 'COMPLETED'
  AND v.visibility = 'PUBLIC'
  AND v.created_at >= CURRENT_TIMESTAMP - INTERVAL '7 days'
  AND v.nsfw_score < 70
ORDER BY trending_score DESC
LIMIT 1000
WITH DATA;

CREATE UNIQUE INDEX idx_mv_trending_videos_id ON socialcandor_schema.mv_trending_videos(video_id);
CREATE INDEX idx_mv_trending_videos_score ON socialcandor_schema.mv_trending_videos(trending_score DESC);

-- Trigger for updated_at
CREATE TRIGGER trg_videos_updated_at
    BEFORE UPDATE ON socialcandor_schema.videos
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 19 - events
-- Description: Event management system with geocoding and capacity limits
-- Business Case: Drives real-world engagement through IRL meetups while generating
-- revenue via promoted events and ticketing integrations. Critical for platform
-- differentiation beyond digital-only interactions with comprehensive event
-- lifecycle management.
-- Feature Reference: EVT01 (Event Management), COM02 (Community Events), MON05 (Event Monetization)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.events (
    event_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    organizer_user_id UUID NOT NULL,
    host_group_id UUID,
    host_page_id UUID,

    -- Event information
    event_name VARCHAR(200) NOT NULL,
    event_slug VARCHAR(200) UNIQUE NOT NULL,
    event_type VARCHAR(30) NOT NULL DEFAULT 'SOCIAL' CHECK (
        event_type IN ('SOCIAL', 'BUSINESS', 'EDUCATIONAL', 'ENTERTAINMENT', 'SPORTS', 'CHARITY', 'NETWORKING')
    ),
    description TEXT,
    short_description VARCHAR(500),
    category VARCHAR(100),
    tags VARCHAR(50)[] DEFAULT '{}',

    -- Event timing
    start_time TIMESTAMP WITH TIME ZONE NOT NULL,
    end_time TIMESTAMP WITH TIME ZONE NOT NULL,
    timezone VARCHAR(50) DEFAULT 'UTC',
    is_all_day BOOLEAN DEFAULT FALSE,
    is_recurring BOOLEAN DEFAULT FALSE,
    recurrence_pattern VARCHAR(100),
    recurrence_end_date DATE,

    -- Location information
    location_type VARCHAR(20) DEFAULT 'PHYSICAL' CHECK (
        location_type IN ('PHYSICAL', 'VIRTUAL', 'HYBRID', 'TBD')
    ),
    venue_name VARCHAR(200),
    address_line1 VARCHAR(255),
    address_line2 VARCHAR(255),
    city VARCHAR(100),
    state_province VARCHAR(100),
    country VARCHAR(3),
    postal_code VARCHAR(20),
    location_coordinates GEOGRAPHY(POINT, 4326),
    geocoding_accuracy VARCHAR(20),

    -- Virtual event details
    virtual_event_url VARCHAR(500),
    virtual_platform VARCHAR(100),
    virtual_meeting_id VARCHAR(100),
    virtual_password VARCHAR(100),

    -- Capacity and attendance
    capacity_type VARCHAR(20) DEFAULT 'UNLIMITED' CHECK (
        capacity_type IN ('UNLIMITED', 'LIMITED', 'INVITE_ONLY', 'WAITLIST')
    ),
    max_attendees INTEGER CHECK (max_attendees >= 0),
    min_attendees INTEGER DEFAULT 1 CHECK (min_attendees >= 0),
    current_attendees INTEGER DEFAULT 0 CHECK (current_attendees >= 0),
    waitlist_enabled BOOLEAN DEFAULT FALSE,
    waitlist_capacity INTEGER CHECK (waitlist_capacity >= 0),
    current_waitlist INTEGER DEFAULT 0 CHECK (current_waitlist >= 0),

    -- Registration and ticketing
    registration_required BOOLEAN DEFAULT FALSE,
    registration_deadline TIMESTAMP WITH TIME ZONE,
    registration_type VARCHAR(20) DEFAULT 'FREE' CHECK (
        registration_type IN ('FREE', 'PAID', 'DONATION', 'INVITE_ONLY')
    ),
    ticket_price NUMERIC(10,2) DEFAULT 0.0 CHECK (ticket_price >= 0),
    ticket_currency CHAR(3) DEFAULT 'USD',
    ticket_quantity INTEGER CHECK (ticket_quantity >= 0),
    tickets_sold INTEGER DEFAULT 0 CHECK (tickets_sold >= 0),
    ticket_sales_end TIMESTAMP WITH TIME ZONE,

    -- Event visibility
    visibility socialcandor_schema.content_visibility DEFAULT 'PUBLIC',
    listing_approved BOOLEAN DEFAULT FALSE,
    promoted_event BOOLEAN DEFAULT FALSE,
    promotion_level VARCHAR(20) DEFAULT 'NONE' CHECK (
        promotion_level IN ('NONE', 'BASIC', 'FEATURED', 'SPOTLIGHT')
    ),
    promotion_ends_at TIMESTAMP WITH TIME ZONE,

    -- Event status
    event_status VARCHAR(20) DEFAULT 'DRAFT' CHECK (
        event_status IN ('DRAFT', 'PUBLISHED', 'CANCELLED', 'POSTPONED', 'COMPLETED', 'ARCHIVED')
    ),
    cancellation_reason TEXT,
    postponed_to TIMESTAMP WITH TIME ZONE,

    -- Media and branding
    cover_image_url VARCHAR(500),
    banner_image_url VARCHAR(500),
    logo_url VARCHAR(500),
    color_scheme VARCHAR(100),
    custom_css TEXT,

    -- Features and options
    chat_enabled BOOLEAN DEFAULT TRUE,
    qa_enabled BOOLEAN DEFAULT TRUE,
    networking_enabled BOOLEAN DEFAULT TRUE,
    recording_consent_required BOOLEAN DEFAULT FALSE,
    age_restriction INTEGER CHECK (age_restriction >= 0),
    dress_code VARCHAR(50),

    -- Social features
    allow_sharing BOOLEAN DEFAULT TRUE,
    allow_invites BOOLEAN DEFAULT TRUE,
    allow_rsvp_changes BOOLEAN DEFAULT TRUE,
    reminder_enabled BOOLEAN DEFAULT TRUE,
    reminder_days_before INTEGER[] DEFAULT ARRAY[1, 7], -- Days before event to send reminders

    -- Analytics and engagement
    total_views INTEGER DEFAULT 0 CHECK (total_views >= 0),
    total_shares INTEGER DEFAULT 0 CHECK (total_shares >= 0),
    total_invites_sent INTEGER DEFAULT 0 CHECK (total_invites_sent >= 0),
    engagement_score NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_score >= 0 AND engagement_score <= 100),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    published_at TIMESTAMP WITH TIME ZONE,
    archived_at TIMESTAMP WITH TIME ZONE,

    -- Foreign key constraints
    CONSTRAINT fk_events_organizer FOREIGN KEY (organizer_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_events_group FOREIGN KEY (host_group_id)
        REFERENCES socialcandor_schema.groups(group_id) ON DELETE SET NULL,
    CONSTRAINT fk_events_page FOREIGN KEY (host_page_id)
        REFERENCES socialcandor_schema.pages(page_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_event_timing CHECK (end_time > start_time),
    CONSTRAINT chk_capacity_limits CHECK (
        (capacity_type != 'LIMITED' OR max_attendees > 0) AND
        current_attendees <= COALESCE(max_attendees, current_attendees)
    ),
    CONSTRAINT chk_ticket_sales CHECK (
        (registration_type != 'PAID' OR ticket_price > 0) AND
        tickets_sold <= COALESCE(ticket_quantity, tickets_sold)
    ),
    CONSTRAINT chk_waitlist_capacity CHECK (
        (waitlist_enabled = FALSE OR waitlist_capacity > 0) AND
        current_waitlist <= COALESCE(waitlist_capacity, current_waitlist)
    ),
    CONSTRAINT chk_event_slug_format CHECK (event_slug ~ '^[a-z0-9-]{3,200}$')
);

COMMENT ON TABLE socialcandor_schema.events IS 'Event management system with location geocoding, capacity limits, and RSVP workflows';
COMMENT ON COLUMN socialcandor_schema.events.recurrence_pattern IS 'iCal/RFC5545 recurrence pattern for repeating events';

-- Indexes for events table
CREATE INDEX IF NOT EXISTS idx_events_organizer ON socialcandor_schema.events(organizer_user_id);
CREATE INDEX IF NOT EXISTS idx_events_start_time ON socialcandor_schema.events(start_time);
CREATE INDEX IF NOT EXISTS idx_events_status ON socialcandor_schema.events(event_status);
CREATE INDEX IF NOT EXISTS idx_events_location_type ON socialcandor_schema.events(location_type);
CREATE INDEX IF NOT EXISTS idx_events_location ON socialcandor_schema.events USING GIST(location_coordinates);
CREATE INDEX IF NOT EXISTS idx_events_visibility ON socialcandor_schema.events(visibility);
CREATE INDEX IF NOT EXISTS idx_events_category ON socialcandor_schema.events(category);
CREATE INDEX IF NOT EXISTS idx_events_capacity ON socialcandor_schema.events(capacity_type, current_attendees);
CREATE INDEX IF NOT EXISTS idx_events_promoted ON socialcandor_schema.events(promoted_event) WHERE promoted_event = TRUE;

-- Full-text search index for event discovery
CREATE INDEX IF NOT EXISTS idx_events_search ON socialcandor_schema.events
USING gin(to_tsvector('english', event_name || ' ' || COALESCE(description, '') || ' ' || COALESCE(short_description, '') || ' ' || COALESCE(venue_name, '')));

-- Trigger for updated_at
CREATE TRIGGER trg_events_updated_at
    BEFORE UPDATE ON socialcandor_schema.events
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 20 - events_members
-- Description: Event attendance tracking with RSVP status lifecycle
-- Business Case: Enables attendance prediction algorithms for venue planning while
-- supporting waitlist management and last-minute vacancy notifications to maximize
-- event utilization. Provides comprehensive attendee management and engagement tracking.
-- Feature Reference: EVT02 (Attendance Management), PRD01 (Predictive Analytics), NTFC03 (Event Notifications)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.events_members (
    event_membership_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    event_id UUID NOT NULL,
    user_id UUID NOT NULL,
    invited_by_user_id UUID,

    -- Membership status
    membership_status VARCHAR(20) NOT NULL DEFAULT 'INVITED' CHECK (
        membership_status IN ('INVITED', 'PENDING', 'GOING', 'NOT_GOING', 'MAYBE', 'WAITLIST', 'CHECKED_IN', 'NO_SHOW', 'CANCELLED')
    ),
    membership_type VARCHAR(20) DEFAULT 'ATTENDEE' CHECK (
        membership_type IN ('ORGANIZER', 'CO_ORGANIZER', 'SPEAKER', 'MODERATOR', 'VOLUNTEER', 'ATTENDEE', 'VIP')
    ),

    -- RSVP lifecycle
    invited_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    invited_via VARCHAR(20) CHECK (
        invited_via IN ('EVENT_PAGE', 'DIRECT_INVITE', 'GROUP_INVITE', 'FRIEND_INVITE', 'PUBLIC_LISTING')
    ),
    rsvp_status_changed_at TIMESTAMP WITH TIME ZONE,
    rsvp_note TEXT,

    -- Check-in information
    check_in_enabled BOOLEAN DEFAULT FALSE,
    checked_in_at TIMESTAMP WITH TIME ZONE,
    checked_in_by UUID,
    check_in_method VARCHAR(20) CHECK (
        check_in_method IN ('QR_CODE', 'MANUAL', 'GEO_FENCE', 'FACE_RECOGNITION')
    ),
    check_in_code VARCHAR(100),
    check_in_location GEOGRAPHY(POINT, 4326),

    -- Ticket information (if applicable)
    ticket_id UUID,
    ticket_number VARCHAR(100),
    ticket_purchased_at TIMESTAMP WITH TIME ZONE,
    ticket_price_paid NUMERIC(10,2) DEFAULT 0.0 CHECK (ticket_price_paid >= 0),
    ticket_currency CHAR(3) DEFAULT 'USD',
    ticket_refunded BOOLEAN DEFAULT FALSE,
    ticket_refunded_at TIMESTAMP WITH TIME ZONE,

    -- Guest information
    plus_one_allowed BOOLEAN DEFAULT FALSE,
    guest_count INTEGER DEFAULT 0 CHECK (guest_count >= 0),
    guest_names VARCHAR(255)[] DEFAULT '{}',

    -- Preferences and requirements
    dietary_restrictions VARCHAR(100)[] DEFAULT '{}',
    accessibility_requirements TEXT,
    special_requests TEXT,
    receive_updates BOOLEAN DEFAULT TRUE,
    receive_reminders BOOLEAN DEFAULT TRUE,
    share_attendance BOOLEAN DEFAULT TRUE,

    -- Engagement metrics
    event_views INTEGER DEFAULT 0 CHECK (event_views >= 0),
    last_viewed_at TIMESTAMP WITH TIME ZONE,
    questions_asked INTEGER DEFAULT 0 CHECK (questions_asked >= 0),
    polls_participated INTEGER DEFAULT 0 CHECK (polls_participated >= 0),
    networking_connections_made INTEGER DEFAULT 0 CHECK (networking_connections_made >= 0),

    -- Feedback and ratings
    rating_submitted BOOLEAN DEFAULT FALSE,
    rating_value INTEGER CHECK (rating_value >= 1 AND rating_value <= 5),
    rating_submitted_at TIMESTAMP WITH TIME ZONE,
    feedback_text TEXT,
    would_recommend BOOLEAN,

    -- Waitlist management
    waitlist_position INTEGER CHECK (waitlist_position >= 0),
    waitlisted_at TIMESTAMP WITH TIME ZONE,
    waitlist_upgraded_at TIMESTAMP WITH TIME ZONE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    deleted_at TIMESTAMP WITH TIME ZONE,
    deleted_by UUID,

    -- Foreign key constraints
    CONSTRAINT fk_events_members_event FOREIGN KEY (event_id)
        REFERENCES socialcandor_schema.events(event_id) ON DELETE CASCADE,
    CONSTRAINT fk_events_members_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_events_members_invited_by FOREIGN KEY (invited_by_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_events_members_checked_by FOREIGN KEY (checked_in_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT uk_events_members UNIQUE (event_id, user_id),
    CONSTRAINT chk_membership_timeline CHECK (
        (invited_at <= COALESCE(rsvp_status_changed_at, invited_at)) AND
        (checked_in_at IS NULL OR checked_in_at >= invited_at)
    ),
    CONSTRAINT chk_ticket_purchase CHECK (
        (ticket_purchased_at IS NULL) OR
        (ticket_price_paid >= 0 AND ticket_purchased_at >= invited_at)
    ),
    CONSTRAINT chk_waitlist_position CHECK (
        (membership_status != 'WAITLIST' OR waitlist_position > 0) OR
        membership_status = 'WAITLIST'
    )
);

COMMENT ON TABLE socialcandor_schema.events_members IS 'Event attendance tracking with RSVP status lifecycle and reminder preferences';
COMMENT ON COLUMN socialcandor_schema.events_members.check_in_code IS 'Unique code for attendee check-in (QR code data)';

-- Indexes for events_members table
CREATE INDEX IF NOT EXISTS idx_events_members_event ON socialcandor_schema.events_members(event_id);
CREATE INDEX IF NOT EXISTS idx_events_members_user ON socialcandor_schema.events_members(user_id);
CREATE INDEX IF NOT EXISTS idx_events_members_status ON socialcandor_schema.events_members(membership_status);
CREATE INDEX IF NOT EXISTS idx_events_members_type ON socialcandor_schema.events_members(membership_type);
CREATE INDEX IF NOT EXISTS idx_events_members_check_in ON socialcandor_schema.events_members(checked_in_at) WHERE checked_in_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_events_members_waitlist ON socialcandor_schema.events_members(waitlist_position) WHERE membership_status = 'WAITLIST';
CREATE INDEX IF NOT EXISTS idx_events_members_invited_by ON socialcandor_schema.events_members(invited_by_user_id);

-- Trigger to update event attendance counts
CREATE OR REPLACE FUNCTION socialcandor_schema.update_event_attendance_counts()
RETURNS TRIGGER AS $$
DECLARE
    v_old_status VARCHAR(20);
    v_new_status VARCHAR(20);
    v_event_capacity INTEGER;
    v_current_attendees INTEGER;
BEGIN
    -- Get old and new status
    v_old_status := COALESCE(OLD.membership_status, 'INVITED');
    v_new_status := NEW.membership_status;

    -- Only process if status changed
    IF v_old_status = v_new_status THEN
        RETURN NEW;
    END IF;

    -- Get event capacity
    SELECT max_attendees, current_attendees
    INTO v_event_capacity, v_current_attendees
    FROM socialcandor_schema.events
    WHERE event_id = NEW.event_id;

    -- Update counts based on status changes
    IF v_new_status = 'GOING' AND v_old_status != 'GOING' THEN
        -- Increment attendee count
        UPDATE socialcandor_schema.events
        SET current_attendees = current_attendees + 1 + NEW.guest_count,
            updated_at = CURRENT_TIMESTAMP
        WHERE event_id = NEW.event_id;

    ELSIF v_old_status = 'GOING' AND v_new_status != 'GOING' THEN
        -- Decrement attendee count
        UPDATE socialcandor_schema.events
        SET current_attendees = GREATEST(0, current_attendees - 1 - OLD.guest_count),
            updated_at = CURRENT_TIMESTAMP
        WHERE event_id = NEW.event_id;

    END IF;

    -- Handle waitlist
    IF v_new_status = 'WAITLIST' AND v_old_status != 'WAITLIST' THEN
        -- Add to waitlist count
        UPDATE socialcandor_schema.events
        SET current_waitlist = current_waitlist + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE event_id = NEW.event_id;

        -- Set waitlist position
        NEW.waitlist_position := (
            SELECT COUNT(*) + 1
            FROM socialcandor_schema.events_members
            WHERE event_id = NEW.event_id
            AND membership_status = 'WAITLIST'
            AND event_membership_id != NEW.event_membership_id
        );

    ELSIF v_old_status = 'WAITLIST' AND v_new_status != 'WAITLIST' THEN
        -- Remove from waitlist count
        UPDATE socialcandor_schema.events
        SET current_waitlist = GREATEST(0, current_waitlist - 1),
            updated_at = CURRENT_TIMESTAMP
        WHERE event_id = NEW.event_id;

        -- Clear waitlist position
        NEW.waitlist_position := NULL;

        -- Update waitlist positions for others
        UPDATE socialcandor_schema.events_members
        SET waitlist_position = waitlist_position - 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE event_id = NEW.event_id
        AND membership_status = 'WAITLIST'
        AND waitlist_position > OLD.waitlist_position;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_events_members_attendance
    AFTER INSERT OR UPDATE OF membership_status ON socialcandor_schema.events_members
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_event_attendance_counts();

-- Trigger for updated_at
CREATE TRIGGER trg_events_members_updated_at
    BEFORE UPDATE ON socialcandor_schema.events_members
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 21 - user_wallets
-- Description: Virtual currency storage with multi-currency support
-- Business Case: Foundation for in-platform economy enabling tipping, paid content access,
-- and microtransactions while maintaining PCI-DSS compliance separation from actual
-- payment processing systems. Supports creator monetization and user rewards.
-- Feature Reference: WLT01 (Wallet Management), PAY01 (Payments), MON06 (Virtual Economy)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.user_wallets (
    wallet_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL UNIQUE,

    -- Balance information
    balance NUMERIC(15,2) DEFAULT 0.0 NOT NULL CHECK (balance >= 0),
    available_balance NUMERIC(15,2) DEFAULT 0.0 CHECK (available_balance >= 0 AND available_balance <= balance),
    pending_balance NUMERIC(15,2) DEFAULT 0.0 CHECK (pending_balance >= 0),
    locked_balance NUMERIC(15,2) DEFAULT 0.0 CHECK (locked_balance >= 0),

    -- Currency and settings
    currency_code CHAR(3) NOT NULL DEFAULT 'USD',
    auto_recharge_enabled BOOLEAN DEFAULT FALSE,
    auto_recharge_threshold NUMERIC(15,2) DEFAULT 10.0 CHECK (auto_recharge_threshold >= 0),
    auto_recharge_amount NUMERIC(15,2) DEFAULT 50.0 CHECK (auto_recharge_amount >= 0),

    -- Limits and restrictions
    daily_spend_limit NUMERIC(15,2) DEFAULT 1000.0 CHECK (daily_spend_limit >= 0),
    daily_spent_today NUMERIC(15,2) DEFAULT 0.0 CHECK (daily_spent_today >= 0),
    monthly_spend_limit NUMERIC(15,2) DEFAULT 5000.0 CHECK (monthly_spend_limit >= 0),
    monthly_spent_this_month NUMERIC(15,2) DEFAULT 0.0 CHECK (monthly_spent_this_month >= 0),
    transaction_limit_per_day INTEGER DEFAULT 100 CHECK (transaction_limit_per_day >= 0),
    transactions_today INTEGER DEFAULT 0 CHECK (transactions_today >= 0),

    -- Verification and compliance
    verification_level VARCHAR(20) DEFAULT 'BASIC' CHECK (
        verification_level IN ('BASIC', 'VERIFIED', 'ENHANCED', 'FULL')
    ),
    kyc_verified BOOLEAN DEFAULT FALSE,
    kyc_verified_at TIMESTAMP WITH TIME ZONE,
    kyc_document_type VARCHAR(50),
    kyc_document_id VARCHAR(100),
    compliance_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
        compliance_status IN ('ACTIVE', 'RESTRICTED', 'SUSPENDED', 'CLOSED')
    ),

    -- Security features
    pin_hash VARCHAR(255),
    pin_attempts INTEGER DEFAULT 0 CHECK (pin_attempts >= 0),
    pin_locked_until TIMESTAMP WITH TIME ZONE,
    two_factor_enabled BOOLEAN DEFAULT FALSE,
    last_password_change TIMESTAMP WITH TIME ZONE,

    -- Wallet status
    wallet_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
        wallet_status IN ('ACTIVE', 'INACTIVE', 'SUSPENDED', 'CLOSED', 'FROZEN')
    ),
    activation_date TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    closure_date TIMESTAMP WITH TIME ZONE,
    closure_reason TEXT,

    -- Linked payment methods
    default_payment_method_id UUID,
    linked_bank_accounts INTEGER DEFAULT 0 CHECK (linked_bank_accounts >= 0),
    linked_cards INTEGER DEFAULT 0 CHECK (linked_cards >= 0),

    -- Statistics
    total_deposits NUMERIC(15,2) DEFAULT 0.0 CHECK (total_deposits >= 0),
    total_withdrawals NUMERIC(15,2) DEFAULT 0.0 CHECK (total_withdrawals >= 0),
    total_transactions INTEGER DEFAULT 0 CHECK (total_transactions >= 0),
    total_fees_paid NUMERIC(15,2) DEFAULT 0.0 CHECK (total_fees_paid >= 0),
    last_transaction_at TIMESTAMP WITH TIME ZONE,
    last_deposit_at TIMESTAMP WITH TIME ZONE,
    last_withdrawal_at TIMESTAMP WITH TIME ZONE,

    -- Reward program
    reward_points INTEGER DEFAULT 0 CHECK (reward_points >= 0),
    loyalty_tier VARCHAR(20) DEFAULT 'BRONZE' CHECK (
        loyalty_tier IN ('BRONZE', 'SILVER', 'GOLD', 'PLATINUM', 'DIAMOND')
    ),
    cashback_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (cashback_percentage >= 0 AND cashback_percentage <= 100),

    -- Risk assessment
    risk_score NUMERIC(5,2) DEFAULT 50.0 CHECK (risk_score >= 0 AND risk_score <= 100),
    risk_level VARCHAR(20) DEFAULT 'LOW' CHECK (
        risk_level IN ('LOW', 'MEDIUM', 'HIGH', 'VERY_HIGH')
    ),
    last_risk_assessment TIMESTAMP WITH TIME ZONE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_user_wallets_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_balance_consistency CHECK (
        available_balance + pending_balance + locked_balance <= balance
    ),
    CONSTRAINT chk_spending_limits CHECK (
        daily_spent_today <= daily_spend_limit AND
        monthly_spent_this_month <= monthly_spend_limit
    ),
    CONSTRAINT chk_transaction_limits CHECK (
        transactions_today <= transaction_limit_per_day
    ),
    CONSTRAINT chk_verification_requirements CHECK (
        (verification_level != 'ENHANCED' OR kyc_verified = TRUE) AND
        (verification_level != 'FULL' OR kyc_verified = TRUE)
    )
);

COMMENT ON TABLE socialcandor_schema.user_wallets IS 'Virtual currency storage with balance tracking and multi-currency support';
COMMENT ON COLUMN socialcandor_schema.user_wallets.pending_balance IS 'Funds in pending transactions (e.g., unconfirmed tips)';
COMMENT ON COLUMN socialcandor_schema.user_wallets.locked_balance IS 'Funds temporarily locked (e.g., for disputes, holds)';

-- Indexes for user_wallets table
CREATE INDEX IF NOT EXISTS idx_user_wallets_user ON socialcandor_schema.user_wallets(user_id);
CREATE INDEX IF NOT EXISTS idx_user_wallets_balance ON socialcandor_schema.user_wallets(balance DESC);
CREATE INDEX IF NOT EXISTS idx_user_wallets_status ON socialcandor_schema.user_wallets(wallet_status);
CREATE INDEX IF NOT EXISTS idx_user_wallets_verification ON socialcandor_schema.user_wallets(verification_level);
CREATE INDEX IF NOT EXISTS idx_user_wallets_risk ON socialcandor_schema.user_wallets(risk_level);
CREATE INDEX IF NOT EXISTS idx_user_wallets_loyalty ON socialcandor_schema.user_wallets(loyalty_tier);
CREATE INDEX IF NOT EXISTS idx_user_wallets_compliance ON socialcandor_schema.user_wallets(compliance_status);

-- Trigger to reset daily/monthly counters
CREATE OR REPLACE FUNCTION socialcandor_schema.reset_wallet_daily_counters()
RETURNS TRIGGER AS $$
BEGIN
    -- Reset daily counters at midnight
    IF DATE(NEW.updated_at) > DATE(OLD.updated_at) THEN
        NEW.daily_spent_today := 0;
        NEW.transactions_today := 0;
    END IF;

    -- Reset monthly counters at month start
    IF DATE_TRUNC('month', NEW.updated_at) > DATE_TRUNC('month', OLD.updated_at) THEN
        NEW.monthly_spent_this_month := 0;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_user_wallets_reset_counters
    BEFORE UPDATE ON socialcandor_schema.user_wallets
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.reset_wallet_daily_counters();

-- Trigger for updated_at
CREATE TRIGGER trg_user_wallets_updated_at
    BEFORE UPDATE ON socialcandor_schema.user_wallets
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 22 - wallet_transactions
-- Description: Immutable financial ledger with revenue attribution
-- Business Case: Enables LTV analysis, subscription billing reconciliation, and
-- regulatory-compliant financial reporting with full auditability for SOX/internal
-- controls requirements. Provides complete transaction history for dispute resolution.
-- Feature Reference: TXN01 (Transaction Ledger), AUD01 (Financial Auditing), ANL02 (Revenue Analytics)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.wallet_transactions (
    transaction_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    wallet_id UUID NOT NULL,
    user_id UUID NOT NULL,

    -- Transaction identification
    transaction_type VARCHAR(30) NOT NULL CHECK (
        transaction_type IN ('DEPOSIT', 'WITHDRAWAL', 'TRANSFER', 'TIP', 'PURCHASE',
                           'REFUND', 'REWARD', 'CASHBACK', 'FEE', 'ADJUSTMENT', 'BONUS')
    ),
    transaction_subtype VARCHAR(50),
    external_transaction_id VARCHAR(100) UNIQUE,
    correlation_id UUID, -- For grouping related transactions

    -- Amount and currency
    amount NUMERIC(15,2) NOT NULL CHECK (amount != 0),
    currency_code CHAR(3) NOT NULL DEFAULT 'USD',
    exchange_rate NUMERIC(10,6) DEFAULT 1.0 CHECK (exchange_rate > 0),
    converted_amount NUMERIC(15,2) CHECK (converted_amount IS NULL OR converted_amount != 0),
    converted_currency CHAR(3),

    -- Fee information
    fee_amount NUMERIC(15,2) DEFAULT 0.0 CHECK (fee_amount >= 0),
    fee_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (fee_percentage >= 0 AND fee_percentage <= 100),
    net_amount NUMERIC(15,2) NOT NULL,
    platform_fee_amount NUMERIC(15,2) DEFAULT 0.0 CHECK (platform_fee_amount >= 0),
    processing_fee_amount NUMERIC(15,2) DEFAULT 0.0 CHECK (processing_fee_amount >= 0),

    -- Balance tracking
    balance_before NUMERIC(15,2) NOT NULL,
    balance_after NUMERIC(15,2) NOT NULL,
    available_balance_before NUMERIC(15,2) NOT NULL,
    available_balance_after NUMERIC(15,2) NOT NULL,

    -- Parties involved
    counterparty_wallet_id UUID,
    counterparty_user_id UUID,
    counterparty_name VARCHAR(255),
    beneficiary_name VARCHAR(255),

    -- Source/destination
    source_type VARCHAR(50) CHECK (
        source_type IN ('CREDIT_CARD', 'BANK_ACCOUNT', 'PAYPAL', 'STRIPE', 'WALLET', 'SYSTEM')
    ),
    source_id VARCHAR(100),
    destination_type VARCHAR(50) CHECK (
        destination_type IN ('CREDIT_CARD', 'BANK_ACCOUNT', 'PAYPAL', 'STRIPE', 'WALLET', 'SYSTEM')
    ),
    destination_id VARCHAR(100),

    -- Transaction context
    reference_type VARCHAR(50), -- e.g., POST, VIDEO, EVENT, SUBSCRIPTION
    reference_id UUID,
    description TEXT,
    metadata JSONB DEFAULT '{}',

    -- Revenue attribution
    campaign_source VARCHAR(100),
    campaign_medium VARCHAR(100),
    campaign_name VARCHAR(200),
    campaign_content VARCHAR(200),
    campaign_term VARCHAR(200),
    acquisition_channel VARCHAR(50),
    signup_cohort VARCHAR(50),
    revenue_attribution_model VARCHAR(50) DEFAULT 'LAST_CLICK' CHECK (
        revenue_attribution_model IN ('FIRST_CLICK', 'LAST_CLICK', 'LINEAR', 'TIME_DECAY', 'POSITION_BASED')
    ),

    -- Status and lifecycle
    transaction_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (
        transaction_status IN ('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'CANCELLED',
                              'REFUNDED', 'DISPUTED', 'REVERSED', 'HELD')
    ),
    status_reason TEXT,
    held_until TIMESTAMP WITH TIME ZONE,

    -- Timing information
    initiated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    settlement_date DATE,

    -- Risk and compliance
    risk_score NUMERIC(5,2) DEFAULT 0.0 CHECK (risk_score >= 0 AND risk_score <= 100),
    risk_flags VARCHAR(50)[] DEFAULT '{}',
    compliance_reviewed BOOLEAN DEFAULT FALSE,
    compliance_reviewed_by UUID,
    compliance_reviewed_at TIMESTAMP WITH TIME ZONE,
    compliance_notes TEXT,

    -- Dispute information
    dispute_opened BOOLEAN DEFAULT FALSE,
    dispute_reason TEXT,
    dispute_opened_at TIMESTAMP WITH TIME ZONE,
    dispute_resolved_at TIMESTAMP WITH TIME ZONE,
    dispute_resolution VARCHAR(20) CHECK (
        dispute_resolution IN ('REFUNDED', 'CHARGED_BACK', 'RESOLVED_IN_FAVOR', 'CANCELLED')
    ),

    -- Audit trail
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_wallet_transactions_wallet FOREIGN KEY (wallet_id)
        REFERENCES socialcandor_schema.user_wallets(wallet_id) ON DELETE RESTRICT,
    CONSTRAINT fk_wallet_transactions_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE RESTRICT,
    CONSTRAINT fk_wallet_transactions_counterparty_wallet FOREIGN KEY (counterparty_wallet_id)
        REFERENCES socialcandor_schema.user_wallets(wallet_id) ON DELETE SET NULL,
    CONSTRAINT fk_wallet_transactions_counterparty_user FOREIGN KEY (counterparty_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_balance_consistency CHECK (balance_after = balance_before + amount),
    CONSTRAINT chk_amount_sign CHECK (
        (transaction_type IN ('DEPOSIT', 'REFUND', 'REWARD', 'CASHBACK', 'BONUS') AND amount > 0) OR
        (transaction_type IN ('WITHDRAWAL', 'PURCHASE', 'TIP', 'FEE') AND amount < 0) OR
        (transaction_type = 'TRANSFER' AND amount != 0) OR
        (transaction_type = 'ADJUSTMENT')
    ),
    CONSTRAINT chk_net_amount CHECK (net_amount = amount - fee_amount),
    CONSTRAINT chk_timing CHECK (
        (initiated_at <= COALESCE(processed_at, initiated_at)) AND
        (processed_at <= COALESCE(completed_at, processed_at)) AND
        (completed_at IS NULL OR completed_at >= initiated_at)
    )
);

COMMENT ON TABLE socialcandor_schema.wallet_transactions IS 'Immutable financial ledger with revenue attribution fields for auditability';
COMMENT ON COLUMN socialcandor_schema.wallet_transactions.correlation_id IS 'For grouping related transactions (e.g., purchase and fee)';
COMMENT ON COLUMN socialcandor_schema.wallet_transactions.revenue_attribution_model IS 'Model used for attributing revenue to marketing campaigns';

-- Indexes for wallet_transactions table
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_wallet ON socialcandor_schema.wallet_transactions(wallet_id);
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_user ON socialcandor_schema.wallet_transactions(user_id);
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_type ON socialcandor_schema.wallet_transactions(transaction_type);
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_status ON socialcandor_schema.wallet_transactions(transaction_status);
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_date ON socialcandor_schema.wallet_transactions(initiated_at DESC);
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_counterparty ON socialcandor_schema.wallet_transactions(counterparty_user_id);
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_reference ON socialcandor_schema.wallet_transactions(reference_type, reference_id);
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_external_id ON socialcandor_schema.wallet_transactions(external_transaction_id) WHERE external_transaction_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_campaign ON socialcandor_schema.wallet_transactions(campaign_source, campaign_medium, campaign_name);

-- Composite index for common queries
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_user_date_type ON socialcandor_schema.wallet_transactions(user_id, initiated_at DESC, transaction_type);

-- Partition by month for large-scale systems (commented out - implement as needed)
-- CREATE TABLE socialcandor_schema.wallet_transactions_2024_01 PARTITION OF socialcandor_schema.wallet_transactions
-- FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- Trigger to update wallet balances
CREATE OR REPLACE FUNCTION socialcandor_schema.update_wallet_balance_from_transaction()
RETURNS TRIGGER AS $$
DECLARE
    v_wallet_record RECORD;
    v_daily_spent NUMERIC(15,2);
    v_monthly_spent NUMERIC(15,2);
BEGIN
    -- Get current wallet state
    SELECT * INTO v_wallet_record
    FROM socialcandor_schema.user_wallets
    WHERE wallet_id = NEW.wallet_id
    FOR UPDATE;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'Wallet not found: %', NEW.wallet_id;
    END IF;

    -- Calculate new balances
    NEW.balance_before := v_wallet_record.balance;
    NEW.available_balance_before := v_wallet_record.available_balance;

    -- Update based on transaction type and status
    IF NEW.transaction_status = 'COMPLETED' THEN
        NEW.balance_after := v_wallet_record.balance + NEW.amount;
        NEW.available_balance_after := v_wallet_record.available_balance + NEW.net_amount;

        -- Update wallet
        UPDATE socialcandor_schema.user_wallets
        SET
            balance = balance + NEW.amount,
            available_balance = available_balance + NEW.net_amount,
            total_transactions = total_transactions + 1,
            last_transaction_at = NEW.initiated_at,
            updated_at = CURRENT_TIMESTAMP
        WHERE wallet_id = NEW.wallet_id;

        -- Update spend counters for negative amounts (spending)
        IF NEW.amount < 0 THEN
            v_daily_spent := ABS(NEW.amount);
            v_monthly_spent := ABS(NEW.amount);

            UPDATE socialcandor_schema.user_wallets
            SET
                daily_spent_today = daily_spent_today + v_daily_spent,
                monthly_spent_this_month = monthly_spent_this_month + v_monthly_spent,
                transactions_today = transactions_today + 1,
                updated_at = CURRENT_TIMESTAMP
            WHERE wallet_id = NEW.wallet_id;

            -- Update deposit/withdrawal totals
            IF NEW.transaction_type = 'WITHDRAWAL' THEN
                UPDATE socialcandor_schema.user_wallets
                SET
                    total_withdrawals = total_withdrawals + ABS(NEW.amount),
                    last_withdrawal_at = NEW.initiated_at,
                    updated_at = CURRENT_TIMESTAMP
                WHERE wallet_id = NEW.wallet_id;
            END IF;

        -- Update deposit totals for positive amounts
        ELSIF NEW.amount > 0 AND NEW.transaction_type = 'DEPOSIT' THEN
            UPDATE socialcandor_schema.user_wallets
            SET
                total_deposits = total_deposits + NEW.amount,
                last_deposit_at = NEW.initiated_at,
                updated_at = CURRENT_TIMESTAMP
            WHERE wallet_id = NEW.wallet_id;
        END IF;

        -- Update fee totals
        IF NEW.fee_amount > 0 THEN
            UPDATE socialcandor_schema.user_wallets
            SET
                total_fees_paid = total_fees_paid + NEW.fee_amount,
                updated_at = CURRENT_TIMESTAMP
            WHERE wallet_id = NEW.wallet_id;
        END IF;

    ELSE
        -- For non-completed transactions, balances don't change
        NEW.balance_after := v_wallet_record.balance;
        NEW.available_balance_after := v_wallet_record.available_balance;
    END IF;

    RETURN NEW;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Error updating wallet balance: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_wallet_transactions_balance
    BEFORE INSERT ON socialcandor_schema.wallet_transactions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_wallet_balance_from_transaction();

-- Trigger for immutable updates (prevent updates except status changes)
CREATE OR REPLACE FUNCTION socialcandor_schema.prevent_transaction_updates()
RETURNS TRIGGER AS $$
BEGIN
    -- Allow only status updates and certain fields
    IF OLD.transaction_status != NEW.transaction_status OR
       OLD.status_reason != NEW.status_reason OR
       OLD.held_until != NEW.held_until OR
       OLD.dispute_opened != NEW.dispute_opened OR
       OLD.compliance_reviewed != NEW.compliance_reviewed OR
       OLD.risk_score != NEW.risk_score THEN
        RETURN NEW;
    END IF;

    -- Prevent updates to immutable fields
    IF OLD.amount != NEW.amount OR
       OLD.balance_before != NEW.balance_before OR
       OLD.balance_after != NEW.balance_after OR
       OLD.initiated_at != NEW.initiated_at OR
       OLD.reference_id != NEW.reference_id OR
       OLD.counterparty_user_id != NEW.counterparty_user_id THEN
        RAISE EXCEPTION 'Cannot modify immutable transaction fields. Transaction ID: %', OLD.transaction_id;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_wallet_transactions_immutable
    BEFORE UPDATE ON socialcandor_schema.wallet_transactions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.prevent_transaction_updates();

-- Trigger for updated_at
CREATE TRIGGER trg_wallet_transactions_updated_at
    BEFORE UPDATE ON socialcandor_schema.wallet_transactions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 23 - payment_methods
-- Description: PCI-compliant payment instrument storage with tokenization
-- Business Case: Supports seamless checkout experiences while minimizing PCI scope
-- through encrypted JSONB storage of masked card details and integration with
-- third-party payment gateways. Enables secure payment method management with
-- verification workflows and fraud prevention.
-- Feature Reference: PAY02 (Payment Methods), SEC05 (PCI Compliance), FRD01 (Fraud Prevention)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.payment_methods (
    payment_method_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,
    wallet_id UUID NOT NULL,

    -- Payment method identification
    method_type VARCHAR(30) NOT NULL CHECK (
        method_type IN ('CREDIT_CARD', 'DEBIT_CARD', 'BANK_ACCOUNT', 'PAYPAL',
                       'APPLE_PAY', 'GOOGLE_PAY', 'CRYPTO_WALLET', 'GIFT_CARD')
    ),
    method_subtype VARCHAR(50),
    provider VARCHAR(50) NOT NULL CHECK (
        provider IN ('STRIPE', 'PAYPAL', 'BRAINTREE', 'ADYEN', 'SQUARE', 'PLAID', 'CUSTOM')
    ),

    -- Tokenized/encrypted data
    token VARCHAR(500) NOT NULL UNIQUE, -- Payment gateway token
    encrypted_data JSONB DEFAULT '{}', -- Encrypted sensitive data
    last_four VARCHAR(4),
    expiry_month INTEGER CHECK (expiry_month >= 1 AND expiry_month <= 12),
    expiry_year INTEGER CHECK (expiry_year >= 2024 AND expiry_year <= 2100),

    -- Display information (masked)
    display_name VARCHAR(100),
    issuer_name VARCHAR(100),
    issuer_country VARCHAR(3),
    card_network VARCHAR(50) CHECK (
        card_network IN ('VISA', 'MASTERCARD', 'AMEX', 'DISCOVER', 'UNIONPAY', 'JCB', 'DINERS', 'OTHER')
    ),
    card_type VARCHAR(20) CHECK (
        card_type IN ('CREDIT', 'DEBIT', 'PREPAID', 'CHARGE', 'BUSINESS')
    ),

    -- Bank account details (masked)
    bank_name VARCHAR(100),
    bank_country VARCHAR(3),
    routing_number_last_four VARCHAR(4),
    account_number_last_four VARCHAR(4),
    account_type VARCHAR(20) CHECK (
        account_type IN ('CHECKING', 'SAVINGS', 'BUSINESS_CHECKING', 'BUSINESS_SAVINGS')
    ),

    -- Digital wallet details
    wallet_email VARCHAR(255),
    wallet_phone VARCHAR(20),

    -- Verification and status
    verification_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
        verification_status IN ('PENDING', 'VERIFIED', 'FAILED', 'EXPIRED', 'SUSPENDED')
    ),
    verification_method VARCHAR(50) CHECK (
        verification_method IN ('MICRODEPOSITS', 'INSTANT_VERIFICATION', 'MANUAL_REVIEW', 'TOKENIZATION')
    ),
    verification_attempts INTEGER DEFAULT 0 CHECK (verification_attempts >= 0),
    verified_at TIMESTAMP WITH TIME ZONE,
    verification_failed_reason TEXT,

    -- Usage preferences
    is_default BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    auto_recharge_enabled BOOLEAN DEFAULT FALSE,

    -- Limits and restrictions
    daily_limit NUMERIC(15,2) CHECK (daily_limit >= 0),
    monthly_limit NUMERIC(15,2) CHECK (monthly_limit >= 0),
    transaction_limit NUMERIC(15,2) CHECK (transaction_limit >= 0),
    currency_restrictions VARCHAR(3)[] DEFAULT '{}',
    country_restrictions VARCHAR(3)[] DEFAULT '{}',

    -- Risk assessment
    risk_score NUMERIC(5,2) DEFAULT 50.0 CHECK (risk_score >= 0 AND risk_score <= 100),
    risk_level VARCHAR(20) DEFAULT 'LOW' CHECK (
        risk_level IN ('LOW', 'MEDIUM', 'HIGH', 'VERY_HIGH')
    ),
    last_risk_assessment TIMESTAMP WITH TIME ZONE,
    fraud_flags VARCHAR(50)[] DEFAULT '{}',

    -- Statistics
    total_transactions INTEGER DEFAULT 0 CHECK (total_transactions >= 0),
    total_amount NUMERIC(15,2) DEFAULT 0.0 CHECK (total_amount >= 0),
    last_used_at TIMESTAMP WITH TIME ZONE,
    successful_transactions INTEGER DEFAULT 0 CHECK (successful_transactions >= 0),
    failed_transactions INTEGER DEFAULT 0 CHECK (failed_transactions >= 0),

    -- Expiry and lifecycle
    expires_at TIMESTAMP WITH TIME ZONE,
    is_expired BOOLEAN DEFAULT FALSE,
    deactivated_at TIMESTAMP WITH TIME ZONE,
    deactivation_reason TEXT,

    -- Compliance
    pci_compliant BOOLEAN DEFAULT TRUE,
    three_d_secure_enrolled BOOLEAN DEFAULT FALSE,
    three_d_secure_version VARCHAR(10),
    regulatory_compliance JSONB DEFAULT '{}',

    -- Metadata
    metadata JSONB DEFAULT '{}',
    external_references JSONB DEFAULT '{}',

    -- Audit and security
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    deleted_at TIMESTAMP WITH TIME ZONE,
    deleted_by UUID,

    -- Foreign key constraints
    CONSTRAINT fk_payment_methods_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_payment_methods_wallet FOREIGN KEY (wallet_id)
        REFERENCES socialcandor_schema.user_wallets(wallet_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_card_expiry CHECK (
        (method_type NOT IN ('CREDIT_CARD', 'DEBIT_CARD') AND expiry_month IS NULL AND expiry_year IS NULL) OR
        (method_type IN ('CREDIT_CARD', 'DEBIT_CARD') AND expiry_month IS NOT NULL AND expiry_year IS NOT NULL)
    ),
    CONSTRAINT chk_bank_details CHECK (
        (method_type != 'BANK_ACCOUNT' AND bank_name IS NULL) OR
        (method_type = 'BANK_ACCOUNT' AND bank_name IS NOT NULL)
    ),
    CONSTRAINT chk_verification_timing CHECK (
        (verified_at IS NULL) OR
        (verified_at >= created_at)
    )
);

-- Create a partial unique index for the default payment method constraint
-- This ensures only one default payment method per user
CREATE UNIQUE INDEX IF NOT EXISTS idx_unique_default_payment_per_user 
ON socialcandor_schema.payment_methods (user_id) 
WHERE is_default = TRUE;

-- Create a function to check if a payment method is expired
CREATE OR REPLACE FUNCTION socialcandor_schema.check_payment_method_expired(expires_at TIMESTAMP WITH TIME ZONE)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN expires_at IS NOT NULL AND expires_at < CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql STABLE;

-- Create a view that includes the computed is_expired column
CREATE OR REPLACE VIEW socialcandor_schema.payment_methods_with_expiry AS
SELECT 
    *,
    socialcandor_schema.check_payment_method_expired(expires_at) AS is_expired_computed
FROM socialcandor_schema.payment_methods;

-- Create other recommended indexes for performance
CREATE INDEX IF NOT EXISTS idx_payment_methods_user_id ON socialcandor_schema.payment_methods(user_id);
CREATE INDEX IF NOT EXISTS idx_payment_methods_wallet_id ON socialcandor_schema.payment_methods(wallet_id);
CREATE INDEX IF NOT EXISTS idx_payment_methods_is_active ON socialcandor_schema.payment_methods(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_payment_methods_verification_status ON socialcandor_schema.payment_methods(verification_status);
CREATE INDEX IF NOT EXISTS idx_payment_methods_token ON socialcandor_schema.payment_methods(token);
CREATE INDEX IF NOT EXISTS idx_payment_methods_expires_at ON socialcandor_schema.payment_methods(expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_payment_methods_method_type ON socialcandor_schema.payment_methods(method_type);
CREATE INDEX IF NOT EXISTS idx_payment_methods_created_at ON socialcandor_schema.payment_methods(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_payment_methods_is_expired ON socialcandor_schema.payment_methods(is_expired) WHERE is_expired = TRUE;

-- Create a trigger to automatically update the updated_at timestamp
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_payment_methods_updated_at
    BEFORE UPDATE ON socialcandor_schema.payment_methods
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Create a trigger to update is_expired when expires_at changes or periodically
CREATE OR REPLACE FUNCTION socialcandor_schema.update_payment_method_expiry_status()
RETURNS TRIGGER AS $$
BEGIN
    -- Update is_expired based on expires_at
    NEW.is_expired = (NEW.expires_at IS NOT NULL AND NEW.expires_at < CURRENT_TIMESTAMP);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_payment_method_expiry
    BEFORE INSERT OR UPDATE OF expires_at ON socialcandor_schema.payment_methods
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_payment_method_expiry_status();

-- Optional: Create a function to batch update expired payment methods
CREATE OR REPLACE FUNCTION socialcandor_schema.update_all_expired_payment_methods()
RETURNS INTEGER AS $$
DECLARE
    updated_count INTEGER;
BEGIN
    UPDATE socialcandor_schema.payment_methods
    SET is_expired = TRUE,
        updated_at = CURRENT_TIMESTAMP,
        updated_by = uuid_nil() -- System update
    WHERE expires_at IS NOT NULL 
      AND expires_at < CURRENT_TIMESTAMP
      AND is_expired = FALSE;
    
    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RETURN updated_count;
END;
$$ LANGUAGE plpgsql;

-- Optional: Create a function to check expiration status on demand
CREATE OR REPLACE FUNCTION socialcandor_schema.get_payment_method_expiration_status(p_method_id UUID)
RETURNS TABLE(
    payment_method_id UUID,
    expires_at TIMESTAMP WITH TIME ZONE,
    is_expired BOOLEAN,
    days_until_expiry INTEGER
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        pm.payment_method_id,
        pm.expires_at,
        (pm.expires_at IS NOT NULL AND pm.expires_at < CURRENT_TIMESTAMP) AS is_expired,
        CASE 
            WHEN pm.expires_at IS NOT NULL THEN
                EXTRACT(DAY FROM (pm.expires_at - CURRENT_TIMESTAMP))::INTEGER
            ELSE NULL
        END AS days_until_expiry
    FROM socialcandor_schema.payment_methods pm
    WHERE pm.payment_method_id = p_method_id;
END;
$$ LANGUAGE plpgsql STABLE;




------------------------------------------------------------------------------------------------
-- Table: 24 - system_countries
-- Description: Reference data for internationalization with currency mappings
-- Business Case: Enables localized experiences (date formats, currency display) and
-- regulatory compliance by country (GDPR vs. CCPA). Supports tax calculation and
-- shipping logic for commerce features with comprehensive country metadata.
-- Feature Reference: LOC01 (Localization), COMP05 (Regulatory Compliance), TAX01 (Tax Calculation)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.system_countries (
    country_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- ISO standards
    iso_alpha2 CHAR(2) UNIQUE NOT NULL,
    iso_alpha3 CHAR(3) UNIQUE NOT NULL,
    iso_numeric INTEGER UNIQUE NOT NULL CHECK (iso_numeric >= 0 AND iso_numeric <= 999),

    -- Country information
    country_name VARCHAR(100) NOT NULL,
    official_name VARCHAR(200),
    common_name VARCHAR(100),
    demonym VARCHAR(100),

    -- Geographic information
    region VARCHAR(50),
    subregion VARCHAR(50),
    region_code VARCHAR(10),
    subregion_code VARCHAR(10),
    continent VARCHAR(20),

    -- Contact information
    calling_code VARCHAR(10)[] DEFAULT '{}',
    country_code VARCHAR(10),
    national_prefix VARCHAR(20),
    national_number_length INTEGER[] DEFAULT '{}',
    international_prefix VARCHAR(20),

    -- Location data
    latitude NUMERIC(10,8),
    longitude NUMERIC(11,8),
    coordinates GEOGRAPHY(POINT, 4326),
    area_sq_km NUMERIC(12,2) CHECK (area_sq_km >= 0),
    landlocked BOOLEAN DEFAULT FALSE,

    -- Political information
    capital_city VARCHAR(100),
    capital_coordinates GEOGRAPHY(POINT, 4326),
    government_type VARCHAR(100),
    sovereignty VARCHAR(50),
    independent BOOLEAN DEFAULT TRUE,
    un_member BOOLEAN DEFAULT TRUE,

    -- Demographic information
    population INTEGER CHECK (population >= 0),
    population_year INTEGER CHECK (population_year >= 1900 AND population_year <= EXTRACT(YEAR FROM CURRENT_DATE)),
    population_density NUMERIC(10,2) CHECK (population_density >= 0),
    median_age NUMERIC(5,2) CHECK (median_age >= 0),
    life_expectancy NUMERIC(5,2) CHECK (life_expectancy >= 0),

    -- Economic information
    gdp_nominal NUMERIC(20,2) CHECK (gdp_nominal >= 0),
    gdp_year INTEGER CHECK (gdp_year >= 1900 AND gdp_year <= EXTRACT(YEAR FROM CURRENT_DATE)),
    gdp_per_capita NUMERIC(12,2) CHECK (gdp_per_capita >= 0),
    gini_coefficient NUMERIC(5,2) CHECK (gini_coefficient >= 0 AND gini_coefficient <= 100),
    human_development_index NUMERIC(5,3) CHECK (human_development_index >= 0 AND human_development_index <= 1),

    -- Currency information
    currency_code CHAR(3) NOT NULL,
    currency_name VARCHAR(100),
    currency_symbol VARCHAR(10),
    currency_symbol_native VARCHAR(10),
    currency_decimal_places INTEGER DEFAULT 2 CHECK (currency_decimal_places >= 0 AND currency_decimal_places <= 4),

    -- Language information
    official_languages VARCHAR(10)[] DEFAULT '{}',
    spoken_languages VARCHAR(10)[] DEFAULT '{}',

    -- Timezone information
    timezones VARCHAR(50)[] DEFAULT '{}',
    utc_offsets VARCHAR(10)[] DEFAULT '{}',
    daylight_saving VARCHAR(50),

    -- Cultural information
    date_format VARCHAR(50) DEFAULT 'YYYY-MM-DD',
    time_format VARCHAR(50) DEFAULT '24h',
    first_day_of_week VARCHAR(10) DEFAULT 'Monday',
    measurement_system VARCHAR(20) DEFAULT 'METRIC',

    -- Regulatory compliance
    data_protection_law VARCHAR(100),
    data_protection_authority VARCHAR(200),
    privacy_law_active BOOLEAN DEFAULT FALSE,
    privacy_law_name VARCHAR(100),
    privacy_law_effective_date DATE,
    consumer_protection_law VARCHAR(100),

    -- Tax information
    vat_rate NUMERIC(5,2) CHECK (vat_rate >= 0 AND vat_rate <= 100),
    vat_name VARCHAR(50),
    sales_tax_rate NUMERIC(5,2) CHECK (sales_tax_rate >= 0 AND sales_tax_rate <= 100),
    corporate_tax_rate NUMERIC(5,2) CHECK (corporate_tax_rate >= 0 AND corporate_tax_rate <= 100),
    income_tax_rate NUMERIC(5,2) CHECK (income_tax_rate >= 0 AND income_tax_rate <= 100),

    -- Commerce settings
    shipping_zones VARCHAR(50)[] DEFAULT '{}',
    shipping_carriers VARCHAR(50)[] DEFAULT '{}',
    payment_methods_available VARCHAR(50)[] DEFAULT '{}',
    restricted_payment_methods VARCHAR(50)[] DEFAULT '{}',

    -- Platform availability
    platform_available BOOLEAN DEFAULT TRUE,
    platform_launch_date DATE,
    content_restrictions JSONB DEFAULT '{}',
    age_of_consent INTEGER DEFAULT 16 CHECK (age_of_consent >= 13 AND age_of_consent <= 21),
    minimum_age INTEGER DEFAULT 13 CHECK (minimum_age >= 13 AND minimum_age <= 18),

    -- Status and metadata
    is_active BOOLEAN DEFAULT TRUE,
    is_operational BOOLEAN DEFAULT TRUE,
    last_updated DATE DEFAULT CURRENT_DATE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL DEFAULT uuid_nil(),
    updated_by UUID DEFAULT uuid_nil(),

    -- Constraints
    CONSTRAINT chk_country_codes CHECK (
        LENGTH(iso_alpha2) = 2 AND
        iso_alpha2 ~ '^[A-Z]{2}$' AND
        LENGTH(iso_alpha3) = 3 AND
        iso_alpha3 ~ '^[A-Z]{3}$'
    ),
    CONSTRAINT chk_coordinates CHECK (
        (latitude IS NULL AND longitude IS NULL) OR
        (latitude IS NOT NULL AND longitude IS NOT NULL AND
         latitude >= -90 AND latitude <= 90 AND
         longitude >= -180 AND longitude <= 180)
    ),
    CONSTRAINT chk_population_consistency CHECK (
        (population IS NULL AND population_density IS NULL) OR
        (population IS NOT NULL AND population_density IS NOT NULL)
    )
);

COMMENT ON TABLE socialcandor_schema.system_countries IS 'Reference data for internationalization with currency/phone code mappings';
COMMENT ON COLUMN socialcandor_schema.system_countries.data_protection_law IS 'Primary data protection regulation (GDPR, CCPA, etc.)';

-- Indexes for system_countries table
CREATE UNIQUE INDEX IF NOT EXISTS idx_system_countries_alpha2 ON socialcandor_schema.system_countries(iso_alpha2);
CREATE UNIQUE INDEX IF NOT EXISTS idx_system_countries_alpha3 ON socialcandor_schema.system_countries(iso_alpha3);
CREATE UNIQUE INDEX IF NOT EXISTS idx_system_countries_numeric ON socialcandor_schema.system_countries(iso_numeric);
CREATE INDEX IF NOT EXISTS idx_system_countries_region ON socialcandor_schema.system_countries(region, subregion);
CREATE INDEX IF NOT EXISTS idx_system_countries_continent ON socialcandor_schema.system_countries(continent);
CREATE INDEX IF NOT EXISTS idx_system_countries_currency ON socialcandor_schema.system_countries(currency_code);
CREATE INDEX IF NOT EXISTS idx_system_countries_active ON socialcandor_schema.system_countries(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_system_countries_platform ON socialcandor_schema.system_countries(platform_available) WHERE platform_available = TRUE;

-- Full-text search index for country discovery
CREATE INDEX IF NOT EXISTS idx_system_countries_search ON socialcandor_schema.system_countries
USING gin(to_tsvector('english', country_name || ' ' || COALESCE(official_name, '') || ' ' || COALESCE(common_name, '')));

-- Insert default countries (sample data)
INSERT INTO socialcandor_schema.system_countries (
    iso_alpha2,
    iso_alpha3,
    iso_numeric,
    country_name,
    official_name,
    common_name,
    region,
    subregion,
    continent,
    calling_code,
    currency_code,
    currency_name,
    currency_symbol,
    official_languages,
    timezones,
    date_format,
    time_format,
    measurement_system,
    data_protection_law,
    privacy_law_active,
    vat_rate,
    platform_available,
    age_of_consent,
    minimum_age,
    created_by,
    updated_by
) VALUES
(
    'US', 'USA', 840,
    'United States',
    'United States of America',
    'United States',
    'Americas',
    'North America',
    'North America',
    ARRAY['1'],
    'USD',
    'United States Dollar',
    '$',
    ARRAY['en'],
    ARRAY['America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles', 'America/Anchorage', 'Pacific/Honolulu'],
    'MM/DD/YYYY',
    '12h',
    'IMPERIAL',
    'CCPA',
    TRUE,
    0.00,
    TRUE,
    16,
    13,
    uuid_nil(),
    uuid_nil()
),
(
    'GB', 'GBR', 826,
    'United Kingdom',
    'United Kingdom of Great Britain and Northern Ireland',
    'United Kingdom',
    'Europe',
    'Northern Europe',
    'Europe',
    ARRAY['44'],
    'GBP',
    'British Pound',
    'Â£',
    ARRAY['en'],
    ARRAY['Europe/London'],
    'DD/MM/YYYY',
    '24h',
    'METRIC',
    'UK GDPR',
    TRUE,
    20.00,
    TRUE,
    16,
    13,
    uuid_nil(),
    uuid_nil()
),
(
    'DE', 'DEU', 276,
    'Germany',
    'Federal Republic of Germany',
    'Germany',
    'Europe',
    'Western Europe',
    'Europe',
    ARRAY['49'],
    'EUR',
    'Euro',
    'â¬',
    ARRAY['de'],
    ARRAY['Europe/Berlin'],
    'DD.MM.YYYY',
    '24h',
    'METRIC',
    'GDPR',
    TRUE,
    19.00,
    TRUE,
    16,
    14,
    uuid_nil(),
    uuid_nil()
)
ON CONFLICT (iso_alpha2) DO UPDATE SET
    country_name = EXCLUDED.country_name,
    currency_code = EXCLUDED.currency_code,
    updated_at = CURRENT_TIMESTAMP,
    updated_by = EXCLUDED.updated_by;

-- Trigger for updated_at
CREATE TRIGGER trg_system_countries_updated_at
    BEFORE UPDATE ON socialcandor_schema.system_countries
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();
------------------------------------------------------------------------------------------------
-- Table: 26 - system_settings
-- Description: Dynamic configuration management without code deployments
-- Business Case: Enables feature flagging, A/B test configuration, and emergency
-- circuit breakers while maintaining audit trails for configuration changes.
-- Supports dynamic configuration updates without requiring application restarts.
-- Feature Reference: CFG01 (Configuration Management), FTR01 (Feature Flags), EXP01 (A/B Testing)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.system_settings (
    setting_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Setting identification
    setting_key VARCHAR(200) UNIQUE NOT NULL,
    setting_group VARCHAR(100) NOT NULL DEFAULT 'GENERAL',
    setting_category VARCHAR(100),
    setting_type VARCHAR(30) NOT NULL DEFAULT 'STRING' CHECK (
        setting_type IN ('STRING', 'INTEGER', 'BOOLEAN', 'DECIMAL', 'JSON', 'ARRAY', 'OBJECT', 'ENUM')
    ),

    -- Setting value (type-specific columns)
    string_value VARCHAR(1000),
    integer_value BIGINT,
    boolean_value BOOLEAN,
    decimal_value NUMERIC(20,6),
    json_value JSONB,
    array_value JSONB, -- JSON array
    object_value JSONB, -- JSON object

    -- Derived value for easy access
    display_value VARCHAR(1000) GENERATED ALWAYS AS (
        CASE setting_type
            WHEN 'STRING' THEN string_value
            WHEN 'INTEGER' THEN integer_value::text
            WHEN 'BOOLEAN' THEN boolean_value::text
            WHEN 'DECIMAL' THEN decimal_value::text
            WHEN 'JSON' THEN json_value::text
            WHEN 'ARRAY' THEN array_value::text
            WHEN 'OBJECT' THEN object_value::text
            ELSE NULL
        END
    ) STORED,

    -- Validation and constraints
    validation_rules JSONB DEFAULT '{}',
    allowed_values JSONB DEFAULT '[]', -- For ENUM type
    min_value NUMERIC(20,6),
    max_value NUMERIC(20,6),
    pattern VARCHAR(500), -- Regex pattern for validation
    is_required BOOLEAN DEFAULT FALSE,

    -- Environment and scope
    environment VARCHAR(50) DEFAULT 'PRODUCTION' CHECK (
        environment IN ('DEVELOPMENT', 'STAGING', 'PRODUCTION', 'ALL')
    ),
    application VARCHAR(100) DEFAULT 'ALL',
    tenant_id UUID, -- For multi-tenant configurations
    user_id UUID, -- For user-specific configurations

    -- Access control
    access_level VARCHAR(20) DEFAULT 'PUBLIC' CHECK (
        access_level IN ('PRIVATE', 'INTERNAL', 'PUBLIC', 'RESTRICTED')
    ),
    editable_by_roles VARCHAR(50)[] DEFAULT '{}',
    viewable_by_roles VARCHAR(50)[] DEFAULT '{}',

    -- Feature flag specific
    is_feature_flag BOOLEAN DEFAULT FALSE,
    feature_flag_type VARCHAR(20) CHECK (
        feature_flag_type IN ('RELEASE', 'EXPERIMENT', 'OPERATIONAL', 'PERMISSION')
    ),
    rollout_percentage INTEGER DEFAULT 100 CHECK (rollout_percentage >= 0 AND rollout_percentage <= 100),
    target_users UUID[] DEFAULT '{}',
    target_segments VARCHAR(100)[] DEFAULT '{}',
    target_countries VARCHAR(3)[] DEFAULT '{}',

    -- A/B testing specific
    is_experiment BOOLEAN DEFAULT FALSE,
    experiment_id UUID,
    experiment_variant VARCHAR(50),
    experiment_weight INTEGER DEFAULT 50 CHECK (experiment_weight >= 0 AND experiment_weight <= 100),

    -- Circuit breaker specific
    is_circuit_breaker BOOLEAN DEFAULT FALSE,
    circuit_state VARCHAR(20) DEFAULT 'CLOSED' CHECK (
        circuit_state IN ('CLOSED', 'OPEN', 'HALF_OPEN')
    ),
    failure_threshold INTEGER DEFAULT 5 CHECK (failure_threshold >= 0),
    success_threshold INTEGER DEFAULT 3 CHECK (success_threshold >= 0),
    timeout_seconds INTEGER DEFAULT 60 CHECK (timeout_seconds >= 0),

    -- Change management
    change_reason TEXT,
    change_ticket VARCHAR(100),
    scheduled_change TIMESTAMP WITH TIME ZONE,
    scheduled_change_value JSONB,

    -- Versioning
    version INTEGER DEFAULT 1 CHECK (version >= 1),
    previous_value JSONB,
    deprecated BOOLEAN DEFAULT FALSE,
    deprecated_at TIMESTAMP WITH TIME ZONE,
    deprecated_by UUID,

    -- Status and lifecycle
    is_active BOOLEAN DEFAULT TRUE,
    is_sensitive BOOLEAN DEFAULT FALSE,
    is_encrypted BOOLEAN DEFAULT FALSE,
    encryption_key_id UUID,

    -- Audit information
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Metadata
    description TEXT,
    documentation_url VARCHAR(500),
    examples JSONB DEFAULT '[]',

    -- Constraints
    CONSTRAINT chk_setting_value CHECK (
        -- Ensure only one value field is set based on type
        (setting_type = 'STRING' AND string_value IS NOT NULL AND integer_value IS NULL AND boolean_value IS NULL AND decimal_value IS NULL AND json_value IS NULL AND array_value IS NULL AND object_value IS NULL) OR
        (setting_type = 'INTEGER' AND integer_value IS NOT NULL AND string_value IS NULL AND boolean_value IS NULL AND decimal_value IS NULL AND json_value IS NULL AND array_value IS NULL AND object_value IS NULL) OR
        (setting_type = 'BOOLEAN' AND boolean_value IS NOT NULL AND string_value IS NULL AND integer_value IS NULL AND decimal_value IS NULL AND json_value IS NULL AND array_value IS NULL AND object_value IS NULL) OR
        (setting_type = 'DECIMAL' AND decimal_value IS NOT NULL AND string_value IS NULL AND integer_value IS NULL AND boolean_value IS NULL AND json_value IS NULL AND array_value IS NULL AND object_value IS NULL) OR
        (setting_type = 'JSON' AND json_value IS NOT NULL AND string_value IS NULL AND integer_value IS NULL AND boolean_value IS NULL AND decimal_value IS NULL AND array_value IS NULL AND object_value IS NULL) OR
        (setting_type = 'ARRAY' AND array_value IS NOT NULL AND string_value IS NULL AND integer_value IS NULL AND boolean_value IS NULL AND decimal_value IS NULL AND json_value IS NULL AND object_value IS NULL) OR
        (setting_type = 'OBJECT' AND object_value IS NOT NULL AND string_value IS NULL AND integer_value IS NULL AND boolean_value IS NULL AND decimal_value IS NULL AND json_value IS NULL AND array_value IS NULL) OR
        (setting_type = 'ENUM' AND string_value IS NOT NULL AND integer_value IS NULL AND boolean_value IS NULL AND decimal_value IS NULL AND json_value IS NULL AND array_value IS NULL AND object_value IS NULL)
    ),
    CONSTRAINT chk_value_range CHECK (
        (min_value IS NULL OR max_value IS NULL) OR
        (min_value <= max_value)
    ),
    CONSTRAINT chk_rollout_percentage CHECK (
        (is_feature_flag = FALSE OR rollout_percentage BETWEEN 0 AND 100) OR
        is_feature_flag = TRUE
    )
);

COMMENT ON TABLE socialcandor_schema.system_settings IS 'Dynamic configuration management without code deployments for feature flags and A/B tests';
COMMENT ON COLUMN socialcandor_schema.system_settings.circuit_state IS 'State of circuit breaker: CLOSED (normal), OPEN (failed), HALF_OPEN (testing)';

-- Indexes for system_settings table
CREATE UNIQUE INDEX IF NOT EXISTS idx_system_settings_key ON socialcandor_schema.system_settings(setting_key);
CREATE INDEX IF NOT EXISTS idx_system_settings_group ON socialcandor_schema.system_settings(setting_group);
CREATE INDEX IF NOT EXISTS idx_system_settings_category ON socialcandor_schema.system_settings(setting_category);
CREATE INDEX IF NOT EXISTS idx_system_settings_environment ON socialcandor_schema.system_settings(environment);
CREATE INDEX IF NOT EXISTS idx_system_settings_active ON socialcandor_schema.system_settings(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_system_settings_feature_flag ON socialcandor_schema.system_settings(is_feature_flag) WHERE is_feature_flag = TRUE;
CREATE INDEX IF NOT EXISTS idx_system_settings_experiment ON socialcandor_schema.system_settings(is_experiment) WHERE is_experiment = TRUE;
CREATE INDEX IF NOT EXISTS idx_system_settings_circuit_breaker ON socialcandor_schema.system_settings(is_circuit_breaker) WHERE is_circuit_breaker = TRUE;
CREATE INDEX IF NOT EXISTS idx_system_settings_access_level ON socialcandor_schema.system_settings(access_level);

-- Function to get setting value with type casting
CREATE OR REPLACE FUNCTION socialcandor_schema.get_setting_value(p_key VARCHAR)
RETURNS JSONB AS $$
DECLARE
    v_setting RECORD;
BEGIN
    SELECT * INTO v_setting
    FROM socialcandor_schema.system_settings
    WHERE setting_key = p_key
    AND is_active = TRUE
    AND environment IN ('ALL', 'PRODUCTION');

    IF NOT FOUND THEN
        RETURN NULL;
    END IF;

    RETURN CASE v_setting.setting_type
        WHEN 'STRING' THEN to_jsonb(v_setting.string_value)
        WHEN 'INTEGER' THEN to_jsonb(v_setting.integer_value)
        WHEN 'BOOLEAN' THEN to_jsonb(v_setting.boolean_value)
        WHEN 'DECIMAL' THEN to_jsonb(v_setting.decimal_value)
        WHEN 'JSON' THEN v_setting.json_value
        WHEN 'ARRAY' THEN v_setting.array_value
        WHEN 'OBJECT' THEN v_setting.object_value
        WHEN 'ENUM' THEN to_jsonb(v_setting.string_value)
        ELSE NULL
    END;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Insert default system settings - FIXED VERSION
-- Insert all non-ARRAY, non-JSON values first
INSERT INTO socialcandor_schema.system_settings (
    setting_key,
    setting_group,
    setting_category,
    setting_type,
    string_value,
    integer_value,
    boolean_value,
    decimal_value,
    json_value,
    description,
    environment,
    access_level,
    created_by,
    updated_by
) VALUES
-- Feature flags
(
    'feature.new_messaging_enabled',
    'FEATURES',
    'MESSAGING',
    'BOOLEAN',
    NULL,
    NULL,
    TRUE,
    NULL,
    NULL,
    'Enable new messaging interface',
    'PRODUCTION',
    'INTERNAL',
    uuid_nil(),
    uuid_nil()
),
(
    'feature.advanced_analytics_enabled',
    'FEATURES',
    'ANALYTICS',
    'BOOLEAN',
    NULL,
    NULL,
    FALSE,
    NULL,
    NULL,
    'Enable advanced analytics dashboard',
    'PRODUCTION',
    'INTERNAL',
    uuid_nil(),
    uuid_nil()
),
-- Rate limits
(
    'rate_limits.api_requests_per_minute',
    'RATE_LIMITS',
    'API',
    'INTEGER',
    NULL,
    1000,
    NULL,
    NULL,
    NULL,
    'Maximum API requests per minute per user',
    'PRODUCTION',
    'INTERNAL',
    uuid_nil(),
    uuid_nil()
),
(
    'rate_limits.upload_file_size_mb',
    'RATE_LIMITS',
    'UPLOADS',
    'INTEGER',
    NULL,
    100,
    NULL,
    NULL,
    NULL,
    'Maximum file upload size in MB',
    'PRODUCTION',
    'PUBLIC',
    uuid_nil(),
    uuid_nil()
),
-- Business rules
(
    'business.max_friends_per_user',
    'BUSINESS',
    'SOCIAL',
    'INTEGER',
    NULL,
    5000,
    NULL,
    NULL,
    NULL,
    'Maximum number of friends a user can have',
    'PRODUCTION',
    'INTERNAL',
    uuid_nil(),
    uuid_nil()
),
(
    'business.content_moderation_enabled',
    'BUSINESS',
    'MODERATION',
    'BOOLEAN',
    NULL,
    NULL,
    TRUE,
    NULL,
    NULL,
    'Enable automated content moderation',
    'PRODUCTION',
    'INTERNAL',
    uuid_nil(),
    uuid_nil()
),
-- Payment settings
(
    'payments.minimum_deposit_amount',
    'PAYMENTS',
    'WALLET',
    'DECIMAL',
    NULL,
    NULL,
    NULL,
    5.00,
    NULL,
    'Minimum deposit amount',
    'PRODUCTION',
    'PUBLIC',
    uuid_nil(),
    uuid_nil()
),
(
    'payments.currency_conversion_fee',
    'PAYMENTS',
    'FEES',
    'DECIMAL',
    NULL,
    NULL,
    NULL,
    1.50,
    NULL,
    'Currency conversion fee percentage',
    'PRODUCTION',
    'PUBLIC',
    uuid_nil(),
    uuid_nil()
),
-- Security settings
(
    'security.mfa_required',
    'SECURITY',
    'AUTHENTICATION',
    'BOOLEAN',
    NULL,
    NULL,
    FALSE,
    NULL,
    NULL,
    'Require MFA for all users',
    'PRODUCTION',
    'INTERNAL',
    uuid_nil(),
    uuid_nil()
),
(
    'security.session_timeout_minutes',
    'SECURITY',
    'SESSIONS',
    'INTEGER',
    NULL,
    60,
    NULL,
    NULL,
    NULL,
    'Session timeout in minutes',
    'PRODUCTION',
    'INTERNAL',
    uuid_nil(),
    uuid_nil()
)
ON CONFLICT (setting_key) DO UPDATE SET
    string_value = EXCLUDED.string_value,
    integer_value = EXCLUDED.integer_value,
    boolean_value = EXCLUDED.boolean_value,
    decimal_value = EXCLUDED.decimal_value,
    json_value = EXCLUDED.json_value,
    updated_at = CURRENT_TIMESTAMP,
    updated_by = EXCLUDED.updated_by;

-- Insert JSON configuration example separately
INSERT INTO socialcandor_schema.system_settings (
    setting_key,
    setting_group,
    setting_category,
    setting_type,
    json_value,
    description,
    environment,
    access_level,
    created_by,
    updated_by
) VALUES
(
    'ui.homepage_layout',
    'UI',
    'LAYOUT',
    'JSON',
    '{"show_stories": true, "show_trending": true, "show_friends_activity": false, "columns": 3}',
    'Homepage layout configuration',
    'PRODUCTION',
    'INTERNAL',
    uuid_nil(),
    uuid_nil()
)
ON CONFLICT (setting_key) DO UPDATE SET
    json_value = EXCLUDED.json_value,
    updated_at = CURRENT_TIMESTAMP,
    updated_by = EXCLUDED.updated_by;

-- Insert ARRAY configuration example separately
INSERT INTO socialcandor_schema.system_settings (
    setting_key,
    setting_group,
    setting_category,
    setting_type,
    array_value,
    description,
    environment,
    access_level,
    created_by,
    updated_by
) VALUES
(
    'content.supported_file_types',
    'CONTENT',
    'UPLOADS',
    'ARRAY',
    '["jpg", "jpeg", "png", "gif", "mp4", "mov", "pdf", "doc", "docx"]',
    'Supported file types for upload',
    'PRODUCTION',
    'PUBLIC',
    uuid_nil(),
    uuid_nil()
)
ON CONFLICT (setting_key) DO UPDATE SET
    array_value = EXCLUDED.array_value,
    updated_at = CURRENT_TIMESTAMP,
    updated_by = EXCLUDED.updated_by;

-- Audit table for setting changes
CREATE TABLE IF NOT EXISTS socialcandor_schema.system_settings_audit (
    audit_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    setting_id UUID NOT NULL,
    setting_key VARCHAR(200) NOT NULL,

    -- Old values
    old_string_value VARCHAR(1000),
    old_integer_value BIGINT,
    old_boolean_value BOOLEAN,
    old_decimal_value NUMERIC(20,6),
    old_json_value JSONB,
    old_array_value JSONB,
    old_object_value JSONB,
    old_display_value VARCHAR(1000),

    -- New values
    new_string_value VARCHAR(1000),
    new_integer_value BIGINT,
    new_boolean_value BOOLEAN,
    new_decimal_value NUMERIC(20,6),
    new_json_value JSONB,
    new_array_value JSONB,
    new_object_value JSONB,
    new_display_value VARCHAR(1000),

    -- Change metadata
    change_type VARCHAR(10) CHECK (change_type IN ('CREATE', 'UPDATE', 'DELETE')),
    change_reason TEXT,
    change_ticket VARCHAR(100),
    ip_address INET,
    user_agent TEXT,

    -- Audit trail
    changed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    changed_by UUID NOT NULL,

    -- Foreign key constraint
    CONSTRAINT fk_system_settings_audit_setting FOREIGN KEY (setting_id)
        REFERENCES socialcandor_schema.system_settings(setting_id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_system_settings_audit_setting ON socialcandor_schema.system_settings_audit(setting_id);
CREATE INDEX IF NOT EXISTS idx_system_settings_audit_key ON socialcandor_schema.system_settings_audit(setting_key);
CREATE INDEX IF NOT EXISTS idx_system_settings_audit_changed_at ON socialcandor_schema.system_settings_audit(changed_at DESC);
CREATE INDEX IF NOT EXISTS idx_system_settings_audit_changed_by ON socialcandor_schema.system_settings_audit(changed_by);

-- Trigger for auditing setting changes
CREATE OR REPLACE FUNCTION socialcandor_schema.audit_system_settings_changes()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO socialcandor_schema.system_settings_audit (
            setting_id,
            setting_key,
            new_string_value,
            new_integer_value,
            new_boolean_value,
            new_decimal_value,
            new_json_value,
            new_array_value,
            new_object_value,
            new_display_value,
            change_type,
            change_reason,
            change_ticket,
            changed_by
        ) VALUES (
            NEW.setting_id,
            NEW.setting_key,
            NEW.string_value,
            NEW.integer_value,
            NEW.boolean_value,
            NEW.decimal_value,
            NEW.json_value,
            NEW.array_value,
            NEW.object_value,
            NEW.display_value,
            'CREATE',
            NEW.change_reason,
            NEW.change_ticket,
            NEW.created_by
        );

    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO socialcandor_schema.system_settings_audit (
            setting_id,
            setting_key,
            old_string_value,
            old_integer_value,
            old_boolean_value,
            old_decimal_value,
            old_json_value,
            old_array_value,
            old_object_value,
            old_display_value,
            new_string_value,
            new_integer_value,
            new_boolean_value,
            new_decimal_value,
            new_json_value,
            new_array_value,
            new_object_value,
            new_display_value,
            change_type,
            change_reason,
            change_ticket,
            changed_by
        ) VALUES (
            NEW.setting_id,
            NEW.setting_key,
            OLD.string_value,
            OLD.integer_value,
            OLD.boolean_value,
            OLD.decimal_value,
            OLD.json_value,
            OLD.array_value,
            OLD.object_value,
            OLD.display_value,
            NEW.string_value,
            NEW.integer_value,
            NEW.boolean_value,
            NEW.decimal_value,
            NEW.json_value,
            NEW.array_value,
            NEW.object_value,
            NEW.display_value,
            'UPDATE',
            NEW.change_reason,
            NEW.change_ticket,
            NEW.updated_by
        );

    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO socialcandor_schema.system_settings_audit (
            setting_id,
            setting_key,
            old_string_value,
            old_integer_value,
            old_boolean_value,
            old_decimal_value,
            old_json_value,
            old_array_value,
            old_object_value,
            old_display_value,
            change_type,
            changed_by
        ) VALUES (
            OLD.setting_id,
            OLD.setting_key,
            OLD.string_value,
            OLD.integer_value,
            OLD.boolean_value,
            OLD.decimal_value,
            OLD.json_value,
            OLD.array_value,
            OLD.object_value,
            OLD.display_value,
            'DELETE',
            OLD.updated_by
        );
    END IF;

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_system_settings_audit
    AFTER INSERT OR UPDATE OR DELETE ON socialcandor_schema.system_settings
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.audit_system_settings_changes();

-- Trigger for updated_at
CREATE TRIGGER trg_system_settings_updated_at
    BEFORE UPDATE ON socialcandor_schema.system_settings
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();
-----------------------------------------------------------------
	

------------------------------------------------------------------------------------------------
-- Table: 27 - gdpr_consents
-- Description: Granular consent tracking for specific data processing purposes
-- Business Case: Meets GDPR Article 7 requirements for demonstrable consent while enabling
-- consent renewal campaigns and purpose-specific data deletion workflows beyond basic
-- account erasure. Provides legal defensibility for data processing activities.
-- Feature Reference: GDPR01 (Consent Management), COMP01 (Regulatory Compliance), PRV01 (Privacy)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.gdpr_consents (
    consent_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Consent identification
    consent_purpose VARCHAR(100) NOT NULL,
    consent_version VARCHAR(20) NOT NULL,
    consent_channel VARCHAR(50) NOT NULL CHECK (
        consent_channel IN ('WEB_FORM', 'MOBILE_APP', 'EMAIL', 'SMS', 'IN_PERSON', 'PHONE', 'API')
    ),

    -- Consent status
    consent_status socialcandor_schema.consent_status NOT NULL DEFAULT 'PENDING',
    granted_at TIMESTAMP WITH TIME ZONE,
    withdrawn_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,

    -- Legal basis and documentation
    legal_basis VARCHAR(50) NOT NULL CHECK (
        legal_basis IN ('CONSENT', 'CONTRACT', 'LEGAL_OBLIGATION', 'VITAL_INTERESTS', 'PUBLIC_TASK', 'LEGITIMATE_INTEREST')
    ),
    legitimate_interest_assessment_url VARCHAR(500),
    privacy_notice_version VARCHAR(20),
    privacy_notice_url VARCHAR(500),

    -- Consent details
    consent_statement TEXT NOT NULL,
    consent_language VARCHAR(10) DEFAULT 'en',
    is_explicit BOOLEAN DEFAULT TRUE,
    is_informed BOOLEAN DEFAULT TRUE,
    is_unambiguous BOOLEAN DEFAULT TRUE,
    is_specific BOOLEAN DEFAULT TRUE,

    -- Collection context
    ip_address INET,
    user_agent TEXT,
    device_id VARCHAR(255),
    session_id VARCHAR(100),

    -- Renewal management
    renewal_required BOOLEAN DEFAULT FALSE,
    renewal_due_date TIMESTAMP WITH TIME ZONE,
    renewal_attempts INTEGER DEFAULT 0,
    last_renewal_attempt TIMESTAMP WITH TIME ZONE,

    -- Third-party sharing
    third_parties JSONB DEFAULT '[]',
    data_categories JSONB DEFAULT '[]',
    retention_period_days INTEGER,

    -- Verification evidence
    verification_method VARCHAR(50) CHECK (
        verification_method IN ('DOUBLE_OPT_IN', 'CHECKBOX', 'SIGNATURE', 'VOICE_RECORDING', 'VIDEO_RECORDING')
    ),
    verification_evidence_url VARCHAR(500),
    verification_timestamp TIMESTAMP WITH TIME ZONE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    deleted_at TIMESTAMP WITH TIME ZONE,

    -- Foreign key constraint
    CONSTRAINT fk_gdpr_consents_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT uk_gdpr_consents_unique UNIQUE (user_id, consent_purpose, consent_version),
    CONSTRAINT chk_consent_timestamps CHECK (
        (granted_at IS NULL OR granted_at >= created_at) AND
        (withdrawn_at IS NULL OR withdrawn_at >= granted_at) AND
        (expires_at IS NULL OR expires_at > granted_at)
    ),
    CONSTRAINT chk_consent_validity CHECK (
        (consent_status = 'GRANTED' AND granted_at IS NOT NULL) OR
        consent_status != 'GRANTED'
    )
);

COMMENT ON TABLE socialcandor_schema.gdpr_consents IS 'Granular consent tracking for specific data processing purposes with versioning';
COMMENT ON COLUMN socialcandor_schema.gdpr_consents.consent_purpose IS 'Specific processing purpose (e.g., "Marketing Emails", "Location Tracking")';
COMMENT ON COLUMN socialcandor_schema.gdpr_consents.legal_basis IS 'GDPR Article 6 legal basis for processing';

-- Indexes for gdpr_consents
CREATE INDEX IF NOT EXISTS idx_gdpr_consents_user ON socialcandor_schema.gdpr_consents(user_id);
CREATE INDEX IF NOT EXISTS idx_gdpr_consents_status ON socialcandor_schema.gdpr_consents(consent_status);
CREATE INDEX IF NOT EXISTS idx_gdpr_consents_purpose ON socialcandor_schema.gdpr_consents(consent_purpose);
CREATE INDEX IF NOT EXISTS idx_gdpr_consents_granted_at ON socialcandor_schema.gdpr_consents(granted_at DESC);
CREATE INDEX IF NOT EXISTS idx_gdpr_consents_expires ON socialcandor_schema.gdpr_consents(expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_gdpr_consents_renewal ON socialcandor_schema.gdpr_consents(renewal_due_date) WHERE renewal_required = TRUE;

-- Trigger for updated_at
CREATE TRIGGER trg_gdpr_consents_updated_at
    BEFORE UPDATE ON socialcandor_schema.gdpr_consents
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 28 - gdpr_data_subject_requests
-- Description: Formalized workflow engine for processing GDPR rights requests
-- Business Case: Integrates with sp_process_gdpr_request procedure to automate compliance
-- actions including data anonymization while maintaining processor accountability through
-- admin notes and timestamps. Ensures SLA adherence for regulatory requirements.
-- Feature Reference: GDPR02 (DSAR Management), WF01 (Workflow Automation), COMP02 (Compliance)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.gdpr_data_subject_requests (
    request_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Request identification
    request_type VARCHAR(50) NOT NULL CHECK (
        request_type IN ('ACCESS', 'RECTIFICATION', 'ERASURE', 'RESTRICTION', 'PORTABILITY', 'OBJECTION', 'CONSENT_WITHDRAWAL')
    ),
    request_subtype VARCHAR(100),
    request_reference VARCHAR(100) UNIQUE,

    -- Request details
    description TEXT,
    requested_data_scope JSONB DEFAULT '{}',
    preferred_format VARCHAR(50) DEFAULT 'JSON' CHECK (
        preferred_format IN ('JSON', 'CSV', 'PDF', 'XML', 'HTML')
    ),
    delivery_method VARCHAR(50) DEFAULT 'DOWNLOAD' CHECK (
        delivery_method IN ('DOWNLOAD', 'EMAIL', 'POSTAL', 'API')
    ),

    -- Status tracking
    request_status VARCHAR(30) NOT NULL DEFAULT 'RECEIVED' CHECK (
        request_status IN ('RECEIVED', 'VERIFICATION_PENDING', 'VERIFIED', 'PROCESSING',
                          'PARTIALLY_COMPLETED', 'COMPLETED', 'REJECTED', 'CANCELLED', 'ESCALATED')
    ),
    status_changed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    status_changed_by UUID,

    -- Verification details
    verification_status VARCHAR(30) DEFAULT 'PENDING' CHECK (
        verification_status IN ('PENDING', 'VERIFIED', 'FAILED', 'EXEMPT')
    ),
    verification_method VARCHAR(50),
    verification_token VARCHAR(100),
    verification_expires_at TIMESTAMP WITH TIME ZONE,
    verified_at TIMESTAMP WITH TIME ZONE,
    verified_by UUID,

    -- SLA and timing
    received_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    sla_due_date TIMESTAMP WITH TIME ZONE NOT NULL,
    completed_at TIMESTAMP WITH TIME ZONE,
    time_to_completion_days INTEGER,
    is_on_hold BOOLEAN DEFAULT FALSE,
    hold_reason TEXT,
    hold_until TIMESTAMP WITH TIME ZONE,

    -- Processing details
    assigned_to UUID,
    priority_level VARCHAR(20) DEFAULT 'NORMAL' CHECK (
        priority_level IN ('LOW', 'NORMAL', 'HIGH', 'URGENT')
    ),
    complexity_score INTEGER DEFAULT 1 CHECK (complexity_score >= 1 AND complexity_score <= 5),

    -- Data handling
    data_found_count INTEGER DEFAULT 0,
    data_processed_count INTEGER DEFAULT 0,
    data_anonymized_count INTEGER DEFAULT 0,
    data_deleted_count INTEGER DEFAULT 0,
    exported_file_url VARCHAR(500),
    exported_file_size_bytes BIGINT,
    export_checksum VARCHAR(64),

    -- Communication log
    communication_log JSONB DEFAULT '[]',
    last_communication_at TIMESTAMP WITH TIME ZONE,

    -- Rejection details
    rejection_reason TEXT,
    rejection_code VARCHAR(50),
    appeal_allowed BOOLEAN DEFAULT FALSE,
    appeal_deadline TIMESTAMP WITH TIME ZONE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_gdpr_dsr_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_gdpr_dsr_assigned_to FOREIGN KEY (assigned_to)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_gdpr_dsr_verified_by FOREIGN KEY (verified_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_sla_due_date CHECK (sla_due_date > received_at),
    CONSTRAINT chk_completion_date CHECK (
        completed_at IS NULL OR completed_at >= received_at
    ),
    CONSTRAINT chk_verification_expiry CHECK (
        verification_expires_at IS NULL OR verification_expires_at > received_at
    )
);

COMMENT ON TABLE socialcandor_schema.gdpr_data_subject_requests IS 'Formalized workflow engine for processing GDPR rights requests';
COMMENT ON COLUMN socialcandor_schema.gdpr_data_subject_requests.complexity_score IS '1-5 score estimating processing complexity (1=simple, 5=complex)';

-- Indexes for gdpr_data_subject_requests
CREATE INDEX IF NOT EXISTS idx_gdpr_dsr_user ON socialcandor_schema.gdpr_data_subject_requests(user_id);
CREATE INDEX IF NOT EXISTS idx_gdpr_dsr_status ON socialcandor_schema.gdpr_data_subject_requests(request_status);
CREATE INDEX IF NOT EXISTS idx_gdpr_dsr_type ON socialcandor_schema.gdpr_data_subject_requests(request_type);
CREATE INDEX IF NOT EXISTS idx_gdpr_dsr_received_at ON socialcandor_schema.gdpr_data_subject_requests(received_at DESC);
CREATE INDEX IF NOT EXISTS idx_gdpr_dsr_sla ON socialcandor_schema.gdpr_data_subject_requests(sla_due_date) WHERE request_status NOT IN ('COMPLETED', 'REJECTED', 'CANCELLED');
CREATE INDEX IF NOT EXISTS idx_gdpr_dsr_assigned ON socialcandor_schema.gdpr_data_subject_requests(assigned_to) WHERE assigned_to IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_gdpr_dsr_verification ON socialcandor_schema.gdpr_data_subject_requests(verification_status);

-- Trigger for automatic SLA calculation
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_dsr_sla()
RETURNS TRIGGER AS $$
BEGIN
    -- Set SLA due date (30 days from receipt for GDPR compliance)
    IF NEW.sla_due_date IS NULL THEN
        NEW.sla_due_date := NEW.received_at + INTERVAL '30 days';
    END IF;

    -- Calculate time to completion
    IF NEW.completed_at IS NOT NULL AND OLD.completed_at IS NULL THEN
        NEW.time_to_completion_days := EXTRACT(DAY FROM (NEW.completed_at - NEW.received_at));
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_gdpr_dsr_sla
    BEFORE INSERT ON socialcandor_schema.gdpr_data_subject_requests
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_dsr_sla();

-- Trigger for updated_at
CREATE TRIGGER trg_gdpr_dsr_updated_at
    BEFORE UPDATE ON socialcandor_schema.gdpr_data_subject_requests
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 29 - gdpr_processing_activities
-- Description: Article 30-compliant record of processing activities (ROPA)
-- Business Case: Essential for Data Protection Impact Assessments (DPIAs) and regulatory
-- audits while enabling purpose limitation enforcement at the application layer.
-- Documents lawful basis, data categories, and processing purposes.
-- Feature Reference: GDPR03 (ROPA Management), COMP03 (Audit Trail), DPIA01 (Impact Assessment)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.gdpr_processing_activities (
    activity_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Activity identification
    activity_name VARCHAR(200) NOT NULL UNIQUE,
    activity_description TEXT NOT NULL,
    processing_purpose VARCHAR(500) NOT NULL,
    processing_category VARCHAR(100) NOT NULL CHECK (
        processing_category IN ('COLLECTION', 'STORAGE', 'ALTERATION', 'CONSULTATION', 'DISCLOSURE', 'COMBINATION', 'ERASURE')
    ),

    -- Legal basis
    lawful_basis VARCHAR(50) NOT NULL CHECK (
        lawful_basis IN ('CONSENT', 'CONTRACT', 'LEGAL_OBLIGATION', 'VITAL_INTERESTS', 'PUBLIC_TASK', 'LEGITIMATE_INTEREST')
    ),
    legitimate_interest_description TEXT,
    legitimate_interest_balance_test_url VARCHAR(500),

    -- Data categories
    data_categories JSONB NOT NULL DEFAULT '[]',
    special_category_data BOOLEAN DEFAULT FALSE,
    special_category_basis VARCHAR(100),
    criminal_offense_data BOOLEAN DEFAULT FALSE,
    criminal_offense_basis VARCHAR(100),

    -- Data subjects
    data_subject_categories JSONB NOT NULL DEFAULT '[]',
    number_of_data_subjects VARCHAR(50) DEFAULT 'UNKNOWN',
    data_subject_geography VARCHAR(500),

    -- Recipients and transfers
    recipients JSONB DEFAULT '[]',
    international_transfers BOOLEAN DEFAULT FALSE,
    transfer_mechanisms JSONB DEFAULT '[]',
    transfer_countries JSONB DEFAULT '[]',

    -- Retention and deletion
    retention_period VARCHAR(100) NOT NULL,
    deletion_procedure TEXT,
    archival_policy VARCHAR(200),

    -- Security measures
    security_measures JSONB DEFAULT '[]',
    encryption_applied BOOLEAN DEFAULT FALSE,
    pseudonymization_applied BOOLEAN DEFAULT FALSE,
    access_controls JSONB DEFAULT '[]',

    -- DPIA and risk assessment
    dpia_required BOOLEAN DEFAULT FALSE,
    dpia_conducted BOOLEAN DEFAULT FALSE,
    dpia_date DATE,
    dpia_reference VARCHAR(100),
    risk_level VARCHAR(20) CHECK (risk_level IN ('LOW', 'MEDIUM', 'HIGH')),
    risk_mitigation TEXT,

    -- System integration
    system_components JSONB DEFAULT '[]',
    databases_affected JSONB DEFAULT '[]',
    api_endpoints JSONB DEFAULT '[]',

    -- Status and versioning
    is_active BOOLEAN DEFAULT TRUE,
    version VARCHAR(20) NOT NULL,
    effective_date DATE NOT NULL,
    review_date DATE,
    last_reviewed_at TIMESTAMP WITH TIME ZONE,
    last_reviewed_by UUID,

    -- Documentation
    documentation_url VARCHAR(500),
    policy_reference VARCHAR(100),
    procedure_reference VARCHAR(100),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Constraints
    CONSTRAINT chk_effective_date CHECK (effective_date >= CURRENT_DATE),
    CONSTRAINT chk_review_date CHECK (review_date IS NULL OR review_date > effective_date),
    CONSTRAINT chk_dpia_date CHECK (
        (dpia_required = FALSE AND dpia_date IS NULL) OR
        (dpia_required = TRUE AND dpia_date IS NOT NULL)
    )
);

COMMENT ON TABLE socialcandor_schema.gdpr_processing_activities IS 'Article 30-compliant record of processing activities (ROPA) with lawful basis documentation';
COMMENT ON COLUMN socialcandor_schema.gdpr_processing_activities.number_of_data_subjects IS 'Estimated number (e.g., "1000-5000", "ALL_USERS", "UNKNOWN")';

-- Indexes for gdpr_processing_activities
CREATE INDEX IF NOT EXISTS idx_gdpr_activities_name ON socialcandor_schema.gdpr_processing_activities(activity_name);
CREATE INDEX IF NOT EXISTS idx_gdpr_activities_category ON socialcandor_schema.gdpr_processing_activities(processing_category);
CREATE INDEX IF NOT EXISTS idx_gdpr_activities_basis ON socialcandor_schema.gdpr_processing_activities(lawful_basis);
CREATE INDEX IF NOT EXISTS idx_gdpr_activities_active ON socialcandor_schema.gdpr_processing_activities(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_gdpr_activities_dpia ON socialcandor_schema.gdpr_processing_activities(dpia_required) WHERE dpia_required = TRUE;
CREATE INDEX IF NOT EXISTS idx_gdpr_activities_review ON socialcandor_schema.gdpr_processing_activities(review_date) WHERE review_date IS NOT NULL;

-- Trigger for updated_at
CREATE TRIGGER trg_gdpr_activities_updated_at
    BEFORE UPDATE ON socialcandor_schema.gdpr_processing_activities
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 30 - data_retention_policies
-- Description: Policy engine defining automated data lifecycle management rules
-- Business Case: Integrated with sp_apply_data_retention_policy to enforce compliance
-- without manual intervention. Reduces storage costs while maintaining audit readiness
-- for 7-year financial record requirements and other regulatory mandates.
-- Feature Reference: RET01 (Retention Management), COMP04 (Regulatory Compliance), COST01 (Storage Optimization)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.data_retention_policies (
    policy_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Policy identification
    policy_name VARCHAR(200) NOT NULL UNIQUE,
    policy_description TEXT NOT NULL,
    policy_type VARCHAR(50) NOT NULL CHECK (
        policy_type IN ('REGULATORY', 'OPERATIONAL', 'LEGAL_HOLD', 'CONTRACTUAL', 'BUSINESS_NEED')
    ),

    -- Scope definition
    target_table VARCHAR(200) NOT NULL,
    target_schema VARCHAR(100) DEFAULT 'social',
    retention_column VARCHAR(100) NOT NULL,
    primary_key_column VARCHAR(100) NOT NULL,
    additional_conditions TEXT,

    -- Retention rules
    retention_period_days INTEGER NOT NULL CHECK (retention_period_days >= 0),
    retention_period_months INTEGER CHECK (retention_period_months >= 0),
    retention_period_years INTEGER CHECK (retention_period_years >= 0),
    retention_logic VARCHAR(50) DEFAULT 'FIXED_PERIOD' CHECK (
        retention_logic IN ('FIXED_PERIOD', 'EVENT_BASED', 'LAST_ACTIVITY', 'MIXED')
    ),
    event_trigger_column VARCHAR(100),

    -- Action configuration
    action_type VARCHAR(50) NOT NULL CHECK (
        action_type IN ('ARCHIVE', 'DELETE', 'ANONYMIZE', 'MOVE_TO_COLD_STORAGE')
    ),
    archive_table_name VARCHAR(200),
    archive_schema VARCHAR(100),
    anonymization_rules JSONB DEFAULT '{}',

    -- Execution settings
    is_active BOOLEAN DEFAULT TRUE,
    apply_schedule VARCHAR(100) NOT NULL DEFAULT 'DAILY', -- cron expression
    batch_size INTEGER DEFAULT 1000 CHECK (batch_size >= 100 AND batch_size <= 10000),
    max_execution_time_minutes INTEGER DEFAULT 60 CHECK (max_execution_time_minutes >= 1),

    -- Compliance mapping
    regulatory_references JSONB DEFAULT '[]',
    legal_requirements TEXT,
    exemption_allowed BOOLEAN DEFAULT FALSE,
    exemption_approval_required BOOLEAN DEFAULT TRUE,

    -- Notification settings
    notify_before_days INTEGER DEFAULT 30 CHECK (notify_before_days >= 0),
    notification_template VARCHAR(200),
    escalation_enabled BOOLEAN DEFAULT FALSE,
    escalation_after_days INTEGER DEFAULT 7 CHECK (escalation_after_days >= 1),

    -- Monitoring and auditing
    last_executed_at TIMESTAMP WITH TIME ZONE,
    last_execution_status VARCHAR(20),
    last_execution_records INTEGER DEFAULT 0,
    total_executions INTEGER DEFAULT 0,
    total_records_processed BIGINT DEFAULT 0,
    error_count INTEGER DEFAULT 0,
    last_error_message TEXT,

    -- Review and approval
    approved_by UUID,
    approved_at TIMESTAMP WITH TIME ZONE,
    review_frequency_days INTEGER DEFAULT 365 CHECK (review_frequency_days >= 30),
    next_review_date DATE,
    requires_reapproval BOOLEAN DEFAULT FALSE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Constraints
    CONSTRAINT chk_retention_period CHECK (
        retention_period_days > 0 OR
        retention_period_months > 0 OR
        retention_period_years > 0
    ),
    CONSTRAINT chk_archive_table CHECK (
        (action_type = 'ARCHIVE' AND archive_table_name IS NOT NULL) OR
        action_type != 'ARCHIVE'
    ),
    CONSTRAINT chk_anonymization_rules CHECK (
        (action_type = 'ANONYMIZE' AND anonymization_rules IS NOT NULL) OR
        action_type != 'ANONYMIZE'
    ),
    CONSTRAINT chk_next_review_date CHECK (
        next_review_date IS NULL OR next_review_date > CURRENT_DATE
    )
);

COMMENT ON TABLE socialcandor_schema.data_retention_policies IS 'Policy engine defining automated data lifecycle management rules based on regulatory requirements';
COMMENT ON COLUMN socialcandor_schema.data_retention_policies.apply_schedule IS 'Cron expression for automatic execution (e.g., "0 2 * * *" for daily at 2 AM)';

-- Indexes for data_retention_policies
CREATE INDEX IF NOT EXISTS idx_retention_policies_active ON socialcandor_schema.data_retention_policies(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_retention_policies_type ON socialcandor_schema.data_retention_policies(policy_type);
CREATE INDEX IF NOT EXISTS idx_retention_policies_table ON socialcandor_schema.data_retention_policies(target_schema, target_table);
CREATE INDEX IF NOT EXISTS idx_retention_policies_next_review ON socialcandor_schema.data_retention_policies(next_review_date);
CREATE INDEX IF NOT EXISTS idx_retention_policies_last_executed ON socialcandor_schema.data_retention_policies(last_executed_at DESC);
CREATE INDEX IF NOT EXISTS idx_retention_policies_schedule ON socialcandor_schema.data_retention_policies(apply_schedule);

-- Function to calculate next review date
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_next_review_date()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.next_review_date IS NULL AND NEW.review_frequency_days IS NOT NULL THEN
        NEW.next_review_date := CURRENT_DATE + (NEW.review_frequency_days || ' days')::INTERVAL;
    END IF;

    -- Calculate retention period in days if months or years are specified
    IF NEW.retention_period_days = 0 AND (NEW.retention_period_months > 0 OR NEW.retention_period_years > 0) THEN
        NEW.retention_period_days :=
            COALESCE(NEW.retention_period_months, 0) * 30 +
            COALESCE(NEW.retention_period_years, 0) * 365;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_retention_policies_review_date
    BEFORE INSERT OR UPDATE ON socialcandor_schema.data_retention_policies
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_next_review_date();

-- Trigger for updated_at
CREATE TRIGGER trg_retention_policies_updated_at
    BEFORE UPDATE ON socialcandor_schema.data_retention_policies
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 31 - data_archive_logs
-- Description: Immutable audit trail of data archival/deletion actions
-- Business Case: Provides defensible compliance evidence during regulatory investigations
-- while enabling storage cost optimization through tiered archival strategies.
-- Tracks record counts, execution metrics, and verification checksums.
-- Feature Reference: RET02 (Archival Audit), AUD01 (Audit Trail), COMP05 (Evidence Collection)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.data_archive_logs (
    archive_log_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    policy_id UUID NOT NULL,

    -- Execution details
    execution_type VARCHAR(50) NOT NULL CHECK (
        execution_type IN ('ARCHIVE', 'DELETE', 'ANONYMIZE', 'RESTORE', 'VALIDATE')
    ),
    execution_status VARCHAR(20) NOT NULL CHECK (
        execution_status IN ('STARTED', 'IN_PROGRESS', 'COMPLETED', 'FAILED', 'PARTIAL', 'CANCELLED')
    ),
    started_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    completed_at TIMESTAMP WITH TIME ZONE,
    duration_seconds NUMERIC(10,2),

    -- Source and target
    source_table VARCHAR(200) NOT NULL,
    source_schema VARCHAR(100) DEFAULT 'social',
    target_table VARCHAR(200),
    target_schema VARCHAR(100),
    archive_location VARCHAR(500),

    -- Data metrics
    total_records_processed BIGINT DEFAULT 0 CHECK (total_records_processed >= 0),
    records_archived BIGINT DEFAULT 0 CHECK (records_archived >= 0),
    records_deleted BIGINT DEFAULT 0 CHECK (records_deleted >= 0),
    records_anonymized BIGINT DEFAULT 0 CHECK (records_anonymized >= 0),
    records_skipped BIGINT DEFAULT 0 CHECK (records_skipped >= 0),

    -- Performance metrics
    batch_size INTEGER,
    batch_count INTEGER,
    avg_records_per_second NUMERIC(10,2),
    peak_records_per_second NUMERIC(10,2),

    -- Verification and integrity
    verification_status VARCHAR(20) CHECK (
        verification_status IN ('PENDING', 'VERIFIED', 'FAILED', 'SKIPPED')
    ),
    source_row_count BIGINT,
    target_row_count BIGINT,
    checksum_source VARCHAR(64),
    checksum_target VARCHAR(64),
    verification_timestamp TIMESTAMP WITH TIME ZONE,

    -- Storage optimization
    compression_ratio NUMERIC(5,2),
    original_size_bytes BIGINT,
    archived_size_bytes BIGINT,
    storage_class VARCHAR(50) CHECK (
        storage_class IN ('HOT', 'WARM', 'COLD', 'GLACIER', 'DEEP_ARCHIVE')
    ),

    -- Error handling
    error_count INTEGER DEFAULT 0,
    error_messages TEXT[] DEFAULT '{}',
    retry_attempts INTEGER DEFAULT 0,
    last_retry_at TIMESTAMP WITH TIME ZONE,

    -- Execution context
    executed_by UUID NOT NULL,
    execution_server VARCHAR(100),
    execution_environment VARCHAR(50) CHECK (
        execution_environment IN ('PRODUCTION', 'STAGING', 'TEST', 'DEVELOPMENT')
    ),

    -- Rollback information
    rollback_available BOOLEAN DEFAULT FALSE,
    rollback_script_url VARCHAR(500),
    rollback_window_days INTEGER,

    -- Cost tracking
    storage_cost_estimate NUMERIC(10,2),
    compute_cost_estimate NUMERIC(10,2),
    actual_cost NUMERIC(10,2),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_archive_logs_policy FOREIGN KEY (policy_id)
        REFERENCES socialcandor_schema.data_retention_policies(policy_id) ON DELETE RESTRICT,

    -- Constraints
    CONSTRAINT chk_completion_timestamp CHECK (
        completed_at IS NULL OR completed_at >= started_at
    ),
    CONSTRAINT chk_record_counts CHECK (
        total_records_processed = records_archived + records_deleted + records_anonymized + records_skipped
    ),
    CONSTRAINT chk_verification_complete CHECK (
        (verification_status IS NULL AND verification_timestamp IS NULL) OR
        (verification_status IS NOT NULL AND verification_timestamp IS NOT NULL)
    )
);

COMMENT ON TABLE socialcandor_schema.data_archive_logs IS 'Immutable audit trail of data archival/deletion actions with record counts and execution metrics';
COMMENT ON COLUMN socialcandor_schema.data_archive_logs.compression_ratio IS 'Compression ratio achieved (original_size / archived_size)';

-- Indexes for data_archive_logs
CREATE INDEX IF NOT EXISTS idx_archive_logs_policy ON socialcandor_schema.data_archive_logs(policy_id);
CREATE INDEX IF NOT EXISTS idx_archive_logs_status ON socialcandor_schema.data_archive_logs(execution_status);
CREATE INDEX IF NOT EXISTS idx_archive_logs_type ON socialcandor_schema.data_archive_logs(execution_type);
CREATE INDEX IF NOT EXISTS idx_archive_logs_started ON socialcandor_schema.data_archive_logs(started_at DESC);
CREATE INDEX IF NOT EXISTS idx_archive_logs_source ON socialcandor_schema.data_archive_logs(source_schema, source_table);
CREATE INDEX IF NOT EXISTS idx_archive_logs_verification ON socialcandor_schema.data_archive_logs(verification_status);
CREATE INDEX IF NOT EXISTS idx_archive_logs_environment ON socialcandor_schema.data_archive_logs(execution_environment);

-- Function to calculate duration automatically
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_archive_duration()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.completed_at IS NOT NULL AND OLD.completed_at IS NULL THEN
        NEW.duration_seconds := EXTRACT(EPOCH FROM (NEW.completed_at - NEW.started_at));
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_archive_logs_duration
    BEFORE UPDATE ON socialcandor_schema.data_archive_logs
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_archive_duration();

-- Trigger for updated_at
CREATE TRIGGER trg_archive_logs_updated_at
    BEFORE UPDATE ON socialcandor_schema.data_archive_logs
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 32 - data_quality_rules
-- Description: Configurable data validation rules with severity levels
-- Business Case: Prevents data corruption at scale through automated checks while
-- enabling data observability dashboards for engineering teams. Supports dynamic
-- SQL execution for complex validation scenarios.
-- Feature Reference: DQ01 (Data Quality Rules), MON01 (Monitoring), GOV01 (Data Governance)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.data_quality_rules (
    rule_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Rule identification
    rule_name VARCHAR(200) NOT NULL UNIQUE,
    rule_description TEXT NOT NULL,
    rule_category VARCHAR(100) NOT NULL CHECK (
        rule_category IN ('COMPLETENESS', 'ACCURACY', 'CONSISTENCY', 'TIMELINESS', 'VALIDITY', 'UNIQUENESS', 'INTEGRITY')
    ),

    -- Scope definition
    target_table VARCHAR(200) NOT NULL,
    target_schema VARCHAR(100) DEFAULT 'social',
    target_column VARCHAR(200),
    condition_type VARCHAR(50) NOT NULL CHECK (
        condition_type IN ('SQL_EXPRESSION', 'REGEX_PATTERN', 'RANGE_CHECK', 'REFERENCE_CHECK', 'CUSTOM_FUNCTION')
    ),

    -- Validation logic
    validation_expression TEXT NOT NULL,
    validation_parameters JSONB DEFAULT '{}',
    custom_function_name VARCHAR(200),
    error_message_template VARCHAR(500) NOT NULL,

    -- Severity and impact
    severity_level VARCHAR(20) NOT NULL CHECK (
        severity_level IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL', 'BLOCKER')
    ),
    business_impact VARCHAR(500),
    data_owner VARCHAR(200),
    data_steward VARCHAR(200),

    -- Execution settings
    is_active BOOLEAN DEFAULT TRUE,
    check_frequency VARCHAR(50) DEFAULT 'ON_INSERT' CHECK (
        check_frequency IN ('ON_INSERT', 'ON_UPDATE', 'ON_DELETE', 'SCHEDULED', 'ON_DEMAND', 'REAL_TIME')
    ),
    schedule_expression VARCHAR(100), -- cron expression for scheduled checks
    batch_size INTEGER DEFAULT 1000 CHECK (batch_size >= 100 AND batch_size <= 10000),

    -- Thresholds and tolerance
    warning_threshold NUMERIC(5,2) CHECK (warning_threshold >= 0 AND warning_threshold <= 100),
    error_threshold NUMERIC(5,2) CHECK (error_threshold >= 0 AND error_threshold <= 100),
    tolerance_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (tolerance_percentage >= 0 AND tolerance_percentage <= 100),

    -- Alerting and notification
    alert_enabled BOOLEAN DEFAULT TRUE,
    alert_channels VARCHAR(50)[] DEFAULT ARRAY['EMAIL', 'SLACK']::VARCHAR(50)[],
    notification_template VARCHAR(200),
    escalation_enabled BOOLEAN DEFAULT FALSE,
    escalation_after_failures INTEGER DEFAULT 3 CHECK (escalation_after_failures >= 1),

    -- Historical tracking
    last_executed_at TIMESTAMP WITH TIME ZONE,
    last_execution_status VARCHAR(20),
    total_executions INTEGER DEFAULT 0,
    total_violations BIGINT DEFAULT 0,
    success_rate NUMERIC(5,2) DEFAULT 100.0 CHECK (success_rate >= 0 AND success_rate <= 100),

    -- Dependencies
    depends_on_rules UUID[] DEFAULT '{}',
    related_rules UUID[] DEFAULT '{}',
    rule_version VARCHAR(20) NOT NULL DEFAULT '1.0',

    -- Documentation
    documentation_url VARCHAR(500),
    business_rule_id VARCHAR(100),
    regulatory_reference VARCHAR(200),

    -- Review and approval
    approved_by UUID,
    approved_at TIMESTAMP WITH TIME ZONE,
    review_frequency_days INTEGER DEFAULT 90 CHECK (review_frequency_days >= 30),
    next_review_date DATE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Constraints
    CONSTRAINT chk_thresholds CHECK (
        (warning_threshold IS NULL AND error_threshold IS NULL) OR
        (warning_threshold IS NOT NULL AND error_threshold IS NOT NULL AND warning_threshold < error_threshold)
    ),
    CONSTRAINT chk_custom_function CHECK (
        (condition_type != 'CUSTOM_FUNCTION' OR custom_function_name IS NOT NULL) AND
        (condition_type = 'CUSTOM_FUNCTION' OR custom_function_name IS NULL)
    ),
    CONSTRAINT chk_schedule CHECK (
        (check_frequency != 'SCHEDULED' OR schedule_expression IS NOT NULL) AND
        (check_frequency = 'SCHEDULED' OR schedule_expression IS NULL)
    )
);

COMMENT ON TABLE socialcandor_schema.data_quality_rules IS 'Configurable data validation rules with severity levels and dynamic SQL execution';
COMMENT ON COLUMN socialcandor_schema.data_quality_rules.validation_expression IS 'SQL WHERE clause for violations or regex pattern depending on condition_type';

-- Indexes for data_quality_rules
CREATE INDEX IF NOT EXISTS idx_dq_rules_active ON socialcandor_schema.data_quality_rules(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_dq_rules_category ON socialcandor_schema.data_quality_rules(rule_category);
CREATE INDEX IF NOT EXISTS idx_dq_rules_table ON socialcandor_schema.data_quality_rules(target_schema, target_table);
CREATE INDEX IF NOT EXISTS idx_dq_rules_severity ON socialcandor_schema.data_quality_rules(severity_level);
CREATE INDEX IF NOT EXISTS idx_dq_rules_frequency ON socialcandor_schema.data_quality_rules(check_frequency);
CREATE INDEX IF NOT EXISTS idx_dq_rules_last_executed ON socialcandor_schema.data_quality_rules(last_executed_at DESC);
CREATE INDEX IF NOT EXISTS idx_dq_rules_next_review ON socialcandor_schema.data_quality_rules(next_review_date) WHERE next_review_date IS NOT NULL;

-- Trigger for next review date calculation
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_dq_rule_review_date()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.next_review_date IS NULL AND NEW.review_frequency_days IS NOT NULL THEN
        NEW.next_review_date := CURRENT_DATE + (NEW.review_frequency_days || ' days')::INTERVAL;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_dq_rules_review_date
    BEFORE INSERT OR UPDATE ON socialcandor_schema.data_quality_rules
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_dq_rule_review_date();

-- Trigger for updated_at
CREATE TRIGGER trg_dq_rules_updated_at
    BEFORE UPDATE ON socialcandor_schema.data_quality_rules
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 33 - data_quality_logs
-- Description: Historical record of data quality rule executions
-- Business Case: Enables root cause analysis for data pipeline failures and trend analysis
-- of data degradation patterns. Critical for maintaining ML model training data quality
-- and regulatory compliance reporting.
-- Feature Reference: DQ02 (Quality Monitoring), AUD02 (Audit Logging), RCA01 (Root Cause Analysis)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.data_quality_logs (
    log_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    rule_id UUID NOT NULL,

    -- Execution details
    execution_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    execution_status VARCHAR(20) NOT NULL CHECK (
        execution_status IN ('SUCCESS', 'VIOLATION', 'ERROR', 'SKIPPED', 'TIMEOUT')
    ),
    execution_duration_ms INTEGER CHECK (execution_duration_ms >= 0),
    execution_mode VARCHAR(20) NOT NULL CHECK (
        execution_mode IN ('SCHEDULED', 'MANUAL', 'TRIGGERED', 'API', 'PIPELINE')
    ),

    -- Scope and context
    table_name VARCHAR(200) NOT NULL,
    schema_name VARCHAR(100) DEFAULT 'social',
    column_name VARCHAR(200),
    partition_filter VARCHAR(500),

    -- Results and metrics
    records_checked BIGINT DEFAULT 0 CHECK (records_checked >= 0),
    violations_found BIGINT DEFAULT 0 CHECK (violations_found >= 0),
    violation_percentage NUMERIC(5,2) CHECK (violation_percentage >= 0 AND violation_percentage <= 100),
    sample_violations JSONB DEFAULT '[]',

    -- Threshold evaluation
    threshold_type VARCHAR(20) CHECK (threshold_type IN ('WARNING', 'ERROR', 'CRITICAL')),
    threshold_value NUMERIC(5,2),
    threshold_exceeded BOOLEAN DEFAULT FALSE,

    -- Error details
    error_message TEXT,
    error_stack_trace TEXT,
    error_code VARCHAR(50),
    retry_count INTEGER DEFAULT 0 CHECK (retry_count >= 0),

    -- Alert information
    alert_generated BOOLEAN DEFAULT FALSE,
    alert_id UUID,
    notification_sent BOOLEAN DEFAULT FALSE,

    -- Data sampling
    sample_size INTEGER,
    sampling_method VARCHAR(50) CHECK (
        sampling_method IN ('RANDOM', 'SYSTEMATIC', 'STRATIFIED', 'CLUSTER', 'FULL_SCAN')
    ),
    confidence_level NUMERIC(5,2) CHECK (confidence_level >= 0 AND confidence_level <= 100),

    -- Performance metrics
    query_plan JSONB,
    indexes_used VARCHAR(200)[] DEFAULT '{}',
    table_size_bytes BIGINT,
    index_size_bytes BIGINT,

    -- Execution environment
    executed_by UUID,
    execution_server VARCHAR(100),
    database_name VARCHAR(100) DEFAULT CURRENT_DATABASE(),
    application_name VARCHAR(100),

    -- Cost tracking
    query_cost_estimate NUMERIC(10,2),
    actual_cost NUMERIC(10,2),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_dq_logs_rule FOREIGN KEY (rule_id)
        REFERENCES socialcandor_schema.data_quality_rules(rule_id) ON DELETE RESTRICT,

    -- Constraints
    CONSTRAINT chk_violation_percentage CHECK (
        (violations_found = 0 AND violation_percentage = 0) OR
        (violations_found > 0 AND violation_percentage > 0 AND violation_percentage <= 100)
    ),
    CONSTRAINT chk_sample_size CHECK (
        (sample_size IS NULL) OR
        (sample_size >= 1 AND sample_size <= records_checked)
    )
);

COMMENT ON TABLE socialcandor_schema.data_quality_logs IS 'Historical record of data quality rule executions with failure details';
COMMENT ON COLUMN socialcandor_schema.data_quality_logs.sample_violations IS 'JSON array of sample violation records for investigation';

-- Indexes for data_quality_logs
CREATE INDEX IF NOT EXISTS idx_dq_logs_rule ON socialcandor_schema.data_quality_logs(rule_id);
CREATE INDEX IF NOT EXISTS idx_dq_logs_timestamp ON socialcandor_schema.data_quality_logs(execution_timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_dq_logs_status ON socialcandor_schema.data_quality_logs(execution_status);
CREATE INDEX IF NOT EXISTS idx_dq_logs_table ON socialcandor_schema.data_quality_logs(schema_name, table_name);
CREATE INDEX IF NOT EXISTS idx_dq_logs_violations ON socialcandor_schema.data_quality_logs(violations_found DESC) WHERE violations_found > 0;
CREATE INDEX IF NOT EXISTS idx_dq_logs_threshold ON socialcandor_schema.data_quality_logs(threshold_exceeded) WHERE threshold_exceeded = TRUE;
CREATE INDEX IF NOT EXISTS idx_dq_logs_alert ON socialcandor_schema.data_quality_logs(alert_generated) WHERE alert_generated = TRUE;

-- Partition by month for performance (example syntax, actual partitioning setup would be separate)
-- CREATE TABLE socialcandor_schema.data_quality_logs_y2023m01 PARTITION OF socialcandor_schema.data_quality_logs
-- FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');

-- Function to calculate violation percentage
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_violation_percentage()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.records_checked > 0 THEN
        NEW.violation_percentage := ROUND((NEW.violations_found::NUMERIC / NEW.records_checked) * 100, 2);
    ELSE
        NEW.violation_percentage := 0.0;
    END IF;

    -- Determine if threshold exceeded
    IF NEW.rule_id IS NOT NULL THEN
        SELECT warning_threshold, error_threshold, severity_level
        INTO NEW.threshold_value, NEW.threshold_type, NEW.threshold_exceeded
        FROM socialcandor_schema.data_quality_rules
        WHERE rule_id = NEW.rule_id;

        IF NEW.violation_percentage >= COALESCE(NEW.threshold_value, 100) THEN
            NEW.threshold_exceeded := TRUE;
        ELSE
            NEW.threshold_exceeded := FALSE;
        END IF;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_dq_logs_violation_calc
    BEFORE INSERT OR UPDATE OF violations_found, records_checked ON socialcandor_schema.data_quality_logs
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_violation_percentage();

-- Trigger for updated_at
CREATE TRIGGER trg_dq_logs_updated_at
    BEFORE UPDATE ON socialcandor_schema.data_quality_logs
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();
------------------------------------------------------------------------------------------------
-- Table: 34 - data_profiling_results
-- Description: Statistical metadata about column distributions
-- Business Case: Powers automated anomaly detection for data drift in ML features while
-- supporting schema evolution planning through usage pattern analysis. Provides
-- comprehensive data understanding for data scientists and engineers.
-- Feature Reference: DQ03 (Data Profiling), ML01 (Machine Learning), GOV02 (Data Discovery)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.data_profiling_results (
    profile_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Target identification
    table_name VARCHAR(200) NOT NULL,
    schema_name VARCHAR(100) DEFAULT 'social',
    column_name VARCHAR(200) NOT NULL,
    column_data_type VARCHAR(100),

    -- Profiling context
    profiling_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    profiling_type VARCHAR(50) NOT NULL CHECK (
        profiling_type IN ('FULL', 'INCREMENTAL', 'SAMPLE', 'TARGETED', 'COMPARATIVE')
    ),
    sample_size INTEGER,
    sample_percentage NUMERIC(5,2) CHECK (sample_percentage >= 0 AND sample_percentage <= 100),

    -- Basic statistics
    total_records BIGINT NOT NULL CHECK (total_records >= 0),
    null_count BIGINT DEFAULT 0 CHECK (null_count >= 0 AND null_count <= total_records),
    null_percentage NUMERIC(5,2) CHECK (null_percentage >= 0 AND null_percentage <= 100),
    distinct_count BIGINT DEFAULT 0 CHECK (distinct_count >= 0 AND distinct_count <= total_records),
    distinct_percentage NUMERIC(5,2) CHECK (distinct_percentage >= 0 AND distinct_percentage <= 100),

    -- Value distribution
    min_value TEXT,
    max_value TEXT,
    avg_value NUMERIC(30,10),
    median_value TEXT,
    mode_value TEXT,
    mode_frequency BIGINT,

    -- Statistical measures
    std_dev NUMERIC(30,10),
    variance NUMERIC(30,10),
    skewness NUMERIC(30,10),
    kurtosis NUMERIC(30,10),
    iqr TEXT, -- Interquartile range

    -- Pattern analysis
    pattern_distribution JSONB DEFAULT '{}',
    top_values JSONB DEFAULT '[]',
    bottom_values JSONB DEFAULT '[]',
    value_frequencies JSONB DEFAULT '{}',

    -- Data quality indicators
    data_quality_score NUMERIC(5,2) CHECK (data_quality_score >= 0 AND data_quality_score <= 100),
    completeness_score NUMERIC(5,2) CHECK (completeness_score >= 0 AND completeness_score <= 100),
    validity_score NUMERIC(5,2) CHECK (validity_score >= 0 AND validity_score <= 100),
    consistency_score NUMERIC(5,2) CHECK (consistency_score >= 0 AND consistency_score <= 100),

    -- String-specific metrics (if applicable)
    avg_length NUMERIC(10,2),
    min_length INTEGER,
    max_length INTEGER,
    empty_string_count BIGINT,
    whitespace_count BIGINT, -- Changed from BIGNUMERIC to BIGINT

    -- Numeric-specific metrics (if applicable)
    sum_value NUMERIC(30,10),
    positive_count BIGINT,
    negative_count BIGINT,
    zero_count BIGINT,

    -- Date-specific metrics (if applicable)
    min_date TIMESTAMP WITH TIME ZONE,
    max_date TIMESTAMP WITH TIME ZONE,
    date_range_days INTEGER,

    -- Cardinality analysis
    cardinality_type VARCHAR(50) CHECK (
        cardinality_type IN ('UNIQUE', 'HIGH', 'MEDIUM', 'LOW', 'CONSTANT')
    ),
    uniqueness_score NUMERIC(5,2) CHECK (uniqueness_score >= 0 AND uniqueness_score <= 100),

    -- Anomaly detection
    anomaly_count INTEGER DEFAULT 0,
    anomaly_types VARCHAR(100)[] DEFAULT '{}',
    outlier_count INTEGER DEFAULT 0,
    outlier_values JSONB DEFAULT '[]',

    -- Trend analysis
    trend_direction VARCHAR(20) CHECK (trend_direction IN ('INCREASING', 'DECREASING', 'STABLE', 'VOLATILE')),
    trend_strength NUMERIC(5,2) CHECK (trend_strength >= 0 AND trend_strength <= 1),

    -- Comparison metrics
    previous_profile_id UUID,
    change_percentage NUMERIC(10,2),
    drift_score NUMERIC(5,2) CHECK (drift_score >= 0 AND drift_score <= 100),

    -- Performance metrics
    profiling_duration_ms INTEGER CHECK (profiling_duration_ms >= 0),
    memory_used_mb INTEGER CHECK (memory_used_mb >= 0),

    -- Metadata
    tags VARCHAR(50)[] DEFAULT '{}',
    notes TEXT,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Constraints
    CONSTRAINT uk_profiling_unique UNIQUE (schema_name, table_name, column_name, profiling_timestamp),
    CONSTRAINT chk_null_percentage CHECK (
        null_percentage = ROUND((null_count::NUMERIC / GREATEST(total_records, 1)) * 100, 2)
    ),
    CONSTRAINT chk_distinct_percentage CHECK (
        distinct_percentage = ROUND((distinct_count::NUMERIC / GREATEST(total_records, 1)) * 100, 2)
    )
);

COMMENT ON TABLE socialcandor_schema.data_profiling_results IS 'Statistical metadata about column distributions for data quality and ML feature monitoring';
COMMENT ON COLUMN socialcandor_schema.data_profiling_results.drift_score IS 'Score indicating data drift from previous profile (0=no drift, 100=complete drift)';
COMMENT ON COLUMN socialcandor_schema.data_profiling_results.whitespace_count IS 'Count of strings containing only whitespace characters';

-- Indexes for data_profiling_results
CREATE INDEX IF NOT EXISTS idx_profiling_table ON socialcandor_schema.data_profiling_results(schema_name, table_name);
CREATE INDEX IF NOT EXISTS idx_profiling_column ON socialcandor_schema.data_profiling_results(column_name);
CREATE INDEX IF NOT EXISTS idx_profiling_timestamp ON socialcandor_schema.data_profiling_results(profiling_timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_profiling_type ON socialcandor_schema.data_profiling_results(profiling_type);
CREATE INDEX IF NOT EXISTS idx_profiling_quality ON socialcandor_schema.data_profiling_results(data_quality_score DESC);
CREATE INDEX IF NOT EXISTS idx_profiling_drift ON socialcandor_schema.data_profiling_results(drift_score DESC) WHERE drift_score > 0;
CREATE INDEX IF NOT EXISTS idx_profiling_null_percentage ON socialcandor_schema.data_profiling_results(null_percentage DESC) WHERE null_percentage > 0;

-- Materialized view for column-level data quality summary
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_column_quality_summary AS
SELECT
    schema_name,
    table_name,
    column_name,
    column_data_type,
    MAX(profiling_timestamp) AS last_profiled_at,
    AVG(data_quality_score) AS avg_quality_score,
    AVG(null_percentage) AS avg_null_percentage,
    AVG(distinct_percentage) AS avg_distinct_percentage,
    COUNT(*) AS profile_count,
    BOOL_OR(drift_score > 30) AS has_significant_drift,
    BOOL_OR(anomaly_count > 0) AS has_anomalies,
    MAX(CASE WHEN profiling_timestamp >= CURRENT_TIMESTAMP - INTERVAL '7 days'
        THEN data_quality_score ELSE NULL END) AS recent_quality_score
FROM socialcandor_schema.data_profiling_results
WHERE profiling_timestamp >= CURRENT_TIMESTAMP - INTERVAL '90 days'
GROUP BY schema_name, table_name, column_name, column_data_type
WITH DATA;

CREATE UNIQUE INDEX idx_mv_column_quality ON socialcandor_schema.mv_column_quality_summary(schema_name, table_name, column_name);

-- Function to calculate derived statistics
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_profiling_derived_stats()
RETURNS TRIGGER AS $$
BEGIN
    -- Calculate percentages
    IF NEW.total_records > 0 THEN
        NEW.null_percentage := ROUND((NEW.null_count::NUMERIC / NEW.total_records) * 100, 2);
        NEW.distinct_percentage := ROUND((NEW.distinct_count::NUMERIC / NEW.total_records) * 100, 2);
    ELSE
        NEW.null_percentage := 0.0;
        NEW.distinct_percentage := 0.0;
    END IF;

    -- Calculate data quality score (simplified)
    NEW.data_quality_score :=
        (100 - NEW.null_percentage) * 0.4 +
        NEW.distinct_percentage * 0.3 +
        COALESCE(NEW.validity_score, 100) * 0.3;

    -- Determine cardinality type
    IF NEW.distinct_percentage >= 99.9 THEN
        NEW.cardinality_type := 'UNIQUE';
    ELSIF NEW.distinct_percentage >= 50 THEN
        NEW.cardinality_type := 'HIGH';
    ELSIF NEW.distinct_percentage >= 10 THEN
        NEW.cardinality_type := 'MEDIUM';
    ELSIF NEW.distinct_percentage >= 1 THEN
        NEW.cardinality_type := 'LOW';
    ELSE
        NEW.cardinality_type := 'CONSTANT';
    END IF;

    -- Calculate uniqueness score
    IF NEW.distinct_percentage >= 99.9 THEN
        NEW.uniqueness_score := 100.0;
    ELSE
        NEW.uniqueness_score := LEAST(100.0, NEW.distinct_percentage * 1.5);
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_profiling_stats_calculation
    BEFORE INSERT ON socialcandor_schema.data_profiling_results
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_profiling_derived_stats();

-- Trigger for updated_at
CREATE TRIGGER trg_profiling_results_updated_at
    BEFORE UPDATE ON socialcandor_schema.data_profiling_results
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Function to refresh materialized view
CREATE OR REPLACE FUNCTION socialcandor_schema.refresh_column_quality_summary()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY socialcandor_schema.mv_column_quality_summary;
END;
$$ LANGUAGE plpgsql;

-- -- Grant necessary permissions (adjust as needed)
-- GRANT SELECT ON socialcandor_schema.data_profiling_results TO data_scientist_role;
-- GRANT SELECT ON socialcandor_schema.mv_column_quality_summary TO data_scientist_role;
-- GRANT INSERT, UPDATE ON socialcandor_schema.data_profiling_results TO data_engineer_role;
-- GRANT EXECUTE ON FUNCTION socialcandor_schema.refresh_column_quality_summary TO data_engineer_role;

------------------------------------------------------------------------------------------------
-- Table: 35 - data_lineage
-- Description: Documentation of data flow transformations between systems
-- Business Case: Essential for impact analysis during schema changes and regulatory
-- compliance (proving data provenance for financial reporting or clinical data).
-- Supports data governance and data catalog integration.
-- Feature Reference: GOV03 (Data Lineage), IMP01 (Impact Analysis), CAT01 (Data Catalog)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.data_lineage (
    lineage_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Source identification
    source_system VARCHAR(200) NOT NULL,
    source_database VARCHAR(200),
    source_schema VARCHAR(200),
    source_table VARCHAR(200) NOT NULL,
    source_column VARCHAR(200),
    source_environment VARCHAR(50) CHECK (
        source_environment IN ('PRODUCTION', 'STAGING', 'TEST', 'DEVELOPMENT', 'LEGACY')
    ),

    -- Target identification
    target_system VARCHAR(200) NOT NULL,
    target_database VARCHAR(200),
    target_schema VARCHAR(200),
    target_table VARCHAR(200) NOT NULL,
    target_column VARCHAR(200),
    target_environment VARCHAR(50) CHECK (
        target_environment IN ('PRODUCTION', 'STAGING', 'TEST', 'DEVELOPMENT', 'ARCHIVE')
    ),

    -- Transformation details
    transformation_type VARCHAR(50) NOT NULL CHECK (
        transformation_type IN ('DIRECT_MAP', 'AGGREGATION', 'FILTER', 'JOIN', 'PIVOT', 'CALCULATION', 'ENRICHMENT', 'CLEANSING')
    ),
    transformation_logic TEXT,
    transformation_sql TEXT,
    transformation_tool VARCHAR(200),
    transformation_job VARCHAR(200),

    -- Business context
    business_rule VARCHAR(500),
    business_owner VARCHAR(200),
    technical_owner VARCHAR(200),
    data_domain VARCHAR(100),
    data_subdomain VARCHAR(100),

    -- Lineage metadata
    lineage_level VARCHAR(20) DEFAULT 'COLUMN' CHECK (
        lineage_level IN ('TABLE', 'COLUMN', 'ROW', 'VALUE')
    ),
    lineage_direction VARCHAR(20) DEFAULT 'FORWARD' CHECK (
        lineage_direction IN ('FORWARD', 'BACKWARD', 'BIDIRECTIONAL')
    ),
    lineage_depth INTEGER DEFAULT 1 CHECK (lineage_depth >= 1),

    -- Quality and validation
    data_quality_rule VARCHAR(200),
    validation_rule VARCHAR(200),
    is_validated BOOLEAN DEFAULT FALSE,
    validation_date DATE,

    -- Performance and metrics
    data_volume_rows BIGINT,
    data_volume_bytes BIGINT,
    refresh_frequency VARCHAR(50),
    last_refresh_timestamp TIMESTAMP WITH TIME ZONE,
    next_refresh_timestamp TIMESTAMP WITH TIME ZONE,

    -- Dependencies
    depends_on_lineage UUID[] DEFAULT '{}',
    impacted_by_changes BOOLEAN DEFAULT FALSE,
    change_impact_level VARCHAR(20) CHECK (
        change_impact_level IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')
    ),

    -- Version and lifecycle
    lineage_version VARCHAR(20) NOT NULL DEFAULT '1.0',
    effective_from DATE NOT NULL DEFAULT CURRENT_DATE,
    effective_to DATE,
    is_active BOOLEAN DEFAULT TRUE,

    -- Documentation
    documentation_url VARCHAR(500),
    data_catalog_id VARCHAR(100),
    metadata_tags VARCHAR(50)[] DEFAULT '{}',

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    verified_at TIMESTAMP WITH TIME ZONE,
    verified_by UUID,

    -- Constraints
    CONSTRAINT chk_effective_dates CHECK (
        effective_to IS NULL OR effective_to > effective_from
    ),
    CONSTRAINT chk_refresh_timestamps CHECK (
        (next_refresh_timestamp IS NULL) OR
        (last_refresh_timestamp IS NULL) OR
        (next_refresh_timestamp > last_refresh_timestamp)
    ),
    CONSTRAINT uk_lineage_unique UNIQUE (
        source_system, source_table, source_column,
        target_system, target_table, target_column,
        transformation_type, effective_from
    )
);

COMMENT ON TABLE socialcandor_schema.data_lineage IS 'Documentation of data flow transformations between source and target systems';
COMMENT ON COLUMN socialcandor_schema.data_lineage.lineage_depth IS 'Number of hops from original source (1=direct, 2=one intermediate, etc.)';

-- Indexes for data_lineage
CREATE INDEX IF NOT EXISTS idx_lineage_source ON socialcandor_schema.data_lineage(source_system, source_table, source_column);
CREATE INDEX IF NOT EXISTS idx_lineage_target ON socialcandor_schema.data_lineage(target_system, target_table, target_column);
CREATE INDEX IF NOT EXISTS idx_lineage_transformation ON socialcandor_schema.data_lineage(transformation_type);
CREATE INDEX IF NOT EXISTS idx_lineage_active ON socialcandor_schema.data_lineage(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_lineage_domain ON socialcandor_schema.data_lineage(data_domain);
CREATE INDEX IF NOT EXISTS idx_lineage_impact ON socialcandor_schema.data_lineage(impacted_by_changes) WHERE impacted_by_changes = TRUE;
CREATE INDEX IF NOT EXISTS idx_lineage_refresh ON socialcandor_schema.data_lineage(next_refresh_timestamp) WHERE next_refresh_timestamp IS NOT NULL;

-- Function to automatically set effective_to when deactivating
CREATE OR REPLACE FUNCTION socialcandor_schema.handle_lineage_deactivation()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.is_active = FALSE AND OLD.is_active = TRUE THEN
        NEW.effective_to := CURRENT_DATE;
    ELSIF NEW.is_active = TRUE AND OLD.is_active = FALSE THEN
        NEW.effective_to := NULL;
        NEW.effective_from := CURRENT_DATE;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_lineage_deactivation
    BEFORE UPDATE OF is_active ON socialcandor_schema.data_lineage
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.handle_lineage_deactivation();

-- Trigger for updated_at
CREATE TRIGGER trg_data_lineage_updated_at
    BEFORE UPDATE ON socialcandor_schema.data_lineage
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 36 - audit_logs
-- Description: Immutable security ledger recording sensitive data modifications
-- Business Case: Provides forensic capability for security investigations, supports
-- SOC 2 Type II compliance, and enables accountability across platform operations
-- through user/IP/action triads. Essential for regulatory compliance and security audits.
-- Feature Reference: SEC01 (Audit Trail), COMP06 (Security Compliance), FOR01 (Forensics)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.audit_logs (
    audit_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Action identification
    action_type VARCHAR(100) NOT NULL,
    action_subtype VARCHAR(100),
    action_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,

    -- User context
    user_id UUID,
    user_ip INET,
    user_agent TEXT,
    session_id VARCHAR(100),
    device_fingerprint VARCHAR(100),

    -- Target context
    target_type VARCHAR(100),
    target_id UUID,
    target_name VARCHAR(200),
    target_owner_id UUID,

    -- Resource context
    resource_type VARCHAR(100),
    resource_id VARCHAR(200),
    resource_name VARCHAR(200),
    resource_path VARCHAR(500),

    -- Action details
    action_details JSONB DEFAULT '{}',
    changed_fields JSONB DEFAULT '{}',
    old_values JSONB DEFAULT '{}',
    new_values JSONB DEFAULT '{}',

    -- Outcome and status
    action_status VARCHAR(50) NOT NULL CHECK (
        action_status IN ('SUCCESS', 'FAILURE', 'PARTIAL', 'PENDING', 'CANCELLED')
    ),
    status_code INTEGER CHECK (status_code >= 100 AND status_code <= 599),
    error_message TEXT,
    error_stack_trace TEXT,

    -- Location and network
    country_code VARCHAR(3),
    city VARCHAR(100),
    latitude NUMERIC(10,6),
    longitude NUMERIC(10,6),
    network_provider VARCHAR(100),

    -- Application context
    application_name VARCHAR(100),
    application_version VARCHAR(50),
    api_endpoint VARCHAR(500),
    http_method VARCHAR(10),
    request_id VARCHAR(100),

    -- Performance metrics
    response_time_ms INTEGER CHECK (response_time_ms >= 0),
    request_size_bytes INTEGER CHECK (request_size_bytes >= 0),
    response_size_bytes INTEGER CHECK (response_size_bytes >= 0),

    -- Security context
    authentication_method VARCHAR(50),
    mfa_used BOOLEAN DEFAULT FALSE,
    security_level VARCHAR(20) CHECK (
        security_level IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')
    ),
    threat_score NUMERIC(5,2) CHECK (threat_score >= 0 AND threat_score <= 100),

    -- Compliance and tagging
    compliance_tags VARCHAR(50)[] DEFAULT '{}',
    pii_accessed BOOLEAN DEFAULT FALSE,
    sensitive_data_accessed BOOLEAN DEFAULT FALSE,
    regulatory_category VARCHAR(50) CHECK (
        regulatory_category IN ('GDPR', 'HIPAA', 'PCI_DSS', 'SOX', 'CCPA', 'FERPA', 'OTHER')
    ),

    -- Correlation and tracing
    correlation_id VARCHAR(100),
    trace_id VARCHAR(100),
    span_id VARCHAR(100),
    parent_audit_id UUID,

    -- Retention and archival
    retention_category VARCHAR(50) DEFAULT 'STANDARD' CHECK (
        retention_category IN ('STANDARD', 'EXTENDED', 'PERMANENT', 'COMPLIANCE')
    ),
    retention_expiry_date DATE,
    is_archived BOOLEAN DEFAULT FALSE,
    archive_location VARCHAR(500),

    -- Verification and integrity
    hash_algorithm VARCHAR(20) DEFAULT 'SHA256',
    record_hash VARCHAR(64) NOT NULL UNIQUE,
    previous_hash VARCHAR(64),
    blockchain_tx_id VARCHAR(100),

    -- Audit and metadata (minimal since this is the audit trail itself)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- Indexes (created separately)

    -- Constraints
    CONSTRAINT chk_timestamp_consistency CHECK (action_timestamp >= created_at),
    CONSTRAINT chk_hash_algorithm CHECK (hash_algorithm IN ('MD5', 'SHA1', 'SHA256', 'SHA512')),
    CONSTRAINT fk_audit_logs_parent FOREIGN KEY (parent_audit_id)
        REFERENCES socialcandor_schema.audit_logs(audit_id) ON DELETE SET NULL
);

COMMENT ON TABLE socialcandor_schema.audit_logs IS 'Immutable security ledger recording all sensitive data modifications and admin actions';
COMMENT ON COLUMN socialcandor_schema.audit_logs.record_hash IS 'Cryptographic hash of audit record for tamper detection';

-- Indexes for audit_logs (comprehensive for various query patterns)
CREATE INDEX IF NOT EXISTS idx_audit_logs_user ON socialcandor_schema.audit_logs(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_audit_logs_timestamp ON socialcandor_schema.audit_logs(action_timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_audit_logs_type ON socialcandor_schema.audit_logs(action_type);
CREATE INDEX IF NOT EXISTS idx_audit_logs_target ON socialcandor_schema.audit_logs(target_type, target_id) WHERE target_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_audit_logs_resource ON socialcandor_schema.audit_logs(resource_type, resource_id) WHERE resource_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_audit_logs_status ON socialcandor_schema.audit_logs(action_status);
CREATE INDEX IF NOT EXISTS idx_audit_logs_ip ON socialcandor_schema.audit_logs(user_ip);
CREATE INDEX IF NOT EXISTS idx_audit_logs_session ON socialcandor_schema.audit_logs(session_id) WHERE session_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_audit_logs_compliance ON socialcandor_schema.audit_logs(compliance_tags);
CREATE INDEX IF NOT EXISTS idx_audit_logs_pii ON socialcandor_schema.audit_logs(pii_accessed) WHERE pii_accessed = TRUE;
CREATE INDEX IF NOT EXISTS idx_audit_logs_correlation ON socialcandor_schema.audit_logs(correlation_id) WHERE correlation_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_audit_logs_retention ON socialcandor_schema.audit_logs(retention_expiry_date) WHERE retention_expiry_date IS NOT NULL;

-- Partition by month for performance (example setup)
-- CREATE TABLE socialcandor_schema.audit_logs_y2023m01 PARTITION OF socialcandor_schema.audit_logs
-- FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');

-- Function to automatically calculate record hash
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_audit_hash()
RETURNS TRIGGER AS $$
DECLARE
    v_hash_input TEXT;
BEGIN
    -- Create hash input from critical fields (excluding hash fields themselves)
    v_hash_input :=
        NEW.audit_id::text || '|' ||
        NEW.action_type || '|' ||
        COALESCE(NEW.action_subtype, '') || '|' ||
        NEW.action_timestamp::text || '|' ||
        COALESCE(NEW.user_id::text, '') || '|' ||
        COALESCE(NEW.user_ip::text, '') || '|' ||
        COALESCE(NEW.target_type, '') || '|' ||
        COALESCE(NEW.target_id::text, '') || '|' ||
        COALESCE(NEW.action_details::text, '{}') || '|' ||
        COALESCE(NEW.previous_hash, '');

    -- Calculate hash based on algorithm
    CASE NEW.hash_algorithm
        WHEN 'MD5' THEN
            NEW.record_hash := encode(digest(v_hash_input, 'md5'), 'hex');
        WHEN 'SHA1' THEN
            NEW.record_hash := encode(digest(v_hash_input, 'sha1'), 'hex');
        WHEN 'SHA256' THEN
            NEW.record_hash := encode(digest(v_hash_input, 'sha256'), 'hex');
        WHEN 'SHA512' THEN
            NEW.record_hash := encode(digest(v_hash_input, 'sha512'), 'hex');
        ELSE
            NEW.record_hash := encode(digest(v_hash_input, 'sha256'), 'hex');
    END CASE;

    -- Set retention expiry based on category
    IF NEW.retention_expiry_date IS NULL THEN
        CASE NEW.retention_category
            WHEN 'STANDARD' THEN
                NEW.retention_expiry_date := CURRENT_DATE + INTERVAL '7 years';
            WHEN 'EXTENDED' THEN
                NEW.retention_expiry_date := CURRENT_DATE + INTERVAL '10 years';
            WHEN 'COMPLIANCE' THEN
                NEW.retention_expiry_date := CURRENT_DATE + INTERVAL '15 years';
            WHEN 'PERMANENT' THEN
                NEW.retention_expiry_date := NULL;
        END CASE;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_audit_logs_hash
    BEFORE INSERT ON socialcandor_schema.audit_logs
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_audit_hash();

-- Function to verify audit trail integrity
CREATE OR REPLACE FUNCTION socialcandor_schema.verify_audit_integrity(p_start_date DATE DEFAULT CURRENT_DATE - 30, p_end_date DATE DEFAULT CURRENT_DATE)
RETURNS TABLE(
    audit_id UUID,
    action_timestamp TIMESTAMP WITH TIME ZONE,
    record_hash VARCHAR(64),
    calculated_hash VARCHAR(64),
    hash_matches BOOLEAN,
    chain_integrity BOOLEAN
) AS $$
DECLARE
    r RECORD;
    v_previous_hash VARCHAR(64);
    v_current_hash VARCHAR(64);
    v_hash_input TEXT;
BEGIN
    FOR r IN
        SELECT *
        FROM socialcandor_schema.audit_logs
        WHERE DATE(action_timestamp) BETWEEN p_start_date AND p_end_date
        ORDER BY action_timestamp, audit_id
    LOOP
        -- Recalculate hash
        v_hash_input :=
            r.audit_id::text || '|' ||
            r.action_type || '|' ||
            COALESCE(r.action_subtype, '') || '|' ||
            r.action_timestamp::text || '|' ||
            COALESCE(r.user_id::text, '') || '|' ||
            COALESCE(r.user_ip::text, '') || '|' ||
            COALESCE(r.target_type, '') || '|' ||
            COALESCE(r.target_id::text, '') || '|' ||
            COALESCE(r.action_details::text, '{}') || '|' ||
            COALESCE(v_previous_hash, '');

        CASE r.hash_algorithm
            WHEN 'MD5' THEN
                v_current_hash := encode(digest(v_hash_input, 'md5'), 'hex');
            WHEN 'SHA1' THEN
                v_current_hash := encode(digest(v_hash_input, 'sha1'), 'hex');
            WHEN 'SHA256' THEN
                v_current_hash := encode(digest(v_hash_input, 'sha256'), 'hex');
            WHEN 'SHA512' THEN
                v_current_hash := encode(digest(v_hash_input, 'sha512'), 'hex');
            ELSE
                v_current_hash := encode(digest(v_hash_input, 'sha256'), 'hex');
        END CASE;

        -- Return results
        audit_id := r.audit_id;
        action_timestamp := r.action_timestamp;
        record_hash := r.record_hash;
        calculated_hash := v_current_hash;
        hash_matches := (r.record_hash = v_current_hash);
        chain_integrity := (r.previous_hash = v_previous_hash);

        -- Store for next iteration
        v_previous_hash := r.record_hash;

        RETURN NEXT;
    END LOOP;

    RETURN;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION socialcandor_schema.verify_audit_integrity IS 'Verifies cryptographic integrity of audit trail and hash chain';

------------------------------------------------------------------------------------------------
-- Table: 37 - system_health_metrics
-- Description: Real-time infrastructure telemetry with component tagging
-- Business Case: Enables proactive incident prevention through anomaly detection while
-- supporting capacity planning and cloud cost optimization via resource utilization trends.
-- Integrates with monitoring and alerting systems for SRE operations.
-- Feature Reference: MON02 (System Monitoring), SRE01 (Site Reliability), CAP01 (Capacity Planning)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.system_health_metrics (
    metric_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Metric identification
    metric_name VARCHAR(200) NOT NULL,
    metric_namespace VARCHAR(100) NOT NULL,
    metric_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,

    -- Component context
    component_type VARCHAR(100) NOT NULL CHECK (
        component_type IN ('DATABASE', 'APPLICATION', 'WEB_SERVER', 'CACHE', 'QUEUE', 'STORAGE', 'NETWORK', 'LOAD_BALANCER')
    ),
    component_name VARCHAR(200) NOT NULL,
    component_id VARCHAR(100),
    component_version VARCHAR(50),

    -- Environment context
    environment VARCHAR(50) NOT NULL CHECK (
        environment IN ('PRODUCTION', 'STAGING', 'TEST', 'DEVELOPMENT', 'CANARY')
    ),
    deployment_id VARCHAR(100),
    region VARCHAR(50),
    availability_zone VARCHAR(50),

    -- Metric values
    metric_value NUMERIC(30,10) NOT NULL,
    metric_unit VARCHAR(50) NOT NULL,
    metric_type VARCHAR(50) NOT NULL CHECK (
        metric_type IN ('GAUGE', 'COUNTER', 'HISTOGRAM', 'SUMMARY', 'DERIVED')
    ),

    -- Aggregation and sampling
    aggregation_period_seconds INTEGER CHECK (aggregation_period_seconds >= 0),
    sample_count INTEGER CHECK (sample_count >= 1),
    min_value NUMERIC(30,10),
    max_value NUMERIC(30,10),
    avg_value NUMERIC(30,10),
    p50_value NUMERIC(30,10),
    p95_value NUMERIC(30,10),
    p99_value NUMERIC(30,10),

    -- Resource utilization
    cpu_percent NUMERIC(5,2) CHECK (cpu_percent >= 0 AND cpu_percent <= 100),
    memory_percent NUMERIC(5,2) CHECK (memory_percent >= 0 AND memory_percent <= 100),
    memory_used_bytes BIGINT CHECK (memory_used_bytes >= 0),
    memory_total_bytes BIGINT CHECK (memory_total_bytes >= 0),
    disk_usage_percent NUMERIC(5,2) CHECK (disk_usage_percent >= 0 AND disk_usage_percent <= 100),
    disk_used_bytes BIGINT CHECK (disk_used_bytes >= 0),
    disk_total_bytes BIGINT CHECK (disk_total_bytes >= 0),

    -- Network metrics
    network_in_bytes_per_second NUMERIC(20,2),
    network_out_bytes_per_second NUMERIC(20,2),
    network_connections INTEGER CHECK (network_connections >= 0),
    network_error_rate NUMERIC(5,4) CHECK (network_error_rate >= 0 AND network_error_rate <= 1),

    -- Database-specific metrics
    database_connections INTEGER CHECK (database_connections >= 0),
    database_locks INTEGER CHECK (database_locks >= 0),
    query_count_per_second NUMERIC(10,2),
    avg_query_duration_ms NUMERIC(10,2),

    -- Application-specific metrics
    request_rate_per_second NUMERIC(10,2),
    error_rate_per_second NUMERIC(10,2),
    response_time_p95_ms NUMERIC(10,2),
    throughput_bytes_per_second NUMERIC(20,2),

    -- Health status
    health_status VARCHAR(20) CHECK (
        health_status IN ('HEALTHY', 'DEGRADED', 'UNHEALTHY', 'UNKNOWN')
    ),
    health_score NUMERIC(5,2) CHECK (health_score >= 0 AND health_score <= 100),

    -- Alerting context
    alert_threshold NUMERIC(30,10),
    is_above_threshold BOOLEAN DEFAULT FALSE,
    alert_fired BOOLEAN DEFAULT FALSE,
    alert_id UUID,

    -- Tags and labels
    tags JSONB DEFAULT '{}',
    labels VARCHAR(100)[] DEFAULT '{}',

    -- Metadata
    collection_method VARCHAR(50) CHECK (
        collection_method IN ('AGENT', 'SCRAPE', 'PUSH', 'LOG', 'API')
    ),
    collection_agent VARCHAR(100),
    data_source VARCHAR(200),

    -- Retention and cost
    retention_days INTEGER DEFAULT 30 CHECK (retention_days >= 1 AND retention_days <= 3650),
    storage_cost_per_day NUMERIC(10,4),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Constraints
    CONSTRAINT uk_metric_unique UNIQUE (metric_name, component_name, metric_timestamp, environment),
    CONSTRAINT chk_metric_consistency CHECK (
        (metric_type != 'DERIVED' OR aggregation_period_seconds IS NOT NULL) AND
        (metric_type != 'COUNTER' OR metric_value >= 0)
    )
);

COMMENT ON TABLE socialcandor_schema.system_health_metrics IS 'Real-time infrastructure telemetry with component tagging for monitoring and capacity planning';
COMMENT ON COLUMN socialcandor_schema.system_health_metrics.health_score IS 'Composite health score (0-100) based on multiple metrics';

-- Indexes for system_health_metrics
CREATE INDEX IF NOT EXISTS idx_health_metrics_timestamp ON socialcandor_schema.system_health_metrics(metric_timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_health_metrics_name ON socialcandor_schema.system_health_metrics(metric_name);
CREATE INDEX IF NOT EXISTS idx_health_metrics_component ON socialcandor_schema.system_health_metrics(component_type, component_name);
CREATE INDEX IF NOT EXISTS idx_health_metrics_environment ON socialcandor_schema.system_health_metrics(environment);
CREATE INDEX IF NOT EXISTS idx_health_metrics_health ON socialcandor_schema.system_health_metrics(health_status);
CREATE INDEX IF NOT EXISTS idx_health_metrics_value ON socialcandor_schema.system_health_metrics(metric_value DESC);
CREATE INDEX IF NOT EXISTS idx_health_metrics_cpu ON socialcandor_schema.system_health_metrics(cpu_percent DESC) WHERE cpu_percent IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_health_metrics_memory ON socialcandor_schema.system_health_metrics(memory_percent DESC) WHERE memory_percent IS NOT NULL;

-- TimescaleDB hypertable for time-series optimization (if extension enabled)
-- SELECT create_hypertable('socialcandor_schema.system_health_metrics', 'metric_timestamp');

-- Materialized view for component health summary
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_component_health_summary AS
SELECT
    component_type,
    component_name,
    environment,
    DATE(metric_timestamp) AS metric_date,
    COUNT(*) AS metric_count,
    AVG(health_score) AS avg_health_score,
    MIN(health_score) AS min_health_score,
    MAX(health_score) AS max_health_score,
    AVG(cpu_percent) AS avg_cpu_percent,
    AVG(memory_percent) AS avg_memory_percent,
    AVG(disk_usage_percent) AS avg_disk_percent,
    BOOL_OR(alert_fired) AS had_alerts,
    COUNT(*) FILTER (WHERE health_status = 'UNHEALTHY') AS unhealthy_count
FROM socialcandor_schema.system_health_metrics
WHERE metric_timestamp >= CURRENT_TIMESTAMP - INTERVAL '30 days'
GROUP BY component_type, component_name, environment, DATE(metric_timestamp)
WITH DATA;

CREATE UNIQUE INDEX idx_mv_component_health ON socialcandor_schema.mv_component_health_summary(component_type, component_name, environment, metric_date);

-- Function to calculate health score
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_health_score()
RETURNS TRIGGER AS $$
BEGIN
    -- Calculate health score based on various metrics (simplified example)
    NEW.health_score := 100.0;

    -- Deduct points for high CPU
    IF NEW.cpu_percent > 80 THEN
        NEW.health_score := NEW.health_score - 20;
    ELSIF NEW.cpu_percent > 90 THEN
        NEW.health_score := NEW.health_score - 40;
    END IF;

    -- Deduct points for high memory
    IF NEW.memory_percent > 80 THEN
        NEW.health_score := NEW.health_score - 15;
    ELSIF NEW.memory_percent > 90 THEN
        NEW.health_score := NEW.health_score - 30;
    END IF;

    -- Deduct points for high disk usage
    IF NEW.disk_usage_percent > 80 THEN
        NEW.health_score := NEW.health_score - 10;
    ELSIF NEW.disk_usage_percent > 90 THEN
        NEW.health_score := NEW.health_score - 25;
    END IF;

    -- Deduct points for high error rate
    IF NEW.error_rate_per_second > 1 THEN
        NEW.health_score := NEW.health_score - 20;
    END IF;

    -- Ensure score stays in range
    NEW.health_score := GREATEST(0, LEAST(100, NEW.health_score));

    -- Determine health status
    IF NEW.health_score >= 90 THEN
        NEW.health_status := 'HEALTHY';
    ELSIF NEW.health_score >= 70 THEN
        NEW.health_status := 'DEGRADED';
    ELSE
        NEW.health_status := 'UNHEALTHY';
    END IF;

    -- Check if above alert threshold
    IF NEW.alert_threshold IS NOT NULL AND NEW.metric_value > NEW.alert_threshold THEN
        NEW.is_above_threshold := TRUE;
    ELSE
        NEW.is_above_threshold := FALSE;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_health_score_calculation
    BEFORE INSERT ON socialcandor_schema.system_health_metrics
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_health_score();

-- Trigger for updated_at
CREATE TRIGGER trg_health_metrics_updated_at
    BEFORE UPDATE ON socialcandor_schema.system_health_metrics
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 38 - system_health_logs
-- Description: Structured application error logging with severity levels
-- Business Case: Accelerates MTTR (Mean Time To Resolution) through centralized error
-- aggregation while enabling predictive failure detection via error pattern recognition.
-- Supports debugging, monitoring, and incident response workflows.
-- Feature Reference: LOG01 (Error Logging), MON03 (Error Monitoring), INC01 (Incident Response)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.system_health_logs (
    log_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Log identification
    log_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    log_level VARCHAR(20) NOT NULL CHECK (
        log_level IN ('DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL', 'FATAL')
    ),
    log_source VARCHAR(200) NOT NULL,
    log_category VARCHAR(100) NOT NULL CHECK (
        log_category IN ('APPLICATION', 'DATABASE', 'NETWORK', 'SECURITY', 'PERFORMANCE', 'AUDIT', 'BUSINESS')
    ),

    -- Component context
    component_type VARCHAR(100) NOT NULL,
    component_name VARCHAR(200) NOT NULL,
    component_version VARCHAR(50),
    module_name VARCHAR(200),
    function_name VARCHAR(200),
    line_number INTEGER CHECK (line_number >= 0),

    -- Environment context
    environment VARCHAR(50) NOT NULL CHECK (
        environment IN ('PRODUCTION', 'STAGING', 'TEST', 'DEVELOPMENT', 'CANARY')
    ),
    deployment_id VARCHAR(100),
    release_version VARCHAR(50),
    build_number VARCHAR(50),

    -- Error details
    error_code VARCHAR(100),
    error_message TEXT NOT NULL,
    error_details JSONB DEFAULT '{}',
    stack_trace TEXT,
    exception_type VARCHAR(200),
    exception_message TEXT,

    -- Request context
    request_id VARCHAR(100),
    session_id VARCHAR(100),
    user_id UUID,
    user_ip INET,
    user_agent TEXT,

    -- Resource context
    resource_type VARCHAR(100),
    resource_id VARCHAR(200),
    endpoint_path VARCHAR(500),
    http_method VARCHAR(10),
    status_code INTEGER CHECK (status_code >= 100 AND status_code <= 599),

    -- Performance context
    response_time_ms INTEGER CHECK (response_time_ms >= 0),
    memory_used_mb NUMERIC(10,2) CHECK (memory_used_mb >= 0),
    cpu_used_percent NUMERIC(5,2) CHECK (cpu_used_percent >= 0 AND cpu_used_percent <= 100),

    -- Business context
    business_process VARCHAR(200),
    transaction_id VARCHAR(100),
    customer_id VARCHAR(100),
    impact_level VARCHAR(20) CHECK (
        impact_level IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')
    ),

    -- Correlation and tracing
    correlation_id VARCHAR(100),
    trace_id VARCHAR(100),
    span_id VARCHAR(100),
    parent_log_id UUID,

    -- Alert and incident management
    alert_generated BOOLEAN DEFAULT FALSE,
    alert_id UUID,
    incident_created BOOLEAN DEFAULT FALSE,
    incident_id VARCHAR(100),
    escalation_level INTEGER DEFAULT 0 CHECK (escalation_level >= 0),

    -- Resolution tracking
    is_resolved BOOLEAN DEFAULT FALSE,
    resolved_at TIMESTAMP WITH TIME ZONE,
    resolved_by UUID,
    resolution_notes TEXT,
    fix_version VARCHAR(50),

    -- Pattern recognition
    error_pattern_hash VARCHAR(64),
    occurrence_count INTEGER DEFAULT 1 CHECK (occurrence_count >= 1),
    first_occurrence TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_occurrence TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- Tags and classification
    tags VARCHAR(50)[] DEFAULT '{}',
    classification VARCHAR(100) CHECK (
        classification IN ('BUG', 'CONFIGURATION', 'DEPENDENCY', 'NETWORK', 'DATABASE', 'PERFORMANCE', 'SECURITY')
    ),
    priority VARCHAR(20) CHECK (priority IN ('LOW', 'MEDIUM', 'HIGH', 'URGENT')),

    -- Metadata
    log_file_path VARCHAR(500),
    host_name VARCHAR(200),
    operating_system VARCHAR(100),
    application_name VARCHAR(100),

    -- Retention
    retention_days INTEGER DEFAULT 90 CHECK (retention_days >= 1 AND retention_days <= 3650),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Constraints
    CONSTRAINT chk_timestamp_consistency CHECK (log_timestamp >= created_at),
    CONSTRAINT chk_resolution_time CHECK (
        (is_resolved = FALSE AND resolved_at IS NULL) OR
        (is_resolved = TRUE AND resolved_at IS NOT NULL AND resolved_at >= log_timestamp)
    ),
    CONSTRAINT fk_health_logs_parent FOREIGN KEY (parent_log_id)
        REFERENCES socialcandor_schema.system_health_logs(log_id) ON DELETE SET NULL
);

COMMENT ON TABLE socialcandor_schema.system_health_logs IS 'Structured application error logging with severity levels and contextual metadata';
COMMENT ON COLUMN socialcandor_schema.system_health_logs.error_pattern_hash IS 'Hash of error pattern for grouping similar errors';

-- Indexes for system_health_logs
CREATE INDEX IF NOT EXISTS idx_health_logs_timestamp ON socialcandor_schema.system_health_logs(log_timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_health_logs_level ON socialcandor_schema.system_health_logs(log_level);
CREATE INDEX IF NOT EXISTS idx_health_logs_source ON socialcandor_schema.system_health_logs(log_source);
CREATE INDEX IF NOT EXISTS idx_health_logs_component ON socialcandor_schema.system_health_logs(component_type, component_name);
CREATE INDEX IF NOT EXISTS idx_health_logs_environment ON socialcandor_schema.system_health_logs(environment);
CREATE INDEX IF NOT EXISTS idx_health_logs_error_code ON socialcandor_schema.system_health_logs(error_code) WHERE error_code IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_health_logs_user ON socialcandor_schema.system_health_logs(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_health_logs_request ON socialcandor_schema.system_health_logs(request_id) WHERE request_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_health_logs_pattern ON socialcandor_schema.system_health_logs(error_pattern_hash) WHERE error_pattern_hash IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_health_logs_resolved ON socialcandor_schema.system_health_logs(is_resolved) WHERE is_resolved = FALSE;
CREATE INDEX IF NOT EXISTS idx_health_logs_alert ON socialcandor_schema.system_health_logs(alert_generated) WHERE alert_generated = TRUE;

-- Partition by month for performance
-- CREATE TABLE socialcandor_schema.system_health_logs_y2023m01 PARTITION OF socialcandor_schema.system_health_logs
-- FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');

-- Function to calculate error pattern hash
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_error_pattern_hash()
RETURNS TRIGGER AS $$
DECLARE
    v_pattern_input TEXT;
BEGIN
    -- Create pattern input from error characteristics (excluding variable data)
    v_pattern_input :=
        COALESCE(NEW.error_code, '') || '|' ||
        COALESCE(NEW.exception_type, '') || '|' ||
        COALESCE(SPLIT_PART(NEW.error_message, ':', 1), '') || '|' ||
        COALESCE(NEW.module_name, '') || '|' ||
        COALESCE(NEW.function_name, '') || '|' ||
        COALESCE(NEW.component_name, '') || '|' ||
        COALESCE(NEW.endpoint_path, '');

    -- Calculate hash
    NEW.error_pattern_hash := encode(digest(v_pattern_input, 'sha256'), 'hex');

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_error_pattern_hash
    BEFORE INSERT ON socialcandor_schema.system_health_logs
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_error_pattern_hash();

-- Function to group similar errors
CREATE OR REPLACE FUNCTION socialcandor_schema.group_similar_errors(p_pattern_hash VARCHAR(64))
RETURNS TABLE(
    log_id UUID,
    log_timestamp TIMESTAMP WITH TIME ZONE,
    log_level VARCHAR(20),
    component_name VARCHAR(200),
    error_message TEXT,
    occurrence_count INTEGER,
    first_occurrence TIMESTAMP WITH TIME ZONE,
    last_occurrence TIMESTAMP WITH TIME ZONE,
    is_resolved BOOLEAN
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        l.log_id,
        l.log_timestamp,
        l.log_level,
        l.component_name,
        l.error_message,
        l.occurrence_count,
        l.first_occurrence,
        l.last_occurrence,
        l.is_resolved
    FROM socialcandor_schema.system_health_logs l
    WHERE l.error_pattern_hash = p_pattern_hash
    ORDER BY l.last_occurrence DESC;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION socialcandor_schema.group_similar_errors IS 'Groups similar errors by pattern hash for analysis';

-- Trigger for updated_at
CREATE TRIGGER trg_health_logs_updated_at
    BEFORE UPDATE ON socialcandor_schema.system_health_logs
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 39 - user_activity_logs
-- Description: Comprehensive behavioral tracking for analytics and security
-- Business Case: Powers retention analysis, feature adoption funnels, and real-time
-- recommendation engines while detecting account takeover attempts through anomalous
-- behavior patterns. Supports both business intelligence and security monitoring.
-- Feature Reference: ANL01 (User Analytics), SEC02 (Behavior Monitoring), REC01 (Recommendations)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.user_activity_logs (
    activity_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Activity identification
    activity_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    activity_type VARCHAR(100) NOT NULL,
    activity_subtype VARCHAR(100),
    action_name VARCHAR(200) NOT NULL,

    -- Session context
    session_id VARCHAR(100) NOT NULL,
    device_id VARCHAR(200),
    device_type VARCHAR(50) CHECK (
        device_type IN ('WEB', 'MOBILE_IOS', 'MOBILE_ANDROID', 'DESKTOP', 'TABLET', 'TV', 'WEARABLE')
    ),
    device_platform VARCHAR(100),
    device_version VARCHAR(50),

    -- Location context
    ip_address INET,
    country_code VARCHAR(3),
    region VARCHAR(100),
    city VARCHAR(100),
    latitude NUMERIC(10,6),
    longitude NUMERIC(10,6),
    timezone VARCHAR(50),

    -- Application context
    app_version VARCHAR(50),
    app_build_number VARCHAR(50),
    os_name VARCHAR(100),
    os_version VARCHAR(50),
    browser_name VARCHAR(100),
    browser_version VARCHAR(50),

    -- Resource context
    resource_type VARCHAR(100),
    resource_id VARCHAR(200),
    resource_name VARCHAR(200),
    resource_path VARCHAR(500),
    endpoint VARCHAR(500),
    http_method VARCHAR(10),

    -- Action details
    action_details JSONB DEFAULT '{}',
    action_metadata JSONB DEFAULT '{}',
    action_duration_ms INTEGER CHECK (action_duration_ms >= 0),
    action_result VARCHAR(50) CHECK (
        action_result IN ('SUCCESS', 'FAILURE', 'PARTIAL', 'CANCELLED', 'TIMEOUT')
    ),
    error_code VARCHAR(100),
    error_message TEXT,

    -- User context
    user_segment VARCHAR(100),
    user_tier VARCHAR(50),
    is_premium_user BOOLEAN DEFAULT FALSE,
    days_since_registration INTEGER,

    -- Engagement metrics
    engagement_score NUMERIC(5,2) CHECK (engagement_score >= 0 AND engagement_score <= 100),
    session_duration_seconds INTEGER CHECK (session_duration_seconds >= 0),
    actions_in_session INTEGER CHECK (actions_in_session >= 1),

    -- Business metrics
    revenue_impact NUMERIC(10,2),
    conversion_event BOOLEAN DEFAULT FALSE,
    funnel_stage VARCHAR(100),
    campaign_id VARCHAR(100),

    -- Security context
    is_suspicious BOOLEAN DEFAULT FALSE,
    risk_score NUMERIC(5,2) CHECK (risk_score >= 0 AND risk_score <= 100),
    threat_indicator VARCHAR(100)[] DEFAULT '{}',
    authentication_method VARCHAR(50),
    mfa_used BOOLEAN DEFAULT FALSE,

    -- Performance metrics
    response_time_ms INTEGER CHECK (response_time_ms >= 0),
    network_latency_ms INTEGER CHECK (network_latency_ms >= 0),
    page_load_time_ms INTEGER CHECK (page_load_time_ms >= 0),

    -- Correlation and sequencing
    correlation_id VARCHAR(100),
    parent_activity_id UUID,
    activity_sequence INTEGER DEFAULT 1 CHECK (activity_sequence >= 1),

    -- Tags and classification
    tags VARCHAR(50)[] DEFAULT '{}',
    classification VARCHAR(100) CHECK (
        classification IN ('BROWSING', 'CONTENT_CREATION', 'SOCIAL_INTERACTION', 'COMMERCE', 'SETTINGS', 'SECURITY', 'SYSTEM')
    ),

    -- Retention settings
    retention_category VARCHAR(50) DEFAULT 'ANALYTICS' CHECK (
        retention_category IN ('ANALYTICS', 'SECURITY', 'COMPLIANCE', 'PERFORMANCE')
    ),
    retention_days INTEGER DEFAULT 365 CHECK (retention_days >= 30 AND retention_days <= 3650),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_activity_logs_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_activity_logs_parent FOREIGN KEY (parent_activity_id)
        REFERENCES socialcandor_schema.user_activity_logs(activity_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_timestamp_consistency CHECK (activity_timestamp >= created_at),
    CONSTRAINT chk_session_metrics CHECK (
        (session_duration_seconds IS NULL) OR
        (actions_in_session IS NULL) OR
        (actions_in_session >= 1)
    )
);

COMMENT ON TABLE socialcandor_schema.user_activity_logs IS 'Comprehensive behavioral tracking for analytics, personalization, and security monitoring';
COMMENT ON COLUMN socialcandor_schema.user_activity_logs.risk_score IS 'Risk assessment score for security monitoring (0=low risk, 100=high risk)';

-- Indexes for user_activity_logs
CREATE INDEX IF NOT EXISTS idx_activity_logs_user ON socialcandor_schema.user_activity_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_activity_logs_timestamp ON socialcandor_schema.user_activity_logs(activity_timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_activity_logs_type ON socialcandor_schema.user_activity_logs(activity_type);
CREATE INDEX IF NOT EXISTS idx_activity_logs_session ON socialcandor_schema.user_activity_logs(session_id);
CREATE INDEX IF NOT EXISTS idx_activity_logs_device ON socialcandor_schema.user_activity_logs(device_type, device_platform);
CREATE INDEX IF NOT EXISTS idx_activity_logs_country ON socialcandor_schema.user_activity_logs(country_code);
CREATE INDEX IF NOT EXISTS idx_activity_logs_resource ON socialcandor_schema.user_activity_logs(resource_type, resource_id) WHERE resource_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_activity_logs_suspicious ON socialcandor_schema.user_activity_logs(is_suspicious) WHERE is_suspicious = TRUE;
CREATE INDEX IF NOT EXISTS idx_activity_logs_conversion ON socialcandor_schema.user_activity_logs(conversion_event) WHERE conversion_event = TRUE;
CREATE INDEX IF NOT EXISTS idx_activity_logs_correlation ON socialcandor_schema.user_activity_logs(correlation_id) WHERE correlation_id IS NOT NULL;

-- Partition by month for performance
-- CREATE TABLE socialcandor_schema.user_activity_logs_y2023m01 PARTITION OF socialcandor_schema.user_activity_logs
-- FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');

-- Function to calculate engagement score
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_engagement_score()
RETURNS TRIGGER AS $$
BEGIN
    -- Calculate engagement score based on activity characteristics
    NEW.engagement_score := 50.0; -- Base score

    -- Adjust based on activity type
    CASE NEW.activity_type
        WHEN 'CONTENT_CREATION' THEN
            NEW.engagement_score := NEW.engagement_score + 30;
        WHEN 'SOCIAL_INTERACTION' THEN
            NEW.engagement_score := NEW.engagement_score + 20;
        WHEN 'COMMERCE' THEN
            NEW.engagement_score := NEW.engagement_score + 25;
        WHEN 'SETTINGS' THEN
            NEW.engagement_score := NEW.engagement_score + 5;
        ELSE
            NEW.engagement_score := NEW.engagement_score + 10;
    END CASE;

    -- Adjust based on session duration
    IF NEW.session_duration_seconds > 300 THEN -- 5 minutes
        NEW.engagement_score := NEW.engagement_score + 10;
    ELSIF NEW.session_duration_seconds > 60 THEN -- 1 minute
        NEW.engagement_score := NEW.engagement_score + 5;
    END IF;

    -- Adjust based on actions in session
    IF NEW.actions_in_session > 10 THEN
        NEW.engagement_score := NEW.engagement_score + 10;
    ELSIF NEW.actions_in_session > 5 THEN
        NEW.engagement_score := NEW.engagement_score + 5;
    END IF;

    -- Cap at 100
    NEW.engagement_score := LEAST(100, NEW.engagement_score);

    -- Calculate risk score (simplified)
    NEW.risk_score := 0.0;

    -- Increase risk for suspicious patterns
    IF NEW.is_suspicious THEN
        NEW.risk_score := 70.0;
    END IF;

    -- Increase risk for unusual locations
    IF NEW.country_code NOT IN ('US', 'CA', 'GB', 'AU', 'DE') THEN
        NEW.risk_score := NEW.risk_score + 10;
    END IF;

    -- Increase risk for multiple devices
    IF EXISTS (
        SELECT 1 FROM socialcandor_schema.user_activity_logs
        WHERE user_id = NEW.user_id
        AND device_id != NEW.device_id
        AND activity_timestamp > CURRENT_TIMESTAMP - INTERVAL '1 hour'
    ) THEN
        NEW.risk_score := NEW.risk_score + 15;
    END IF;

    -- Cap risk score at 100
    NEW.risk_score := LEAST(100, NEW.risk_score);

    -- Mark as suspicious if risk score is high
    IF NEW.risk_score > 60 THEN
        NEW.is_suspicious := TRUE;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_engagement_score_calculation
    BEFORE INSERT ON socialcandor_schema.user_activity_logs
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_engagement_score();

-- Materialized view for user engagement summary
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_user_engagement_daily AS
SELECT
    user_id,
    DATE(activity_timestamp) AS activity_date,
    COUNT(*) AS total_activities,
    COUNT(DISTINCT session_id) AS session_count,
    AVG(engagement_score) AS avg_engagement_score,
    MAX(engagement_score) AS max_engagement_score,
    SUM(CASE WHEN activity_type = 'CONTENT_CREATION' THEN 1 ELSE 0 END) AS content_creation_count,
    SUM(CASE WHEN activity_type = 'SOCIAL_INTERACTION' THEN 1 ELSE 0 END) AS social_interaction_count,
    SUM(CASE WHEN conversion_event = TRUE THEN 1 ELSE 0 END) AS conversion_count,
    BOOL_OR(is_suspicious) AS had_suspicious_activity,
    MAX(risk_score) AS max_risk_score
FROM socialcandor_schema.user_activity_logs
WHERE activity_timestamp >= CURRENT_TIMESTAMP - INTERVAL '90 days'
GROUP BY user_id, DATE(activity_timestamp)
WITH DATA;

CREATE UNIQUE INDEX idx_mv_user_engagement_daily ON socialcandor_schema.mv_user_engagement_daily(user_id, activity_date);

-- Trigger for updated_at
CREATE TRIGGER trg_activity_logs_updated_at
    BEFORE UPDATE ON socialcandor_schema.user_activity_logs
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 40 - content_engagement_metrics
-- Description: Normalized engagement tracking across content types
-- Business Case: Enables cross-content-type performance benchmarking and algorithmic
-- feed optimization through unified engagement scoring. Critical for maximizing
-- session duration KPIs and understanding content performance holistically.
-- Feature Reference: ENG01 (Engagement Analytics), REC02 (Content Optimization), ANL02 (Performance Benchmarking)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.content_engagement_metrics (
    metric_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Content identification
    content_id UUID NOT NULL,
    content_type socialcandor_schema.content_type NOT NULL,
    content_owner_id UUID NOT NULL,

    -- Time context
    metric_date DATE NOT NULL,
    metric_hour INTEGER CHECK (metric_hour >= 0 AND metric_hour <= 23),
    metric_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,

    -- Engagement metrics
    view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
    unique_viewers INTEGER DEFAULT 0 CHECK (unique_viewers >= 0),
    like_count INTEGER DEFAULT 0 CHECK (like_count >= 0),
    comment_count INTEGER DEFAULT 0 CHECK (comment_count >= 0),
    share_count INTEGER DEFAULT 0 CHECK (share_count >= 0),
    save_count INTEGER DEFAULT 0 CHECK (save_count >= 0),
    click_count INTEGER DEFAULT 0 CHECK (click_count >= 0),
    reaction_count INTEGER DEFAULT 0 CHECK (reaction_count >= 0),

    -- Time-based metrics
    avg_view_duration_seconds NUMERIC(10,2) CHECK (avg_view_duration_seconds >= 0),
    completion_rate NUMERIC(5,2) CHECK (completion_rate >= 0 AND completion_rate <= 100),
    bounce_rate NUMERIC(5,2) CHECK (bounce_rate >= 0 AND bounce_rate <= 100),

    -- Quality metrics
    engagement_rate NUMERIC(5,2) CHECK (engagement_rate >= 0 AND engagement_rate <= 100),
    virality_score NUMERIC(10,4) CHECK (virality_score >= 0),
    quality_score NUMERIC(5,2) CHECK (quality_score >= 0 AND quality_score <= 100),
    sentiment_score NUMERIC(5,2) CHECK (sentiment_score >= -1 AND sentiment_score <= 1),

    -- Monetary metrics
    revenue_generated NUMERIC(10,2) DEFAULT 0 CHECK (revenue_generated >= 0),
    tips_received NUMERIC(10,2) DEFAULT 0 CHECK (tips_received >= 0),
    ad_revenue NUMERIC(10,2) DEFAULT 0 CHECK (ad_revenue >= 0),

    -- Audience metrics
    new_followers_gained INTEGER DEFAULT 0,
    audience_retention_rate NUMERIC(5,2) CHECK (audience_retention_rate >= 0 AND audience_retention_rate <= 100),
    demographic_distribution JSONB DEFAULT '{}',

    -- Platform metrics
    platform_distribution JSONB DEFAULT '{}',
    device_distribution JSONB DEFAULT '{}',
    geographic_distribution JSONB DEFAULT '{}',

    -- Trending and ranking
    trending_score NUMERIC(10,4) DEFAULT 0,
    ranking_position INTEGER CHECK (ranking_position >= 1),
    percentile_rank NUMERIC(5,2) CHECK (percentile_rank >= 0 AND percentile_rank <= 100),

    -- Velocity metrics
    engagement_velocity NUMERIC(10,2) DEFAULT 0,
    growth_rate NUMERIC(10,2),
    acceleration_rate NUMERIC(10,2),

    -- Comparison metrics
    previous_period_comparison JSONB DEFAULT '{}',
    benchmark_comparison JSONB DEFAULT '{}',
    category_average_comparison JSONB DEFAULT '{}',

    -- Derived metrics (now calculated in trigger instead of generated columns)
    total_engagement INTEGER DEFAULT 0,
    engagement_per_view NUMERIC(10,4) DEFAULT 0,

    -- Tags and classification
    content_category VARCHAR(100),
    content_tags VARCHAR(50)[] DEFAULT '{}',
    content_language VARCHAR(10),

    -- Metadata
    is_aggregated BOOLEAN DEFAULT FALSE,
    aggregation_level VARCHAR(50) CHECK (
        aggregation_level IN ('HOURLY', 'DAILY', 'WEEKLY', 'MONTHLY', 'QUARTERLY', 'YEARLY')
    ),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Constraints
    CONSTRAINT uk_content_metrics_unique UNIQUE (content_id, metric_date, metric_hour, aggregation_level),
    CONSTRAINT chk_aggregation_consistency CHECK (
        (aggregation_level = 'HOURLY' AND metric_hour IS NOT NULL) OR
        (aggregation_level != 'HOURLY' AND metric_hour IS NULL)
    ),
    CONSTRAINT chk_unique_viewers CHECK (unique_viewers <= view_count),
    CONSTRAINT chk_total_engagement CHECK (total_engagement >= 0),
    CONSTRAINT chk_engagement_per_view CHECK (engagement_per_view >= 0)
);

COMMENT ON TABLE socialcandor_schema.content_engagement_metrics IS 'Normalized engagement tracking across content types for performance benchmarking';
COMMENT ON COLUMN socialcandor_schema.content_engagement_metrics.total_engagement IS 'Sum of all engagement actions (likes, comments, shares, saves, clicks, reactions)';
COMMENT ON COLUMN socialcandor_schema.content_engagement_metrics.engagement_per_view IS 'Engagement rate per view (total_engagement / view_count)';
COMMENT ON COLUMN socialcandor_schema.content_engagement_metrics.virality_score IS 'Measure of content sharing and distribution velocity';

-- Indexes for content_engagement_metrics
CREATE INDEX IF NOT EXISTS idx_content_metrics_content ON socialcandor_schema.content_engagement_metrics(content_id);
CREATE INDEX IF NOT EXISTS idx_content_metrics_owner ON socialcandor_schema.content_engagement_metrics(content_owner_id);
CREATE INDEX IF NOT EXISTS idx_content_metrics_date ON socialcandor_schema.content_engagement_metrics(metric_date DESC);
CREATE INDEX IF NOT EXISTS idx_content_metrics_type ON socialcandor_schema.content_engagement_metrics(content_type);
CREATE INDEX IF NOT EXISTS idx_content_metrics_engagement ON socialcandor_schema.content_engagement_metrics(total_engagement DESC);
CREATE INDEX IF NOT EXISTS idx_content_metrics_trending ON socialcandor_schema.content_engagement_metrics(trending_score DESC);
CREATE INDEX IF NOT EXISTS idx_content_metrics_category ON socialcandor_schema.content_engagement_metrics(content_category) WHERE content_category IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_content_metrics_aggregated ON socialcandor_schema.content_engagement_metrics(is_aggregated) WHERE is_aggregated = TRUE;

-- Function to calculate derived engagement metrics
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_engagement_metrics()
RETURNS TRIGGER AS $$
BEGIN
    -- Calculate total engagement
    NEW.total_engagement := 
        NEW.like_count + 
        NEW.comment_count + 
        NEW.share_count + 
        NEW.save_count + 
        NEW.click_count + 
        NEW.reaction_count;
    
    -- Calculate engagement per view
    IF NEW.view_count > 0 THEN
        NEW.engagement_per_view := ROUND(
            NEW.total_engagement::NUMERIC / NEW.view_count,
            4
        );
    ELSE
        NEW.engagement_per_view := 0.0;
    END IF;

    -- Calculate engagement rate
    IF NEW.view_count > 0 THEN
        NEW.engagement_rate := ROUND(
            ((NEW.like_count + NEW.comment_count + NEW.share_count + NEW.save_count)::NUMERIC / NEW.view_count) * 100,
            2
        );
    ELSE
        NEW.engagement_rate := 0.0;
    END IF;

    -- Calculate virality score (simplified)
    IF NEW.share_count > 0 AND NEW.view_count > 0 THEN
        NEW.virality_score := ROUND(
            (NEW.share_count::NUMERIC / NEW.view_count) * 100 *
            LOG(GREATEST(NEW.view_count, 1)) *
            (1 + (NEW.comment_count::NUMERIC / GREATEST(NEW.view_count, 1))),
            4
        );
    ELSE
        NEW.virality_score := 0.0;
    END IF;

    -- Calculate quality score (simplified)
    NEW.quality_score :=
        (NEW.engagement_rate * 0.4) +
        (COALESCE(NEW.completion_rate, 50) * 0.3) +
        (COALESCE(NEW.sentiment_score, 0) * 30 + 50) * 0.3;

    -- Ensure quality score is in range
    NEW.quality_score := GREATEST(0, LEAST(100, NEW.quality_score));

    -- Calculate trending score (simplified Reddit hot algorithm variant)
    IF NEW.metric_timestamp IS NOT NULL THEN
        DECLARE
            v_age_hours NUMERIC;
        BEGIN
            v_age_hours := EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - NEW.metric_timestamp)) / 3600;
            IF v_age_hours < 0.1 THEN
                v_age_hours := 0.1;
            END IF;

            NEW.trending_score :=
                (NEW.total_engagement + NEW.engagement_velocity * 5) /
                POWER(v_age_hours + 2, 1.8);
        END;
    END IF;

    -- Update timestamp
    NEW.updated_at := CURRENT_TIMESTAMP;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for engagement metrics calculation
CREATE TRIGGER trg_engagement_metrics_calculation
    BEFORE INSERT OR UPDATE ON socialcandor_schema.content_engagement_metrics
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_engagement_metrics();

-- Materialized view for top performing content
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_top_performing_content AS
SELECT
    content_id,
    content_type,
    content_owner_id,
    metric_date,
    SUM(view_count) AS total_views,
    SUM(total_engagement) AS total_engagement,
    AVG(engagement_rate) AS avg_engagement_rate,
    MAX(trending_score) AS max_trending_score,
    SUM(revenue_generated) AS total_revenue,
    COUNT(*) AS metric_count
FROM socialcandor_schema.content_engagement_metrics
WHERE metric_date >= CURRENT_DATE - INTERVAL '30 days'
AND is_aggregated = FALSE
GROUP BY content_id, content_type, content_owner_id, metric_date
HAVING SUM(view_count) > 100
ORDER BY total_engagement DESC
LIMIT 1000
WITH DATA;

CREATE UNIQUE INDEX idx_mv_top_content ON socialcandor_schema.mv_top_performing_content(content_id, metric_date);

-- Function to refresh the materialized view
CREATE OR REPLACE FUNCTION socialcandor_schema.refresh_top_performing_content()
RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY socialcandor_schema.mv_top_performing_content;
END;
$$ LANGUAGE plpgsql;

-- Partition by month for performance (uncomment and adjust as needed)
-- CREATE TABLE socialcandor_schema.content_engagement_metrics_y2023m01 PARTITION OF socialcandor_schema.content_engagement_metrics
-- FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');


------------------------------------------------------------------------------------------------
-- Table: 43 - roles
-- Description: Role definitions for RBAC system
-- Business Case: Enables least-privilege access control while supporting dynamic role
-- creation for enterprise customers requiring custom permission sets. Supports
-- system-defined and user-created roles with hierarchical inheritance.
-- Feature Reference: RBAC01 (Role Management), SEC03 (Access Control), ENT01 (Enterprise Features)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.roles (
    role_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Role identification
    role_name VARCHAR(100) NOT NULL UNIQUE,
    role_description TEXT NOT NULL,
    role_type VARCHAR(50) NOT NULL DEFAULT 'SYSTEM' CHECK (
        role_type IN ('SYSTEM', 'CUSTOM', 'ENTERPRISE', 'TEMPLATE')
    ),

    -- Hierarchy and inheritance
    parent_role_id UUID,
    role_hierarchy_level INTEGER DEFAULT 0 CHECK (role_hierarchy_level >= 0),
    inherits_permissions BOOLEAN DEFAULT TRUE,

    -- Scope and context
    scope_type VARCHAR(50) DEFAULT 'GLOBAL' CHECK (
        scope_type IN ('GLOBAL', 'TENANT', 'DEPARTMENT', 'TEAM', 'PROJECT', 'INDIVIDUAL')
    ),
    scope_id UUID,
    is_tenant_specific BOOLEAN DEFAULT FALSE,
    tenant_id UUID,

    -- Status and lifecycle
    is_active BOOLEAN DEFAULT TRUE,
    is_system_managed BOOLEAN DEFAULT FALSE,
    effective_from DATE DEFAULT CURRENT_DATE,
    effective_to DATE,
    deprecated_at TIMESTAMP WITH TIME ZONE,
    deprecated_by UUID,

    -- Usage metrics
    user_count INTEGER DEFAULT 0 CHECK (user_count >= 0),
    permission_count INTEGER DEFAULT 0 CHECK (permission_count >= 0),
    last_assigned_at TIMESTAMP WITH TIME ZONE,

    -- Security context
    requires_mfa BOOLEAN DEFAULT FALSE,
    session_timeout_minutes INTEGER DEFAULT 60 CHECK (session_timeout_minutes >= 5),
    max_concurrent_sessions INTEGER DEFAULT 5 CHECK (max_concurrent_sessions >= 1),
    ip_restrictions VARCHAR(100)[] DEFAULT '{}',

    -- Compliance and auditing
    is_privileged BOOLEAN DEFAULT FALSE,
    requires_approval BOOLEAN DEFAULT FALSE,
    approval_workflow_id UUID,
    review_frequency_days INTEGER DEFAULT 90 CHECK (review_frequency_days >= 30),
    last_reviewed_at TIMESTAMP WITH TIME ZONE,
    next_review_date DATE,

    -- Customization
    custom_properties JSONB DEFAULT '{}',
    role_color VARCHAR(7),
    role_icon VARCHAR(100),

    -- Documentation
    documentation_url VARCHAR(500),
    business_owner VARCHAR(200),
    technical_owner VARCHAR(200),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_roles_parent FOREIGN KEY (parent_role_id)
        REFERENCES socialcandor_schema.roles(role_id) ON DELETE SET NULL,
    CONSTRAINT fk_roles_deprecated_by FOREIGN KEY (deprecated_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_effective_dates CHECK (
        effective_to IS NULL OR effective_to > effective_from
    ),
    CONSTRAINT chk_hierarchy_cycle CHECK (
        role_id != parent_role_id
    ),
    CONSTRAINT chk_system_managed CHECK (
        (is_system_managed = TRUE AND role_type = 'SYSTEM') OR
        is_system_managed = FALSE
    )
);

COMMENT ON TABLE socialcandor_schema.roles IS 'Role definitions for RBAC system with system/user-created distinction';
COMMENT ON COLUMN socialcandor_schema.roles.role_hierarchy_level IS 'Depth in role hierarchy (0=root, 1=child of root, etc.)';

-- Indexes for roles
CREATE INDEX IF NOT EXISTS idx_roles_name ON socialcandor_schema.roles(role_name);
CREATE INDEX IF NOT EXISTS idx_roles_type ON socialcandor_schema.roles(role_type);
CREATE INDEX IF NOT EXISTS idx_roles_active ON socialcandor_schema.roles(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_roles_parent ON socialcandor_schema.roles(parent_role_id) WHERE parent_role_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_roles_scope ON socialcandor_schema.roles(scope_type, scope_id) WHERE scope_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_roles_tenant ON socialcandor_schema.roles(tenant_id) WHERE tenant_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_roles_privileged ON socialcandor_schema.roles(is_privileged) WHERE is_privileged = TRUE;
CREATE INDEX IF NOT EXISTS idx_roles_next_review ON socialcandor_schema.roles(next_review_date) WHERE next_review_date IS NOT NULL;

-- Function to prevent circular references in role hierarchy
CREATE OR REPLACE FUNCTION socialcandor_schema.check_role_hierarchy_cycle()
RETURNS TRIGGER AS $$
DECLARE
    v_current_id UUID := NEW.role_id;
    v_parent_id UUID := NEW.parent_role_id;
    v_visited UUID[] := ARRAY[v_current_id];
BEGIN
    -- Check for cycles
    WHILE v_parent_id IS NOT NULL LOOP
        -- If we've visited this parent already, there's a cycle
        IF v_parent_id = ANY(v_visited) THEN
            RAISE EXCEPTION 'Circular reference detected in role hierarchy for role %', NEW.role_name;
        END IF;

        -- Add parent to visited list
        v_visited := array_append(v_visited, v_parent_id);

        -- Get the parent's parent
        SELECT parent_role_id INTO v_parent_id
        FROM socialcandor_schema.roles
        WHERE role_id = v_parent_id;
    END LOOP;

    -- Calculate hierarchy level
    NEW.role_hierarchy_level := array_length(v_visited, 1) - 1;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_roles_hierarchy_check
    BEFORE INSERT OR UPDATE OF parent_role_id ON socialcandor_schema.roles
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.check_role_hierarchy_cycle();

-- Function to calculate next review date
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_role_review_date()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.next_review_date IS NULL AND NEW.review_frequency_days IS NOT NULL THEN
        NEW.next_review_date := CURRENT_DATE + (NEW.review_frequency_days || ' days')::INTERVAL;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_roles_review_date
    BEFORE INSERT OR UPDATE ON socialcandor_schema.roles
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_role_review_date();

-- Trigger for updated_at
CREATE TRIGGER trg_roles_updated_at
    BEFORE UPDATE ON socialcandor_schema.roles
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
-- Table: 44 - permissions
-- Description: Atomic permission definitions mapped to resources and actions
-- Business Case: Provides granular access control foundation while enabling permission
-- inheritance patterns and audit-ready permission justification documentation.
-- Supports complex authorization scenarios with resource-specific permissions.
-- Feature Reference: RBAC02 (Permission Management), SEC04 (Authorization), AUD03 (Permission Audit)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.permissions (
    permission_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Permission identification
    permission_code VARCHAR(200) NOT NULL UNIQUE,
    permission_name VARCHAR(200) NOT NULL,
    permission_description TEXT NOT NULL,

    -- Resource and action mapping
    resource_type VARCHAR(100) NOT NULL,
    resource_id VARCHAR(200),
    action_type VARCHAR(50) NOT NULL CHECK (
        action_type IN ('CREATE', 'READ', 'UPDATE', 'DELETE', 'EXECUTE', 'MANAGE', 'DELEGATE', 'APPROVE')
    ),
    action_scope VARCHAR(50) DEFAULT 'ALL' CHECK (
        action_scope IN ('ALL', 'OWN', 'TEAM', 'DEPARTMENT', 'TENANT', 'SYSTEM')
    ),

    -- Category and grouping
    permission_category VARCHAR(100) NOT NULL,
    permission_group VARCHAR(100),
    permission_weight INTEGER DEFAULT 1 CHECK (permission_weight >= 0),
    is_core_permission BOOLEAN DEFAULT FALSE,

    -- Security context
    risk_level VARCHAR(20) DEFAULT 'LOW' CHECK (
        risk_level IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')
    ),
    requires_approval BOOLEAN DEFAULT FALSE,
    approval_level INTEGER DEFAULT 1 CHECK (approval_level >= 1),
    mfa_required BOOLEAN DEFAULT FALSE,

    -- Dependencies and constraints
    depends_on_permissions UUID[] DEFAULT '{}',
    conflicts_with_permissions UUID[] DEFAULT '{}',
    prerequisite_permissions UUID[] DEFAULT '{}',

    -- Business context
    business_justification TEXT,
    regulatory_requirement VARCHAR(200),
    compliance_category VARCHAR(100) CHECK (
        compliance_category IN ('GDPR', 'HIPAA', 'PCI_DSS', 'SOX', 'ISO27001', 'OTHER')
    ),

    -- Technical implementation
    implementation_type VARCHAR(50) DEFAULT 'RBAC' CHECK (
        implementation_type IN ('RBAC', 'ABAC', 'PBAC', 'HYBRID')
    ),
    enforcement_point VARCHAR(200),
    validation_logic TEXT,

    -- Usage and metrics
    usage_count INTEGER DEFAULT 0 CHECK (usage_count >= 0),
    last_used_at TIMESTAMP WITH TIME ZONE,
    role_count INTEGER DEFAULT 0 CHECK (role_count >= 0),
    user_count INTEGER DEFAULT 0 CHECK (user_count >= 0),

    -- Status and lifecycle
    is_active BOOLEAN DEFAULT TRUE,
    is_deprecated BOOLEAN DEFAULT FALSE,
    deprecated_at TIMESTAMP WITH TIME ZONE,
    deprecated_by UUID,
    deprecated_reason TEXT,
    replacement_permission_id UUID,

    -- Versioning
    permission_version VARCHAR(20) NOT NULL DEFAULT '1.0',
    effective_from DATE DEFAULT CURRENT_DATE,
    effective_to DATE,

    -- Documentation
    documentation_url VARCHAR(500),
    business_owner VARCHAR(200),
    technical_owner VARCHAR(200),
    change_log JSONB DEFAULT '[]',

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_permissions_replacement FOREIGN KEY (replacement_permission_id)
        REFERENCES socialcandor_schema.permissions(permission_id) ON DELETE SET NULL,
    CONSTRAINT fk_permissions_deprecated_by FOREIGN KEY (deprecated_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_effective_dates CHECK (
        effective_to IS NULL OR effective_to > effective_from
    ),
    CONSTRAINT chk_permission_code_format CHECK (permission_code ~ '^[A-Z_][A-Z0-9_:]*$'),
    CONSTRAINT chk_deprecation_consistency CHECK (
        (is_deprecated = FALSE AND deprecated_at IS NULL AND deprecated_by IS NULL) OR
        (is_deprecated = TRUE AND deprecated_at IS NOT NULL)
    )
);

COMMENT ON TABLE socialcandor_schema.permissions IS 'Atomic permission definitions mapped to resources and actions';
COMMENT ON COLUMN socialcandor_schema.permissions.permission_weight IS 'Relative importance weight for permission scoring (higher = more sensitive)';

-- Indexes for permissions
CREATE INDEX IF NOT EXISTS idx_permissions_code ON socialcandor_schema.permissions(permission_code);
CREATE INDEX IF NOT EXISTS idx_permissions_resource ON socialcandor_schema.permissions(resource_type, resource_id);
CREATE INDEX IF NOT EXISTS idx_permissions_action ON socialcandor_schema.permissions(action_type, action_scope);
CREATE INDEX IF NOT EXISTS idx_permissions_category ON socialcandor_schema.permissions(permission_category);
CREATE INDEX IF NOT EXISTS idx_permissions_active ON socialcandor_schema.permissions(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_permissions_risk ON socialcandor_schema.permissions(risk_level);
CREATE INDEX IF NOT EXISTS idx_permissions_core ON socialcandor_schema.permissions(is_core_permission) WHERE is_core_permission = TRUE;
CREATE INDEX IF NOT EXISTS idx_permissions_deprecated ON socialcandor_schema.permissions(is_deprecated) WHERE is_deprecated = TRUE;
CREATE INDEX IF NOT EXISTS idx_permissions_usage ON socialcandor_schema.permissions(usage_count DESC);

-- Function to validate permission dependencies
CREATE OR REPLACE FUNCTION socialcandor_schema.validate_permission_dependencies()
RETURNS TRIGGER AS $$
BEGIN
    -- Check that dependencies exist and are active
    IF CARDINALITY(NEW.depends_on_permissions) > 0 THEN
        IF EXISTS (
            SELECT 1 FROM socialcandor_schema.permissions
            WHERE permission_id = ANY(NEW.depends_on_permissions)
            AND (is_active = FALSE OR is_deprecated = TRUE)
        ) THEN
            RAISE EXCEPTION 'Cannot depend on inactive or deprecated permissions';
        END IF;
    END IF;

    -- Check that conflicts don't include dependencies
    IF CARDINALITY(NEW.conflicts_with_permissions) > 0 AND CARDINALITY(NEW.depends_on_permissions) > 0 THEN
        IF NEW.depends_on_permissions && NEW.conflicts_with_permissions THEN
            RAISE EXCEPTION 'Permission cannot both depend on and conflict with the same permission';
        END IF;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_permissions_dependencies
    BEFORE INSERT OR UPDATE OF depends_on_permissions, conflicts_with_permissions ON socialcandor_schema.permissions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.validate_permission_dependencies();

-- Function to handle permission deprecation
CREATE OR REPLACE FUNCTION socialcandor_schema.handle_permission_deprecation()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.is_deprecated = TRUE AND OLD.is_deprecated = FALSE THEN
        NEW.deprecated_at := CURRENT_TIMESTAMP;
        NEW.effective_to := CURRENT_DATE;

        -- Log the deprecation
        INSERT INTO socialcandor_schema.audit_logs (
            action_type,
            user_id,
            target_type,
            target_id,
            action_details,
            created_by
        ) VALUES (
            'PERMISSION_DEPRECATED',
            NEW.deprecated_by,
            'PERMISSION',
            NEW.permission_id,
            jsonb_build_object(
                'permission_code', NEW.permission_code,
                'replacement_permission_id', NEW.replacement_permission_id,
                'deprecated_by', NEW.deprecated_by,
                'reason', NEW.deprecated_reason
            ),
            NEW.deprecated_by
        );
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_permissions_deprecation
    BEFORE UPDATE OF is_deprecated ON socialcandor_schema.permissions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.handle_permission_deprecation();

-- Trigger for updated_at
CREATE TRIGGER trg_permissions_updated_at
    BEFORE UPDATE ON socialcandor_schema.permissions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();


    ------------------------------------------------------------------------------------------------
    -- Table: 45 - role_permissions
    -- Description: Many-to-many role-permission assignments enabling permission composition
    -- Business Case: Supports role templating (e.g., "moderator template") and permission revocation
    -- at scale during security incidents without user reassignment. Enables fine-grained access
    -- control through atomic permission definitions mapped to resources and actions.
    -- Feature Reference: RBAC01 (Role-Based Access Control), SEC05 (Permission Management), AUD01 (Audit)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.role_permissions (
        role_permission_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        role_id UUID NOT NULL,
        permission_id UUID NOT NULL,

        -- Assignment metadata
        assigned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        assigned_by UUID NOT NULL,
        assignment_reason VARCHAR(200),

        -- Permission scope and context
        resource_id UUID,
        resource_type VARCHAR(50),
        conditions JSONB DEFAULT '{}',
        constraints JSONB DEFAULT '{}',

        -- Effective date range
        effective_from TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        effective_until TIMESTAMP WITH TIME ZONE,

        -- Inheritance and precedence
        inherited_from UUID,
        inheritance_level INTEGER DEFAULT 0 CHECK (inheritance_level >= 0),
        precedence INTEGER DEFAULT 0,

        -- Status and lifecycle
        is_active BOOLEAN DEFAULT TRUE,
        is_inheritable BOOLEAN DEFAULT TRUE,
        revoked_at TIMESTAMP WITH TIME ZONE,
        revoked_by UUID,
        revocation_reason VARCHAR(200),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_role_permissions_role FOREIGN KEY (role_id)
            REFERENCES socialcandor_schema.roles(role_id) ON DELETE CASCADE,
        CONSTRAINT fk_role_permissions_permission FOREIGN KEY (permission_id)
            REFERENCES socialcandor_schema.permissions(permission_id) ON DELETE CASCADE,
        CONSTRAINT fk_role_permissions_inherited FOREIGN KEY (inherited_from)
            REFERENCES socialcandor_schema.role_permissions(role_permission_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT uk_role_permission UNIQUE (role_id, permission_id, resource_id, resource_type),
        CONSTRAINT chk_effective_dates CHECK (
            (effective_until IS NULL) OR
            (effective_until > effective_from)
        ),
        CONSTRAINT chk_inheritance_depth CHECK (inheritance_level <= 10)
    );

    COMMENT ON TABLE socialcandor_schema.role_permissions IS 'Many-to-many role-permission assignments enabling permission composition and inheritance';
    COMMENT ON COLUMN socialcandor_schema.role_permissions.conditions IS 'JSON conditions for conditional permission application';
    COMMENT ON COLUMN socialcandor_schema.role_permissions.constraints IS 'JSON constraints limiting permission scope (time, location, etc.)';

    -- Indexes for role_permissions
    CREATE INDEX IF NOT EXISTS idx_role_permissions_role ON socialcandor_schema.role_permissions(role_id);
    CREATE INDEX IF NOT EXISTS idx_role_permissions_permission ON socialcandor_schema.role_permissions(permission_id);
    CREATE INDEX IF NOT EXISTS idx_role_permissions_active ON socialcandor_schema.role_permissions(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_role_permissions_effective ON socialcandor_schema.role_permissions(effective_from, effective_until);
    CREATE INDEX IF NOT EXISTS idx_role_permissions_resource ON socialcandor_schema.role_permissions(resource_type, resource_id);

    -- Trigger for updated_at
    CREATE TRIGGER trg_role_permissions_updated_at
        BEFORE UPDATE ON socialcandor_schema.role_permissions
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();
------------------------------------------------------------------------------------------------
-- Table: 46 - user_roles
-- Description: User-role assignments with assignment history and delegator tracking
-- Business Case: Enables compliance auditing of privileged access grants while supporting
-- temporary role elevation with automatic expiration for just-in-time access. Provides
-- comprehensive role assignment lifecycle management with delegation tracking.
-- Feature Reference: RBAC02 (User Role Assignment), AUD02 (Access Auditing), SEC06 (Temporary Access)
------------------------------------------------------------------------------------------------

-- First, ensure the update_updated_at_column function exists
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create the user_roles table
CREATE TABLE IF NOT EXISTS socialcandor_schema.user_roles (
    user_role_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,
    role_id UUID NOT NULL,

    -- Assignment details
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    assigned_by UUID NOT NULL,
    assignment_source VARCHAR(50) DEFAULT 'MANUAL' CHECK (
        assignment_source IN ('MANUAL', 'AUTO', 'WORKFLOW', 'IMPORT', 'SYSTEM', 'DELEGATION')
    ),
    assignment_reason TEXT,
    assignment_reference VARCHAR(200),

    -- Delegation chain
    delegated_from UUID,
    delegation_chain UUID[] DEFAULT '{}',
    delegation_depth INTEGER DEFAULT 0 CHECK (delegation_depth >= 0),

    -- Temporal constraints
    starts_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE,
    is_temporary BOOLEAN DEFAULT FALSE,
    temporary_duration_days INTEGER,

    -- Scope and context
    scope_type VARCHAR(50) DEFAULT 'GLOBAL' CHECK (
        scope_type IN ('GLOBAL', 'DEPARTMENT', 'TEAM', 'PROJECT', 'REGION', 'TENANT')
    ),
    scope_id UUID,
    conditions JSONB DEFAULT '{}',

    -- Status and lifecycle
    status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
        status IN ('ACTIVE', 'PENDING', 'SUSPENDED', 'EXPIRED', 'REVOKED', 'ESCALATED')
    ),
    suspended_at TIMESTAMP WITH TIME ZONE,
    suspended_by UUID,
    suspended_reason TEXT,
    revoked_at TIMESTAMP WITH TIME ZONE,
    revoked_by UUID,
    revocation_reason TEXT,

    -- Review and compliance
    last_reviewed_at TIMESTAMP WITH TIME ZONE,
    reviewed_by UUID,
    requires_review BOOLEAN DEFAULT FALSE,
    review_frequency_days INTEGER DEFAULT 90,

    -- Usage tracking
    last_used_at TIMESTAMP WITH TIME ZONE,
    usage_count INTEGER DEFAULT 0 CHECK (usage_count >= 0),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_user_roles_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_roles_role FOREIGN KEY (role_id)
        REFERENCES socialcandor_schema.roles(role_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_roles_assigned_by FOREIGN KEY (assigned_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_temporal_dates CHECK (
        (expires_at IS NULL) OR
        (expires_at > starts_at)
    ),
    CONSTRAINT chk_delegation_depth CHECK (delegation_depth <= 5)
);

COMMENT ON TABLE socialcandor_schema.user_roles IS 'User-role assignments with assignment history, delegation tracking, and temporal constraints';
COMMENT ON COLUMN socialcandor_schema.user_roles.delegation_chain IS 'Array tracking the delegation hierarchy for audit purposes';

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_user_roles_user ON socialcandor_schema.user_roles(user_id);
CREATE INDEX IF NOT EXISTS idx_user_roles_role ON socialcandor_schema.user_roles(role_id);
CREATE INDEX IF NOT EXISTS idx_user_roles_status ON socialcandor_schema.user_roles(status);
CREATE INDEX IF NOT EXISTS idx_user_roles_expires ON socialcandor_schema.user_roles(expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_user_roles_temporary ON socialcandor_schema.user_roles(is_temporary) WHERE is_temporary = TRUE;
CREATE INDEX IF NOT EXISTS idx_user_roles_scope ON socialcandor_schema.user_roles(scope_type, scope_id);
CREATE INDEX IF NOT EXISTS idx_user_roles_review ON socialcandor_schema.user_roles(requires_review, last_reviewed_at) WHERE requires_review = TRUE;

-- Unique constraint for active roles only (partial unique index)
CREATE UNIQUE INDEX IF NOT EXISTS uk_user_role_active 
ON socialcandor_schema.user_roles (user_id, role_id, scope_type, scope_id) 
WHERE status = 'ACTIVE';

-- Function to handle role expiration
CREATE OR REPLACE FUNCTION socialcandor_schema.handle_role_expiration()
RETURNS TRIGGER AS $$
BEGIN
    -- Check for expired roles
    UPDATE socialcandor_schema.user_roles
    SET
        status = 'EXPIRED',
        updated_at = CURRENT_TIMESTAMP,
        updated_by = uuid_nil()
    WHERE expires_at IS NOT NULL
    AND expires_at <= CURRENT_TIMESTAMP
    AND status = 'ACTIVE';

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create triggers (using DO blocks to conditionally drop triggers only if they exist)
DO $$
BEGIN
    -- Drop triggers if they exist
    IF EXISTS (
        SELECT 1 FROM pg_trigger 
        WHERE tgname = 'trg_check_role_expiration' 
        AND tgrelid = 'socialcandor_schema.user_roles'::regclass
    ) THEN
        DROP TRIGGER trg_check_role_expiration ON socialcandor_schema.user_roles;
    END IF;

    IF EXISTS (
        SELECT 1 FROM pg_trigger 
        WHERE tgname = 'trg_user_roles_updated_at' 
        AND tgrelid = 'socialcandor_schema.user_roles'::regclass
    ) THEN
        DROP TRIGGER trg_user_roles_updated_at ON socialcandor_schema.user_roles;
    END IF;
END
$$;

-- Create trigger for role expiration check
CREATE TRIGGER trg_check_role_expiration
    AFTER INSERT OR UPDATE OF expires_at ON socialcandor_schema.user_roles
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.handle_role_expiration();

-- Create trigger for updated_at
CREATE TRIGGER trg_user_roles_updated_at
    BEFORE UPDATE ON socialcandor_schema.user_roles
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 47 - user_content_preferences
    -- Description: Explicit user preference tracking for content categories and types
    -- Business Case: Powers cold-start recommendation solving for new users while enabling
    -- preference-based ad targeting without relying solely on behavioral inference.
    -- Enhances privacy compliance by using explicit preferences instead of inferred interests.
    -- Feature Reference: REC03 (Content Preferences), PRV04 (Explicit Consent), PER01 (Personalization)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.user_content_preferences (
        preference_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        user_id UUID NOT NULL,

        -- Content categories
        preferred_categories VARCHAR(100)[] DEFAULT '{}',
        excluded_categories VARCHAR(100)[] DEFAULT '{}',
        category_weights JSONB DEFAULT '{}',

        -- Content types
        preferred_content_types socialcandor_schema.content_type[] DEFAULT '{}',
        excluded_content_types socialcandor_schema.content_type[] DEFAULT '{}',

        -- Language preferences
        preferred_languages VARCHAR(10)[] DEFAULT ARRAY['en']::VARCHAR(10)[],
        auto_translate BOOLEAN DEFAULT FALSE,
        translation_threshold INTEGER DEFAULT 70 CHECK (translation_threshold >= 0 AND translation_threshold <= 100),

        -- Maturity and sensitivity
        maturity_level VARCHAR(20) DEFAULT 'GENERAL' CHECK (
            maturity_level IN ('GENERAL', 'TEEN', 'MATURE', 'RESTRICTED')
        ),
        show_sensitive_content BOOLEAN DEFAULT FALSE,
        content_warnings_enabled BOOLEAN DEFAULT TRUE,

        -- Temporal preferences
        preferred_viewing_times JSONB DEFAULT '{
            "weekdays": {"start": "09:00", "end": "18:00"},
            "weekends": {"start": "10:00", "end": "22:00"}
        }',
        timezone_based_filtering BOOLEAN DEFAULT TRUE,

        -- Social preferences
        preferred_creators UUID[] DEFAULT '{}',
        excluded_creators UUID[] DEFAULT '{}',
        show_friends_content_first BOOLEAN DEFAULT TRUE,
        show_trending_content BOOLEAN DEFAULT TRUE,

        -- Engagement preferences
        auto_play_videos BOOLEAN DEFAULT TRUE,
        video_autoplay_settings JSONB DEFAULT '{
            "wifi": true,
            "cellular": false,
            "sound": false
        }',
        notification_frequency VARCHAR(20) DEFAULT 'STANDARD' CHECK (
            notification_frequency IN ('MINIMAL', 'STANDARD', 'FREQUENT', 'REAL_TIME')
        ),

        -- Discovery preferences
        discovery_intensity VARCHAR(20) DEFAULT 'BALANCED' CHECK (
            discovery_intensity IN ('CONSERVATIVE', 'BALANCED', 'EXPLORATORY', 'ADVENTUROUS')
        ),
        show_similar_content BOOLEAN DEFAULT TRUE,
        show_diverse_content BOOLEAN DEFAULT TRUE,

        -- Privacy preferences
        personalized_ads_enabled BOOLEAN DEFAULT TRUE,
        data_for_personalization BOOLEAN DEFAULT TRUE,
        cross_device_personalization BOOLEAN DEFAULT TRUE,

        -- Learning preferences
        allow_preference_learning BOOLEAN DEFAULT TRUE,
        last_learned_at TIMESTAMP WITH TIME ZONE,
        learning_confidence NUMERIC(5,2) DEFAULT 0.0 CHECK (learning_confidence >= 0 AND learning_confidence <= 100),

        -- Versioning
        preference_version INTEGER DEFAULT 1,
        last_updated_by_source VARCHAR(50) DEFAULT 'USER' CHECK (
            last_updated_by_source IN ('USER', 'SYSTEM', 'LEARNING', 'IMPORT')
        ),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_user_content_preferences_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_user_content_preferences UNIQUE (user_id),
        CONSTRAINT chk_translation_threshold CHECK (translation_threshold BETWEEN 0 AND 100)
    );

    COMMENT ON TABLE socialcandor_schema.user_content_preferences IS 'Explicit user preference tracking for content categories, types, and personalization settings';
    COMMENT ON COLUMN socialcandor_schema.user_content_preferences.learning_confidence IS 'Confidence score for machine-learned preferences (0-100)';

    -- Indexes for user_content_preferences
    CREATE INDEX IF NOT EXISTS idx_user_content_preferences_user ON socialcandor_schema.user_content_preferences(user_id);
    CREATE INDEX IF NOT EXISTS idx_user_content_preferences_categories ON socialcandor_schema.user_content_preferences USING gin(preferred_categories);
    CREATE INDEX IF NOT EXISTS idx_user_content_preferences_languages ON socialcandor_schema.user_content_preferences USING gin(preferred_languages);
    CREATE INDEX IF NOT EXISTS idx_user_content_preferences_maturity ON socialcandor_schema.user_content_preferences(maturity_level);

    -- GIN index for JSONB columns
    CREATE INDEX IF NOT EXISTS idx_user_content_preferences_weights ON socialcandor_schema.user_content_preferences USING gin(category_weights);
    CREATE INDEX IF NOT EXISTS idx_user_content_preferences_viewing_times ON socialcandor_schema.user_content_preferences USING gin(preferred_viewing_times);

    -- Trigger for updated_at
    CREATE TRIGGER trg_user_content_preferences_updated_at
        BEFORE UPDATE ON socialcandor_schema.user_content_preferences
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 48 - content_similarity
    -- Description: Precomputed content similarity scores for recommendation algorithms
    -- Business Case: Accelerates "because you liked X" recommendations while reducing real-time
    -- computation costs. Critical for scaling recommendation systems to millions of users with
    -- sub-second latency requirements. Supports multiple similarity algorithms and decay factors.
    -- Feature Reference: REC04 (Content Similarity), ALG01 (Algorithmic Scaling), PER02 (Performance)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.content_similarity (
        similarity_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Content references
        source_content_id UUID NOT NULL,
        source_content_type socialcandor_schema.content_type NOT NULL,
        target_content_id UUID NOT NULL,
        target_content_type socialcandor_schema.content_type NOT NULL,

        -- Similarity algorithms
        algorithm_name VARCHAR(50) NOT NULL CHECK (
            algorithm_name IN ('CONTENT_BASED', 'COLLABORATIVE', 'HYBRID', 'SEMANTIC', 'DEEP_LEARNING')
        ),
        algorithm_version VARCHAR(20) NOT NULL,

        -- Similarity metrics
        similarity_score NUMERIC(8,6) NOT NULL CHECK (similarity_score >= 0 AND similarity_score <= 1),
        confidence_score NUMERIC(5,2) DEFAULT 0.0 CHECK (confidence_score >= 0 AND confidence_score <= 100),
        rank_position INTEGER,

        -- Feature vectors and metadata
        feature_vector FLOAT[],
        feature_dimensions INTEGER CHECK (feature_dimensions >= 0),
        similarity_metadata JSONB DEFAULT '{}',

        -- Context and weighting
        context_type VARCHAR(50) DEFAULT 'GENERAL' CHECK (
            context_type IN ('GENERAL', 'PERSONALIZED', 'TRENDING', 'SEASONAL', 'LOCAL')
        ),
        context_weights JSONB DEFAULT '{}',
        decay_factor NUMERIC(5,4) DEFAULT 1.0 CHECK (decay_factor >= 0 AND decay_factor <= 1),

        -- Temporal aspects
        computed_at TIMESTAMP WITH TIME ZONE NOT NULL,
        valid_until TIMESTAMP WITH TIME ZONE,
        is_stale BOOLEAN DEFAULT FALSE,
        staleness_reason VARCHAR(100),

        -- Performance metrics
        computation_time_ms INTEGER,
        memory_usage_kb INTEGER,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Constraints
        CONSTRAINT uk_content_similarity UNIQUE (
            source_content_id,
            target_content_id,
            algorithm_name,
            context_type
        ),
        CONSTRAINT chk_content_not_self CHECK (source_content_id != target_content_id),
        CONSTRAINT chk_feature_dimensions CHECK (
            (feature_vector IS NULL AND feature_dimensions IS NULL) OR
            (feature_vector IS NOT NULL AND feature_dimensions IS NOT NULL AND
             array_length(feature_vector, 1) = feature_dimensions)
        )
    );

    COMMENT ON TABLE socialcandor_schema.content_similarity IS 'Precomputed content similarity scores for recommendation algorithms with multiple algorithm support';
    COMMENT ON COLUMN socialcandor_schema.content_similarity.decay_factor IS 'Factor for time-based similarity decay (1.0 = no decay)';

    -- Indexes for content_similarity
    CREATE INDEX IF NOT EXISTS idx_content_similarity_source ON socialcandor_schema.content_similarity(source_content_id);
    CREATE INDEX IF NOT EXISTS idx_content_similarity_target ON socialcandor_schema.content_similarity(target_content_id);
    CREATE INDEX IF NOT EXISTS idx_content_similarity_algorithm ON socialcandor_schema.content_similarity(algorithm_name);
    CREATE INDEX IF NOT EXISTS idx_content_similarity_score ON socialcandor_schema.content_similarity(similarity_score DESC);
    CREATE INDEX IF NOT EXISTS idx_content_similarity_computed ON socialcandor_schema.content_similarity(computed_at DESC);
    CREATE INDEX IF NOT EXISTS idx_content_similarity_context ON socialcandor_schema.content_similarity(context_type);
    CREATE INDEX IF NOT EXISTS idx_content_similarity_stale ON socialcandor_schema.content_similarity(is_stale) WHERE is_stale = TRUE;

    -- Index for feature-based similarity search
    CREATE INDEX IF NOT EXISTS idx_content_similarity_feature ON socialcandor_schema.content_similarity
    USING gin(feature_vector)
    WHERE feature_vector IS NOT NULL;

    -- Trigger for updated_at
    CREATE TRIGGER trg_content_similarity_updated_at
        BEFORE UPDATE ON socialcandor_schema.content_similarity
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    -- Materialized view for top similar content
    CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_top_similar_content AS
    SELECT
        source_content_id,
        source_content_type,
        target_content_id,
        target_content_type,
        algorithm_name,
        similarity_score,
        confidence_score,
        rank_position,
        computed_at,
        ROW_NUMBER() OVER (
            PARTITION BY source_content_id, algorithm_name
            ORDER BY similarity_score DESC
        ) as similarity_rank
    FROM socialcandor_schema.content_similarity
    WHERE similarity_score > 0.3
    AND is_stale = FALSE
    AND (valid_until IS NULL OR valid_until > CURRENT_TIMESTAMP)
    WITH DATA;

    CREATE UNIQUE INDEX idx_mv_top_similar_content ON socialcandor_schema.mv_top_similar_content(source_content_id, algorithm_name, similarity_rank);
    CREATE INDEX idx_mv_top_similar_content_score ON socialcandor_schema.mv_top_similar_content(similarity_score DESC);

    ------------------------------------------------------------------------------------------------
    -- Table: 49 - user_segments
    -- Description: Dynamic audience segmentation framework for targeted feature rollouts
    -- Business Case: Enables precision marketing campaigns and personalized user experiences
    -- at scale while supporting regulatory requirements for age-gated content distribution.
    -- Supports complex segmentation logic with real-time evaluation and expiration.
    -- Feature Reference: SEG01 (User Segmentation), MKT02 (Targeted Marketing), PER03 (Personalization)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.user_segments (
        segment_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Segment identification
        segment_name VARCHAR(200) NOT NULL,
        segment_code VARCHAR(100) UNIQUE NOT NULL,
        segment_description TEXT,

        -- Segment classification
        segment_type VARCHAR(50) NOT NULL DEFAULT 'STATIC' CHECK (
            segment_type IN ('STATIC', 'DYNAMIC', 'BEHAVIORAL', 'DEMOGRAPHIC', 'GEOGRAPHIC', 'CUSTOM')
        ),
        segment_category VARCHAR(100),
        parent_segment_id UUID,

        -- Target audience
        target_audience VARCHAR(50) DEFAULT 'ALL_USERS' CHECK (
            target_audience IN ('ALL_USERS', 'REGISTERED', 'ACTIVE', 'PREMIUM', 'CREATORS', 'ENTERPRISE')
        ),
        min_users INTEGER DEFAULT 0 CHECK (min_users >= 0),
        max_users INTEGER CHECK (max_users >= 0),

        -- Rules and logic
        rule_engine VARCHAR(50) DEFAULT 'SQL' CHECK (rule_engine IN ('SQL', 'JSON_LOGIC', 'CUSTOM', 'ML_MODEL')),
        rule_definition JSONB NOT NULL,
        rule_version INTEGER DEFAULT 1,

        -- Evaluation settings
        evaluation_frequency VARCHAR(20) DEFAULT 'REALTIME' CHECK (
            evaluation_frequency IN ('REALTIME', 'HOURLY', 'DAILY', 'WEEKLY', 'MANUAL')
        ),
        last_evaluated_at TIMESTAMP WITH TIME ZONE,
        next_evaluation_at TIMESTAMP WITH TIME ZONE,
        evaluation_timeout_seconds INTEGER DEFAULT 300,

        -- Performance metrics
        estimated_user_count INTEGER,
        actual_user_count INTEGER CHECK (actual_user_count >= 0),
        evaluation_duration_ms INTEGER,
        evaluation_success_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (evaluation_success_rate >= 0 AND evaluation_success_rate <= 100),

        -- Status and lifecycle
        is_active BOOLEAN DEFAULT TRUE,
        is_public BOOLEAN DEFAULT FALSE,
        status VARCHAR(20) DEFAULT 'DRAFT' CHECK (
            status IN ('DRAFT', 'ACTIVE', 'PAUSED', 'ARCHIVED', 'ERROR')
        ),
        activation_date TIMESTAMP WITH TIME ZONE,
        deactivation_date TIMESTAMP WITH TIME ZONE,

        -- Compliance and governance
        data_sensitivity_level socialcandor_schema.data_classification DEFAULT 'INTERNAL',
        retention_policy_days INTEGER DEFAULT 90 CHECK (retention_policy_days >= 0),
        requires_approval BOOLEAN DEFAULT FALSE,
        approved_by UUID,
        approved_at TIMESTAMP WITH TIME ZONE,

        -- Usage tracking
        used_in_campaigns INTEGER DEFAULT 0 CHECK (used_in_campaigns >= 0),
        last_used_at TIMESTAMP WITH TIME ZONE,
        usage_analytics JSONB DEFAULT '{}',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_user_segments_parent FOREIGN KEY (parent_segment_id)
            REFERENCES socialcandor_schema.user_segments(segment_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_max_users CHECK (max_users IS NULL OR max_users >= min_users),
        CONSTRAINT chk_activation_dates CHECK (
            (deactivation_date IS NULL) OR
            (deactivation_date > activation_date)
        )
    );

    COMMENT ON TABLE socialcandor_schema.user_segments IS 'Dynamic audience segmentation framework for targeted feature rollouts and marketing campaigns';
    COMMENT ON COLUMN socialcandor_schema.user_segments.rule_definition IS 'JSON definition of segment rules for evaluation engine';

    -- Indexes for user_segments
    CREATE INDEX IF NOT EXISTS idx_user_segments_code ON socialcandor_schema.user_segments(segment_code);
    CREATE INDEX IF NOT EXISTS idx_user_segments_type ON socialcandor_schema.user_segments(segment_type);
    CREATE INDEX IF NOT EXISTS idx_user_segments_active ON socialcandor_schema.user_segments(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_user_segments_status ON socialcandor_schema.user_segments(status);
    CREATE INDEX IF NOT EXISTS idx_user_segments_parent ON socialcandor_schema.user_segments(parent_segment_id) WHERE parent_segment_id IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_user_segments_created ON socialcandor_schema.user_segments(created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_user_segments_evaluation ON socialcandor_schema.user_segments(next_evaluation_at) WHERE next_evaluation_at IS NOT NULL;

    -- Full-text search for segment names and descriptions
    CREATE INDEX IF NOT EXISTS idx_user_segments_search ON socialcandor_schema.user_segments
    USING gin(to_tsvector('english', segment_name || ' ' || COALESCE(segment_description, '')));

    -- Trigger for updated_at
    CREATE TRIGGER trg_user_segments_updated_at
        BEFORE UPDATE ON socialcandor_schema.user_segments
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 50 - segment_rules
    -- Description: Configurable segmentation logic with JSONB rule definitions
    -- Business Case: Allows non-technical marketers to create segments without engineering
    -- dependency while maintaining version control for segment definitions during campaign
    -- analysis. Supports complex logical operators and nested conditions.
    -- Feature Reference: SEG02 (Rule Management), MKT03 (Campaign Rules), DEV02 (Low-Code)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.segment_rules (
        rule_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        segment_id UUID NOT NULL,

        -- Rule identification
        rule_name VARCHAR(200) NOT NULL,
        rule_order INTEGER NOT NULL DEFAULT 0 CHECK (rule_order >= 0),
        rule_group VARCHAR(100),

        -- Rule logic
        rule_type VARCHAR(50) NOT NULL CHECK (
            rule_type IN ('INCLUSION', 'EXCLUSION', 'FILTER', 'TRANSFORMATION', 'AGGREGATION')
        ),
        condition_type VARCHAR(50) NOT NULL DEFAULT 'AND' CHECK (
            condition_type IN ('AND', 'OR', 'NOT', 'XOR', 'NAND')
        ),
        rule_conditions JSONB NOT NULL,

        -- Data sources
        data_source_type VARCHAR(50) DEFAULT 'USER_PROFILE' CHECK (
            data_source_type IN ('USER_PROFILE', 'BEHAVIORAL', 'TRANSACTIONAL', 'DEMOGRAPHIC', 'GEOGRAPHIC', 'CUSTOM')
        ),
        data_source_table VARCHAR(200),
        data_source_column VARCHAR(200),

        -- Comparison and operators
        comparison_operator VARCHAR(20) CHECK (
            comparison_operator IN ('EQUALS', 'NOT_EQUALS', 'GREATER_THAN', 'LESS_THAN',
                                   'BETWEEN', 'IN', 'NOT_IN', 'CONTAINS', 'STARTS_WITH', 'ENDS_WITH')
        ),
        comparison_value JSONB,
        comparison_value_type VARCHAR(50) DEFAULT 'STRING' CHECK (
            comparison_value_type IN ('STRING', 'NUMBER', 'BOOLEAN', 'DATE', 'ARRAY', 'OBJECT')
        ),

        -- Performance optimization
        is_indexed BOOLEAN DEFAULT FALSE,
        index_columns VARCHAR(200)[] DEFAULT '{}',
        estimated_selectivity NUMERIC(5,2) CHECK (estimated_selectivity >= 0 AND estimated_selectivity <= 100),

        -- Versioning
        rule_version INTEGER DEFAULT 1,
        previous_version_id UUID,
        version_notes TEXT,

        -- Validation and testing
        is_validated BOOLEAN DEFAULT FALSE,
        validation_result JSONB,
        test_user_count INTEGER DEFAULT 0 CHECK (test_user_count >= 0),
        test_success_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (test_success_rate >= 0 AND test_success_rate <= 100),

        -- Status and lifecycle
        is_active BOOLEAN DEFAULT TRUE,
        activation_date TIMESTAMP WITH TIME ZONE,
        deactivation_date TIMESTAMP WITH TIME ZONE,

        -- Complexity metrics
        rule_complexity_score INTEGER DEFAULT 0 CHECK (rule_complexity_score >= 0),
        nested_levels INTEGER DEFAULT 0 CHECK (nested_levels >= 0),
        condition_count INTEGER DEFAULT 0 CHECK (condition_count >= 0),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_segment_rules_segment FOREIGN KEY (segment_id)
            REFERENCES socialcandor_schema.user_segments(segment_id) ON DELETE CASCADE,
        CONSTRAINT fk_segment_rules_previous FOREIGN KEY (previous_version_id)
            REFERENCES socialcandor_schema.segment_rules(rule_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT uk_segment_rule_order UNIQUE (segment_id, rule_order),
        CONSTRAINT chk_rule_conditions_not_empty CHECK (jsonb_array_length(rule_conditions) > 0),
        CONSTRAINT chk_deactivation_date CHECK (
            (deactivation_date IS NULL) OR
            (deactivation_date > activation_date)
        )
    );

    COMMENT ON TABLE socialcandor_schema.segment_rules IS 'Configurable segmentation logic with JSONB rule definitions and version control';
    COMMENT ON COLUMN socialcandor_schema.segment_rules.rule_complexity_score IS 'Calculated complexity score for rule evaluation optimization';

    -- Indexes for segment_rules
    CREATE INDEX IF NOT EXISTS idx_segment_rules_segment ON socialcandor_schema.segment_rules(segment_id);
    CREATE INDEX IF NOT EXISTS idx_segment_rules_active ON socialcandor_schema.segment_rules(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_segment_rules_type ON socialcandor_schema.segment_rules(rule_type);
    CREATE INDEX IF NOT EXISTS idx_segment_rules_order ON socialcandor_schema.segment_rules(rule_order);
    CREATE INDEX IF NOT EXISTS idx_segment_rules_created ON socialcandor_schema.segment_rules(created_at DESC);

    -- GIN index for rule conditions JSONB search
    CREATE INDEX IF NOT EXISTS idx_segment_rules_conditions ON socialcandor_schema.segment_rules USING gin(rule_conditions);

    -- Trigger for updated_at
    CREATE TRIGGER trg_segment_rules_updated_at
        BEFORE UPDATE ON socialcandor_schema.segment_rules
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    -- Function to validate rule conditions
    CREATE OR REPLACE FUNCTION socialcandor_schema.validate_segment_rule_conditions()
    RETURNS TRIGGER AS $$
    DECLARE
        v_conditions_count INTEGER;
        v_max_conditions INTEGER := 100;
    BEGIN
        -- Validate JSON structure
        IF NOT jsonb_typeof(NEW.rule_conditions) = 'array' THEN
            RAISE EXCEPTION 'Rule conditions must be a JSON array';
        END IF;

        -- Check condition count
        v_conditions_count := jsonb_array_length(NEW.rule_conditions);
        IF v_conditions_count > v_max_conditions THEN
            RAISE EXCEPTION 'Rule cannot have more than % conditions', v_max_conditions;
        END IF;

        -- Update complexity metrics
        NEW.nested_levels := socialcandor_schema.calculate_nested_levels(NEW.rule_conditions);
        NEW.condition_count := v_conditions_count;
        NEW.rule_complexity_score := v_conditions_count * 2 + NEW.nested_levels * 5;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Supporting function for nested level calculation
    CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_nested_levels(conditions JSONB)
    RETURNS INTEGER AS $$
    DECLARE
        v_max_depth INTEGER := 0;
        v_current_depth INTEGER;
        v_condition JSONB;
    BEGIN
        FOR i IN 0..jsonb_array_length(conditions)-1 LOOP
            v_condition := conditions->i;

            -- Recursively check nested conditions
            IF jsonb_typeof(v_condition->'conditions') = 'array' THEN
                v_current_depth := 1 + socialcandor_schema.calculate_nested_levels(v_condition->'conditions');
                IF v_current_depth > v_max_depth THEN
                    v_max_depth := v_current_depth;
                END IF;
            END IF;
        END LOOP;

        RETURN v_max_depth;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_validate_segment_rule_conditions
        BEFORE INSERT OR UPDATE OF rule_conditions ON socialcandor_schema.segment_rules
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.validate_segment_rule_conditions();

    ------------------------------------------------------------------------------------------------
-- Table: 51 - user_segment_assignments
-- Description: User-to-segment mappings with expiration support for time-bound segments
-- Business Case: Enables ephemeral segments (e.g., "users who saw Black Friday campaign")
-- while preventing segment bloat through automatic cleanup of stale assignments.
-- Supports real-time segment evaluation and membership tracking.
-- Feature Reference: SEG03 (Assignment Management), MKT04 (Temporal Segments), PER04 (Real-time)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.user_segment_assignments (
    assignment_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,
    segment_id UUID NOT NULL,

    -- Assignment details
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    assigned_by_source VARCHAR(50) DEFAULT 'RULE_ENGINE' CHECK (
        assigned_by_source IN ('RULE_ENGINE', 'MANUAL', 'IMPORT', 'API', 'WORKFLOW', 'LEARNING')
    ),
    assignment_reference VARCHAR(200),

    -- Temporal constraints
    effective_from TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    effective_until TIMESTAMP WITH TIME ZONE,
    is_time_bound BOOLEAN DEFAULT FALSE,

    -- Assignment confidence
    confidence_score NUMERIC(5,2) DEFAULT 100.0 CHECK (confidence_score >= 0 AND confidence_score <= 100),
    confidence_reason VARCHAR(200),

    -- Rule matching
    matched_rule_id UUID,
    matched_conditions JSONB DEFAULT '{}',
    match_strength NUMERIC(5,2) DEFAULT 100.0 CHECK (match_strength >= 0 AND match_strength <= 100),

    -- Status and lifecycle
    assignment_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
        assignment_status IN ('ACTIVE', 'PENDING', 'EXPIRED', 'REMOVED', 'OVERRIDDEN')
    ),
    removed_at TIMESTAMP WITH TIME ZONE,
    removal_reason VARCHAR(200),

    -- Re-evaluation tracking
    last_evaluated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    evaluation_count INTEGER DEFAULT 1 CHECK (evaluation_count >= 0),
    requires_re_evaluation BOOLEAN DEFAULT FALSE,
    next_evaluation_at TIMESTAMP WITH TIME ZONE,

    -- Performance metrics
    evaluation_duration_ms INTEGER,
    memory_usage_kb INTEGER,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_user_segment_assignments_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_segment_assignments_segment FOREIGN KEY (segment_id)
        REFERENCES socialcandor_schema.user_segments(segment_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_segment_assignments_rule FOREIGN KEY (matched_rule_id)
        REFERENCES socialcandor_schema.segment_rules(rule_id) ON DELETE SET NULL,

    -- Constraints (removed the invalid UNIQUE constraint with WHERE clause)
    CONSTRAINT chk_effective_dates CHECK (
        (effective_until IS NULL) OR
        (effective_until > effective_from)
    ),
    CONSTRAINT chk_evaluation_future CHECK (
        (next_evaluation_at IS NULL) OR
        (next_evaluation_at > last_evaluated_at)
    )
);

COMMENT ON TABLE socialcandor_schema.user_segment_assignments IS 'User-to-segment mappings with expiration support and confidence scoring';
COMMENT ON COLUMN socialcandor_schema.user_segment_assignments.match_strength IS 'Strength of rule match (0-100) indicating how well user fits segment';

-- Indexes for user_segment_assignments
CREATE INDEX IF NOT EXISTS idx_user_segment_assignments_user ON socialcandor_schema.user_segment_assignments(user_id);
CREATE INDEX IF NOT EXISTS idx_user_segment_assignments_segment ON socialcandor_schema.user_segment_assignments(segment_id);
CREATE INDEX IF NOT EXISTS idx_user_segment_assignments_status ON socialcandor_schema.user_segment_assignments(assignment_status);
CREATE INDEX IF NOT EXISTS idx_user_segment_assignments_effective ON socialcandor_schema.user_segment_assignments(effective_from, effective_until);
CREATE INDEX IF NOT EXISTS idx_user_segment_assignments_evaluation ON socialcandor_schema.user_segment_assignments(next_evaluation_at) WHERE next_evaluation_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_user_segment_assignments_confidence ON socialcandor_schema.user_segment_assignments(confidence_score DESC);
CREATE INDEX IF NOT EXISTS idx_user_segment_assignments_created ON socialcandor_schema.user_segment_assignments(created_at DESC);

-- Partial index for active assignments (replaces the invalid UNIQUE constraint)
CREATE UNIQUE INDEX IF NOT EXISTS idx_user_segment_assignments_active_unique 
ON socialcandor_schema.user_segment_assignments(user_id, segment_id)
WHERE assignment_status = 'ACTIVE';

-- Regular index for active assignments (for general queries)
CREATE INDEX IF NOT EXISTS idx_user_segment_assignments_active 
ON socialcandor_schema.user_segment_assignments(user_id, segment_id)
WHERE assignment_status = 'ACTIVE';

-- Trigger for updated_at
CREATE TRIGGER trg_user_segment_assignments_updated_at
    BEFORE UPDATE ON socialcandor_schema.user_segment_assignments
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Trigger to handle assignment expiration
CREATE OR REPLACE FUNCTION socialcandor_schema.handle_segment_assignment_expiration()
RETURNS TRIGGER AS $$
BEGIN
    -- Check for expired assignments
    UPDATE socialcandor_schema.user_segment_assignments
    SET
        assignment_status = 'EXPIRED',
        updated_at = CURRENT_TIMESTAMP,
        updated_by = uuid_nil()
    WHERE effective_until IS NOT NULL
    AND effective_until <= CURRENT_TIMESTAMP
    AND assignment_status = 'ACTIVE';

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_check_segment_assignment_expiration
    AFTER INSERT OR UPDATE OF effective_until ON socialcandor_schema.user_segment_assignments
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.handle_segment_assignment_expiration();
	


-- Create the update_updated_at_column function if it doesn't exist
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

------------------------------------------------------------------------------------------------
--   Create advertisers table (without materialized view dependency)
	
    ------------------------------------------------------------------------------------------------
    -- Table: 52 - advertisers
    -- Description: Advertiser account management with billing information and balance tracking
    -- Business Case: Creates self-serve advertising ecosystem while enabling credit limits and
    -- fraud prevention through balance monitoring and payment verification workflows.
    -- Supports multi-tier advertiser accounts with compliance requirements.
    -- Feature Reference: AD01 (Advertiser Management), BIL01 (Billing), FRA01 (Fraud Prevention)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.advertisers (
    advertiser_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Company information
    company_name VARCHAR(200) NOT NULL,
    company_type VARCHAR(50) CHECK (
        company_type IN ('BRAND', 'AGENCY', 'RESELLER', 'PUBLISHER', 'AFFILIATE', 'INDIVIDUAL')
    ),
    company_registration_number VARCHAR(100),
    tax_id VARCHAR(50),
    vat_number VARCHAR(50),

    -- Contact information
    contact_name VARCHAR(200),
    contact_email VARCHAR(255) NOT NULL,
    contact_phone VARCHAR(20),
    contact_address TEXT,
    website_url VARCHAR(500),

    -- Industry and classification
    industry_category VARCHAR(100),
    sub_industry VARCHAR(100),
    advertiser_tier VARCHAR(20) DEFAULT 'STANDARD' CHECK (
        advertiser_tier IN ('BASIC', 'STANDARD', 'PREMIUM', 'ENTERPRISE', 'PARTNER')
    ),

    -- Account status
    account_status VARCHAR(20) DEFAULT 'PENDING_APPROVAL' CHECK (
        account_status IN ('PENDING_APPROVAL', 'ACTIVE', 'SUSPENDED', 'TERMINATED', 'BLACKLISTED')
    ),
    approval_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
        approval_status IN ('PENDING', 'APPROVED', 'REJECTED', 'UNDER_REVIEW')
    ),
    approved_by UUID,
    approved_at TIMESTAMP WITH TIME ZONE,
    rejection_reason TEXT,

    -- Billing and financials
    billing_currency CHAR(3) DEFAULT 'USD',
    credit_limit NUMERIC(15,2) DEFAULT 0.00 CHECK (credit_limit >= 0),
    current_balance NUMERIC(15,2) DEFAULT 0.00,
    outstanding_amount NUMERIC(15,2) DEFAULT 0.00 CHECK (outstanding_amount >= 0),
    total_spent NUMERIC(15,2) DEFAULT 0.00 CHECK (total_spent >= 0),

    -- Payment settings
    payment_method VARCHAR(50) DEFAULT 'CREDIT_CARD' CHECK (
        payment_method IN ('CREDIT_CARD', 'BANK_TRANSFER', 'PAYPAL', 'STRIPE', 'INVOICE')
    ),
    payment_terms_days INTEGER DEFAULT 30 CHECK (payment_terms_days >= 0),
    auto_replenish BOOLEAN DEFAULT FALSE,
    auto_replenish_threshold NUMERIC(15,2),
    auto_replenish_amount NUMERIC(15,2),

    -- Risk and compliance
    risk_score NUMERIC(5,2) DEFAULT 50.0 CHECK (risk_score >= 0 AND risk_score <= 100),
    risk_level VARCHAR(20) DEFAULT 'MEDIUM' CHECK (
        risk_level IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')
    ),
    compliance_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
        compliance_status IN ('PENDING', 'COMPLIANT', 'NON_COMPLIANT', 'EXEMPT')
    ),
    kyc_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
        kyc_status IN ('PENDING', 'VERIFIED', 'REJECTED', 'EXPIRED')
    ),

    -- Performance metrics
    total_campaigns INTEGER DEFAULT 0 CHECK (total_campaigns >= 0),
    active_campaigns INTEGER DEFAULT 0 CHECK (active_campaigns >= 0),
    total_impressions BIGINT DEFAULT 0 CHECK (total_impressions >= 0),
    total_clicks BIGINT DEFAULT 0 CHECK (total_clicks >= 0),
    total_conversions BIGINT DEFAULT 0 CHECK (total_conversions >= 0),
    avg_ctr NUMERIC(5,2) DEFAULT 0.0 CHECK (avg_ctr >= 0),
    avg_cpc NUMERIC(10,4) DEFAULT 0.0 CHECK (avg_cpc >= 0),

    -- Account preferences
    notification_preferences JSONB DEFAULT '{
        "low_balance": true,
        "campaign_paused": true,
        "campaign_completed": true,
        "monthly_report": true,
        "payment_due": true
    }',
    reporting_preferences JSONB DEFAULT '{
        "frequency": "WEEKLY",
        "format": "PDF",
        "metrics": ["impressions", "clicks", "conversions", "spend"]
    }',

    -- Account manager
    account_manager_id UUID,
    account_manager_notes TEXT,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_advertisers_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_advertisers_approved_by FOREIGN KEY (approved_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_advertisers_account_manager FOREIGN KEY (account_manager_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT uk_advertiser_user UNIQUE (user_id),
    CONSTRAINT uk_advertiser_company UNIQUE (company_name),
    CONSTRAINT chk_balance_limit CHECK (current_balance >= -credit_limit),
    CONSTRAINT chk_approval_dates CHECK (
        (approved_at IS NULL) OR
        (approved_at >= created_at)
    )
);

COMMENT ON TABLE socialcandor_schema.advertisers IS 'Advertiser account management with billing, compliance, and performance tracking';
COMMENT ON COLUMN socialcandor_schema.advertisers.risk_score IS 'Risk assessment score based on payment history and compliance';

-- Step 2: Create indexes for advertisers
CREATE INDEX IF NOT EXISTS idx_advertisers_user ON socialcandor_schema.advertisers(user_id);
CREATE INDEX IF NOT EXISTS idx_advertisers_status ON socialcandor_schema.advertisers(account_status);
CREATE INDEX IF NOT EXISTS idx_advertisers_tier ON socialcandor_schema.advertisers(advertiser_tier);
CREATE INDEX IF NOT EXISTS idx_advertisers_balance ON socialcandor_schema.advertisers(current_balance DESC);
CREATE INDEX IF NOT EXISTS idx_advertisers_risk ON socialcandor_schema.advertisers(risk_score DESC);
CREATE INDEX IF NOT EXISTS idx_advertisers_created ON socialcandor_schema.advertisers(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_advertisers_industry ON socialcandor_schema.advertisers(industry_category);

-- Step 3: Create trigger for advertisers
CREATE TRIGGER trg_advertisers_updated_at
    BEFORE UPDATE ON socialcandor_schema.advertisers
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------
    -- Table: 53 - ad_campaigns
    -- Description: Campaign configuration with budget pacing, targeting criteria, and scheduling
    -- Business Case: Supports sophisticated bidding strategies (CPC/CPM/oCPM) while enabling
    -- campaign performance forecasting through historical spend pattern analysis.
    -- Provides comprehensive campaign lifecycle management with real-time optimization.
    -- Feature Reference: AD02 (Campaign Management), BID01 (Bidding Strategies), OPT01 (Optimization)
    ------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.ad_campaigns (
    campaign_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    advertiser_id UUID NOT NULL,

    -- Campaign identification
    campaign_name VARCHAR(200) NOT NULL,
    campaign_code VARCHAR(100) UNIQUE NOT NULL,
    campaign_description TEXT,

    -- Campaign type and objectives
    campaign_type VARCHAR(50) NOT NULL DEFAULT 'AWARENESS' CHECK (
        campaign_type IN ('AWARENESS', 'CONSIDERATION', 'CONVERSION', 'RETENTION', 'REENGAGEMENT')
    ),
    primary_objective VARCHAR(50) NOT NULL CHECK (
        primary_objective IN ('IMPRESSIONS', 'CLICKS', 'CONVERSIONS', 'ENGAGEMENT', 'VIDEO_VIEWS', 'LEADS')
    ),
    secondary_objectives VARCHAR(50)[] DEFAULT '{}',

    -- Budget and pacing
    budget_type VARCHAR(20) DEFAULT 'DAILY' CHECK (
        budget_type IN ('DAILY', 'LIFETIME', 'PERFORMANCE', 'UNLIMITED')
    ),
    total_budget NUMERIC(15,2) NOT NULL CHECK (total_budget >= 0),
    daily_budget NUMERIC(15,2) CHECK (daily_budget >= 0),
    spent_to_date NUMERIC(15,2) DEFAULT 0.00 CHECK (spent_to_date >= 0 AND spent_to_date <= total_budget),
    remaining_budget NUMERIC(15,2) GENERATED ALWAYS AS (total_budget - spent_to_date) STORED,

    -- Bidding strategy
    bidding_strategy VARCHAR(50) DEFAULT 'CPC' CHECK (
        bidding_strategy IN ('CPC', 'CPM', 'CPA', 'CPV', 'OCPM', 'OCPC', 'AUTO')
    ),
    bid_amount NUMERIC(10,4) CHECK (bid_amount >= 0),
    bid_strategy_settings JSONB DEFAULT '{}',

    -- Scheduling
    start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    end_date TIMESTAMP WITH TIME ZONE,
    is_continuous BOOLEAN DEFAULT FALSE,
    day_parting_schedule JSONB DEFAULT '{}',
    timezone VARCHAR(50) DEFAULT 'UTC',

    -- Targeting criteria
    targeting_criteria JSONB NOT NULL,
    targeting_version INTEGER DEFAULT 1,
    excluded_audiences UUID[] DEFAULT '{}',

    -- Creative settings
    creative_rotation VARCHAR(20) DEFAULT 'OPTIMIZED' CHECK (
        creative_rotation IN ('EVEN', 'OPTIMIZED', 'SEQUENTIAL', 'WEIGHTED')
    ),
    frequency_capping JSONB DEFAULT '{
        "impressions_per_day": null,
        "impressions_per_week": null,
        "impressions_per_campaign": null
    }',

    -- Optimization settings
    optimization_goal VARCHAR(50),
    optimization_settings JSONB DEFAULT '{}',
    auto_optimization_enabled BOOLEAN DEFAULT TRUE,
    optimization_schedule VARCHAR(20) DEFAULT 'HOURLY' CHECK (
        optimization_schedule IN ('HOURLY', 'DAILY', 'WEEKLY', 'MANUAL')
    ),

    -- Performance tracking
    campaign_status VARCHAR(20) DEFAULT 'DRAFT' CHECK (
        campaign_status IN ('DRAFT', 'PENDING_APPROVAL', 'ACTIVE', 'PAUSED', 'COMPLETED', 'ARCHIVED', 'REJECTED')
    ),
    approval_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
        approval_status IN ('PENDING', 'APPROVED', 'REJECTED', 'CHANGES_REQUIRED')
    ),
    approved_by UUID,
    approved_at TIMESTAMP WITH TIME ZONE,

    -- Performance metrics
    impressions_delivered BIGINT DEFAULT 0 CHECK (impressions_delivered >= 0),
    clicks_delivered BIGINT DEFAULT 0 CHECK (clicks_delivered >= 0),
    conversions_delivered BIGINT DEFAULT 0 CHECK (conversions_delivered >= 0),
    ctr NUMERIC(5,2) DEFAULT 0.0 CHECK (ctr >= 0),
    average_cpc NUMERIC(10,4) DEFAULT 0.0 CHECK (average_cpc >= 0),
    conversion_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (conversion_rate >= 0),

    -- Pacing and delivery
    pacing_status VARCHAR(20) DEFAULT 'ON_TRACK' CHECK (
        pacing_status IN ('ON_TRACK', 'AHEAD', 'BEHIND', 'LIMITED', 'EXHAUSTED')
    ),
    pacing_adjustment_factor NUMERIC(5,2) DEFAULT 1.0,
    last_pacing_check TIMESTAMP WITH TIME ZONE,

    -- Compliance and review
    compliance_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
        compliance_status IN ('PENDING', 'PASSED', 'FAILED', 'EXEMPT')
    ),
    review_notes TEXT,
    rejection_reason TEXT,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_ad_campaigns_advertiser FOREIGN KEY (advertiser_id)
        REFERENCES socialcandor_schema.advertisers(advertiser_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_campaign_dates CHECK (
        (end_date IS NULL AND is_continuous = TRUE) OR
        (end_date IS NOT NULL AND end_date > start_date)
    ),
    CONSTRAINT chk_budget_consistency CHECK (
        (budget_type != 'DAILY' OR daily_budget IS NOT NULL) AND
        (budget_type = 'DAILY' AND daily_budget IS NOT NULL AND total_budget >= daily_budget) OR
        budget_type != 'DAILY'
    ),
    CONSTRAINT chk_bid_amount CHECK (
        (bidding_strategy IN ('CPC', 'CPA') AND bid_amount > 0) OR
        bidding_strategy NOT IN ('CPC', 'CPA')
    )
);

COMMENT ON TABLE socialcandor_schema.ad_campaigns IS 'Campaign configuration with budget pacing, targeting, and sophisticated bidding strategies';
COMMENT ON COLUMN socialcandor_schema.ad_campaigns.targeting_criteria IS 'JSON definition of audience targeting rules and filters';

-- Step 5: Create indexes for ad_campaigns
CREATE INDEX IF NOT EXISTS idx_ad_campaigns_advertiser ON socialcandor_schema.ad_campaigns(advertiser_id);
CREATE INDEX IF NOT EXISTS idx_ad_campaigns_status ON socialcandor_schema.ad_campaigns(campaign_status);
CREATE INDEX IF NOT EXISTS idx_ad_campaigns_type ON socialcandor_schema.ad_campaigns(campaign_type);
CREATE INDEX IF NOT EXISTS idx_ad_campaigns_dates ON socialcandor_schema.ad_campaigns(start_date, end_date);
CREATE INDEX IF NOT EXISTS idx_ad_campaigns_budget ON socialcandor_schema.ad_campaigns(total_budget DESC);
CREATE INDEX IF NOT EXISTS idx_ad_campaigns_pacing ON socialcandor_schema.ad_campaigns(pacing_status);
CREATE INDEX IF NOT EXISTS idx_ad_campaigns_created ON socialcandor_schema.ad_campaigns(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_ad_campaigns_targeting ON socialcandor_schema.ad_campaigns USING gin(targeting_criteria);

-- Step 6: Create trigger for ad_campaigns
CREATE TRIGGER trg_ad_campaigns_updated_at
    BEFORE UPDATE ON socialcandor_schema.ad_campaigns
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Step 7: Create function for campaign targeting validation
CREATE OR REPLACE FUNCTION socialcandor_schema.validate_campaign_targeting()
RETURNS TRIGGER AS $$
DECLARE
    v_targeting JSONB;
    v_segment_count INTEGER;
    v_max_segments INTEGER := 20;
BEGIN
    v_targeting := NEW.targeting_criteria;

    -- Validate JSON structure
    IF NOT jsonb_typeof(v_targeting) = 'object' THEN
        RAISE EXCEPTION 'Targeting criteria must be a JSON object';
    END IF;

    -- Check segment count
    IF v_targeting ? 'segments' THEN
        IF jsonb_typeof(v_targeting->'segments') = 'array' THEN
            v_segment_count := jsonb_array_length(v_targeting->'segments');
            IF v_segment_count > v_max_segments THEN
                RAISE EXCEPTION 'Cannot target more than % segments', v_max_segments;
            END IF;
        END IF;
    END IF;

    -- Validate required fields for certain campaign types
    IF NEW.campaign_type = 'CONVERSION' AND NOT (v_targeting ? 'conversion_tracking') THEN
        RAISE NOTICE 'Conversion campaigns should have conversion tracking configured';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Step 8: Create trigger for campaign targeting validation
CREATE TRIGGER trg_validate_campaign_targeting
    BEFORE INSERT OR UPDATE OF targeting_criteria ON socialcandor_schema.ad_campaigns
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.validate_campaign_targeting();

------------------------------------------------------------------------------------------------
-- Step 9: Add the missing column to advertisers table
------------------------------------------------------------------------------------------------
ALTER TABLE socialcandor_schema.advertisers
ADD COLUMN IF NOT EXISTS last_active_campaign_at TIMESTAMP WITH TIME ZONE;

------------------------------------------------------------------------------------------------
-- Step 10: Create materialized view (after both tables exist)
------------------------------------------------------------------------------------------------
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_advertiser_performance AS
SELECT
    a.advertiser_id,
    a.company_name,
    a.account_status,
    a.advertiser_tier,
    a.total_spent,
    a.current_balance,
    a.total_campaigns,
    a.active_campaigns,
    a.total_impressions,
    a.total_clicks,
    a.total_conversions,
    CASE
        WHEN a.total_impressions > 0
        THEN ROUND((a.total_clicks::NUMERIC / a.total_impressions) * 100, 2)
        ELSE 0
    END as overall_ctr,
    CASE
        WHEN a.total_clicks > 0
        THEN ROUND(a.total_spent / a.total_clicks, 4)
        ELSE 0
    END as overall_cpc,
    CASE
        WHEN a.total_spent > 0
        THEN ROUND(a.total_conversions::NUMERIC / (a.total_spent / 1000), 2)
        ELSE 0
    END as conversion_rate_per_spend,
    a.risk_score,
    a.created_at,
    c.last_active_campaign_at
FROM socialcandor_schema.advertisers a
LEFT JOIN (
    SELECT advertiser_id, MAX(updated_at) as last_active_campaign_at
    FROM socialcandor_schema.ad_campaigns
    WHERE campaign_status = 'ACTIVE'
    GROUP BY advertiser_id
) c ON a.advertiser_id = c.advertiser_id
WITH DATA;

-- Step 11: Create indexes for materialized view
CREATE UNIQUE INDEX IF NOT EXISTS idx_mv_advertiser_performance_id 
ON socialcandor_schema.mv_advertiser_performance(advertiser_id);

CREATE INDEX IF NOT EXISTS idx_mv_advertiser_performance_spent 
ON socialcandor_schema.mv_advertiser_performance(total_spent DESC);

CREATE INDEX IF NOT EXISTS idx_mv_advertiser_performance_ctr 
ON socialcandor_schema.mv_advertiser_performance(overall_ctr DESC);

-- Step 12: Create refresh function for materialized view
CREATE OR REPLACE FUNCTION socialcandor_schema.refresh_advertiser_performance()
RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY socialcandor_schema.mv_advertiser_performance;
END;
$$ LANGUAGE plpgsql;

------------------------------------------------------------------------------------------------
-- Optional: Create a function to refresh materialized view on schedule
------------------------------------------------------------------------------------------------
COMMENT ON FUNCTION socialcandor_schema.refresh_advertiser_performance() 
IS 'Refreshes the advertiser performance materialized view. Can be called from a scheduled job.';
	
	
	
   
    ------------------------------------------------------------------------------------------------
    -- Table: 54 - ad_creatives
    -- Description: Ad creative assets with multi-format support and brand safety
    -- Business Case: Enables A/B testing of creative variants while maintaining brand safety
    -- through pre-flight moderation and automatic resizing for placement requirements.
    -- Supports rich media formats with performance tracking and approval workflows.
    -- Feature Reference: AD03 (Creative Management), MOD04 (Brand Safety), TEST01 (A/B Testing)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.ad_creatives (
        creative_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        campaign_id UUID NOT NULL,
        advertiser_id UUID NOT NULL,

        -- Creative identification
        creative_name VARCHAR(200) NOT NULL,
        creative_type VARCHAR(50) NOT NULL CHECK (
            creative_type IN ('IMAGE', 'VIDEO', 'CAROUSEL', 'COLLECTION', 'PLAYABLE', 'DYNAMIC')
        ),
        creative_format VARCHAR(50) NOT NULL CHECK (
            creative_format IN ('BANNER', 'INTERSTITIAL', 'NATIVE', 'REWARDED', 'IN_FEED', 'STORY')
        ),

        -- Creative assets
        primary_image_url VARCHAR(500),
        video_url VARCHAR(500),
        thumbnail_url VARCHAR(500),
        media_files JSONB DEFAULT '[]',

        -- Content and messaging
        headline VARCHAR(200),
        description TEXT,
        call_to_action VARCHAR(100),
        display_url VARCHAR(500),
        destination_url VARCHAR(500) NOT NULL,

        -- Branding
        brand_name VARCHAR(100),
        brand_logo_url VARCHAR(500),
        primary_color VARCHAR(7),
        secondary_color VARCHAR(7),

        -- Technical specifications
        dimensions VARCHAR(20),
        file_size_bytes INTEGER CHECK (file_size_bytes >= 0),
        aspect_ratio NUMERIC(5,2),
        duration_seconds NUMERIC(6,2) CHECK (duration_seconds >= 0),
        mime_type VARCHAR(100),

        -- Moderation and compliance
        moderation_status VARCHAR(20) DEFAULT 'PENDING_REVIEW' CHECK (
            moderation_status IN ('PENDING_REVIEW', 'APPROVED', 'REJECTED', 'CHANGES_REQUIRED', 'EXEMPT')
        ),
        moderation_score NUMERIC(5,2) DEFAULT 0.0 CHECK (moderation_score >= 0 AND moderation_score <= 100),
        moderation_notes TEXT,
        moderated_by UUID,
        moderated_at TIMESTAMP WITH TIME ZONE,

        -- Brand safety
        brand_safety_score NUMERIC(5,2) DEFAULT 0.0 CHECK (brand_safety_score >= 0 AND brand_safety_score <= 100),
        sensitive_categories VARCHAR(100)[] DEFAULT '{}',
        content_warnings VARCHAR(200)[] DEFAULT '{}',

        -- Performance tracking
        performance_score NUMERIC(5,2) DEFAULT 50.0 CHECK (performance_score >= 0 AND performance_score <= 100),
        impressions_served BIGINT DEFAULT 0 CHECK (impressions_served >= 0),
        clicks_served BIGINT DEFAULT 0 CHECK (clicks_served >= 0),
        ctr NUMERIC(5,2) DEFAULT 0.0 CHECK (ctr >= 0),
        conversion_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (conversion_rate >= 0),

        -- A/B Testing
        is_variant BOOLEAN DEFAULT FALSE,
        variant_of UUID,
        variant_group VARCHAR(100),
        variant_weight NUMERIC(5,2) DEFAULT 100.0 CHECK (variant_weight >= 0 AND variant_weight <= 100),

        -- Scheduling and rotation
        start_date TIMESTAMP WITH TIME ZONE,
        end_date TIMESTAMP WITH TIME ZONE,
        is_active BOOLEAN DEFAULT TRUE,
        rotation_weight INTEGER DEFAULT 100 CHECK (rotation_weight >= 0 AND rotation_weight <= 100),

        -- Metadata and tracking
        tracking_parameters JSONB DEFAULT '{}',
        utm_parameters JSONB DEFAULT '{}',
        custom_parameters JSONB DEFAULT '{}',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_ad_creatives_campaign FOREIGN KEY (campaign_id)
            REFERENCES socialcandor_schema.ad_campaigns(campaign_id) ON DELETE CASCADE,
        CONSTRAINT fk_ad_creatives_advertiser FOREIGN KEY (advertiser_id)
            REFERENCES socialcandor_schema.advertisers(advertiser_id) ON DELETE CASCADE,
        CONSTRAINT fk_ad_creatives_variant FOREIGN KEY (variant_of)
            REFERENCES socialcandor_schema.ad_creatives(creative_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_creative_dates CHECK (
            (end_date IS NULL) OR
            (end_date > start_date)
        ),
        CONSTRAINT chk_variant_weight CHECK (
            (is_variant = FALSE AND variant_weight = 100) OR
            is_variant = TRUE
        ),
        CONSTRAINT chk_media_requirements CHECK (
            (creative_type != 'IMAGE' OR primary_image_url IS NOT NULL) AND
            (creative_type != 'VIDEO' OR video_url IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.ad_creatives IS 'Ad creative assets with multi-format support, brand safety, and performance tracking';
    COMMENT ON COLUMN socialcandor_schema.ad_creatives.brand_safety_score IS 'AI-generated score for brand safety and content appropriateness';

    -- Indexes for ad_creatives
    CREATE INDEX IF NOT EXISTS idx_ad_creatives_campaign ON socialcandor_schema.ad_creatives(campaign_id);
    CREATE INDEX IF NOT EXISTS idx_ad_creatives_advertiser ON socialcandor_schema.ad_creatives(advertiser_id);
    CREATE INDEX IF NOT EXISTS idx_ad_creatives_type ON socialcandor_schema.ad_creatives(creative_type);
    CREATE INDEX IF NOT EXISTS idx_ad_creatives_status ON socialcandor_schema.ad_creatives(moderation_status);
    CREATE INDEX IF NOT EXISTS idx_ad_creatives_active ON socialcandor_schema.ad_creatives(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_ad_creatives_variant ON socialcandor_schema.ad_creatives(variant_of) WHERE variant_of IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_ad_creatives_performance ON socialcandor_schema.ad_creatives(performance_score DESC);

    -- Trigger for updated_at
    CREATE TRIGGER trg_ad_creatives_updated_at
        BEFORE UPDATE ON socialcandor_schema.ad_creatives
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 55 - ad_placements
    -- Description: Inventory definition for ad slots with base pricing and targeting capabilities
    -- Business Case: Models ad inventory as a marketplace commodity while enabling dynamic pricing
    -- based on placement performance and user attention metrics. Supports inventory forecasting
    -- and yield optimization across different placement types.
    -- Feature Reference: AD04 (Inventory Management), PRC01 (Pricing), YLD01 (Yield Optimization)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.ad_placements (
        placement_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Placement identification
        placement_name VARCHAR(200) NOT NULL,
        placement_code VARCHAR(100) UNIQUE NOT NULL,
        placement_description TEXT,

        -- Placement classification
        placement_type VARCHAR(50) NOT NULL CHECK (
            placement_type IN ('IN_FEED', 'STORY', 'SEARCH', 'SIDEBAR', 'INTERSTITIAL', 'BANNER', 'NATIVE', 'VIDEO')
        ),
        platform VARCHAR(50) NOT NULL DEFAULT 'WEB' CHECK (
            platform IN ('WEB', 'MOBILE_WEB', 'IOS', 'ANDROID', 'ALL')
        ),
        placement_category VARCHAR(100),

        -- Location and context
        page_type VARCHAR(100),
        section_name VARCHAR(100),
        position_name VARCHAR(100),
        context_tags VARCHAR(100)[] DEFAULT '{}',

        -- Technical specifications
        dimensions VARCHAR(20),
        supported_formats VARCHAR(50)[] NOT NULL,
        supported_creative_types socialcandor_schema.content_type[] NOT NULL,
        max_file_size_kb INTEGER CHECK (max_file_size_kb >= 0),
        allowed_media_types VARCHAR(100)[] DEFAULT '{}',

        -- Pricing and inventory
        base_cpm NUMERIC(10,4) CHECK (base_cpm >= 0),
        base_cpc NUMERIC(10,4) CHECK (base_cpc >= 0),
        pricing_model VARCHAR(20) DEFAULT 'CPM' CHECK (
            pricing_model IN ('CPM', 'CPC', 'CPV', 'CPA', 'FLAT', 'HYBRID')
        ),
        inventory_capacity INTEGER CHECK (inventory_capacity >= 0),
        reserved_inventory INTEGER DEFAULT 0 CHECK (reserved_inventory >= 0 AND reserved_inventory <= inventory_capacity),
        available_inventory INTEGER GENERATED ALWAYS AS (inventory_capacity - reserved_inventory) STORED,

        -- Performance metrics
        average_ctr NUMERIC(5,2) DEFAULT 0.0 CHECK (average_ctr >= 0),
        average_viewability NUMERIC(5,2) DEFAULT 0.0 CHECK (average_viewability >= 0 AND average_viewability <= 100),
        average_completion_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (average_completion_rate >= 0 AND average_completion_rate <= 100),
        quality_score NUMERIC(5,2) DEFAULT 50.0 CHECK (quality_score >= 0 AND quality_score <= 100),

        -- Targeting capabilities
        targeting_options JSONB DEFAULT '{}',
        excluded_categories VARCHAR(100)[] DEFAULT '{}',
        content_restrictions JSONB DEFAULT '{}',

        -- Scheduling and availability
        is_active BOOLEAN DEFAULT TRUE,
        active_hours JSONB DEFAULT '{}',
        geographic_availability VARCHAR(3)[] DEFAULT '{}',
        language_availability VARCHAR(10)[] DEFAULT ARRAY['en']::VARCHAR(10)[],

        -- Monetization settings
        revenue_share_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (revenue_share_percentage >= 0 AND revenue_share_percentage <= 100),
        minimum_bid NUMERIC(10,4) CHECK (minimum_bid >= 0),
        auction_type VARCHAR(20) DEFAULT 'FIRST_PRICE' CHECK (
            auction_type IN ('FIRST_PRICE', 'SECOND_PRICE', 'UNIFIED')
        ),

        -- Performance tracking
        total_impressions BIGINT DEFAULT 0 CHECK (total_impressions >= 0),
        total_revenue NUMERIC(15,2) DEFAULT 0.00 CHECK (total_revenue >= 0),
        fill_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (fill_rate >= 0 AND fill_rate <= 100),
        last_served_at TIMESTAMP WITH TIME ZONE,

        -- Compliance and moderation
        requires_moderation BOOLEAN DEFAULT TRUE,
        moderation_level VARCHAR(20) DEFAULT 'STANDARD' CHECK (
            moderation_level IN ('NONE', 'BASIC', 'STANDARD', 'STRICT')
        ),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Constraints
        CONSTRAINT chk_inventory_positive CHECK (inventory_capacity >= reserved_inventory),
        CONSTRAINT chk_pricing_consistency CHECK (
            (pricing_model IN ('CPM', 'FLAT', 'HYBRID') AND base_cpm IS NOT NULL) OR
            (pricing_model = 'CPC' AND base_cpc IS NOT NULL) OR
            pricing_model NOT IN ('CPM', 'CPC', 'FLAT', 'HYBRID')
        )
    );

    COMMENT ON TABLE socialcandor_schema.ad_placements IS 'Inventory definition for ad slots with pricing, targeting, and performance metrics';
    COMMENT ON COLUMN socialcandor_schema.ad_placements.quality_score IS 'Overall quality score based on user engagement and viewability';

    -- Indexes for ad_placements
    CREATE INDEX IF NOT EXISTS idx_ad_placements_type ON socialcandor_schema.ad_placements(placement_type);
    CREATE INDEX IF NOT EXISTS idx_ad_placements_platform ON socialcandor_schema.ad_placements(platform);
    CREATE INDEX IF NOT EXISTS idx_ad_placements_active ON socialcandor_schema.ad_placements(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_ad_placements_quality ON socialcandor_schema.ad_placements(quality_score DESC);
    CREATE INDEX IF NOT EXISTS idx_ad_placements_pricing ON socialcandor_schema.ad_placements(base_cpm DESC);
    CREATE INDEX IF NOT EXISTS idx_ad_placements_inventory ON socialcandor_schema.ad_placements(available_inventory DESC);
    CREATE INDEX IF NOT EXISTS idx_ad_placements_created ON socialcandor_schema.ad_placements(created_at DESC);

    -- Trigger for updated_at
    CREATE TRIGGER trg_ad_placements_updated_at
        BEFORE UPDATE ON socialcandor_schema.ad_placements
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();
------------------------------------------------------------------------------------------------
    -- Table: 56 - ad_delivery
    -- Description: Ad impression/click/conversion tracking with user-level attribution
    -- Business Case: Provides closed-loop measurement for advertisers while enabling real-time
    -- bid optimization through conversion probability modeling and frequency capping enforcement.
    -- Supports multi-touch attribution and cross-device tracking.
    -- Feature Reference: AD05 (Delivery Tracking), ATT01 (Attribution), OPT02 (Real-time Optimization)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.ad_delivery (
        delivery_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Delivery identification
        campaign_id UUID NOT NULL,
        creative_id UUID NOT NULL,
        placement_id UUID NOT NULL,
        user_id UUID,

        -- Event type and timing
        event_type VARCHAR(20) NOT NULL CHECK (
            event_type IN ('IMPRESSION', 'CLICK', 'CONVERSION', 'VIEWABILITY', 'COMPLETION')
        ),
        event_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        
        -- Use explicit columns instead of generated columns for date/hour
        event_date DATE,
        event_hour INTEGER,

        -- User and device context
        device_type VARCHAR(50) CHECK (
            device_type IN ('DESKTOP', 'MOBILE', 'TABLET', 'TV', 'UNKNOWN')
        ),
        device_os VARCHAR(50),
        browser VARCHAR(100),
        user_agent TEXT,
        ip_address INET,

        -- Geographic context
        country_code VARCHAR(3),
        region VARCHAR(100),
        city VARCHAR(100),
        postal_code VARCHAR(20),
        latitude NUMERIC(10,7),
        longitude NUMERIC(10,7),

        -- Attribution and conversion
        conversion_type VARCHAR(50),
        conversion_value NUMERIC(10,2) CHECK (conversion_value >= 0),
        attribution_model VARCHAR(50) DEFAULT 'LAST_CLICK' CHECK (
            attribution_model IN ('FIRST_CLICK', 'LAST_CLICK', 'LINEAR', 'TIME_DECAY', 'POSITION_BASED')
        ),
        attribution_weight NUMERIC(5,2) DEFAULT 100.0 CHECK (attribution_weight >= 0 AND attribution_weight <= 100),

        -- Campaign and creative details
        bid_amount NUMERIC(10,4) CHECK (bid_amount >= 0),
        win_price NUMERIC(10,4) CHECK (win_price >= 0),
        auction_type VARCHAR(20),
        auction_id VARCHAR(100),

        -- Performance metrics
        viewability_percentage NUMERIC(5,2) CHECK (viewability_percentage >= 0 AND viewability_percentage <= 100),
        video_completion_rate NUMERIC(5,2) CHECK (video_completion_rate >= 0 AND video_completion_rate <= 100),
        time_to_click_seconds NUMERIC(10,3) CHECK (time_to_click_seconds >= 0),
        time_to_conversion_seconds NUMERIC(10,3) CHECK (time_to_conversion_seconds >= 0),

        -- Frequency capping
        user_frequency_count INTEGER DEFAULT 1 CHECK (user_frequency_count >= 0),
        campaign_frequency_count INTEGER DEFAULT 1 CHECK (campaign_frequency_count >= 0),

        -- Fraud detection
        fraud_score NUMERIC(5,2) DEFAULT 0.0 CHECK (fraud_score >= 0 AND fraud_score <= 100),
        fraud_indications VARCHAR(100)[] DEFAULT '{}',
        is_suspicious BOOLEAN DEFAULT FALSE,

        -- Delivery status
        delivery_status VARCHAR(20) DEFAULT 'DELIVERED' CHECK (
            delivery_status IN ('DELIVERED', 'VIEWABLE', 'CLICKED', 'CONVERTED', 'INVALID', 'FILTERED')
        ),
        invalid_reason VARCHAR(200),

        -- Session and journey
        session_id VARCHAR(100),
        journey_id VARCHAR(100),
        referrer_url VARCHAR(500),
        landing_page_url VARCHAR(500),

        -- Custom tracking
        custom_parameters JSONB DEFAULT '{}',
        utm_parameters JSONB DEFAULT '{}',
        tracking_parameters JSONB DEFAULT '{}',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_ad_delivery_campaign FOREIGN KEY (campaign_id)
            REFERENCES socialcandor_schema.ad_campaigns(campaign_id) ON DELETE CASCADE,
        CONSTRAINT fk_ad_delivery_creative FOREIGN KEY (creative_id)
            REFERENCES socialcandor_schema.ad_creatives(creative_id) ON DELETE CASCADE,
        CONSTRAINT fk_ad_delivery_placement FOREIGN KEY (placement_id)
            REFERENCES socialcandor_schema.ad_placements(placement_id) ON DELETE CASCADE,
        CONSTRAINT fk_ad_delivery_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_conversion_value CHECK (
            (event_type = 'CONVERSION' AND conversion_value IS NOT NULL) OR
            (event_type != 'CONVERSION' AND conversion_value IS NULL)
        ),
        CONSTRAINT chk_viewability_range CHECK (
            (event_type = 'VIEWABILITY' AND viewability_percentage IS NOT NULL) OR
            (event_type != 'VIEWABILITY' AND viewability_percentage IS NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.ad_delivery IS 'Ad impression/click/conversion tracking with user-level attribution and fraud detection';
    COMMENT ON COLUMN socialcandor_schema.ad_delivery.fraud_score IS 'AI-generated score indicating likelihood of fraudulent activity';

    -- Create trigger function to populate event_date and event_hour
    CREATE OR REPLACE FUNCTION socialcandor_schema.set_ad_delivery_date_hour()
    RETURNS TRIGGER AS $$
    BEGIN
        -- Use UTC timezone for consistent date/hour extraction
        NEW.event_date := DATE(NEW.event_timestamp AT TIME ZONE 'UTC');
        NEW.event_hour := EXTRACT(HOUR FROM NEW.event_timestamp AT TIME ZONE 'UTC');
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Trigger to set event_date and event_hour before insert or update
    CREATE TRIGGER trg_set_ad_delivery_date_hour
        BEFORE INSERT OR UPDATE ON socialcandor_schema.ad_delivery
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.set_ad_delivery_date_hour();

    -- Indexes for ad_delivery
    CREATE INDEX IF NOT EXISTS idx_ad_delivery_campaign ON socialcandor_schema.ad_delivery(campaign_id);
    CREATE INDEX IF NOT EXISTS idx_ad_delivery_creative ON socialcandor_schema.ad_delivery(creative_id);
    CREATE INDEX IF NOT EXISTS idx_ad_delivery_user ON socialcandor_schema.ad_delivery(user_id) WHERE user_id IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_ad_delivery_event_type ON socialcandor_schema.ad_delivery(event_type);
    CREATE INDEX IF NOT EXISTS idx_ad_delivery_timestamp ON socialcandor_schema.ad_delivery(event_timestamp DESC);
    CREATE INDEX IF NOT EXISTS idx_ad_delivery_date ON socialcandor_schema.ad_delivery(event_date);
    CREATE INDEX IF NOT EXISTS idx_ad_delivery_country ON socialcandor_schema.ad_delivery(country_code);
    CREATE INDEX IF NOT EXISTS idx_ad_delivery_conversion ON socialcandor_schema.ad_delivery(event_type) WHERE event_type = 'CONVERSION';

    -- Time-series partitioning index for performance
    CREATE INDEX IF NOT EXISTS idx_ad_delivery_time_series ON socialcandor_schema.ad_delivery(event_date, event_hour, event_type);

    -- Trigger for updated_at
    CREATE TRIGGER trg_ad_delivery_updated_at
        BEFORE UPDATE ON socialcandor_schema.ad_delivery
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    -- Materialized view for campaign performance by day
    CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_campaign_performance_daily AS
    SELECT
        campaign_id,
        event_date,
        COUNT(*) FILTER (WHERE event_type = 'IMPRESSION') as impressions,
        COUNT(*) FILTER (WHERE event_type = 'CLICK') as clicks,
        COUNT(*) FILTER (WHERE event_type = 'CONVERSION') as conversions,
        SUM(conversion_value) FILTER (WHERE event_type = 'CONVERSION') as conversion_value_total,
        SUM(win_price) FILTER (WHERE event_type = 'IMPRESSION') as spend,
        CASE
            WHEN COUNT(*) FILTER (WHERE event_type = 'IMPRESSION') > 0
            THEN ROUND(
                COUNT(*) FILTER (WHERE event_type = 'CLICK')::NUMERIC /
                COUNT(*) FILTER (WHERE event_type = 'IMPRESSION') * 100, 2
            )
            ELSE 0
        END as ctr,
        CASE
            WHEN COUNT(*) FILTER (WHERE event_type = 'CLICK') > 0
            THEN ROUND(
                COUNT(*) FILTER (WHERE event_type = 'CONVERSION')::NUMERIC /
                COUNT(*) FILTER (WHERE event_type = 'CLICK') * 100, 2
            )
            ELSE 0
        END as conversion_rate,
        AVG(viewability_percentage) FILTER (WHERE event_type = 'IMPRESSION') as avg_viewability,
        AVG(fraud_score) as avg_fraud_score
    FROM socialcandor_schema.ad_delivery
    WHERE event_date >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY campaign_id, event_date
    WITH DATA;

    CREATE UNIQUE INDEX idx_mv_campaign_performance_daily ON socialcandor_schema.mv_campaign_performance_daily(campaign_id, event_date);
    CREATE INDEX idx_mv_campaign_performance_spend ON socialcandor_schema.mv_campaign_performance_daily(spend DESC);
    CREATE INDEX idx_mv_campaign_performance_ctr ON socialcandor_schema.mv_campaign_performance_daily(ctr DESC);

    ------------------------------------------------------------------------------------------------
    -- Table: 57 - community_guidelines
    -- Description: Versioned community standards with severity levels and category taxonomy
    -- Business Case: Creates transparent enforcement framework while enabling guideline-specific
    -- training for human moderators and AI model fine-tuning for policy violations.
    -- Supports multi-jurisdictional compliance with localized guideline versions.
    -- Feature Reference: MOD05 (Community Guidelines), COMP05 (Policy Management), TRAIN01 (Training)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.community_guidelines (
        guideline_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Guideline identification
        guideline_code VARCHAR(50) UNIQUE NOT NULL,
        guideline_title VARCHAR(200) NOT NULL,
        guideline_version VARCHAR(20) NOT NULL,
        is_current_version BOOLEAN DEFAULT TRUE,

        -- Classification and taxonomy
        category VARCHAR(100) NOT NULL,
        subcategory VARCHAR(100),
        guideline_type VARCHAR(50) NOT NULL DEFAULT 'CONTENT' CHECK (
            guideline_type IN ('CONTENT', 'BEHAVIOR', 'SAFETY', 'LEGAL', 'COMMERCIAL', 'ACCESSIBILITY')
        ),
        tags VARCHAR(100)[] DEFAULT '{}',

        -- Severity and enforcement
        severity_level socialcandor_schema.moderation_severity NOT NULL DEFAULT 'MEDIUM',
        enforcement_action VARCHAR(100) NOT NULL,
        minimum_penalty_days INTEGER DEFAULT 0 CHECK (minimum_penalty_days >= 0),
        maximum_penalty_days INTEGER CHECK (maximum_penalty_days >= 0),

        -- Guideline content
        guideline_text TEXT NOT NULL,
        explanation TEXT,
        examples JSONB DEFAULT '[]',
        non_examples JSONB DEFAULT '[]',

        -- Legal and compliance
        legal_reference VARCHAR(500),
        jurisdiction VARCHAR(3)[] DEFAULT '{}',
        compliance_standard VARCHAR(100)[] DEFAULT '{}',
        requires_age_verification BOOLEAN DEFAULT FALSE,

        -- Moderation guidance
        moderation_guidance TEXT,
        escalation_path VARCHAR(200),
        appeal_process TEXT,

        -- AI/ML integration
        ai_detection_model VARCHAR(100),
        ai_confidence_threshold NUMERIC(5,2) DEFAULT 70.0 CHECK (ai_confidence_threshold >= 0 AND ai_confidence_threshold <= 100),
        training_data_version VARCHAR(20),

        -- Versioning and updates
        previous_version_id UUID,
        version_notes TEXT,
        effective_from TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        effective_until TIMESTAMP WITH TIME ZONE,

        -- Statistics and metrics
        violation_count INTEGER DEFAULT 0 CHECK (violation_count >= 0),
        appeal_count INTEGER DEFAULT 0 CHECK (appeal_count >= 0),
        appeal_success_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (appeal_success_rate >= 0 AND appeal_success_rate <= 100),
        last_violation_at TIMESTAMP WITH TIME ZONE,

        -- Localization
        language_code VARCHAR(10) DEFAULT 'en',
        localized_versions UUID[] DEFAULT '{}',

        -- Status and lifecycle
        is_active BOOLEAN DEFAULT TRUE,
        is_public BOOLEAN DEFAULT TRUE,
        publication_status VARCHAR(20) DEFAULT 'DRAFT' CHECK (
            publication_status IN ('DRAFT', 'PUBLISHED', 'ARCHIVED', 'DEPRECATED')
        ),
        published_at TIMESTAMP WITH TIME ZONE,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_community_guidelines_previous FOREIGN KEY (previous_version_id)
            REFERENCES socialcandor_schema.community_guidelines(guideline_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT uk_guideline_version UNIQUE (guideline_code, guideline_version),
        CONSTRAINT chk_penalty_range CHECK (
            (maximum_penalty_days IS NULL) OR
            (maximum_penalty_days >= minimum_penalty_days)
        ),
        CONSTRAINT chk_effective_dates CHECK (
            (effective_until IS NULL) OR
            (effective_until > effective_from)
        )
    );

    COMMENT ON TABLE socialcandor_schema.community_guidelines IS 'Versioned community standards with severity levels, enforcement actions, and AI integration';
    COMMENT ON COLUMN socialcandor_schema.community_guidelines.examples IS 'JSON array of positive and negative examples for moderator training';

    -- Indexes for community_guidelines
    CREATE INDEX IF NOT EXISTS idx_community_guidelines_code ON socialcandor_schema.community_guidelines(guideline_code);
    CREATE INDEX IF NOT EXISTS idx_community_guidelines_category ON socialcandor_schema.community_guidelines(category);
    CREATE INDEX IF NOT EXISTS idx_community_guidelines_severity ON socialcandor_schema.community_guidelines(severity_level);
    CREATE INDEX IF NOT EXISTS idx_community_guidelines_current ON socialcandor_schema.community_guidelines(is_current_version) WHERE is_current_version = TRUE;
    CREATE INDEX IF NOT EXISTS idx_community_guidelines_active ON socialcandor_schema.community_guidelines(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_community_guidelines_effective ON socialcandor_schema.community_guidelines(effective_from, effective_until);
    CREATE INDEX IF NOT EXISTS idx_community_guidelines_created ON socialcandor_schema.community_guidelines(created_at DESC);

    -- Full-text search for guideline content
    CREATE INDEX IF NOT EXISTS idx_community_guidelines_search ON socialcandor_schema.community_guidelines
    USING gin(to_tsvector('english', guideline_title || ' ' || guideline_text || ' ' || COALESCE(explanation, '')));

    -- Trigger for updated_at
    CREATE TRIGGER trg_community_guidelines_updated_at
        BEFORE UPDATE ON socialcandor_schema.community_guidelines
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    -- Function to maintain current version flag
    CREATE OR REPLACE FUNCTION socialcandor_schema.maintain_guideline_current_version()
    RETURNS TRIGGER AS $$
    BEGIN
        -- If this is marked as current, ensure no other versions are current for same code
        IF NEW.is_current_version = TRUE AND TG_OP = 'INSERT' THEN
            UPDATE socialcandor_schema.community_guidelines
            SET is_current_version = FALSE
            WHERE guideline_code = NEW.guideline_code
            AND guideline_id != NEW.guideline_id;
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_maintain_guideline_current_version
        AFTER INSERT OR UPDATE OF is_current_version ON socialcandor_schema.community_guidelines
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.maintain_guideline_current_version();

    ------------------------------------------------------------------------------------------------
    -- Table: 58 - moderator_actions
    -- Description: Immutable log of all moderation decisions with guideline references
    -- Business Case: Provides audit trail for appeals processes while enabling moderator
    -- performance analytics (accuracy, speed) and bias detection through action pattern analysis.
    -- Supports quality assurance and training through decision pattern analysis.
    -- Feature Reference: MOD06 (Action Logging), AUD03 (Moderation Audit), QA01 (Quality Assurance)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.moderator_actions (
        action_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Action identification
        moderator_user_id UUID NOT NULL,
        content_id UUID NOT NULL,
        content_type socialcandor_schema.content_type NOT NULL,

        -- Decision details
        action_type VARCHAR(50) NOT NULL CHECK (
            action_type IN ('APPROVE', 'REJECT', 'DELETE', 'ESCALATE', 'WARN', 'SUSPEND', 'BAN', 'EDIT')
        ),
        decision VARCHAR(20) NOT NULL CHECK (
            decision IN ('ALLOW', 'REMOVE', 'ESCALATE', 'NO_ACTION')
        ),
        decision_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

        -- Guideline references
        guideline_id UUID NOT NULL,
        guideline_violations VARCHAR(100)[] NOT NULL,
        guideline_severity socialcandor_schema.moderation_severity NOT NULL,

        -- Context and evidence
        content_snapshot JSONB,
        user_context JSONB DEFAULT '{}',
        additional_evidence JSONB DEFAULT '{}',

        -- AI integration
        ai_recommendation VARCHAR(20),
        ai_confidence NUMERIC(5,2) CHECK (ai_confidence >= 0 AND ai_confidence <= 100),
        human_override_reason VARCHAR(200),

        -- Moderation workflow
        queue_type VARCHAR(50) DEFAULT 'STANDARD' CHECK (
            queue_type IN ('STANDARD', 'PRIORITY', 'APPEAL', 'ESCALATED')
        ),
        time_in_queue_seconds INTEGER CHECK (time_in_queue_seconds >= 0),
        review_duration_seconds INTEGER CHECK (review_duration_seconds >= 0),

        -- Appeal tracking
        appeal_status VARCHAR(20) DEFAULT 'NONE' CHECK (
            appeal_status IN ('NONE', 'PENDING', 'GRANTED', 'DENIED', 'WITHDRAWN')
        ),
        appeal_id UUID,
        appeal_outcome VARCHAR(20),

        -- Quality assurance
        qa_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
            qa_status IN ('PENDING', 'PASSED', 'FAILED', 'DISPUTED')
        ),
        qa_reviewer_id UUID,
        qa_score NUMERIC(5,2) CHECK (qa_score >= 0 AND qa_score <= 100),
        qa_notes TEXT,

        -- Performance metrics
        decision_confidence NUMERIC(5,2) DEFAULT 100.0 CHECK (decision_confidence >= 0 AND decision_confidence <= 100),
        decision_complexity VARCHAR(20) DEFAULT 'STANDARD' CHECK (
            decision_complexity IN ('SIMPLE', 'STANDARD', 'COMPLEX', 'VERY_COMPLEX')
        ),

        -- System context
        moderation_tool_version VARCHAR(20),
        ip_address INET,
        user_agent TEXT,

        -- Audit and metadata (immutable)
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,

        -- Foreign key constraints
        CONSTRAINT fk_moderator_actions_moderator FOREIGN KEY (moderator_user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE RESTRICT,
        CONSTRAINT fk_moderator_actions_guideline FOREIGN KEY (guideline_id)
            REFERENCES socialcandor_schema.community_guidelines(guideline_id) ON DELETE RESTRICT,
        CONSTRAINT fk_moderator_actions_qa_reviewer FOREIGN KEY (qa_reviewer_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

        -- Constraints (no updated_at for immutability)
        CONSTRAINT chk_review_duration CHECK (review_duration_seconds >= 0),
        CONSTRAINT chk_decision_confidence CHECK (decision_confidence >= 0 AND decision_confidence <= 100)
    );

    COMMENT ON TABLE socialcandor_schema.moderator_actions IS 'Immutable log of all moderation decisions with guideline references and quality assurance';
    COMMENT ON COLUMN socialcandor_schema.moderator_actions.content_snapshot IS 'Snapshot of content at time of moderation for audit purposes';

    -- Indexes for moderator_actions
    CREATE INDEX IF NOT EXISTS idx_moderator_actions_moderator ON socialcandor_schema.moderator_actions(moderator_user_id);
    CREATE INDEX IF NOT EXISTS idx_moderator_actions_content ON socialcandor_schema.moderator_actions(content_id, content_type);
    CREATE INDEX IF NOT EXISTS idx_moderator_actions_decision ON socialcandor_schema.moderator_actions(decision);
    CREATE INDEX IF NOT EXISTS idx_moderator_actions_timestamp ON socialcandor_schema.moderator_actions(decision_timestamp DESC);
    CREATE INDEX IF NOT EXISTS idx_moderator_actions_guideline ON socialcandor_schema.moderator_actions(guideline_id);
    CREATE INDEX IF NOT EXISTS idx_moderator_actions_appeal ON socialcandor_schema.moderator_actions(appeal_status) WHERE appeal_status != 'NONE';
    CREATE INDEX IF NOT EXISTS idx_moderator_actions_qa ON socialcandor_schema.moderator_actions(qa_status) WHERE qa_status != 'PENDING';

--  -- Time-series index for performance analytics
-- CREATE INDEX IF NOT EXISTS idx_moderator_actions_date_hour 
-- ON socialcandor_schema.moderator_actions(
--     (decision_timestamp::DATE),  -- Cast to date first
--     EXTRACT(HOUR FROM decision_timestamp),
--     moderator_user_id,
--     decision
-- );

-- -- First, add a generated column
-- ALTER TABLE socialcandor_schema.moderator_actions 
-- ADD COLUMN IF NOT EXISTS decision_hour timestamp 
-- GENERATED ALWAYS AS (date_trunc('hour', decision_timestamp)) STORED;

-- -- Then create index on the generated column
-- CREATE INDEX IF NOT EXISTS idx_moderator_actions_date_hour 
-- ON socialcandor_schema.moderator_actions(
--     decision_hour,
--     moderator_user_id,
--     decision
-- );

    -- Function to prevent updates (immutability)
    CREATE OR REPLACE FUNCTION socialcandor_schema.prevent_moderator_action_updates()
    RETURNS TRIGGER AS $$
    BEGIN
        IF TG_OP = 'UPDATE' THEN
            RAISE EXCEPTION 'Moderator actions are immutable and cannot be updated';
        END IF;
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_prevent_moderator_action_updates
        BEFORE UPDATE ON socialcandor_schema.moderator_actions
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.prevent_moderator_action_updates();

    -- Create a B-tree index on the timestamp itself
CREATE INDEX IF NOT EXISTS idx_moderator_actions_timestampone 
ON socialcandor_schema.moderator_actions(decision_timestamp);

-- Create composite index for your common queries
CREATE INDEX IF NOT EXISTS idx_moderator_actions_compositeone
ON socialcandor_schema.moderator_actions(
    moderator_user_id,
    decision,
    decision_timestamp
);
	
	
	------------------------------------------------------------------------------------------------
    -- Table: 59 - user_moderation_status
    -- Description: User-level moderation state tracking with warning counters and restrictions
    -- Business Case: Enables progressive discipline workflows while preventing banned users
    -- from creating new accounts through device fingerprinting correlation. Supports
    -- temporary restrictions, shadow banning, and rehabilitation tracking.
    -- Feature Reference: MOD07 (User Moderation), SEC07 (Account Security), WF02 (Progressive Discipline)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.user_moderation_status (
        user_id UUID PRIMARY KEY,

        -- Warning and strike system
        warning_count INTEGER DEFAULT 0 CHECK (warning_count >= 0),
        strike_count INTEGER DEFAULT 0 CHECK (strike_count >= 0),
        last_warning_at TIMESTAMP WITH TIME ZONE,
        last_strike_at TIMESTAMP WITH TIME ZONE,

        -- Current restrictions
        restriction_level VARCHAR(20) DEFAULT 'NONE' CHECK (
            restriction_level IN ('NONE', 'LIMITED', 'RESTRICTED', 'SEVERE', 'COMPLETE')
        ),
        restriction_reason TEXT,
        restriction_applied_at TIMESTAMP WITH TIME ZONE,
        restriction_expires_at TIMESTAMP WITH TIME ZONE,

        -- Shadow banning
        is_shadow_banned BOOLEAN DEFAULT FALSE,
        shadow_ban_applied_at TIMESTAMP WITH TIME ZONE,
        shadow_ban_expires_at TIMESTAMP WITH TIME ZONE,
        shadow_ban_reason TEXT,

        -- Content limitations
        daily_post_limit INTEGER DEFAULT 100 CHECK (daily_post_limit >= 0),
        daily_comment_limit INTEGER DEFAULT 500 CHECK (daily_comment_limit >= 0),
        daily_message_limit INTEGER DEFAULT 50 CHECK (daily_message_limit >= 0),

        -- Feature restrictions
        restricted_features VARCHAR(50)[] DEFAULT '{}',
        allowed_features VARCHAR(50)[] DEFAULT '{}',

        -- Moderation history
        total_moderated_content INTEGER DEFAULT 0 CHECK (total_moderated_content >= 0),
        total_removed_content INTEGER DEFAULT 0 CHECK (total_removed_content >= 0),
        last_moderation_action_at TIMESTAMP WITH TIME ZONE,

        -- Appeal status
        pending_appeal_count INTEGER DEFAULT 0 CHECK (pending_appeal_count >= 0),
        successful_appeal_count INTEGER DEFAULT 0 CHECK (successful_appeal_count >= 0),
        last_appeal_at TIMESTAMP WITH TIME ZONE,

        -- Rehabilitation tracking
        rehabilitation_status VARCHAR(20) DEFAULT 'NOT_REQUIRED' CHECK (
            rehabilitation_status IN ('NOT_REQUIRED', 'IN_PROGRESS', 'COMPLETED', 'FAILED')
        ),
        rehabilitation_started_at TIMESTAMP WITH TIME ZONE,
        rehabilitation_completed_at TIMESTAMP WITH TIME ZONE,
        rehabilitation_progress NUMERIC(5,2) DEFAULT 0.0 CHECK (rehabilitation_progress >= 0 AND rehabilitation_progress <= 100),

        -- Trust and reputation
        trust_score_modifier NUMERIC(5,2) DEFAULT 0.0 CHECK (trust_score_modifier >= -100 AND trust_score_modifier <= 100),
        reputation_penalty NUMERIC(5,2) DEFAULT 0.0 CHECK (reputation_penalty >= 0 AND reputation_penalty <= 100),

        -- Device correlation
        correlated_device_count INTEGER DEFAULT 0 CHECK (correlated_device_count >= 0),
        correlated_accounts UUID[] DEFAULT '{}',

        -- Monitoring settings
        is_under_increased_monitoring BOOLEAN DEFAULT FALSE,
        monitoring_level VARCHAR(20) DEFAULT 'STANDARD' CHECK (
            monitoring_level IN ('STANDARD', 'INCREASED', 'HIGH', 'MAXIMUM')
        ),
        monitoring_expires_at TIMESTAMP WITH TIME ZONE,

        -- Compliance tracking
        acknowledged_guidelines UUID[] DEFAULT '{}',
        last_guideline_acknowledgment TIMESTAMP WITH TIME ZONE,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_user_moderation_status_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT chk_restriction_dates CHECK (
            (restriction_expires_at IS NULL) OR
            (restriction_expires_at > restriction_applied_at)
        ),
        CONSTRAINT chk_shadow_ban_dates CHECK (
            (shadow_ban_expires_at IS NULL) OR
            (shadow_ban_expires_at > shadow_ban_applied_at)
        ),
        CONSTRAINT chk_strikes_warnings CHECK (strike_count <= warning_count)
    );

    COMMENT ON TABLE socialcandor_schema.user_moderation_status IS 'User-level moderation state tracking with warnings, restrictions, and rehabilitation';
    COMMENT ON COLUMN socialcandor_schema.user_moderation_status.correlated_accounts IS 'Array of account IDs suspected to belong to same user';

    -- Indexes for user_moderation_status
    CREATE INDEX IF NOT EXISTS idx_user_moderation_status_user ON socialcandor_schema.user_moderation_status(user_id);
    CREATE INDEX IF NOT EXISTS idx_user_moderation_status_restriction ON socialcandor_schema.user_moderation_status(restriction_level);
    CREATE INDEX IF NOT EXISTS idx_user_moderation_status_shadow_ban ON socialcandor_schema.user_moderation_status(is_shadow_banned) WHERE is_shadow_banned = TRUE;
    CREATE INDEX IF NOT EXISTS idx_user_moderation_status_expires ON socialcandor_schema.user_moderation_status(restriction_expires_at) WHERE restriction_expires_at IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_user_moderation_status_warnings ON socialcandor_schema.user_moderation_status(warning_count DESC);
    CREATE INDEX IF NOT EXISTS idx_user_moderation_status_monitoring ON socialcandor_schema.user_moderation_status(is_under_increased_monitoring) WHERE is_under_increased_monitoring = TRUE;

    -- Trigger for updated_at
    CREATE TRIGGER trg_user_moderation_status_updated_at
        BEFORE UPDATE ON socialcandor_schema.user_moderation_status
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    -- Function to handle restriction expiration
    CREATE OR REPLACE FUNCTION socialcandor_schema.handle_restriction_expiration()
    RETURNS TRIGGER AS $$
    BEGIN
        -- Check for expired restrictions
        IF NEW.restriction_expires_at IS NOT NULL AND NEW.restriction_expires_at <= CURRENT_TIMESTAMP THEN
            NEW.restriction_level := 'NONE';
            NEW.restriction_reason := NULL;
            NEW.restriction_expires_at := NULL;
        END IF;

        -- Check for expired shadow bans
        IF NEW.shadow_ban_expires_at IS NOT NULL AND NEW.shadow_ban_expires_at <= CURRENT_TIMESTAMP THEN
            NEW.is_shadow_banned := FALSE;
            NEW.shadow_ban_reason := NULL;
            NEW.shadow_ban_expires_at := NULL;
        END IF;

        -- Check for expired monitoring
        IF NEW.monitoring_expires_at IS NOT NULL AND NEW.monitoring_expires_at <= CURRENT_TIMESTAMP THEN
            NEW.is_under_increased_monitoring := FALSE;
            NEW.monitoring_level := 'STANDARD';
            NEW.monitoring_expires_at := NULL;
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_handle_restriction_expiration
        BEFORE INSERT OR UPDATE ON socialcandor_schema.user_moderation_status
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.handle_restriction_expiration();

    ------------------------------------------------------------------------------------------------
    -- Table: 60 - dashboard_widgets
    -- Description: Configurable analytics dashboard components with refresh intervals
    -- Business Case: Enables personalized executive dashboards while supporting data freshness
    -- SLAs through intelligent refresh scheduling based on widget criticality. Supports
    -- widget templating and sharing across users and roles.
    -- Feature Reference: DASH01 (Dashboard Widgets), VIZ01 (Visualization), PERF05 (Refresh Optimization)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.dashboard_widgets (
        widget_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Widget identification
        widget_name VARCHAR(200) NOT NULL,
        widget_code VARCHAR(100) UNIQUE NOT NULL,
        widget_description TEXT,

        -- Widget classification
        widget_type VARCHAR(50) NOT NULL CHECK (
            widget_type IN ('CHART', 'TABLE', 'METRIC', 'LIST', 'MAP', 'HEATMAP', 'TIMELINE', 'CUSTOM')
        ),
        widget_category VARCHAR(100),
        widget_subcategory VARCHAR(100),
        tags VARCHAR(100)[] DEFAULT '{}',

        -- Data source configuration
        data_source_type VARCHAR(50) NOT NULL CHECK (
            data_source_type IN ('SQL', 'API', 'MATERIALIZED_VIEW', 'EXTERNAL', 'COMPOSITE')
        ),
        data_source_config JSONB NOT NULL,
        data_refresh_frequency VARCHAR(20) DEFAULT 'HOURLY' CHECK (
            data_refresh_frequency IN ('REALTIME', 'HOURLY', 'DAILY', 'WEEKLY', 'MONTHLY', 'MANUAL')
        ),
        refresh_priority VARCHAR(20) DEFAULT 'MEDIUM' CHECK (
            refresh_priority IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')
        ),

        -- Visualization configuration
        visualization_config JSONB NOT NULL,
        chart_type VARCHAR(50) CHECK (
            chart_type IN ('LINE', 'BAR', 'PIE', 'SCATTER', 'AREA', 'HEATMAP', 'GAUGE', 'FUNNEL')
        ),
        color_scheme VARCHAR(50) DEFAULT 'DEFAULT',

        -- Performance optimization
        cache_enabled BOOLEAN DEFAULT TRUE,
        cache_ttl_seconds INTEGER DEFAULT 300 CHECK (cache_ttl_seconds >= 0),
        query_timeout_seconds INTEGER DEFAULT 30 CHECK (query_timeout_seconds >= 0),
        max_data_points INTEGER DEFAULT 1000 CHECK (max_data_points >= 0),

        -- Security and permissions
        visibility VARCHAR(20) DEFAULT 'PUBLIC' CHECK (
            visibility IN ('PUBLIC', 'PRIVATE', 'ROLE_BASED', 'USER_SPECIFIC')
        ),
        allowed_roles VARCHAR(50)[] DEFAULT '{}',
        minimum_permission_level VARCHAR(50) DEFAULT 'VIEW',

        -- Usage tracking
        usage_count INTEGER DEFAULT 0 CHECK (usage_count >= 0),
        last_used_at TIMESTAMP WITH TIME ZONE,
        average_load_time_ms INTEGER,
        error_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (error_rate >= 0 AND error_rate <= 100),

        -- Quality metrics
        data_freshness_score NUMERIC(5,2) DEFAULT 100.0 CHECK (data_freshness_score >= 0 AND data_freshness_score <= 100),
        data_accuracy_score NUMERIC(5,2) DEFAULT 100.0 CHECK (data_accuracy_score >= 0 AND data_accuracy_score <= 100),
        user_satisfaction_score NUMERIC(5,2) DEFAULT 0.0 CHECK (user_satisfaction_score >= 0 AND user_satisfaction_score <= 100),

        -- Versioning
        widget_version INTEGER DEFAULT 1,
        previous_version_id UUID,
        version_notes TEXT,

        -- Status and lifecycle
        is_active BOOLEAN DEFAULT TRUE,
        is_template BOOLEAN DEFAULT FALSE,
        template_of UUID,
        publication_status VARCHAR(20) DEFAULT 'DRAFT' CHECK (
            publication_status IN ('DRAFT', 'PUBLISHED', 'DEPRECATED', 'ARCHIVED')
        ),
        published_at TIMESTAMP WITH TIME ZONE,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_dashboard_widgets_template FOREIGN KEY (template_of)
            REFERENCES socialcandor_schema.dashboard_widgets(widget_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_data_source_config CHECK (jsonb_typeof(data_source_config) = 'object'),
        CONSTRAINT chk_visualization_config CHECK (jsonb_typeof(visualization_config) = 'object'),
        CONSTRAINT chk_template_consistency CHECK (
            (is_template = FALSE AND template_of IS NULL) OR
            (is_template = TRUE AND template_of IS NULL) OR
            (is_template = FALSE AND template_of IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.dashboard_widgets IS 'Configurable analytics dashboard components with refresh intervals and performance optimization';
    COMMENT ON COLUMN socialcandor_schema.dashboard_widgets.data_freshness_score IS 'Score indicating how current the widget data is (0-100)';

    -- Indexes for dashboard_widgets
    CREATE INDEX IF NOT EXISTS idx_dashboard_widgets_code ON socialcandor_schema.dashboard_widgets(widget_code);
    CREATE INDEX IF NOT EXISTS idx_dashboard_widgets_type ON socialcandor_schema.dashboard_widgets(widget_type);
    CREATE INDEX IF NOT EXISTS idx_dashboard_widgets_category ON socialcandor_schema.dashboard_widgets(widget_category);
    CREATE INDEX IF NOT EXISTS idx_dashboard_widgets_active ON socialcandor_schema.dashboard_widgets(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_dashboard_widgets_template ON socialcandor_schema.dashboard_widgets(is_template) WHERE is_template = TRUE;
    CREATE INDEX IF NOT EXISTS idx_dashboard_widgets_created ON socialcandor_schema.dashboard_widgets(created_at DESC);

    -- GIN index for tags and configuration
    CREATE INDEX IF NOT EXISTS idx_dashboard_widgets_tags ON socialcandor_schema.dashboard_widgets USING gin(tags);
    CREATE INDEX IF NOT EXISTS idx_dashboard_widgets_config ON socialcandor_schema.dashboard_widgets USING gin(data_source_config);

    -- Trigger for updated_at
    CREATE TRIGGER trg_dashboard_widgets_updated_at
        BEFORE UPDATE ON socialcandor_schema.dashboard_widgets
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();





-- =============================================================================
-- Purpose: Provides a two-tier dashboard system with base templates for 
--          consistency and user-specific configurations for personalization.
-- Business Value: Enables standardized dashboard templates across roles 
--                 while allowing individual customization and sharing.
-- Features Supported: DASH01, DASH02, PER06, COLLAB01
-- =============================================================================
-- =============================================================================
-- DASHBOARDS MODULE - BASE TEMPLATES & USER-SPECIFIC CONFIGURATIONS
-- =============================================================================
-- Purpose: Provides a two-tier dashboard system with base templates for 
--          consistency and user-specific configurations for personalization.
-- Business Value: Enables standardized dashboard templates across roles 
--                 while allowing individual customization and sharing.
-- Features Supported: DASH01, DASH02, PER06, COLLAB01
-- =============================================================================

------------------------------------------------------------------------------------------------
-- Table: 60 - dashboards (BASE TEMPLATES)
-- Description: System-wide dashboard templates and base configurations
-- Business Case: Provides standardized dashboard templates for different roles
--                (executive, analyst, operational) that can be cloned and 
--                customized by individual users. Ensures consistency in 
--                default layouts, visualizations, and business metrics.
-- Feature Reference: DASH01 (Dashboard Templates), PER06 (Personalization)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.dashboards (
    -- Primary Identifier
    dashboard_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    
    -- Basic Dashboard Information
    dashboard_name VARCHAR(200) NOT NULL,
    dashboard_description TEXT,
    
    -- Dashboard Classification
    dashboard_type VARCHAR(50) DEFAULT 'STANDARD' CHECK (
        dashboard_type IN ('STANDARD', 'TEMPLATE', 'SYSTEM')
    ),
    dashboard_category VARCHAR(100),
    tags VARCHAR(100)[] DEFAULT '{}',
    
    -- Base Layout and Configuration
    -- NOTE: User dashboards can override these settings
    base_layout_config JSONB,
    default_theme VARCHAR(50) DEFAULT 'LIGHT' CHECK (default_theme IN ('LIGHT', 'DARK', 'CUSTOM')),
    
    -- Template and System Settings
    is_template BOOLEAN DEFAULT FALSE,
    is_system_dashboard BOOLEAN DEFAULT FALSE,
    
    -- Target Audience and Role Mapping
    -- Defines which roles/departments should see this template by default
    target_roles VARCHAR(50)[] DEFAULT '{}',
    target_departments VARCHAR(100)[] DEFAULT '{}',
    
    -- Status and Lifecycle Management
    is_active BOOLEAN DEFAULT TRUE,
    
    -- Audit Trail and Metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    
    -- Foreign Key Constraints
    CONSTRAINT fk_dashboards_created_by FOREIGN KEY (created_by)
        REFERENCES socialcandor_schema.users(user_id),
    CONSTRAINT fk_dashboards_updated_by FOREIGN KEY (updated_by)
        REFERENCES socialcandor_schema.users(user_id),
    
    -- Business Rules and Constraints
    CONSTRAINT chk_base_layout_config CHECK (
        jsonb_typeof(base_layout_config) = 'object' OR base_layout_config IS NULL
    ),
    CONSTRAINT chk_template_type CHECK (
        (is_template = TRUE AND dashboard_type = 'TEMPLATE') OR
        (is_template = FALSE)
    )
);

-- Indexes for Base Dashboards Table
CREATE INDEX IF NOT EXISTS idx_dashboards_target_roles 
    ON socialcandor_schema.dashboards USING GIN(target_roles);
CREATE INDEX IF NOT EXISTS idx_dashboards_target_departments 
    ON socialcandor_schema.dashboards USING GIN(target_departments);
CREATE INDEX IF NOT EXISTS idx_dashboards_is_template 
    ON socialcandor_schema.dashboards(is_template) WHERE is_template = TRUE;
CREATE INDEX IF NOT EXISTS idx_dashboards_is_active 
    ON socialcandor_schema.dashboards(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_dashboards_dashboard_type 
    ON socialcandor_schema.dashboards(dashboard_type);
COMMENT ON INDEX socialcandor_schema.idx_dashboards_target_roles IS 
    'Enables efficient role-based template filtering';
COMMENT ON INDEX socialcandor_schema.idx_dashboards_is_template IS 
    'Optimizes queries for template dashboards';

------------------------------------------------------------------------------------------------
-- Table: 61 - user_dashboards
-- Description: User-specific dashboard configurations with layout persistence
-- Business Case: Supports role-based dashboard templates (executive vs. analyst views)
--                while enabling dashboard sharing and collaboration for cross-functional 
--                alignment. Provides personalized data visualization with persistent 
--                user preferences.
-- Feature Reference: DASH02 (User Dashboards), PER06 (Personalization), COLLAB01 (Collaboration)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.user_dashboards (
    -- Primary Identifier
    dashboard_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    
    -- User Association
    user_id UUID NOT NULL,
    
    -- Base Dashboard Reference (OPTIONAL: links to base template)
    base_dashboard_id UUID,
    
    -- Dashboard Identification
    dashboard_name VARCHAR(200) NOT NULL,
    dashboard_description TEXT,
    
    -- Dashboard Classification
    dashboard_type VARCHAR(50) DEFAULT 'PERSONAL' CHECK (
        dashboard_type IN ('PERSONAL', 'SHARED', 'TEAM', 'EXECUTIVE', 'ANALYTICS', 'OPERATIONAL')
    ),
    dashboard_category VARCHAR(100),
    tags VARCHAR(100)[] DEFAULT '{}',
    
    -- Layout and Configuration
    layout_config JSONB NOT NULL,
    theme VARCHAR(50) DEFAULT 'LIGHT' CHECK (theme IN ('LIGHT', 'DARK', 'CUSTOM')),
    color_scheme VARCHAR(50),
    
    -- Sharing and Collaboration
    is_shared BOOLEAN DEFAULT FALSE,
    sharing_level VARCHAR(20) DEFAULT 'PRIVATE' CHECK (
        sharing_level IN ('PRIVATE', 'TEAM', 'DEPARTMENT', 'ORGANIZATION', 'PUBLIC')
    ),
    shared_with_users UUID[] DEFAULT '{}',
    shared_with_roles VARCHAR(50)[] DEFAULT '{}',
    can_edit_shared BOOLEAN DEFAULT FALSE,
    
    -- Template and Inheritance
    is_template BOOLEAN DEFAULT FALSE,
    template_id UUID,
    inherited_from UUID,
    
    -- Default Settings
    is_default BOOLEAN DEFAULT FALSE,
    default_for_role VARCHAR(50),
    
    -- Performance Settings
    auto_refresh_enabled BOOLEAN DEFAULT TRUE,
    refresh_interval_seconds INTEGER DEFAULT 300 CHECK (refresh_interval_seconds >= 0),
    collapse_empty_sections BOOLEAN DEFAULT TRUE,
    
    -- Usage Tracking
    view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
    last_viewed_at TIMESTAMP WITH TIME ZONE,
    average_session_duration_seconds INTEGER,
    favorite_count INTEGER DEFAULT 0 CHECK (favorite_count >= 0),
    
    -- Widget Statistics
    widget_count INTEGER DEFAULT 0 CHECK (widget_count >= 0),
    last_widget_update TIMESTAMP WITH TIME ZONE,
    
    -- Status and Lifecycle
    is_active BOOLEAN DEFAULT TRUE,
    is_archived BOOLEAN DEFAULT FALSE,
    archived_at TIMESTAMP WITH TIME ZONE,
    
    -- Audit Trail and Metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    
    -- Foreign Key Constraints
    CONSTRAINT fk_user_dashboards_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_dashboards_base_dashboard FOREIGN KEY (base_dashboard_id)
        REFERENCES socialcandor_schema.dashboards(dashboard_id) ON DELETE SET NULL,
    CONSTRAINT fk_user_dashboards_template FOREIGN KEY (template_id)
        REFERENCES socialcandor_schema.user_dashboards(dashboard_id) ON DELETE SET NULL,
    CONSTRAINT fk_user_dashboards_inherited FOREIGN KEY (inherited_from)
        REFERENCES socialcandor_schema.user_dashboards(dashboard_id) ON DELETE SET NULL,
    CONSTRAINT fk_user_dashboards_created_by FOREIGN KEY (created_by)
        REFERENCES socialcandor_schema.users(user_id),
    CONSTRAINT fk_user_dashboards_updated_by FOREIGN KEY (updated_by)
        REFERENCES socialcandor_schema.users(user_id),
    
    -- Business Rules and Constraints
    CONSTRAINT chk_layout_config CHECK (jsonb_typeof(layout_config) = 'object'),
    CONSTRAINT chk_template_inheritance CHECK (
        (is_template = FALSE AND template_id IS NULL) OR
        (is_template = TRUE AND template_id IS NULL) OR
        (is_template = FALSE AND template_id IS NOT NULL)
    ),
    CONSTRAINT chk_user_or_base_dashboard CHECK (
        (base_dashboard_id IS NULL) OR 
        (base_dashboard_id IS NOT NULL AND template_id IS NULL)
    )
);

-- Create a UNIQUE INDEX instead of a constraint for partial uniqueness
-- This enforces one default dashboard per user
CREATE UNIQUE INDEX IF NOT EXISTS uk_user_default_dashboard 
    ON socialcandor_schema.user_dashboards(user_id) 
    WHERE is_default = TRUE;

-- Indexes for User Dashboards Table
CREATE INDEX IF NOT EXISTS idx_user_dashboards_user_id 
    ON socialcandor_schema.user_dashboards(user_id);
CREATE INDEX IF NOT EXISTS idx_user_dashboards_base_dashboard_id 
    ON socialcandor_schema.user_dashboards(base_dashboard_id);
CREATE INDEX IF NOT EXISTS idx_user_dashboards_shared_with_users 
    ON socialcandor_schema.user_dashboards USING GIN(shared_with_users);
CREATE INDEX IF NOT EXISTS idx_user_dashboards_shared_with_roles 
    ON socialcandor_schema.user_dashboards USING GIN(shared_with_roles);
CREATE INDEX IF NOT EXISTS idx_user_dashboards_tags 
    ON socialcandor_schema.user_dashboards USING GIN(tags);
CREATE INDEX IF NOT EXISTS idx_user_dashboards_is_default 
    ON socialcandor_schema.user_dashboards(is_default) WHERE is_default = TRUE;
CREATE INDEX IF NOT EXISTS idx_user_dashboards_is_active 
    ON socialcandor_schema.user_dashboards(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_user_dashboards_sharing_level 
    ON socialcandor_schema.user_dashboards(sharing_level);
CREATE INDEX IF NOT EXISTS idx_user_dashboards_dashboard_type 
    ON socialcandor_schema.user_dashboards(dashboard_type);
CREATE INDEX IF NOT EXISTS idx_user_dashboards_created_at 
    ON socialcandor_schema.user_dashboards(created_at DESC);

-- Index Comments for Documentation
COMMENT ON INDEX socialcandor_schema.uk_user_default_dashboard IS 
    'Ensures each user has only one default dashboard (partial unique index)';
COMMENT ON INDEX socialcandor_schema.idx_user_dashboards_user_id IS 
    'Optimizes queries for retrieving all dashboards for a specific user';
COMMENT ON INDEX socialcandor_schema.idx_user_dashboards_shared_with_users IS 
    'Enables efficient lookup of dashboards shared with specific users';
COMMENT ON INDEX socialcandor_schema.idx_user_dashboards_shared_with_roles IS 
    'Optimizes role-based dashboard sharing queries';
COMMENT ON INDEX socialcandor_schema.idx_user_dashboards_is_default IS 
    'Quick retrieval of default dashboards per user';

-- =============================================================================
-- RELATIONSHIP DIAGRAM SUMMARY (notes for later on before i forget):
-- =============================================================================
-- dashboards (base templates)
--     â (optional reference)
-- user_dashboards (user-specific instances)
--     â (template inheritance)
-- user_dashboards (user-created templates)
--
-- USAGE PATTERNS:
-- 1. System Admin creates base templates in 'dashboards' table
-- 2. Users clone/instantiate templates into 'user_dashboards'
-- 3. Users can share their dashboards with others
-- 4. Users can create their own templates for team/department use
-- =============================================================================

-- =============================================================================
-- DATABASE TRIGGERS (Recommended for production)
-- =============================================================================
-- Note: These triggers should be created separately in a migrations folder
/*
-- 1. Update timestamp trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_dashboards_updated_at 
    BEFORE UPDATE ON socialcandor_schema.dashboards
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_dashboards_updated_at 
    BEFORE UPDATE ON socialcandor_schema.user_dashboards
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 2. Archive validation trigger
CREATE OR REPLACE FUNCTION prevent_archive_default_dashboard()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.is_archived = TRUE AND NEW.is_default = TRUE THEN
        RAISE EXCEPTION 'Cannot archive a default dashboard. Set another dashboard as default first.';
    END IF;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER check_archive_default_dashboard
    BEFORE UPDATE ON socialcandor_schema.user_dashboards
    FOR EACH ROW EXECUTE FUNCTION prevent_archive_default_dashboard();
*/
-- =============================================================================


    ------------------------------------------------------------------------------------------------
    -- Table: 62 - dashboard_widget_assignments
    -- Description: Widget positioning within dashboards using grid coordinates
    -- Business Case: Enables drag-and-drop dashboard customization while maintaining responsive
    -- layouts across device types through coordinate normalization. Supports widget state
    -- persistence and user-specific widget configurations.
    -- Feature Reference: DASH03 (Widget Assignment), UI01 (User Interface), RESP01 (Responsive Design)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.dashboard_widget_assignments (
        assignment_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        dashboard_id UUID NOT NULL,
        widget_id UUID NOT NULL,

        -- Positioning and layout
        grid_row INTEGER NOT NULL CHECK (grid_row >= 0),
        grid_column INTEGER NOT NULL CHECK (grid_column >= 0),
        width_cells INTEGER NOT NULL CHECK (width_cells >= 1 AND width_cells <= 12),
        height_cells INTEGER NOT NULL CHECK (height_cells >= 1 AND height_cells <= 12),
        z_index INTEGER DEFAULT 0 CHECK (z_index >= 0),

        -- Responsive behavior
        responsive_behavior VARCHAR(20) DEFAULT 'RESPONSIVE' CHECK (
            responsive_behavior IN ('FIXED', 'RESPONSIVE', 'ADAPTIVE', 'CUSTOM')
        ),
        mobile_config JSONB DEFAULT '{}',
        tablet_config JSONB DEFAULT '{}',
        desktop_config JSONB DEFAULT '{}',

        -- Widget configuration
        widget_config JSONB DEFAULT '{}',
        filters JSONB DEFAULT '{}',
        parameters JSONB DEFAULT '{}',

        -- State and visibility
        is_visible BOOLEAN DEFAULT TRUE,
        is_collapsed BOOLEAN DEFAULT FALSE,
        collapse_state JSONB DEFAULT '{}',

        -- Refresh behavior
        refresh_behavior VARCHAR(20) DEFAULT 'INHERIT' CHECK (
            refresh_behavior IN ('INHERIT', 'INDEPENDENT', 'MANUAL', 'SYNCED')
        ),
        custom_refresh_interval_seconds INTEGER CHECK (custom_refresh_interval_seconds >= 0),

        -- Interactions
        interaction_settings JSONB DEFAULT '{
            "draggable": true,
            "resizable": true,
            "collapsible": true,
            "refreshable": true
        }',

        -- Usage tracking
        last_interacted_at TIMESTAMP WITH TIME ZONE,
        interaction_count INTEGER DEFAULT 0 CHECK (interaction_count >= 0),

        -- Performance
        load_time_ms INTEGER,
        error_count INTEGER DEFAULT 0 CHECK (error_count >= 0),
        last_error_at TIMESTAMP WITH TIME ZONE,
        last_error_message TEXT,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_dashboard_widget_assignments_dashboard FOREIGN KEY (dashboard_id)
            REFERENCES socialcandor_schema.user_dashboards(dashboard_id) ON DELETE CASCADE,
        CONSTRAINT fk_dashboard_widget_assignments_widget FOREIGN KEY (widget_id)
            REFERENCES socialcandor_schema.dashboard_widgets(widget_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_dashboard_widget_position UNIQUE (dashboard_id, grid_row, grid_column),
        CONSTRAINT chk_widget_dimensions CHECK (
            (grid_row + height_cells <= 100) AND
            (grid_column + width_cells <= 12)
        ),
        CONSTRAINT chk_responsive_config CHECK (
            (responsive_behavior != 'CUSTOM' OR (
                mobile_config IS NOT NULL AND
                tablet_config IS NOT NULL AND
                desktop_config IS NOT NULL
            )) OR responsive_behavior = 'CUSTOM'
        )
    );

    COMMENT ON TABLE socialcandor_schema.dashboard_widget_assignments IS 'Widget positioning within dashboards using grid coordinates with responsive design support';
    COMMENT ON COLUMN socialcandor_schema.dashboard_widget_assignments.widget_config IS 'User-specific configuration overrides for widget behavior and display';

    -- Indexes for dashboard_widget_assignments
    CREATE INDEX IF NOT EXISTS idx_dashboard_widget_assignments_dashboard ON socialcandor_schema.dashboard_widget_assignments(dashboard_id);
    CREATE INDEX IF NOT EXISTS idx_dashboard_widget_assignments_widget ON socialcandor_schema.dashboard_widget_assignments(widget_id);
    CREATE INDEX IF NOT EXISTS idx_dashboard_widget_assignments_position ON socialcandor_schema.dashboard_widget_assignments(grid_row, grid_column);
    CREATE INDEX IF NOT EXISTS idx_dashboard_widget_assignments_visible ON socialcandor_schema.dashboard_widget_assignments(is_visible) WHERE is_visible = TRUE;

    -- Trigger for updated_at
    CREATE TRIGGER trg_dashboard_widget_assignments_updated_at
        BEFORE UPDATE ON socialcandor_schema.dashboard_widget_assignments
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    -- Function to validate widget positioning
    CREATE OR REPLACE FUNCTION socialcandor_schema.validate_widget_positioning()
    RETURNS TRIGGER AS $$
    DECLARE
        v_overlapping_count INTEGER;
    BEGIN
        -- Check for overlapping widgets
        SELECT COUNT(*)
        INTO v_overlapping_count
        FROM socialcandor_schema.dashboard_widget_assignments
        WHERE dashboard_id = NEW.dashboard_id
        AND assignment_id != COALESCE(NEW.assignment_id, uuid_nil())
        AND grid_row < NEW.grid_row + NEW.height_cells
        AND grid_row + height_cells > NEW.grid_row
        AND grid_column < NEW.grid_column + NEW.width_cells
        AND grid_column + width_cells > NEW.grid_column;

        IF v_overlapping_count > 0 THEN
            RAISE EXCEPTION 'Widget position overlaps with existing widget(s)';
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_validate_widget_positioning
        BEFORE INSERT OR UPDATE OF grid_row, grid_column, width_cells, height_cells
        ON socialcandor_schema.dashboard_widget_assignments
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.validate_widget_positioning();

   ------------------------------------------------------------------------------------------------
-- Table: 63 - widget_data_cache
-- Description: Cached widget data with expiration timestamps
-- Business Case: Reduces database load during dashboard access spikes while ensuring
-- data freshness through TTL-based invalidation and background refresh workers.
-- Supports multi-tenant caching with versioning and compression.
-- Feature Reference: CACHE01 (Data Caching), PERF07 (Performance), SCAL01 (Scalability)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.widget_data_cache (
    cache_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    widget_id UUID NOT NULL,
    dashboard_id UUID,

    -- Cache identification
    cache_key VARCHAR(500) NOT NULL,
    cache_version INTEGER DEFAULT 1,

    -- Cached data
    cached_data JSONB NOT NULL,
    data_size_bytes INTEGER GENERATED ALWAYS AS (octet_length(cached_data::text)) STORED,
    compression_type VARCHAR(20) DEFAULT 'NONE' CHECK (
        compression_type IN ('NONE', 'GZIP', 'LZ4', 'SNAPPY')
    ),
    compressed_data BYTEA,

    -- Expiration and freshness
    cached_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    stale_at TIMESTAMP WITH TIME ZONE,
    ttl_seconds INTEGER NOT NULL CHECK (ttl_seconds > 0),

    -- Refresh tracking
    last_refreshed_at TIMESTAMP WITH TIME ZONE,
    refresh_count INTEGER DEFAULT 0 CHECK (refresh_count >= 0),
    refresh_status VARCHAR(20) DEFAULT 'SUCCESS' CHECK (
        refresh_status IN ('SUCCESS', 'FAILED', 'PENDING', 'SKIPPED')
    ),
    refresh_error TEXT,

    -- Performance metrics
    query_execution_time_ms INTEGER,
    cache_hit_count INTEGER DEFAULT 0 CHECK (cache_hit_count >= 0),
    last_hit_at TIMESTAMP WITH TIME ZONE,
    average_hit_time_ms NUMERIC(10,2),

    -- Data characteristics
    data_type VARCHAR(50) DEFAULT 'JSON' CHECK (
        data_type IN ('JSON', 'CSV', 'HTML', 'TEXT', 'BINARY')
    ),
    row_count INTEGER CHECK (row_count >= 0),
    column_count INTEGER CHECK (column_count >= 0),

    -- Cache invalidation
    invalidation_reason VARCHAR(200),
    invalidated_at TIMESTAMP WITH TIME ZONE,
    invalidated_by UUID,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_widget_data_cache_widget FOREIGN KEY (widget_id)
        REFERENCES socialcandor_schema.dashboard_widgets(widget_id) ON DELETE CASCADE,
    CONSTRAINT fk_widget_data_cache_dashboard FOREIGN KEY (dashboard_id)
        REFERENCES socialcandor_schema.user_dashboards(dashboard_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT uk_widget_cache_key UNIQUE (widget_id, cache_key, cache_version),
    CONSTRAINT chk_expiration_future CHECK (expires_at > cached_at),
    CONSTRAINT chk_stale_before_expire CHECK (
        (stale_at IS NULL) OR
        (stale_at > cached_at AND stale_at < expires_at)
    ),
    CONSTRAINT chk_compression CHECK (
        (compression_type = 'NONE' AND compressed_data IS NULL) OR
        (compression_type != 'NONE' AND compressed_data IS NOT NULL)
    )
);

COMMENT ON TABLE socialcandor_schema.widget_data_cache IS 'Cached widget data with expiration timestamps and performance tracking';
COMMENT ON COLUMN socialcandor_schema.widget_data_cache.compressed_data IS 'Compressed cache data for storage optimization';

-- Indexes for widget_data_cache
CREATE INDEX IF NOT EXISTS idx_widget_data_cache_widget ON socialcandor_schema.widget_data_cache(widget_id);
CREATE INDEX IF NOT EXISTS idx_widget_data_cache_key ON socialcandor_schema.widget_data_cache(cache_key);
CREATE INDEX IF NOT EXISTS idx_widget_data_cache_expires ON socialcandor_schema.widget_data_cache(expires_at);
CREATE INDEX IF NOT EXISTS idx_widget_data_cache_freshness ON socialcandor_schema.widget_data_cache(expires_at DESC, cached_at DESC);
CREATE INDEX IF NOT EXISTS idx_widget_data_cache_hits ON socialcandor_schema.widget_data_cache(cache_hit_count DESC);
CREATE INDEX IF NOT EXISTS idx_widget_data_cache_size ON socialcandor_schema.widget_data_cache(data_size_bytes DESC);

-- Partial index for active (non-expired) cache entries
-- Removed CURRENT_TIMESTAMP from predicate since it's not IMMUTABLE
-- This index will be less efficient but will work
CREATE INDEX IF NOT EXISTS idx_widget_data_cache_active ON socialcandor_schema.widget_data_cache(widget_id, cache_key)
WHERE invalidated_at IS NULL;

-- Trigger for updated_at
CREATE OR REPLACE TRIGGER trg_widget_data_cache_updated_at
    BEFORE UPDATE ON socialcandor_schema.widget_data_cache
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Improved function to clean up expired cache entries
-- Use a timestamp parameter to make it work correctly
CREATE OR REPLACE FUNCTION socialcandor_schema.cleanup_expired_widget_cache(p_retention_days INTEGER DEFAULT 7)
RETURNS INTEGER AS $$
DECLARE
    v_deleted_count INTEGER;
BEGIN
    DELETE FROM socialcandor_schema.widget_data_cache
    WHERE expires_at < CURRENT_TIMESTAMP - (p_retention_days || ' days')::INTERVAL
    RETURNING COUNT(*) INTO v_deleted_count;
    
    RETURN v_deleted_count;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to get active cache entries (replaces the problematic partial index query)
CREATE OR REPLACE FUNCTION socialcandor_schema.get_active_cache_entries(
    p_widget_id UUID DEFAULT NULL,
    p_cache_key VARCHAR DEFAULT NULL
)
RETURNS TABLE (
    cache_id UUID,
    widget_id UUID,
    dashboard_id UUID,
    cache_key VARCHAR,
    cache_version INTEGER,
    cached_data JSONB,
    expires_at TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        wdc.cache_id,
        wdc.widget_id,
        wdc.dashboard_id,
        wdc.cache_key,
        wdc.cache_version,
        wdc.cached_data,
        wdc.expires_at,
        (wdc.expires_at > CURRENT_TIMESTAMP AND wdc.invalidated_at IS NULL) AS is_active
    FROM socialcandor_schema.widget_data_cache wdc
    WHERE 
        (p_widget_id IS NULL OR wdc.widget_id = p_widget_id)
        AND (p_cache_key IS NULL OR wdc.cache_key = p_cache_key)
        AND wdc.expires_at > CURRENT_TIMESTAMP
        AND wdc.invalidated_at IS NULL
    ORDER BY wdc.expires_at DESC;
END;
$$ LANGUAGE plpgsql STABLE;

-- Function to automatically update last_hit_at and increment cache_hit_count
CREATE OR REPLACE FUNCTION socialcandor_schema.increment_cache_hit(p_cache_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
    UPDATE socialcandor_schema.widget_data_cache
    SET 
        cache_hit_count = cache_hit_count + 1,
        last_hit_at = CURRENT_TIMESTAMP,
        updated_at = CURRENT_TIMESTAMP
    WHERE cache_id = p_cache_id
      AND expires_at > CURRENT_TIMESTAMP
      AND invalidated_at IS NULL;
    
    RETURN FOUND;
END;
$$ LANGUAGE plpgsql VOLATILE;

-- Function to refresh cache entry
CREATE OR REPLACE FUNCTION socialcandor_schema.refresh_cache_entry(
    p_cache_id UUID,
    p_new_data JSONB,
    p_new_ttl_seconds INTEGER DEFAULT NULL
)
RETURNS BOOLEAN AS $$
DECLARE
    v_old_ttl INTEGER;
BEGIN
    -- Get current TTL if not provided
    IF p_new_ttl_seconds IS NULL THEN
        SELECT ttl_seconds INTO v_old_ttl
        FROM socialcandor_schema.widget_data_cache
        WHERE cache_id = p_cache_id;
        
        p_new_ttl_seconds := v_old_ttl;
    END IF;
    
    UPDATE socialcandor_schema.widget_data_cache
    SET 
        cached_data = p_new_data,
        expires_at = CURRENT_TIMESTAMP + (p_new_ttl_seconds || ' seconds')::INTERVAL,
        last_refreshed_at = CURRENT_TIMESTAMP,
        refresh_count = refresh_count + 1,
        refresh_status = 'SUCCESS',
        updated_at = CURRENT_TIMESTAMP,
        data_size_bytes = octet_length(p_new_data::text)
    WHERE cache_id = p_cache_id;
    
    RETURN FOUND;
EXCEPTION
    WHEN OTHERS THEN
        -- Log error and mark as failed
        UPDATE socialcandor_schema.widget_data_cache
        SET 
            refresh_status = 'FAILED',
            refresh_error = SQLERRM,
            updated_at = CURRENT_TIMESTAMP
        WHERE cache_id = p_cache_id;
        
        RETURN FALSE;
END;
$$ LANGUAGE plpgsql VOLATILE;

-- Function to invalidate cache entries
CREATE OR REPLACE FUNCTION socialcandor_schema.invalidate_cache_entries(
    p_widget_id UUID DEFAULT NULL,
    p_dashboard_id UUID DEFAULT NULL,
    p_cache_key VARCHAR DEFAULT NULL,
    p_reason VARCHAR DEFAULT 'Manual invalidation',
    p_invalidated_by UUID DEFAULT NULL
)
RETURNS INTEGER AS $$
DECLARE
    v_invalidated_count INTEGER;
BEGIN
    UPDATE socialcandor_schema.widget_data_cache
    SET 
        invalidated_at = CURRENT_TIMESTAMP,
        invalidation_reason = p_reason,
        invalidated_by = COALESCE(p_invalidated_by, uuid_nil()),
        updated_at = CURRENT_TIMESTAMP
    WHERE 
        (p_widget_id IS NULL OR widget_id = p_widget_id)
        AND (p_dashboard_id IS NULL OR dashboard_id = p_dashboard_id)
        AND (p_cache_key IS NULL OR cache_key = p_cache_key)
        AND invalidated_at IS NULL
        AND expires_at > CURRENT_TIMESTAMP;
    
    GET DIAGNOSTICS v_invalidated_count = ROW_COUNT;
    RETURN v_invalidated_count;
END;
$$ LANGUAGE plpgsql VOLATILE;

-- View for active cache entries (alternative to the problematic partial index)
CREATE OR REPLACE VIEW socialcandor_schema.vw_active_widget_cache AS
SELECT 
    cache_id,
    widget_id,
    dashboard_id,
    cache_key,
    cache_version,
    cached_data,
    data_size_bytes,
    cached_at,
    expires_at,
    stale_at,
    ttl_seconds,
    -- Calculate freshness score (higher is fresher)
    CASE 
        WHEN stale_at IS NOT NULL AND CURRENT_TIMESTAMP > stale_at 
        THEN 0.5  -- Stale but not expired
        ELSE 1.0  -- Fresh
    END as freshness_score,
    -- Time until expiration in seconds
    EXTRACT(EPOCH FROM (expires_at - CURRENT_TIMESTAMP))::INTEGER as seconds_until_expiry
FROM socialcandor_schema.widget_data_cache
WHERE 
    expires_at > CURRENT_TIMESTAMP
    AND invalidated_at IS NULL;

-- Materialized view for cache performance metrics (updated periodically)
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_cache_performance_metrics AS
SELECT 
    DATE(cached_at) as cache_date,
    widget_id,
    COUNT(*) as total_entries,
    SUM(data_size_bytes) as total_size_bytes,
    AVG(cache_hit_count) as avg_hit_count,
    SUM(cache_hit_count) as total_hits,
    AVG(average_hit_time_ms) as avg_hit_time_ms,
    COUNT(CASE WHEN expires_at > CURRENT_TIMESTAMP THEN 1 END) as active_entries,
    COUNT(CASE WHEN refresh_status = 'FAILED' THEN 1 END) as failed_refreshes
FROM socialcandor_schema.widget_data_cache
GROUP BY DATE(cached_at), widget_id
WITH DATA;

-- Index for the materialized view
CREATE UNIQUE INDEX IF NOT EXISTS idx_mv_cache_metrics_date_widget 
ON socialcandor_schema.mv_cache_performance_metrics(cache_date, widget_id);

-- Function to refresh the materialized view
CREATE OR REPLACE FUNCTION socialcandor_schema.refresh_cache_performance_metrics()
RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY socialcandor_schema.mv_cache_performance_metrics;
END;
$$ LANGUAGE plpgsql;

-- Example usage for scheduling cleanup (typically set up via pg_cron or similar):
-- SELECT cron.schedule('cleanup-expired-cache', '0 2 * * *', 'SELECT socialcandor_schema.cleanup_expired_widget_cache(7)');
-- SELECT cron.schedule('refresh-cache-metrics', '0 */6 * * *', 'SELECT socialcandor_schema.refresh_cache_performance_metrics()');

    ------------------------------------------------------------------------------------------------
    -- Table: 64 - notification_templates
    -- Description: Versioned notification copy with parameterized placeholders
    -- Business Case: Enables localization of notifications without developer involvement while
    -- maintaining brand voice consistency through template approval workflows. Supports
    -- multi-channel templates with conditional logic and personalization.
    -- Feature Reference: NTFC03 (Template Management), LOC01 (Localization), BRAND01 (Brand Consistency)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.notification_templates (
        template_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Template identification
        template_code VARCHAR(100) UNIQUE NOT NULL,
        template_name VARCHAR(200) NOT NULL,
        template_version VARCHAR(20) NOT NULL,
        is_current_version BOOLEAN DEFAULT TRUE,

        -- Template classification
        template_type VARCHAR(50) NOT NULL CHECK (
            template_type IN ('SYSTEM', 'MARKETING', 'TRANSACTIONAL', 'SECURITY', 'SOCIAL', 'PROMOTIONAL')
        ),
        notification_category VARCHAR(100),
        tags VARCHAR(100)[] DEFAULT '{}',

        -- Channel support
        supported_channels socialcandor_schema.notification_channel[] NOT NULL,
        primary_channel socialcandor_schema.notification_channel NOT NULL,

        -- Content templates
        subject_template TEXT,
        body_template TEXT NOT NULL,
        html_template TEXT,
        preview_text TEXT,

        -- Personalization and parameters
        parameter_definitions JSONB DEFAULT '[]',
        default_parameters JSONB DEFAULT '{}',
        personalization_rules JSONB DEFAULT '{}',

        -- Localization
        language_code VARCHAR(10) DEFAULT 'en',
        locale VARCHAR(20) DEFAULT 'en_US',
        is_base_template BOOLEAN DEFAULT FALSE,
        base_template_id UUID,
        localized_versions UUID[] DEFAULT '{}',

        -- Branding and styling
        brand_guidelines JSONB DEFAULT '{}',
        styling_template TEXT,
        allowed_variables VARCHAR(100)[] DEFAULT '{}',

        -- Approval workflow
        approval_status VARCHAR(20) DEFAULT 'DRAFT' CHECK (
            approval_status IN ('DRAFT', 'PENDING_APPROVAL', 'APPROVED', 'REJECTED', 'DEPRECATED')
        ),
        approved_by UUID,
        approved_at TIMESTAMP WITH TIME ZONE,
        reviewer_notes TEXT,

        -- Performance tracking
        usage_count INTEGER DEFAULT 0 CHECK (usage_count >= 0),
        delivery_success_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (delivery_success_rate >= 0 AND delivery_success_rate <= 100),
        engagement_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_rate >= 0 AND engagement_rate <= 100),
        last_used_at TIMESTAMP WITH TIME ZONE,

        -- A/B testing
        is_test_variant BOOLEAN DEFAULT FALSE,
        variant_of UUID,
        test_group VARCHAR(100),

        -- Versioning
        previous_version_id UUID,
        version_notes TEXT,
        effective_from TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        effective_until TIMESTAMP WITH TIME ZONE,

        -- Status and lifecycle
        is_active BOOLEAN DEFAULT TRUE,
        is_archived BOOLEAN DEFAULT FALSE,
        archived_at TIMESTAMP WITH TIME ZONE,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_notification_templates_base FOREIGN KEY (base_template_id)
            REFERENCES socialcandor_schema.notification_templates(template_id) ON DELETE SET NULL,
        CONSTRAINT fk_notification_templates_previous FOREIGN KEY (previous_version_id)
            REFERENCES socialcandor_schema.notification_templates(template_id) ON DELETE SET NULL,
        CONSTRAINT fk_notification_templates_variant FOREIGN KEY (variant_of)
            REFERENCES socialcandor_schema.notification_templates(template_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT uk_template_version UNIQUE (template_code, template_version),
        CONSTRAINT chk_effective_dates CHECK (
            (effective_until IS NULL) OR
            (effective_until > effective_from)
        ),
        CONSTRAINT chk_localization CHECK (
            (is_base_template = TRUE AND base_template_id IS NULL) OR
            (is_base_template = FALSE AND base_template_id IS NOT NULL) OR
            (language_code = 'en' AND is_base_template = TRUE)
        )
    );

    COMMENT ON TABLE socialcandor_schema.notification_templates IS 'Versioned notification copy with parameterized placeholders and localization support';
    COMMENT ON COLUMN socialcandor_schema.notification_templates.parameter_definitions IS 'JSON array defining template parameters with validation rules';

    -- Indexes for notification_templates
    CREATE INDEX IF NOT EXISTS idx_notification_templates_code ON socialcandor_schema.notification_templates(template_code);
    CREATE INDEX IF NOT EXISTS idx_notification_templates_type ON socialcandor_schema.notification_templates(template_type);
    CREATE INDEX IF NOT EXISTS idx_notification_templates_current ON socialcandor_schema.notification_templates(is_current_version) WHERE is_current_version = TRUE;
    CREATE INDEX IF NOT EXISTS idx_notification_templates_active ON socialcandor_schema.notification_templates(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_notification_templates_language ON socialcandor_schema.notification_templates(language_code);
    CREATE INDEX IF NOT EXISTS idx_notification_templates_approved ON socialcandor_schema.notification_templates(approval_status) WHERE approval_status = 'APPROVED';
    CREATE INDEX IF NOT EXISTS idx_notification_templates_created ON socialcandor_schema.notification_templates(created_at DESC);

    -- Full-text search for template content
    CREATE INDEX IF NOT EXISTS idx_notification_templates_search ON socialcandor_schema.notification_templates
    USING gin(to_tsvector('english', template_name || ' ' || COALESCE(subject_template, '') || ' ' || body_template));

    -- Trigger for updated_at
    CREATE TRIGGER trg_notification_templates_updated_at
        BEFORE UPDATE ON socialcandor_schema.notification_templates
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    -- Function to maintain current version flag
    CREATE OR REPLACE FUNCTION socialcandor_schema.maintain_template_current_version()
    RETURNS TRIGGER AS $$
    BEGIN
        -- If this is marked as current, ensure no other versions are current for same code
        IF NEW.is_current_version = TRUE AND TG_OP = 'INSERT' THEN
            UPDATE socialcandor_schema.notification_templates
            SET is_current_version = FALSE
            WHERE template_code = NEW.template_code
            AND template_id != NEW.template_id;
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_maintain_template_current_version
        AFTER INSERT OR UPDATE OF is_current_version ON socialcandor_schema.notification_templates
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.maintain_template_current_version();

    -- Function to validate template parameters
    CREATE OR REPLACE FUNCTION socialcandor_schema.validate_template_parameters()
    RETURNS TRIGGER AS $$
    DECLARE
        v_parameters JSONB;
        v_param RECORD;
    BEGIN
        -- Validate parameter definitions
        IF NEW.parameter_definitions IS NOT NULL AND jsonb_typeof(NEW.parameter_definitions) = 'array' THEN
            FOR v_param IN SELECT * FROM jsonb_array_elements(NEW.parameter_definitions) LOOP
                -- Check required fields
                IF NOT (v_param.value ? 'name' AND v_param.value ? 'type') THEN
                    RAISE EXCEPTION 'Parameter definition must include name and type';
                END IF;

                -- Validate parameter name format
                IF NOT (v_param.value->>'name' ~ '^[a-zA-Z_][a-zA-Z0-9_]*$') THEN
                    RAISE EXCEPTION 'Invalid parameter name: %', v_param.value->>'name';
                END IF;
            END LOOP;
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_validate_template_parameters
        BEFORE INSERT OR UPDATE OF parameter_definitions ON socialcandor_schema.notification_templates
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.validate_template_parameters();

    ------------------------------------------------------------------------------------------------
    -- Table: 65 - notification_delivery_methods
    -- Description: Delivery channel configuration with provider settings
    -- Business Case: Supports multi-provider failover for critical notifications while enabling
    -- delivery method optimization based on user engagement patterns. Provides provider
    -- performance monitoring and cost optimization across delivery channels.
    -- Feature Reference: NTFC04 (Delivery Methods), PROV01 (Provider Management), COST02 (Cost Optimization)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.notification_delivery_methods (
        method_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Method identification
        method_name VARCHAR(200) NOT NULL,
        method_code VARCHAR(100) UNIQUE NOT NULL,
        delivery_channel socialcandor_schema.notification_channel NOT NULL,

        -- Provider configuration
        provider_name VARCHAR(100) NOT NULL,
        provider_type VARCHAR(50) DEFAULT 'EXTERNAL' CHECK (
            provider_type IN ('INTERNAL', 'EXTERNAL', 'HYBRID')
        ),
        provider_config JSONB NOT NULL,
        provider_version VARCHAR(20),

        -- Connection settings
        api_endpoint VARCHAR(500),
        api_key_encrypted TEXT,
        authentication_method VARCHAR(50) DEFAULT 'API_KEY' CHECK (
            authentication_method IN ('API_KEY', 'OAUTH2', 'BASIC', 'JWT', 'CUSTOM')
        ),
        connection_timeout_seconds INTEGER DEFAULT 30 CHECK (connection_timeout_seconds >= 0),

        -- Delivery settings
        max_retry_attempts INTEGER DEFAULT 3 CHECK (max_retry_attempts >= 0),
        retry_delay_seconds INTEGER DEFAULT 60 CHECK (retry_delay_seconds >= 0),
        batch_size INTEGER DEFAULT 100 CHECK (batch_size >= 1),
        batch_interval_seconds INTEGER DEFAULT 10 CHECK (batch_interval_seconds >= 0),

        -- Rate limiting
        rate_limit_requests_per_minute INTEGER DEFAULT 60 CHECK (rate_limit_requests_per_minute >= 0),
        rate_limit_requests_per_hour INTEGER DEFAULT 1000 CHECK (rate_limit_requests_per_hour >= 0),
        rate_limit_strategy VARCHAR(20) DEFAULT 'QUEUE' CHECK (
            rate_limit_strategy IN ('QUEUE', 'DROP', 'THROTTLE', 'FAILOVER')
        ),

        -- Cost and pricing
        cost_per_message NUMERIC(10,4) DEFAULT 0.0 CHECK (cost_per_message >= 0),
        cost_currency CHAR(3) DEFAULT 'USD',
        pricing_tier VARCHAR(50),
        monthly_cost_limit NUMERIC(10,2) CHECK (monthly_cost_limit >= 0),

        -- Performance metrics
        delivery_success_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (delivery_success_rate >= 0 AND delivery_success_rate <= 100),
        average_delivery_time_ms INTEGER,
        error_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (error_rate >= 0 AND error_rate <= 100),
        queue_size INTEGER DEFAULT 0 CHECK (queue_size >= 0),

        -- Health monitoring
        health_status VARCHAR(20) DEFAULT 'HEALTHY' CHECK (
            health_status IN ('HEALTHY', 'DEGRADED', 'UNHEALTHY', 'MAINTENANCE')
        ),
        last_health_check TIMESTAMP WITH TIME ZONE,
        health_check_interval_seconds INTEGER DEFAULT 300 CHECK (health_check_interval_seconds >= 0),

        -- Failover configuration
        failover_method_id UUID,
        failover_conditions JSONB DEFAULT '{}',
        failover_priority INTEGER DEFAULT 0 CHECK (failover_priority >= 0),

        -- Feature support
        supported_features VARCHAR(50)[] DEFAULT '{}',
        maximum_payload_size_bytes INTEGER DEFAULT 1024 CHECK (maximum_payload_size_bytes >= 0),
        supports_attachments BOOLEAN DEFAULT FALSE,
        supports_tracking BOOLEAN DEFAULT TRUE,

        -- Status and lifecycle
        is_active BOOLEAN DEFAULT TRUE,
        is_default BOOLEAN DEFAULT FALSE,
        activation_date TIMESTAMP WITH TIME ZONE,
        deactivation_date TIMESTAMP WITH TIME ZONE,

        -- Compliance and security
        encryption_required BOOLEAN DEFAULT TRUE,
        data_retention_days INTEGER DEFAULT 90 CHECK (data_retention_days >= 0),
        compliance_certifications VARCHAR(100)[] DEFAULT '{}',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_notification_delivery_methods_failover FOREIGN KEY (failover_method_id)
            REFERENCES socialcandor_schema.notification_delivery_methods(method_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_deactivation_date CHECK (
            (deactivation_date IS NULL) OR
            (deactivation_date > activation_date)
        ),
        CONSTRAINT chk_provider_config CHECK (jsonb_typeof(provider_config) = 'object')
    );

    COMMENT ON TABLE socialcandor_schema.notification_delivery_methods IS 'Delivery channel configuration with provider settings and failover support';
    COMMENT ON COLUMN socialcandor_schema.notification_delivery_methods.provider_config IS 'JSON configuration for specific provider API settings';

    -- Indexes for notification_delivery_methods
    CREATE INDEX IF NOT EXISTS idx_notification_delivery_methods_code ON socialcandor_schema.notification_delivery_methods(method_code);
    CREATE INDEX IF NOT EXISTS idx_notification_delivery_methods_channel ON socialcandor_schema.notification_delivery_methods(delivery_channel);
    CREATE INDEX IF NOT EXISTS idx_notification_delivery_methods_active ON socialcandor_schema.notification_delivery_methods(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_notification_delivery_methods_default ON socialcandor_schema.notification_delivery_methods(is_default) WHERE is_default = TRUE;
    CREATE INDEX IF NOT EXISTS idx_notification_delivery_methods_health ON socialcandor_schema.notification_delivery_methods(health_status);
    CREATE INDEX IF NOT EXISTS idx_notification_delivery_methods_provider ON socialcandor_schema.notification_delivery_methods(provider_name);
    CREATE INDEX IF NOT EXISTS idx_notification_delivery_methods_created ON socialcandor_schema.notification_delivery_methods(created_at DESC);

    -- Trigger for updated_at
    CREATE TRIGGER trg_notification_delivery_methods_updated_at
        BEFORE UPDATE ON socialcandor_schema.notification_delivery_methods
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    -- Function to ensure only one default method per channel
    CREATE OR REPLACE FUNCTION socialcandor_schema.ensure_single_default_delivery_method()
    RETURNS TRIGGER AS $$
    BEGIN
        IF NEW.is_default = TRUE THEN
            UPDATE socialcandor_schema.notification_delivery_methods
            SET is_default = FALSE
            WHERE delivery_channel = NEW.delivery_channel
            AND method_id != NEW.method_id
            AND is_default = TRUE;
        END IF;
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_ensure_single_default_delivery_method
        AFTER INSERT OR UPDATE OF is_default ON socialcandor_schema.notification_delivery_methods
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.ensure_single_default_delivery_method();	
	
	------------------------------------------------------------------------------------------------
-- Table: Developer Applications (Create before webhook_endpoints)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.developer_applications (
    application_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,
    application_name VARCHAR(200) NOT NULL,
    description TEXT,
    api_key VARCHAR(255) NOT NULL DEFAULT encode(gen_random_bytes(32), 'hex'),
    api_secret VARCHAR(255) NOT NULL DEFAULT encode(gen_random_bytes(64), 'hex'),
    redirect_uri VARCHAR(500),
    application_type VARCHAR(50) DEFAULT 'WEB' CHECK (
        application_type IN ('WEB', 'MOBILE', 'DESKTOP', 'SERVER', 'BROWSER_EXTENSION')
    ),
    scopes VARCHAR(100)[] DEFAULT '{}',
    is_active BOOLEAN DEFAULT TRUE,
    rate_limit_per_hour INTEGER DEFAULT 1000,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_developer_applications_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE
);

-- Create index for developer_applications
CREATE INDEX IF NOT EXISTS idx_developer_applications_user 
ON socialcandor_schema.developer_applications(user_id);

    ------------------------------------------------------------------------------------------------
    -- Table: 66 - webhook_endpoints
    -- Description: Third-party integration endpoints with secret key management
    -- Business Case: Enables real-time data sync with external systems (CRM, analytics) while
    -- maintaining security through HMAC signature verification and IP allowlisting. Supports
    -- event-driven architecture and system integration without polling overhead.
    -- Feature Reference: INT01 (Webhook Integration), SEC05 (API Security), SYNC02 (Data Synchronization)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.webhook_endpoints (
        endpoint_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        user_id UUID NOT NULL,
        application_id UUID,

        -- Endpoint identification
        endpoint_name VARCHAR(200) NOT NULL,
        endpoint_url VARCHAR(500) NOT NULL,
        endpoint_description TEXT,

        -- Security configuration
        secret_key VARCHAR(255) NOT NULL DEFAULT encode(gen_random_bytes(32), 'hex'),
        hmac_algorithm VARCHAR(20) DEFAULT 'SHA256' CHECK (
            hmac_algorithm IN ('SHA256', 'SHA384', 'SHA512', 'MD5')
        ),
        signature_header_name VARCHAR(100) DEFAULT 'X-Webhook-Signature',

        -- Network security
        ip_allowlist INET[] DEFAULT '{}',
        ip_denylist INET[] DEFAULT '{}',
        require_ssl BOOLEAN DEFAULT TRUE,
        ssl_verification_enabled BOOLEAN DEFAULT TRUE,

        -- Endpoint configuration
        content_type VARCHAR(50) DEFAULT 'application/json' CHECK (
            content_type IN ('application/json', 'application/xml', 'application/x-www-form-urlencoded')
        ),
        http_method VARCHAR(10) DEFAULT 'POST' CHECK (http_method IN ('POST', 'PUT', 'PATCH')),
        timeout_seconds INTEGER DEFAULT 30 CHECK (timeout_seconds BETWEEN 1 AND 300),
        max_retries INTEGER DEFAULT 3 CHECK (max_retries BETWEEN 0 AND 10),

        -- Headers and customization
        custom_headers JSONB DEFAULT '{}',
        payload_template TEXT,
        payload_transform_rules JSONB DEFAULT '{}',

        -- Rate limiting
        rate_limit_per_minute INTEGER DEFAULT 60 CHECK (rate_limit_per_minute >= 0),
        rate_limit_per_hour INTEGER DEFAULT 1000 CHECK (rate_limit_per_hour >= 0),
        concurrent_requests_limit INTEGER DEFAULT 5 CHECK (concurrent_requests_limit >= 1),

        -- Status and health
        endpoint_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
            endpoint_status IN ('ACTIVE', 'INACTIVE', 'SUSPENDED', 'FAILING', 'DEPRECATED')
        ),
        last_delivery_attempt TIMESTAMP WITH TIME ZONE,
        last_successful_delivery TIMESTAMP WITH TIME ZONE,
        consecutive_failures INTEGER DEFAULT 0 CHECK (consecutive_failures >= 0),
        health_score NUMERIC(5,2) DEFAULT 100.0 CHECK (health_score >= 0 AND health_score <= 100),

        -- Monitoring and alerting
        alert_on_failure BOOLEAN DEFAULT TRUE,
        alert_threshold_failures INTEGER DEFAULT 5 CHECK (alert_threshold_failures >= 1),
        alert_email VARCHAR(255),
        alert_webhook_url VARCHAR(500),

        -- Usage metrics
        total_delivery_attempts INTEGER DEFAULT 0 CHECK (total_delivery_attempts >= 0),
        successful_deliveries INTEGER DEFAULT 0 CHECK (successful_deliveries >= 0),
        failed_deliveries INTEGER DEFAULT 0 CHECK (failed_deliveries >= 0),
        average_response_time_ms NUMERIC(10,2),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),
        expires_at TIMESTAMP WITH TIME ZONE,

        -- Foreign key constraints
        CONSTRAINT fk_webhook_endpoints_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_webhook_endpoints_application FOREIGN KEY (application_id)
            REFERENCES socialcandor_schema.developer_applications(application_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_webhook_url_valid CHECK (
            endpoint_url ~* '^https?://[a-zA-Z0-9.-]+(:[0-9]+)?(/.*)?$'
        ),
        CONSTRAINT chk_secret_key_length CHECK (LENGTH(secret_key) >= 32),
        CONSTRAINT chk_health_score_valid CHECK (
            (endpoint_status != 'FAILING' OR health_score < 50) OR
            endpoint_status = 'FAILING'
        )
    );

    COMMENT ON TABLE socialcandor_schema.webhook_endpoints IS 'Third-party integration endpoints with secret key management and security controls';
    COMMENT ON COLUMN socialcandor_schema.webhook_endpoints.health_score IS 'Composite score based on delivery success rate and response times';

    -- Indexes for webhook_endpoints
    CREATE INDEX IF NOT EXISTS idx_webhook_endpoints_user ON socialcandor_schema.webhook_endpoints(user_id);
    CREATE INDEX IF NOT EXISTS idx_webhook_endpoints_status ON socialcandor_schema.webhook_endpoints(endpoint_status);
    CREATE INDEX IF NOT EXISTS idx_webhook_endpoints_health ON socialcandor_schema.webhook_endpoints(health_score DESC);
    CREATE INDEX IF NOT EXISTS idx_webhook_endpoints_application ON socialcandor_schema.webhook_endpoints(application_id) WHERE application_id IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_webhook_endpoints_url_pattern ON socialcandor_schema.webhook_endpoints USING gin(endpoint_url gin_trgm_ops);

    -- Trigger for updated_at
    CREATE TRIGGER trg_webhook_endpoints_updated_at
        BEFORE UPDATE ON socialcandor_schema.webhook_endpoints
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 67 - webhook_events
    -- Description: Event taxonomy for webhook triggers with activation controls
    -- Business Case: Provides standardized event naming conventions while enabling event
    -- versioning to prevent breaking changes for subscribed integrations. Supports
    -- event filtering and transformation for different consumer needs.
    -- Feature Reference: INT02 (Event Management), VER02 (Versioning), EVT01 (Event Taxonomy)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.webhook_events (
        event_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Event identification
        event_name VARCHAR(100) NOT NULL UNIQUE,
        event_description TEXT NOT NULL,
        event_category VARCHAR(50) NOT NULL CHECK (
            event_category IN ('USER', 'CONTENT', 'COMMERCE', 'MESSAGING', 'SYSTEM', 'SECURITY', 'ANALYTICS')
        ),
        event_version VARCHAR(20) DEFAULT '1.0.0',

        -- Event schema
        event_schema JSONB NOT NULL DEFAULT '{
            "type": "object",
            "properties": {},
            "required": []
        }',
        sample_payload JSONB,
        schema_version INTEGER DEFAULT 1 CHECK (schema_version >= 1),

        -- Event configuration
        is_active BOOLEAN DEFAULT TRUE,
        is_deprecated BOOLEAN DEFAULT FALSE,
        deprecated_since TIMESTAMP WITH TIME ZONE,
        replacement_event_id UUID,

        -- Delivery configuration
        default_retry_policy JSONB DEFAULT '{
            "max_attempts": 3,
            "backoff_multiplier": 2,
            "initial_delay_ms": 1000,
            "max_delay_ms": 30000
        }',
        default_priority INTEGER DEFAULT 5 CHECK (default_priority BETWEEN 1 AND 10),
        is_high_frequency BOOLEAN DEFAULT FALSE,

        -- Security and permissions
        required_permissions VARCHAR(50)[] DEFAULT '{}',
        data_classification socialcandor_schema.data_classification DEFAULT 'INTERNAL',
        pii_included BOOLEAN DEFAULT FALSE,
        pii_fields TEXT[] DEFAULT '{}',

        -- Event metadata
        producer_service VARCHAR(100),
        estimated_volume_per_day INTEGER CHECK (estimated_volume_per_day >= 0),
        average_payload_size_bytes INTEGER CHECK (average_payload_size_bytes >= 0),

        -- Documentation
        documentation_url VARCHAR(500),
        changelog JSONB DEFAULT '[]',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_webhook_events_replacement FOREIGN KEY (replacement_event_id)
            REFERENCES socialcandor_schema.webhook_events(event_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_event_name_format CHECK (event_name ~ '^[a-z][a-z0-9_]*(\.[a-z][a-z0-9_]*)*$'),
        CONSTRAINT chk_schema_valid CHECK (event_schema ? 'type' AND event_schema->>'type' = 'object'),
        CONSTRAINT chk_deprecation_fields CHECK (
            (is_deprecated = TRUE AND deprecated_since IS NOT NULL) OR
            is_deprecated = FALSE
        )
    );

    COMMENT ON TABLE socialcandor_schema.webhook_events IS 'Event taxonomy for webhook triggers with versioning and schema management';
    COMMENT ON COLUMN socialcandor_schema.webhook_events.event_schema IS 'JSON Schema defining the structure of webhook payloads';

    -- Indexes for webhook_events
    CREATE INDEX IF NOT EXISTS idx_webhook_events_category ON socialcandor_schema.webhook_events(event_category);
    CREATE INDEX IF NOT EXISTS idx_webhook_events_active ON socialcandor_schema.webhook_events(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_webhook_events_deprecated ON socialcandor_schema.webhook_events(is_deprecated) WHERE is_deprecated = TRUE;
    CREATE INDEX IF NOT EXISTS idx_webhook_events_version ON socialcandor_schema.webhook_events(event_version);
    CREATE INDEX IF NOT EXISTS idx_webhook_events_volume ON socialcandor_schema.webhook_events(estimated_volume_per_day DESC);

    -- Trigger for updated_at
    CREATE TRIGGER trg_webhook_events_updated_at
        BEFORE UPDATE ON socialcandor_schema.webhook_events
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 68 - webhook_subscriptions
    -- Description: User-configured event-to-endpoint mappings with filtering rules
    -- Business Case: Enables granular webhook configuration per integration while supporting
    -- event filtering to reduce unnecessary payload delivery and third-party API costs.
    -- Supports complex subscription logic with transformation rules.
    -- Feature Reference: INT03 (Subscription Management), EVT02 (Event Routing), FLT01 (Filtering)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.webhook_subscriptions (
        subscription_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        endpoint_id UUID NOT NULL,
        event_id UUID NOT NULL,
        user_id UUID NOT NULL,

        -- Subscription configuration
        subscription_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
            subscription_status IN ('ACTIVE', 'PAUSED', 'CANCELLED', 'SUSPENDED', 'EXPIRED')
        ),
        subscription_name VARCHAR(200),
        description TEXT,

        -- Filtering rules
        filter_rules JSONB DEFAULT '{}',
        filter_expression TEXT,
        filter_enabled BOOLEAN DEFAULT FALSE,

        -- Transformation rules
        payload_transform JSONB DEFAULT '{}',
        field_mappings JSONB DEFAULT '{}',
        include_metadata BOOLEAN DEFAULT TRUE,

        -- Delivery configuration
        retry_policy JSONB,
        priority_override INTEGER CHECK (priority_override BETWEEN 1 AND 10),
        delivery_timeout_seconds INTEGER CHECK (delivery_timeout_seconds BETWEEN 1 AND 300),

        -- Batching configuration
        batching_enabled BOOLEAN DEFAULT FALSE,
        batch_size INTEGER DEFAULT 10 CHECK (batch_size BETWEEN 1 AND 1000),
        batch_timeout_seconds INTEGER DEFAULT 30 CHECK (batch_timeout_seconds BETWEEN 1 AND 300),
        max_batch_delay_ms INTEGER DEFAULT 5000 CHECK (max_batch_delay_ms BETWEEN 0 AND 30000),

        -- Rate limiting
        rate_limit_enabled BOOLEAN DEFAULT FALSE,
        max_events_per_minute INTEGER CHECK (max_events_per_minute >= 1),
        max_events_per_hour INTEGER CHECK (max_events_per_hour >= 1),

        -- Subscription metadata
        metadata_tags VARCHAR(50)[] DEFAULT '{}',
        subscription_tier VARCHAR(20) DEFAULT 'STANDARD' CHECK (
            subscription_tier IN ('FREE', 'STANDARD', 'PREMIUM', 'ENTERPRISE')
        ),

        -- Usage tracking
        events_delivered INTEGER DEFAULT 0 CHECK (events_delivered >= 0),
        events_filtered INTEGER DEFAULT 0 CHECK (events_filtered >= 0),
        events_failed INTEGER DEFAULT 0 CHECK (events_failed >= 0),
        last_event_delivered TIMESTAMP WITH TIME ZONE,

        -- Subscription lifecycle
        subscribed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        activated_at TIMESTAMP WITH TIME ZONE,
        paused_at TIMESTAMP WITH TIME ZONE,
        cancelled_at TIMESTAMP WITH TIME ZONE,
        expires_at TIMESTAMP WITH TIME ZONE,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_webhook_subscriptions_endpoint FOREIGN KEY (endpoint_id)
            REFERENCES socialcandor_schema.webhook_endpoints(endpoint_id) ON DELETE CASCADE,
        CONSTRAINT fk_webhook_subscriptions_event FOREIGN KEY (event_id)
            REFERENCES socialcandor_schema.webhook_events(event_id) ON DELETE CASCADE,
        CONSTRAINT fk_webhook_subscriptions_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_webhook_subscriptions_endpoint_event UNIQUE (endpoint_id, event_id),
        CONSTRAINT chk_subscription_dates CHECK (
            subscribed_at <= COALESCE(activated_at, subscribed_at) AND
            activated_at <= COALESCE(paused_at, activated_at) AND
            paused_at <= COALESCE(cancelled_at, paused_at)
        ),
        CONSTRAINT chk_batching_config CHECK (
            (batching_enabled = FALSE AND batch_size IS NULL) OR
            (batching_enabled = TRUE AND batch_size IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.webhook_subscriptions IS 'User-configured event-to-endpoint mappings with filtering and transformation rules';
    COMMENT ON COLUMN socialcandor_schema.webhook_subscriptions.filter_rules IS 'JSON rules for filtering which events trigger webhook delivery';

    -- Indexes for webhook_subscriptions
    CREATE INDEX IF NOT EXISTS idx_webhook_subscriptions_endpoint ON socialcandor_schema.webhook_subscriptions(endpoint_id);
    CREATE INDEX IF NOT EXISTS idx_webhook_subscriptions_event ON socialcandor_schema.webhook_subscriptions(event_id);
    CREATE INDEX IF NOT EXISTS idx_webhook_subscriptions_user ON socialcandor_schema.webhook_subscriptions(user_id);
    CREATE INDEX IF NOT EXISTS idx_webhook_subscriptions_status ON socialcandor_schema.webhook_subscriptions(subscription_status);
    CREATE INDEX IF NOT EXISTS idx_webhook_subscriptions_active ON socialcandor_schema.webhook_subscriptions(subscription_status) WHERE subscription_status = 'ACTIVE';
    CREATE INDEX IF NOT EXISTS idx_webhook_subscriptions_expires ON socialcandor_schema.webhook_subscriptions(expires_at) WHERE expires_at IS NOT NULL;

    -- Trigger for updated_at
    CREATE TRIGGER trg_webhook_subscriptions_updated_at
        BEFORE UPDATE ON socialcandor_schema.webhook_subscriptions
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 69 - webhook_delivery_logs
    -- Description: Immutable webhook delivery audit trail with retry tracking
    -- Business Case: Provides debugging capability for failed deliveries while enabling
    -- SLA monitoring for integration reliability and automatic alerting on delivery
    -- failure patterns. Supports comprehensive audit trails for compliance requirements.
    -- Feature Reference: INT04 (Delivery Monitoring), AUD01 (Audit Trail), MON04 (SLA Tracking)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.webhook_delivery_logs (
        delivery_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        subscription_id UUID NOT NULL,
        endpoint_id UUID NOT NULL,
        event_id UUID NOT NULL,
        webhook_event_id UUID,

        -- Event data
        event_name VARCHAR(100) NOT NULL,
        event_payload JSONB NOT NULL,
        transformed_payload JSONB,
        event_timestamp TIMESTAMP WITH TIME ZONE NOT NULL,

        -- Delivery configuration
        delivery_attempt INTEGER DEFAULT 1 CHECK (delivery_attempt >= 1),
        max_attempts INTEGER DEFAULT 3 CHECK (max_attempts >= 1),
        priority INTEGER DEFAULT 5 CHECK (priority BETWEEN 1 AND 10),

        -- Delivery status
        delivery_status VARCHAR(20) NOT NULL CHECK (
            delivery_status IN ('PENDING', 'QUEUED', 'PROCESSING', 'DELIVERED', 'FAILED', 'RETRYING', 'EXPIRED')
        ),
        status_reason VARCHAR(200),
        status_code INTEGER,
        response_body TEXT,
        response_headers JSONB,

        -- Timing metrics
        queued_at TIMESTAMP WITH TIME ZONE,
        processing_started_at TIMESTAMP WITH TIME ZONE,
        processing_completed_at TIMESTAMP WITH TIME ZONE,
        delivery_latency_ms NUMERIC(10,2),
        total_processing_time_ms NUMERIC(10,2),

        -- Retry information
        retry_count INTEGER DEFAULT 0 CHECK (retry_count >= 0),
        next_retry_at TIMESTAMP WITH TIME ZONE,
        retry_delay_ms INTEGER,
        retry_reason VARCHAR(200),

        -- Error details
        error_type VARCHAR(100),
        error_message TEXT,
        error_details JSONB,
        stack_trace TEXT,

        -- Network details
        destination_url VARCHAR(500),
        request_headers JSONB,
        request_body_size_bytes INTEGER CHECK (request_body_size_bytes >= 0),
        response_size_bytes INTEGER CHECK (response_size_bytes >= 0),

        -- Security details
        signature_verified BOOLEAN,
        signature_header VARCHAR(500),
        ip_address INET,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID DEFAULT uuid_nil(),
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_webhook_delivery_logs_subscription FOREIGN KEY (subscription_id)
            REFERENCES socialcandor_schema.webhook_subscriptions(subscription_id) ON DELETE CASCADE,
        CONSTRAINT fk_webhook_delivery_logs_endpoint FOREIGN KEY (endpoint_id)
            REFERENCES socialcandor_schema.webhook_endpoints(endpoint_id) ON DELETE CASCADE,
        CONSTRAINT fk_webhook_delivery_logs_event FOREIGN KEY (event_id)
            REFERENCES socialcandor_schema.webhook_events(event_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT chk_delivery_timestamps CHECK (
            queued_at <= COALESCE(processing_started_at, queued_at) AND
            processing_started_at <= COALESCE(processing_completed_at, processing_started_at)
        ),
        CONSTRAINT chk_status_code_valid CHECK (
            status_code IS NULL OR
            (status_code >= 100 AND status_code <= 599)
        )
    );

    COMMENT ON TABLE socialcandor_schema.webhook_delivery_logs IS 'Immutable webhook delivery audit trail with comprehensive delivery metrics';
    COMMENT ON COLUMN socialcandor_schema.webhook_delivery_logs.webhook_event_id IS 'Unique identifier for the webhook event instance';

    -- Indexes for webhook_delivery_logs
    CREATE INDEX IF NOT EXISTS idx_webhook_delivery_logs_subscription ON socialcandor_schema.webhook_delivery_logs(subscription_id);
    CREATE INDEX IF NOT EXISTS idx_webhook_delivery_logs_endpoint ON socialcandor_schema.webhook_delivery_logs(endpoint_id);
    CREATE INDEX IF NOT EXISTS idx_webhook_delivery_logs_event ON socialcandor_schema.webhook_delivery_logs(event_id);
    CREATE INDEX IF NOT EXISTS idx_webhook_delivery_logs_status ON socialcandor_schema.webhook_delivery_logs(delivery_status);
    CREATE INDEX IF NOT EXISTS idx_webhook_delivery_logs_created_at ON socialcandor_schema.webhook_delivery_logs(created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_webhook_delivery_logs_status_code ON socialcandor_schema.webhook_delivery_logs(status_code);
    CREATE INDEX IF NOT EXISTS idx_webhook_delivery_logs_failed ON socialcandor_schema.webhook_delivery_logs(delivery_status) WHERE delivery_status = 'FAILED';
    CREATE INDEX IF NOT EXISTS idx_webhook_delivery_logs_retry ON socialcandor_schema.webhook_delivery_logs(next_retry_at) WHERE next_retry_at IS NOT NULL;

    -- Partition by date for performance (monthly partitions)
    -- Note: This is conceptual; actual partition setup would be done separately
    -- CREATE TABLE socialcandor_schema.webhook_delivery_logs_2024_01 PARTITION OF socialcandor_schema.webhook_delivery_logs
    -- FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

    -- Trigger for updated_at
    CREATE TRIGGER trg_webhook_delivery_logs_updated_at
        BEFORE UPDATE ON socialcandor_schema.webhook_delivery_logs
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 70 - chat_quality_metrics
    -- Description: Conversation-level quality scores for moderation
    -- Business Case: Enables proactive identification of toxic conversations for moderator
    -- intervention while supporting user feedback loops through quality-based ranking
    -- in conversation lists. Uses AI/ML models to assess conversation health.
    -- Feature Reference: MOD04 (Conversation Moderation), AI01 (Quality Scoring), SAF02 (Safety Monitoring)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.chat_quality_metrics (
        quality_metric_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        conversation_id UUID NOT NULL,

        -- Quality scores
        overall_quality_score NUMERIC(5,2) DEFAULT 50.0 CHECK (overall_quality_score >= 0 AND overall_quality_score <= 100),
        sentiment_score NUMERIC(5,2) CHECK (sentiment_score >= -1 AND sentiment_score <= 1),
        toxicity_score NUMERIC(5,2) DEFAULT 0.0 CHECK (toxicity_score >= 0 AND toxicity_score <= 100),
        spam_score NUMERIC(5,2) DEFAULT 0.0 CHECK (spam_score >= 0 AND spam_score <= 100),
        harassment_score NUMERIC(5,2) DEFAULT 0.0 CHECK (harassment_score >= 0 AND harassment_score <= 100),

        -- Engagement metrics
        response_time_score NUMERIC(5,2) CHECK (response_time_score >= 0 AND response_time_score <= 100),
        engagement_balance_score NUMERIC(5,2) CHECK (engagement_balance_score >= 0 AND engagement_balance_score <= 100),
        message_quality_score NUMERIC(5,2) CHECK (message_quality_score >= 0 AND message_quality_score <= 100),

        -- Content analysis
        keyword_violations INTEGER DEFAULT 0 CHECK (keyword_violations >= 0),
        flagged_messages_count INTEGER DEFAULT 0 CHECK (flagged_messages_count >= 0),
        reported_messages_count INTEGER DEFAULT 0 CHECK (reported_messages_count >= 0),

        -- User behavior
        participant_trust_scores NUMERIC(5,2)[] DEFAULT '{}',
        participant_warning_counts INTEGER[] DEFAULT '{}',

        -- Moderation flags
        requires_moderator_review BOOLEAN DEFAULT FALSE,
        review_priority VARCHAR(20) CHECK (review_priority IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
        auto_moderation_action VARCHAR(50),

        -- Analysis metadata
        analyzed_message_count INTEGER DEFAULT 0 CHECK (analyzed_message_count >= 0),
        analysis_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        analysis_window_hours INTEGER DEFAULT 24 CHECK (analysis_window_hours >= 1),

        -- Model information
        model_version VARCHAR(50),
        model_confidence NUMERIC(5,2) CHECK (model_confidence >= 0 AND model_confidence <= 100),
        feature_vector JSONB,

        -- Historical trends
        previous_quality_score NUMERIC(5,2),
        quality_trend VARCHAR(20) CHECK (quality_trend IN ('IMPROVING', 'STABLE', 'DETERIORATING', 'VOLATILE')),
        trend_confidence NUMERIC(5,2) CHECK (trend_confidence >= 0 AND trend_confidence <= 100),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID DEFAULT uuid_nil(),
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_chat_quality_metrics_conversation FOREIGN KEY (conversation_id)
            REFERENCES socialcandor_schema.conversations(conversation_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT chk_scores_consistent CHECK (
            (toxicity_score < 70 OR requires_moderator_review = TRUE) OR
            toxicity_score >= 70
        ),
        CONSTRAINT chk_participant_arrays CHECK (
            array_length(participant_trust_scores, 1) = array_length(participant_warning_counts, 1)
        )
    );

    COMMENT ON TABLE socialcandor_schema.chat_quality_metrics IS 'Conversation-level quality scores for proactive moderation and safety monitoring';
    COMMENT ON COLUMN socialcandor_schema.chat_quality_metrics.feature_vector IS 'ML feature vector used for quality prediction';

    -- Indexes for chat_quality_metrics
    CREATE INDEX IF NOT EXISTS idx_chat_quality_metrics_conversation ON socialcandor_schema.chat_quality_metrics(conversation_id);
    CREATE INDEX IF NOT EXISTS idx_chat_quality_metrics_quality ON socialcandor_schema.chat_quality_metrics(overall_quality_score DESC);
    CREATE INDEX IF NOT EXISTS idx_chat_quality_metrics_toxicity ON socialcandor_schema.chat_quality_metrics(toxicity_score DESC);
    CREATE INDEX IF NOT EXISTS idx_chat_quality_metrics_review ON socialcandor_schema.chat_quality_metrics(requires_moderator_review) WHERE requires_moderator_review = TRUE;
    CREATE INDEX IF NOT EXISTS idx_chat_quality_metrics_analysis_time ON socialcandor_schema.chat_quality_metrics(analysis_timestamp DESC);

    -- Materialized view for high-risk conversations
    CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_high_risk_conversations AS
    SELECT
        cqm.conversation_id,
        c.title,
        c.conversation_type,
        cqm.overall_quality_score,
        cqm.toxicity_score,
        cqm.requires_moderator_review,
        cqm.review_priority,
        cqm.analysis_timestamp,
        COUNT(cmu.user_id) as participant_count,
        ARRAY_AGG(cmu.user_role) as participant_roles
    FROM socialcandor_schema.chat_quality_metrics cqm
    JOIN socialcandor_schema.conversations c ON cqm.conversation_id = c.conversation_id
    JOIN socialcandor_schema.conversations_users cmu ON c.conversation_id = cmu.conversation_id
    WHERE cqm.requires_moderator_review = TRUE
    AND cqm.analysis_timestamp >= CURRENT_TIMESTAMP - INTERVAL '24 hours'
    GROUP BY cqm.conversation_id, c.title, c.conversation_type, cqm.overall_quality_score,
             cqm.toxicity_score, cqm.requires_moderator_review, cqm.review_priority, cqm.analysis_timestamp
    WITH DATA;

    CREATE UNIQUE INDEX idx_mv_high_risk_conversations_id ON socialcandor_schema.mv_high_risk_conversations(conversation_id);

    -- Trigger for updated_at
    CREATE TRIGGER trg_chat_quality_metrics_updated_at
        BEFORE UPDATE ON socialcandor_schema.chat_quality_metrics
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 71 - chat_sentiment_analysis
    -- Description: Message-level sentiment scoring with keyword extraction
    -- Business Case: Powers real-time toxicity detection for minor safety while enabling
    -- emotional intelligence features (e.g., suggesting support resources during detected
    -- distress conversations). Supports multilingual sentiment analysis.
    -- Feature Reference: AI02 (Sentiment Analysis), SAF03 (Emotional Safety), NLP01 (Natural Language Processing)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.chat_sentiment_analysis (
        analysis_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        message_id UUID NOT NULL,
        conversation_id UUID NOT NULL,
        user_id UUID NOT NULL,

        -- Sentiment scores
        sentiment_label VARCHAR(20) CHECK (
            sentiment_label IN ('POSITIVE', 'NEGATIVE', 'NEUTRAL', 'MIXED', 'VERY_POSITIVE', 'VERY_NEGATIVE')
        ),
        sentiment_score NUMERIC(5,2) CHECK (sentiment_score >= -1 AND sentiment_score <= 1),
        confidence_score NUMERIC(5,2) DEFAULT 0.0 CHECK (confidence_score >= 0 AND confidence_score <= 100),

        -- Emotion detection
        emotion_labels VARCHAR(50)[] DEFAULT '{}',
        emotion_scores JSONB DEFAULT '{}',
        dominant_emotion VARCHAR(50),

        -- Toxicity and safety
        toxicity_score NUMERIC(5,2) DEFAULT 0.0 CHECK (toxicity_score >= 0 AND toxicity_score <= 100),
        toxicity_categories JSONB DEFAULT '{}',
        safety_score NUMERIC(5,2) DEFAULT 100.0 CHECK (safety_score >= 0 AND safety_score <= 100),

        -- Keyword extraction
        keywords VARCHAR(100)[] DEFAULT '{}',
        keyword_scores JSONB DEFAULT '{}',
        entities JSONB DEFAULT '[]',

        -- Content analysis
        language_detected VARCHAR(10),
        text_complexity_score NUMERIC(5,2) CHECK (text_complexity_score >= 0 AND text_complexity_score <= 100),
        readability_score NUMERIC(5,2) CHECK (readability_score >= 0 AND readability_score <= 100),

        -- Intent detection
        intent_label VARCHAR(50),
        intent_confidence NUMERIC(5,2) CHECK (intent_confidence >= 0 AND intent_confidence <= 100),
        intent_categories VARCHAR(50)[] DEFAULT '{}',

        -- Urgency and importance
        urgency_score NUMERIC(5,2) DEFAULT 0.0 CHECK (urgency_score >= 0 AND urgency_score <= 100),
        importance_score NUMERIC(5,2) DEFAULT 0.0 CHECK (importance_score >= 0 AND importance_score <= 100),
        requires_attention BOOLEAN DEFAULT FALSE,

        -- Context analysis
        context_scores JSONB DEFAULT '{}',
        topic_categories VARCHAR(50)[] DEFAULT '{}',
        conversation_context JSONB,

        -- Model information
        model_version VARCHAR(50),
        analysis_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        processing_time_ms NUMERIC(10,2),

        -- Historical comparison
        previous_sentiment_score NUMERIC(5,2),
        sentiment_delta NUMERIC(5,2),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID DEFAULT uuid_nil(),
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_chat_sentiment_analysis_message FOREIGN KEY (message_id)
            REFERENCES socialcandor_schema.conversations_messages(message_id) ON DELETE CASCADE,
        CONSTRAINT fk_chat_sentiment_analysis_conversation FOREIGN KEY (conversation_id)
            REFERENCES socialcandor_schema.conversations(conversation_id) ON DELETE CASCADE,
        CONSTRAINT fk_chat_sentiment_analysis_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT chk_sentiment_consistency CHECK (
            (sentiment_score >= 0.3 AND sentiment_label IN ('POSITIVE', 'VERY_POSITIVE')) OR
            (sentiment_score <= -0.3 AND sentiment_label IN ('NEGATIVE', 'VERY_NEGATIVE')) OR
            (sentiment_score > -0.3 AND sentiment_score < 0.3 AND sentiment_label = 'NEUTRAL') OR
            sentiment_label = 'MIXED' OR
            sentiment_label IS NULL
        ),
        CONSTRAINT chk_toxicity_threshold CHECK (
            (toxicity_score < 70 OR requires_attention = TRUE) OR
            toxicity_score >= 70
        )
    );

    COMMENT ON TABLE socialcandor_schema.chat_sentiment_analysis IS 'Message-level sentiment scoring with toxicity detection and keyword extraction';
    COMMENT ON COLUMN socialcandor_schema.chat_sentiment_analysis.entities IS 'Named entity recognition results (people, places, organizations)';

    -- Indexes for chat_sentiment_analysis
    CREATE INDEX IF NOT EXISTS idx_chat_sentiment_analysis_message ON socialcandor_schema.chat_sentiment_analysis(message_id);
    CREATE INDEX IF NOT EXISTS idx_chat_sentiment_analysis_conversation ON socialcandor_schema.chat_sentiment_analysis(conversation_id);
    CREATE INDEX IF NOT EXISTS idx_chat_sentiment_analysis_user ON socialcandor_schema.chat_sentiment_analysis(user_id);
    CREATE INDEX IF NOT EXISTS idx_chat_sentiment_analysis_sentiment ON socialcandor_schema.chat_sentiment_analysis(sentiment_score);
    CREATE INDEX IF NOT EXISTS idx_chat_sentiment_analysis_toxicity ON socialcandor_schema.chat_sentiment_analysis(toxicity_score DESC);
    CREATE INDEX IF NOT EXISTS idx_chat_sentiment_analysis_attention ON socialcandor_schema.chat_sentiment_analysis(requires_attention) WHERE requires_attention = TRUE;
    CREATE INDEX IF NOT EXISTS idx_chat_sentiment_analysis_timestamp ON socialcandor_schema.chat_sentiment_analysis(analysis_timestamp DESC);

    -- Trigger for updated_at
    CREATE TRIGGER trg_chat_sentiment_analysis_updated_at
        BEFORE UPDATE ON socialcandor_schema.chat_sentiment_analysis
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 72 - chat_response_times
    -- Description: Inter-message response latency tracking for conversation health
    -- Business Case: Identifies abandoned conversations for re-engagement prompts while
    -- enabling response time SLAs for business messaging use cases (e.g., customer support).
    -- Supports automated follow-up and conversation health monitoring.
    -- Feature Reference: ENG05 (Response Analytics), CS01 (Customer Service), RET02 (Retention)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.chat_response_times (
        response_time_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        conversation_id UUID NOT NULL,
        message_id UUID NOT NULL,
        responding_to_message_id UUID,
        user_id UUID NOT NULL,
        responding_user_id UUID,

        -- Timing metrics
        message_timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
        response_timestamp TIMESTAMP WITH TIME ZONE,
        response_time_ms BIGINT CHECK (response_time_ms >= 0),
        response_time_seconds NUMERIC(10,2) GENERATED ALWAYS AS (response_time_ms::NUMERIC / 1000.0) STORED,
        response_time_minutes NUMERIC(10,2) GENERATED ALWAYS AS (response_time_ms::NUMERIC / 60000.0) STORED,

        -- Response classification
        response_type VARCHAR(20) CHECK (
            response_type IN ('FIRST_RESPONSE', 'SUBSEQUENT_RESPONSE', 'FINAL_RESPONSE', 'NO_RESPONSE')
        ),
        is_initial_response BOOLEAN,
        is_final_response BOOLEAN,

        -- Conversation context
        conversation_stage VARCHAR(20) CHECK (
            conversation_stage IN ('INITIATION', 'ENGAGEMENT', 'RESOLUTION', 'CLOSURE', 'FOLLOW_UP')
        ),
        message_position_in_thread INTEGER CHECK (message_position_in_thread >= 1),

        -- Performance metrics
        within_sla BOOLEAN,
        sla_threshold_ms BIGINT CHECK (sla_threshold_ms >= 0),
        sla_violation_severity VARCHAR(20) CHECK (
            sla_violation_severity IN ('NONE', 'MINOR', 'MODERATE', 'MAJOR', 'CRITICAL')
        ),

        -- User engagement
        user_response_pattern VARCHAR(50),
        average_user_response_time_ms BIGINT CHECK (average_user_response_time_ms >= 0),

        -- Conversation health
        conversation_abandoned BOOLEAN DEFAULT FALSE,
        abandonment_duration_ms BIGINT CHECK (abandonment_duration_ms >= 0),
        reengagement_attempted BOOLEAN DEFAULT FALSE,

        -- Business context
        business_hours_response BOOLEAN,
        outside_hours_multiplier NUMERIC(5,2) DEFAULT 1.0,

        -- Analysis metadata
        analyzed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        analysis_window_hours INTEGER DEFAULT 24 CHECK (analysis_window_hours >= 1),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID DEFAULT uuid_nil(),
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_chat_response_times_conversation FOREIGN KEY (conversation_id)
            REFERENCES socialcandor_schema.conversations(conversation_id) ON DELETE CASCADE,
        CONSTRAINT fk_chat_response_times_message FOREIGN KEY (message_id)
            REFERENCES socialcandor_schema.conversations_messages(message_id) ON DELETE CASCADE,
        CONSTRAINT fk_chat_response_times_responding_to FOREIGN KEY (responding_to_message_id)
            REFERENCES socialcandor_schema.conversations_messages(message_id) ON DELETE SET NULL,
        CONSTRAINT fk_chat_response_times_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_chat_response_times_responding_user FOREIGN KEY (responding_user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_response_timestamps CHECK (
            (response_timestamp IS NULL) OR
            (response_timestamp >= message_timestamp)
        ),
        CONSTRAINT chk_response_time_calculation CHECK (
            (response_time_ms IS NULL AND response_timestamp IS NULL) OR
            (response_time_ms IS NOT NULL AND response_timestamp IS NOT NULL)
        ),
        CONSTRAINT chk_sla_consistency CHECK (
            (within_sla IS NULL AND sla_threshold_ms IS NULL) OR
            (within_sla IS NOT NULL AND sla_threshold_ms IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.chat_response_times IS 'Inter-message response latency tracking for conversation health monitoring';
    COMMENT ON COLUMN socialcandor_schema.chat_response_times.conversation_stage IS 'Stage of conversation when response occurred';

    -- Indexes for chat_response_times
    CREATE INDEX IF NOT EXISTS idx_chat_response_times_conversation ON socialcandor_schema.chat_response_times(conversation_id);
    CREATE INDEX IF NOT EXISTS idx_chat_response_times_message ON socialcandor_schema.chat_response_times(message_id);
    CREATE INDEX IF NOT EXISTS idx_chat_response_times_user ON socialcandor_schema.chat_response_times(user_id);
    CREATE INDEX IF NOT EXISTS idx_chat_response_times_response_time ON socialcandor_schema.chat_response_times(response_time_ms);
    CREATE INDEX IF NOT EXISTS idx_chat_response_times_sla ON socialcandor_schema.chat_response_times(within_sla) WHERE within_sla = FALSE;
    CREATE INDEX IF NOT EXISTS idx_chat_response_times_abandoned ON socialcandor_schema.chat_response_times(conversation_abandoned) WHERE conversation_abandoned = TRUE;
    CREATE INDEX IF NOT EXISTS idx_chat_response_times_timestamp ON socialcandor_schema.chat_response_times(message_timestamp DESC);

    -- Materialized view for conversation response analytics
    CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_conversation_response_analytics AS
    SELECT
        conversation_id,
        COUNT(*) as total_messages,
        COUNT(*) FILTER (WHERE response_time_ms IS NOT NULL) as responded_messages,
        COUNT(*) FILTER (WHERE response_time_ms IS NULL) as unanswered_messages,
        AVG(response_time_ms) FILTER (WHERE response_time_ms IS NOT NULL) as avg_response_time_ms,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY response_time_ms) FILTER (WHERE response_time_ms IS NOT NULL) as median_response_time_ms,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY response_time_ms) FILTER (WHERE response_time_ms IS NOT NULL) as p95_response_time_ms,
        MAX(response_time_ms) as max_response_time_ms,
        COUNT(*) FILTER (WHERE within_sla = FALSE) as sla_violations,
        COUNT(*) FILTER (WHERE conversation_abandoned = TRUE) as abandoned_conversations,
        MAX(message_timestamp) as last_message_time
    FROM socialcandor_schema.chat_response_times
    WHERE message_timestamp >= CURRENT_TIMESTAMP - INTERVAL '7 days'
    GROUP BY conversation_id
    WITH DATA;

    CREATE UNIQUE INDEX idx_mv_conversation_response_analytics_id ON socialcandor_schema.mv_conversation_response_analytics(conversation_id);

    -- Trigger for updated_at
    CREATE TRIGGER trg_chat_response_times_updated_at
        BEFORE UPDATE ON socialcandor_schema.chat_response_times
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 73 - ab_test_experiments
    -- Description: Experiment metadata with activation controls and date ranges
    -- Business Case: Enables data-driven product development through rigorous hypothesis
    -- testing while preventing conflicting experiments through mutual exclusion groups.
    -- Supports A/B/n testing, multivariate testing, and phased rollouts.
    -- Feature Reference: EXP01 (Experiment Management), PROD01 (Product Testing), ANAL01 (A/B Testing)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.ab_test_experiments (
        experiment_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Experiment identification
        experiment_name VARCHAR(200) NOT NULL UNIQUE,
        experiment_description TEXT NOT NULL,
        experiment_code VARCHAR(50) UNIQUE,

        -- Hypothesis and goals
        hypothesis TEXT NOT NULL,
        primary_metric VARCHAR(200) NOT NULL,
        secondary_metrics VARCHAR(200)[] DEFAULT '{}',
        success_criteria TEXT,
        business_impact_estimate VARCHAR(500),

        -- Configuration
        experiment_type VARCHAR(20) NOT NULL DEFAULT 'AB_TEST' CHECK (
            experiment_type IN ('AB_TEST', 'MULTIVARIATE', 'BANDIT', 'FEATURE_FLAG', 'PILOT')
        ),
        traffic_allocation_percentage NUMERIC(5,2) DEFAULT 100.0 CHECK (
            traffic_allocation_percentage >= 0 AND traffic_allocation_percentage <= 100
        ),
        targeting_rules JSONB DEFAULT '{}',
        exclusion_groups VARCHAR(50)[] DEFAULT '{}',

        -- Scheduling
        start_date TIMESTAMP WITH TIME ZONE NOT NULL,
        end_date TIMESTAMP WITH TIME ZONE,
        is_active BOOLEAN DEFAULT FALSE,
        activation_status VARCHAR(20) DEFAULT 'DRAFT' CHECK (
            activation_status IN ('DRAFT', 'SCHEDULED', 'ACTIVE', 'PAUSED', 'COMPLETED', 'CANCELLED')
        ),

        -- Statistical configuration
        significance_level NUMERIC(5,4) DEFAULT 0.05 CHECK (significance_level > 0 AND significance_level < 1),
        statistical_power NUMERIC(5,4) DEFAULT 0.80 CHECK (statistical_power > 0 AND statistical_power < 1),
        minimum_detectable_effect NUMERIC(5,4) CHECK (minimum_detectable_effect > 0),
        sample_size_per_variant INTEGER CHECK (sample_size_per_variant >= 1),

        -- Audience segmentation
        target_audience JSONB DEFAULT '{}',
        audience_size_estimate INTEGER,
        inclusion_criteria TEXT,
        exclusion_criteria TEXT,

        -- Risk assessment
        risk_level VARCHAR(20) DEFAULT 'LOW' CHECK (
            risk_level IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')
        ),
        rollback_plan TEXT,
        monitoring_plan TEXT,

        -- Team and ownership
        product_owner UUID,
        data_scientist UUID,
        engineering_lead UUID,
        stakeholder_emails VARCHAR(255)[] DEFAULT '{}',

        -- Results and analysis
        results_summary TEXT,
        winning_variant_id UUID,
        recommendation VARCHAR(20) CHECK (
            recommendation IN ('LAUNCH', 'ITERATE', 'KILL', 'INCONCLUSIVE', 'NEEDS_MORE_DATA')
        ),
        confidence_level NUMERIC(5,4),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),
        approved_at TIMESTAMP WITH TIME ZONE,
        approved_by UUID,

        -- Constraints
        CONSTRAINT chk_experiment_dates CHECK (
            (end_date IS NULL) OR
            (end_date > start_date)
        ),
        CONSTRAINT chk_activation_status_dates CHECK (
            (activation_status = 'ACTIVE' AND is_active = TRUE) OR
            (activation_status != 'ACTIVE' AND is_active = FALSE) OR
            activation_status IS NULL
        ),
        CONSTRAINT chk_sample_size_valid CHECK (
            (sample_size_per_variant IS NULL) OR
            (sample_size_per_variant >= 100)
        )
    );

    COMMENT ON TABLE socialcandor_schema.ab_test_experiments IS 'Experiment metadata with comprehensive configuration for A/B testing';
    COMMENT ON COLUMN socialcandor_schema.ab_test_experiments.traffic_allocation_percentage IS 'Percentage of eligible traffic to include in experiment';

    -- Indexes for ab_test_experiments
    CREATE INDEX IF NOT EXISTS idx_ab_test_experiments_name ON socialcandor_schema.ab_test_experiments(experiment_name);
    CREATE INDEX IF NOT EXISTS idx_ab_test_experiments_status ON socialcandor_schema.ab_test_experiments(activation_status);
    CREATE INDEX IF NOT EXISTS idx_ab_test_experiments_active ON socialcandor_schema.ab_test_experiments(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_ab_test_experiments_dates ON socialcandor_schema.ab_test_experiments(start_date, end_date);
    CREATE INDEX IF NOT EXISTS idx_ab_test_experiments_created_by ON socialcandor_schema.ab_test_experiments(created_by);
    CREATE INDEX IF NOT EXISTS idx_ab_test_experiments_type ON socialcandor_schema.ab_test_experiments(experiment_type);

    -- Trigger for updated_at
    CREATE TRIGGER trg_ab_test_experiments_updated_at
        BEFORE UPDATE ON socialcandor_schema.ab_test_experiments
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 74 - ab_test_variants
    -- Description: Experiment variants with allocation percentages and configuration
    -- Business Case: Supports multi-variant testing beyond simple A/B while enabling
    -- gradual rollout through dynamic allocation percentage adjustment based on interim
    -- results. Manages variant configuration and traffic allocation.
    -- Feature Reference: EXP02 (Variant Management), ROLL01 (Gradual Rollout), CONFIG01 (Configuration)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.ab_test_variants (
        variant_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        experiment_id UUID NOT NULL,

        -- Variant identification
        variant_name VARCHAR(100) NOT NULL,
        variant_description TEXT,
        variant_type VARCHAR(20) DEFAULT 'TREATMENT' CHECK (
            variant_type IN ('CONTROL', 'TREATMENT', 'BASELINE', 'PLACEBO')
        ),
        variant_code VARCHAR(50),

        -- Configuration
        configuration JSONB NOT NULL DEFAULT '{}',
        feature_flags VARCHAR(100)[] DEFAULT '{}',
        ui_changes JSONB DEFAULT '{}',
        backend_changes JSONB DEFAULT '{}',

        -- Traffic allocation
        allocation_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (
            allocation_percentage >= 0 AND allocation_percentage <= 100
        ),
        minimum_allocation NUMERIC(5,2) DEFAULT 0.0 CHECK (minimum_allocation >= 0),
        maximum_allocation NUMERIC(5,2) DEFAULT 100.0 CHECK (maximum_allocation <= 100),

        -- Targeting rules
        targeting_overrides JSONB DEFAULT '{}',
        eligibility_criteria TEXT,
        exclusion_criteria TEXT,

        -- Performance metrics
        sample_size INTEGER DEFAULT 0 CHECK (sample_size >= 0),
        conversion_rate NUMERIC(10,6),
        confidence_interval_lower NUMERIC(10,6),
        confidence_interval_upper NUMERIC(10,6),

        -- Statistical significance
        p_value NUMERIC(10,6),
        is_statistically_significant BOOLEAN,
        significance_direction VARCHAR(20) CHECK (
            significance_direction IN ('POSITIVE', 'NEGATIVE', 'NEUTRAL', 'INCONCLUSIVE')
        ),

        -- Business impact
        estimated_impact_percentage NUMERIC(10,2),
        confidence_in_estimate NUMERIC(5,2) CHECK (confidence_in_estimate >= 0 AND confidence_in_estimate <= 100),
        risk_assessment VARCHAR(500),

        -- Variant status
        is_active BOOLEAN DEFAULT TRUE,
        activation_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
            activation_status IN ('PENDING', 'ACTIVE', 'PAUSED', 'COMPLETED', 'REMOVED')
        ),

        -- Rollout information
        rollout_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (
            rollout_percentage >= 0 AND rollout_percentage <= 100
        ),
        rollout_started_at TIMESTAMP WITH TIME ZONE,
        rollout_completed_at TIMESTAMP WITH TIME ZONE,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_ab_test_variants_experiment FOREIGN KEY (experiment_id)
            REFERENCES socialcandor_schema.ab_test_experiments(experiment_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_ab_test_variants_experiment_name UNIQUE (experiment_id, variant_name),
        CONSTRAINT chk_allocation_limits CHECK (
            minimum_allocation <= maximum_allocation
        ),
        CONSTRAINT chk_variant_type_allocation CHECK (
            (variant_type = 'CONTROL' AND allocation_percentage > 0) OR
            variant_type != 'CONTROL'
        ),
        CONSTRAINT chk_rollout_percentage CHECK (
            rollout_percentage <= allocation_percentage
        )
    );

    COMMENT ON TABLE socialcandor_schema.ab_test_variants IS 'Experiment variants with configuration and traffic allocation management';
    COMMENT ON COLUMN socialcandor_schema.ab_test_variants.configuration IS 'JSON configuration for variant-specific settings';

    -- Indexes for ab_test_variants
    CREATE INDEX IF NOT EXISTS idx_ab_test_variants_experiment ON socialcandor_schema.ab_test_variants(experiment_id);
    CREATE INDEX IF NOT EXISTS idx_ab_test_variants_type ON socialcandor_schema.ab_test_variants(variant_type);
    CREATE INDEX IF NOT EXISTS idx_ab_test_variants_active ON socialcandor_schema.ab_test_variants(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_ab_test_variants_allocation ON socialcandor_schema.ab_test_variants(allocation_percentage DESC);
    CREATE INDEX IF NOT EXISTS idx_ab_test_variants_rollout ON socialcandor_schema.ab_test_variants(rollout_percentage DESC) WHERE rollout_percentage > 0;

    -- Trigger to ensure allocation percentages sum to 100
    CREATE OR REPLACE FUNCTION socialcandor_schema.validate_variant_allocation()
    RETURNS TRIGGER AS $$
    DECLARE
        v_total_allocation NUMERIC;
        v_experiment_id UUID;
    BEGIN
        IF TG_OP = 'INSERT' THEN
            v_experiment_id := NEW.experiment_id;
        ELSE
            v_experiment_id := COALESCE(NEW.experiment_id, OLD.experiment_id);
        END IF;

        SELECT SUM(allocation_percentage)
        INTO v_total_allocation
        FROM socialcandor_schema.ab_test_variants
        WHERE experiment_id = v_experiment_id
        AND variant_id != COALESCE(NEW.variant_id, '00000000-0000-0000-0000-000000000000'::UUID);

        v_total_allocation := COALESCE(v_total_allocation, 0) + COALESCE(NEW.allocation_percentage, 0);

        IF v_total_allocation > 100.01 THEN -- Allow small floating point rounding errors
            RAISE EXCEPTION 'Total allocation percentage cannot exceed 100% (current: %)', v_total_allocation;
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_ab_test_variants_allocation
        BEFORE INSERT OR UPDATE OF allocation_percentage ON socialcandor_schema.ab_test_variants
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.validate_variant_allocation();

    -- Trigger for updated_at
    CREATE TRIGGER trg_ab_test_variants_updated_at
        BEFORE UPDATE ON socialcandor_schema.ab_test_variants
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

  

------------------------------------------------------------------------------------------------
-- Table: 75 - ab_test_assignments
-- Description: User-to-variant mappings with assignment timestamps
-- Business Case: Ensures consistent user experience throughout experiment duration while
-- preventing test pollution through cookie-less persistent assignment using user UUIDs.
-- Supports sticky assignments and cross-device consistency.
-- Feature Reference: EXP03 (Assignment Tracking), CONS01 (Consistency), USER01 (User Experience)
------------------------------------------------------------------------------------------------

-- Create the update_updated_at_column function if it doesn't exist
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Create ab_test_experiments table first (referenced by variants)
CREATE TABLE IF NOT EXISTS socialcandor_schema.ab_test_experiments (
    experiment_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    experiment_name VARCHAR(100) NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'DRAFT' CHECK (
        status IN ('DRAFT', 'ACTIVE', 'PAUSED', 'COMPLETED', 'ARCHIVED')
    ),
    start_date TIMESTAMP WITH TIME ZONE,
    end_date TIMESTAMP WITH TIME ZONE,
    target_audience JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_by UUID
);

-- Create ab_test_variants table (referenced by assignments)
CREATE TABLE IF NOT EXISTS socialcandor_schema.ab_test_variants (
    variant_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    experiment_id UUID NOT NULL,
    variant_name VARCHAR(50) NOT NULL,
    variant_description VARCHAR(200),
    variant_type VARCHAR(20) DEFAULT 'CONTROL' CHECK (
        variant_type IN ('CONTROL', 'TREATMENT', 'EXPERIMENTAL')
    ),
    configuration JSONB DEFAULT '{}',
    allocation_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (
        allocation_percentage >= 0 AND allocation_percentage <= 100
    ),
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_by UUID,
    
    CONSTRAINT fk_ab_test_variants_experiment FOREIGN KEY (experiment_id)
        REFERENCES socialcandor_schema.ab_test_experiments(experiment_id) ON DELETE CASCADE,
    CONSTRAINT uk_ab_test_variants_experiment_name UNIQUE (experiment_id, variant_name)
);

-- Create users table (referenced by assignments)
CREATE TABLE IF NOT EXISTS socialcandor_schema.users (
    user_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Create users_sessions table (referenced by assignments)
CREATE TABLE IF NOT EXISTS socialcandor_schema.users_sessions (
    session_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,
    started_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    ended_at TIMESTAMP WITH TIME ZONE,
    device_info JSONB DEFAULT '{}',
    
    CONSTRAINT fk_users_sessions_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE
);



CREATE TABLE IF NOT EXISTS socialcandor_schema.ab_test_assignments (
    assignment_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    experiment_id UUID NOT NULL,
    variant_id UUID NOT NULL,
    user_id UUID NOT NULL,

    -- Assignment details
    assignment_method VARCHAR(20) DEFAULT 'RANDOM' CHECK (
        assignment_method IN ('RANDOM', 'HASH_BASED', 'MANUAL', 'SEGMENT_BASED', 'PREFERENCE')
    ),
    assignment_reason VARCHAR(200),
    assignment_weight NUMERIC(5,2) DEFAULT 1.0 CHECK (assignment_weight >= 0),

    -- Timing
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    first_exposure_at TIMESTAMP WITH TIME ZONE,
    last_exposure_at TIMESTAMP WITH TIME ZONE,
    assignment_expires_at TIMESTAMP WITH TIME ZONE,

    -- Exposure tracking
    exposure_count INTEGER DEFAULT 0 CHECK (exposure_count >= 0),
    total_exposure_duration_seconds INTEGER DEFAULT 0 CHECK (total_exposure_duration_seconds >= 0),
    last_session_id UUID,

    -- User context
    device_id VARCHAR(255),
    device_type VARCHAR(50),
    assignment_context JSONB DEFAULT '{}',

    -- Quality metrics
    assignment_quality_score NUMERIC(5,2) DEFAULT 100.0 CHECK (
        assignment_quality_score >= 0 AND assignment_quality_score <= 100
    ),
    contamination_risk_score NUMERIC(5,2) DEFAULT 0.0 CHECK (
        contamination_risk_score >= 0 AND contamination_risk_score <= 100
    ),

    -- Assignment status
    is_active BOOLEAN DEFAULT TRUE,
    assignment_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
        assignment_status IN ('ACTIVE', 'COMPLETED', 'EXCLUDED', 'INVALID', 'MIGRATED')
    ),
    exclusion_reason VARCHAR(200),

    -- Cross-experiment tracking
    conflicting_experiment_ids UUID[] DEFAULT '{}',
    mutual_exclusion_group VARCHAR(50),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID DEFAULT uuid_nil(),
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_ab_test_assignments_experiment FOREIGN KEY (experiment_id)
        REFERENCES socialcandor_schema.ab_test_experiments(experiment_id) ON DELETE CASCADE,
    CONSTRAINT fk_ab_test_assignments_variant FOREIGN KEY (variant_id)
        REFERENCES socialcandor_schema.ab_test_variants(variant_id) ON DELETE CASCADE,
    CONSTRAINT fk_ab_test_assignments_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_ab_test_assignments_session FOREIGN KEY (last_session_id)
        REFERENCES socialcandor_schema.users_sessions(session_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT uk_ab_test_assignments_user_experiment UNIQUE (experiment_id, user_id),
    CONSTRAINT chk_exposure_timestamps CHECK (
        (first_exposure_at IS NULL AND last_exposure_at IS NULL) OR
        (first_exposure_at IS NOT NULL AND last_exposure_at >= first_exposure_at)
    ),
    CONSTRAINT chk_assignment_expiry CHECK (
        (assignment_expires_at IS NULL) OR
        (assignment_expires_at > assigned_at)
    )
);

COMMENT ON TABLE socialcandor_schema.ab_test_assignments IS 'User-to-variant mappings ensuring consistent experiment assignment';
COMMENT ON COLUMN socialcandor_schema.ab_test_assignments.contamination_risk_score IS 'Risk score for experimental contamination';

-- Indexes for ab_test_assignments
CREATE INDEX IF NOT EXISTS idx_ab_test_assignments_experiment ON socialcandor_schema.ab_test_assignments(experiment_id);
CREATE INDEX IF NOT EXISTS idx_ab_test_assignments_variant ON socialcandor_schema.ab_test_assignments(variant_id);
CREATE INDEX IF NOT EXISTS idx_ab_test_assignments_user ON socialcandor_schema.ab_test_assignments(user_id);
CREATE INDEX IF NOT EXISTS idx_ab_test_assignments_active ON socialcandor_schema.ab_test_assignments(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_ab_test_assignments_assigned_at ON socialcandor_schema.ab_test_assignments(assigned_at DESC);
CREATE INDEX IF NOT EXISTS idx_ab_test_assignments_exposure ON socialcandor_schema.ab_test_assignments(exposure_count DESC);
CREATE INDEX IF NOT EXISTS idx_ab_test_assignments_expiry ON socialcandor_schema.ab_test_assignments(assignment_expires_at) WHERE assignment_expires_at IS NOT NULL;

-- Trigger for updated_at
DROP TRIGGER IF EXISTS trg_ab_test_assignments_updated_at ON socialcandor_schema.ab_test_assignments;
CREATE TRIGGER trg_ab_test_assignments_updated_at
    BEFORE UPDATE ON socialcandor_schema.ab_test_assignments
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Add triggers for other tables
DROP TRIGGER IF EXISTS trg_ab_test_experiments_updated_at ON socialcandor_schema.ab_test_experiments;
CREATE TRIGGER trg_ab_test_experiments_updated_at
    BEFORE UPDATE ON socialcandor_schema.ab_test_experiments
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

DROP TRIGGER IF EXISTS trg_ab_test_variants_updated_at ON socialcandor_schema.ab_test_variants;
CREATE TRIGGER trg_ab_test_variants_updated_at
    BEFORE UPDATE ON socialcandor_schema.ab_test_variants
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

DROP TRIGGER IF EXISTS trg_users_updated_at ON socialcandor_schema.users;
CREATE TRIGGER trg_users_updated_at
    BEFORE UPDATE ON socialcandor_schema.users
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 76 - ab_test_metrics
    -- Description: Experiment success metric definitions with aggregation logic
    -- Business Case: Enables standardized metric calculation across experiments while
    -- preventing p-hacking through pre-registered metric definitions before experiment launch.
    -- Supports complex metric definitions and aggregation rules.
    -- Feature Reference: EXP04 (Metric Definition), ANAL02 (Statistical Analysis), GOV01 (Governance)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.ab_test_metrics (
        metric_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        experiment_id UUID NOT NULL,

        -- Metric identification
        metric_name VARCHAR(200) NOT NULL,
        metric_description TEXT NOT NULL,
        metric_category VARCHAR(50) CHECK (
            metric_category IN ('ENGAGEMENT', 'REVENUE', 'RETENTION', 'PERFORMANCE', 'QUALITY', 'SAFETY')
        ),
        metric_type VARCHAR(20) DEFAULT 'CONTINUOUS' CHECK (
            metric_type IN ('CONTINUOUS', 'BINARY', 'COUNT', 'RATIO', 'DURATION')
        ),

        -- Calculation definition
        calculation_sql TEXT,
        aggregation_function VARCHAR(50) DEFAULT 'AVG' CHECK (
            aggregation_function IN ('SUM', 'AVG', 'COUNT', 'MIN', 'MAX', 'MEDIAN', 'PERCENTILE')
        ),
        window_days INTEGER DEFAULT 7 CHECK (window_days >= 1),

        -- Data source
        source_table VARCHAR(100),
        source_column VARCHAR(100),
        join_conditions TEXT,
        where_clause TEXT,

        -- Statistical configuration
        is_primary BOOLEAN DEFAULT FALSE,
        direction_of_improvement VARCHAR(10) CHECK (
            direction_of_improvement IN ('INCREASE', 'DECREASE', 'ANY')
        ),
        minimum_effect_size NUMERIC(10,4),
        expected_baseline_value NUMERIC(15,4),

        -- Guardrail metrics
        is_guardrail BOOLEAN DEFAULT FALSE,
        guardrail_threshold NUMERIC(15,4),
        guardrail_direction VARCHAR(10) CHECK (
            guardrail_direction IN ('ABOVE', 'BELOW', 'WITHIN')
        ),

        -- Quality metrics
        data_quality_rules JSONB DEFAULT '{}',
        outlier_handling VARCHAR(50) DEFAULT 'INCLUDE' CHECK (
            outlier_handling IN ('INCLUDE', 'EXCLUDE', 'WINSORIZE', 'TRUNCATE')
        ),
        missing_data_handling VARCHAR(50) DEFAULT 'EXCLUDE' CHECK (
            missing_data_handling IN ('INCLUDE', 'EXCLUDE', 'IMPUTE')
        ),

        -- Performance tracking
        calculation_complexity VARCHAR(20) DEFAULT 'LOW' CHECK (
            calculation_complexity IN ('LOW', 'MEDIUM', 'HIGH')
        ),
        expected_runtime_seconds NUMERIC(10,2),
        last_calculated_at TIMESTAMP WITH TIME ZONE,

        -- Metric status
        is_active BOOLEAN DEFAULT TRUE,
        metric_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
            metric_status IN ('ACTIVE', 'DEPRECATED', 'ARCHIVED', 'EXPERIMENTAL')
        ),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),
        approved_at TIMESTAMP WITH TIME ZONE,
        approved_by UUID,

        -- Foreign key constraint
        CONSTRAINT fk_ab_test_metrics_experiment FOREIGN KEY (experiment_id)
            REFERENCES socialcandor_schema.ab_test_experiments(experiment_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_ab_test_metrics_experiment_name UNIQUE (experiment_id, metric_name),
        CONSTRAINT chk_calculation_valid CHECK (
            (calculation_sql IS NOT NULL AND calculation_sql != '') OR
            (source_table IS NOT NULL AND source_column IS NOT NULL)
        ),
        CONSTRAINT chk_guardrail_config CHECK (
            (is_guardrail = FALSE AND guardrail_threshold IS NULL) OR
            (is_guardrail = TRUE AND guardrail_threshold IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.ab_test_metrics IS 'Experiment success metric definitions with calculation logic';
    COMMENT ON COLUMN socialcandor_schema.ab_test_metrics.calculation_sql IS 'SQL query or expression for metric calculation';

    -- Indexes for ab_test_metrics
    CREATE INDEX IF NOT EXISTS idx_ab_test_metrics_experiment ON socialcandor_schema.ab_test_metrics(experiment_id);
    CREATE INDEX IF NOT EXISTS idx_ab_test_metrics_primary ON socialcandor_schema.ab_test_metrics(is_primary) WHERE is_primary = TRUE;
    CREATE INDEX IF NOT EXISTS idx_ab_test_metrics_category ON socialcandor_schema.ab_test_metrics(metric_category);
    CREATE INDEX IF NOT EXISTS idx_ab_test_metrics_type ON socialcandor_schema.ab_test_metrics(metric_type);
    CREATE INDEX IF NOT EXISTS idx_ab_test_metrics_active ON socialcandor_schema.ab_test_metrics(is_active) WHERE is_active = TRUE;

    -- Trigger for updated_at
    CREATE TRIGGER trg_ab_test_metrics_updated_at
        BEFORE UPDATE ON socialcandor_schema.ab_test_metrics
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 77 - ab_test_results
    -- Description: Calculated experiment results with statistical significance indicators
    -- Business Case: Provides self-serve experiment analysis for product teams while enabling
    -- meta-analysis of historical experiments to identify high-impact feature categories.
    -- Supports comprehensive statistical analysis and business impact assessment.
    -- Feature Reference: EXP05 (Results Analysis), STAT01 (Statistical Analysis), DEC01 (Decision Support)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.ab_test_results (
        result_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        experiment_id UUID NOT NULL,
        variant_id UUID NOT NULL,
        metric_id UUID NOT NULL,

        -- Sample statistics
        sample_size INTEGER NOT NULL CHECK (sample_size >= 0),
        exposed_users INTEGER CHECK (exposed_users >= 0),
        converted_users INTEGER CHECK (converted_users >= 0),

        -- Metric values
        metric_value NUMERIC(15,6),
        baseline_value NUMERIC(15,6),
        lift_percentage NUMERIC(10,4),
        absolute_difference NUMERIC(15,6),

        -- Statistical significance
        p_value NUMERIC(10,6) CHECK (p_value >= 0 AND p_value <= 1),
        confidence_interval_lower NUMERIC(15,6),
        confidence_interval_upper NUMERIC(15,6),
        confidence_level NUMERIC(5,4) DEFAULT 0.95 CHECK (confidence_level > 0 AND confidence_level < 1),

        -- Statistical power
        statistical_power NUMERIC(5,4) CHECK (statistical_power >= 0 AND statistical_power <= 1),
        required_sample_size INTEGER CHECK (required_sample_size >= 0),

        -- Significance flags
        is_statistically_significant BOOLEAN,
        significance_level NUMERIC(5,4) DEFAULT 0.05 CHECK (significance_level > 0 AND significance_level < 1),
        practical_significance BOOLEAN,

        -- Effect size
        effect_size NUMERIC(10,6),
        effect_size_category VARCHAR(20) CHECK (
            effect_size_category IN ('NEGLIGIBLE', 'SMALL', 'MEDIUM', 'LARGE', 'VERY_LARGE')
        ),
        cohens_d NUMERIC(10,6),

        -- Bayesian statistics (if applicable)
        bayesian_probability NUMERIC(5,4) CHECK (bayesian_probability >= 0 AND bayesian_probability <= 1),
        bayes_factor NUMERIC(10,4),

        -- Business impact
        estimated_impact NUMERIC(20,2),
        impact_currency CHAR(3) DEFAULT 'USD',
        impact_confidence NUMERIC(5,2) CHECK (impact_confidence >= 0 AND impact_confidence <= 100),

        -- Segment analysis
        segment_name VARCHAR(100),
        segment_value VARCHAR(100),
        segment_sample_size INTEGER CHECK (segment_sample_size >= 0),

        -- Time series data
        result_date DATE,
        cumulative BOOLEAN DEFAULT TRUE,
        time_period VARCHAR(20) CHECK (
            time_period IN ('DAILY', 'WEEKLY', 'CUMULATIVE', 'FINAL')
        ),

        -- Quality metrics
        standard_error NUMERIC(15,6),
        variance NUMERIC(15,6),
        data_quality_score NUMERIC(5,2) CHECK (data_quality_score >= 0 AND data_quality_score <= 100),

        -- Analysis metadata
        analyzed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        analysis_method VARCHAR(50) DEFAULT 'FREQUENTIST' CHECK (
            analysis_method IN ('FREQUENTIST', 'BAYESIAN', 'SEQUENTIAL', 'BOOTSTRAP')
        ),
        analysis_parameters JSONB DEFAULT '{}',

        -- Result status
        is_primary_result BOOLEAN DEFAULT FALSE,
        result_status VARCHAR(20) DEFAULT 'CALCULATED' CHECK (
            result_status IN ('CALCULATED', 'REVIEWED', 'APPROVED', 'REJECTED', 'INVALID')
        ),
        reviewer_notes TEXT,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID DEFAULT uuid_nil(),
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_ab_test_results_experiment FOREIGN KEY (experiment_id)
            REFERENCES socialcandor_schema.ab_test_experiments(experiment_id) ON DELETE CASCADE,
        CONSTRAINT fk_ab_test_results_variant FOREIGN KEY (variant_id)
            REFERENCES socialcandor_schema.ab_test_variants(variant_id) ON DELETE CASCADE,
        CONSTRAINT fk_ab_test_results_metric FOREIGN KEY (metric_id)
            REFERENCES socialcandor_schema.ab_test_metrics(metric_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT chk_conversions_valid CHECK (
            converted_users <= exposed_users
        ),
        CONSTRAINT chk_confidence_interval CHECK (
            (confidence_interval_lower IS NULL AND confidence_interval_upper IS NULL) OR
            (confidence_interval_lower IS NOT NULL AND confidence_interval_upper IS NOT NULL AND
             confidence_interval_upper >= confidence_interval_lower)
        ),
        CONSTRAINT chk_lift_calculation CHECK (
            (lift_percentage IS NULL AND baseline_value IS NULL) OR
            (lift_percentage IS NOT NULL AND baseline_value IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.ab_test_results IS 'Calculated experiment results with comprehensive statistical analysis';
    COMMENT ON COLUMN socialcandor_schema.ab_test_results.bayesian_probability IS 'Probability that variant is better than control (Bayesian)';

    -- Indexes for ab_test_results
    CREATE INDEX IF NOT EXISTS idx_ab_test_results_experiment ON socialcandor_schema.ab_test_results(experiment_id);
    CREATE INDEX IF NOT EXISTS idx_ab_test_results_variant ON socialcandor_schema.ab_test_results(variant_id);
    CREATE INDEX IF NOT EXISTS idx_ab_test_results_metric ON socialcandor_schema.ab_test_results(metric_id);
    CREATE INDEX IF NOT EXISTS idx_ab_test_results_date ON socialcandor_schema.ab_test_results(result_date DESC);
    CREATE INDEX IF NOT EXISTS idx_ab_test_results_significant ON socialcandor_schema.ab_test_results(is_statistically_significant) WHERE is_statistically_significant = TRUE;
    CREATE INDEX IF NOT EXISTS idx_ab_test_results_lift ON socialcandor_schema.ab_test_results(lift_percentage DESC);
    CREATE INDEX IF NOT EXISTS idx_ab_test_results_primary ON socialcandor_schema.ab_test_results(is_primary_result) WHERE is_primary_result = TRUE;

    -- Materialized view for experiment summary
    CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_experiment_summary AS
    SELECT
        e.experiment_id,
        e.experiment_name,
        e.experiment_type,
        e.activation_status,
        e.start_date,
        e.end_date,
        COUNT(DISTINCT v.variant_id) as variant_count,
        COUNT(DISTINCT a.user_id) as assigned_users,
        COUNT(DISTINCT m.metric_id) as metric_count,
        COUNT(DISTINCT r.result_id) as result_count,
        MAX(r.analyzed_at) as last_analysis_at,
        BOOL_OR(r.is_statistically_significant) as any_significant_result,
        AVG(r.lift_percentage) FILTER (WHERE r.is_primary_result = TRUE) as avg_primary_lift
    FROM socialcandor_schema.ab_test_experiments e
    LEFT JOIN socialcandor_schema.ab_test_variants v ON e.experiment_id = v.experiment_id
    LEFT JOIN socialcandor_schema.ab_test_assignments a ON e.experiment_id = a.experiment_id AND a.is_active = TRUE
    LEFT JOIN socialcandor_schema.ab_test_metrics m ON e.experiment_id = m.experiment_id AND m.is_active = TRUE
    LEFT JOIN socialcandor_schema.ab_test_results r ON e.experiment_id = r.experiment_id AND r.is_primary_result = TRUE
    GROUP BY e.experiment_id, e.experiment_name, e.experiment_type, e.activation_status, e.start_date, e.end_date
    WITH DATA;

    CREATE UNIQUE INDEX idx_mv_experiment_summary_id ON socialcandor_schema.mv_experiment_summary(experiment_id);

    -- Trigger for updated_at
    CREATE TRIGGER trg_ab_test_results_updated_at
        BEFORE UPDATE ON socialcandor_schema.ab_test_results
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 78 - chat_encryption_keys
    -- Description: End-to-end encryption key storage with key derivation parameters
    -- Business Case: Enables secure messaging with forward secrecy while maintaining
    -- key recovery capabilities through social recovery mechanismsâcritical for privacy
    -- compliance and user trust in messaging platforms.
    -- Feature Reference: ENC02 (Encryption Key Management), SEC06 (Key Security), PRV04 (Message Privacy)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.chat_encryption_keys (
        key_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        conversation_id UUID NOT NULL,
        user_id UUID NOT NULL,

        -- Key identification
        key_type VARCHAR(20) NOT NULL DEFAULT 'MESSAGE' CHECK (
            key_type IN ('MESSAGE', 'MEDIA', 'METADATA', 'BACKUP', 'RECOVERY')
        ),
        key_version INTEGER NOT NULL DEFAULT 1 CHECK (key_version >= 1),
        key_algorithm VARCHAR(50) DEFAULT 'AES-256-GCM' CHECK (
            key_algorithm IN ('AES-256-GCM', 'AES-256-CBC', 'ChaCha20-Poly1305', 'RSA-OAEP')
        ),

        -- Key material (encrypted)
        encrypted_key TEXT NOT NULL,
        key_wrapping_algorithm VARCHAR(50),
        iv_or_nonce TEXT,
        authentication_tag TEXT,

        -- Key metadata
        key_size_bits INTEGER DEFAULT 256 CHECK (key_size_bits IN (128, 192, 256, 384, 512)),
        key_usage VARCHAR(50)[] DEFAULT '{"ENCRYPT", "DECRYPT"}',
        key_expiration TIMESTAMP WITH TIME ZONE,
        key_rotation_policy VARCHAR(50) DEFAULT 'TIME_BASED' CHECK (
            key_rotation_policy IN ('TIME_BASED', 'MESSAGE_COUNT', 'MANUAL', 'COMPROMISE')
        ),

        -- Key derivation
        key_derivation_function VARCHAR(50) DEFAULT 'PBKDF2' CHECK (
            key_derivation_function IN ('PBKDF2', 'Scrypt', 'Argon2', 'HKDF')
        ),
        salt TEXT,
        iterations INTEGER DEFAULT 100000 CHECK (iterations >= 1000),
        memory_cost_kb INTEGER,
        parallelism INTEGER,

        -- Forward secrecy
        forward_secrecy_enabled BOOLEAN DEFAULT TRUE,
        ephemeral_key_pair JSONB,
        key_agreement_protocol VARCHAR(50) DEFAULT 'ECDH' CHECK (
            key_agreement_protocol IN ('ECDH', 'DH', 'RSA', 'X25519')
        ),

        -- Key ownership and access
        is_master_key BOOLEAN DEFAULT FALSE,
        key_owner_id UUID,
        shared_with_users UUID[] DEFAULT '{}',
        access_control_list JSONB DEFAULT '[]',

        -- Key status
        key_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
            key_status IN ('ACTIVE', 'ROTATED', 'REVOKED', 'COMPROMISED', 'EXPIRED', 'ARCHIVED')
        ),
        key_activation_time TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        key_rotation_time TIMESTAMP WITH TIME ZONE,
        key_revocation_time TIMESTAMP WITH TIME ZONE,
        revocation_reason VARCHAR(200),

        -- Recovery mechanisms
        recovery_enabled BOOLEAN DEFAULT FALSE,
        recovery_threshold INTEGER CHECK (recovery_threshold >= 1),
        recovery_shares JSONB DEFAULT '[]',
        recovery_question_hash VARCHAR(255),

        -- Key usage metrics
        messages_encrypted_count INTEGER DEFAULT 0 CHECK (messages_encrypted_count >= 0),
        messages_decrypted_count INTEGER DEFAULT 0 CHECK (messages_decrypted_count >= 0),
        last_used_at TIMESTAMP WITH TIME ZONE,

        -- Audit and compliance
        key_fingerprint VARCHAR(128),
        key_source VARCHAR(50) DEFAULT 'GENERATED' CHECK (
            key_source IN ('GENERATED', 'IMPORTED', 'DERIVED', 'RECOVERED')
        ),
        compliance_metadata JSONB DEFAULT '{}',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_chat_encryption_keys_conversation FOREIGN KEY (conversation_id)
            REFERENCES socialcandor_schema.conversations(conversation_id) ON DELETE CASCADE,
        CONSTRAINT fk_chat_encryption_keys_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_chat_encryption_keys_owner FOREIGN KEY (key_owner_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT uk_chat_encryption_keys_conversation_user_type_version UNIQUE (
            conversation_id, user_id, key_type, key_version
        ),
        CONSTRAINT chk_key_expiration CHECK (
            (key_expiration IS NULL) OR
            (key_expiration > key_activation_time)
        ),
        CONSTRAINT chk_recovery_threshold CHECK (
            (recovery_enabled = FALSE AND recovery_threshold IS NULL) OR
            (recovery_enabled = TRUE AND recovery_threshold IS NOT NULL AND recovery_threshold >= 1)
        )
    );

    COMMENT ON TABLE socialcandor_schema.chat_encryption_keys IS 'End-to-end encryption key storage with forward secrecy and recovery mechanisms';
    COMMENT ON COLUMN socialcandor_schema.chat_encryption_keys.encrypted_key IS 'Encrypted key material (never stored in plaintext)';

    -- Indexes for chat_encryption_keys
    CREATE INDEX IF NOT EXISTS idx_chat_encryption_keys_conversation ON socialcandor_schema.chat_encryption_keys(conversation_id);
    CREATE INDEX IF NOT EXISTS idx_chat_encryption_keys_user ON socialcandor_schema.chat_encryption_keys(user_id);
    CREATE INDEX IF NOT EXISTS idx_chat_encryption_keys_type ON socialcandor_schema.chat_encryption_keys(key_type);
    CREATE INDEX IF NOT EXISTS idx_chat_encryption_keys_status ON socialcandor_schema.chat_encryption_keys(key_status);
    CREATE INDEX IF NOT EXISTS idx_chat_encryption_keys_active ON socialcandor_schema.chat_encryption_keys(key_status) WHERE key_status = 'ACTIVE';
    CREATE INDEX IF NOT EXISTS idx_chat_encryption_keys_expiration ON socialcandor_schema.chat_encryption_keys(key_expiration) WHERE key_expiration IS NOT NULL;

    -- Trigger for key rotation
    CREATE OR REPLACE FUNCTION socialcandor_schema.rotate_encryption_key()
    RETURNS TRIGGER AS $$
    BEGIN
        IF NEW.key_status = 'ROTATED' AND OLD.key_status = 'ACTIVE' THEN
            NEW.key_rotation_time = CURRENT_TIMESTAMP;

            -- Archive the old key
            INSERT INTO socialcandor_schema.chat_encryption_keys_archive
            SELECT * FROM socialcandor_schema.chat_encryption_keys
            WHERE key_id = OLD.key_id;
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_chat_encryption_keys_rotation
        BEFORE UPDATE OF key_status ON socialcandor_schema.chat_encryption_keys
        FOR EACH ROW
        WHEN (NEW.key_status = 'ROTATED')
        EXECUTE FUNCTION socialcandor_schema.rotate_encryption_key();

    -- Trigger for updated_at
    CREATE TRIGGER trg_chat_encryption_keys_updated_at
        BEFORE UPDATE ON socialcandor_schema.chat_encryption_keys
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 79 - chats
    -- Description: Chat container abstraction with UUID identifiers for security
    -- Business Case: Provides foundation for encrypted messaging while enabling chat
    -- migration across devices through cloud-synced metadata without exposing message
    -- content. Supports both 1:1 and group chats with enhanced security features.
    -- Feature Reference: MSG05 (Chat Management), ENC03 (Chat Security), SYNC03 (Cross-device Sync)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.chats (
        chat_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        conversation_id UUID NOT NULL,

        -- Chat identification
        chat_uuid VARCHAR(36) UNIQUE NOT NULL DEFAULT uuid_generate_v4()::text,
        chat_type VARCHAR(20) NOT NULL DEFAULT 'DIRECT' CHECK (
            chat_type IN ('DIRECT', 'GROUP', 'CHANNEL', 'BROADCAST', 'SECRET')
        ),
        chat_name VARCHAR(200),
        chat_description TEXT,

        -- Encryption configuration
        encryption_enabled BOOLEAN DEFAULT FALSE,
        encryption_protocol VARCHAR(50) DEFAULT 'OMEMO' CHECK (
            encryption_protocol IN ('OMEMO', 'PGP', 'SIGNAL', 'CUSTOM', 'NONE')
        ),
        encryption_key_id UUID,
        forward_secrecy_enabled BOOLEAN DEFAULT TRUE,

        -- Chat settings
        max_participants INTEGER DEFAULT 100 CHECK (max_participants >= 1),
        allow_new_participants BOOLEAN DEFAULT TRUE,
        allow_message_editing BOOLEAN DEFAULT TRUE,
        allow_message_deletion BOOLEAN DEFAULT TRUE,
        message_expiry_days INTEGER CHECK (message_expiry_days >= 1),

        -- Moderation settings
        moderation_level VARCHAR(20) DEFAULT 'STANDARD' CHECK (
            moderation_level IN ('NONE', 'LIGHT', 'STANDARD', 'STRICT', 'VERY_STRICT')
        ),
        automated_moderation_enabled BOOLEAN DEFAULT TRUE,
        report_threshold_for_auto_action INTEGER DEFAULT 3 CHECK (report_threshold_for_auto_action >= 1),

        -- Notification settings
        default_notification_preferences JSONB DEFAULT '{
            "sound": "default",
            "vibrate": true,
            "led": true,
            "priority": "HIGH"
        }',
        mention_notification_rules JSONB DEFAULT '{}',

        -- Chat metadata
        avatar_hash VARCHAR(64),
        theme_settings JSONB DEFAULT '{}',
        custom_emoji_pack JSONB DEFAULT '[]',
        pinned_messages UUID[] DEFAULT '{}',

        -- Chat state
        chat_state VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
            chat_state IN ('ACTIVE', 'ARCHIVED', 'MUTED', 'BLOCKED', 'DELETED')
        ),
        archive_reason VARCHAR(200),
        delete_after_archive_days INTEGER DEFAULT 30 CHECK (delete_after_archive_days >= 0),

        -- Activity tracking
        last_message_timestamp TIMESTAMP WITH TIME ZONE,
        last_message_preview TEXT,
        total_message_count INTEGER DEFAULT 0 CHECK (total_message_count >= 0),
        unread_message_count INTEGER DEFAULT 0 CHECK (unread_message_count >= 0),

        -- Participant management
        participant_count INTEGER DEFAULT 0 CHECK (participant_count >= 0),
        admin_count INTEGER DEFAULT 0 CHECK (admin_count >= 0),
        banned_participant_count INTEGER DEFAULT 0 CHECK (banned_participant_count >= 0),

        -- Chat health metrics
        spam_score NUMERIC(5,2) DEFAULT 0.0 CHECK (spam_score >= 0 AND spam_score <= 100),
        quality_score NUMERIC(5,2) DEFAULT 50.0 CHECK (quality_score >= 0 AND quality_score <= 100),
        engagement_score NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_score >= 0 AND engagement_score <= 100),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),
        archived_at TIMESTAMP WITH TIME ZONE,
        deleted_at TIMESTAMP WITH TIME ZONE,

        -- Foreign key constraint
        CONSTRAINT fk_chats_conversation FOREIGN KEY (conversation_id)
            REFERENCES socialcandor_schema.conversations(conversation_id) ON DELETE CASCADE,
        CONSTRAINT fk_chats_encryption_key FOREIGN KEY (encryption_key_id)
            REFERENCES socialcandor_schema.chat_encryption_keys(key_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_chat_name_required CHECK (
            (chat_type != 'DIRECT' AND chat_name IS NOT NULL) OR
            chat_type = 'DIRECT'
        ),
        CONSTRAINT chk_participant_counts CHECK (
            participant_count >= admin_count AND
            participant_count >= banned_participant_count
        ),
        CONSTRAINT chk_message_counts CHECK (
            unread_message_count <= total_message_count
        )
    );

    COMMENT ON TABLE socialcandor_schema.chats IS 'Chat container abstraction with security features and metadata management';
    COMMENT ON COLUMN socialcandor_schema.chats.chat_uuid IS 'Public UUID for external API access and cross-device synchronization';

    -- Indexes for chats table
    CREATE INDEX IF NOT EXISTS idx_chats_conversation ON socialcandor_schema.chats(conversation_id);
    CREATE INDEX IF NOT EXISTS idx_chats_type ON socialcandor_schema.chats(chat_type);
    CREATE INDEX IF NOT EXISTS idx_chats_state ON socialcandor_schema.chats(chat_state);
    CREATE INDEX IF NOT EXISTS idx_chats_encryption ON socialcandor_schema.chats(encryption_enabled) WHERE encryption_enabled = TRUE;
    CREATE INDEX IF NOT EXISTS idx_chats_activity ON socialcandor_schema.chats(last_message_timestamp DESC NULLS LAST);
    CREATE INDEX IF NOT EXISTS idx_chats_created_by ON socialcandor_schema.chats(created_by);
    CREATE INDEX IF NOT EXISTS idx_chats_quality ON socialcandor_schema.chats(quality_score DESC);

    -- Materialized view for active chats
    CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_active_chats_summary AS
    SELECT
        chat_type,
        COUNT(*) as total_chats,
        COUNT(*) FILTER (WHERE encryption_enabled = TRUE) as encrypted_chats,
        COUNT(*) FILTER (WHERE chat_state = 'ACTIVE') as active_chats,
        COUNT(*) FILTER (WHERE chat_state = 'ARCHIVED') as archived_chats,
        AVG(participant_count) as avg_participants,
        AVG(total_message_count) as avg_messages,
        MAX(last_message_timestamp) as latest_activity,
        SUM(total_message_count) as total_messages_all_chats
    FROM socialcandor_schema.chats
    WHERE created_at >= CURRENT_TIMESTAMP - INTERVAL '90 days'
    GROUP BY chat_type
    WITH DATA;

    CREATE UNIQUE INDEX idx_mv_active_chats_summary_type ON socialcandor_schema.mv_active_chats_summary(chat_type);

    -- Trigger for updated_at
    CREATE TRIGGER trg_chats_updated_at
        BEFORE UPDATE ON socialcandor_schema.chats
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 80 - locations
    -- Description: Geospatial reference data with coordinates for location-based features
    -- Business Case: Powers location-aware content discovery and event recommendations while
    -- enabling geofenced content restrictions for regulatory compliance (e.g., gambling content).
    -- Supports spatial queries and location-based personalization.
    -- Feature Reference: LOC01 (Location Services), GEO01 (Geospatial), COMP05 (Geofencing)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.locations (
        location_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Location identification
        location_name VARCHAR(200) NOT NULL,
        location_type VARCHAR(50) NOT NULL CHECK (
            location_type IN ('CITY', 'REGION', 'COUNTRY', 'POI', 'VENUE', 'CUSTOM', 'NEIGHBORHOOD')
        ),
        normalized_name VARCHAR(200),
        alternate_names VARCHAR(200)[] DEFAULT '{}',

        -- Geographic coordinates
        coordinates GEOGRAPHY(POINT, 4326) NOT NULL,
        bounding_box GEOGRAPHY(POLYGON, 4326),
        elevation_meters NUMERIC(10,2),
        timezone VARCHAR(50),

        -- Administrative hierarchy
        country_code CHAR(3),
        country_name VARCHAR(100),
        region_code VARCHAR(20),
        region_name VARCHAR(100),
        city_name VARCHAR(100),
        postal_code VARCHAR(20),

        -- Geographic hierarchy
        continent VARCHAR(50),
        subregion VARCHAR(100),
        metro_area VARCHAR(100),
        neighborhood VARCHAR(100),

        -- Demographic data
        population INTEGER CHECK (population >= 0),
        population_density NUMERIC(10,2) CHECK (population_density >= 0),
        median_age NUMERIC(5,2) CHECK (median_age >= 0),
        median_income NUMERIC(15,2) CHECK (median_income >= 0),

        -- Cultural and linguistic
        primary_language VARCHAR(50),
        languages_spoken VARCHAR(50)[] DEFAULT '{}',
        currency_code CHAR(3),
        cultural_notes TEXT,

        -- Business context
        business_count INTEGER CHECK (business_count >= 0),
        venue_types VARCHAR(50)[] DEFAULT '{}',
        popularity_score NUMERIC(10,6) DEFAULT 0.0,
        trending_score NUMERIC(10,6) DEFAULT 0.0,

        -- Safety and compliance
        safety_score NUMERIC(5,2) CHECK (safety_score >= 0 AND safety_score <= 100),
        compliance_restrictions VARCHAR(50)[] DEFAULT '{}',
        content_restrictions JSONB DEFAULT '{}',
        legal_jurisdiction VARCHAR(100),

        -- Geographic features
        is_coastal BOOLEAN,
        is_urban BOOLEAN,
        is_touristic BOOLEAN,
        climate_zone VARCHAR(50),

        -- Verification status
        is_verified BOOLEAN DEFAULT FALSE,
        verification_source VARCHAR(100),
        verification_timestamp TIMESTAMP WITH TIME ZONE,
        accuracy_score NUMERIC(5,2) DEFAULT 100.0 CHECK (accuracy_score >= 0 AND accuracy_score <= 100),

        -- Usage metrics
        checkin_count INTEGER DEFAULT 0 CHECK (checkin_count >= 0),
        post_count INTEGER DEFAULT 0 CHECK (post_count >= 0),
        event_count INTEGER DEFAULT 0 CHECK (event_count >= 0),
        last_activity_at TIMESTAMP WITH TIME ZONE,

        -- Spatial metadata
        area_sq_km NUMERIC(15,2) CHECK (area_sq_km >= 0),
        centroid GEOGRAPHY(POINT, 4326),
        spatial_accuracy_meters INTEGER CHECK (spatial_accuracy_meters >= 0),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID DEFAULT uuid_nil(),
        updated_by UUID DEFAULT uuid_nil(),
        source_system VARCHAR(100),
        external_id VARCHAR(100),

        -- Constraints
        CONSTRAINT chk_coordinates_valid CHECK (
            ST_X(coordinates::geometry) BETWEEN -180 AND 180 AND
            ST_Y(coordinates::geometry) BETWEEN -90 AND 90
        ),
        CONSTRAINT chk_location_hierarchy CHECK (
            (location_type = 'COUNTRY' AND country_code IS NOT NULL AND region_code IS NULL AND city_name IS NULL) OR
            (location_type = 'REGION' AND country_code IS NOT NULL AND region_code IS NOT NULL AND city_name IS NULL) OR
            (location_type = 'CITY' AND country_code IS NOT NULL AND region_code IS NOT NULL AND city_name IS NOT NULL) OR
            (location_type IN ('POI', 'VENUE', 'CUSTOM', 'NEIGHBORHOOD'))
        ),
        CONSTRAINT chk_bounding_box_valid CHECK (
            bounding_box IS NULL OR
            ST_IsValid(bounding_box::geometry)
        )
    );

    COMMENT ON TABLE socialcandor_schema.locations IS 'Geospatial reference data for location-based features and geofencing';
    COMMENT ON COLUMN socialcandor_schema.locations.content_restrictions IS 'JSON defining content restrictions based on local laws';

    -- Indexes for locations table
    CREATE INDEX IF NOT EXISTS idx_locations_coordinates ON socialcandor_schema.locations USING GIST(coordinates);
    CREATE INDEX IF NOT EXISTS idx_locations_country ON socialcandor_schema.locations(country_code);
    CREATE INDEX IF NOT EXISTS idx_locations_type ON socialcandor_schema.locations(location_type);
    CREATE INDEX IF NOT EXISTS idx_locations_name ON socialcandor_schema.locations USING gin(location_name gin_trgm_ops);
    CREATE INDEX IF NOT EXISTS idx_locations_popularity ON socialcandor_schema.locations(popularity_score DESC);
    CREATE INDEX IF NOT EXISTS idx_locations_verified ON socialcandor_schema.locations(is_verified) WHERE is_verified = TRUE;
    CREATE INDEX IF NOT EXISTS idx_locations_activity ON socialcandor_schema.locations(last_activity_at DESC);

    -- Spatial index for bounding box queries
    CREATE INDEX IF NOT EXISTS idx_locations_bbox ON socialcandor_schema.locations USING GIST(bounding_box);

    -- Trigger for updated_at
    CREATE TRIGGER trg_locations_updated_at
        BEFORE UPDATE ON socialcandor_schema.locations
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 81 - industries
    -- Description: Professional industry taxonomy for profile enrichment
    -- Business Case: Enables B2B networking features and industry-specific content
    -- recommendations while supporting career development tools through industry
    -- transition analysis. Provides structured industry classification for business users.
    -- Feature Reference: PRO01 (Professional Profiles), BIZ02 (Industry Taxonomy), REC03 (Industry Recommendations)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.industries (
        industry_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        parent_industry_id UUID,

        -- Industry identification
        industry_name VARCHAR(200) NOT NULL UNIQUE,
        industry_code VARCHAR(20) UNIQUE,
        normalized_name VARCHAR(200),
        alternate_names VARCHAR(200)[] DEFAULT '{}',

        -- Taxonomy information
        taxonomy_system VARCHAR(50) DEFAULT 'NAICS' CHECK (
            taxonomy_system IN ('NAICS', 'SIC', 'ISIC', 'GICS', 'CUSTOM')
        ),
        taxonomy_code VARCHAR(20),
        taxonomy_level INTEGER DEFAULT 1 CHECK (taxonomy_level >= 1),
        hierarchy_path LTREE,

        -- Industry description
        description TEXT,
        key_activities TEXT[] DEFAULT '{}',
        typical_products_services TEXT[] DEFAULT '{}',

        -- Economic data
        global_market_size_usd NUMERIC(20,2) CHECK (global_market_size_usd >= 0),
        growth_rate_percentage NUMERIC(10,2),
        employment_statistics JSONB DEFAULT '{}',
        average_salary_usd NUMERIC(15,2) CHECK (average_salary_usd >= 0),

        -- Skills and competencies
        core_skills VARCHAR(100)[] DEFAULT '{}',
        emerging_skills VARCHAR(100)[] DEFAULT '{}',
        certifications VARCHAR(100)[] DEFAULT '{}',
        technology_stack VARCHAR(100)[] DEFAULT '{}',

        -- Industry trends
        trend_analysis JSONB DEFAULT '{}',
        innovation_score NUMERIC(5,2) CHECK (innovation_score >= 0 AND innovation_score <= 100),
        sustainability_score NUMERIC(5,2) CHECK (sustainability_score >= 0 AND sustainability_score <= 100),
        digital_transformation_index NUMERIC(5,2) CHECK (digital_transformation_index >= 0 AND digital_transformation_index <= 100),

        -- Network analysis
        related_industries UUID[] DEFAULT '{}',
        complementary_industries UUID[] DEFAULT '{}',
        competitive_industries UUID[] DEFAULT '{}',
        supply_chain_position VARCHAR(50),

        -- Platform metrics
        user_count INTEGER DEFAULT 0 CHECK (user_count >= 0),
        company_count INTEGER DEFAULT 0 CHECK (company_count >= 0),
        content_count INTEGER DEFAULT 0 CHECK (content_count >= 0),
        engagement_rate NUMERIC(5,2) CHECK (engagement_rate >= 0 AND engagement_rate <= 100),

        -- Industry status
        is_active BOOLEAN DEFAULT TRUE,
        is_emerging BOOLEAN DEFAULT FALSE,
        is_sunset BOOLEAN DEFAULT FALSE,
        sunset_date DATE,

        -- Verification and quality
        is_verified BOOLEAN DEFAULT FALSE,
        verification_source VARCHAR(100),
        data_quality_score NUMERIC(5,2) DEFAULT 100.0 CHECK (data_quality_score >= 0 AND data_quality_score <= 100),

        -- Localization
        localized_names JSONB DEFAULT '{}',
        region_specific_data JSONB DEFAULT '{}',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID DEFAULT uuid_nil(),
        updated_by UUID DEFAULT uuid_nil(),
        source_system VARCHAR(100),
        external_references JSONB DEFAULT '{}',

        -- Foreign key constraint
        CONSTRAINT fk_industries_parent FOREIGN KEY (parent_industry_id)
            REFERENCES socialcandor_schema.industries(industry_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_taxonomy_code_format CHECK (
            taxonomy_code ~ '^[A-Z0-9\-\.]+$'
        ),
        CONSTRAINT chk_hierarchy_depth CHECK (
            taxonomy_level <= 6
        ),
        CONSTRAINT chk_sunset_date CHECK (
            (is_sunset = FALSE AND sunset_date IS NULL) OR
            (is_sunset = TRUE AND sunset_date IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.industries IS 'Professional industry taxonomy with economic data and skills mapping';
    COMMENT ON COLUMN socialcandor_schema.industries.hierarchy_path IS 'LTREE path for hierarchical industry queries';

    -- Indexes for industries table
    CREATE INDEX IF NOT EXISTS idx_industries_parent ON socialcandor_schema.industries(parent_industry_id);
    CREATE INDEX IF NOT EXISTS idx_industries_name ON socialcandor_schema.industries(industry_name);
    CREATE INDEX IF NOT EXISTS idx_industries_code ON socialcandor_schema.industries(industry_code);
    CREATE INDEX IF NOT EXISTS idx_industries_taxonomy ON socialcandor_schema.industries(taxonomy_system, taxonomy_code);
    CREATE INDEX IF NOT EXISTS idx_industries_hierarchy ON socialcandor_schema.industries USING GIST(hierarchy_path);
    CREATE INDEX IF NOT EXISTS idx_industries_active ON socialcandor_schema.industries(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_industries_growth ON socialcandor_schema.industries(growth_rate_percentage DESC);

    -- Trigger for hierarchy path management
    CREATE OR REPLACE FUNCTION socialcandor_schema.update_industry_hierarchy_path()
    RETURNS TRIGGER AS $$
    BEGIN
        IF NEW.parent_industry_id IS NULL THEN
            NEW.hierarchy_path = NEW.industry_id::text::ltree;
        ELSE
            SELECT hierarchy_path || NEW.industry_id::text
            INTO NEW.hierarchy_path
            FROM socialcandor_schema.industries
            WHERE industry_id = NEW.parent_industry_id;
        END IF;

        -- Update taxonomy level
        IF NEW.parent_industry_id IS NULL THEN
            NEW.taxonomy_level = 1;
        ELSE
            SELECT taxonomy_level + 1
            INTO NEW.taxonomy_level
            FROM socialcandor_schema.industries
            WHERE industry_id = NEW.parent_industry_id;
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_industries_hierarchy_path
        BEFORE INSERT ON socialcandor_schema.industries
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_industry_hierarchy_path();

    -- Trigger for updated_at
    CREATE TRIGGER trg_industries_updated_at
        BEFORE UPDATE ON socialcandor_schema.industries
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 82 - user_profiles
    -- Description: Extended professional profile data beyond basic user accounts
    -- Business Case: Creates LinkedIn-like professional identity layer while enabling
    -- job matching algorithms and industry networking features for monetization through
    -- premium career services. Supports comprehensive professional profiling.
    -- Feature Reference: PRO02 (Professional Profiles), CAREER01 (Career Services), NET03 (Professional Networking)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.user_profiles (
        profile_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        user_id UUID NOT NULL UNIQUE,

        -- Professional summary
        professional_headline VARCHAR(200),
        professional_summary TEXT,
        career_objectives TEXT,

        -- Current employment
        current_job_title VARCHAR(200),
        current_company_id UUID,
        current_company_name VARCHAR(200),
        current_industry_id UUID,
        employment_type VARCHAR(50) CHECK (
            employment_type IN ('FULL_TIME', 'PART_TIME', 'CONTRACT', 'FREELANCE', 'INTERNSHIP', 'SELF_EMPLOYED', 'UNEMPLOYED')
        ),
        start_date DATE,

        -- Career history
        total_years_experience INTEGER CHECK (total_years_experience >= 0),
        career_history JSONB DEFAULT '[]',
        education_history JSONB DEFAULT '[]',
        certifications JSONB DEFAULT '[]',

        -- Skills and expertise
        skills JSONB DEFAULT '[]',
        skill_endorsements JSONB DEFAULT '{}',
        expertise_areas VARCHAR(100)[] DEFAULT '{}',
        languages JSONB DEFAULT '[]',

        -- Professional metrics
        profile_completeness_score NUMERIC(5,2) DEFAULT 0.0 CHECK (
            profile_completeness_score >= 0 AND profile_completeness_score <= 100
        ),
        profile_visibility VARCHAR(20) DEFAULT 'PUBLIC' CHECK (
            profile_visibility IN ('PUBLIC', 'CONNECTIONS', 'PRIVATE', 'RECRUITERS_ONLY')
        ),
        profile_strength_score NUMERIC(5,2) DEFAULT 0.0 CHECK (
            profile_strength_score >= 0 AND profile_strength_score <= 100
        ),

        -- Contact information
        professional_email VARCHAR(255),
        professional_phone VARCHAR(20),
        website_url VARCHAR(500),
        portfolio_url VARCHAR(500),
        github_url VARCHAR(500),
        linkedin_url VARCHAR(500),

        -- Location preferences
        current_location_id UUID,
        willing_to_relocate BOOLEAN DEFAULT FALSE,
        preferred_locations UUID[] DEFAULT '{}',
        remote_work_preference VARCHAR(20) DEFAULT 'HYBRID' CHECK (
            remote_work_preference IN ('OFFICE', 'REMOTE', 'HYBRID', 'FLEXIBLE')
        ),

        -- Career preferences
        target_job_titles VARCHAR(200)[] DEFAULT '{}',
        target_industries UUID[] DEFAULT '{}',
        target_salary_min NUMERIC(15,2) CHECK (target_salary_min >= 0),
        target_salary_currency CHAR(3) DEFAULT 'USD',
        job_search_status VARCHAR(20) DEFAULT 'NOT_LOOKING' CHECK (
            job_search_status IN ('ACTIVELY_LOOKING', 'PASSIVELY_OPEN', 'NOT_LOOKING', 'OPEN_TO_OFFERS')
        ),

        -- Availability
        notice_period_days INTEGER CHECK (notice_period_days >= 0),
        available_from_date DATE,
        employment_status VARCHAR(50) CHECK (
            employment_status IN ('EMPLOYED', 'UNEMPLOYED', 'STUDENT', 'RETIRED', 'FREELANCE')
        ),

        -- Professional achievements
        awards JSONB DEFAULT '[]',
        publications JSONB DEFAULT '[]',
        patents JSONB DEFAULT '[]',
        projects JSONB DEFAULT '[]',

        -- Network metrics
        professional_connections INTEGER DEFAULT 0 CHECK (professional_connections >= 0),
        recommendation_count INTEGER DEFAULT 0 CHECK (recommendation_count >= 0),
        endorsement_count INTEGER DEFAULT 0 CHECK (endorsement_count >= 0),

        -- Verification
        is_verified_professional BOOLEAN DEFAULT FALSE,
        verification_method VARCHAR(50) CHECK (
            verification_method IN ('EMAIL', 'PHONE', 'DOCUMENT', 'WORK_EMAIL', 'MANUAL')
        ),
        verification_timestamp TIMESTAMP WITH TIME ZONE,

        -- Premium features
        is_premium_profile BOOLEAN DEFAULT FALSE,
        premium_features JSONB DEFAULT '{}',
        premium_expires_at TIMESTAMP WITH TIME ZONE,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),
        last_updated_by_user TIMESTAMP WITH TIME ZONE,

        -- Foreign key constraints
        CONSTRAINT fk_user_profiles_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_user_profiles_current_company FOREIGN KEY (current_company_id)
            REFERENCES socialcandor_schema.pages(page_id) ON DELETE SET NULL,
        CONSTRAINT fk_user_profiles_industry FOREIGN KEY (current_industry_id)
            REFERENCES socialcandor_schema.industries(industry_id) ON DELETE SET NULL,
        CONSTRAINT fk_user_profiles_location FOREIGN KEY (current_location_id)
            REFERENCES socialcandor_schema.locations(location_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_experience_consistency CHECK (
            total_years_experience <= 100
        ),
        CONSTRAINT chk_salary_currency CHECK (
            (target_salary_min IS NULL AND target_salary_currency = 'USD') OR
            (target_salary_min IS NOT NULL AND target_salary_currency IS NOT NULL)
        ),
        CONSTRAINT chk_verification_status CHECK (
            (is_verified_professional = FALSE AND verification_method IS NULL AND verification_timestamp IS NULL) OR
            (is_verified_professional = TRUE AND verification_method IS NOT NULL AND verification_timestamp IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.user_profiles IS 'Extended professional profile data for career networking and job matching';
    COMMENT ON COLUMN socialcandor_schema.user_profiles.profile_strength_score IS 'Algorithmic score measuring profile quality and completeness';

    -- Indexes for user_profiles
    CREATE INDEX IF NOT EXISTS idx_user_profiles_user ON socialcandor_schema.user_profiles(user_id);
    CREATE INDEX IF NOT EXISTS idx_user_profiles_company ON socialcandor_schema.user_profiles(current_company_id) WHERE current_company_id IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_user_profiles_industry ON socialcandor_schema.user_profiles(current_industry_id) WHERE current_industry_id IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_user_profiles_job_title ON socialcandor_schema.user_profiles USING gin(current_job_title gin_trgm_ops);
    CREATE INDEX IF NOT EXISTS idx_user_profiles_skills ON socialcandor_schema.user_profiles USING gin(skills);
    CREATE INDEX IF NOT EXISTS idx_user_profiles_search_status ON socialcandor_schema.user_profiles(job_search_status);
    CREATE INDEX IF NOT EXISTS idx_user_profiles_premium ON socialcandor_schema.user_profiles(is_premium_profile) WHERE is_premium_profile = TRUE;
    CREATE INDEX IF NOT EXISTS idx_user_profiles_strength ON socialcandor_schema.user_profiles(profile_strength_score DESC);

    -- Full-text search index for professional profiles
    CREATE INDEX IF NOT EXISTS idx_user_profiles_search ON socialcandor_schema.user_profiles
    USING gin(
        to_tsvector('english',
            COALESCE(professional_headline, '') || ' ' ||
            COALESCE(professional_summary, '') || ' ' ||
            COALESCE(current_job_title, '') || ' ' ||
            COALESCE(current_company_name, '')
        )
    );

    -- Trigger for profile completeness calculation
    CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_profile_completeness()
    RETURNS TRIGGER AS $$
    DECLARE
        v_score NUMERIC := 0;
        v_max_score INTEGER := 100;
    BEGIN
        -- Professional headline (10 points)
        IF NEW.professional_headline IS NOT NULL AND LENGTH(TRIM(NEW.professional_headline)) > 0 THEN
            v_score := v_score + 10;
        END IF;

        -- Professional summary (15 points)
        IF NEW.professional_summary IS NOT NULL AND LENGTH(TRIM(NEW.professional_summary)) > 100 THEN
            v_score := v_score + 15;
        END IF;

        -- Current job title (10 points)
        IF NEW.current_job_title IS NOT NULL AND LENGTH(TRIM(NEW.current_job_title)) > 0 THEN
            v_score := v_score + 10;
        END IF;

        -- Current company (10 points)
        IF NEW.current_company_name IS NOT NULL AND LENGTH(TRIM(NEW.current_company_name)) > 0 THEN
            v_score := v_score + 10;
        END IF;

        -- Skills (15 points)
        IF NEW.skills IS NOT NULL AND jsonb_array_length(NEW.skills) >= 5 THEN
            v_score := v_score + 15;
        END IF;

        -- Career history (15 points)
        IF NEW.career_history IS NOT NULL AND jsonb_array_length(NEW.career_history) >= 1 THEN
            v_score := v_score + 15;
        END IF;

        -- Education history (10 points)
        IF NEW.education_history IS NOT NULL AND jsonb_array_length(NEW.education_history) >= 1 THEN
            v_score := v_score + 10;
        END IF;

        -- Profile photo (from users table - would need join)
        -- Add via trigger or application logic

        -- Contact information (5 points)
        IF NEW.professional_email IS NOT NULL OR NEW.linkedin_url IS NOT NULL OR NEW.website_url IS NOT NULL THEN
            v_score := v_score + 5;
        END IF;

        -- Location (5 points)
        IF NEW.current_location_id IS NOT NULL THEN
            v_score := v_score + 5;
        END IF;

        -- Calculate percentage
        NEW.profile_completeness_score := ROUND((v_score::NUMERIC / v_max_score) * 100, 2);

        -- Calculate profile strength (simplified)
        NEW.profile_strength_score := NEW.profile_completeness_score * 0.6 +
                                     COALESCE((SELECT trust_score FROM socialcandor_schema.users WHERE user_id = NEW.user_id), 50) * 0.4;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_user_profiles_completeness
        BEFORE INSERT OR UPDATE ON socialcandor_schema.user_profiles
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.calculate_profile_completeness();

    -- Trigger for updated_at
    CREATE TRIGGER trg_user_profiles_updated_at
        BEFORE UPDATE ON socialcandor_schema.user_profiles
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 83 - post_types
    -- Description: Content type taxonomy with descriptions
    -- Business Case: Enables type-specific rendering optimizations and algorithmic weighting
    -- (e.g., video posts receive higher initial distribution) while supporting content
    -- format analytics for creator guidance and platform optimization.
    -- Feature Reference: CNT04 (Content Taxonomy), REND01 (Rendering Optimization), ANAL03 (Content Analytics)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.post_types (
        post_type_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Type identification
        type_name VARCHAR(50) NOT NULL UNIQUE,
        type_code VARCHAR(20) NOT NULL UNIQUE,
        display_name VARCHAR(100) NOT NULL,
        description TEXT,

        -- Classification
        category VARCHAR(50) NOT NULL CHECK (
            category IN ('TEXT', 'MEDIA', 'INTERACTIVE', 'EVENT', 'COMMERCE', 'PROFESSIONAL')
        ),
        subcategory VARCHAR(50),
        content_family VARCHAR(50),

        -- Technical specifications
        mime_types VARCHAR(100)[] DEFAULT '{}',
        file_extensions VARCHAR(20)[] DEFAULT '{}',
        max_file_size_mb INTEGER CHECK (max_file_size_mb >= 0),
        supported_aspect_ratios VARCHAR(20)[] DEFAULT '{}',
        max_duration_seconds INTEGER CHECK (max_duration_seconds >= 0),

        -- Platform handling
        processing_pipeline VARCHAR(100),
        rendering_template VARCHAR(100),
        preview_generation_strategy VARCHAR(50),
        compression_settings JSONB DEFAULT '{}',

        -- Algorithmic weighting
        base_engagement_weight NUMERIC(5,2) DEFAULT 1.0 CHECK (base_engagement_weight >= 0),
        viral_coefficient_multiplier NUMERIC(5,2) DEFAULT 1.0 CHECK (viral_coefficient_multiplier >= 0),
        freshness_decay_rate NUMERIC(5,2) DEFAULT 1.0 CHECK (freshness_decay_rate >= 0),
        quality_score_weight NUMERIC(5,2) DEFAULT 1.0 CHECK (quality_score_weight >= 0),

        -- Monetization settings
        monetization_supported BOOLEAN DEFAULT FALSE,
        ad_integration_level VARCHAR(20) DEFAULT 'NONE' CHECK (
            ad_integration_level IN ('NONE', 'BASIC', 'ENHANCED', 'NATIVE', 'FULL')
        ),
        sponsorship_allowed BOOLEAN DEFAULT TRUE,
        tipping_allowed BOOLEAN DEFAULT TRUE,

        -- Moderation requirements
        moderation_priority VARCHAR(20) DEFAULT 'STANDARD' CHECK (
            moderation_priority IN ('LOW', 'STANDARD', 'HIGH', 'CRITICAL')
        ),
        pre_moderation_required BOOLEAN DEFAULT FALSE,
        ai_moderation_confidence_threshold NUMERIC(5,2) DEFAULT 80.0 CHECK (
            ai_moderation_confidence_threshold >= 0 AND ai_moderation_confidence_threshold <= 100
        ),
        content_guidelines_url VARCHAR(500),

        -- User experience
        default_visibility socialcandor_schema.content_visibility DEFAULT 'PUBLIC',
        allow_comments BOOLEAN DEFAULT TRUE,
        allow_sharing BOOLEAN DEFAULT TRUE,
        allow_embedding BOOLEAN DEFAULT TRUE,
        allow_download BOOLEAN DEFAULT FALSE,

        -- Creator features
        creator_tools JSONB DEFAULT '{}',
        analytics_provided BOOLEAN DEFAULT TRUE,
        editing_allowed BOOLEAN DEFAULT TRUE,
        versioning_supported BOOLEAN DEFAULT FALSE,

        -- Platform metrics
        total_posts_count INTEGER DEFAULT 0 CHECK (total_posts_count >= 0),
        average_engagement_rate NUMERIC(5,2) CHECK (average_engagement_rate >= 0 AND average_engagement_rate <= 100),
        creator_adoption_rate NUMERIC(5,2) CHECK (creator_adoption_rate >= 0 AND creator_adoption_rate <= 100),
        user_satisfaction_score NUMERIC(5,2) CHECK (user_satisfaction_score >= 0 AND user_satisfaction_score <= 100),

        -- Type status
        is_active BOOLEAN DEFAULT TRUE,
        is_beta BOOLEAN DEFAULT FALSE,
        is_deprecated BOOLEAN DEFAULT FALSE,
        deprecation_date DATE,
        replacement_type_id UUID,

        -- Localization
        localized_display_names JSONB DEFAULT '{}',
        region_specific_settings JSONB DEFAULT '{}',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),
        approved_at TIMESTAMP WITH TIME ZONE,
        approved_by UUID,

        -- Foreign key constraint
        CONSTRAINT fk_post_types_replacement FOREIGN KEY (replacement_type_id)
            REFERENCES socialcandor_schema.post_types(post_type_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_type_code_format CHECK (type_code ~ '^[A-Z][A-Z0-9_]*$'),
        CONSTRAINT chk_engagement_weights CHECK (
            base_engagement_weight >= 0 AND
            viral_coefficient_multiplier >= 0 AND
            freshness_decay_rate >= 0
        ),
        CONSTRAINT chk_deprecation_fields CHECK (
            (is_deprecated = FALSE AND deprecation_date IS NULL) OR
            (is_deprecated = TRUE AND deprecation_date IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.post_types IS 'Content type taxonomy with platform handling and algorithmic configuration';
    COMMENT ON COLUMN socialcandor_schema.post_types.base_engagement_weight IS 'Weight applied to engagement metrics for this content type in ranking';

    -- Indexes for post_types
    CREATE INDEX IF NOT EXISTS idx_post_types_category ON socialcandor_schema.post_types(category);
    CREATE INDEX IF NOT EXISTS idx_post_types_active ON socialcandor_schema.post_types(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_post_types_code ON socialcandor_schema.post_types(type_code);
    CREATE INDEX IF NOT EXISTS idx_post_types_engagement_weight ON socialcandor_schema.post_types(base_engagement_weight DESC);
    CREATE INDEX IF NOT EXISTS idx_post_types_creation_date ON socialcandor_schema.post_types(created_at DESC);

    -- Insert default post types
    INSERT INTO socialcandor_schema.post_types (
        type_name,
        type_code,
        display_name,
        description,
        category,
        subcategory,
        mime_types,
        file_extensions,
        max_file_size_mb,
        base_engagement_weight,
        created_by
    ) VALUES
        (
            'TEXT_POST',
            'TEXT',
            'Text Post',
            'Simple text-based content with formatting support',
            'TEXT',
            'BASIC',
            ARRAY['text/plain'],
            ARRAY['txt'],
            10,
            1.0,
            uuid_nil()
        ),
        (
            'IMAGE_POST',
            'IMAGE',
            'Image Post',
            'Single or multiple image content with captions',
            'MEDIA',
            'VISUAL',
            ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
            ARRAY['jpg', 'jpeg', 'png', 'gif', 'webp'],
            50,
            1.2,
            uuid_nil()
        ),
        (
            'VIDEO_POST',
            'VIDEO',
            'Video Post',
            'Video content with playback controls',
            'MEDIA',
            'VIDEO',
            ARRAY['video/mp4', 'video/webm', 'video/quicktime'],
            ARRAY['mp4', 'webm', 'mov'],
            500,
            1.5,
            uuid_nil()
        ),
        (
            'LINK_POST',
            'LINK',
            'Link Share',
            'External link with preview and description',
            'TEXT',
            'LINK',
            ARRAY[]::VARCHAR[],
            ARRAY[]::VARCHAR[],
            0,
            0.8,
            uuid_nil()
        ),
        (
            'POLL_POST',
            'POLL',
            'Poll',
            'Interactive poll with multiple choice options',
            'INTERACTIVE',
            'POLL',
            ARRAY[]::VARCHAR[],
            ARRAY[]::VARCHAR[],
            1,
            1.8,
            uuid_nil()
        )
    ON CONFLICT (type_code) DO UPDATE SET
        display_name = EXCLUDED.display_name,
        description = EXCLUDED.description,
        updated_at = CURRENT_TIMESTAMP;

    -- Trigger for updated_at
    CREATE TRIGGER trg_post_types_updated_at
        BEFORE UPDATE ON socialcandor_schema.post_types
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 84 - media_attachments
    -- Description: Rich media metadata beyond basic posts_media with duration/aspect ratio
    -- Business Case: Supports advanced media features (360Â° photos, spatial audio) while
    -- enabling accessibility compliance through automatic alt-text generation triggers
    -- based on media type. Provides comprehensive media asset management.
    -- Feature Reference: MED02 (Advanced Media), ACC02 (Accessibility), ASSET01 (Asset Management)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.media_attachments (
        attachment_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        media_id UUID NOT NULL,
        post_id UUID,
        user_id UUID NOT NULL,

        -- Media classification
        media_category VARCHAR(50) NOT NULL DEFAULT 'CONTENT' CHECK (
            media_category IN ('CONTENT', 'PROFILE', 'COVER', 'ADVERTISEMENT', 'DOCUMENT', 'OTHER')
        ),
        attachment_type VARCHAR(50) NOT NULL CHECK (
            attachment_type IN ('IMAGE', 'VIDEO', 'AUDIO', 'DOCUMENT', 'ARCHIVE', '3D_MODEL', 'AR_ASSET', 'VR_SCENE')
        ),
        content_type VARCHAR(100) NOT NULL,

        -- Technical specifications
        width_pixels INTEGER CHECK (width_pixels >= 0),
        height_pixels INTEGER CHECK (height_pixels >= 0),
        aspect_ratio VARCHAR(20),
        duration_seconds NUMERIC(10,3) CHECK (duration_seconds >= 0),
        frame_rate NUMERIC(6,2) CHECK (frame_rate >= 0),
        bitrate_kbps INTEGER CHECK (bitrate_kbps >= 0),
        file_size_bytes BIGINT NOT NULL CHECK (file_size_bytes >= 0),

        -- Advanced media features
        is_360_content BOOLEAN DEFAULT FALSE,
        is_hdr BOOLEAN DEFAULT FALSE,
        is_spatial_audio BOOLEAN DEFAULT FALSE,
        has_alpha_channel BOOLEAN DEFAULT FALSE,
        color_profile VARCHAR(50),

        -- Processing information
        processing_pipeline_version VARCHAR(50),
        optimization_level VARCHAR(20) DEFAULT 'BALANCED' CHECK (
            optimization_level IN ('LOSSY', 'LOSSLESS', 'BALANCED', 'MAX_QUALITY', 'MIN_SIZE')
        ),
        transformations_applied JSONB DEFAULT '[]',
        processing_metadata JSONB DEFAULT '{}',

        -- Accessibility features
        alt_text VARCHAR(1000),
        alt_text_source VARCHAR(20) DEFAULT 'MANUAL' CHECK (
            alt_text_source IN ('MANUAL', 'AI_GENERATED', 'CROWD_SOURCED', 'SYSTEM')
        ),
        alt_text_confidence NUMERIC(5,2) CHECK (alt_text_confidence >= 0 AND alt_text_confidence <= 100),
        caption TEXT,
        transcript TEXT,
        audio_description_url VARCHAR(500),

        -- Copyright and licensing
        copyright_status VARCHAR(20) DEFAULT 'UNKNOWN' CHECK (
            copyright_status IN ('ORIGINAL', 'LICENSED', 'CREATIVE_COMMONS', 'PUBLIC_DOMAIN', 'FAIR_USE', 'UNKNOWN')
        ),
        license_type VARCHAR(50),
        attribution_required BOOLEAN DEFAULT FALSE,
        commercial_use_allowed BOOLEAN DEFAULT FALSE,
        copyright_holder VARCHAR(255),

        -- Content analysis
        content_analysis_results JSONB DEFAULT '{}',
        nsfw_score NUMERIC(5,2) DEFAULT 0.0 CHECK (nsfw_score >= 0 AND nsfw_score <= 100),
        quality_score NUMERIC(5,2) DEFAULT 50.0 CHECK (quality_score >= 0 AND quality_score <= 100),
        aesthetic_score NUMERIC(5,2) CHECK (aesthetic_score >= 0 AND aesthetic_score <= 100),

        -- SEO and discovery
        keywords VARCHAR(100)[] DEFAULT '{}',
        description TEXT,
        title VARCHAR(200),

        -- Storage information
        storage_tier VARCHAR(20) DEFAULT 'STANDARD' CHECK (
            storage_tier IN ('HOT', 'WARM', 'COLD', 'ARCHIVE', 'STANDARD')
        ),
        storage_class VARCHAR(50),
        replication_count INTEGER DEFAULT 3 CHECK (replication_count >= 1),
        backup_enabled BOOLEAN DEFAULT TRUE,

        -- Delivery optimization
        cdn_enabled BOOLEAN DEFAULT TRUE,
        cdn_purge_on_update BOOLEAN DEFAULT TRUE,
        delivery_optimization JSONB DEFAULT '{}',

        -- Usage analytics
        view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
        download_count INTEGER DEFAULT 0 CHECK (download_count >= 0),
        share_count INTEGER DEFAULT 0 CHECK (share_count >= 0),
        last_accessed_at TIMESTAMP WITH TIME ZONE,

        -- Lifecycle management
        retention_policy_id UUID,
        auto_delete_date DATE,
        archival_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
            archival_status IN ('ACTIVE', 'ARCHIVED', 'PENDING_DELETION', 'DELETED')
        ),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),
        ingested_at TIMESTAMP WITH TIME ZONE,

        -- Foreign key constraints
        CONSTRAINT fk_media_attachments_media FOREIGN KEY (media_id)
            REFERENCES socialcandor_schema.posts_media(media_id) ON DELETE CASCADE,
        CONSTRAINT fk_media_attachments_post FOREIGN KEY (post_id)
            REFERENCES socialcandor_schema.posts(post_id) ON DELETE SET NULL,
        CONSTRAINT fk_media_attachments_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT chk_media_dimensions CHECK (
            (attachment_type NOT IN ('IMAGE', 'VIDEO')) OR
            (width_pixels > 0 AND height_pixels > 0)
        ),
        CONSTRAINT chk_file_size_limit CHECK (file_size_bytes <= 107374182400), -- 100GB limit
        CONSTRAINT chk_accessibility_fields CHECK (
            (alt_text_source != 'AI_GENERATED' OR alt_text_confidence IS NOT NULL) OR
            alt_text_source = 'AI_GENERATED'
        )
    );

    COMMENT ON TABLE socialcandor_schema.media_attachments IS 'Rich media metadata with advanced features and accessibility support';
    COMMENT ON COLUMN socialcandor_schema.media_attachments.transformations_applied IS 'JSON array of transformations applied to the media';

    -- Indexes for media_attachments
    CREATE INDEX IF NOT EXISTS idx_media_attachments_media ON socialcandor_schema.media_attachments(media_id);
    CREATE INDEX IF NOT EXISTS idx_media_attachments_post ON socialcandor_schema.media_attachments(post_id);
    CREATE INDEX IF NOT EXISTS idx_media_attachments_user ON socialcandor_schema.media_attachments(user_id);
    CREATE INDEX IF NOT EXISTS idx_media_attachments_type ON socialcandor_schema.media_attachments(attachment_type);
    CREATE INDEX IF NOT EXISTS idx_media_attachments_category ON socialcandor_schema.media_attachments(media_category);
    CREATE INDEX IF NOT EXISTS idx_media_attachments_created_at ON socialcandor_schema.media_attachments(created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_media_attachments_nsfw ON socialcandor_schema.media_attachments(nsfw_score DESC);
    CREATE INDEX IF NOT EXISTS idx_media_attachments_quality ON socialcandor_schema.media_attachments(quality_score DESC);

    -- Trigger for alt-text generation tracking
    CREATE OR REPLACE FUNCTION socialcandor_schema.track_alt_text_generation()
    RETURNS TRIGGER AS $$
    BEGIN
        IF NEW.alt_text IS NOT NULL AND OLD.alt_text IS NULL THEN
            INSERT INTO socialcandor_schema.accessibility_logs (
                media_id,
                user_id,
                action_type,
                details,
                created_by
            ) VALUES (
                NEW.media_id,
                NEW.created_by,
                'ALT_TEXT_ADDED',
                jsonb_build_object(
                    'source', NEW.alt_text_source,
                    'confidence', NEW.alt_text_confidence,
                    'character_count', LENGTH(NEW.alt_text)
                ),
                NEW.updated_by
            );
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_media_attachments_alt_text
        AFTER UPDATE OF alt_text ON socialcandor_schema.media_attachments
        FOR EACH ROW
        WHEN (NEW.alt_text IS NOT NULL AND OLD.alt_text IS NULL)
        EXECUTE FUNCTION socialcandor_schema.track_alt_text_generation();

    -- Trigger for updated_at
    CREATE TRIGGER trg_media_attachments_updated_at
        BEFORE UPDATE ON socialcandor_schema.media_attachments
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 85 - relationship_types
    -- Description: Configurable relationship taxonomy beyond simple follows/friends
    -- Business Case: Enables complex social graphs (family relationships, professional
    -- connections) while supporting relationship-specific privacy controls and content
    -- distribution rules. Provides flexibility for diverse social networking needs.
    -- Feature Reference: REL03 (Relationship Taxonomy), PRV05 (Relationship Privacy), GRAPH01 (Social Graph)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.relationship_types (
        relationship_type_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Type identification
        type_name VARCHAR(50) NOT NULL UNIQUE,
        type_code VARCHAR(20) NOT NULL UNIQUE,
        display_name VARCHAR(100) NOT NULL,
        description TEXT,

        -- Relationship characteristics
        is_symmetric BOOLEAN DEFAULT TRUE,
        is_transitive BOOLEAN DEFAULT FALSE,
        requires_consent BOOLEAN DEFAULT TRUE,
        is_exclusive BOOLEAN DEFAULT FALSE,

        -- Privacy and visibility
        default_visibility VARCHAR(20) DEFAULT 'MUTUAL' CHECK (
            default_visibility IN ('PUBLIC', 'FRIENDS', 'MUTUAL', 'PRIVATE')
        ),
        can_be_hidden BOOLEAN DEFAULT TRUE,
        shows_in_timeline BOOLEAN DEFAULT TRUE,
        shows_in_suggestions BOOLEAN DEFAULT TRUE,

        -- Content sharing rules
        content_visibility_preset socialcandor_schema.content_visibility DEFAULT 'FRIENDS',
        can_see_posts_by_default BOOLEAN DEFAULT TRUE,
        can_see_friends_by_default BOOLEAN DEFAULT FALSE,
        can_message_by_default BOOLEAN DEFAULT TRUE,

        -- Notification settings
        notification_preferences JSONB DEFAULT '{
            "new_post": true,
            "story_update": true,
            "life_event": true,
            "birthday": true
        }',

        -- Relationship strength
        base_strength_score NUMERIC(5,2) DEFAULT 50.0 CHECK (
            base_strength_score >= 0 AND base_strength_score <= 100
        ),
        decay_rate_per_day NUMERIC(5,2) DEFAULT 0.1 CHECK (decay_rate_per_day >= 0),
        reinforcement_multiplier NUMERIC(5,2) DEFAULT 1.5 CHECK (reinforcement_multiplier >= 1),

        -- Platform integration
        appears_in_graph BOOLEAN DEFAULT TRUE,
        graph_weight NUMERIC(5,2) DEFAULT 1.0 CHECK (graph_weight >= 0),
        algorithm_consideration VARCHAR(20) DEFAULT 'STANDARD' CHECK (
            algorithm_consideration IN ('NONE', 'LOW', 'STANDARD', 'HIGH', 'CRITICAL')
        ),

        -- Category and grouping
        category VARCHAR(50) NOT NULL DEFAULT 'SOCIAL' CHECK (
            category IN ('SOCIAL', 'FAMILY', 'PROFESSIONAL', 'EDUCATIONAL', 'ROMANTIC', 'COMMUNITY')
        ),
        subcategory VARCHAR(50),
        tags VARCHAR(50)[] DEFAULT '{}',

        -- Customization
        allows_custom_label BOOLEAN DEFAULT FALSE,
        custom_fields_schema JSONB DEFAULT '{}',
        validation_rules JSONB DEFAULT '{}',

        -- Usage metrics
        active_relationships_count INTEGER DEFAULT 0 CHECK (active_relationships_count >= 0),
        total_relationships_count INTEGER DEFAULT 0 CHECK (total_relationships_count >= 0),
        user_satisfaction_score NUMERIC(5,2) CHECK (user_satisfaction_score >= 0 AND user_satisfaction_score <= 100),

        -- Type status
        is_active BOOLEAN DEFAULT TRUE,
        is_system_defined BOOLEAN DEFAULT FALSE,
        is_deprecated BOOLEAN DEFAULT FALSE,
        deprecation_date DATE,
        replacement_type_id UUID,

        -- Localization
        localized_display_names JSONB DEFAULT '{}',
        cultural_variations JSONB DEFAULT '{}',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_relationship_types_replacement FOREIGN KEY (replacement_type_id)
            REFERENCES socialcandor_schema.relationship_types(relationship_type_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_type_code_format CHECK (type_code ~ '^[A-Z][A-Z0-9_]*$'),
        CONSTRAINT chk_exclusive_requires_consent CHECK (
            (is_exclusive = TRUE AND requires_consent = TRUE) OR
            is_exclusive = FALSE
        ),
        CONSTRAINT chk_deprecation_fields CHECK (
            (is_deprecated = FALSE AND deprecation_date IS NULL) OR
            (is_deprecated = TRUE AND deprecation_date IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.relationship_types IS 'Configurable relationship taxonomy for complex social graphs';
    COMMENT ON COLUMN socialcandor_schema.relationship_types.base_strength_score IS 'Initial relationship strength for this relationship type';

    -- Indexes for relationship_types
    CREATE INDEX IF NOT EXISTS idx_relationship_types_category ON socialcandor_schema.relationship_types(category);
    CREATE INDEX IF NOT EXISTS idx_relationship_types_active ON socialcandor_schema.relationship_types(is_active) WHERE is_active = TRUE;
    CREATE INDEX IF NOT EXISTS idx_relationship_types_code ON socialcandor_schema.relationship_types(type_code);
    CREATE INDEX IF NOT EXISTS idx_relationship_types_symmetric ON socialcandor_schema.relationship_types(is_symmetric);
    CREATE INDEX IF NOT EXISTS idx_relationship_types_strength ON socialcandor_schema.relationship_types(base_strength_score DESC);

    -- Insert default relationship types
    INSERT INTO socialcandor_schema.relationship_types (
        type_name,
        type_code,
        display_name,
        description,
        category,
        is_symmetric,
        requires_consent,
        default_visibility,
        base_strength_score,
        is_system_defined,
        created_by
    ) VALUES
        (
            'FRIEND',
            'FRIEND',
            'Friend',
            'Mutual friendship with equal privileges',
            'SOCIAL',
            TRUE,
            TRUE,
            'MUTUAL',
            70.0,
            TRUE,
            uuid_nil()
        ),
        (
            'FOLLOWER',
            'FOLLOWER',
            'Follower',
            'One-way following relationship',
            'SOCIAL',
            FALSE,
            FALSE,
            'PUBLIC',
            30.0,
            TRUE,
            uuid_nil()
        ),
        (
            'FAMILY_MEMBER',
            'FAMILY',
            'Family Member',
            'Family relationship with close ties',
            'FAMILY',
            TRUE,
            TRUE,
            'MUTUAL',
            90.0,
            TRUE,
            uuid_nil()
        ),
        (
            'COLLEAGUE',
            'COLLEAGUE',
            'Colleague',
            'Professional work relationship',
            'PROFESSIONAL',
            TRUE,
            TRUE,
            'MUTUAL',
            60.0,
            TRUE,
            uuid_nil()
        ),
        (
            'CLASSMATE',
            'CLASSMATE',
            'Classmate',
            'Educational relationship',
            'EDUCATIONAL',
            TRUE,
            TRUE,
            'MUTUAL',
            50.0,
            TRUE,
            uuid_nil()
        )
    ON CONFLICT (type_code) DO UPDATE SET
        display_name = EXCLUDED.display_name,
        description = EXCLUDED.description,
        updated_at = CURRENT_TIMESTAMP;

    -- Trigger for updated_at
    CREATE TRIGGER trg_relationship_types_updated_at
        BEFORE UPDATE ON socialcandor_schema.relationship_types
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 86 - user_relationships
    -- Description: Flexible relationship storage with strength weighting and directionality
    -- Business Case: Powers "People You May Know" algorithms through relationship strength
    -- inference while enabling relationship decay modeling for stale connection detection.
    -- Supports complex relationship dynamics beyond simple binary connections.
    -- Feature Reference: REL04 (Relationship Management), ALG01 (Recommendation Algorithms), GRAPH02 (Graph Analytics)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.user_relationships (
        relationship_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        user_id UUID NOT NULL,
        related_user_id UUID NOT NULL,
        relationship_type_id UUID NOT NULL,

        -- Relationship status
        relationship_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
            relationship_status IN ('PENDING', 'ACTIVE', 'INACTIVE', 'BLOCKED', 'HIDDEN', 'ARCHIVED')
        ),
        is_mutual BOOLEAN DEFAULT FALSE,
        is_verified BOOLEAN DEFAULT FALSE,

        -- Strength and quality metrics
        strength_score NUMERIC(5,2) DEFAULT 50.0 CHECK (strength_score >= 0 AND strength_score <= 100),
        confidence_score NUMERIC(5,2) DEFAULT 80.0 CHECK (confidence_score >= 0 AND confidence_score <= 100),
        quality_score NUMERIC(5,2) DEFAULT 50.0 CHECK (quality_score >= 0 AND quality_score <= 100),

        -- Interaction metrics
        interaction_frequency_days NUMERIC(10,2) CHECK (interaction_frequency_days >= 0),
        last_interaction_at TIMESTAMP WITH TIME ZONE,
        total_interactions INTEGER DEFAULT 0 CHECK (total_interactions >= 0),
        interaction_intensity NUMERIC(5,2) DEFAULT 1.0 CHECK (interaction_intensity >= 0),

        -- Content sharing metrics
        shared_content_count INTEGER DEFAULT 0 CHECK (shared_content_count >= 0),
        mutual_interests_count INTEGER DEFAULT 0 CHECK (mutual_interests_count >= 0),
        common_groups_count INTEGER DEFAULT 0 CHECK (common_groups_count >= 0),

        -- Privacy settings
        visibility_setting VARCHAR(20) DEFAULT 'DEFAULT' CHECK (
            visibility_setting IN ('DEFAULT', 'PUBLIC', 'FRIENDS', 'MUTUAL', 'PRIVATE', 'HIDDEN')
        ),
        content_sharing_level VARCHAR(20) DEFAULT 'DEFAULT' CHECK (
            content_sharing_level IN ('DEFAULT', 'ALL', 'SOME', 'NONE', 'CUSTOM')
        ),
        notification_preferences_overrides JSONB DEFAULT '{}',

        -- Custom fields
        custom_label VARCHAR(100),
        custom_metadata JSONB DEFAULT '{}',
        notes TEXT,

        -- Relationship timeline
        relationship_start_date DATE,
        relationship_established_at TIMESTAMP WITH TIME ZONE,
        last_strength_update TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        relationship_end_date DATE,
        end_reason VARCHAR(200),

        -- Source and context
        source_type VARCHAR(50) DEFAULT 'MANUAL' CHECK (
            source_type IN ('MANUAL', 'IMPORT', 'SUGGESTION', 'ALGORITHM', 'EVENT', 'GROUP')
        ),
        source_details JSONB DEFAULT '{}',
        context_tags VARCHAR(50)[] DEFAULT '{}',

        -- Verification and trust
        verification_method VARCHAR(50),
        verification_timestamp TIMESTAMP WITH TIME ZONE,
        trust_indicator VARCHAR(20) DEFAULT 'NEUTRAL' CHECK (
            trust_indicator IN ('HIGH_TRUST', 'MEDIUM_TRUST', 'NEUTRAL', 'LOW_TRUST', 'DISTRUST')
        ),

        -- Platform metrics
        algorithm_weight NUMERIC(10,6) DEFAULT 1.0 CHECK (algorithm_weight >= 0),
        recommendation_priority INTEGER DEFAULT 5 CHECK (recommendation_priority BETWEEN 1 AND 10),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_user_relationships_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_user_relationships_related_user FOREIGN KEY (related_user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_user_relationships_type FOREIGN KEY (relationship_type_id)
            REFERENCES socialcandor_schema.relationship_types(relationship_type_id) ON DELETE RESTRICT,

        -- Constraints
        CONSTRAINT uk_user_relationships_uniq UNIQUE (user_id, related_user_id, relationship_type_id),
        CONSTRAINT chk_users_not_same CHECK (user_id != related_user_id),
        CONSTRAINT chk_strength_update_timestamp CHECK (
            last_strength_update >= created_at
        ),
        CONSTRAINT chk_relationship_dates CHECK (
            (relationship_start_date IS NULL) OR
            (relationship_end_date IS NULL) OR
            (relationship_end_date >= relationship_start_date)
        )
    );

    COMMENT ON TABLE socialcandor_schema.user_relationships IS 'Flexible relationship storage with strength scoring and interaction tracking';
    COMMENT ON COLUMN socialcandor_schema.user_relationships.strength_score IS 'Dynamic score representing relationship strength based on interactions';

    -- Indexes for user_relationships
    CREATE INDEX IF NOT EXISTS idx_user_relationships_user ON socialcandor_schema.user_relationships(user_id);
    CREATE INDEX IF NOT EXISTS idx_user_relationships_related_user ON socialcandor_schema.user_relationships(related_user_id);
    CREATE INDEX IF NOT EXISTS idx_user_relationships_type ON socialcandor_schema.user_relationships(relationship_type_id);
    CREATE INDEX IF NOT EXISTS idx_user_relationships_status ON socialcandor_schema.user_relationships(relationship_status);
    CREATE INDEX IF NOT EXISTS idx_user_relationships_strength ON socialcandor_schema.user_relationships(strength_score DESC);
    CREATE INDEX IF NOT EXISTS idx_user_relationships_mutual ON socialcandor_schema.user_relationships(is_mutual) WHERE is_mutual = TRUE;
    CREATE INDEX IF NOT EXISTS idx_user_relationships_interaction ON socialcandor_schema.user_relationships(last_interaction_at DESC NULLS LAST);

    -- Materialized view for user relationship network
    CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_user_relationship_network AS
    SELECT
        user_id,
        COUNT(*) as total_relationships,
        COUNT(*) FILTER (WHERE is_mutual = TRUE) as mutual_relationships,
        COUNT(DISTINCT relationship_type_id) as relationship_types_count,
        AVG(strength_score) as avg_relationship_strength,
        MAX(strength_score) as max_relationship_strength,
        COUNT(*) FILTER (WHERE last_interaction_at >= CURRENT_TIMESTAMP - INTERVAL '30 days') as active_relationships_30d,
        COUNT(*) FILTER (WHERE relationship_status = 'BLOCKED') as blocked_relationships
    FROM socialcandor_schema.user_relationships
    WHERE relationship_status IN ('ACTIVE', 'PENDING')
    GROUP BY user_id
    WITH DATA;

    CREATE UNIQUE INDEX idx_mv_user_relationship_network_user ON socialcandor_schema.mv_user_relationship_network(user_id);

    -- Trigger for relationship strength decay
    CREATE OR REPLACE FUNCTION socialcandor_schema.update_relationship_strength()
    RETURNS TRIGGER AS $$
    DECLARE
        v_days_since_interaction NUMERIC;
        v_decay_rate NUMERIC;
        v_new_strength NUMERIC;
    BEGIN
        -- Calculate days since last interaction
        v_days_since_interaction := EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - COALESCE(NEW.last_interaction_at, NEW.created_at))) / 86400.0;

        -- Get decay rate from relationship type
        SELECT decay_rate_per_day INTO v_decay_rate
        FROM socialcandor_schema.relationship_types
        WHERE relationship_type_id = NEW.relationship_type_id;

        -- Apply decay if more than 7 days since interaction
        IF v_days_since_interaction > 7 THEN
            v_new_strength := NEW.strength_score * POWER(0.99, v_days_since_interaction - 7);

            -- Ensure strength doesn't drop below minimum
            IF v_new_strength < 10 THEN
                v_new_strength := 10;
            END IF;

            NEW.strength_score := ROUND(v_new_strength, 2);
            NEW.last_strength_update := CURRENT_TIMESTAMP;
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_user_relationships_strength_decay
        BEFORE UPDATE OF last_interaction_at ON socialcandor_schema.user_relationships
        FOR EACH ROW
        WHEN (NEW.last_interaction_at IS NOT NULL)
        EXECUTE FUNCTION socialcandor_schema.update_relationship_strength();

    -- Trigger for updated_at
    CREATE TRIGGER trg_user_relationships_updated_at
        BEFORE UPDATE ON socialcandor_schema.user_relationships
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();
	

--       ------------------------------------------------------------------------------------------------
--       -- Table: 87 - user_relationships
--       -- Description: Flexible relationship storage with strength weighting and directionality
--       -- Business Case: Powers "People You May Know" algorithms through relationship strength
--       -- inference while enabling relationship decay modeling for stale connection detection.
--       -- Supports complex social graphs beyond simple follows/friends for sophisticated
--       -- network analysis and recommendation systems.
--       -- Feature Reference: REL03 (Relationship Intelligence), NET03 (Network Analysis), REC03 (Recommendations)
--       ------------------------------------------------------------------------------------------------
--       CREATE TABLE IF NOT EXISTS socialcandor_schema.user_relationships (
--           relationship_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
--           source_user_id UUID NOT NULL,
--           target_user_id UUID NOT NULL,

--           -- Relationship definition
--           relationship_type socialcandor_schema.relationship_type NOT NULL,
--           relationship_direction VARCHAR(20) NOT NULL DEFAULT 'UNDIRECTED' CHECK (
--               relationship_direction IN ('DIRECTED', 'UNDIRECTED', 'MUTUAL', 'ASYMMETRIC')
--           ),

--           -- Strength and weighting
--           relationship_strength NUMERIC(5,2) DEFAULT 50.0 CHECK (relationship_strength >= 0 AND relationship_strength <= 100),
--           strength_confidence NUMERIC(5,2) DEFAULT 50.0 CHECK (strength_confidence >= 0 AND strength_confidence <= 100),
--           weight NUMERIC(10,6) DEFAULT 1.0,

--           -- Interaction metrics
--           interaction_frequency INTEGER DEFAULT 0 CHECK (interaction_frequency >= 0),
--           last_interaction_at TIMESTAMP WITH TIME ZONE,
--           interaction_types VARCHAR(50)[] DEFAULT '{}',
--           total_interaction_score INTEGER DEFAULT 0 CHECK (total_interaction_score >= 0),

--           -- Content sharing metrics
--           content_shared_count INTEGER DEFAULT 0 CHECK (content_shared_count >= 0),
--           content_interaction_count INTEGER DEFAULT 0 CHECK (content_interaction_count >= 0),
--           mutual_content_interest_score NUMERIC(5,2) DEFAULT 0.0 CHECK (mutual_content_interest_score >= 0 AND mutual_content_interest_score <= 100),

--           -- Temporal dynamics
--           relationship_age_days INTEGER DEFAULT 0 CHECK (relationship_age_days >= 0),
--           decay_factor NUMERIC(5,4) DEFAULT 1.0 CHECK (decay_factor >= 0 AND decay_factor <= 1),
--           last_strength_update TIMESTAMP WITH TIME ZONE,

--           -- Context and metadata
--           relationship_context VARCHAR(100),
--           context_confidence NUMERIC(5,2) DEFAULT 0.0 CHECK (context_confidence >= 0 AND context_confidence <= 100),
--           tags VARCHAR(50)[] DEFAULT '{}',
--           notes TEXT,

--           -- Inferred vs explicit
--           is_inferred BOOLEAN DEFAULT FALSE,
--           inference_source VARCHAR(50) CHECK (inference_source IN ('BEHAVIOR', 'CONTENT', 'NETWORK', 'DEMOGRAPHIC', 'HYBRID')),
--           inference_confidence NUMERIC(5,2) DEFAULT 0.0 CHECK (inference_confidence >= 0 AND inference_confidence <= 100),

--           -- Relationship status
--           is_active BOOLEAN DEFAULT TRUE,
--           archived_at TIMESTAMP WITH TIME ZONE,
--           archive_reason VARCHAR(200),

--           -- Audit and metadata
--           created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
--           updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
--           created_by UUID NOT NULL,
--           updated_by UUID DEFAULT uuid_nil(),

--           -- Foreign key constraints
--           CONSTRAINT fk_user_relationships_source FOREIGN KEY (source_user_id)
--               REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
--           CONSTRAINT fk_user_relationships_target FOREIGN KEY (target_user_id)
--               REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

--           -- Constraints
--           CONSTRAINT uk_user_relationships_unique UNIQUE (source_user_id, target_user_id, relationship_type),
--           CONSTRAINT chk_user_relationships_not_self CHECK (source_user_id != target_user_id),
--           CONSTRAINT chk_strength_updates CHECK (
--               (last_strength_update IS NULL) OR
--               (last_strength_update >= created_at)
--           )
--       );

--       COMMENT ON TABLE socialcandor_schema.user_relationships IS 'Flexible relationship storage with strength weighting and directionality for network analysis';
--       COMMENT ON COLUMN socialcandor_schema.user_relationships.decay_factor IS 'Factor applied to relationship strength over time (1.0 = no decay)';

--       -- Indexes for user_relationships
--       CREATE INDEX IF NOT EXISTS idx_user_relationships_source ON socialcandor_schema.user_relationships(source_user_id);
--       CREATE INDEX IF NOT EXISTS idx_user_relationships_target ON socialcandor_schema.user_relationships(target_user_id);
--       CREATE INDEX IF NOT EXISTS idx_user_relationships_type ON socialcandor_schema.user_relationships(relationship_type);
--       CREATE INDEX IF NOT EXISTS idx_user_relationships_strength ON socialcandor_schema.user_relationships(relationship_strength DESC);
--       CREATE INDEX IF NOT EXISTS idx_user_relationships_interaction ON socialcandor_schema.user_relationships(last_interaction_at DESC);
--       CREATE INDEX IF NOT EXISTS idx_user_relationships_bidirectional ON socialcandor_schema.user_relationships(source_user_id, target_user_id, relationship_strength);
--       CREATE INDEX IF NOT EXISTS idx_user_relationships_active ON socialcandor_schema.user_relationships(is_active) WHERE is_active = TRUE;

--       -- Trigger for relationship strength decay calculation
--       CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_relationship_decay()
--       RETURNS TRIGGER AS $$
--       DECLARE
--           v_days_since_update INTEGER;
--           v_decay_rate NUMERIC(5,4) := 0.997; -- 0.3% decay per day
--           v_min_strength NUMERIC(5,2) := 5.0; -- Minimum strength threshold
--       BEGIN
--           IF NEW.last_interaction_at IS NOT NULL AND OLD.last_interaction_at IS NOT NULL THEN
--               -- Calculate days since last interaction
--               v_days_since_update := EXTRACT(DAY FROM (CURRENT_TIMESTAMP - NEW.last_interaction_at));

--               -- Apply exponential decay
--               NEW.decay_factor := POWER(v_decay_rate, v_days_since_update);
--               NEW.relationship_strength := GREATEST(
--                   v_min_strength,
--                   NEW.relationship_strength * NEW.decay_factor
--               );
--               NEW.last_strength_update := CURRENT_TIMESTAMP;
--           END IF;

--           RETURN NEW;
--       END;
--       $$ LANGUAGE plpgsql;

--       CREATE TRIGGER trg_user_relationships_decay
--           BEFORE UPDATE OF last_interaction_at ON socialcandor_schema.user_relationships
--           FOR EACH ROW
--           EXECUTE FUNCTION socialcandor_schema.calculate_relationship_decay();

--       -- Trigger for updated_at
--       CREATE TRIGGER trg_user_relationships_updated_at
--           BEFORE UPDATE ON socialcandor_schema.user_relationships
--           FOR EACH ROW
--           EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

      ------------------------------------------------------------------------------------------------
      -- Table: 88 - privacy_settings
      -- Description: Granular user privacy controls with visibility presets
      -- Business Case: Meets evolving privacy regulations (GDPR, CCPA) while reducing support
      -- tickets through intuitive privacy controls and automatic privacy checkups based on
      -- content sharing patterns. Enables users to control exactly who can see their information.
      -- Feature Reference: PRV04 (Privacy Controls), COMP05 (Regulatory Compliance), US05 (User Experience)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.privacy_settings (
          privacy_setting_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
          user_id UUID NOT NULL UNIQUE,

          -- Profile visibility
          profile_visibility VARCHAR(20) DEFAULT 'PUBLIC' CHECK (
              profile_visibility IN ('PUBLIC', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'PRIVATE', 'CUSTOM')
          ),
          show_email VARCHAR(20) DEFAULT 'NOBODY' CHECK (
              show_email IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY')
          ),
          show_phone VARCHAR(20) DEFAULT 'NOBODY' CHECK (
              show_phone IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY')
          ),
          show_date_of_birth VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              show_date_of_birth IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY')
          ),
          show_location VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              show_location IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY')
          ),

          -- Activity visibility
          show_online_status VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              show_online_status IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY')
          ),
          show_last_seen VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              show_last_seen IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY')
          ),
          show_friends_list VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              show_friends_list IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY', 'CUSTOM')
          ),
          show_groups VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              show_groups IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY', 'CUSTOM')
          ),
          show_pages VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              show_pages IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY', 'CUSTOM')
          ),

          -- Content visibility defaults
          default_post_visibility socialcandor_schema.content_visibility DEFAULT 'FRIENDS',
          default_story_visibility VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              default_story_visibility IN ('PUBLIC', 'FRIENDS', 'CLOSE_FRIENDS', 'CUSTOM', 'PRIVATE')
          ),
          default_album_visibility VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              default_album_visibility IN ('PUBLIC', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'CUSTOM', 'PRIVATE')
          ),

          -- Search and discovery
          appear_in_search_results BOOLEAN DEFAULT TRUE,
          appear_in_people_suggestions BOOLEAN DEFAULT TRUE,
          allow_tagging BOOLEAN DEFAULT TRUE,
          review_tags_before_appearing BOOLEAN DEFAULT FALSE,
          allow_mentions BOOLEAN DEFAULT TRUE,

          -- Messaging privacy
          who_can_send_messages VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              who_can_send_messages IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY')
          ),
          who_can_add_to_groups VARCHAR(20) DEFAULT 'FRIENDS' CHECK (
              who_can_add_to_groups IN ('EVERYONE', 'FRIENDS', 'FRIENDS_OF_FRIENDS', 'NOBODY')
          ),
          filter_message_requests BOOLEAN DEFAULT TRUE,

          -- Data sharing and advertising
          allow_data_for_personalization BOOLEAN DEFAULT TRUE,
          allow_data_for_advertising BOOLEAN DEFAULT TRUE,
          allow_third_party_data_sharing BOOLEAN DEFAULT FALSE,
          allow_location_based_features BOOLEAN DEFAULT TRUE,
          allow_face_recognition BOOLEAN DEFAULT FALSE,

          -- Custom lists for granular control
          custom_visibility_lists JSONB DEFAULT '{
              "close_friends": [],
              "restricted": [],
              "work_colleagues": [],
              "family": []
          }',

          -- Privacy checkup tracking
          last_privacy_checkup_at TIMESTAMP WITH TIME ZONE,
          privacy_checkup_score NUMERIC(5,2) DEFAULT 0.0 CHECK (privacy_checkup_score >= 0 AND privacy_checkup_score <= 100),
          recommended_settings_changes JSONB DEFAULT '[]',

          -- Automatic privacy adjustments
          auto_adjust_privacy BOOLEAN DEFAULT FALSE,
          auto_adjustment_level VARCHAR(20) DEFAULT 'CONSERVATIVE' CHECK (
              auto_adjustment_level IN ('AGGRESSIVE', 'MODERATE', 'CONSERVATIVE', 'NONE')
          ),

          -- Regional compliance
          regional_compliance_settings JSONB DEFAULT '{
              "gdpr": {"enabled": true, "strict_mode": false},
              "ccpa": {"enabled": true, "do_not_sell": false},
              "lgpd": {"enabled": true, "data_processing": true}
          }',

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID NOT NULL,
          updated_by UUID DEFAULT uuid_nil(),

          -- Foreign key constraint
          CONSTRAINT fk_privacy_settings_user FOREIGN KEY (user_id)
              REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

          -- Constraints
          CONSTRAINT chk_privacy_consistency CHECK (
              (profile_visibility != 'PRIVATE' OR appear_in_search_results = FALSE) OR
              profile_visibility = 'PRIVATE'
          )
      );

      COMMENT ON TABLE socialcandor_schema.privacy_settings IS 'Granular user privacy controls with visibility presets and regulatory compliance';
      COMMENT ON COLUMN socialcandor_schema.privacy_settings.privacy_checkup_score IS 'Score indicating how well privacy settings are configured (0-100)';

      -- Indexes for privacy_settings
      CREATE INDEX IF NOT EXISTS idx_privacy_settings_user ON socialcandor_schema.privacy_settings(user_id);
      CREATE INDEX IF NOT EXISTS idx_privacy_settings_visibility ON socialcandor_schema.privacy_settings(profile_visibility);
      CREATE INDEX IF NOT EXISTS idx_privacy_settings_auto_adjust ON socialcandor_schema.privacy_settings(auto_adjust_privacy) WHERE auto_adjust_privacy = TRUE;

      -- Function for automatic privacy adjustments
      CREATE OR REPLACE FUNCTION socialcandor_schema.auto_adjust_privacy_settings()
      RETURNS TRIGGER AS $$
      DECLARE
          v_risk_score NUMERIC(5,2);
          v_new_friend_count INTEGER;
          v_public_post_count INTEGER;
      BEGIN
          -- Only run if auto_adjust_privacy is enabled
          IF NEW.auto_adjust_privacy = TRUE THEN
              -- Calculate risk score based on user behavior
              SELECT
                  COUNT(*) INTO v_new_friend_count
              FROM socialcandor_schema.friends f
              WHERE (f.user_id = NEW.user_id OR f.friend_user_id = NEW.user_id)
              AND f.created_at >= CURRENT_TIMESTAMP - INTERVAL '7 days'
              AND f.status = 'ACCEPTED';

              SELECT
                  COUNT(*) INTO v_public_post_count
              FROM socialcandor_schema.posts p
              WHERE p.user_id = NEW.user_id
              AND p.visibility = 'PUBLIC'
              AND p.created_at >= CURRENT_TIMESTAMP - INTERVAL '30 days';

              -- Simple risk calculation
              v_risk_score := LEAST(100,
                  (v_new_friend_count * 2) +
                  (v_public_post_count * 1) +
                  CASE WHEN NEW.profile_visibility = 'PUBLIC' THEN 20 ELSE 0 END
              );

              -- Adjust settings based on risk and adjustment level
              IF NEW.auto_adjustment_level = 'AGGRESSIVE' THEN
                  IF v_risk_score > 50 THEN
                      NEW.profile_visibility := 'FRIENDS';
                      NEW.appear_in_search_results := FALSE;
                      NEW.who_can_send_messages := 'FRIENDS';
                  END IF;
              ELSIF NEW.auto_adjustment_level = 'MODERATE' THEN
                  IF v_risk_score > 70 THEN
                      NEW.profile_visibility := 'FRIENDS';
                  END IF;
              ELSIF NEW.auto_adjustment_level = 'CONSERVATIVE' THEN
                  IF v_risk_score > 90 THEN
                      NEW.profile_visibility := 'FRIENDS';
                  END IF;
              END IF;
          END IF;

          RETURN NEW;
      END;
      $$ LANGUAGE plpgsql;

      CREATE TRIGGER trg_privacy_settings_auto_adjust
          BEFORE UPDATE ON socialcandor_schema.privacy_settings
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.auto_adjust_privacy_settings();

      -- Trigger for updated_at
      CREATE TRIGGER trg_privacy_settings_updated_at
          BEFORE UPDATE ON socialcandor_schema.privacy_settings
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

      ------------------------------------------------------------------------------------------------
      -- Table: 89 - post_visibility
      -- Description: Post-level visibility rules beyond global privacy settings
      -- Business Case: Enables context-aware sharing (e.g., "share with friends except X")
      -- while maintaining performance through visibility precomputation during feed generation.
      -- Supports complex privacy scenarios without compromising user experience or system performance.
      -- Feature Reference: PRV05 (Content Privacy), CNT04 (Content Distribution), PERF05 (Feed Performance)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.post_visibility (
          post_visibility_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
          post_id UUID NOT NULL,
          user_id UUID NOT NULL,

          -- Visibility configuration
          visibility_type VARCHAR(20) NOT NULL DEFAULT 'STANDARD' CHECK (
              visibility_type IN ('STANDARD', 'CUSTOM', 'EXCEPTIONS', 'ONLY_THESE', 'HYBRID')
          ),
          base_visibility socialcandor_schema.content_visibility NOT NULL,

          -- Exception lists
          excluded_users UUID[] DEFAULT '{}',
          excluded_groups UUID[] DEFAULT '{}',
          excluded_segments UUID[] DEFAULT '{}',

          -- Inclusion lists (for ONLY_THESE type)
          included_users UUID[] DEFAULT '{}',
          included_groups UUID[] DEFAULT '{}',
          included_segments UUID[] DEFAULT '{}',

          -- Advanced rules
          visibility_rules JSONB DEFAULT '{
              "allow_sharing": true,
              "allow_comments": true,
              "allow_reactions": true,
              "expire_after": null,
              "schedule_visibility": null,
              "location_restrictions": null,
              "device_restrictions": null
          }',

          -- Precomputed visibility
          precomputed_visible_to_users UUID[] DEFAULT '{}',
          precomputed_hidden_from_users UUID[] DEFAULT '{}',
          is_precomputed BOOLEAN DEFAULT FALSE,
          last_precomputed_at TIMESTAMP WITH TIME ZONE,

          -- Performance metrics
          computation_time_ms INTEGER,
          estimated_visible_count INTEGER DEFAULT 0 CHECK (estimated_visible_count >= 0),

          -- Versioning and updates
          version INTEGER DEFAULT 1 CHECK (version >= 1),
          previous_version_id UUID,
          update_reason VARCHAR(200),

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID NOT NULL,
          updated_by UUID DEFAULT uuid_nil(),

          -- Foreign key constraints
          CONSTRAINT fk_post_visibility_post FOREIGN KEY (post_id)
              REFERENCES socialcandor_schema.posts(post_id) ON DELETE CASCADE,
          CONSTRAINT fk_post_visibility_user FOREIGN KEY (user_id)
              REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

          -- Constraints
          CONSTRAINT uk_post_visibility_post UNIQUE (post_id),
          CONSTRAINT chk_visibility_consistency CHECK (
              (visibility_type != 'ONLY_THESE' OR
               (CARDINALITY(included_users) > 0 OR
                CARDINALITY(included_groups) > 0 OR
                CARDINALITY(included_segments) > 0)) OR
              visibility_type = 'ONLY_THESE'
          ),
          CONSTRAINT chk_exclusion_inclusion_exclusivity CHECK (
              (CARDINALITY(excluded_users) = 0 OR CARDINALITY(included_users) = 0) OR
              visibility_type != 'HYBRID'
          )
      );

      COMMENT ON TABLE socialcandor_schema.post_visibility IS 'Post-level visibility rules beyond global privacy settings';
      COMMENT ON COLUMN socialcandor_schema.post_visibility.precomputed_visible_to_users IS 'Precomputed list of users who can see this post for performance optimization';

      -- Indexes for post_visibility
      CREATE INDEX IF NOT EXISTS idx_post_visibility_post ON socialcandor_schema.post_visibility(post_id);
      CREATE INDEX IF NOT EXISTS idx_post_visibility_user ON socialcandor_schema.post_visibility(user_id);
      CREATE INDEX IF NOT EXISTS idx_post_visibility_type ON socialcandor_schema.post_visibility(visibility_type);
      CREATE INDEX IF NOT EXISTS idx_post_visibility_precomputed ON socialcandor_schema.post_visibility(is_precomputed) WHERE is_precomputed = TRUE;
      CREATE INDEX IF NOT EXISTS idx_post_visibility_created_at ON socialcandor_schema.post_visibility(created_at DESC);

      -- GIN indexes for array columns
      CREATE INDEX IF NOT EXISTS idx_post_visibility_excluded_users ON socialcandor_schema.post_visibility USING GIN(excluded_users);
      CREATE INDEX IF NOT EXISTS idx_post_visibility_included_users ON socialcandor_schema.post_visibility USING GIN(included_users);
      CREATE INDEX IF NOT EXISTS idx_post_visibility_precomputed_users ON socialcandor_schema.post_visibility USING GIN(precomputed_visible_to_users);

      -- Function to precompute visibility
      CREATE OR REPLACE FUNCTION socialcandor_schema.precompute_post_visibility(p_post_id UUID)
      RETURNS INTEGER AS $$
      DECLARE
          v_post_visibility RECORD;
          v_visible_users UUID[];
          v_hidden_users UUID[];
          v_start_time TIMESTAMP;
          v_end_time TIMESTAMP;
          v_duration_ms INTEGER;
      BEGIN
          v_start_time := clock_timestamp();

          -- Get visibility configuration
          SELECT * INTO v_post_visibility
          FROM socialcandor_schema.post_visibility
          WHERE post_id = p_post_id;

          IF NOT FOUND THEN
              RETURN 0;
          END IF;

          -- Calculate visibility based on type
          CASE v_post_visibility.visibility_type
              WHEN 'STANDARD' THEN
                  -- Use base visibility logic
                  SELECT ARRAY_AGG(user_id) INTO v_visible_users
                  FROM socialcandor_schema.get_visible_users_for_post(
                      p_post_id,
                      v_post_visibility.base_visibility,
                      v_post_visibility.user_id
                  );

              WHEN 'CUSTOM' THEN
                  -- Base visibility with exceptions
                  WITH base_visible AS (
                      SELECT user_id
                      FROM socialcandor_schema.get_visible_users_for_post(
                          p_post_id,
                          v_post_visibility.base_visibility,
                          v_post_visibility.user_id
                      )
                  )
                  SELECT
                      ARRAY_AGG(user_id) INTO v_visible_users
                  FROM base_visible
                  WHERE user_id != ALL(v_post_visibility.excluded_users);

              WHEN 'ONLY_THESE' THEN
                  -- Only specified users/groups
                  v_visible_users := v_post_visibility.included_users;

              WHEN 'HYBRID' THEN
                  -- Complex hybrid logic
                  WITH base_visible AS (
                      SELECT user_id
                      FROM socialcandor_schema.get_visible_users_for_post(
                          p_post_id,
                          v_post_visibility.base_visibility,
                          v_post_visibility.user_id
                      )
                  ),
                  included_users AS (
                      SELECT UNNEST(v_post_visibility.included_users) AS user_id
                  )
                  SELECT
                      ARRAY_AGG(DISTINCT COALESCE(i.user_id, b.user_id)) INTO v_visible_users
                  FROM base_visible b
                  FULL OUTER JOIN included_users i ON b.user_id = i.user_id
                  WHERE b.user_id != ALL(v_post_visibility.excluded_users);

              ELSE
                  -- Default to standard
                  SELECT ARRAY_AGG(user_id) INTO v_visible_users
                  FROM socialcandor_schema.get_visible_users_for_post(
                      p_post_id,
                      v_post_visibility.base_visibility,
                      v_post_visibility.user_id
                  );
          END CASE;

          -- Update precomputed visibility
          UPDATE socialcandor_schema.post_visibility
          SET
              precomputed_visible_to_users = v_visible_users,
              precomputed_hidden_from_users = v_hidden_users,
              is_precomputed = TRUE,
              last_precomputed_at = CURRENT_TIMESTAMP,
              estimated_visible_count = COALESCE(array_length(v_visible_users, 1), 0),
              computation_time_ms = EXTRACT(MILLISECONDS FROM (clock_timestamp() - v_start_time)),
              updated_at = CURRENT_TIMESTAMP
          WHERE post_id = p_post_id;

          v_end_time := clock_timestamp();
          v_duration_ms := EXTRACT(MILLISECONDS FROM (v_end_time - v_start_time));

          RETURN COALESCE(array_length(v_visible_users, 1), 0);

      EXCEPTION
          WHEN OTHERS THEN
              RAISE NOTICE 'Error precomputing visibility for post %: %', p_post_id, SQLERRM;
              RETURN -1;
      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.precompute_post_visibility IS 'Precomputes visibility lists for a post to optimize feed generation performance';

      -- Trigger for updated_at
      CREATE TRIGGER trg_post_visibility_updated_at
          BEFORE UPDATE ON socialcandor_schema.post_visibility
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

      ------------------------------------------------------------------------------------------------
      -- Table: 90 - post_visibility_custom
      -- Description: Custom audience definitions for individual posts
      -- Business Case: Supports complex sharing scenarios (e.g., "share with marketing team members")
      -- while preventing privacy leaks through audience validation during post creation.
      -- Enables enterprise-grade content distribution with fine-grained audience control.
      -- Feature Reference: PRV06 (Custom Audiences), ENT01 (Enterprise Features), SEC05 (Privacy Validation)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.post_visibility_custom (
          custom_audience_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
          post_id UUID NOT NULL,
          user_id UUID NOT NULL,

          -- Audience definition
          audience_name VARCHAR(200) NOT NULL,
          audience_type VARCHAR(30) NOT NULL DEFAULT 'STATIC' CHECK (
              audience_type IN ('STATIC', 'DYNAMIC', 'HYBRID', 'QUERY_BASED')
          ),

          -- Static audience members
          static_user_ids UUID[] DEFAULT '{}',
          static_group_ids UUID[] DEFAULT '{}',
          static_segment_ids UUID[] DEFAULT '{}',

          -- Dynamic audience criteria
          dynamic_criteria JSONB DEFAULT '{
              "min_trust_score": 0,
              "max_trust_score": 100,
              "required_tags": [],
              "excluded_tags": [],
              "relationship_types": [],
              "interaction_history": {},
              "demographic_filters": {},
              "behavioral_filters": {}
          }',

          -- Query-based audience (for complex SQL-based definitions)
          audience_query TEXT,
          query_parameters JSONB DEFAULT '{}',

          -- Audience validation
          is_validated BOOLEAN DEFAULT FALSE,
          validation_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
              validation_status IN ('PENDING', 'VALID', 'INVALID', 'NEEDS_REVIEW')
          ),
          validation_errors TEXT[] DEFAULT '{}',
          last_validated_at TIMESTAMP WITH TIME ZONE,
          validated_by UUID,

          -- Audience statistics
          estimated_audience_size INTEGER,
          actual_audience_size INTEGER,
          audience_growth_rate NUMERIC(5,2),
          last_size_calculated_at TIMESTAMP WITH TIME ZONE,

          -- Sharing permissions
          allow_resharing BOOLEAN DEFAULT FALSE,
          resharing_depth INTEGER DEFAULT 1 CHECK (resharing_depth >= 0 AND resharing_depth <= 10),
          require_resharing_approval BOOLEAN DEFAULT TRUE,

          -- Expiration and scheduling
          expires_at TIMESTAMP WITH TIME ZONE,
          is_recurring BOOLEAN DEFAULT FALSE,
          recurrence_pattern VARCHAR(100),

          -- Security and compliance
          requires_authentication BOOLEAN DEFAULT TRUE,
          requires_encryption BOOLEAN DEFAULT FALSE,
          compliance_level VARCHAR(20) DEFAULT 'STANDARD' CHECK (
              compliance_level IN ('STANDARD', 'HIGH', 'VERY_HIGH', 'RESTRICTED')
          ),

          -- Version management
          version INTEGER DEFAULT 1 CHECK (version >= 1),
          is_latest_version BOOLEAN DEFAULT TRUE,
          previous_version_id UUID,
          change_log TEXT,

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID NOT NULL,
          updated_by UUID DEFAULT uuid_nil(),

          -- Foreign key constraints
          CONSTRAINT fk_post_visibility_custom_post FOREIGN KEY (post_id)
              REFERENCES socialcandor_schema.posts(post_id) ON DELETE CASCADE,
          CONSTRAINT fk_post_visibility_custom_user FOREIGN KEY (user_id)
              REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

          -- Constraints
          CONSTRAINT uk_post_visibility_custom_post UNIQUE (post_id),
          CONSTRAINT chk_audience_criteria CHECK (
              (audience_type != 'STATIC' OR
               (CARDINALITY(static_user_ids) > 0 OR
                CARDINALITY(static_group_ids) > 0 OR
                CARDINALITY(static_segment_ids) > 0)) OR
              audience_type = 'STATIC'
          ),
          CONSTRAINT chk_audience_query CHECK (
              (audience_type != 'QUERY_BASED' OR audience_query IS NOT NULL) OR
              audience_type = 'QUERY_BASED'
          )
      );

      COMMENT ON TABLE socialcandor_schema.post_visibility_custom IS 'Custom audience definitions for individual posts with validation and compliance features';
      COMMENT ON COLUMN socialcandor_schema.post_visibility_custom.compliance_level IS 'Data protection compliance level required for this audience';

      -- Indexes for post_visibility_custom
      CREATE INDEX IF NOT EXISTS idx_post_visibility_custom_post ON socialcandor_schema.post_visibility_custom(post_id);
      CREATE INDEX IF NOT EXISTS idx_post_visibility_custom_user ON socialcandor_schema.post_visibility_custom(user_id);
      CREATE INDEX IF NOT EXISTS idx_post_visibility_custom_type ON socialcandor_schema.post_visibility_custom(audience_type);
      CREATE INDEX IF NOT EXISTS idx_post_visibility_custom_validated ON socialcandor_schema.post_visibility_custom(is_validated) WHERE is_validated = TRUE;
      CREATE INDEX IF NOT EXISTS idx_post_visibility_custom_expires ON socialcandor_schema.post_visibility_custom(expires_at) WHERE expires_at IS NOT NULL;

      -- GIN indexes for array columns
      CREATE INDEX IF NOT EXISTS idx_post_visibility_custom_static_users ON socialcandor_schema.post_visibility_custom USING GIN(static_user_ids);
      CREATE INDEX IF NOT EXISTS idx_post_visibility_custom_static_groups ON socialcandor_schema.post_visibility_custom USING GIN(static_group_ids);

      -- Function to validate custom audience
      CREATE OR REPLACE FUNCTION socialcandor_schema.validate_custom_audience(p_custom_audience_id UUID)
      RETURNS TABLE(
          is_valid BOOLEAN,
          validation_errors TEXT[],
          estimated_size INTEGER,
          actual_size INTEGER
      ) AS $$
      DECLARE
          v_custom_audience RECORD;
          v_validation_errors TEXT[] := '{}';
          v_estimated_size INTEGER;
          v_actual_size INTEGER;
          v_is_valid BOOLEAN := TRUE;
          v_user_count INTEGER;
          v_group_count INTEGER;
          v_segment_count INTEGER;
      BEGIN
          -- Get audience definition
          SELECT * INTO v_custom_audience
          FROM socialcandor_schema.post_visibility_custom
          WHERE custom_audience_id = p_custom_audience_id;

          IF NOT FOUND THEN
              v_validation_errors := array_append(v_validation_errors, 'Custom audience not found');
              v_is_valid := FALSE;
              RETURN QUERY SELECT v_is_valid, v_validation_errors, 0, 0;
              RETURN;
          END IF;

          -- Validate based on audience type
          CASE v_custom_audience.audience_type
              WHEN 'STATIC' THEN
                  -- Validate static users exist and are active
                  SELECT COUNT(*) INTO v_user_count
                  FROM socialcandor_schema.users u
                  WHERE u.user_id = ANY(v_custom_audience.static_user_ids)
                  AND u.status = 'ACTIVE';

                  IF v_user_count < array_length(v_custom_audience.static_user_ids, 1) THEN
                      v_validation_errors := array_append(v_validation_errors,
                          'Some users in the audience are not active or do not exist');
                      v_is_valid := FALSE;
                  END IF;

                  -- Validate groups exist
                  SELECT COUNT(*) INTO v_group_count
                  FROM socialcandor_schema.groups g
                  WHERE g.group_id = ANY(v_custom_audience.static_group_ids)
                  AND g.is_active = TRUE;

                  IF v_group_count < array_length(v_custom_audience.static_group_ids, 1) THEN
                      v_validation_errors := array_append(v_validation_errors,
                          'Some groups in the audience do not exist or are not active');
                      v_is_valid := FALSE;
                  END IF;

                  v_estimated_size := v_user_count + (v_group_count * 10); -- Estimate 10 users per group

              WHEN 'DYNAMIC' THEN
                  -- Validate dynamic criteria structure
                  IF NOT jsonb_typeof(v_custom_audience.dynamic_criteria) = 'object' THEN
                      v_validation_errors := array_append(v_validation_errors,
                          'Dynamic criteria must be a JSON object');
                      v_is_valid := FALSE;
                  END IF;

                  -- Simple estimation for dynamic audience
                  v_estimated_size := 100; -- Placeholder

              WHEN 'QUERY_BASED' THEN
                  -- Validate query syntax (basic check)
                  IF v_custom_audience.audience_query IS NULL OR
                     LENGTH(TRIM(v_custom_audience.audience_query)) = 0 THEN
                      v_validation_errors := array_append(v_validation_errors,
                          'Query-based audience requires a valid SQL query');
                      v_is_valid := FALSE;
                  ELSE
                      -- Try to explain the query (syntax check)
                      BEGIN
                          EXECUTE 'EXPLAIN ' || v_custom_audience.audience_query;
                      EXCEPTION
                          WHEN OTHERS THEN
                              v_validation_errors := array_append(v_validation_errors,
                                  'Invalid SQL query: ' || SQLERRM);
                              v_is_valid := FALSE;
                      END;
                  END IF;

                  v_estimated_size := 50; -- Placeholder

              ELSE
                  v_validation_errors := array_append(v_validation_errors,
                      'Unsupported audience type');
                  v_is_valid := FALSE;
          END CASE;

          -- Validate compliance requirements
          IF v_custom_audience.compliance_level = 'RESTRICTED' AND
             v_custom_audience.requires_encryption = FALSE THEN
              v_validation_errors := array_append(v_validation_errors,
                  'Restricted compliance level requires encryption');
              v_is_valid := FALSE;
          END IF;

          -- Update validation status
          UPDATE socialcandor_schema.post_visibility_custom
          SET
              is_validated = v_is_valid,
              validation_status = CASE WHEN v_is_valid THEN 'VALID' ELSE 'INVALID' END,
              validation_errors = v_validation_errors,
              estimated_audience_size = v_estimated_size,
              last_validated_at = CURRENT_TIMESTAMP,
              validated_by = v_custom_audience.user_id,
              updated_at = CURRENT_TIMESTAMP
          WHERE custom_audience_id = p_custom_audience_id;

          RETURN QUERY SELECT v_is_valid, v_validation_errors, v_estimated_size, v_actual_size;

      EXCEPTION
          WHEN OTHERS THEN
              v_validation_errors := array_append(v_validation_errors, 'Validation error: ' || SQLERRM);
              RETURN QUERY SELECT FALSE, v_validation_errors, 0, 0;
      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.validate_custom_audience IS 'Validates custom audience definitions for security and compliance';

      -- Trigger for updated_at
      CREATE TRIGGER trg_post_visibility_custom_updated_at
          BEFORE UPDATE ON socialcandor_schema.post_visibility_custom
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

      ------------------------------------------------------------------------------------------------
      -- Table: 91 - user_activities
      -- Description: Normalized activity stream for cross-feature analytics
      -- Business Case: Enables unified activity feeds spanning posts/comments/messages while
      -- supporting activity-based recommendations ("users who did X also did Y").
      -- Provides comprehensive user behavior tracking for analytics, personalization, and security.
      -- Feature Reference: ANL02 (Activity Tracking), REC04 (Behavior-based Recommendations), SEC06 (Behavior Analysis)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.user_activities (
          activity_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
          user_id UUID NOT NULL,

          -- Activity identification
          activity_type socialcandor_schema.engagement_type NOT NULL,
          activity_subtype VARCHAR(50),

          -- Target entity
          target_type VARCHAR(30) NOT NULL CHECK (
              target_type IN ('POST', 'COMMENT', 'MESSAGE', 'USER', 'GROUP', 'PAGE', 'EVENT', 'MEDIA', 'STORY', 'LIVE')
          ),
          target_id UUID NOT NULL,
          target_user_id UUID,

          -- Content and context
          activity_content TEXT,
          activity_metadata JSONB DEFAULT '{}',

          -- Location and device context
          location_coordinates GEOGRAPHY(POINT, 4326),
          location_accuracy INTEGER CHECK (location_accuracy >= 0 AND location_accuracy <= 100),
          device_type VARCHAR(50),
          device_id VARCHAR(255),
          app_version VARCHAR(50),

          -- Session context
          session_id UUID,
          request_id VARCHAR(100),

          -- Privacy and visibility
          visibility socialcandor_schema.content_visibility DEFAULT 'PUBLIC',
          is_sensitive BOOLEAN DEFAULT FALSE,

          -- Engagement metrics
          engagement_value NUMERIC(10,2) DEFAULT 0.0,
          engagement_duration_seconds INTEGER CHECK (engagement_duration_seconds >= 0),

          -- Sequence and grouping
          activity_sequence INTEGER DEFAULT 0 CHECK (activity_sequence >= 0),
          parent_activity_id UUID,
          activity_group_id UUID,

          -- Real-time processing
          is_processed BOOLEAN DEFAULT FALSE,
          processing_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
              processing_status IN ('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'SKIPPED')
          ),
          processing_attempts INTEGER DEFAULT 0 CHECK (processing_attempts >= 0),
          processing_error TEXT,

          -- Analytics flags
          is_anomalous BOOLEAN DEFAULT FALSE,
          anomaly_score NUMERIC(5,2) DEFAULT 0.0 CHECK (anomaly_score >= 0 AND anomaly_score <= 100),
          is_synthetic BOOLEAN DEFAULT FALSE,

          -- Retention and archiving
          retention_days INTEGER DEFAULT 730,
          is_archived BOOLEAN DEFAULT FALSE,
          archived_at TIMESTAMP WITH TIME ZONE,

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID NOT NULL,
          updated_by UUID DEFAULT uuid_nil(),

          -- Foreign key constraints
          CONSTRAINT fk_user_activities_user FOREIGN KEY (user_id)
              REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
          CONSTRAINT fk_user_activities_parent FOREIGN KEY (parent_activity_id)
              REFERENCES socialcandor_schema.user_activities(activity_id) ON DELETE SET NULL,

          -- Constraints
          CONSTRAINT chk_activity_duration CHECK (
              (engagement_duration_seconds IS NULL) OR
              engagement_duration_seconds <= 86400 -- Max 24 hours
          ),
          CONSTRAINT chk_activity_metadata CHECK (
              jsonb_typeof(activity_metadata) = 'object'
          )
      );

      COMMENT ON TABLE socialcandor_schema.user_activities IS 'Normalized activity stream for cross-feature analytics and behavior tracking';
      COMMENT ON COLUMN socialcandor_schema.user_activities.anomaly_score IS 'Score indicating how anomalous this activity is compared to user baseline';

      -- Indexes for user_activities
      CREATE INDEX IF NOT EXISTS idx_user_activities_user ON socialcandor_schema.user_activities(user_id);
      CREATE INDEX IF NOT EXISTS idx_user_activities_type ON socialcandor_schema.user_activities(activity_type);
      CREATE INDEX IF NOT EXISTS idx_user_activities_target ON socialcandor_schema.user_activities(target_type, target_id);
      CREATE INDEX IF NOT EXISTS idx_user_activities_created_at ON socialcandor_schema.user_activities(created_at DESC);
      CREATE INDEX IF NOT EXISTS idx_user_activities_session ON socialcandor_schema.user_activities(session_id);
      CREATE INDEX IF NOT EXISTS idx_user_activities_processed ON socialcandor_schema.user_activities(is_processed) WHERE is_processed = FALSE;
      CREATE INDEX IF NOT EXISTS idx_user_activities_anomalous ON socialcandor_schema.user_activities(is_anomalous) WHERE is_anomalous = TRUE;
      CREATE INDEX IF NOT EXISTS idx_user_activities_location ON socialcandor_schema.user_activities USING GIST(location_coordinates);

--       -- Time-series partitioning for user_activities
--       CREATE TABLE IF NOT EXISTS socialcandor_schema.user_activities_2024 PARTITION OF socialcandor_schema.user_activities
--           FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

--       CREATE TABLE IF NOT EXISTS socialcandor_schema.user_activities_2025 PARTITION OF socialcandor_schema.user_activities
--           FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

      -- Function to detect anomalous activities
      CREATE OR REPLACE FUNCTION socialcandor_schema.detect_activity_anomalies()
      RETURNS TRIGGER AS $$
      DECLARE
          v_user_avg_activities_per_hour NUMERIC(10,2);
          v_user_activity_count_last_hour INTEGER;
          v_anomaly_score NUMERIC(5,2) := 0.0;
      BEGIN
          -- Calculate user's average activities per hour (last 30 days)
          SELECT
              COUNT(*) / 720.0 INTO v_user_avg_activities_per_hour -- 720 hours in 30 days
          FROM socialcandor_schema.user_activities
          WHERE user_id = NEW.user_id
          AND created_at >= CURRENT_TIMESTAMP - INTERVAL '30 days'
          AND activity_type NOT IN ('VIEW', 'READ'); -- Exclude passive activities

          -- Count user's activities in the last hour
          SELECT
              COUNT(*) INTO v_user_activity_count_last_hour
          FROM socialcandor_schema.user_activities
          WHERE user_id = NEW.user_id
          AND created_at >= CURRENT_TIMESTAMP - INTERVAL '1 hour'
          AND activity_type NOT IN ('VIEW', 'READ');

          -- Calculate anomaly score based on deviation from average
          IF v_user_avg_activities_per_hour > 0 THEN
              v_anomaly_score := LEAST(100,
                  (v_user_activity_count_last_hour::NUMERIC / v_user_avg_activities_per_hour) * 100
              );
          END IF;

          -- Check for other anomaly indicators
          IF NEW.activity_type IN ('REPORT', 'BLOCK', 'HIDE') THEN
              v_anomaly_score := v_anomaly_score + 20;
          END IF;

          IF NEW.device_type IS NOT NULL AND NEW.device_id IS NULL THEN
              v_anomaly_score := v_anomaly_score + 10;
          END IF;

          -- Set anomaly flag
          NEW.anomaly_score := v_anomaly_score;
          NEW.is_anomalous := v_anomaly_score > 150; -- Flag if 150% above average

          RETURN NEW;
      END;
      $$ LANGUAGE plpgsql;

      CREATE TRIGGER trg_user_activities_anomaly_detection
          BEFORE INSERT ON socialcandor_schema.user_activities
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.detect_activity_anomalies();

      -- Trigger for updated_at
      CREATE TRIGGER trg_user_activities_updated_at
          BEFORE UPDATE ON socialcandor_schema.user_activities
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

      ------------------------------------------------------------------------------------------------
      -- Table: 92 - content_recommendations
      -- Description: Precomputed recommendation scores for algorithmic feeds
      -- Business Case: Reduces real-time computation costs for home feed generation while
      -- enabling recommendation diversity through multi-algorithm blending (collaborative + content-based).
      -- Supports personalized content discovery at scale with sub-second latency.
      -- Feature Reference: REC05 (Content Recommendations), PERF06 (Feed Performance), ENG05 (Personalization)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.content_recommendations (
          recommendation_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
          user_id UUID NOT NULL,
          content_id UUID NOT NULL,
          content_type VARCHAR(30) NOT NULL CHECK (
              content_type IN ('POST', 'USER', 'GROUP', 'PAGE', 'EVENT', 'HASHTAG', 'TOPIC')
          ),

          -- Recommendation algorithms
          algorithm_id VARCHAR(50) NOT NULL,
          algorithm_version VARCHAR(20) NOT NULL,
          algorithm_type VARCHAR(30) NOT NULL CHECK (
              algorithm_type IN ('COLLABORATIVE', 'CONTENT_BASED', 'HYBRID', 'CONTEXTUAL', 'POPULARITY', 'TRENDING')
          ),

          -- Recommendation scores
          base_score NUMERIC(10,6) NOT NULL CHECK (base_score >= 0 AND base_score <= 1),
          confidence_score NUMERIC(5,2) DEFAULT 50.0 CHECK (confidence_score >= 0 AND confidence_score <= 100),
          final_score NUMERIC(10,6) GENERATED ALWAYS AS (base_score * (confidence_score / 100.0)) STORED,

          -- Score breakdown
          score_components JSONB DEFAULT '{
              "collaborative_filtering": 0,
              "content_similarity": 0,
              "trending_boost": 0,
              "personalization": 0,
              "diversity_penalty": 0,
              "freshness_boost": 0
          }',

          -- Context and features
          context_features JSONB DEFAULT '{
              "time_of_day": null,
              "day_of_week": null,
              "device_type": null,
              "location": null,
              "mood": null
          }',
          user_features JSONB DEFAULT '{}',
          content_features JSONB DEFAULT '{}',

          -- Diversity and novelty
          is_novel BOOLEAN DEFAULT FALSE,
          novelty_score NUMERIC(5,2) DEFAULT 0.0 CHECK (novelty_score >= 0 AND novelty_score <= 100),
          diversity_penalty NUMERIC(5,2) DEFAULT 0.0 CHECK (diversity_penalty >= 0 AND diversity_penalty <= 100),

          -- Business rules
          business_rules_applied JSONB DEFAULT '{
              "content_quality_threshold": true,
              "user_preferences": true,
              "privacy_constraints": true,
              "monetization_boost": false,
              "sponsored_content": false
          }',
          rule_adjustments NUMERIC(5,2) DEFAULT 0.0 CHECK (rule_adjustments >= -100 AND rule_adjustments <= 100),

          -- Real-time adjustments
          real_time_boost NUMERIC(5,2) DEFAULT 0.0 CHECK (real_time_boost >= 0 AND real_time_boost <= 100),
          boost_reason VARCHAR(100),
          boost_expires_at TIMESTAMP WITH TIME ZONE,

          -- Performance tracking
          ranking_position INTEGER,
          impression_count INTEGER DEFAULT 0 CHECK (impression_count >= 0),
          click_count INTEGER DEFAULT 0 CHECK (click_count >= 0),
          engagement_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_rate >= 0 AND engagement_rate <= 100),

          -- Model training data
          is_training_example BOOLEAN DEFAULT FALSE,
          training_weight NUMERIC(5,2) DEFAULT 1.0 CHECK (training_weight >= 0 AND training_weight <= 10),

          -- Recommendation lifecycle
          is_active BOOLEAN DEFAULT TRUE,
          expires_at TIMESTAMP WITH TIME ZONE,
          refreshed_at TIMESTAMP WITH TIME ZONE,
          refresh_count INTEGER DEFAULT 0 CHECK (refresh_count >= 0),

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID NOT NULL,
          updated_by UUID DEFAULT uuid_nil(),

          -- Foreign key constraints
          CONSTRAINT fk_content_recommendations_user FOREIGN KEY (user_id)
              REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

          -- Constraints
          CONSTRAINT uk_content_recommendations_unique UNIQUE (user_id, content_id, content_type, algorithm_id, algorithm_version),
          CONSTRAINT chk_freshness CHECK (
              (refreshed_at IS NULL) OR
              (refreshed_at >= created_at)
          ),
          CONSTRAINT chk_expiration CHECK (
              (expires_at IS NULL) OR
              (expires_at > created_at)
          )
      );

      COMMENT ON TABLE socialcandor_schema.content_recommendations IS 'Precomputed recommendation scores for algorithmic feeds with multi-algorithm support';
      COMMENT ON COLUMN socialcandor_schema.content_recommendations.novelty_score IS 'Score indicating how novel this recommendation is for the user';

      -- Indexes for content_recommendations
      CREATE INDEX IF NOT EXISTS idx_content_recommendations_user ON socialcandor_schema.content_recommendations(user_id);
      CREATE INDEX IF NOT EXISTS idx_content_recommendations_content ON socialcandor_schema.content_recommendations(content_id, content_type);
      CREATE INDEX IF NOT EXISTS idx_content_recommendations_score ON socialcandor_schema.content_recommendations(final_score DESC);
      CREATE INDEX IF NOT EXISTS idx_content_recommendations_algorithm ON socialcandor_schema.content_recommendations(algorithm_id, algorithm_version);
      CREATE INDEX IF NOT EXISTS idx_content_recommendations_active ON socialcandor_schema.content_recommendations(is_active) WHERE is_active = TRUE;
      CREATE INDEX IF NOT EXISTS idx_content_recommendations_freshness ON socialcandor_schema.content_recommendations(refreshed_at DESC NULLS LAST);
      CREATE INDEX IF NOT EXISTS idx_content_recommendations_composite ON socialcandor_schema.content_recommendations(user_id, final_score DESC, refreshed_at DESC);

      -- Materialized view for top recommendations per user
      CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_user_top_recommendations AS
      SELECT
          user_id,
          content_id,
          content_type,
          algorithm_id,
          final_score,
          confidence_score,
          ranking_position,
          refreshed_at,
          created_at,
          ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY final_score DESC) as user_rank
      FROM socialcandor_schema.content_recommendations
      WHERE is_active = TRUE
      AND (expires_at IS NULL OR expires_at > CURRENT_TIMESTAMP)
      WITH DATA;

      CREATE UNIQUE INDEX idx_mv_user_top_recommendations_user_content ON socialcandor_schema.mv_user_top_recommendations(user_id, content_id, content_type);
      CREATE INDEX idx_mv_user_top_recommendations_score ON socialcandor_schema.mv_user_top_recommendations(user_id, final_score DESC);

      -- Function to refresh recommendations
      CREATE OR REPLACE FUNCTION socialcandor_schema.refresh_user_recommendations(p_user_id UUID, p_algorithm_id VARCHAR(50))
      RETURNS INTEGER AS $$
      DECLARE
          v_refresh_count INTEGER := 0;
          v_expiration_days INTEGER := 7;
      BEGIN
          -- Mark old recommendations as inactive
          UPDATE socialcandor_schema.content_recommendations
          SET
              is_active = FALSE,
              updated_at = CURRENT_TIMESTAMP,
              updated_by = uuid_nil()
          WHERE user_id = p_user_id
          AND algorithm_id = p_algorithm_id
          AND is_active = TRUE
          AND refreshed_at < CURRENT_TIMESTAMP - INTERVAL '1 day';

          -- Generate new recommendations (simplified - would call ML service)
          -- This is a placeholder for the actual recommendation generation logic
          INSERT INTO socialcandor_schema.content_recommendations (
              user_id,
              content_id,
              content_type,
              algorithm_id,
              algorithm_version,
              algorithm_type,
              base_score,
              confidence_score,
              score_components,
              expires_at,
              refreshed_at,
              created_by,
              updated_by
          )
          SELECT
              p_user_id,
              p.post_id as content_id,
              'POST' as content_type,
              p_algorithm_id,
              '1.0' as algorithm_version,
              'HYBRID' as algorithm_type,
              -- Simplified scoring logic
              CASE
                  WHEN p.trending_score > 0.5 THEN 0.8
                  WHEN p.quality_score > 70 THEN 0.6
                  ELSE 0.3
              END as base_score,
              -- Confidence based on data availability
              CASE
                  WHEN EXISTS (
                      SELECT 1 FROM socialcandor_schema.user_activities ua
                      WHERE ua.user_id = p_user_id
                      AND ua.target_id = p.post_id
                  ) THEN 90.0
                  ELSE 50.0
              END as confidence_score,
              jsonb_build_object(
                  'trending_boost', p.trending_score * 0.3,
                  'quality_boost', (p.quality_score / 100.0) * 0.3,
                  'personalization', 0.2,
                  'freshness', EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - p.created_at)) / 86400.0
              ) as score_components,
              CURRENT_TIMESTAMP + (v_expiration_days || ' days')::INTERVAL as expires_at,
              CURRENT_TIMESTAMP as refreshed_at,
              uuid_nil() as created_by,
              uuid_nil() as updated_by
          FROM socialcandor_schema.posts p
          WHERE p.moderation_status = 'APPROVED'
          AND p.visibility = 'PUBLIC'
          AND p.created_at >= CURRENT_TIMESTAMP - INTERVAL '30 days'
          AND NOT EXISTS (
              SELECT 1 FROM socialcandor_schema.user_activities ua
              WHERE ua.user_id = p_user_id
              AND ua.target_id = p.post_id
              AND ua.activity_type IN ('HIDE', 'BLOCK', 'REPORT')
          )
          ORDER BY p.trending_score DESC, p.created_at DESC
          LIMIT 100;

          GET DIAGNOSTICS v_refresh_count = ROW_COUNT;

          -- Refresh materialized view
          REFRESH MATERIALIZED VIEW CONCURRENTLY socialcandor_schema.mv_user_top_recommendations;

          RETURN v_refresh_count;

      EXCEPTION
          WHEN OTHERS THEN
              RAISE NOTICE 'Error refreshing recommendations for user %: %', p_user_id, SQLERRM;
              RETURN -1;
      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.refresh_user_recommendations IS 'Refreshes recommendations for a specific user and algorithm';

      -- Trigger for updated_at
      CREATE TRIGGER trg_content_recommendations_updated_at
          BEFORE UPDATE ON socialcandor_schema.content_recommendations
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

      ------------------------------------------------------------------------------------------------
      -- Table: 93 - user_similarity
      -- Description: Precomputed user affinity scores for friend recommendations
      -- Business Case: Accelerates "People You May Know" generation while enabling cold-start
      -- solving for new users through demographic/interest-based similarity fallbacks.
      -- Supports network growth and engagement through intelligent connection suggestions.
      -- Feature Reference: REC06 (Friend Recommendations), NET04 (Network Growth), ONB01 (Onboarding)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.user_similarity (
          similarity_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
          user_a_id UUID NOT NULL,
          user_b_id UUID NOT NULL,

          -- Similarity metrics
          overall_similarity NUMERIC(5,2) NOT NULL CHECK (overall_similarity >= 0 AND overall_similarity <= 100),

          -- Component similarities
          profile_similarity NUMERIC(5,2) DEFAULT 0.0 CHECK (profile_similarity >= 0 AND profile_similarity <= 100),
          interest_similarity NUMERIC(5,2) DEFAULT 0.0 CHECK (interest_similarity >= 0 AND interest_similarity <= 100),
          behavioral_similarity NUMERIC(5,2) DEFAULT 0.0 CHECK (behavioral_similarity >= 0 AND behavioral_similarity <= 100),
          network_similarity NUMERIC(5,2) DEFAULT 0.0 CHECK (network_similarity >= 0 AND network_similarity <= 100),
          content_similarity NUMERIC(5,2) DEFAULT 0.0 CHECK (content_similarity >= 0 AND content_similarity <= 100),

          -- Similarity features
          similarity_features JSONB DEFAULT '{
              "common_friends_count": 0,
              "common_groups_count": 0,
              "common_interests_count": 0,
              "interaction_frequency": 0,
              "geographic_distance": null,
              "demographic_similarity": 0
          }',

          -- Confidence and reliability
          confidence_score NUMERIC(5,2) DEFAULT 50.0 CHECK (confidence_score >= 0 AND confidence_score <= 100),
          data_sufficiency_score NUMERIC(5,2) DEFAULT 0.0 CHECK (data_sufficiency_score >= 0 AND data_sufficiency_score <= 100),
          is_statistically_significant BOOLEAN DEFAULT FALSE,

          -- Relationship context
          existing_relationship_type socialcandor_schema.relationship_type,
          existing_relationship_strength NUMERIC(5,2) DEFAULT 0.0 CHECK (existing_relationship_strength >= 0 AND existing_relationship_strength <= 100),

          -- Recommendation context
          recommendation_strength NUMERIC(5,2) DEFAULT 0.0 CHECK (recommendation_strength >= 0 AND recommendation_strength <= 100),
          recommendation_reason VARCHAR(200)[] DEFAULT '{}',
          is_recommended BOOLEAN DEFAULT FALSE,
          recommendation_rank INTEGER,

          -- Algorithm details
          algorithm_id VARCHAR(50) NOT NULL,
          algorithm_version VARCHAR(20) NOT NULL,
          calculation_method VARCHAR(30) NOT NULL CHECK (
              calculation_method IN ('COSINE_SIMILARITY', 'JACCARD_INDEX', 'PEARSON_CORRELATION', 'EUCLIDEAN_DISTANCE', 'HYBRID', 'ML_MODEL')
          ),

          -- Temporal dynamics
          similarity_trend VARCHAR(20) DEFAULT 'STABLE' CHECK (
              similarity_trend IN ('INCREASING', 'DECREASING', 'STABLE', 'VOLATILE')
          ),
          trend_velocity NUMERIC(5,2) DEFAULT 0.0,
          last_increase_at TIMESTAMP WITH TIME ZONE,
          last_decrease_at TIMESTAMP WITH TIME ZONE,

          -- Update frequency
          is_stale BOOLEAN DEFAULT FALSE,
          staleness_score NUMERIC(5,2) DEFAULT 0.0 CHECK (staleness_score >= 0 AND staleness_score <= 100),
          last_calculated_at TIMESTAMP WITH TIME ZONE NOT NULL,
          next_calculation_due_at TIMESTAMP WITH TIME ZONE,

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID NOT NULL,
          updated_by UUID DEFAULT uuid_nil(),

          -- Foreign key constraints
          CONSTRAINT fk_user_similarity_user_a FOREIGN KEY (user_a_id)
              REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
          CONSTRAINT fk_user_similarity_user_b FOREIGN KEY (user_b_id)
              REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

          -- Constraints
          CONSTRAINT uk_user_similarity_unique UNIQUE (user_a_id, user_b_id, algorithm_id, algorithm_version),
          CONSTRAINT chk_user_similarity_not_self CHECK (user_a_id != user_b_id),
          CONSTRAINT chk_similarity_timestamps CHECK (
              last_calculated_at >= created_at AND
              (next_calculation_due_at IS NULL OR next_calculation_due_at > last_calculated_at)
          )
      );

      COMMENT ON TABLE socialcandor_schema.user_similarity IS 'Precomputed user affinity scores for friend recommendations and network analysis';
      COMMENT ON COLUMN socialcandor_schema.user_similarity.staleness_score IS 'Score indicating how stale the similarity calculation is (higher = more stale)';

      -- Indexes for user_similarity
      CREATE INDEX IF NOT EXISTS idx_user_similarity_user_a ON socialcandor_schema.user_similarity(user_a_id);
      CREATE INDEX IF NOT EXISTS idx_user_similarity_user_b ON socialcandor_schema.user_similarity(user_b_id);
      CREATE INDEX IF NOT EXISTS idx_user_similarity_overall ON socialcandor_schema.user_similarity(overall_similarity DESC);
      CREATE INDEX IF NOT EXISTS idx_user_similarity_recommended ON socialcandor_schema.user_similarity(is_recommended) WHERE is_recommended = TRUE;
      CREATE INDEX IF NOT EXISTS idx_user_similarity_stale ON socialcandor_schema.user_similarity(is_stale) WHERE is_stale = TRUE;
      CREATE INDEX IF NOT EXISTS idx_user_similarity_calculated ON socialcandor_schema.user_similarity(last_calculated_at DESC);
      CREATE INDEX IF NOT EXISTS idx_user_similarity_composite ON socialcandor_schema.user_similarity(user_a_id, overall_similarity DESC, last_calculated_at DESC);

      -- Function to calculate user similarity
      CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_user_similarity(p_user_a_id UUID, p_user_b_id UUID)
      RETURNS TABLE(
          overall_similarity NUMERIC(5,2),
          profile_similarity NUMERIC(5,2),
          interest_similarity NUMERIC(5,2),
          behavioral_similarity NUMERIC(5,2),
          network_similarity NUMERIC(5,2),
          content_similarity NUMERIC(5,2),
          confidence_score NUMERIC(5,2),
          features JSONB
      ) AS $$
      DECLARE
          v_profile_similarity NUMERIC(5,2) := 0.0;
          v_interest_similarity NUMERIC(5,2) := 0.0;
          v_behavioral_similarity NUMERIC(5,2) := 0.0;
          v_network_similarity NUMERIC(5,2) := 0.0;
          v_content_similarity NUMERIC(5,2) := 0.0;
          v_overall_similarity NUMERIC(5,2) := 0.0;
          v_confidence_score NUMERIC(5,2) := 50.0;
          v_features JSONB := '{}'::jsonb;
          v_common_friends_count INTEGER := 0;
          v_common_groups_count INTEGER := 0;
          v_interaction_count INTEGER := 0;
      BEGIN
          -- Calculate common friends count
          SELECT COUNT(*) INTO v_common_friends_count
          FROM (
              SELECT friend_user_id FROM socialcandor_schema.friends
              WHERE user_id = p_user_a_id AND status = 'ACCEPTED' AND is_mutual = TRUE
              INTERSECT
              SELECT friend_user_id FROM socialcandor_schema.friends
              WHERE user_id = p_user_b_id AND status = 'ACCEPTED' AND is_mutual = TRUE
          ) common_friends;

          -- Calculate common groups count
          SELECT COUNT(*) INTO v_common_groups_count
          FROM (
              SELECT group_id FROM socialcandor_schema.groups_members
              WHERE user_id = p_user_a_id AND membership_status = 'APPROVED'
              INTERSECT
              SELECT group_id FROM socialcandor_schema.groups_members
              WHERE user_id = p_user_b_id AND membership_status = 'APPROVED'
          ) common_groups;

          -- Calculate interaction count
          SELECT COUNT(*) INTO v_interaction_count
          FROM socialcandor_schema.user_activities ua
          WHERE (ua.user_id = p_user_a_id AND ua.target_user_id = p_user_b_id)
             OR (ua.user_id = p_user_b_id AND ua.target_user_id = p_user_a_id);

          -- Calculate similarity components
          -- Profile similarity (simplified - based on demographics)
          SELECT
              CASE
                  WHEN ua.country = ub.country THEN 20 ELSE 0 END +
              CASE
                  WHEN ABS(EXTRACT(YEAR FROM AGE(ua.date_of_birth)) - EXTRACT(YEAR FROM AGE(ub.date_of_birth))) <= 5 THEN 15 ELSE 0 END +
              CASE
                  WHEN ua.gender = ub.gender THEN 10 ELSE 0 END
          INTO v_profile_similarity
          FROM socialcandor_schema.users ua, socialcandor_schema.users ub
          WHERE ua.user_id = p_user_a_id AND ub.user_id = p_user_b_id;

          -- Network similarity (based on common connections)
          v_network_similarity := LEAST(100,
              (v_common_friends_count * 10) +
              (v_common_groups_count * 15)
          );

          -- Interest similarity (placeholder - would use actual interest data)
          v_interest_similarity := 25.0; -- Placeholder

          -- Behavioral similarity (based on interaction patterns)
          v_behavioral_similarity := LEAST(100, v_interaction_count * 5);

          -- Content similarity (placeholder - would analyze content engagement)
          v_content_similarity := 30.0; -- Placeholder

          -- Calculate overall similarity (weighted average)
          v_overall_similarity := (
              v_profile_similarity * 0.15 +
              v_interest_similarity * 0.20 +
              v_behavioral_similarity * 0.25 +
              v_network_similarity * 0.30 +
              v_content_similarity * 0.10
          );

          -- Calculate confidence score based on data availability
          v_confidence_score := LEAST(100,
              CASE WHEN v_profile_similarity > 0 THEN 20 ELSE 0 END +
              CASE WHEN v_network_similarity > 0 THEN 30 ELSE 0 END +
              CASE WHEN v_behavioral_similarity > 0 THEN 25 ELSE 0 END +
              CASE WHEN v_interest_similarity > 0 THEN 15 ELSE 0 END +
              CASE WHEN v_content_similarity > 0 THEN 10 ELSE 0 END
          );

          -- Build features JSON
          v_features := jsonb_build_object(
              'common_friends_count', v_common_friends_count,
              'common_groups_count', v_common_groups_count,
              'interaction_count', v_interaction_count,
              'demographic_similarity', v_profile_similarity,
              'connection_strength', v_network_similarity
          );

          RETURN QUERY SELECT
              v_overall_similarity,
              v_profile_similarity,
              v_interest_similarity,
              v_behavioral_similarity,
              v_network_similarity,
              v_content_similarity,
              v_confidence_score,
              v_features;

      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.calculate_user_similarity IS 'Calculates similarity between two users across multiple dimensions';

      -- Trigger for updated_at
      CREATE TRIGGER trg_user_similarity_updated_at
          BEFORE UPDATE ON socialcandor_schema.user_similarity
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

     ------------------------------------------------------------------------------------------------
      -- Table: 94 - subscription_plans
      -- Description: Tiered subscription offerings with feature gating
      -- Business Case: Creates recurring revenue stream beyond advertising while enabling
      -- plan migration workflows and grandfathered pricing preservation for existing subscribers.
      -- Supports complex subscription models with trial periods, discounts, and enterprise pricing.
      -- Feature Reference: MON03 (Subscription Management), REV01 (Revenue Diversification), BIZ02 (Business Models)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.subscription_plans (
          plan_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

          -- Plan identification
          plan_name VARCHAR(200) NOT NULL UNIQUE,
          plan_code VARCHAR(50) NOT NULL UNIQUE,
          plan_type VARCHAR(30) NOT NULL DEFAULT 'INDIVIDUAL' CHECK (
              plan_type IN ('INDIVIDUAL', 'FAMILY', 'STUDENT', 'ENTERPRISE', 'NON_PROFIT', 'CUSTOM')
          ),

          -- Tier and positioning
          plan_tier VARCHAR(20) NOT NULL DEFAULT 'BASIC' CHECK (
              plan_tier IN ('FREE', 'BASIC', 'PRO', 'PREMIUM', 'ENTERPRISE', 'ULTIMATE')
          ),
          display_order INTEGER DEFAULT 0 CHECK (display_order >= 0),
          is_featured BOOLEAN DEFAULT FALSE,
          featured_until TIMESTAMP WITH TIME ZONE,

          -- Pricing information
          currency CHAR(3) NOT NULL DEFAULT 'USD',
          monthly_price NUMERIC(10,2) CHECK (monthly_price >= 0),
          annual_price NUMERIC(10,2) CHECK (annual_price >= 0),
          lifetime_price NUMERIC(10,2) CHECK (lifetime_price >= 0),

          -- Discounts and promotions
          discount_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (discount_percentage >= 0 AND discount_percentage <= 100),
          discount_expires_at TIMESTAMP WITH TIME ZONE,
          is_discounted BOOLEAN DEFAULT FALSE,

          -- Billing configuration
          billing_cycle VARCHAR(20) DEFAULT 'MONTHLY' CHECK (
              billing_cycle IN ('MONTHLY', 'QUARTERLY', 'ANNUAL', 'LIFETIME', 'CUSTOM')
          ),
          trial_period_days INTEGER DEFAULT 0 CHECK (trial_period_days >= 0),
          grace_period_days INTEGER DEFAULT 7 CHECK (grace_period_days >= 0),

          -- Feature gating
          features JSONB DEFAULT '{
              "max_storage_gb": 5,
              "max_file_size_mb": 100,
              "video_quality": "SD",
              "ad_free": false,
              "priority_support": false,
              "analytics_access": "BASIC",
              "customization": false,
              "api_access": false,
              "team_features": false,
              "monetization": false
          }',
          feature_limits JSONB DEFAULT '{
              "max_posts_per_day": 10,
              "max_groups": 5,
              "max_friends": 1000,
              "max_media_uploads": 50
          }',

          -- Access controls
          allowed_regions VARCHAR(3)[] DEFAULT '{}',
          restricted_regions VARCHAR(3)[] DEFAULT '{}',
          minimum_age INTEGER DEFAULT 13 CHECK (minimum_age >= 13),
          requires_verification BOOLEAN DEFAULT FALSE,

          -- Plan metadata
          description TEXT,
          benefits TEXT[] DEFAULT '{}',
          icon_url VARCHAR(500),
          color_scheme VARCHAR(7),

          -- Terms and conditions
          terms_url VARCHAR(500),
          cancellation_policy VARCHAR(20) DEFAULT 'STANDARD' CHECK (
              cancellation_policy IN ('STANDARD', 'FLEXIBLE', 'STRICT', 'NONE')
          ),
          refund_policy_days INTEGER DEFAULT 30 CHECK (refund_policy_days >= 0),

          -- Compliance and legal
          tax_code VARCHAR(50),
          accounting_code VARCHAR(50),
          legal_entity VARCHAR(100),

          -- Plan lifecycle
          is_active BOOLEAN DEFAULT TRUE,
          is_visible BOOLEAN DEFAULT TRUE,
          launched_at TIMESTAMP WITH TIME ZONE,
          retired_at TIMESTAMP WITH TIME ZONE,
          retirement_reason VARCHAR(200),

          -- Migration settings
          upgrade_paths UUID[] DEFAULT '{}',
          downgrade_paths UUID[] DEFAULT '{}',
          grandfathered_until TIMESTAMP WITH TIME ZONE,

          -- Performance metrics
          conversion_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (conversion_rate >= 0 AND conversion_rate <= 100),
          churn_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (churn_rate >= 0 AND churn_rate <= 100),
          avg_revenue_per_user NUMERIC(10,2) DEFAULT 0.0 CHECK (avg_revenue_per_user >= 0),

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID NOT NULL,
          updated_by UUID DEFAULT uuid_nil(),

          -- Constraints
          CONSTRAINT chk_subscription_pricing CHECK (
              (plan_tier != 'FREE' AND (monthly_price > 0 OR annual_price > 0 OR lifetime_price > 0)) OR
              plan_tier = 'FREE'
          ),
          CONSTRAINT chk_discount_validity CHECK (
              (discount_expires_at IS NULL) OR
              discount_expires_at > created_at
          )
      );

-- Create function to check if discount is active
CREATE OR REPLACE FUNCTION socialcandor_schema.check_discount_active(
    p_discount_percentage NUMERIC,
    p_discount_expires_at TIMESTAMP WITH TIME ZONE
) RETURNS BOOLEAN AS $$
BEGIN
    RETURN p_discount_percentage > 0 
           AND (p_discount_expires_at IS NULL 
                OR p_discount_expires_at > CURRENT_TIMESTAMP);
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Create trigger to update is_discounted on insert or update
CREATE OR REPLACE FUNCTION socialcandor_schema.update_discount_status()
RETURNS TRIGGER AS $$
BEGIN
    NEW.is_discounted := socialcandor_schema.check_discount_active(
        NEW.discount_percentage,
        NEW.discount_expires_at
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;



-- Create view for current active plans with discount status
CREATE OR REPLACE VIEW socialcandor_schema.active_subscription_plans AS
SELECT 
    sp.*,
    socialcandor_schema.check_discount_active(
        sp.discount_percentage,
        sp.discount_expires_at
    ) AS discount_active
FROM socialcandor_schema.subscription_plans sp
WHERE sp.is_active = TRUE 
      AND sp.is_visible = TRUE
      AND (sp.retired_at IS NULL OR sp.retired_at > CURRENT_TIMESTAMP);

-- Create function to recalculate discount status for existing records
CREATE OR REPLACE FUNCTION socialcandor_schema.recalculate_all_discount_status()
RETURNS INTEGER AS $$
DECLARE
    updated_count INTEGER;
BEGIN
    UPDATE socialcandor_schema.subscription_plans
    SET is_discounted = socialcandor_schema.check_discount_active(
        discount_percentage,
        discount_expires_at
    )
    WHERE is_discounted != socialcandor_schema.check_discount_active(
        discount_percentage,
        discount_expires_at
    );
    
    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RETURN updated_count;
END;
$$ LANGUAGE plpgsql;

-- Comment for the discount status logic
COMMENT ON FUNCTION socialcandor_schema.check_discount_active IS 
    'Checks if a discount is currently active based on percentage and expiration date. 
     Returns TRUE if discount_percentage > 0 and (expiration is NULL or in the future).';



      -- Indexes for subscription_plans
      CREATE INDEX IF NOT EXISTS idx_subscription_plans_tier ON socialcandor_schema.subscription_plans(plan_tier);
      CREATE INDEX IF NOT EXISTS idx_subscription_plans_active ON socialcandor_schema.subscription_plans(is_active) WHERE is_active = TRUE;
      CREATE INDEX IF NOT EXISTS idx_subscription_plans_visible ON socialcandor_schema.subscription_plans(is_visible) WHERE is_visible = TRUE;
      CREATE INDEX IF NOT EXISTS idx_subscription_plans_price ON socialcandor_schema.subscription_plans(monthly_price, annual_price);
      CREATE INDEX IF NOT EXISTS idx_subscription_plans_featured ON socialcandor_schema.subscription_plans(is_featured) WHERE is_featured = TRUE;
      CREATE INDEX IF NOT EXISTS idx_subscription_plans_display_order ON socialcandor_schema.subscription_plans(display_order);

      -- Function to validate feature limits
      CREATE OR REPLACE FUNCTION socialcandor_schema.validate_subscription_features(p_user_id UUID, p_feature_key VARCHAR(50), p_requested_value NUMERIC)
      RETURNS BOOLEAN AS $$
      DECLARE
          v_user_plan RECORD;
          v_current_usage NUMERIC;
          v_limit NUMERIC;
          v_is_allowed BOOLEAN := TRUE;
      BEGIN
          -- Get user's current subscription plan
          SELECT sp.* INTO v_user_plan
          FROM socialcandor_schema.user_subscriptions us
          JOIN socialcandor_schema.subscription_plans sp ON us.plan_id = sp.plan_id
          WHERE us.user_id = p_user_id
          AND us.status = 'ACTIVE'
          AND sp.is_active = TRUE
          AND (us.expires_at IS NULL OR us.expires_at > CURRENT_TIMESTAMP);

          IF NOT FOUND THEN
              -- User has no active subscription, use free plan
              SELECT * INTO v_user_plan
              FROM socialcandor_schema.subscription_plans
              WHERE plan_tier = 'FREE'
              AND is_active = TRUE
              LIMIT 1;
          END IF;

          -- Get the feature limit from the plan
          v_limit := (v_user_plan.feature_limits->>p_feature_key)::NUMERIC;

          IF v_limit IS NOT NULL THEN
              -- Get current usage (implementation depends on feature)
              CASE p_feature_key
                  WHEN 'max_posts_per_day' THEN
                      SELECT COUNT(*) INTO v_current_usage
                      FROM socialcandor_schema.posts p
                      WHERE p.user_id = p_user_id
                      AND p.created_at >= CURRENT_DATE;

                  WHEN 'max_media_uploads' THEN
                      SELECT COUNT(*) INTO v_current_usage
                      FROM socialcandor_schema.posts_media pm
                      WHERE pm.user_id = p_user_id
                      AND pm.created_at >= CURRENT_TIMESTAMP - INTERVAL '24 hours';

                  -- Add more feature checks as needed
                  ELSE
                      v_current_usage := 0;
              END CASE;

              -- Check if request exceeds limit
              IF (v_current_usage + p_requested_value) > v_limit THEN
                  v_is_allowed := FALSE;

                  -- Log the limit violation
                  INSERT INTO socialcandor_schema.subscription_limit_violations (
                      user_id,
                      plan_id,
                      feature_key,
                      current_usage,
                      requested_value,
                      limit_value,
                      created_by
                  ) VALUES (
                      p_user_id,
                      v_user_plan.plan_id,
                      p_feature_key,
                      v_current_usage,
                      p_requested_value,
                      v_limit,
                      p_user_id
                  );
              END IF;
          END IF;

          RETURN v_is_allowed;
      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.validate_subscription_features IS 'Validates if a user can perform an action based on their subscription limits';

      -- Trigger for updated_at
      CREATE TRIGGER trg_subscription_plans_updated_at
          BEFORE UPDATE ON socialcandor_schema.subscription_plans
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

      ------------------------------------------------------------------------------------------------
      -- Table: 95 - user_subscriptions
      -- Description: Active subscription tracking with billing cycle management
      -- Business Case: Supports dunning management for failed payments while enabling
      -- subscription pause/resume features to reduce churn during temporary financial hardship.
      -- Provides comprehensive subscription lifecycle management with revenue recognition support.
      -- Feature Reference: MON04 (Billing Management), RET02 (Retention), REV02 (Revenue Assurance)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.user_subscriptions (
          subscription_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
          user_id UUID NOT NULL,
          plan_id UUID NOT NULL,

          -- Subscription status
          status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (
              status IN ('PENDING', 'ACTIVE', 'PAUSED', 'CANCELLED', 'EXPIRED', 'FAILED', 'TRIAL', 'GRACE_PERIOD')
          ),
          status_reason VARCHAR(200),

          -- Billing information
          billing_cycle VARCHAR(20) NOT NULL DEFAULT 'MONTHLY' CHECK (
              billing_cycle IN ('MONTHLY', 'QUARTERLY', 'ANNUAL', 'LIFETIME', 'CUSTOM')
          ),
          currency CHAR(3) NOT NULL DEFAULT 'USD',
          amount NUMERIC(10,2) NOT NULL CHECK (amount >= 0),
          tax_amount NUMERIC(10,2) DEFAULT 0 CHECK (tax_amount >= 0),
          total_amount NUMERIC(10,2) GENERATED ALWAYS AS (amount + tax_amount) STORED,

          -- Payment method
          payment_method_id UUID,
          payment_provider VARCHAR(50) NOT NULL CHECK (
              payment_provider IN ('STRIPE', 'PAYPAL', 'APPLE', 'GOOGLE', 'MANUAL', 'OTHER')
          ),
          payment_provider_customer_id VARCHAR(255),
          payment_provider_subscription_id VARCHAR(255),

          -- Trial period
          trial_started_at TIMESTAMP WITH TIME ZONE,
          trial_ends_at TIMESTAMP WITH TIME ZONE,
          is_in_trial BOOLEAN DEFAULT FALSE,

          -- Subscription dates
          started_at TIMESTAMP WITH TIME ZONE,
          current_period_start TIMESTAMP WITH TIME ZONE,
          current_period_end TIMESTAMP WITH TIME ZONE,
          expires_at TIMESTAMP WITH TIME ZONE,

          -- Cancellation and pause
          cancelled_at TIMESTAMP WITH TIME ZONE,
          cancel_reason VARCHAR(200),
          cancelled_by UUID,
          pause_start_at TIMESTAMP WITH TIME ZONE,
          pause_end_at TIMESTAMP WITH TIME ZONE,
          pause_reason VARCHAR(200),

          -- Renewal management
          auto_renew BOOLEAN DEFAULT TRUE,
          renewal_attempts INTEGER DEFAULT 0 CHECK (renewal_attempts >= 0),
          next_renewal_attempt_at TIMESTAMP WITH TIME ZONE,
          last_renewal_at TIMESTAMP WITH TIME ZONE,

          -- Dunning management
          dunning_stage INTEGER DEFAULT 0 CHECK (dunning_stage >= 0 AND dunning_stage <= 5),
          last_dunning_email_at TIMESTAMP WITH TIME ZONE,
          dunning_emails_sent INTEGER DEFAULT 0 CHECK (dunning_emails_sent >= 0),

          -- Invoice and receipt tracking
          last_invoice_id UUID,
          last_payment_at TIMESTAMP WITH TIME ZONE,
          next_payment_due_at TIMESTAMP WITH TIME ZONE,

          -- Discounts and promotions
          discount_code VARCHAR(100),
          discount_percentage NUMERIC(5,2) DEFAULT 0.0 CHECK (discount_percentage >= 0 AND discount_percentage <= 100),
          discount_expires_at TIMESTAMP WITH TIME ZONE,

          -- Upgrade/downgrade tracking
          previous_subscription_id UUID,
          upgrade_path VARCHAR(20) CHECK (
              upgrade_path IN ('UPGRADE', 'DOWNGRADE', 'CROSSGRADE', 'REACTIVATION')
          ),
          prorated_amount NUMERIC(10,2) DEFAULT 0 CHECK (prorated_amount >= 0),

          -- Compliance and reporting
          invoice_required BOOLEAN DEFAULT TRUE,
          tax_exempt BOOLEAN DEFAULT FALSE,
          tax_exempt_reason VARCHAR(200),
          vat_number VARCHAR(50),

          -- Usage tracking
          usage_metrics JSONB DEFAULT '{
              "posts_this_month": 0,
              "storage_used_gb": 0,
              "api_calls_this_month": 0,
              "feature_usage": {}
          }',

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID,
          updated_by UUID,

          -- Foreign key constraints
          CONSTRAINT fk_user_subscriptions_user FOREIGN KEY (user_id)
              REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
          CONSTRAINT fk_user_subscriptions_plan FOREIGN KEY (plan_id)
              REFERENCES socialcandor_schema.subscription_plans(plan_id) ON DELETE RESTRICT,
          CONSTRAINT fk_user_subscriptions_cancelled_by FOREIGN KEY (cancelled_by)
              REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
          CONSTRAINT fk_user_subscriptions_previous FOREIGN KEY (previous_subscription_id)
              REFERENCES socialcandor_schema.user_subscriptions(subscription_id) ON DELETE SET NULL,

          -- Constraints
          CONSTRAINT chk_subscription_dates CHECK (
              (started_at IS NULL OR current_period_start IS NULL OR started_at <= current_period_start) AND
              (current_period_start IS NULL OR current_period_end IS NULL OR current_period_start < current_period_end) AND
              (expires_at IS NULL OR current_period_end IS NULL OR expires_at > current_period_end) AND
              (trial_ends_at IS NULL OR trial_started_at IS NULL OR trial_ends_at > trial_started_at) AND
              (pause_end_at IS NULL OR pause_start_at IS NULL OR pause_end_at > pause_start_at)
          ),
          CONSTRAINT chk_dunning_stage CHECK (
              (status != 'FAILED' AND dunning_stage = 0) OR
              status = 'FAILED'
          )
      );

-- Create partial unique index for active subscriptions (replaces the UNIQUE constraint with WHERE clause)
CREATE UNIQUE INDEX IF NOT EXISTS uk_user_subscriptions_active 
    ON socialcandor_schema.user_subscriptions(user_id) 
    WHERE status IN ('ACTIVE', 'TRIAL', 'GRACE_PERIOD');

COMMENT ON TABLE socialcandor_schema.user_subscriptions IS 'Active subscription tracking with billing cycle and dunning management';
COMMENT ON COLUMN socialcandor_schema.user_subscriptions.dunning_stage IS 'Current stage in the dunning process (0-5, 0 = no dunning needed)';

-- Create index for performance
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_user_id 
    ON socialcandor_schema.user_subscriptions(user_id);

CREATE INDEX IF NOT EXISTS idx_user_subscriptions_plan_id 
    ON socialcandor_schema.user_subscriptions(plan_id);

CREATE INDEX IF NOT EXISTS idx_user_subscriptions_status 
    ON socialcandor_schema.user_subscriptions(status)
    WHERE status IN ('ACTIVE', 'TRIAL', 'GRACE_PERIOD');

CREATE INDEX IF NOT EXISTS idx_user_subscriptions_trial 
    ON socialcandor_schema.user_subscriptions(trial_ends_at)
    WHERE trial_ends_at IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_user_subscriptions_current_period 
    ON socialcandor_schema.user_subscriptions(current_period_end);

-- Create function to update is_in_trial status
CREATE OR REPLACE FUNCTION socialcandor_schema.update_trial_status()
RETURNS TRIGGER AS $$
BEGIN
    -- Update is_in_trial based on trial_ends_at and current time
    NEW.is_in_trial := (
        NEW.trial_ends_at IS NOT NULL 
        AND NEW.trial_ends_at > CURRENT_TIMESTAMP
        AND (NEW.status = 'TRIAL' OR NEW.status = 'ACTIVE')
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger to update trial status
DROP TRIGGER IF EXISTS trg_update_trial_status ON socialcandor_schema.user_subscriptions;
CREATE TRIGGER trg_update_trial_status
    BEFORE INSERT OR UPDATE 
    ON socialcandor_schema.user_subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_trial_status();

-- Create function to update trial status periodically (for existing records)
CREATE OR REPLACE FUNCTION socialcandor_schema.update_all_trial_statuses()
RETURNS INTEGER AS $$
DECLARE
    updated_count INTEGER;
BEGIN
    UPDATE socialcandor_schema.user_subscriptions
    SET is_in_trial = (
        trial_ends_at IS NOT NULL 
        AND trial_ends_at > CURRENT_TIMESTAMP
        AND (status = 'TRIAL' OR status = 'ACTIVE')
    )
    WHERE is_in_trial != (
        trial_ends_at IS NOT NULL 
        AND trial_ends_at > CURRENT_TIMESTAMP
        AND (status = 'TRIAL' OR status = 'ACTIVE')
    );
    
    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RETURN updated_count;
END;
$$ LANGUAGE plpgsql;

-- Create function to check subscription status validity
CREATE OR REPLACE FUNCTION socialcandor_schema.check_subscription_status_validity()
RETURNS TRIGGER AS $$
BEGIN
    -- Ensure trial subscriptions have trial dates
    IF NEW.status = 'TRIAL' THEN
        IF NEW.trial_started_at IS NULL THEN
            NEW.trial_started_at := COALESCE(NEW.started_at, CURRENT_TIMESTAMP);
        END IF;
        IF NEW.trial_ends_at IS NULL THEN
            -- Default to 14 days trial if not specified
            NEW.trial_ends_at := COALESCE(NEW.trial_started_at, NEW.started_at, CURRENT_TIMESTAMP) + INTERVAL '14 days';
        END IF;
    END IF;

    -- Ensure current period dates are set for active subscriptions
    IF NEW.status IN ('ACTIVE', 'TRIAL', 'GRACE_PERIOD') THEN
        IF NEW.current_period_start IS NULL THEN
            NEW.current_period_start := COALESCE(NEW.started_at, CURRENT_TIMESTAMP);
        END IF;
        IF NEW.current_period_end IS NULL THEN
            -- Set period end based on billing cycle
            CASE NEW.billing_cycle
                WHEN 'MONTHLY' THEN
                    NEW.current_period_end := NEW.current_period_start + INTERVAL '1 month';
                WHEN 'QUARTERLY' THEN
                    NEW.current_period_end := NEW.current_period_start + INTERVAL '3 months';
                WHEN 'ANNUAL' THEN
                    NEW.current_period_end := NEW.current_period_start + INTERVAL '1 year';
                WHEN 'LIFETIME' THEN
                    NEW.current_period_end := NEW.current_period_start + INTERVAL '100 years';
                ELSE
                    NEW.current_period_end := NEW.current_period_start + INTERVAL '1 month';
            END CASE;
        END IF;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger for subscription status validity
DROP TRIGGER IF EXISTS trg_check_subscription_status ON socialcandor_schema.user_subscriptions;
CREATE TRIGGER trg_check_subscription_status
    BEFORE INSERT OR UPDATE 
    ON socialcandor_schema.user_subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.check_subscription_status_validity();

-- Create view for active subscriptions
CREATE OR REPLACE VIEW socialcandor_schema.active_user_subscriptions AS
SELECT 
    us.*,
    -- Calculate days until trial ends
    CASE 
        WHEN us.trial_ends_at IS NOT NULL AND us.trial_ends_at > CURRENT_TIMESTAMP THEN
            EXTRACT(DAY FROM (us.trial_ends_at - CURRENT_TIMESTAMP))
        ELSE 0
    END AS days_remaining_in_trial,
    -- Calculate days until next payment
    CASE 
        WHEN us.next_payment_due_at IS NOT NULL THEN
            EXTRACT(DAY FROM (us.next_payment_due_at - CURRENT_TIMESTAMP))
        ELSE
            EXTRACT(DAY FROM (us.current_period_end - CURRENT_TIMESTAMP))
    END AS days_until_next_payment
FROM socialcandor_schema.user_subscriptions us
WHERE us.status IN ('ACTIVE', 'TRIAL', 'GRACE_PERIOD')
  AND (us.expires_at IS NULL OR us.expires_at > CURRENT_TIMESTAMP);

-- Create function to get user's current subscription
CREATE OR REPLACE FUNCTION socialcandor_schema.get_user_current_subscription(p_user_id UUID)
RETURNS SETOF socialcandor_schema.user_subscriptions AS $$
BEGIN
    RETURN QUERY
    SELECT us.*
    FROM socialcandor_schema.user_subscriptions us
    WHERE us.user_id = p_user_id
      AND us.status IN ('ACTIVE', 'TRIAL', 'GRACE_PERIOD')
      AND (us.expires_at IS NULL OR us.expires_at > CURRENT_TIMESTAMP)
    ORDER BY us.created_at DESC
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;

-- Create function to update subscription status based on dates
CREATE OR REPLACE FUNCTION socialcandor_schema.update_expired_subscriptions()
RETURNS INTEGER AS $$
DECLARE
    updated_count INTEGER;
BEGIN
    -- Update expired subscriptions
    UPDATE socialcandor_schema.user_subscriptions
    SET 
        status = 'EXPIRED',
        status_reason = 'Subscription period ended',
        updated_at = CURRENT_TIMESTAMP
    WHERE status IN ('ACTIVE', 'TRIAL', 'GRACE_PERIOD')
      AND expires_at IS NOT NULL
      AND expires_at <= CURRENT_TIMESTAMP
      AND (status != 'EXPIRED' OR status_reason IS NULL);

    -- Update trial status
    UPDATE socialcandor_schema.user_subscriptions
    SET 
        status = CASE 
            WHEN auto_renew = TRUE THEN 'ACTIVE'
            ELSE 'CANCELLED'
        END,
        status_reason = 'Trial period ended',
        updated_at = CURRENT_TIMESTAMP
    WHERE status = 'TRIAL'
      AND trial_ends_at IS NOT NULL
      AND trial_ends_at <= CURRENT_TIMESTAMP;

    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RETURN updated_count;
END;
$$ LANGUAGE plpgsql;

-- Create function to calculate prorated amount for upgrade/downgrade
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_prorated_amount(
    p_old_plan_id UUID,
    p_new_plan_id UUID,
    p_current_period_start TIMESTAMP WITH TIME ZONE,
    p_current_period_end TIMESTAMP WITH TIME ZONE,
    p_switch_date TIMESTAMP WITH TIME ZONE
) RETURNS NUMERIC AS $$
DECLARE
    v_old_daily_rate NUMERIC;
    v_new_daily_rate NUMERIC;
    v_days_used INTEGER;
    v_days_remaining INTEGER;
    v_total_days INTEGER;
    v_refund_amount NUMERIC;
    v_charge_amount NUMERIC;
BEGIN
    -- Get old and new plan prices
    SELECT 
        COALESCE(monthly_price, 0) / 30,
        COALESCE(monthly_price, 0) / 30
    INTO v_old_daily_rate, v_new_daily_rate
    FROM socialcandor_schema.subscription_plans
    WHERE plan_id IN (p_old_plan_id, p_new_plan_id);

    -- Calculate days
    v_total_days := EXTRACT(DAY FROM (p_current_period_end - p_current_period_start));
    v_days_used := EXTRACT(DAY FROM (p_switch_date - p_current_period_start));
    v_days_remaining := v_total_days - v_days_used;

    -- Calculate prorated amount
    v_refund_amount := v_old_daily_rate * v_days_remaining;
    v_charge_amount := v_new_daily_rate * v_days_remaining;

    RETURN v_charge_amount - v_refund_amount;
END;
$$ LANGUAGE plpgsql;

-- Create function to handle subscription upgrades/downgrades
CREATE OR REPLACE FUNCTION socialcandor_schema.change_subscription_plan(
    p_subscription_id UUID,
    p_new_plan_id UUID,
    p_change_type VARCHAR(20)
) RETURNS UUID AS $$
DECLARE
    v_old_subscription socialcandor_schema.user_subscriptions%ROWTYPE;
    v_new_subscription_id UUID;
    v_prorated_amount NUMERIC;
BEGIN
    -- Get current subscription
    SELECT * INTO v_old_subscription
    FROM socialcandor_schema.user_subscriptions
    WHERE subscription_id = p_subscription_id;

    -- Calculate prorated amount
    v_prorated_amount := socialcandor_schema.calculate_prorated_amount(
        v_old_subscription.plan_id,
        p_new_plan_id,
        v_old_subscription.current_period_start,
        v_old_subscription.current_period_end,
        CURRENT_TIMESTAMP
    );

    -- End old subscription
    UPDATE socialcandor_schema.user_subscriptions
    SET 
        status = 'CANCELLED',
        status_reason = 'Changed to new plan: ' || p_change_type,
        cancelled_at = CURRENT_TIMESTAMP,
        updated_at = CURRENT_TIMESTAMP
    WHERE subscription_id = p_subscription_id;

    -- Create new subscription
    INSERT INTO socialcandor_schema.user_subscriptions (
        user_id,
        plan_id,
        status,
        billing_cycle,
        currency,
        amount,
        started_at,
        current_period_start,
        current_period_end,
        previous_subscription_id,
        upgrade_path,
        prorated_amount,
        created_by,
        updated_by
    ) VALUES (
        v_old_subscription.user_id,
        p_new_plan_id,
        'ACTIVE',
        v_old_subscription.billing_cycle,
        v_old_subscription.currency,
        (SELECT COALESCE(monthly_price, 0) FROM socialcandor_schema.subscription_plans WHERE plan_id = p_new_plan_id),
        CURRENT_TIMESTAMP,
        CURRENT_TIMESTAMP,
        CURRENT_TIMESTAMP + INTERVAL '1 month', -- Default to 1 month, will be updated by trigger
        p_subscription_id,
        p_change_type,
        v_prorated_amount,
        v_old_subscription.created_by,
        v_old_subscription.updated_by
    ) RETURNING subscription_id INTO v_new_subscription_id;

    RETURN v_new_subscription_id;
END;
$$ LANGUAGE plpgsql;

-- Create function to pause subscription
CREATE OR REPLACE FUNCTION socialcandor_schema.pause_subscription(
    p_subscription_id UUID,
    p_pause_reason VARCHAR(200),
    p_pause_duration_days INTEGER DEFAULT 30
) RETURNS BOOLEAN AS $$
BEGIN
    UPDATE socialcandor_schema.user_subscriptions
    SET 
        status = 'PAUSED',
        pause_start_at = CURRENT_TIMESTAMP,
        pause_end_at = CURRENT_TIMESTAMP + (p_pause_duration_days * INTERVAL '1 day'),
        pause_reason = p_pause_reason,
        updated_at = CURRENT_TIMESTAMP
    WHERE subscription_id = p_subscription_id
      AND status IN ('ACTIVE', 'TRIAL');

    RETURN FOUND;
END;
$$ LANGUAGE plpgsql;

-- Create function to resume subscription
CREATE OR REPLACE FUNCTION socialcandor_schema.resume_subscription(p_subscription_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
    UPDATE socialcandor_schema.user_subscriptions
    SET 
        status = 'ACTIVE',
        pause_start_at = NULL,
        pause_end_at = NULL,
        pause_reason = NULL,
        updated_at = CURRENT_TIMESTAMP
    WHERE subscription_id = p_subscription_id
      AND status = 'PAUSED';

    RETURN FOUND;
END;
$$ LANGUAGE plpgsql;

-- Create function to update updated_at timestamp automatically
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger for auto-updating updated_at
DROP TRIGGER IF EXISTS trg_update_updated_at ON socialcandor_schema.user_subscriptions;
CREATE TRIGGER trg_update_updated_at
    BEFORE UPDATE 
    ON socialcandor_schema.user_subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Create function to check and update dunning status
CREATE OR REPLACE FUNCTION socialcandor_schema.check_dunning_status()
RETURNS TRIGGER AS $$
BEGIN
    -- If status changes to FAILED, start dunning process if not already started
    IF NEW.status = 'FAILED' AND OLD.status != 'FAILED' THEN
        NEW.dunning_stage := 1;
        NEW.last_dunning_email_at := CURRENT_TIMESTAMP;
        NEW.dunning_emails_sent := 1;
    END IF;
    
    -- If status changes from FAILED, reset dunning
    IF NEW.status != 'FAILED' AND OLD.status = 'FAILED' THEN
        NEW.dunning_stage := 0;
        NEW.last_dunning_email_at := NULL;
        NEW.dunning_emails_sent := 0;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger for dunning status
DROP TRIGGER IF EXISTS trg_check_dunning_status ON socialcandor_schema.user_subscriptions;
CREATE TRIGGER trg_check_dunning_status
    BEFORE UPDATE 
    ON socialcandor_schema.user_subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.check_dunning_status();

      -- Indexes for user_subscriptions
      CREATE INDEX IF NOT EXISTS idx_user_subscriptions_user ON socialcandor_schema.user_subscriptions(user_id);
      CREATE INDEX IF NOT EXISTS idx_user_subscriptions_plan ON socialcandor_schema.user_subscriptions(plan_id);
      CREATE INDEX IF NOT EXISTS idx_user_subscriptions_status ON socialcandor_schema.user_subscriptions(status);
      CREATE INDEX IF NOT EXISTS idx_user_subscriptions_period_end ON socialcandor_schema.user_subscriptions(current_period_end);
      CREATE INDEX IF NOT EXISTS idx_user_subscriptions_payment_due ON socialcandor_schema.user_subscriptions(next_payment_due_at) WHERE next_payment_due_at IS NOT NULL;
      CREATE INDEX IF NOT EXISTS idx_user_subscriptions_trial ON socialcandor_schema.user_subscriptions(trial_ends_at) WHERE trial_ends_at IS NOT NULL;
      CREATE INDEX IF NOT EXISTS idx_user_subscriptions_provider ON socialcandor_schema.user_subscriptions(payment_provider, payment_provider_subscription_id);

      -- Function to handle subscription renewal
      CREATE OR REPLACE FUNCTION socialcandor_schema.process_subscription_renewal()
      RETURNS TABLE(
          processed_count INTEGER,
          renewed_count INTEGER,
          failed_count INTEGER,
          cancelled_count INTEGER
      ) AS $$
      DECLARE
          v_subscription RECORD;
          v_processed_count INTEGER := 0;
          v_renewed_count INTEGER := 0;
          v_failed_count INTEGER := 0;
          v_cancelled_count INTEGER := 0;
          v_new_period_start TIMESTAMP WITH TIME ZONE;
          v_new_period_end TIMESTAMP WITH TIME ZONE;
          v_renewal_successful BOOLEAN;
      BEGIN
          -- Process subscriptions due for renewal
          FOR v_subscription IN
              SELECT *
              FROM socialcandor_schema.user_subscriptions
              WHERE status IN ('ACTIVE', 'GRACE_PERIOD')
              AND current_period_end <= CURRENT_TIMESTAMP + INTERVAL '1 day'
              AND (next_renewal_attempt_at IS NULL OR next_renewal_attempt_at <= CURRENT_TIMESTAMP)
              AND auto_renew = TRUE
              FOR UPDATE SKIP LOCKED
          LOOP
              v_processed_count := v_processed_count + 1;

              -- Calculate new period dates
              v_new_period_start := v_subscription.current_period_end;
              CASE v_subscription.billing_cycle
                  WHEN 'MONTHLY' THEN
                      v_new_period_end := v_new_period_start + INTERVAL '1 month';
                  WHEN 'QUARTERLY' THEN
                      v_new_period_end := v_new_period_start + INTERVAL '3 months';
                  WHEN 'ANNUAL' THEN
                      v_new_period_end := v_new_period_start + INTERVAL '1 year';
                  ELSE
                      v_new_period_end := v_new_period_start + INTERVAL '1 month';
              END CASE;

              -- Attempt payment (simplified - would integrate with payment provider)
              BEGIN
                  -- Simulate payment processing
                  v_renewal_successful := random() > 0.05; -- 95% success rate for demo

                  IF v_renewal_successful THEN
                      -- Successful renewal
                      UPDATE socialcandor_schema.user_subscriptions
                      SET
                          status = 'ACTIVE',
                          current_period_start = v_new_period_start,
                          current_period_end = v_new_period_end,
                          last_renewal_at = CURRENT_TIMESTAMP,
                          renewal_attempts = 0,
                          dunning_stage = 0,
                          updated_at = CURRENT_TIMESTAMP
                      WHERE subscription_id = v_subscription.subscription_id;

                      v_renewed_count := v_renewed_count + 1;

                      -- Record successful payment
                      INSERT INTO socialcandor_schema.payment_transactions (
                          subscription_id,
                          user_id,
                          amount,
                          currency,
                          status,
                          payment_method,
                          created_by
                      ) VALUES (
                          v_subscription.subscription_id,
                          v_subscription.user_id,
                          v_subscription.amount,
                          v_subscription.currency,
                          'SUCCESS',
                          v_subscription.payment_provider,
                          v_subscription.user_id
                      );

                      -- Send renewal confirmation
                      INSERT INTO socialcandor_schema.notifications (
                          user_id,
                          notification_type,
                          title,
                          body,
                          data_payload,
                          delivery_channels,
                          created_by
                      ) VALUES (
                          v_subscription.user_id,
                          'SUBSCRIPTION_RENEWED',
                          'Subscription Renewed',
                          'Your subscription has been successfully renewed. Next payment due: ' ||
                          TO_CHAR(v_new_period_end, 'YYYY-MM-DD'),
                          jsonb_build_object(
                              'subscription_id', v_subscription.subscription_id,
                              'amount', v_subscription.amount,
                              'currency', v_subscription.currency,
                              'next_payment_date', v_new_period_end
                          ),
                          ARRAY['EMAIL', 'IN_APP']::socialcandor_schema.notification_channel[],
                          uuid_nil()
                      );

                  ELSE
                      -- Payment failed
                      UPDATE socialcandor_schema.user_subscriptions
                      SET
                          status = CASE
                              WHEN v_subscription.dunning_stage < 3 THEN 'GRACE_PERIOD'
                              ELSE 'FAILED'
                          END,
                          renewal_attempts = v_subscription.renewal_attempts + 1,
                          dunning_stage = v_subscription.dunning_stage + 1,
                          next_renewal_attempt_at = CURRENT_TIMESTAMP +
                              CASE v_subscription.dunning_stage
                                  WHEN 0 THEN INTERVAL '2 days'
                                  WHEN 1 THEN INTERVAL '3 days'
                                  WHEN 2 THEN INTERVAL '5 days'
                                  ELSE INTERVAL '7 days'
                              END,
                          updated_at = CURRENT_TIMESTAMP
                      WHERE subscription_id = v_subscription.subscription_id;

                      v_failed_count := v_failed_count + 1;

                      -- Record failed payment
                      INSERT INTO socialcandor_schema.payment_transactions (
                          subscription_id,
                          user_id,
                          amount,
                          currency,
                          status,
                          payment_method,
                          failure_reason,
                          created_by
                      ) VALUES (
                          v_subscription.subscription_id,
                          v_subscription.user_id,
                          v_subscription.amount,
                          v_subscription.currency,
                          'FAILED',
                          v_subscription.payment_provider,
                          'Payment declined',
                          v_subscription.user_id
                      );

                      -- Send failure notification based on dunning stage
                      IF v_subscription.dunning_stage < 2 THEN
                          INSERT INTO socialcandor_schema.notifications (
                              user_id,
                              notification_type,
                              title,
                              body,
                              data_payload,
                              delivery_channels,
                              created_by
                          ) VALUES (
                              v_subscription.user_id,
                              'SUBSCRIPTION_PAYMENT_FAILED',
                              'Payment Failed',
                              'We were unable to process your subscription payment. We will retry in ' ||
                              CASE v_subscription.dunning_stage
                                  WHEN 0 THEN '2 days'
                                  WHEN 1 THEN '3 days'
                                  ELSE '5 days'
                              END,
                              jsonb_build_object(
                                  'subscription_id', v_subscription.subscription_id,
                                  'amount', v_subscription.amount,
                                  'currency', v_subscription.currency,
                                  'retry_date', CURRENT_TIMESTAMP +
                                      CASE v_subscription.dunning_stage
                                          WHEN 0 THEN INTERVAL '2 days'
                                          WHEN 1 THEN INTERVAL '3 days'
                                          ELSE INTERVAL '5 days'
                                      END
                              ),
                              ARRAY['EMAIL']::socialcandor_schema.notification_channel[],
                              uuid_nil()
                          );
                      END IF;

                      -- Cancel subscription if too many failed attempts
                      IF v_subscription.dunning_stage >= 3 THEN
                          UPDATE socialcandor_schema.user_subscriptions
                          SET
                              status = 'CANCELLED',
                              cancelled_at = CURRENT_TIMESTAMP,
                              cancel_reason = 'Payment failure after multiple attempts',
                              updated_at = CURRENT_TIMESTAMP
                          WHERE subscription_id = v_subscription.subscription_id;

                          v_cancelled_count := v_cancelled_count + 1;

                          -- Send cancellation notification
                          INSERT INTO socialcandor_schema.notifications (
                              user_id,
                              notification_type,
                              title,
                              body,
                              data_payload,
                              delivery_channels,
                              created_by
                          ) VALUES (
                              v_subscription.user_id,
                              'SUBSCRIPTION_CANCELLED',
                              'Subscription Cancelled',
                              'Your subscription has been cancelled due to multiple failed payment attempts.',
                              jsonb_build_object(
                                  'subscription_id', v_subscription.subscription_id,
                                  'cancellation_reason', 'Payment failure after multiple attempts',
                                  'cancellation_date', CURRENT_TIMESTAMP
                              ),
                              ARRAY['EMAIL', 'IN_APP']::socialcandor_schema.notification_channel[],
                              uuid_nil()
                          );
                      END IF;
                  END IF;

              EXCEPTION
                  WHEN OTHERS THEN
                      -- Log error but continue processing other subscriptions
                      RAISE NOTICE 'Error processing subscription %: %', v_subscription.subscription_id, SQLERRM;
              END;
          END LOOP;

          RETURN QUERY SELECT
              v_processed_count,
              v_renewed_count,
              v_failed_count,
              v_cancelled_count;

      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.process_subscription_renewal IS 'Processes subscription renewals, handles failed payments, and manages dunning';

      -- Trigger for updated_at
      CREATE TRIGGER trg_user_subscriptions_updated_at
          BEFORE UPDATE ON socialcandor_schema.user_subscriptions
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
-- Table: 96 - creator_monetization
-- Description: Creator payment configuration with minimum tip amounts
-- Business Case: Enables creator economy features while preventing microtransaction fraud
-- through tip amount floors and velocity checks on rapid tipping patterns.
-- Supports diverse monetization models (tips, subscriptions, paid content) with fraud prevention.
-- Feature Reference: MON05 (Creator Economy), FRAUD01 (Fraud Prevention), CRE02 (Monetization Tools)
-----------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.creator_monetization (
    monetization_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    creator_user_id UUID NOT NULL UNIQUE,

    -- Monetization status
    is_monetization_enabled BOOLEAN DEFAULT FALSE,
    monetization_status VARCHAR(20) DEFAULT 'PENDING_APPROVAL' CHECK (
        monetization_status IN ('PENDING_APPROVAL', 'APPROVED', 'REJECTED', 'SUSPENDED', 'DEACTIVATED')
    ),
    status_reason VARCHAR(200),
    approved_at TIMESTAMP WITH TIME ZONE,
    approved_by UUID,

    -- Payment configuration
    payment_methods VARCHAR(50)[] DEFAULT '{}' CHECK (
        payment_methods <@ ARRAY['CREDIT_CARD', 'PAYPAL', 'BANK_TRANSFER', 'CRYPTO', 'OTHER']::VARCHAR(50)[]
    ),
    primary_payout_method VARCHAR(50),
    payout_threshold NUMERIC(10,2) DEFAULT 50.00 CHECK (payout_threshold >= 0),
    payout_schedule VARCHAR(20) DEFAULT 'MONTHLY' CHECK (
        payout_schedule IN ('DAILY', 'WEEKLY', 'BI_WEEKLY', 'MONTHLY', 'QUARTERLY', 'MANUAL')
    ),

    -- Tip configuration
    accept_tips BOOLEAN DEFAULT TRUE,
    minimum_tip_amount NUMERIC(10,2) DEFAULT 1.00 CHECK (minimum_tip_amount >= 0),
    maximum_tip_amount NUMERIC(10,2) DEFAULT 1000.00 CHECK (maximum_tip_amount >= 0),
    suggested_tip_amounts NUMERIC(10,2)[] DEFAULT '{1.99, 4.99, 9.99, 19.99}',
    tip_velocity_limit_per_hour INTEGER DEFAULT 10 CHECK (tip_velocity_limit_per_hour >= 0),

    -- Subscription configuration
    accept_subscriptions BOOLEAN DEFAULT FALSE,
    subscription_tiers JSONB DEFAULT '[
        {"name": "Supporter", "amount": 4.99, "benefits": ["Exclusive posts", "Behind the scenes"]},
        {"name": "VIP", "amount": 9.99, "benefits": ["All previous benefits", "Monthly Q&A"]}
    ]',

    -- Paid content configuration
    sell_content BOOLEAN DEFAULT FALSE,
    content_price_range JSONB DEFAULT '{"min": 0.99, "max": 99.99}',
    content_commission_percentage NUMERIC(5,2) DEFAULT 20.0 CHECK (content_commission_percentage >= 0 AND content_commission_percentage <= 100),

    -- Commission and fees
    platform_commission_percentage NUMERIC(5,2) DEFAULT 10.0 CHECK (platform_commission_percentage >= 0 AND platform_commission_percentage <= 100),
    processing_fee_percentage NUMERIC(5,2) DEFAULT 2.9 CHECK (processing_fee_percentage >= 0 AND processing_fee_percentage <= 100),
    fixed_processing_fee NUMERIC(10,2) DEFAULT 0.30 CHECK (fixed_processing_fee >= 0),

    -- Tax configuration
    tax_country VARCHAR(3),
    tax_id VARCHAR(50),
    tax_form_status VARCHAR(20) DEFAULT 'NOT_SUBMITTED' CHECK (
        tax_form_status IN ('NOT_SUBMITTED', 'PENDING_REVIEW', 'APPROVED', 'REJECTED', 'EXPIRED')
    ),
    tax_form_url VARCHAR(500),

    -- Compliance and verification
    identity_verified BOOLEAN DEFAULT FALSE,
    identity_verification_method VARCHAR(50),
    identity_verified_at TIMESTAMP WITH TIME ZONE,
    age_verified BOOLEAN DEFAULT FALSE,
    compliance_checks_passed BOOLEAN DEFAULT FALSE,

    -- Fraud prevention
    fraud_score NUMERIC(5,2) DEFAULT 0.0 CHECK (fraud_score >= 0 AND fraud_score <= 100),
    fraud_risk_level VARCHAR(20) DEFAULT 'LOW' CHECK (
        fraud_risk_level IN ('LOW', 'MEDIUM', 'HIGH', 'VERY_HIGH')
    ),
    last_fraud_check_at TIMESTAMP WITH TIME ZONE,
    fraud_check_results JSONB DEFAULT '{}',

    -- Performance metrics
    total_earnings NUMERIC(15,2) DEFAULT 0.0 CHECK (total_earnings >= 0),
    available_balance NUMERIC(15,2) DEFAULT 0.0 CHECK (available_balance >= 0),
    total_payouts NUMERIC(15,2) DEFAULT 0.0 CHECK (total_payouts >= 0),
    earnings_last_30_days NUMERIC(15,2) DEFAULT 0.0 CHECK (earnings_last_30_days >= 0),
    top_tippers UUID[] DEFAULT '{}',

    -- Content performance
    best_performing_content JSONB DEFAULT '[]',
    conversion_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (conversion_rate >= 0 AND conversion_rate <= 100),
    average_tip_amount NUMERIC(10,2) DEFAULT 0.0 CHECK (average_tip_amount >= 0),

    -- Settings and preferences
    monetization_preferences JSONB DEFAULT '{
        "public_earnings": false,
        "show_tip_history": true,
        "auto_thank_you_messages": true,
        "custom_thank_you_message": "Thank you for your support!",
        "goal_tracking": false,
        "monthly_goal": 0
    }',

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_creator_monetization_user FOREIGN KEY (creator_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_creator_monetization_approved_by FOREIGN KEY (approved_by)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_monetization_thresholds CHECK (
        minimum_tip_amount <= maximum_tip_amount
    ),
    CONSTRAINT chk_tax_requirements CHECK (
        (tax_form_status = 'APPROVED') = (identity_verified = TRUE)
    )
);

COMMENT ON TABLE socialcandor_schema.creator_monetization IS 'Creator payment configuration with fraud prevention and compliance features';
COMMENT ON COLUMN socialcandor_schema.creator_monetization.tip_velocity_limit_per_hour IS 'Maximum number of tips allowed per hour to prevent fraud';

      -- Indexes for creator_monetization
      CREATE INDEX IF NOT EXISTS idx_creator_monetization_creator ON socialcandor_schema.creator_monetization(creator_user_id);
      CREATE INDEX IF NOT EXISTS idx_creator_monetization_status ON socialcandor_schema.creator_monetization(monetization_status);
      CREATE INDEX IF NOT EXISTS idx_creator_monetization_enabled ON socialcandor_schema.creator_monetization(is_monetization_enabled) WHERE is_monetization_enabled = TRUE;
      CREATE INDEX IF NOT EXISTS idx_creator_monetization_earnings ON socialcandor_schema.creator_monetization(total_earnings DESC);
      CREATE INDEX IF NOT EXISTS idx_creator_monetization_fraud_risk ON socialcandor_schema.creator_monetization(fraud_risk_level);
      CREATE INDEX IF NOT EXISTS idx_creator_monetization_tax_status ON socialcandor_schema.creator_monetization(tax_form_status);

      -- Function to check tip velocity
      CREATE OR REPLACE FUNCTION socialcandor_schema.check_tip_velocity(p_creator_user_id UUID, p_tipper_user_id UUID)
      RETURNS TABLE(
          is_allowed BOOLEAN,
          reason VARCHAR(200),
          tips_in_last_hour INTEGER,
          limit_per_hour INTEGER
      ) AS $$
      DECLARE
          v_tips_in_last_hour INTEGER;
          v_limit_per_hour INTEGER;
          v_is_allowed BOOLEAN := TRUE;
          v_reason VARCHAR(200) := '';
      BEGIN
          -- Get creator's tip velocity limit
          SELECT tip_velocity_limit_per_hour INTO v_limit_per_hour
          FROM socialcandor_schema.creator_monetization
          WHERE creator_user_id = p_creator_user_id
          AND is_monetization_enabled = TRUE;

          IF v_limit_per_hour IS NULL THEN
              v_limit_per_hour := 10; -- Default limit
          END IF;

          -- Count tips from this tipper to this creator in the last hour
          SELECT COUNT(*) INTO v_tips_in_last_hour
          FROM socialcandor_schema.tip_transactions tt
          WHERE tt.creator_user_id = p_creator_user_id
          AND tt.tipper_user_id = p_tipper_user_id
          AND tt.created_at >= CURRENT_TIMESTAMP - INTERVAL '1 hour'
          AND tt.status = 'COMPLETED';

          -- Check if limit exceeded
          IF v_tips_in_last_hour >= v_limit_per_hour THEN
              v_is_allowed := FALSE;
              v_reason := format('Tip velocity limit exceeded. %s tips in the last hour (limit: %s)',
                                v_tips_in_last_hour, v_limit_per_hour);
          END IF;

          -- Additional fraud checks
          IF v_is_allowed THEN
              -- Check for suspicious pattern (same amount repeated)
              SELECT COUNT(DISTINCT amount) INTO v_tips_in_last_hour
              FROM socialcandor_schema.tip_transactions tt
              WHERE tt.creator_user_id = p_creator_user_id
              AND tt.tipper_user_id = p_tipper_user_id
              AND tt.created_at >= CURRENT_TIMESTAMP - INTERVAL '5 minutes'
              AND tt.status = 'COMPLETED';

              IF v_tips_in_last_hour = 1 AND v_tips_in_last_hour >= 3 THEN
                  v_is_allowed := FALSE;
                  v_reason := 'Suspicious tipping pattern detected (same amount repeated rapidly)';
              END IF;
          END IF;

          RETURN QUERY SELECT v_is_allowed, v_reason, v_tips_in_last_hour, v_limit_per_hour;

      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.check_tip_velocity IS 'Checks if a tip is allowed based on velocity limits and fraud patterns';

      -- Trigger for updated_at
      CREATE TRIGGER trg_creator_monetization_updated_at
          BEFORE UPDATE ON socialcandor_schema.creator_monetization
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
-- Table: 97 - search_history
-- Description: User search query logging for personalization
-- Business Case: Powers search autocomplete and trending topics discovery while
-- maintaining GDPR compliance through automatic anonymization of search history
-- after retention period. Enables personalized search experiences without compromising privacy.
-- Feature Reference: SRCH02 (Search History), PRV07 (Privacy Compliance), PERF07 (Search Optimization)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.search_history (
    search_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID,

    -- Search query
    search_query TEXT NOT NULL,
    normalized_query VARCHAR(500) GENERATED ALWAYS AS (LOWER(TRIM(search_query))) STORED,
    query_type VARCHAR(20) DEFAULT 'TEXT' CHECK (
        query_type IN ('TEXT', 'VOICE', 'IMAGE', 'LOCATION', 'HASHTAG', 'MENTION')
    ),

    -- Search context
    search_context VARCHAR(30) DEFAULT 'GLOBAL' CHECK (
        search_context IN ('GLOBAL', 'USERS', 'POSTS', 'GROUPS', 'EVENTS', 'HASHTAGS', 'LOCAL')
    ),
    filters_applied JSONB DEFAULT '{}',
    sort_order VARCHAR(50),

    -- Location context
    location_coordinates GEOGRAPHY(POINT, 4326),
    location_radius_km INTEGER CHECK (location_radius_km >= 0),
    location_name VARCHAR(255),

    -- Device and session context
    device_type VARCHAR(50),
    device_id VARCHAR(255),
    session_id UUID,

    -- Results and engagement
    total_results INTEGER CHECK (total_results >= 0),
    results_viewed INTEGER DEFAULT 0 CHECK (results_viewed >= 0),
    clicked_results UUID[] DEFAULT '{}',
    clicked_positions INTEGER[] DEFAULT '{}',
    time_spent_seconds INTEGER CHECK (time_spent_seconds >= 0),

    -- Search success metrics
    is_successful BOOLEAN DEFAULT TRUE,
    success_criteria VARCHAR(20) DEFAULT 'CLICK' CHECK (
        success_criteria IN ('CLICK', 'TIME_SPENT', 'CONVERSION', 'BOUNCE')
    ),
    satisfaction_score NUMERIC(3,1) CHECK (satisfaction_score >= 1 AND satisfaction_score <= 5),

    -- Privacy and retention
    is_anonymous BOOLEAN DEFAULT FALSE,
    anonymized_at TIMESTAMP WITH TIME ZONE,
    retention_days INTEGER DEFAULT 90 CHECK (retention_days >= 1 AND retention_days <= 730),
    
    -- Changed: Use a trigger instead of generated column for dynamic calculation
    scheduled_deletion_at TIMESTAMP WITH TIME ZONE,

    -- Personalization data
    personalization_features JSONB DEFAULT '{
        "previous_searches": [],
        "common_interests": [],
        "demographic_group": null,
        "search_behavior": "STANDARD"
    }'::jsonb,

    -- Error tracking
    error_occurred BOOLEAN DEFAULT FALSE,
    error_type VARCHAR(50),
    error_message TEXT,

    -- Performance metrics
    response_time_ms INTEGER CHECK (response_time_ms >= 0),
    cache_hit BOOLEAN DEFAULT FALSE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_search_history_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT chk_search_query_length CHECK (LENGTH(search_query) <= 1000),
    CONSTRAINT chk_anonymous_user CHECK (
        (is_anonymous = TRUE AND user_id IS NULL) OR
        (is_anonymous = FALSE AND user_id IS NOT NULL) OR
        is_anonymous = FALSE
    )
);

COMMENT ON TABLE socialcandor_schema.search_history IS 'User search query logging with privacy controls and personalization features';
COMMENT ON COLUMN socialcandor_schema.search_history.scheduled_deletion_at IS 'Automatic deletion timestamp for GDPR compliance, calculated as created_at + retention_days';

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_search_history_user_id ON socialcandor_schema.search_history(user_id);
CREATE INDEX IF NOT EXISTS idx_search_history_created_at ON socialcandor_schema.search_history(created_at);
CREATE INDEX IF NOT EXISTS idx_search_history_scheduled_deletion ON socialcandor_schema.search_history(scheduled_deletion_at);
CREATE INDEX IF NOT EXISTS idx_search_history_normalized_query ON socialcandor_schema.search_history(normalized_query);
CREATE INDEX IF NOT EXISTS idx_search_history_anonymous ON socialcandor_schema.search_history(is_anonymous, scheduled_deletion_at);

-- Create index for geography searches if using location-based queries frequently
CREATE INDEX IF NOT EXISTS idx_search_history_location ON socialcandor_schema.search_history USING GIST (location_coordinates);

-- Create trigger for updated_at auto-update
CREATE OR REPLACE FUNCTION socialcandor_schema.update_search_history_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger to calculate scheduled_deletion_at on insert and update
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_scheduled_deletion()
RETURNS TRIGGER AS $$
BEGIN
    -- Calculate scheduled_deletion_at as created_at + retention_days
    NEW.scheduled_deletion_at = NEW.created_at + (NEW.retention_days || ' days')::INTERVAL;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create triggers
CREATE TRIGGER trg_search_history_updated_at
    BEFORE UPDATE ON socialcandor_schema.search_history
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_search_history_updated_at();

CREATE TRIGGER trg_search_history_calculate_deletion
    BEFORE INSERT OR UPDATE OF retention_days, created_at ON socialcandor_schema.search_history
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_scheduled_deletion();

-- Optional: Function to anonymize old search history
CREATE OR REPLACE FUNCTION socialcandor_schema.anonymize_old_searches()
RETURNS void AS $$
BEGIN
    UPDATE socialcandor_schema.search_history
    SET 
        search_query = 'ANONYMIZED',
        normalized_query = 'anonymized',
        user_id = NULL,
        device_id = NULL,
        session_id = NULL,
        is_anonymous = TRUE,
        anonymized_at = CURRENT_TIMESTAMP,
        personalization_features = '{"search_behavior": "ANONYMIZED"}'::jsonb
    WHERE 
        scheduled_deletion_at <= CURRENT_TIMESTAMP 
        AND is_anonymous = FALSE;
END;
$$ LANGUAGE plpgsql;

-- Optional: Function to purge anonymized records after additional period
CREATE OR REPLACE FUNCTION socialcandor_schema.purge_anonymized_searches()
RETURNS void AS $$
BEGIN
    DELETE FROM socialcandor_schema.search_history
    WHERE 
        is_anonymous = TRUE 
        AND anonymized_at <= CURRENT_TIMESTAMP - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;

-- View to show upcoming deletions (for monitoring)
CREATE OR REPLACE VIEW socialcandor_schema.vw_upcoming_search_deletions AS
SELECT 
    search_id,
    user_id,
    created_at,
    retention_days,
    scheduled_deletion_at,
    is_anonymous,
    CASE 
        WHEN scheduled_deletion_at <= CURRENT_TIMESTAMP THEN 'READY_FOR_ANONYMIZATION'
        WHEN scheduled_deletion_at <= CURRENT_TIMESTAMP + INTERVAL '7 days' THEN 'WITHIN_7_DAYS'
        WHEN scheduled_deletion_at <= CURRENT_TIMESTAMP + INTERVAL '30 days' THEN 'WITHIN_30_DAYS'
        ELSE 'FUTURE'
    END as deletion_status,
    EXTRACT(DAY FROM scheduled_deletion_at - CURRENT_TIMESTAMP)::INTEGER as days_until_deletion
FROM socialcandor_schema.search_history
WHERE is_anonymous = FALSE
ORDER BY scheduled_deletion_at;

      -- Indexes for search_history
      CREATE INDEX IF NOT EXISTS idx_search_history_user ON socialcandor_schema.search_history(user_id) WHERE user_id IS NOT NULL;
      CREATE INDEX IF NOT EXISTS idx_search_history_created_at ON socialcandor_schema.search_history(created_at DESC);
      CREATE INDEX IF NOT EXISTS idx_search_history_query ON socialcandor_schema.search_history USING gin(normalized_query gin_trgm_ops);
      CREATE INDEX IF NOT EXISTS idx_search_history_context ON socialcandor_schema.search_history(search_context);
--       CREATE INDEX IF NOT EXISTS idx_search_history_deletion ON socialcandor_schema.search_history(scheduled_deletion_at) WHERE scheduled_deletion_at <= CURRENT_TIMESTAMP + INTERVAL '7 days';
      CREATE INDEX IF NOT EXISTS idx_search_history_anonymous ON socialcandor_schema.search_history(is_anonymous) WHERE is_anonymous = TRUE;
      CREATE INDEX IF NOT EXISTS idx_search_history_composite ON socialcandor_schema.search_history(user_id, created_at DESC) WHERE user_id IS NOT NULL;

      -- GIN indexes for JSONB columns
      CREATE INDEX IF NOT EXISTS idx_search_history_filters ON socialcandor_schema.search_history USING gin(filters_applied);
      CREATE INDEX IF NOT EXISTS idx_search_history_clicked ON socialcandor_schema.search_history USING gin(clicked_results);

      -- Function to anonymize old search history
      CREATE OR REPLACE FUNCTION socialcandor_schema.anonymize_search_history()
      RETURNS INTEGER AS $$
      DECLARE
          v_anonymized_count INTEGER := 0;
      BEGIN
          -- Anonymize search history older than retention period
          WITH anonymized AS (
              UPDATE socialcandor_schema.search_history
              SET
                  user_id = NULL,
                  is_anonymous = TRUE,
                  anonymized_at = CURRENT_TIMESTAMP,
                  device_id = NULL,
                  session_id = NULL,
                  updated_at = CURRENT_TIMESTAMP
              WHERE scheduled_deletion_at <= CURRENT_TIMESTAMP
              AND is_anonymous = FALSE
              AND user_id IS NOT NULL
              RETURNING search_id
          )
          SELECT COUNT(*) INTO v_anonymized_count FROM anonymized;

          -- Delete fully anonymized records older than extra grace period
          DELETE FROM socialcandor_schema.search_history
          WHERE scheduled_deletion_at <= CURRENT_TIMESTAMP - INTERVAL '30 days'
          AND is_anonymous = TRUE;

          RETURN v_anonymized_count;

      EXCEPTION
          WHEN OTHERS THEN
              RAISE NOTICE 'Error anonymizing search history: %', SQLERRM;
              RETURN -1;
      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.anonymize_search_history IS 'Anonymizes and cleans up old search history for GDPR compliance';

      -- Function to get search suggestions
      CREATE OR REPLACE FUNCTION socialcandor_schema.get_search_suggestions(p_user_id UUID, p_prefix VARCHAR(100), p_limit INTEGER DEFAULT 10)
      RETURNS TABLE(
          suggestion TEXT,
          suggestion_type VARCHAR(20),
          relevance_score NUMERIC(5,2),
          frequency INTEGER,
          last_searched_at TIMESTAMP WITH TIME ZONE
      ) AS $$
      BEGIN
          RETURN QUERY
          WITH
          user_history AS (
              SELECT
                  normalized_query,
                  COUNT(*) as frequency,
                  MAX(created_at) as last_searched
              FROM socialcandor_schema.search_history
              WHERE user_id = p_user_id
              AND normalized_query LIKE p_prefix || '%'
              AND created_at >= CURRENT_TIMESTAMP - INTERVAL '30 days'
              GROUP BY normalized_query
          ),
          popular_searches AS (
              SELECT
                  normalized_query,
                  COUNT(*) as frequency,
                  MAX(created_at) as last_searched
              FROM socialcandor_schema.search_history
              WHERE normalized_query LIKE p_prefix || '%'
              AND created_at >= CURRENT_TIMESTAMP - INTERVAL '7 days'
              GROUP BY normalized_query
          ),
          combined_suggestions AS (
              SELECT
                  COALESCE(uh.normalized_query, ps.normalized_query) as suggestion,
                  CASE
                      WHEN uh.normalized_query IS NOT NULL THEN 'PERSONAL'
                      ELSE 'POPULAR'
                  END as suggestion_type,
                  COALESCE(uh.frequency, 0) * 2 + COALESCE(ps.frequency, 0) as relevance_score,
                  COALESCE(uh.frequency, 0) + COALESCE(ps.frequency, 0) as frequency,
                  GREATEST(uh.last_searched, ps.last_searched) as last_searched_at
              FROM user_history uh
              FULL OUTER JOIN popular_searches ps ON uh.normalized_query = ps.normalized_query
          )
          SELECT
              suggestion,
              suggestion_type,
              relevance_score,
              frequency,
              last_searched_at
          FROM combined_suggestions
          ORDER BY relevance_score DESC, last_searched_at DESC
          LIMIT p_limit;

      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.get_search_suggestions IS 'Generates personalized search suggestions based on user history and popular searches';



      ------------------------------------------------------------------------------------------------
      -- Table: 98 - trending_topics
      -- Description: Real-time topic popularity tracking with post volume metrics
      -- Business Case: Drives discovery features and cultural relevance while enabling
      -- brand safety through automatic exclusion of sensitive topics from promoted placements.
      -- Supports trending algorithms with velocity-based ranking and category filtering.
      -- Feature Reference: DISC01 (Discovery), TREND01 (Trending Algorithm), MOD04 (Content Safety)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.trending_topics (
          trending_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

          -- Topic identification
          topic_text VARCHAR(200) NOT NULL,
          topic_type VARCHAR(20) NOT NULL DEFAULT 'HASHTAG' CHECK (
              topic_type IN ('HASHTAG', 'KEYWORD', 'ENTITY', 'LOCATION', 'EVENT', 'PERSON', 'BRAND')
          ),
          normalized_topic VARCHAR(200) GENERATED ALWAYS AS (LOWER(TRIM(topic_text))) STORED,

          -- Category and classification
          primary_category VARCHAR(100),
          secondary_categories VARCHAR(100)[] DEFAULT '{}',
          topic_classification JSONB DEFAULT '{
              "sentiment": "NEUTRAL",
              "controversy_level": "LOW",
              "nsfw_score": 0,
              "political_leaning": "NEUTRAL",
              "commercial_potential": "LOW"
          }',

          -- Volume metrics
          post_count_1h INTEGER DEFAULT 0 CHECK (post_count_1h >= 0),
          post_count_24h INTEGER DEFAULT 0 CHECK (post_count_24h >= 0),
          post_count_7d INTEGER DEFAULT 0 CHECK (post_count_7d >= 0),
          unique_users_count INTEGER DEFAULT 0 CHECK (unique_users_count >= 0),

          -- Velocity metrics
          velocity_1h NUMERIC(10,2) DEFAULT 0.0,
          velocity_24h NUMERIC(10,2) DEFAULT 0.0,
          acceleration_1h NUMERIC(10,2) DEFAULT 0.0,

          -- Engagement metrics
          total_engagement INTEGER DEFAULT 0 CHECK (total_engagement >= 0),
          engagement_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_rate >= 0 AND engagement_rate <= 100),
          average_sentiment NUMERIC(3,2) DEFAULT 0.0 CHECK (average_sentiment >= -1 AND average_sentiment <= 1),

          -- Geographic distribution
          top_countries VARCHAR(3)[] DEFAULT '{}',
          country_distribution JSONB DEFAULT '{}',
          location_centroid GEOGRAPHY(POINT, 4326),
          location_spread NUMERIC(10,2) DEFAULT 0.0 CHECK (location_spread >= 0),

          -- Temporal patterns
          peak_hours INTEGER[] DEFAULT '{}',
          daily_pattern JSONB DEFAULT '{}',
          trend_started_at TIMESTAMP WITH TIME ZONE,
          trend_peak_at TIMESTAMP WITH TIME ZONE,
          trend_duration_hours INTEGER DEFAULT 0 CHECK (trend_duration_hours >= 0),

          -- Trending scores
          raw_trending_score NUMERIC(10,6) DEFAULT 0.0,
          normalized_trending_score NUMERIC(10,6) DEFAULT 0.0 CHECK (normalized_trending_score >= 0 AND normalized_trending_score <= 1),
          score_components JSONB DEFAULT '{
              "volume": 0,
              "velocity": 0,
              "acceleration": 0,
              "engagement": 0,
              "diversity": 0,
              "novelty": 0
          }',

          -- Safety and moderation
          is_sensitive BOOLEAN DEFAULT FALSE,
          sensitivity_reason VARCHAR(200),
          is_excluded_from_promotion BOOLEAN DEFAULT FALSE,
          exclusion_reason VARCHAR(200),
          moderation_status VARCHAR(20) DEFAULT 'PENDING_REVIEW' CHECK (
              moderation_status IN ('PENDING_REVIEW', 'APPROVED', 'RESTRICTED', 'BLOCKED', 'WHITELISTED')
          ),

          -- Related topics
          related_topics UUID[] DEFAULT '{}',
          similarity_scores JSONB DEFAULT '{}',
          topic_cluster_id UUID,

          -- Performance tracking
          impression_count INTEGER DEFAULT 0 CHECK (impression_count >= 0),
          click_count INTEGER DEFAULT 0 CHECK (click_count >= 0),
          ctr NUMERIC(5,2) DEFAULT 0.0 CHECK (ctr >= 0 AND ctr <= 100),

          -- Metadata
          first_seen_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          last_updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          update_count INTEGER DEFAULT 0 CHECK (update_count >= 0),

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID NOT NULL,
          updated_by UUID DEFAULT uuid_nil(),

          -- Constraints
          CONSTRAINT uk_trending_topics_unique UNIQUE (normalized_topic, topic_type),
          CONSTRAINT chk_trending_velocity CHECK (
              velocity_1h >= 0 AND velocity_24h >= 0
          ),
          CONSTRAINT chk_trending_duration CHECK (
              (trend_peak_at IS NULL) OR
              (trend_started_at IS NULL) OR
              (trend_peak_at >= trend_started_at)
          )
      );

      COMMENT ON TABLE socialcandor_schema.trending_topics IS 'Real-time topic popularity tracking with volume metrics and safety features';
      COMMENT ON COLUMN socialcandor_schema.trending_topics.acceleration_1h IS 'Rate of change of velocity (posts per hour squared)';

      -- Indexes for trending_topics
      CREATE INDEX IF NOT EXISTS idx_trending_topics_topic ON socialcandor_schema.trending_topics(normalized_topic);
      CREATE INDEX IF NOT EXISTS idx_trending_topics_type ON socialcandor_schema.trending_topics(topic_type);
      CREATE INDEX IF NOT EXISTS idx_trending_topics_score ON socialcandor_schema.trending_topics(normalized_trending_score DESC);
      CREATE INDEX IF NOT EXISTS idx_trending_topics_velocity ON socialcandor_schema.trending_topics(velocity_1h DESC);
      CREATE INDEX IF NOT EXISTS idx_trending_topics_volume ON socialcandor_schema.trending_topics(post_count_1h DESC);
      CREATE INDEX IF NOT EXISTS idx_trending_topics_category ON socialcandor_schema.trending_topics(primary_category);
      CREATE INDEX IF NOT EXISTS idx_trending_topics_sensitive ON socialcandor_schema.trending_topics(is_sensitive) WHERE is_sensitive = TRUE;
      CREATE INDEX IF NOT EXISTS idx_trending_topics_updated ON socialcandor_schema.trending_topics(last_updated_at DESC);

      -- GIN indexes for array columns
      CREATE INDEX IF NOT EXISTS idx_trending_topics_categories ON socialcandor_schema.trending_topics USING GIN(secondary_categories);
      CREATE INDEX IF NOT EXISTS idx_trending_topics_countries ON socialcandor_schema.trending_topics USING GIN(top_countries);

      -- Function to calculate trending scores
      CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_trending_score(p_trending_id UUID)
      RETURNS NUMERIC(10,6) AS $$
      DECLARE
          v_topic RECORD;
          v_raw_score NUMERIC(10,6);
          v_normalized_score NUMERIC(10,6);
          v_decay_factor NUMERIC(10,6);
          v_novelty_boost NUMERIC(10,6);
          v_diversity_penalty NUMERIC(10,6);
      BEGIN
          -- Get topic data
          SELECT * INTO v_topic
          FROM socialcandor_schema.trending_topics
          WHERE trending_id = p_trending_id;

          IF NOT FOUND THEN
              RETURN 0.0;
          END IF;

          -- Calculate time decay (older trends get penalized)
          IF v_topic.trend_started_at IS NOT NULL THEN
              v_decay_factor := EXP(-EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - v_topic.trend_started_at)) / 86400.0); -- 24-hour half-life
          ELSE
              v_decay_factor := 1.0;
          END IF;

          -- Calculate novelty boost (new topics get boost)
          IF v_topic.first_seen_at >= CURRENT_TIMESTAMP - INTERVAL '1 hour' THEN
              v_novelty_boost := 1.5;
          ELSIF v_topic.first_seen_at >= CURRENT_TIMESTAMP - INTERVAL '6 hours' THEN
              v_novelty_boost := 1.2;
          ELSE
              v_novelty_boost := 1.0;
          END IF;

          -- Calculate diversity penalty (topics from diverse locations get boost)
          IF v_topic.location_spread > 1000 THEN -- More than 1000km spread
              v_diversity_penalty := 1.2;
          ELSIF v_topic.location_spread > 100 THEN
              v_diversity_penalty := 1.1;
          ELSE
              v_diversity_penalty := 1.0;
          END IF;

          -- Calculate raw score using multiple factors
          v_raw_score :=
              -- Volume component (40%)
              (LOG(GREATEST(v_topic.post_count_1h, 1)) * 0.4) +
              -- Velocity component (30%)
              (v_topic.velocity_1h / 100.0 * 0.3) +
              -- Acceleration component (15%)
              (GREATEST(v_topic.acceleration_1h, 0) / 10.0 * 0.15) +
              -- Engagement component (15%)
              (v_topic.engagement_rate / 100.0 * 0.15);

          -- Apply adjustments
          v_raw_score := v_raw_score * v_decay_factor * v_novelty_boost * v_diversity_penalty;

          -- Apply safety penalties
          IF v_topic.is_sensitive THEN
              v_raw_score := v_raw_score * 0.5;
          END IF;

          IF v_topic.is_excluded_from_promotion THEN
              v_raw_score := v_raw_score * 0.3;
          END IF;

          -- Normalize score to 0-1 range (simplified)
          v_normalized_score := LEAST(1.0, v_raw_score / 10.0);

          -- Update topic with new scores
          UPDATE socialcandor_schema.trending_topics
          SET
              raw_trending_score = v_raw_score,
              normalized_trending_score = v_normalized_score,
              score_components = jsonb_build_object(
                  'volume', LOG(GREATEST(v_topic.post_count_1h, 1)),
                  'velocity', v_topic.velocity_1h / 100.0,
                  'acceleration', GREATEST(v_topic.acceleration_1h, 0) / 10.0,
                  'engagement', v_topic.engagement_rate / 100.0,
                  'diversity', v_diversity_penalty,
                  'novelty', v_novelty_boost,
                  'decay', v_decay_factor
              ),
              last_updated_at = CURRENT_TIMESTAMP,
              update_count = update_count + 1,
              updated_at = CURRENT_TIMESTAMP
          WHERE trending_id = p_trending_id;

          RETURN v_normalized_score;

      EXCEPTION
          WHEN OTHERS THEN
              RAISE NOTICE 'Error calculating trending score for %: %', p_trending_id, SQLERRM;
              RETURN 0.0;
      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.calculate_trending_score IS 'Calculates trending score for a topic using volume, velocity, and engagement metrics';

      -- Materialized view for top trending topics
      CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_top_trending_topics AS
      SELECT
          trending_id,
          topic_text,
          topic_type,
          primary_category,
          normalized_trending_score,
          post_count_1h,
          velocity_1h,
          engagement_rate,
          is_sensitive,
          is_excluded_from_promotion,
          last_updated_at,
          ROW_NUMBER() OVER (PARTITION BY primary_category ORDER BY normalized_trending_score DESC) as category_rank,
          ROW_NUMBER() OVER (ORDER BY normalized_trending_score DESC) as global_rank
      FROM socialcandor_schema.trending_topics
      WHERE is_excluded_from_promotion = FALSE
      AND moderation_status = 'APPROVED'
      AND last_updated_at >= CURRENT_TIMESTAMP - INTERVAL '1 hour'
      WITH DATA;

      CREATE UNIQUE INDEX idx_mv_top_trending_topics_id ON socialcandor_schema.mv_top_trending_topics(trending_id);
      CREATE INDEX idx_mv_top_trending_topics_score ON socialcandor_schema.mv_top_trending_topics(normalized_trending_score DESC);
      CREATE INDEX idx_mv_top_trending_topics_category ON socialcandor_schema.mv_top_trending_topics(primary_category, normalized_trending_score DESC);

      -- Trigger for updated_at
      CREATE TRIGGER trg_trending_topics_updated_at
          BEFORE UPDATE ON socialcandor_schema.trending_topics
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

      ------------------------------------------------------------------------------------------------
      -- Table: 99 - notification_types
      -- Description: Notification category taxonomy with default templates
      -- Business Case: Enables consistent notification taxonomy across platforms while
      -- supporting notification grouping strategies to reduce notification fatigue.
      -- Provides localization support and template management for scalable notification systems.
      -- Feature Reference: NTFC03 (Notification Taxonomy), LOC01 (Localization), CONS01 (Consistency)
      ------------------------------------------------------------------------------------------------
      CREATE TABLE IF NOT EXISTS socialcandor_schema.notification_types (
          notification_type_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

          -- Type identification
          type_code VARCHAR(50) NOT NULL UNIQUE,
          type_name VARCHAR(100) NOT NULL,
          category VARCHAR(50) NOT NULL CHECK (
              category IN ('SOCIAL', 'SYSTEM', 'SECURITY', 'MARKETING', 'TRANSACTIONAL', 'PROMOTIONAL', 'REMINDER')
          ),
          subcategory VARCHAR(50),

          -- Priority and importance
          default_priority VARCHAR(20) DEFAULT 'NORMAL' CHECK (
              default_priority IN ('LOW', 'NORMAL', 'HIGH', 'CRITICAL', 'EMERGENCY')
          ),
          importance_level INTEGER DEFAULT 3 CHECK (importance_level >= 1 AND importance_level <= 5),
          is_time_sensitive BOOLEAN DEFAULT FALSE,
          is_action_required BOOLEAN DEFAULT FALSE,

          -- Template configuration
          default_template JSONB NOT NULL DEFAULT '{
              "title": "",
              "body": "",
              "icon": "",
              "color": "",
              "sound": "default"
          }',
          template_variables JSONB DEFAULT '{
              "required": [],
              "optional": []
          }',
          template_versions JSONB DEFAULT '[]',

          -- Localization support
          supported_locales VARCHAR(10)[] DEFAULT '{"en"}',
          locale_templates JSONB DEFAULT '{}',
          auto_translate BOOLEAN DEFAULT TRUE,
          translation_service VARCHAR(50),

          -- Delivery configuration
          default_channels socialcandor_schema.notification_channel[] NOT NULL DEFAULT ARRAY['IN_APP', 'PUSH']::socialcandor_schema.notification_channel[],
          channel_priorities JSONB DEFAULT '{
              "in_app": 1,
              "push": 2,
              "email": 3,
              "sms": 4
          }',
          delivery_strategy VARCHAR(20) DEFAULT 'ALL_CHANNELS' CHECK (
              delivery_strategy IN ('ALL_CHANNELS', 'FIRST_SUCCESS', 'FALLBACK', 'SEQUENTIAL')
          ),

          -- Grouping and batching
          supports_grouping BOOLEAN DEFAULT TRUE,
          grouping_key VARCHAR(100),
          grouping_timeout_seconds INTEGER DEFAULT 300 CHECK (grouping_timeout_seconds >= 0),
          max_group_size INTEGER DEFAULT 10 CHECK (max_group_size >= 1),

          -- Rate limiting
          rate_limit_per_user_per_hour INTEGER DEFAULT 10 CHECK (rate_limit_per_user_per_hour >= 0),
          rate_limit_per_user_per_day INTEGER DEFAULT 50 CHECK (rate_limit_per_user_per_day >= 0),
          burst_limit INTEGER DEFAULT 5 CHECK (burst_limit >= 0),

          -- Expiration and retention
          default_ttl_seconds INTEGER DEFAULT 604800 CHECK (default_ttl_seconds >= 0), -- 7 days
          default_retention_days INTEGER DEFAULT 30 CHECK (default_retention_days >= 0),

          -- Personalization
          supports_personalization BOOLEAN DEFAULT TRUE,
          personalization_rules JSONB DEFAULT '{
              "time_based": true,
              "location_based": false,
              "behavior_based": true,
              "preference_based": true
          }',
          a_b_testing_enabled BOOLEAN DEFAULT FALSE,

          -- Analytics and tracking
          track_delivery BOOLEAN DEFAULT TRUE,
          track_open BOOLEAN DEFAULT TRUE,
          track_click BOOLEAN DEFAULT TRUE,
          track_conversion BOOLEAN DEFAULT FALSE,
          conversion_event VARCHAR(100),

          -- Compliance and privacy
          requires_consent BOOLEAN DEFAULT TRUE,
          consent_type VARCHAR(50) DEFAULT 'IMPLICIT',
          privacy_level VARCHAR(20) DEFAULT 'STANDARD' CHECK (
              privacy_level IN ('PUBLIC', 'STANDARD', 'SENSITIVE', 'CONFIDENTIAL')
          ),
          data_retention_category VARCHAR(50) DEFAULT 'STANDARD',

          -- Approval workflow
          requires_approval BOOLEAN DEFAULT FALSE,
          approval_workflow JSONB DEFAULT '{}',
          last_approved_at TIMESTAMP WITH TIME ZONE,
          approved_by UUID,

          -- Status and lifecycle
          is_active BOOLEAN DEFAULT TRUE,
          is_deprecated BOOLEAN DEFAULT FALSE,
          deprecated_at TIMESTAMP WITH TIME ZONE,
          replacement_type_id UUID,

          -- Audit and metadata
          created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
          created_by UUID NOT NULL,
          updated_by UUID DEFAULT uuid_nil(),

          -- Foreign key constraint
          CONSTRAINT fk_notification_types_replacement FOREIGN KEY (replacement_type_id)
              REFERENCES socialcandor_schema.notification_types(notification_type_id) ON DELETE SET NULL,

          -- Constraints
          CONSTRAINT chk_template_structure CHECK (
              jsonb_typeof(default_template) = 'object' AND
              default_template ? 'title' AND
              default_template ? 'body'
          ),
          CONSTRAINT chk_rate_limits CHECK (
              rate_limit_per_user_per_day >= rate_limit_per_user_per_hour
          )
      );

      COMMENT ON TABLE socialcandor_schema.notification_types IS 'Notification category taxonomy with default templates and delivery configuration';
      COMMENT ON COLUMN socialcandor_schema.notification_types.grouping_timeout_seconds IS 'Time window for grouping similar notifications (0 = no grouping)';

      -- Indexes for notification_types
      CREATE INDEX IF NOT EXISTS idx_notification_types_code ON socialcandor_schema.notification_types(type_code);
      CREATE INDEX IF NOT EXISTS idx_notification_types_category ON socialcandor_schema.notification_types(category);
      CREATE INDEX IF NOT EXISTS idx_notification_types_active ON socialcandor_schema.notification_types(is_active) WHERE is_active = TRUE;
      CREATE INDEX IF NOT EXISTS idx_notification_types_priority ON socialcandor_schema.notification_types(default_priority);
      CREATE INDEX IF NOT EXISTS idx_notification_types_created_at ON socialcandor_schema.notification_types(created_at DESC);

      -- Function to validate notification template
      CREATE OR REPLACE FUNCTION socialcandor_schema.validate_notification_template(p_notification_type_id UUID, p_template JSONB)
      RETURNS TABLE(
          is_valid BOOLEAN,
          validation_errors TEXT[],
          missing_variables TEXT[],
          extra_variables TEXT[]
      ) AS $$
      DECLARE
          v_notification_type RECORD;
          v_required_variables TEXT[];
          v_optional_variables TEXT[];
          v_template_variables TEXT[];
          v_missing_variables TEXT[] := '{}';
          v_extra_variables TEXT[] := '{}';
          v_validation_errors TEXT[] := '{}';
          v_is_valid BOOLEAN := TRUE;
          v_variable TEXT;
      BEGIN
          -- Get notification type details
          SELECT * INTO v_notification_type
          FROM socialcandor_schema.notification_types
          WHERE notification_type_id = p_notification_type_id;

          IF NOT FOUND THEN
              v_validation_errors := array_append(v_validation_errors, 'Notification type not found');
              v_is_valid := FALSE;
              RETURN QUERY SELECT v_is_valid, v_validation_errors, v_missing_variables, v_extra_variables;
              RETURN;
          END IF;

          -- Extract required and optional variables
          v_required_variables := ARRAY(
              SELECT jsonb_array_elements_text(v_notification_type.template_variables->'required')
          );

          v_optional_variables := ARRAY(
              SELECT jsonb_array_elements_text(v_notification_type.template_variables->'optional')
          );

          -- Extract variables from template (simple regex extraction for {{variable}} pattern)
          SELECT ARRAY(
              SELECT DISTINCT m[1]
              FROM regexp_matches(p_template->>'body', '\{\{([^}]+)\}\}', 'g') AS m
          ) INTO v_template_variables;

          -- Check for missing required variables
          FOREACH v_variable IN ARRAY v_required_variables
          LOOP
              IF NOT v_variable = ANY(v_template_variables) THEN
                  v_missing_variables := array_append(v_missing_variables, v_variable);
                  v_is_valid := FALSE;
              END IF;
          END LOOP;

          -- Check for extra variables (not in required or optional)
          FOREACH v_variable IN ARRAY v_template_variables
          LOOP
              IF NOT (v_variable = ANY(v_required_variables) OR v_variable = ANY(v_optional_variables)) THEN
                  v_extra_variables := array_append(v_extra_variables, v_variable);
                  v_is_valid := FALSE;
              END IF;
          END LOOP;

          -- Validate template structure
          IF NOT (p_template ? 'title' AND p_template ? 'body') THEN
              v_validation_errors := array_append(v_validation_errors, 'Template must contain title and body');
              v_is_valid := FALSE;
          END IF;

          IF LENGTH(p_template->>'title') > 200 THEN
              v_validation_errors := array_append(v_validation_errors, 'Title exceeds maximum length of 200 characters');
              v_is_valid := FALSE;
          END IF;

          IF LENGTH(p_template->>'body') > 1000 THEN
              v_validation_errors := array_append(v_validation_errors, 'Body exceeds maximum length of 1000 characters');
              v_is_valid := FALSE;
          END IF;

          RETURN QUERY SELECT v_is_valid, v_validation_errors, v_missing_variables, v_extra_variables;

      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.validate_notification_template IS 'Validates notification template against type requirements and variable definitions';

      -- Trigger for updated_at
      CREATE TRIGGER trg_notification_types_updated_at
          BEFORE UPDATE ON socialcandor_schema.notification_types
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

   ------------------------------------------------------------------------------------------------
-- Table: 100 - user_notifications
-- Description: Delivered notification records with read status tracking
-- Business Case: Provides notification engagement analytics while enabling
-- notification re-engagement campaigns for users with high unread notification counts.
-- Supports comprehensive notification lifecycle management and user behavior analysis.
-- Feature Reference: NTFC04 (Notification Analytics), ENG06 (Engagement Tracking), RET03 (Re-engagement)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.user_notifications (
    user_notification_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    notification_id UUID NOT NULL,
    user_id UUID NOT NULL,

    -- Delivery tracking
    delivery_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (
        delivery_status IN ('PENDING', 'SENT', 'DELIVERED', 'FAILED', 'BOUNCED', 'FILTERED')
    ),
    delivered_at TIMESTAMP WITH TIME ZONE,
    delivery_channel socialcandor_schema.notification_channel NOT NULL,
    delivery_provider VARCHAR(50),
    provider_message_id VARCHAR(255),

    -- Read status
    read_status VARCHAR(20) DEFAULT 'UNREAD' CHECK (
        read_status IN ('UNREAD', 'READ', 'DISMISSED', 'ARCHIVED', 'DELETED')
    ),
    read_at TIMESTAMP WITH TIME ZONE,
    read_duration_seconds INTEGER CHECK (read_duration_seconds >= 0),

    -- Interaction tracking
    clicked BOOLEAN DEFAULT FALSE,
    clicked_at TIMESTAMP WITH TIME ZONE,
    click_location VARCHAR(50),
    action_taken VARCHAR(50),
    action_taken_at TIMESTAMP WITH TIME ZONE,

    -- Device and context
    device_type VARCHAR(50),
    device_id VARCHAR(255),
    app_version VARCHAR(50),
    os_version VARCHAR(50),

    -- Grouping and threading
    group_id UUID,
    thread_id UUID,
    is_grouped BOOLEAN DEFAULT FALSE,
    group_position INTEGER DEFAULT 0 CHECK (group_position >= 0),

    -- Personalization
    personalized_content JSONB DEFAULT '{}',
    personalization_score NUMERIC(5,2) DEFAULT 0.0 CHECK (personalization_score >= 0 AND personalization_score <= 100),

    -- A/B testing
    variant_id UUID,
    variant_name VARCHAR(50),
    is_control_group BOOLEAN DEFAULT FALSE,

    -- Performance metrics
    delivery_latency_ms INTEGER CHECK (delivery_latency_ms >= 0),
    render_time_ms INTEGER CHECK (render_time_ms >= 0),
    network_conditions VARCHAR(20) CHECK (
        network_conditions IN ('EXCELLENT', 'GOOD', 'FAIR', 'POOR', 'OFFLINE')
    ),

    -- Error tracking
    error_occurred BOOLEAN DEFAULT FALSE,
    error_type VARCHAR(50),
    error_message TEXT,
    error_details JSONB DEFAULT '{}',

    -- User feedback
    feedback_rating INTEGER CHECK (feedback_rating >= 1 AND feedback_rating <= 5),
    feedback_comment TEXT,
    feedback_provided_at TIMESTAMP WITH TIME ZONE,

    -- Retention settings
    retention_days INTEGER DEFAULT 90 CHECK (retention_days >= 1 AND retention_days <= 365),
    scheduled_cleanup_at TIMESTAMP WITH TIME ZONE,

    -- Re-engagement tracking
    re_engagement_attempts INTEGER DEFAULT 0 CHECK (re_engagement_attempts >= 0),
    last_re_engagement_at TIMESTAMP WITH TIME ZONE,
    is_re_engagement_eligible BOOLEAN DEFAULT TRUE,

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraints
    CONSTRAINT fk_user_notifications_notification FOREIGN KEY (notification_id)
        REFERENCES socialcandor_schema.notifications(notification_id) ON DELETE CASCADE,
    CONSTRAINT fk_user_notifications_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT chk_delivery_timestamps CHECK (
        (delivered_at IS NULL OR delivered_at >= created_at) AND
        (read_at IS NULL OR read_at >= delivered_at) AND
        (clicked_at IS NULL OR clicked_at >= delivered_at)
    ),
    CONSTRAINT chk_read_duration CHECK (
        (read_duration_seconds IS NULL) OR
        (read_at IS NOT NULL AND read_duration_seconds <= 86400) -- Max 24 hours
    )
);

COMMENT ON TABLE socialcandor_schema.user_notifications IS 'Delivered notification records with comprehensive engagement tracking';
COMMENT ON COLUMN socialcandor_schema.user_notifications.personalization_score IS 'Score indicating how well the notification was personalized for the user';

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_user_notifications_user_id ON socialcandor_schema.user_notifications(user_id);
CREATE INDEX IF NOT EXISTS idx_user_notifications_notification_id ON socialcandor_schema.user_notifications(notification_id);
CREATE INDEX IF NOT EXISTS idx_user_notifications_delivered_at ON socialcandor_schema.user_notifications(delivered_at);
CREATE INDEX IF NOT EXISTS idx_user_notifications_read_status ON socialcandor_schema.user_notifications(read_status);
CREATE INDEX IF NOT EXISTS idx_user_notifications_scheduled_cleanup ON socialcandor_schema.user_notifications(scheduled_cleanup_at) WHERE scheduled_cleanup_at IS NOT NULL;

-- Create trigger to update updated_at timestamp
CREATE OR REPLACE FUNCTION socialcandor_schema.update_user_notifications_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_user_notifications_update_timestamp
    BEFORE UPDATE ON socialcandor_schema.user_notifications
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_user_notifications_updated_at();

-- Create trigger to calculate and set scheduled_cleanup_at
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_user_notifications_cleanup_date()
RETURNS TRIGGER AS $$
BEGIN
    -- Calculate scheduled_cleanup_at based on delivered_at or created_at
    NEW.scheduled_cleanup_at = COALESCE(NEW.delivered_at, NEW.created_at) + 
                               (NEW.retention_days * INTERVAL '1 day');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_user_notifications_calculate_cleanup
    BEFORE INSERT OR UPDATE OF delivered_at, retention_days ON socialcandor_schema.user_notifications
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.calculate_user_notifications_cleanup_date();

-- Create view for notifications eligible for cleanup
CREATE OR REPLACE VIEW socialcandor_schema.user_notifications_cleanup_candidates AS
SELECT 
    user_notification_id,
    user_id,
    notification_id,
    delivered_at,
    created_at,
    retention_days,
    scheduled_cleanup_at,
    CASE 
        WHEN scheduled_cleanup_at <= CURRENT_TIMESTAMP THEN 'READY_FOR_CLEANUP'
        ELSE 'PENDING'
    END as cleanup_status
FROM socialcandor_schema.user_notifications
WHERE scheduled_cleanup_at IS NOT NULL;

-- Function to perform cleanup of old notifications (fixed version)
CREATE OR REPLACE FUNCTION socialcandor_schema.cleanup_old_user_notifications(
    p_batch_size INTEGER DEFAULT 1000
)
RETURNS INTEGER AS $$
DECLARE
    v_deleted_count INTEGER := 0;
    v_row RECORD;
BEGIN
    -- Alternative approach using a loop with DELETE using WHERE IN
    FOR v_row IN (
        SELECT user_notification_id 
        FROM socialcandor_schema.user_notifications 
        WHERE scheduled_cleanup_at <= CURRENT_TIMESTAMP
        LIMIT p_batch_size
    ) LOOP
        DELETE FROM socialcandor_schema.user_notifications 
        WHERE user_notification_id = v_row.user_notification_id;
        v_deleted_count := v_deleted_count + 1;
    END LOOP;
    
    RETURN v_deleted_count;
END;
$$ LANGUAGE plpgsql;

-- Alternative: More efficient batch cleanup function using DELETE with subquery
CREATE OR REPLACE FUNCTION socialcandor_schema.bulk_cleanup_old_user_notifications(
    p_batch_size INTEGER DEFAULT 1000
)
RETURNS INTEGER AS $$
DECLARE
    v_deleted_count INTEGER;
BEGIN
    -- Use DELETE with RETURNING to get the count in one operation
    WITH delete_cte AS (
        DELETE FROM socialcandor_schema.user_notifications 
        WHERE user_notification_id IN (
            SELECT user_notification_id 
            FROM socialcandor_schema.user_notifications 
            WHERE scheduled_cleanup_at <= CURRENT_TIMESTAMP
            ORDER BY scheduled_cleanup_at  -- Optional: delete oldest first
            LIMIT p_batch_size
        )
        RETURNING 1
    )
    SELECT COUNT(*) INTO v_deleted_count FROM delete_cte;
    
    RETURN v_deleted_count;
END;
$$ LANGUAGE plpgsql;

-- Create index to support the cleanup queries
CREATE INDEX IF NOT EXISTS idx_user_notifications_cleanup 
    ON socialcandor_schema.user_notifications(scheduled_cleanup_at) 
    WHERE scheduled_cleanup_at IS NOT NULL;

      -- Indexes for user_notifications
      CREATE INDEX IF NOT EXISTS idx_user_notifications_user ON socialcandor_schema.user_notifications(user_id);
      CREATE INDEX IF NOT EXISTS idx_user_notifications_notification ON socialcandor_schema.user_notifications(notification_id);
      CREATE INDEX IF NOT EXISTS idx_user_notifications_delivery_status ON socialcandor_schema.user_notifications(delivery_status);
      CREATE INDEX IF NOT EXISTS idx_user_notifications_read_status ON socialcandor_schema.user_notifications(read_status);
      CREATE INDEX IF NOT EXISTS idx_user_notifications_delivered_at ON socialcandor_schema.user_notifications(delivered_at DESC);
      CREATE INDEX IF NOT EXISTS idx_user_notifications_channel ON socialcandor_schema.user_notifications(delivery_channel);
      CREATE INDEX IF NOT EXISTS idx_user_notifications_group ON socialcandor_schema.user_notifications(group_id) WHERE group_id IS NOT NULL;
--       CREATE INDEX IF NOT EXISTS idx_user_notifications_cleanup ON socialcandor_schema.user_notifications(scheduled_cleanup_at) WHERE scheduled_cleanup_at <= CURRENT_TIMESTAMP + INTERVAL '7 days';
      CREATE INDEX IF NOT EXISTS idx_user_notifications_composite ON socialcandor_schema.user_notifications(user_id, delivered_at DESC, read_status);

      -- Materialized view for user notification analytics
      CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_user_notification_analytics AS
      SELECT
          user_id,
          COUNT(*) as total_notifications,
          COUNT(*) FILTER (WHERE delivery_status = 'DELIVERED') as delivered_count,
          COUNT(*) FILTER (WHERE read_status = 'READ') as read_count,
          COUNT(*) FILTER (WHERE clicked = TRUE) as clicked_count,
          AVG(read_duration_seconds) FILTER (WHERE read_duration_seconds > 0) as avg_read_duration,
          COUNT(*) FILTER (WHERE delivered_at >= CURRENT_TIMESTAMP - INTERVAL '24 hours') as notifications_24h,
          COUNT(*) FILTER (WHERE delivered_at >= CURRENT_TIMESTAMP - INTERVAL '24 hours' AND read_status = 'UNREAD') as unread_24h,
          MAX(delivered_at) as last_notification_at,
          ROUND(
              COUNT(*) FILTER (WHERE read_status = 'READ')::NUMERIC /
              NULLIF(COUNT(*) FILTER (WHERE delivery_status = 'DELIVERED'), 0) * 100,
              2
          ) as read_rate_percentage
      FROM socialcandor_schema.user_notifications
      WHERE delivered_at >= CURRENT_TIMESTAMP - INTERVAL '30 days'
      GROUP BY user_id
      WITH DATA;

      CREATE UNIQUE INDEX idx_mv_user_notification_analytics_user ON socialcandor_schema.mv_user_notification_analytics(user_id);
      CREATE INDEX idx_mv_user_notification_analytics_read_rate ON socialcandor_schema.mv_user_notification_analytics(read_rate_percentage DESC);

      -- Function to clean up old notifications
      CREATE OR REPLACE FUNCTION socialcandor_schema.cleanup_old_notifications()
      RETURNS INTEGER AS $$
      DECLARE
          v_deleted_count INTEGER := 0;
      BEGIN
          -- Delete notifications scheduled for cleanup
          WITH deleted AS (
              DELETE FROM socialcandor_schema.user_notifications
              WHERE scheduled_cleanup_at <= CURRENT_TIMESTAMP
              RETURNING user_notification_id
          )
          SELECT COUNT(*) INTO v_deleted_count FROM deleted;

          -- Also clean up orphaned notifications (without parent)
          DELETE FROM socialcandor_schema.user_notifications un
          WHERE NOT EXISTS (
              SELECT 1 FROM socialcandor_schema.notifications n
              WHERE n.notification_id = un.notification_id
          );

          RETURN v_deleted_count;

      EXCEPTION
          WHEN OTHERS THEN
              RAISE NOTICE 'Error cleaning up notifications: %', SQLERRM;
              RETURN -1;
      END;
      $$ LANGUAGE plpgsql;

      COMMENT ON FUNCTION socialcandor_schema.cleanup_old_notifications IS 'Cleans up old notifications based on retention policy';

      -- Trigger for updated_at
      CREATE TRIGGER trg_user_notifications_updated_at
          BEFORE UPDATE ON socialcandor_schema.user_notifications
          FOR EACH ROW
          EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    

    ------------------------------------------------------------------------------------------------
-- Table: 101 - relationship_graph
-- Description: Optimized graph storage for relationship analytics
-- Business Case: Powers graph algorithms (shortest path, community detection) for
-- "degrees of separation" features while enabling influence scoring through eigenvector
-- centrality calculations. Supports advanced social network analysis and recommendation systems.
-- Feature Reference: NET03 (Graph Analytics), REC03 (Social Recommendations), INF01 (Influence Scoring)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.relationship_graph (
    relationship_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    source_user_id UUID NOT NULL,
    target_user_id UUID NOT NULL,

    -- Relationship types
    relationship_types socialcandor_schema.relationship_type[] NOT NULL DEFAULT ARRAY['FRIEND']::socialcandor_schema.relationship_type[],
    primary_relationship_type socialcandor_schema.relationship_type NOT NULL DEFAULT 'FRIEND',

    -- Graph properties
    relationship_strength NUMERIC(5,2) NOT NULL DEFAULT 50.0 CHECK (relationship_strength >= 0 AND relationship_strength <= 100),
    weight NUMERIC(10,6) DEFAULT 1.0 CHECK (weight > 0),
    directionality VARCHAR(10) DEFAULT 'BIDIRECTIONAL' CHECK (
        directionality IN ('UNIDIRECTIONAL', 'BIDIRECTIONAL', 'MUTUAL')
    ),

    -- Temporal properties
    established_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_interaction_at TIMESTAMP WITH TIME ZONE,
    -- REMOVED: relationship_age_days INTEGER GENERATED ALWAYS AS (EXTRACT(DAY FROM (CURRENT_TIMESTAMP - established_at))) STORED,
    -- Replaced with regular column that will be updated via trigger
    relationship_age_days INTEGER DEFAULT 0,

    -- Interaction metrics
    interaction_frequency INTEGER DEFAULT 0 CHECK (interaction_frequency >= 0),
    interaction_intensity NUMERIC(5,2) DEFAULT 0.0 CHECK (interaction_intensity >= 0),
    last_interaction_type VARCHAR(50),

    -- Content sharing metrics
    shared_content_count INTEGER DEFAULT 0 CHECK (shared_content_count >= 0),
    mutual_interests_count INTEGER DEFAULT 0 CHECK (mutual_interests_count >= 0),
    common_groups_count INTEGER DEFAULT 0 CHECK (common_groups_count >= 0),

    -- Graph algorithm scores
    centrality_score NUMERIC(10,6) DEFAULT 0.0,
    betweenness_score NUMERIC(10,6) DEFAULT 0.0,
    closeness_score NUMERIC(10,6) DEFAULT 0.0,
    eigenvector_score NUMERIC(10,6) DEFAULT 0.0,

    -- Community detection
    community_id INTEGER,
    modularity_class INTEGER,
    cluster_coefficient NUMERIC(5,4) DEFAULT 0.0 CHECK (cluster_coefficient >= 0 AND cluster_coefficient <= 1),

    -- Relationship quality
    trust_score NUMERIC(5,2) DEFAULT 50.0 CHECK (trust_score >= 0 AND trust_score <= 100),
    sentiment_score NUMERIC(5,2) DEFAULT 0.0 CHECK (sentiment_score >= -1 AND sentiment_score <= 1),
    reciprocity_score NUMERIC(5,2) DEFAULT 0.0 CHECK (reciprocity_score >= 0 AND reciprocity_score <= 1),

    -- Status flags
    is_active BOOLEAN DEFAULT TRUE,
    is_hidden BOOLEAN DEFAULT FALSE,
    is_verified BOOLEAN DEFAULT FALSE,

    -- Metadata
    tags VARCHAR(50)[] DEFAULT '{}',
    context JSONB DEFAULT '{}',

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    last_calculated_at TIMESTAMP WITH TIME ZONE,

    -- Foreign key constraints
    CONSTRAINT fk_relationship_graph_source FOREIGN KEY (source_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_relationship_graph_target FOREIGN KEY (target_user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT uk_relationship_direction UNIQUE (source_user_id, target_user_id, primary_relationship_type),
    CONSTRAINT chk_relationship_not_self CHECK (source_user_id != target_user_id)
);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_relationship_graph_source ON socialcandor_schema.relationship_graph(source_user_id);
CREATE INDEX IF NOT EXISTS idx_relationship_graph_target ON socialcandor_schema.relationship_graph(target_user_id);
CREATE INDEX IF NOT EXISTS idx_relationship_graph_bidirectional ON socialcandor_schema.relationship_graph(source_user_id, target_user_id);
CREATE INDEX IF NOT EXISTS idx_relationship_graph_primary_type ON socialcandor_schema.relationship_graph(primary_relationship_type);
CREATE INDEX IF NOT EXISTS idx_relationship_graph_community ON socialcandor_schema.relationship_graph(community_id);
CREATE INDEX IF NOT EXISTS idx_relationship_graph_centrality ON socialcandor_schema.relationship_graph(centrality_score DESC);
CREATE INDEX IF NOT EXISTS idx_relationship_graph_strength ON socialcandor_schema.relationship_graph(relationship_strength DESC);
CREATE INDEX IF NOT EXISTS idx_relationship_graph_established ON socialcandor_schema.relationship_graph(established_at DESC);
CREATE INDEX IF NOT EXISTS idx_relationship_graph_active ON socialcandor_schema.relationship_graph(is_active) WHERE is_active = TRUE;

-- Create a function to calculate relationship age
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_relationship_age(established_date TIMESTAMP WITH TIME ZONE)
RETURNS INTEGER AS $$
BEGIN
    RETURN EXTRACT(DAY FROM (CURRENT_TIMESTAMP - established_date));
END;
$$ LANGUAGE plpgsql;

-- Create a function to update relationship_age_days and updated_at
CREATE OR REPLACE FUNCTION socialcandor_schema.update_relationship_graph_timestamps()
RETURNS TRIGGER AS $$
BEGIN
    -- Update relationship_age_days based on established_at
    NEW.relationship_age_days := EXTRACT(DAY FROM (CURRENT_TIMESTAMP - NEW.established_at));
    
    -- Always update the updated_at timestamp
    NEW.updated_at := CURRENT_TIMESTAMP;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger to automatically update timestamps and calculate age
CREATE OR REPLACE TRIGGER trg_update_relationship_graph_timestamps
BEFORE INSERT OR UPDATE ON socialcandor_schema.relationship_graph
FOR EACH ROW
EXECUTE FUNCTION socialcandor_schema.update_relationship_graph_timestamps();

-- Create a materialized view for frequently accessed relationship metrics
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.relationship_graph_metrics AS
SELECT 
    relationship_id,
    source_user_id,
    target_user_id,
    primary_relationship_type,
    relationship_strength,
    weight,
    EXTRACT(DAY FROM (CURRENT_TIMESTAMP - established_at)) as current_relationship_age_days,
    interaction_frequency,
    centrality_score,
    betweenness_score,
    closeness_score,
    eigenvector_score,
    community_id,
    trust_score,
    is_active,
    created_at,
    updated_at
FROM socialcandor_schema.relationship_graph
WHERE is_active = TRUE;

-- Create index on the materialized view for performance
CREATE INDEX IF NOT EXISTS idx_relationship_metrics_source ON socialcandor_schema.relationship_graph_metrics(source_user_id);
CREATE INDEX IF NOT EXISTS idx_relationship_metrics_target ON socialcandor_schema.relationship_graph_metrics(target_user_id);
CREATE INDEX IF NOT EXISTS idx_relationship_metrics_centrality ON socialcandor_schema.relationship_graph_metrics(eigenvector_score DESC);

-- Create a function to refresh relationship age for batch processing
CREATE OR REPLACE FUNCTION socialcandor_schema.refresh_relationship_ages()
RETURNS INTEGER AS $$
DECLARE
    rows_updated INTEGER;
BEGIN
    UPDATE socialcandor_schema.relationship_graph
    SET relationship_age_days = EXTRACT(DAY FROM (CURRENT_TIMESTAMP - established_at)),
        updated_at = CURRENT_TIMESTAMP
    WHERE is_active = TRUE;
    
    GET DIAGNOSTICS rows_updated = ROW_COUNT;
    RETURN rows_updated;
END;
$$ LANGUAGE plpgsql;

-- Create a function to get relationship age on demand (for queries)
CREATE OR REPLACE FUNCTION socialcandor_schema.get_relationship_age(rel_id UUID)
RETURNS INTEGER AS $$
DECLARE
    age_days INTEGER;
BEGIN
    SELECT EXTRACT(DAY FROM (CURRENT_TIMESTAMP - established_at))
    INTO age_days
    FROM socialcandor_schema.relationship_graph
    WHERE relationship_id = rel_id;
    
    RETURN COALESCE(age_days, 0);
END;
$$ LANGUAGE plpgsql;

-- Create a view for relationship analytics
CREATE OR REPLACE VIEW socialcandor_schema.relationship_analytics AS
SELECT 
    rg.relationship_id,
    rg.source_user_id,
    rg.target_user_id,
    rg.primary_relationship_type,
    rg.relationship_strength,
    rg.weight,
    EXTRACT(DAY FROM (CURRENT_TIMESTAMP - rg.established_at)) as relationship_age_days,
    rg.interaction_frequency,
    rg.centrality_score,
    rg.betweenness_score,
    rg.closeness_score,
    rg.eigenvector_score,
    rg.community_id,
    rg.trust_score,
    rg.is_active,
    -- Calculate derived metrics
    (rg.relationship_strength * 0.3 + rg.trust_score * 0.3 + (rg.interaction_frequency::NUMERIC / 100) * 0.4) as relationship_health_score,
    CASE 
        WHEN EXTRACT(DAY FROM (CURRENT_TIMESTAMP - rg.established_at)) > 365 THEN 'LONG_TERM'
        WHEN EXTRACT(DAY FROM (CURRENT_TIMESTAMP - rg.established_at)) > 90 THEN 'MEDIUM_TERM'
        ELSE 'NEW'
    END as relationship_duration_category
FROM socialcandor_schema.relationship_graph rg
WHERE rg.is_active = TRUE;

-- Create a function to find relationships by strength threshold
CREATE OR REPLACE FUNCTION socialcandor_schema.get_relationships_by_strength(
    min_strength NUMERIC DEFAULT 50.0,
    max_strength NUMERIC DEFAULT 100.0
)
RETURNS TABLE(
    relationship_id UUID,
    source_user_id UUID,
    target_user_id UUID,
    relationship_strength NUMERIC,
    relationship_type socialcandor_schema.relationship_type,
    relationship_age_days INTEGER
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        rg.relationship_id,
        rg.source_user_id,
        rg.target_user_id,
        rg.relationship_strength,
        rg.primary_relationship_type,
        EXTRACT(DAY FROM (CURRENT_TIMESTAMP - rg.established_at))::INTEGER
    FROM socialcandor_schema.relationship_graph rg
    WHERE rg.is_active = TRUE
        AND rg.relationship_strength BETWEEN min_strength AND max_strength
    ORDER BY rg.relationship_strength DESC;
END;
$$ LANGUAGE plpgsql;

 

    ------------------------------------------------------------------------------------------------
    -- Table: 102 - shortest_path_cache
    -- Description: Precomputed social graph distances for performance
    -- Business Case: Accelerates "How do you know X?" features while reducing graph traversal
    -- costs during feed generation for distant connections' content. Supports efficient
    -- social discovery and network analysis queries.
    -- Feature Reference: NET04 (Path Analysis), PERF06 (Query Optimization), DIS01 (Social Discovery)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.shortest_path_cache (
        path_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        source_user_id UUID NOT NULL,
        target_user_id UUID NOT NULL,

        -- Path information
        shortest_path_length INTEGER NOT NULL CHECK (shortest_path_length >= 1 AND shortest_path_length <= 6),
        path_nodes UUID[] NOT NULL,
        path_edges UUID[] NOT NULL,
        path_strength NUMERIC(5,2) DEFAULT 0.0 CHECK (path_strength >= 0 AND path_strength <= 100),

        -- Path metrics
        total_relationship_strength NUMERIC(10,6) DEFAULT 0.0,
        average_relationship_strength NUMERIC(10,6) DEFAULT 0.0,
        min_relationship_strength NUMERIC(10,6) DEFAULT 0.0,
        max_relationship_strength NUMERIC(10,6) DEFAULT 0.0,

        -- Connection types
        connection_types socialcandor_schema.relationship_type[] DEFAULT '{}',
        primary_connection_type socialcandor_schema.relationship_type,

        -- Common properties
        mutual_friends_count INTEGER DEFAULT 0 CHECK (mutual_friends_count >= 0),
        mutual_groups_count INTEGER DEFAULT 0 CHECK (mutual_groups_count >= 0),
        mutual_interests_count INTEGER DEFAULT 0 CHECK (mutual_interests_count >= 0),

        -- Temporal properties
        last_updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        next_update_due TIMESTAMP WITH TIME ZONE,

        -- Algorithm metadata
        algorithm_used VARCHAR(50) DEFAULT 'BFS' CHECK (
            algorithm_used IN ('BFS', 'DIJKSTRA', 'A_STAR', 'FLOYD_WARSHALL', 'JOHNSON')
        ),
        calculation_time_ms INTEGER CHECK (calculation_time_ms >= 0),
        cache_hits INTEGER DEFAULT 0 CHECK (cache_hits >= 0),

        -- Status flags
        is_valid BOOLEAN DEFAULT TRUE,
        needs_recalculation BOOLEAN DEFAULT FALSE,
        is_direct_connection BOOLEAN GENERATED ALWAYS AS (shortest_path_length = 1) STORED,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_shortest_path_cache_source FOREIGN KEY (source_user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_shortest_path_cache_target FOREIGN KEY (target_user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_shortest_path_direction UNIQUE (source_user_id, target_user_id),
        CONSTRAINT chk_path_length_valid CHECK (
            shortest_path_length = CARDINALITY(path_nodes) - 1
        ),
        CONSTRAINT chk_path_edges_count CHECK (
            CARDINALITY(path_edges) = shortest_path_length
        ),
        CONSTRAINT chk_nodes_edges_alignment CHECK (
            CARDINALITY(path_nodes) = CARDINALITY(path_edges) + 1
        )
    );

    COMMENT ON TABLE socialcandor_schema.shortest_path_cache IS 'Precomputed social graph distances for performance optimization';
    COMMENT ON COLUMN socialcandor_schema.shortest_path_cache.path_strength IS 'Composite strength score of the entire connection path';

    -- Indexes for shortest_path_cache
    CREATE INDEX IF NOT EXISTS idx_shortest_path_cache_source ON socialcandor_schema.shortest_path_cache(source_user_id);
    CREATE INDEX IF NOT EXISTS idx_shortest_path_cache_target ON socialcandor_schema.shortest_path_cache(target_user_id);
    CREATE INDEX IF NOT EXISTS idx_shortest_path_cache_length ON socialcandor_schema.shortest_path_cache(shortest_path_length);
    CREATE INDEX IF NOT EXISTS idx_shortest_path_cache_strength ON socialcandor_schema.shortest_path_cache(path_strength DESC);
    CREATE INDEX IF NOT EXISTS idx_shortest_path_cache_valid ON socialcandor_schema.shortest_path_cache(is_valid) WHERE is_valid = TRUE;
    CREATE INDEX IF NOT EXISTS idx_shortest_path_cache_update ON socialcandor_schema.shortest_path_cache(next_update_due) WHERE needs_recalculation = TRUE;

    -- Composite index for common queries
    CREATE INDEX IF NOT EXISTS idx_shortest_path_cache_composite ON socialcandor_schema.shortest_path_cache
    (source_user_id, shortest_path_length, path_strength DESC)
    WHERE is_valid = TRUE;

    -- Trigger for updated_at
    CREATE TRIGGER trg_shortest_path_cache_updated_at
        BEFORE UPDATE ON socialcandor_schema.shortest_path_cache
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

  ------------------------------------------------------------------------------------------------
    -- Table: 103 - blockchain_identity
    -- Description: Web3 identity verification through wallet address binding
    -- Business Case: Enables NFT-gated content and crypto-native features while providing
    -- Sybil resistance through blockchain-verified identity without exposing private keys.
    -- Supports decentralized identity verification and cross-platform authentication.
    -- Feature Reference: WEB3_01 (Blockchain Integration), VER02 (Decentralized Identity), SEC05 (Sybil Resistance)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.blockchain_identity (
        blockchain_identity_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        user_id UUID NOT NULL,

        -- Blockchain information
        blockchain_network VARCHAR(50) NOT NULL CHECK (
            blockchain_network IN ('ETHEREUM', 'POLYGON', 'SOLANA', 'ARBITRUM', 'OPTIMISM', 'AVALANCHE', 'BNB_CHAIN')
        ),
        wallet_address VARCHAR(255) NOT NULL,
        wallet_type VARCHAR(50) CHECK (
            wallet_type IN ('EOA', 'CONTRACT', 'MULTISIG', 'CUSTODIAL', 'HARDWARE')
        ),

        -- Verification status
        verification_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
            verification_status IN ('PENDING', 'VERIFIED', 'FAILED', 'REVOKED', 'EXPIRED')
        ),
        verification_method VARCHAR(50) DEFAULT 'SIGNATURE' CHECK (
            verification_method IN ('SIGNATURE', 'TRANSACTION', 'DELEGATE', 'CUSTODIAL')
        ),
        verified_at TIMESTAMP WITH TIME ZONE,
        verification_expires_at TIMESTAMP WITH TIME ZONE,

        -- Wallet metrics
        wallet_age_days INTEGER,
        total_transaction_count INTEGER DEFAULT 0 CHECK (total_transaction_count >= 0),
        total_volume_eth NUMERIC(30,18) DEFAULT 0 CHECK (total_volume_eth >= 0),
        last_transaction_at TIMESTAMP WITH TIME ZONE,

        -- NFT and token holdings
        nft_count INTEGER DEFAULT 0 CHECK (nft_count >= 0),
        token_holdings JSONB DEFAULT '{}',
        nft_collections JSONB DEFAULT '{}',

        -- Decentralized identity
        decentralized_identifier VARCHAR(255),
        verifiable_credentials JSONB DEFAULT '[]',
        identity_attestations JSONB DEFAULT '[]',

        -- Security features
        nonce VARCHAR(100),
        signature_hash VARCHAR(255),
        signature_timestamp TIMESTAMP WITH TIME ZONE,
        is_primary_wallet BOOLEAN DEFAULT FALSE,

        -- Risk assessment
        risk_score NUMERIC(5,2) DEFAULT 50.0 CHECK (risk_score >= 0 AND risk_score <= 100),
        sybil_resistance_score NUMERIC(5,2) DEFAULT 0.0 CHECK (sybil_resistance_score >= 0 AND sybil_resistance_score <= 100),
        wallet_reputation_score NUMERIC(5,2) DEFAULT 0.0 CHECK (wallet_reputation_score >= 0 AND wallet_reputation_score <= 100),

        -- Integration metadata
        connected_apps JSONB DEFAULT '[]',
        web3_social_links JSONB DEFAULT '{}',
        ens_domain VARCHAR(255),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_blockchain_identity_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_wallet_network UNIQUE (wallet_address, blockchain_network),
        CONSTRAINT chk_wallet_address_format CHECK (
            wallet_address ~ '^0x[a-fA-F0-9]{40}$' OR
            wallet_address ~ '^[1-9A-HJ-NP-Za-km-z]{32,44}$' -- Solana address pattern
        ),
        CONSTRAINT chk_verification_expiry CHECK (
            verification_expires_at IS NULL OR
            verification_expires_at > verified_at
        )
    );

    COMMENT ON TABLE socialcandor_schema.blockchain_identity IS 'Web3 identity verification through wallet address binding and Sybil resistance';
    COMMENT ON COLUMN socialcandor_schema.blockchain_identity.sybil_resistance_score IS 'Score measuring resistance to Sybil attacks based on on-chain behavior';
    
    -- Create a partial unique index to enforce one primary wallet per user
    -- This replaces the CONSTRAINT uk_user_primary_wallet that had a WHERE clause
    CREATE UNIQUE INDEX IF NOT EXISTS idx_unique_primary_wallet 
    ON socialcandor_schema.blockchain_identity (user_id) 
    WHERE is_primary_wallet = TRUE;

    -- Indexes for blockchain_identity
    CREATE INDEX IF NOT EXISTS idx_blockchain_identity_user ON socialcandor_schema.blockchain_identity(user_id);
    CREATE INDEX IF NOT EXISTS idx_blockchain_identity_wallet ON socialcandor_schema.blockchain_identity(wallet_address);
    CREATE INDEX IF NOT EXISTS idx_blockchain_identity_network ON socialcandor_schema.blockchain_identity(blockchain_network);
    CREATE INDEX IF NOT EXISTS idx_blockchain_identity_verification ON socialcandor_schema.blockchain_identity(verification_status);
    CREATE INDEX IF NOT EXISTS idx_blockchain_identity_primary ON socialcandor_schema.blockchain_identity(is_primary_wallet) WHERE is_primary_wallet = TRUE;
    CREATE INDEX IF NOT EXISTS idx_blockchain_identity_reputation ON socialcandor_schema.blockchain_identity(wallet_reputation_score DESC);
    CREATE INDEX IF NOT EXISTS idx_blockchain_identity_nft_count ON socialcandor_schema.blockchain_identity(nft_count DESC);

    -- Trigger for updated_at
    CREATE TRIGGER trg_blockchain_identity_updated_at
        BEFORE UPDATE ON socialcandor_schema.blockchain_identity
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 104 - content_moderation
    -- Description: AI-powered content safety scoring with toxicity/sentiment metrics
    -- Business Case: Reduces human moderator workload through pre-screening while maintaining
    -- transparency through appeal processes for AI-flagged content. Enables proactive
    -- content safety management at scale with continuous model improvement.
    -- Feature Reference: MOD04 (AI Moderation), SAF02 (Content Safety), ML01 (Machine Learning)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.content_moderation (
        moderation_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Content reference
        content_type VARCHAR(50) NOT NULL CHECK (
            content_type IN ('POST', 'COMMENT', 'MESSAGE', 'PROFILE', 'MEDIA', 'GROUP', 'PAGE')
        ),
        content_id UUID NOT NULL,
        content_owner_id UUID NOT NULL,

        -- AI scoring
        toxicity_score NUMERIC(5,2) DEFAULT 0.0 CHECK (toxicity_score >= 0 AND toxicity_score <= 100),
        sentiment_score NUMERIC(5,2) DEFAULT 0.0 CHECK (sentiment_score >= -1 AND sentiment_score <= 1),
        severity_level socialcandor_schema.moderation_severity DEFAULT 'LOW',

        -- Category classification
        violation_categories VARCHAR(50)[] DEFAULT '{}',
        primary_violation_category VARCHAR(50),
        confidence_score NUMERIC(5,2) DEFAULT 0.0 CHECK (confidence_score >= 0 AND confidence_score <= 100),

        -- Moderation actions
        moderation_status VARCHAR(20) DEFAULT 'PENDING_REVIEW' CHECK (
            moderation_status IN ('PENDING_REVIEW', 'AUTO_APPROVED', 'AUTO_REJECTED', 'HUMAN_REVIEWED', 'APPEALED', 'OVERRIDDEN')
        ),
        automated_action VARCHAR(50),
        human_reviewer_id UUID,
        reviewed_at TIMESTAMP WITH TIME ZONE,

        -- Content analysis
        language_code VARCHAR(10),
        text_content TEXT,
        media_analysis JSONB DEFAULT '{}',
        contextual_analysis JSONB DEFAULT '{}',

        -- Model metadata
        model_version VARCHAR(50) NOT NULL,
        model_type VARCHAR(50) CHECK (
            model_type IN ('TOXICITY', 'SENTIMENT', 'NSFW', 'SPAM', 'MULTIMODAL', 'ENSEMBLE')
        ),
        inference_time_ms INTEGER CHECK (inference_time_ms >= 0),

        -- Appeal process
        appeal_status VARCHAR(20) DEFAULT 'NONE' CHECK (
            appeal_status IN ('NONE', 'REQUESTED', 'UNDER_REVIEW', 'GRANTED', 'DENIED')
        ),
        appealed_at TIMESTAMP WITH TIME ZONE,
        appeal_reviewer_id UUID,
        appeal_reviewed_at TIMESTAMP WITH TIME ZONE,
        appeal_decision_reason TEXT,

        -- Feedback loop
        human_feedback VARCHAR(20) CHECK (
            human_feedback IN ('CORRECT', 'FALSE_POSITIVE', 'FALSE_NEGATIVE', 'INCONCLUSIVE')
        ),
        feedback_confidence NUMERIC(5,2) CHECK (feedback_confidence >= 0 AND feedback_confidence <= 100),
        model_retraining_flag BOOLEAN DEFAULT FALSE,

        -- Performance metrics
        precision_score NUMERIC(5,4) CHECK (precision_score >= 0 AND precision_score <= 1),
        recall_score NUMERIC(5,4) CHECK (recall_score >= 0 AND recall_score <= 1),
        f1_score NUMERIC(5,4) CHECK (f1_score >= 0 AND f1_score <= 1),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_content_moderation_owner FOREIGN KEY (content_owner_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_content_moderation_reviewer FOREIGN KEY (human_reviewer_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
        CONSTRAINT fk_content_moderation_appeal_reviewer FOREIGN KEY (appeal_reviewer_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT uk_content_moderation UNIQUE (content_type, content_id),
        CONSTRAINT chk_confidence_threshold CHECK (
            (automated_action IS NULL AND moderation_status != 'AUTO_REJECTED') OR
            confidence_score >= 80
        ),
        CONSTRAINT chk_appeal_timestamps CHECK (
            (appealed_at IS NULL) OR
            (appealed_at >= created_at AND (appeal_reviewed_at IS NULL OR appeal_reviewed_at >= appealed_at))
        )
    );

    COMMENT ON TABLE socialcandor_schema.content_moderation IS 'AI-powered content safety scoring with toxicity/sentiment metrics and appeal process';
    COMMENT ON COLUMN socialcandor_schema.content_moderation.model_retraining_flag IS 'Flag indicating this case should be used for model retraining';

    -- Indexes for content_moderation
    CREATE INDEX IF NOT EXISTS idx_content_moderation_content ON socialcandor_schema.content_moderation(content_type, content_id);
    CREATE INDEX IF NOT EXISTS idx_content_moderation_owner ON socialcandor_schema.content_moderation(content_owner_id);
    CREATE INDEX IF NOT EXISTS idx_content_moderation_toxicity ON socialcandor_schema.content_moderation(toxicity_score DESC);
    CREATE INDEX IF NOT EXISTS idx_content_moderation_status ON socialcandor_schema.content_moderation(moderation_status);
    CREATE INDEX IF NOT EXISTS idx_content_moderation_severity ON socialcandor_schema.content_moderation(severity_level);
    CREATE INDEX IF NOT EXISTS idx_content_moderation_appeal ON socialcandor_schema.content_moderation(appeal_status);
    CREATE INDEX IF NOT EXISTS idx_content_moderation_created ON socialcandor_schema.content_moderation(created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_content_moderation_feedback ON socialcandor_schema.content_moderation(human_feedback) WHERE human_feedback IS NOT NULL;

    -- Trigger for updated_at
    CREATE TRIGGER trg_content_moderation_updated_at
        BEFORE UPDATE ON socialcandor_schema.content_moderation
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();



-- Create uuid_nil() function if not exists
CREATE OR REPLACE FUNCTION socialcandor_schema.uuid_nil()
RETURNS UUID AS $$
BEGIN
    RETURN '00000000-0000-0000-0000-000000000000'::UUID;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

------------------------------------------------------------------------------------------------
-- Enum: content_type
-- Description: Defines types of user-generated content
-- Business Case: Enables type-specific processing and rendering
-- Feature Reference: CNT01 (Content Management), MED01 (Media Processing)
------------------------------------------------------------------------------------------------
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_type 
        WHERE typname = 'content_type' 
        AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'socialcandor_schema')
    ) THEN
        CREATE TYPE socialcandor_schema.content_type AS ENUM (
            'TEXT',                    -- Text-only content
            'IMAGE',                   -- Image post
            'VIDEO',                   -- Video content
            'LINK',                    -- Shared link
            'POLL',                    -- Interactive poll
            'EVENT',                   -- Event announcement
            'LIVE',                    -- Live stream
            'AUDIO',                   -- Audio content
            'STORY',                   -- Ephemeral content (24h)
            'REEL',                    -- Short-form video
            'ARTICLE',                 -- Long-form article
            'QUESTION',                -- Q&A format
            'JOB_POSTING'              -- Job opportunity
        );
        COMMENT ON TYPE socialcandor_schema.content_type IS 'Defines types of user-generated content';
    END IF;
END
$$;

-----------------------------------------------------------------------------------------------
-- Enum: engagement_type
-- Description: Defines types of user engagement with content
-- Business Case: Tracks detailed engagement metrics for analytics
-- Feature Reference: ENG01 (Engagement Analytics), REC01 (Recommendation System)
------------------------------------------------------------------------------------------------
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_type 
        WHERE typname = 'engagement_type' 
        AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'socialcandor_schema')
    ) THEN
        CREATE TYPE socialcandor_schema.engagement_type AS ENUM (
            'VIEW',                    -- Content viewed
            'LIKE',                    -- Positive reaction
            'COMMENT',                 -- Comment posted
            'SHARE',                   -- Content shared
            'SAVE',                    -- Content saved/bookmarked
            'CLICK',                   -- Link/CTR clicked
            'FOLLOW',                  -- Creator followed
            'REPORT',                  -- Content reported
            'HIDE',                    -- Content hidden
            'MUTE',                    -- Creator muted
            'BLOCK',                   -- Creator blocked
            'TIP',                     -- Financial tip
            'PAID SUBSCRIBE',          -- Paid subscription
            'REACTION',                -- Emoji reaction
            'VULGAR COMMENT',          -- Vulgar Comment
            'UNPAID SUBSCRIBE',        -- Unpaid subscription
            'LOL',                     -- Laugh out aloud
            'STAN',                    -- Stalker and fan
            'DANK',                    -- Excellent or very high quality
            'GHOSTING',                -- GHOSTING
            'SALTY',                   -- FEELING JEALOUS
            'FINNA',                   -- I AM GOING TO
            'YIKES',                   -- EMBARRASSED
            'BOUJEE',                  -- Extravagant or fancy
            'CAP',                     -- MEANS TO LIE
            'HIGH-KEY',                -- HIGH-KEY
            'LOW-KEY',                 -- LOW-KEY
            'CHEUGY',                  -- NOT ALL TRENDY
            'SIMP',                    -- Someone who does way too much for the person they have crush on
            'CAMP',                    -- Something that is ironically trendy
            'WOKE',                    -- Politically Aware
            'TFW',                     -- That feeling when
            'SNACK',                   -- A person that you find attractive
            'SIP-TEA',                 -- Sitting back and listening to gossip "spilling the tea"
            'L',                       -- LOSER
            'TSS',                     -- If someone is really getting on your nerves
            'DRIP',                    -- COOL or Sexy trend style
            'SWAG',                    -- COOL
            'BOP',                     -- When a song or album is exceptionally good
            'SHEESH',                  -- hype someone up if they are looking good or doing something good
            'IYKYK',                   -- reference to an inside joke or something only a specific community might understand
            'LIVE-RENT-FREE',          -- LIVING RENT FREE IN YOUR HEAD, YOU CANT STOP THINKING ABOUT IT
            'BET',                     -- YES
            'VIBE CHECK',              -- TO CHECK SOMEONE'S ENERGY OR MOOD
            'CATCH THESE HANDS',       -- CONTENTIOUS MATTER
            'DRAG',                    -- CRITICIZING OR MAKING FUN OF THEM
            'FINESSE',                 -- TO TRICK OR MANIPULATE SOMEONE OR A SITUATION IN ORDER TO GET WHAT YOU WANT
            'IM-WEAK',                 -- USED WHEN YOU FIND SOMETHING HILARIOUS
            'SLAPS',                   -- USED TO DESCRIBE HOW EXCEPTIONAL SOMETHING IS
            'BUSSIN',                  -- WHEN YOU TASTE SOMETHING DELICIOUS
            'SUS',                     -- SUSPICIOUS
            'GUAP',                    -- MONEY AND LOTS OF IT
            'SMOL',                    -- SMALL AND EXCEPTIONALLY ADORABLE
            'CLAPBACK',                -- A RESPONSE OR COMEBACK AFTER YOU HAVE BEEN CALLED OUT FOR SOMETHING
            'GOAT'                     -- THE GREATEST OF ALL TIME
        );
        COMMENT ON TYPE socialcandor_schema.engagement_type IS 'Defines types of user engagement with content';
    END IF;
END
$$;

-- Create the notification_channel enum if not exists
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_type 
        WHERE typname = 'notification_channel' 
        AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'socialcandor_schema')
    ) THEN
        CREATE TYPE socialcandor_schema.notification_channel AS ENUM (
            'IN_APP',
            'EMAIL',
            'PUSH',
            'SMS',
            'WEBHOOK',
            'SLACK',
            'TEAMS'
        );
    END IF;
END
$$;

------------------------------------------------------------------------------------------------
-- Table: 105 - engagement_windows
-- Description: Time window definitions for real-time engagement tracking
-- Business Case: Enables configurable engagement measurement periods (5-min/1-hour windows)
-- for viral content detection while supporting window-based rate limiting for spam
-- prevention. Provides flexible analytics timeframes for different business needs.
-- Feature Reference: ENG06 (Time-based Analytics), ANL02 (Viral Detection), RATE01 (Rate Limiting)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.engagement_windows (
    window_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Window configuration
    window_name VARCHAR(100) NOT NULL UNIQUE,
    window_description TEXT,
    window_type VARCHAR(20) NOT NULL DEFAULT 'SLIDING' CHECK (
        window_type IN ('SLIDING', 'TUMBLING', 'SESSION', 'FIXED')
    ),

    -- Time configuration
    duration_seconds INTEGER NOT NULL CHECK (duration_seconds > 0),
    slide_interval_seconds INTEGER CHECK (slide_interval_seconds > 0),
    alignment_unit VARCHAR(20) CHECK (
        alignment_unit IN ('MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH')
    ),

    -- Aggregation settings
    aggregation_function VARCHAR(20) DEFAULT 'SUM' CHECK (
        aggregation_function IN ('SUM', 'COUNT', 'AVG', 'MAX', 'MIN', 'COUNT_DISTINCT')
    ),
    aggregation_field VARCHAR(100),
    group_by_fields VARCHAR(100)[] DEFAULT '{}',

    -- Threshold configuration
    warning_threshold NUMERIC(15,2),
    critical_threshold NUMERIC(15,2),
    rate_limit_threshold INTEGER CHECK (rate_limit_threshold >= 0),

    -- Application scope
    applicable_content_types socialcandor_schema.content_type[] DEFAULT '{}',
    applicable_engagement_types socialcandor_schema.engagement_type[] DEFAULT '{}',
    user_segment_filters JSONB DEFAULT '{}',

    -- Performance optimization
    precompute_interval_seconds INTEGER DEFAULT 60 CHECK (precompute_interval_seconds > 0),
    retention_days INTEGER DEFAULT 30 CHECK (retention_days >= 1 AND retention_days <= 365),

    -- Monitoring and alerts
    alert_channel socialcandor_schema.notification_channel[] DEFAULT ARRAY['IN_APP']::socialcandor_schema.notification_channel[],
    alert_template_id UUID,
    escalation_policy JSONB DEFAULT '{}',

    -- Status and lifecycle
    is_active BOOLEAN DEFAULT TRUE,
    is_system_defined BOOLEAN DEFAULT FALSE,
    version INTEGER DEFAULT 1 CHECK (version >= 1),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT socialcandor_schema.uuid_nil(),

    -- Constraints
    CONSTRAINT chk_slide_interval CHECK (
        (window_type != 'SLIDING' AND slide_interval_seconds IS NULL) OR
        (window_type = 'SLIDING' AND slide_interval_seconds IS NOT NULL AND slide_interval_seconds <= duration_seconds)
    ),
    CONSTRAINT chk_thresholds_order CHECK (
        (warning_threshold IS NULL AND critical_threshold IS NULL) OR
        warning_threshold <= critical_threshold
    ),
    CONSTRAINT chk_aggregation_validity CHECK (
        (aggregation_function NOT IN ('SUM', 'AVG', 'MAX', 'MIN') AND aggregation_field IS NULL) OR
        aggregation_field IS NOT NULL
    )
);

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_engagement_windows_name ON socialcandor_schema.engagement_windows(window_name);
CREATE INDEX IF NOT EXISTS idx_engagement_windows_active ON socialcandor_schema.engagement_windows(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_engagement_windows_updated ON socialcandor_schema.engagement_windows(updated_at);
CREATE INDEX IF NOT EXISTS idx_engagement_windows_content_types ON socialcandor_schema.engagement_windows USING GIN(applicable_content_types);
CREATE INDEX IF NOT EXISTS idx_engagement_windows_engagement_types ON socialcandor_schema.engagement_windows USING GIN(applicable_engagement_types);
CREATE INDEX IF NOT EXISTS idx_engagement_windows_user_segment ON socialcandor_schema.engagement_windows USING GIN(user_segment_filters);

-- Create trigger to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_engagement_windows_updated_at
    BEFORE UPDATE ON socialcandor_schema.engagement_windows
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Create comment on table and columns
COMMENT ON TABLE socialcandor_schema.engagement_windows IS 'Time window definitions for real-time engagement tracking and rate limiting';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.window_id IS 'Unique identifier for the window configuration';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.window_name IS 'Human-readable name for the window configuration';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.window_type IS 'Type of time window: SLIDING, TUMBLING, SESSION, or FIXED';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.duration_seconds IS 'Duration of the window in seconds';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.slide_interval_seconds IS 'Slide interval for sliding windows (must be <= duration)';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.alignment_unit IS 'Time unit for window alignment (e.g., HOUR for hourly boundaries)';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.aggregation_function IS 'Aggregation function to apply to window data';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.aggregation_field IS 'Field to apply aggregation function to (if applicable)';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.group_by_fields IS 'Fields to group by when computing window aggregates';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.warning_threshold IS 'Warning threshold for engagement metrics';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.critical_threshold IS 'Critical threshold for engagement metrics';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.rate_limit_threshold IS 'Maximum number of engagements allowed in this window';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.applicable_content_types IS 'Content types this window applies to';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.applicable_engagement_types IS 'Engagement types this window tracks';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.user_segment_filters IS 'JSON filters to limit window to specific user segments';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.precompute_interval_seconds IS 'Interval for precomputing window aggregates for performance';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.retention_days IS 'Number of days to retain window data';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.alert_channel IS 'Channels to send alerts through when thresholds are breached';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.alert_template_id IS 'Reference to alert template for notifications';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.escalation_policy IS 'JSON policy for escalating alerts based on severity and duration';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.is_active IS 'Whether this window configuration is currently active';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.is_system_defined IS 'Whether this is a system-defined window (not user-modifiable)';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.version IS 'Version number for configuration changes';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.created_at IS 'Timestamp when the window configuration was created';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.updated_at IS 'Timestamp when the window configuration was last updated';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.created_by IS 'User who created the window configuration';
COMMENT ON COLUMN socialcandor_schema.engagement_windows.updated_by IS 'User who last updated the window configuration';

-- -- Insert some default/system-defined window configurations using the correct enum values
-- INSERT INTO socialcandor_schema.engagement_windows (
--     window_name,
--     window_description,
--     window_type,
--     duration_seconds,
--     slide_interval_seconds,
--     alignment_unit,
--     aggregation_function,
--     aggregation_field,
--     group_by_fields,
--     warning_threshold,
--     critical_threshold,
--     rate_limit_threshold,
--     applicable_content_types,
--     applicable_engagement_types,
--     user_segment_filters,
--     precompute_interval_seconds,
--     retention_days,
--     alert_channel,
--     is_system_defined,
--     created_by,
--     updated_by
-- ) VALUES 
-- -- Viral detection window for trending content (5-minute sliding window)
-- (
--     'trending_content_5min',
--     '5-minute sliding window for real-time trending content detection',
--     'SLIDING',
--     300, -- 5 minutes in seconds
--     60,  -- slide every minute
--     'MINUTE',
--     'COUNT',
--     NULL,
--     ARRAY['content_id', 'user_id'],
--     1000, -- warning at 1000 engagements
--     5000, -- critical at 5000 engagements
--     NULL,
--     ARRAY['VIDEO', 'STORY', 'REEL', 'IMAGE']::socialcandor_schema.content_type[],
--     ARRAY['LIKE', 'SHARE', 'COMMENT', 'VIEW', 'SAVE', 'REACTION', 'LOL', 'SHEESH', 'GOAT']::socialcandor_schema.engagement_type[],
--     '{"min_followers": 100, "user_status": "active"}'::JSONB,
--     30, -- precompute every 30 seconds
--     90, -- retain for 90 days
--     ARRAY['IN_APP', 'EMAIL']::socialcandor_schema.notification_channel[],
--     TRUE,
--     '00000000-0000-0000-0000-000000000000'::UUID,
--     '00000000-0000-0000-0000-000000000000'::UUID
-- ),
-- -- Rate limiting window for spam prevention on text content
-- (
--     'text_spam_prevention_1hr',
--     '1-hour tumbling window for spam prevention on text content',
--     'TUMBLING',
--     3600, -- 1 hour in seconds
--     NULL,
--     'HOUR',
--     'COUNT',
--     NULL,
--     ARRAY['user_id', 'engagement_type'],
--     50,  -- warning at 50 engagements
--     100, -- critical at 100 engagements
--     200, -- rate limit at 200 engagements
--     ARRAY['TEXT', 'COMMENT']::socialcandor_schema.content_type[],
--     ARRAY['COMMENT', 'VULGAR COMMENT', 'CAP', 'DRAG', 'CLAPBACK']::socialcandor_schema.engagement_type[],
--     '{"account_age_days": {"$gt": 1}}'::JSONB,
--     300, -- precompute every 5 minutes
--     30,  -- retain for 30 days
--     ARRAY['IN_APP']::socialcandor_schema.notification_channel[],
--     TRUE,
--     '00000000-0000-0000-0000-000000000000'::UUID,
--     '00000000-0000-0000-0000-000000000000'::UUID
-- ),
-- -- Daily engagement analytics for all content types
-- (
--     'daily_engagement_analytics',
--     '24-hour fixed window for daily engagement analytics',
--     'FIXED',
--     86400, -- 24 hours in seconds
--     NULL,
--     'DAY',
--     'SUM',
--     'engagement_value',
--     ARRAY['content_type', 'user_segment'],
--     10000, -- warning at 10,000 engagement value
--     50000, -- critical at 50,000 engagement value
--     NULL,
--     ARRAY['TEXT', 'IMAGE', 'VIDEO', 'LINK', 'POLL', 'EVENT', 'LIVE', 'AUDIO', 'STORY', 'REEL', 'ARTICLE', 'QUESTION', 'JOB_POSTING']::socialcandor_schema.content_type[],
--     ARRAY['LIKE', 'SHARE', 'COMMENT', 'VIEW', 'CLICK', 'REACTION', 'SAVE', 'FOLLOW', 'TIP', 'PAID SUBSCRIBE']::socialcandor_schema.engagement_type[],
--     '{}'::JSONB,
--     3600, -- precompute every hour
--     365,  -- retain for 1 year
--     ARRAY['EMAIL']::socialcandor_schema.notification_channel[],
--     TRUE,
--     '00000000-0000-0000-0000-000000000000'::UUID,
--     '00000000-0000-0000-0000-000000000000'::UUID
-- ),
-- -- Modern slang engagement tracker for viral content
-- (
--     'slang_engagement_30min',
--     '30-minute sliding window for tracking modern slang engagements',
--     'SLIDING',
--     1800, -- 30 minutes in seconds
--     300,  -- slide every 5 minutes
--     'MINUTE',
--     'COUNT',
--     NULL,
--     ARRAY['content_id', 'slang_type'],
--     100,  -- warning at 100 slang engagements
--     500,  -- critical at 500 slang engagements
--     NULL,
--     ARRAY['TEXT', 'VIDEO', 'REEL', 'STORY']::socialcandor_schema.content_type[],
--     ARRAY['LOL', 'STAN', 'DANK', 'SUS', 'GOAT', 'SHEESH', 'DRIP', 'SWAG', 'BOP', 'BUSSIN', 'GUAP', 'SLAPS']::socialcandor_schema.engagement_type[],
--     '{"age_group": "13-25", "user_status": "active"}'::JSONB,
--     60, -- precompute every minute
--     60,  -- retain for 60 days
--     ARRAY['IN_APP', 'PUSH']::socialcandor_schema.notification_channel[],
--     TRUE,
--     '00000000-0000-0000-0000-000000000000'::UUID,
--     '00000000-0000-0000-0000-000000000000'::UUID
-- ),
-- -- Negative engagement monitoring window
-- (
--     'negative_engagement_monitoring',
--     '2-hour sliding window for monitoring negative engagements',
--     'SLIDING',
--     7200, -- 2 hours in seconds
--     900,  -- slide every 15 minutes
--     'HOUR',
--     'COUNT',
--     NULL,
--     ARRAY['content_id', 'user_id', 'negative_type'],
--     10,   -- warning at 10 negative engagements
--     50,   -- critical at 50 negative engagements
--     100,  -- rate limit at 100 negative engagements
--     ARRAY['TEXT', 'IMAGE', 'VIDEO']::socialcandor_schema.content_type[],
--     ARRAY['REPORT', 'HIDE', 'MUTE', 'BLOCK', 'VULGAR COMMENT', 'SALTY', 'DRAG', 'TSS']::socialcandor_schema.engagement_type[],
--     '{"requires_moderation": true}'::JSONB,
--     300, -- precompute every 5 minutes
--     90,  -- retain for 90 days
--     ARRAY['IN_APP', 'EMAIL', 'SLACK']::socialcandor_schema.notification_channel[],
--     TRUE,
--     '00000000-0000-0000-0000-000000000000'::UUID,
--     '00000000-0000-0000-0000-000000000000'::UUID
-- )
-- ON CONFLICT (window_name) DO NOTHING;

-- -- Grant appropriate permissions (adjust as needed for your security requirements)
-- GRANT USAGE ON SCHEMA socialcandor_schema TO PUBLIC;
-- GRANT SELECT ON socialcandor_schema.engagement_windows TO PUBLIC;
-- GRANT INSERT, UPDATE, DELETE ON socialcandor_schema.engagement_windows TO socialcandor_admin;
-- GRANT USAGE ON TYPE socialcandor_schema.content_type TO PUBLIC;
-- GRANT USAGE ON TYPE socialcandor_schema.engagement_type TO PUBLIC;
-- GRANT USAGE ON TYPE socialcandor_schema.notification_channel TO PUBLIC;

-- Create a view for active windows only
CREATE OR REPLACE VIEW socialcandor_schema.active_engagement_windows AS
SELECT 
    window_id,
    window_name,
    window_description,
    window_type,
    duration_seconds,
    slide_interval_seconds,
    alignment_unit,
    aggregation_function,
    aggregation_field,
    group_by_fields,
    warning_threshold,
    critical_threshold,
    rate_limit_threshold,
    applicable_content_types,
    applicable_engagement_types,
    user_segment_filters,
    precompute_interval_seconds,
    retention_days,
    alert_channel,
    alert_template_id,
    escalation_policy,
    is_active,
    is_system_defined,
    version,
    created_at,
    updated_at,
    created_by,
    updated_by
FROM socialcandor_schema.engagement_windows
WHERE is_active = TRUE;

COMMENT ON VIEW socialcandor_schema.active_engagement_windows IS 'Active engagement window configurations only';

-- Create a function to get windows applicable to specific content and engagement types
CREATE OR REPLACE FUNCTION socialcandor_schema.get_applicable_windows(
    p_content_type socialcandor_schema.content_type,
    p_engagement_type socialcandor_schema.engagement_type,
    p_user_segment JSONB DEFAULT '{}'
)
RETURNS TABLE (
    window_id UUID,
    window_name VARCHAR(100),
    window_type VARCHAR(20),
    duration_seconds INTEGER,
    slide_interval_seconds INTEGER,
    aggregation_function VARCHAR(20),
    aggregation_field VARCHAR(100),
    rate_limit_threshold INTEGER,
    warning_threshold NUMERIC(15,2),
    critical_threshold NUMERIC(15,2)
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        ew.window_id,
        ew.window_name,
        ew.window_type,
        ew.duration_seconds,
        ew.slide_interval_seconds,
        ew.aggregation_function,
        ew.aggregation_field,
        ew.rate_limit_threshold,
        ew.warning_threshold,
        ew.critical_threshold
    FROM socialcandor_schema.engagement_windows ew
    WHERE ew.is_active = TRUE
        AND (
            ew.applicable_content_types = '{}'::socialcandor_schema.content_type[] OR
            p_content_type = ANY(ew.applicable_content_types)
        )
        AND (
            ew.applicable_engagement_types = '{}'::socialcandor_schema.engagement_type[] OR
            p_engagement_type = ANY(ew.applicable_engagement_types)
        )
        AND (
            ew.user_segment_filters = '{}'::JSONB OR
            ew.user_segment_filters @> p_user_segment
        );
END;
$$ LANGUAGE plpgsql STABLE;

COMMENT ON FUNCTION socialcandor_schema.get_applicable_windows IS 'Returns engagement windows applicable to specific content type, engagement type, and user segment';

   ------------------------------------------------------------------------------------------------
-- Table: 106 - live_engagement
-- Description: Real-time engagement aggregation per content item
-- Business Case: Powers "trending now" features with sub-minute latency while enabling
-- engagement velocity alerts for moderator review of rapidly spreading potentially
-- harmful content. Supports real-time dashboards and dynamic content ranking.
-- Feature Reference: ENG07 (Real-time Analytics), TREND01 (Trending Detection), ALERT01 (Velocity Alerts)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.live_engagement (
    live_engagement_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    content_id UUID NOT NULL,
    content_type socialcandor_schema.content_type NOT NULL,
    window_id UUID NOT NULL,

    -- Window timing
    window_start TIMESTAMP WITH TIME ZONE NOT NULL,
    window_end TIMESTAMP WITH TIME ZONE NOT NULL,
    window_duration_seconds INTEGER GENERATED ALWAYS AS (EXTRACT(EPOCH FROM (window_end - window_start))) STORED,

    -- Engagement counts
    view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
    like_count INTEGER DEFAULT 0 CHECK (like_count >= 0),
    comment_count INTEGER DEFAULT 0 CHECK (comment_count >= 0),
    share_count INTEGER DEFAULT 0 CHECK (share_count >= 0),
    save_count INTEGER DEFAULT 0 CHECK (save_count >= 0),
    report_count INTEGER DEFAULT 0 CHECK (report_count >= 0),

    -- User participation
    unique_users_count INTEGER DEFAULT 0 CHECK (unique_users_count >= 0),
    returning_users_count INTEGER DEFAULT 0 CHECK (returning_users_count >= 0),
    new_users_count INTEGER DEFAULT 0 CHECK (new_users_count >= 0),

    -- Velocity metrics
    engagement_velocity NUMERIC(10,2) DEFAULT 0.0,
    velocity_per_minute NUMERIC(10,2) DEFAULT 0.0,
    acceleration NUMERIC(10,2) DEFAULT 0.0, -- Change in velocity

    -- Quality metrics
    engagement_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_rate >= 0 AND engagement_rate <= 100),
    completion_rate NUMERIC(5,2) DEFAULT 0.0 CHECK (completion_rate >= 0 AND completion_rate <= 100),
    sentiment_score NUMERIC(5,2) DEFAULT 0.0 CHECK (sentiment_score >= -1 AND sentiment_score <= 1),

    -- Geographic distribution
    countries JSONB DEFAULT '{}',
    cities JSONB DEFAULT '{}',
    top_country VARCHAR(3),

    -- Device distribution
    devices JSONB DEFAULT '{}',
    top_device_type VARCHAR(50),

    -- Source distribution
    sources JSONB DEFAULT '{}',
    top_source VARCHAR(50),

    -- Trend analysis
    is_trending BOOLEAN DEFAULT FALSE,
    trending_score NUMERIC(10,6) DEFAULT 0.0,
    trend_direction VARCHAR(10) CHECK (trend_direction IN ('UP', 'DOWN', 'STABLE', 'VOLATILE')),

    -- Alert status
    alert_level VARCHAR(20) DEFAULT 'NONE' CHECK (
        alert_level IN ('NONE', 'LOW', 'MEDIUM', 'HIGH', 'CRITICAL')
    ),
    alert_triggered_at TIMESTAMP WITH TIME ZONE,
    alert_reason VARCHAR(200),

    -- Performance metrics
    calculation_time_ms INTEGER DEFAULT 0 CHECK (calculation_time_ms >= 0),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),

    -- Foreign key constraint
    CONSTRAINT fk_live_engagement_window FOREIGN KEY (window_id)
        REFERENCES socialcandor_schema.engagement_windows(window_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT uk_live_engagement_window UNIQUE (content_id, window_id, window_start),
    CONSTRAINT chk_window_timing CHECK (
        window_end > window_start AND
        window_end <= CURRENT_TIMESTAMP
    ),
    CONSTRAINT chk_velocity_calculation CHECK (
        (engagement_velocity = (like_count + comment_count * 2 + share_count * 3) / GREATEST(window_duration_seconds, 1)) OR
        engagement_velocity = 0
    ),
    CONSTRAINT chk_unique_users_limit CHECK (
        unique_users_count >= returning_users_count + new_users_count
    )
);

COMMENT ON TABLE socialcandor_schema.live_engagement IS 'Real-time engagement aggregation per content item for trending detection';
COMMENT ON COLUMN socialcandor_schema.live_engagement.acceleration IS 'Rate of change of engagement velocity (2nd derivative)';

-- Indexes for live_engagement
CREATE INDEX IF NOT EXISTS idx_live_engagement_content ON socialcandor_schema.live_engagement(content_id);
CREATE INDEX IF NOT EXISTS idx_live_engagement_window ON socialcandor_schema.live_engagement(window_id, window_end DESC);
CREATE INDEX IF NOT EXISTS idx_live_engagement_trending ON socialcandor_schema.live_engagement(trending_score DESC) WHERE is_trending = TRUE;
CREATE INDEX IF NOT EXISTS idx_live_engagement_velocity ON socialcandor_schema.live_engagement(engagement_velocity DESC);
CREATE INDEX IF NOT EXISTS idx_live_engagement_alert ON socialcandor_schema.live_engagement(alert_level) WHERE alert_level != 'NONE';
CREATE INDEX IF NOT EXISTS idx_live_engagement_composite ON socialcandor_schema.live_engagement(content_type, window_end DESC, trending_score DESC);

-- Create a view for data freshness (alternative to generated column)
CREATE OR REPLACE VIEW socialcandor_schema.live_engagement_with_freshness AS
SELECT 
    *,
    EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - window_end))::INTEGER AS data_freshness_seconds
FROM socialcandor_schema.live_engagement;

-- Create a function to calculate data freshness for use in queries
CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_freshness(window_end_timestamp TIMESTAMP WITH TIME ZONE)
RETURNS INTEGER AS $$
BEGIN
    RETURN EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - window_end_timestamp))::INTEGER;
END;
$$ LANGUAGE plpgsql;

-- Partition by time (example for TimescaleDB)
-- Note: Uncomment and adjust if using TimescaleDB
-- SELECT create_hypertable('socialcandor_schema.live_engagement', 'window_end');

-- Trigger for updated_at
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_live_engagement_updated_at
    BEFORE UPDATE ON socialcandor_schema.live_engagement
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

-- Create indexes for the view's freshness calculations if needed
CREATE INDEX IF NOT EXISTS idx_live_engagement_window_end ON socialcandor_schema.live_engagement(window_end DESC);

 ------------------------------------------------------------------------------------------------
-- Table: 107 - neural_recommendations
-- Description: Deep learning-based recommendation storage with confidence scores
-- Business Case: Enables state-of-the-art personalization through transformer models
-- while maintaining explainability through recommendation context metadata for
-- transparency. Supports multi-objective optimization and real-time updates.
-- Feature Reference: REC04 (Neural Recommendations), ML02 (Deep Learning), EXPL01 (Explainable AI)
-----------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.neural_recommendations (
    recommendation_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL,

    -- Recommendation target
    recommended_item_id UUID NOT NULL,
    item_type VARCHAR(50) NOT NULL CHECK (
        item_type IN ('POST', 'USER', 'GROUP', 'PAGE', 'EVENT', 'PRODUCT', 'CONTENT')
    ),

    -- Model information
    model_name VARCHAR(100) NOT NULL,
    model_version VARCHAR(50) NOT NULL,
    model_type VARCHAR(50) CHECK (
        model_type IN ('COLLABORATIVE', 'CONTENT_BASED', 'HYBRID', 'DEEP', 'TRANSFORMER', 'GRAPH')
    ),

    -- Prediction scores
    prediction_score NUMERIC(10,6) NOT NULL CHECK (prediction_score >= 0 AND prediction_score <= 1),
    confidence_score NUMERIC(10,6) DEFAULT 0.0 CHECK (confidence_score >= 0 AND confidence_score <= 1),
    uncertainty_score NUMERIC(10,6) DEFAULT 0.0 CHECK (uncertainty_score >= 0 AND uncertainty_score <= 1),

    -- Ranking information
    rank_position INTEGER NOT NULL CHECK (rank_position >= 1),
    rank_score NUMERIC(10,6) DEFAULT 0.0,
    percentile_rank NUMERIC(5,2) DEFAULT 0.0 CHECK (percentile_rank >= 0 AND percentile_rank <= 100),

    -- Recommendation context
    recommendation_context JSONB DEFAULT '{}',
    feature_importance JSONB DEFAULT '{}',
    similarity_scores JSONB DEFAULT '{}',

    -- Diversity and novelty
    novelty_score NUMERIC(10,6) DEFAULT 0.0 CHECK (novelty_score >= 0 AND novelty_score <= 1),
    diversity_score NUMERIC(10,6) DEFAULT 0.0 CHECK (diversity_score >= 0 AND diversity_score <= 1),
    serendipity_score NUMERIC(10,6) DEFAULT 0.0 CHECK (serendipity_score >= 0 AND serendipity_score <= 1),

    -- Business objectives
    relevance_score NUMERIC(10,6) DEFAULT 0.0 CHECK (relevance_score >= 0 AND relevance_score <= 1),
    engagement_score NUMERIC(10,6) DEFAULT 0.0 CHECK (engagement_score >= 0 AND engagement_score <= 1),
    revenue_score NUMERIC(10,6) DEFAULT 0.0 CHECK (revenue_score >= 0 AND revenue_score <= 1),

    -- User interaction
    was_shown BOOLEAN DEFAULT FALSE,
    shown_at TIMESTAMP WITH TIME ZONE,
    was_clicked BOOLEAN DEFAULT FALSE,
    clicked_at TIMESTAMP WITH TIME ZONE,
    engagement_type socialcandor_schema.engagement_type,

    -- Feedback and improvement
    feedback_score NUMERIC(5,2) CHECK (feedback_score >= 0 AND feedback_score <= 100),
    feedback_reason VARCHAR(200),
    model_training_flag BOOLEAN DEFAULT FALSE,

    -- Performance metrics
    inference_time_ms INTEGER CHECK (inference_time_ms >= 0),
    feature_generation_time_ms INTEGER CHECK (feature_generation_time_ms >= 0),

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    expires_at TIMESTAMP WITH TIME ZONE,

    -- Foreign key constraint
    CONSTRAINT fk_neural_recommendations_user FOREIGN KEY (user_id)
        REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

    -- Constraints
    CONSTRAINT uk_user_recommendation UNIQUE (user_id, recommended_item_id, item_type, model_name),
    CONSTRAINT chk_score_consistency CHECK (
        prediction_score * confidence_score <= 1.0
    ),
    CONSTRAINT chk_ranking_validity CHECK (
        rank_position >= 1 AND rank_position <= 1000
    ),
    CONSTRAINT chk_feedback_timing CHECK (
        (was_clicked = FALSE AND clicked_at IS NULL) OR
        (was_clicked = TRUE AND clicked_at IS NOT NULL AND clicked_at >= shown_at)
    )
);

COMMENT ON TABLE socialcandor_schema.neural_recommendations IS 'Deep learning-based recommendation storage with confidence scores and explainability';
COMMENT ON COLUMN socialcandor_schema.neural_recommendations.serendipity_score IS 'Score measuring unexpected but relevant recommendations';

-- Indexes for neural_recommendations
CREATE INDEX IF NOT EXISTS idx_neural_recommendations_user ON socialcandor_schema.neural_recommendations(user_id);
CREATE INDEX IF NOT EXISTS idx_neural_recommendations_item ON socialcandor_schema.neural_recommendations(recommended_item_id, item_type);
CREATE INDEX IF NOT EXISTS idx_neural_recommendations_score ON socialcandor_schema.neural_recommendations(prediction_score DESC);
CREATE INDEX IF NOT EXISTS idx_neural_recommendations_rank ON socialcandor_schema.neural_recommendations(rank_position);
CREATE INDEX IF NOT EXISTS idx_neural_recommendations_shown ON socialcandor_schema.neural_recommendations(was_shown) WHERE was_shown = TRUE;
CREATE INDEX IF NOT EXISTS idx_neural_recommendations_clicked ON socialcandor_schema.neural_recommendations(was_clicked) WHERE was_clicked = TRUE;
CREATE INDEX IF NOT EXISTS idx_neural_recommendations_expires ON socialcandor_schema.neural_recommendations(expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_neural_recommendations_created ON socialcandor_schema.neural_recommendations(created_at DESC);

-- Composite index for recommendation retrieval (without volatile function in WHERE clause)
CREATE INDEX IF NOT EXISTS idx_neural_recommendations_retrieval ON socialcandor_schema.neural_recommendations
(user_id, item_type, prediction_score DESC, rank_position);

-- -- Alternative: Add a boolean column to mark active recommendations and index on that
-- -- This avoids using volatile functions in index predicates
-- ALTER TABLE socialcandor_schema.neural_recommendations 
-- ADD COLUMN IF NOT EXISTS is_active BOOLEAN GENERATED ALWAYS AS 
--     (expires_at IS NULL OR expires_at > CURRENT_TIMESTAMP) STORED;

-- -- Now create indexes using the generated column
-- CREATE INDEX IF NOT EXISTS idx_neural_recommendations_active ON socialcandor_schema.neural_recommendations
-- (user_id, item_type, prediction_score DESC, rank_position)
-- WHERE is_active = TRUE;

-- CREATE INDEX IF NOT EXISTS idx_neural_recommendations_active_fresh ON socialcandor_schema.neural_recommendations
-- (created_at DESC)
-- WHERE is_active = TRUE;

-- Trigger for updated_at
CREATE OR REPLACE FUNCTION socialcandor_schema.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_neural_recommendations_updated_at
    BEFORE UPDATE ON socialcandor_schema.neural_recommendations
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 108 - call_metrics
    -- Description: Voice/video call quality analytics with emotion analysis
    -- Business Case: Supports communication feature optimization while enabling automatic
    -- call summarization through transcript analysis and key moment extraction. Provides
    -- quality of service monitoring and user experience insights.
    -- Feature Reference: COMM01 (Call Analytics), QoS01 (Quality of Service), AI01 (Emotion Analysis)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.call_metrics (
        call_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        conversation_id UUID NOT NULL,

        -- Call identification
        call_type VARCHAR(20) NOT NULL DEFAULT 'VOICE' CHECK (
            call_type IN ('VOICE', 'VIDEO', 'SCREEN_SHARE', 'GROUP', 'CONFERENCE')
        ),
        call_uuid VARCHAR(36) UNIQUE NOT NULL DEFAULT uuid_generate_v4()::text,

        -- Timing information
        initiated_at TIMESTAMP WITH TIME ZONE NOT NULL,
        connected_at TIMESTAMP WITH TIME ZONE,
        ended_at TIMESTAMP WITH TIME ZONE,
        call_duration_seconds INTEGER GENERATED ALWAYS AS (
            CASE
                WHEN ended_at IS NOT NULL AND connected_at IS NOT NULL
                THEN EXTRACT(EPOCH FROM (ended_at - connected_at))
                ELSE 0
            END
        ) STORED,

        -- Participant information
        initiator_user_id UUID NOT NULL,
        participant_user_ids UUID[] NOT NULL,
        max_participants_count INTEGER CHECK (max_participants_count >= 1),

        -- Technical metrics
        jitter_ms NUMERIC(6,2) CHECK (jitter_ms >= 0),
        packet_loss_percentage NUMERIC(5,2) CHECK (packet_loss_percentage >= 0 AND packet_loss_percentage <= 100),
        latency_ms NUMERIC(6,2) CHECK (latency_ms >= 0),
        bitrate_kbps INTEGER CHECK (bitrate_kbps >= 0),
        resolution_width INTEGER CHECK (resolution_width >= 0),
        resolution_height INTEGER CHECK (resolution_height >= 0),
        frame_rate_fps NUMERIC(4,1) CHECK (frame_rate_fps >= 0),

        -- Quality scores
        audio_quality_score NUMERIC(5,2) DEFAULT 0.0 CHECK (audio_quality_score >= 0 AND audio_quality_score <= 100),
        video_quality_score NUMERIC(5,2) DEFAULT 0.0 CHECK (video_quality_score >= 0 AND video_quality_score <= 100),
        overall_quality_score NUMERIC(5,2) DEFAULT 0.0 CHECK (overall_quality_score >= 0 AND overall_quality_score <= 100),
        mos_score NUMERIC(3,1) CHECK (mos_score >= 1 AND mos_score <= 5), -- Mean Opinion Score

        -- Network information
        network_types VARCHAR(50)[] DEFAULT '{}',
        ice_connection_state VARCHAR(50),
        data_channel_state VARCHAR(50),

        -- Emotion and engagement
        emotion_scores JSONB DEFAULT '{}',
        engagement_score NUMERIC(5,2) DEFAULT 0.0 CHECK (engagement_score >= 0 AND engagement_score <= 100),
        speaking_time_distribution JSONB DEFAULT '{}',

        -- Transcription and analysis
        transcript_text TEXT,
        transcript_language VARCHAR(10),
        key_moments JSONB DEFAULT '[]',
        sentiment_score NUMERIC(5,2) DEFAULT 0.0 CHECK (sentiment_score >= -1 AND sentiment_score <= 1),

        -- Recording information
        was_recorded BOOLEAN DEFAULT FALSE,
        recording_url VARCHAR(500),
        recording_duration_seconds INTEGER CHECK (recording_duration_seconds >= 0),

        -- Call outcome
        call_status VARCHAR(20) DEFAULT 'INITIATED' CHECK (
            call_status IN ('INITIATED', 'RINGING', 'CONNECTED', 'IN_PROGRESS', 'COMPLETED', 'FAILED', 'MISSED', 'REJECTED')
        ),
        termination_reason VARCHAR(50),
        user_feedback_score INTEGER CHECK (user_feedback_score >= 1 AND user_feedback_score <= 5),

        -- Cost and billing
        cost_credits NUMERIC(10,2) DEFAULT 0.0 CHECK (cost_credits >= 0),
        billing_tier VARCHAR(20),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_call_metrics_conversation FOREIGN KEY (conversation_id)
            REFERENCES socialcandor_schema.conversations(conversation_id) ON DELETE CASCADE,
        CONSTRAINT fk_call_metrics_initiator FOREIGN KEY (initiator_user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT chk_call_timing CHECK (
            initiated_at <= CURRENT_TIMESTAMP AND
            (connected_at IS NULL OR connected_at >= initiated_at) AND
            (ended_at IS NULL OR ended_at >= connected_at)
        ),
        CONSTRAINT chk_participants_count CHECK (
            CARDINALITY(participant_user_ids) >= 2 AND
            (max_participants_count IS NULL OR CARDINALITY(participant_user_ids) <= max_participants_count)
        ),
        CONSTRAINT chk_quality_scores CHECK (
            overall_quality_score = (audio_quality_score + video_quality_score) / 2 OR
            video_quality_score IS NULL
        )
    );

    COMMENT ON TABLE socialcandor_schema.call_metrics IS 'Voice/video call quality analytics with emotion analysis and quality monitoring';
    COMMENT ON COLUMN socialcandor_schema.call_metrics.mos_score IS 'Mean Opinion Score (1-5) measuring perceived call quality';

    -- Indexes for call_metrics
    CREATE INDEX IF NOT EXISTS idx_call_metrics_conversation ON socialcandor_schema.call_metrics(conversation_id);
    CREATE INDEX IF NOT EXISTS idx_call_metrics_initiator ON socialcandor_schema.call_metrics(initiator_user_id);
    CREATE INDEX IF NOT EXISTS idx_call_metrics_time ON socialcandor_schema.call_metrics(initiated_at DESC);
    CREATE INDEX IF NOT EXISTS idx_call_metrics_duration ON socialcandor_schema.call_metrics(call_duration_seconds DESC);
    CREATE INDEX IF NOT EXISTS idx_call_metrics_quality ON socialcandor_schema.call_metrics(overall_quality_score DESC);
    CREATE INDEX IF NOT EXISTS idx_call_metrics_participants ON socialcandor_schema.call_metrics USING gin(participant_user_ids);
    CREATE INDEX IF NOT EXISTS idx_call_metrics_status ON socialcandor_schema.call_metrics(call_status);

    -- Trigger for updated_at
    CREATE TRIGGER trg_call_metrics_updated_at
        BEFORE UPDATE ON socialcandor_schema.call_metrics
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 109 - churn_predictions
    -- Description: ML-generated churn risk scores with key factor attribution
    -- Business Case: Enables proactive retention interventions (special offers, feature
    -- education) while prioritizing high-value at-risk users through LTV-weighted churn
    -- scoring. Supports data-driven retention strategies and resource allocation.
    -- Feature Reference: RET02 (Churn Prediction), ML03 (Predictive Analytics), CS01 (Customer Success)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.churn_predictions (
        prediction_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        user_id UUID NOT NULL,

        -- Prediction information
        prediction_date DATE NOT NULL DEFAULT CURRENT_DATE,
        prediction_horizon_days INTEGER NOT NULL CHECK (prediction_horizon_days >= 1 AND prediction_horizon_days <= 90),
        churn_probability NUMERIC(10,6) NOT NULL CHECK (churn_probability >= 0 AND churn_probability <= 1),
        confidence_interval_lower NUMERIC(10,6) CHECK (confidence_interval_lower >= 0 AND confidence_interval_lower <= 1),
        confidence_interval_upper NUMERIC(10,6) CHECK (confidence_interval_upper >= 0 AND confidence_interval_upper <= 1),

        -- Risk classification
        risk_level VARCHAR(20) NOT NULL DEFAULT 'LOW' CHECK (
            risk_level IN ('VERY_LOW', 'LOW', 'MEDIUM', 'HIGH', 'VERY_HIGH', 'CRITICAL')
        ),
        risk_score NUMERIC(5,2) GENERATED ALWAYS AS (churn_probability * 100) STORED,

        -- Key drivers
        top_drivers JSONB NOT NULL DEFAULT '[]',
        driver_contributions JSONB DEFAULT '{}',
        primary_driver VARCHAR(100),
        primary_driver_contribution NUMERIC(5,2) CHECK (primary_driver_contribution >= 0 AND primary_driver_contribution <= 100),

        -- User value context
        user_lifetime_value NUMERIC(15,2) CHECK (user_lifetime_value >= 0),
        user_ltv_rank_percentile NUMERIC(5,2) CHECK (user_ltv_rank_percentile >= 0 AND user_ltv_rank_percentile <= 100),
        user_segment VARCHAR(50),

        -- Model information
        model_name VARCHAR(100) NOT NULL,
        model_version VARCHAR(50) NOT NULL,
        model_type VARCHAR(50) CHECK (
            model_type IN ('CLASSIFICATION', 'REGRESSION', 'SURVIVAL', 'ENSEMBLE', 'DEEP')
        ),
        training_data_cutoff_date DATE,

        -- Feature importance
        feature_importance JSONB DEFAULT '{}',
        shap_values JSONB DEFAULT '{}',
        feature_contributions JSONB DEFAULT '{}',

        -- Intervention tracking
        recommended_interventions VARCHAR(100)[] DEFAULT '{}',
        intervention_priority INTEGER CHECK (intervention_priority >= 1),
        estimated_intervention_effectiveness NUMERIC(5,2) CHECK (estimated_intervention_effectiveness >= 0 AND estimated_intervention_effectiveness <= 100),

        -- Outcome tracking
        actual_churn_outcome BOOLEAN,
        churned_at TIMESTAMP WITH TIME ZONE,
        outcome_recorded_at TIMESTAMP WITH TIME ZONE,
        prediction_accuracy BOOLEAN,

        -- Performance metrics
        model_performance_metrics JSONB DEFAULT '{}',
        inference_time_ms INTEGER CHECK (inference_time_ms >= 0),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),
        expires_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP + INTERVAL '90 days',

        -- Foreign key constraint
        CONSTRAINT fk_churn_predictions_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_user_prediction_horizon UNIQUE (user_id, prediction_date, prediction_horizon_days),
        CONSTRAINT chk_confidence_interval CHECK (
            (confidence_interval_lower IS NULL AND confidence_interval_upper IS NULL) OR
            (confidence_interval_lower <= churn_probability AND confidence_interval_upper >= churn_probability)
        ),
        CONSTRAINT chk_driver_contributions CHECK (
            jsonb_array_length(top_drivers) <= 10 AND
            (primary_driver_contribution IS NULL OR primary_driver_contribution <= 100)
        ),
        CONSTRAINT chk_outcome_timing CHECK (
            (actual_churn_outcome IS NULL AND churned_at IS NULL) OR
            (actual_churn_outcome = TRUE AND churned_at IS NOT NULL AND churned_at >= prediction_date)
        )
    );

    COMMENT ON TABLE socialcandor_schema.churn_predictions IS 'ML-generated churn risk scores with key factor attribution and intervention recommendations';
    COMMENT ON COLUMN socialcandor_schema.churn_predictions.shap_values IS 'SHAP (SHapley Additive exPlanations) values for model interpretability';

    -- Indexes for churn_predictions
    CREATE INDEX IF NOT EXISTS idx_churn_predictions_user ON socialcandor_schema.churn_predictions(user_id);
    CREATE INDEX IF NOT EXISTS idx_churn_predictions_date ON socialcandor_schema.churn_predictions(prediction_date DESC);
    CREATE INDEX IF NOT EXISTS idx_churn_predictions_risk ON socialcandor_schema.churn_predictions(risk_level, risk_score DESC);
    CREATE INDEX IF NOT EXISTS idx_churn_predictions_probability ON socialcandor_schema.churn_predictions(churn_probability DESC);
--     CREATE INDEX IF NOT EXISTS idx_churn_predictions_active ON socialcandor_schema.churn_predictions(user_id) WHERE expires_at > CURRENT_TIMESTAMP;
    CREATE INDEX IF NOT EXISTS idx_churn_predictions_outcome ON socialcandor_schema.churn_predictions(actual_churn_outcome) WHERE actual_churn_outcome IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_churn_predictions_intervention ON socialcandor_schema.churn_predictions(intervention_priority) WHERE intervention_priority IS NOT NULL;

--     -- Composite index for retention team dashboards
--     CREATE INDEX IF NOT EXISTS idx_churn_predictions_dashboard ON socialcandor_schema.churn_predictions
--     (prediction_date, risk_level, user_segment, churn_probability DESC)
--     WHERE expires_at > CURRENT_TIMESTAMP;

    -- Trigger for updated_at
    CREATE TRIGGER trg_churn_predictions_updated_at
        BEFORE UPDATE ON socialcandor_schema.churn_predictions
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 110 - external_platforms
    -- Description: Cross-platform identity binding with OAuth token management
    -- Business Case: Enables social graph import from other networks while maintaining
    -- token refresh workflows and automatic sync scheduling based on platform API rate
    -- limits. Supports seamless multi-platform user experiences and data portability.
    -- Feature Reference: INT01 (Platform Integration), SYNC02 (Data Synchronization), AUTH02 (OAuth Management)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.external_platforms (
        external_platform_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        user_id UUID NOT NULL,

        -- Platform identification
        platform_name VARCHAR(50) NOT NULL CHECK (
            platform_name IN ('FACEBOOK', 'TWITTER', 'INSTAGRAM', 'LINKEDIN', 'GOOGLE', 'APPLE', 'GITHUB', 'DISCORD', 'TWITCH', 'TIKTOK')
        ),
        platform_user_id VARCHAR(255) NOT NULL,
        platform_username VARCHAR(255),

        -- OAuth credentials
        access_token TEXT NOT NULL,
        refresh_token TEXT,
        token_type VARCHAR(50) DEFAULT 'BEARER',

        -- Token metadata
        access_token_expires_at TIMESTAMP WITH TIME ZONE,
        refresh_token_expires_at TIMESTAMP WITH TIME ZONE,
        token_scopes VARCHAR(500)[] DEFAULT '{}',
        token_issued_at TIMESTAMP WITH TIME ZONE,

        -- Connection status
        connection_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (
            connection_status IN ('ACTIVE', 'EXPIRED', 'REVOKED', 'LIMITED', 'ERROR', 'PENDING')
        ),
        connected_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        last_validated_at TIMESTAMP WITH TIME ZONE,

        -- User profile data
        profile_data JSONB DEFAULT '{}',
        email VARCHAR(255),
        profile_picture_url VARCHAR(500),
        profile_url VARCHAR(500),

        -- Import settings
        auto_import_enabled BOOLEAN DEFAULT FALSE,
        import_frequency VARCHAR(20) DEFAULT 'DAILY' CHECK (
            import_frequency IN ('HOURLY', 'DAILY', 'WEEKLY', 'MONTHLY', 'MANUAL')
        ),
        last_import_at TIMESTAMP WITH TIME ZONE,
        next_import_due TIMESTAMP WITH TIME ZONE,

        -- Import statistics
        total_imports_count INTEGER DEFAULT 0 CHECK (total_imports_count >= 0),
        last_import_status VARCHAR(20),
        last_import_error TEXT,

        -- Rate limiting
        api_rate_limit_remaining INTEGER,
        api_rate_limit_reset_at TIMESTAMP WITH TIME ZONE,
        daily_import_quota INTEGER DEFAULT 100 CHECK (daily_import_quota >= 0),
        imports_today_count INTEGER DEFAULT 0 CHECK (imports_today_count >= 0),

        -- Privacy and permissions
        data_usage_consent BOOLEAN DEFAULT FALSE,
        marketing_consent BOOLEAN DEFAULT FALSE,
        friend_list_import_consent BOOLEAN DEFAULT FALSE,

        -- Platform-specific data
        platform_metadata JSONB DEFAULT '{}',
        verified_on_platform BOOLEAN DEFAULT FALSE,
        follower_count_on_platform INTEGER CHECK (follower_count_on_platform >= 0),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_external_platforms_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_platform_user UNIQUE (user_id, platform_name),
        CONSTRAINT uk_platform_external_id UNIQUE (platform_name, platform_user_id),
        CONSTRAINT chk_token_expiry CHECK (
            (access_token_expires_at IS NULL) OR
            (access_token_expires_at > token_issued_at)
        ),
        CONSTRAINT chk_import_schedule CHECK (
            (next_import_due IS NULL) OR
            (next_import_due > last_import_at)
        )
    );

    COMMENT ON TABLE socialcandor_schema.external_platforms IS 'Cross-platform identity binding with OAuth token management and import scheduling';
    COMMENT ON COLUMN socialcandor_schema.external_platforms.imports_today_count IS 'Counter reset daily to enforce import quotas';

    -- Indexes for external_platforms
    CREATE INDEX IF NOT EXISTS idx_external_platforms_user ON socialcandor_schema.external_platforms(user_id);
    CREATE INDEX IF NOT EXISTS idx_external_platforms_platform ON socialcandor_schema.external_platforms(platform_name);
    CREATE INDEX IF NOT EXISTS idx_external_platforms_status ON socialcandor_schema.external_platforms(connection_status);
    CREATE INDEX IF NOT EXISTS idx_external_platforms_token_expiry ON socialcandor_schema.external_platforms(access_token_expires_at) WHERE access_token_expires_at IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_external_platforms_import_due ON socialcandor_schema.external_platforms(next_import_due) WHERE auto_import_enabled = TRUE;
    CREATE INDEX IF NOT EXISTS idx_external_platforms_active ON socialcandor_schema.external_platforms(user_id, platform_name) WHERE connection_status = 'ACTIVE';

    -- Trigger to reset daily import counter
    CREATE OR REPLACE FUNCTION socialcandor_schema.reset_daily_import_counter()
    RETURNS TRIGGER AS $$
    BEGIN
        -- Reset imports_today_count at midnight
        IF DATE(NEW.updated_at) > DATE(OLD.updated_at) THEN
            NEW.imports_today_count := 0;
        END IF;
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_external_platforms_reset_counter
        BEFORE UPDATE ON socialcandor_schema.external_platforms
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.reset_daily_import_counter();

    -- Trigger for updated_at
    CREATE TRIGGER trg_external_platforms_updated_at
        BEFORE UPDATE ON socialcandor_schema.external_platforms
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 111 - network_dynamics_snapshots
    -- Description: Daily network health metrics for longitudinal analysis
    -- Business Case: Tracks platform virality and engagement health through network effects
    -- metrics while enabling early warning detection of network decay through connection
    -- strength trends. Supports strategic decision-making and growth forecasting.
    -- Feature Reference: NET05 (Network Health), ANL03 (Longitudinal Analysis), GROWTH01 (Growth Metrics)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.network_dynamics_snapshots (
        snapshot_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Snapshot timing
        snapshot_date DATE NOT NULL DEFAULT CURRENT_DATE,
        snapshot_hour INTEGER CHECK (snapshot_hour >= 0 AND snapshot_hour <= 23),
        snapshot_type VARCHAR(20) DEFAULT 'DAILY' CHECK (
            snapshot_type IN ('HOURLY', 'DAILY', 'WEEKLY', 'MONTHLY', 'QUARTERLY')
        ),

        -- User growth metrics
        total_users_count INTEGER NOT NULL CHECK (total_users_count >= 0),
        new_users_count INTEGER NOT NULL CHECK (new_users_count >= 0),
        active_users_count INTEGER NOT NULL CHECK (active_users_count >= 0),
        returning_users_count INTEGER NOT NULL CHECK (returning_users_count >= 0),

        -- Engagement metrics
        daily_active_users INTEGER CHECK (daily_active_users >= 0),
        weekly_active_users INTEGER CHECK (weekly_active_users >= 0),
        monthly_active_users INTEGER CHECK (monthly_active_users >= 0),
        stickiness_ratio NUMERIC(5,4) CHECK (stickiness_ratio >= 0 AND stickiness_ratio <= 1),

        -- Network structure metrics
        total_connections_count INTEGER NOT NULL CHECK (total_connections_count >= 0),
        new_connections_count INTEGER NOT NULL CHECK (new_connections_count >= 0),
        avg_connections_per_user NUMERIC(10,6) CHECK (avg_connections_per_user >= 0),
        network_density NUMERIC(10,6) CHECK (network_density >= 0 AND network_density <= 1),

        -- Content metrics
        total_content_items INTEGER CHECK (total_content_items >= 0),
        new_content_items INTEGER CHECK (new_content_items >= 0),
        avg_content_per_user NUMERIC(10,6) CHECK (avg_content_per_user >= 0),
        content_engagement_rate NUMERIC(5,2) CHECK (content_engagement_rate >= 0 AND content_engagement_rate <= 100),

        -- Virality metrics
        viral_coefficient NUMERIC(10,6) CHECK (viral_coefficient >= 0),
        k_factor NUMERIC(10,6) CHECK (k_factor >= 0),
        reproduction_rate NUMERIC(10,6) CHECK (reproduction_rate >= 0),

        -- Community health
        communities_count INTEGER CHECK (communities_count >= 0),
        avg_community_size NUMERIC(10,6) CHECK (avg_community_size >= 0),
        community_modularity NUMERIC(10,6) CHECK (community_modularity >= 0 AND community_modularity <= 1),

        -- Churn and retention
        churn_rate NUMERIC(5,2) CHECK (churn_rate >= 0 AND churn_rate <= 100),
        retention_rate_1_day NUMERIC(5,2) CHECK (retention_rate_1_day >= 0 AND retention_rate_1_day <= 100),
        retention_rate_7_day NUMERIC(5,2) CHECK (retention_rate_7_day >= 0 AND retention_rate_7_day <= 100),
        retention_rate_30_day NUMERIC(5,2) CHECK (retention_rate_30_day >= 0 AND retention_rate_30_day <= 100),

        -- Geographic distribution
        countries_represented_count INTEGER CHECK (countries_represented_count >= 0),
        top_country VARCHAR(3),
        top_country_percentage NUMERIC(5,2) CHECK (top_country_percentage >= 0 AND top_country_percentage <= 100),

        -- Device distribution
        mobile_users_percentage NUMERIC(5,2) CHECK (mobile_users_percentage >= 0 AND mobile_users_percentage <= 100),
        web_users_percentage NUMERIC(5,2) CHECK (web_users_percentage >= 0 AND web_users_percentage <= 100),

        -- Quality metrics
        spam_accounts_percentage NUMERIC(5,2) CHECK (spam_accounts_percentage >= 0 AND spam_accounts_percentage <= 100),
        fake_accounts_percentage NUMERIC(5,2) CHECK (fake_accounts_percentage >= 0 AND fake_accounts_percentage <= 100),
        trust_score_avg NUMERIC(5,2) CHECK (trust_score_avg >= 0 AND trust_score_avg <= 100),

        -- Trend indicators
        growth_momentum NUMERIC(10,6),
        network_health_index NUMERIC(5,2) CHECK (network_health_index >= 0 AND network_health_index <= 100),
        trend_direction VARCHAR(20) CHECK (trend_direction IN ('POSITIVE', 'NEUTRAL', 'NEGATIVE', 'ACCELERATING', 'DECELERATING')),

        -- Calculation metadata
        calculation_duration_seconds INTEGER CHECK (calculation_duration_seconds >= 0),
        data_freshness_minutes INTEGER CHECK (data_freshness_minutes >= 0),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Constraints
        CONSTRAINT uk_snapshot_timing UNIQUE (snapshot_date, snapshot_hour, snapshot_type),
        CONSTRAINT chk_active_users_consistency CHECK (
            active_users_count <= total_users_count AND
            returning_users_count <= active_users_count
        ),
        CONSTRAINT chk_retention_consistency CHECK (
            retention_rate_1_day >= retention_rate_7_day AND
            retention_rate_7_day >= retention_rate_30_day
        ),
        CONSTRAINT chk_network_density_valid CHECK (
            network_density IS NULL OR
            (network_density >= 0 AND network_density <= 1)
        )
    );

    COMMENT ON TABLE socialcandor_schema.network_dynamics_snapshots IS 'Daily network health metrics for longitudinal analysis and trend detection';
    COMMENT ON COLUMN socialcandor_schema.network_dynamics_snapshots.network_health_index IS 'Composite index (0-100) measuring overall network health';

    -- Indexes for network_dynamics_snapshots
    CREATE INDEX IF NOT EXISTS idx_network_snapshots_date ON socialcandor_schema.network_dynamics_snapshots(snapshot_date DESC);
    CREATE INDEX IF NOT EXISTS idx_network_snapshots_type ON socialcandor_schema.network_dynamics_snapshots(snapshot_type);
    CREATE INDEX IF NOT EXISTS idx_network_snapshots_health ON socialcandor_schema.network_dynamics_snapshots(network_health_index DESC);
    CREATE INDEX IF NOT EXISTS idx_network_snapshots_growth ON socialcandor_schema.network_dynamics_snapshots(growth_momentum DESC);
    CREATE INDEX IF NOT EXISTS idx_network_snapshots_users ON socialcandor_schema.network_dynamics_snapshots(active_users_count DESC);
    CREATE INDEX IF NOT EXISTS idx_network_snapshots_trend ON socialcandor_schema.network_dynamics_snapshots(trend_direction);

    -- Partition by date for time-series optimization
    -- Note: Uncomment if using partitioning
    -- CREATE TABLE socialcandor_schema.network_dynamics_snapshots_y2023 PARTITION OF socialcandor_schema.network_dynamics_snapshots
    -- FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');

    -- Trigger for updated_at
    CREATE TRIGGER trg_network_dynamics_snapshots_updated_at
        BEFORE UPDATE ON socialcandor_schema.network_dynamics_snapshots
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 112 - flagged_content
    -- Description: User-reported content tracking with review workflow
    -- Business Case: Creates community-powered moderation scaling while maintaining
    -- reporter anonymity and preventing retaliatory flagging through abuse detection
    -- on reporter patterns. Enables transparent moderation with community participation.
    -- Feature Reference: MOD05 (Community Moderation), SAF03 (Content Reporting), WF02 (Review Workflow)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.flagged_content (
        flag_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Content reference
        content_type VARCHAR(50) NOT NULL CHECK (
            content_type IN ('POST', 'COMMENT', 'MESSAGE', 'PROFILE', 'GROUP', 'PAGE', 'MEDIA')
        ),
        content_id UUID NOT NULL,
        content_owner_id UUID NOT NULL,

        -- Reporting information
        reporter_user_id UUID NOT NULL,
        reported_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        report_source VARCHAR(20) DEFAULT 'USER' CHECK (
            report_source IN ('USER', 'AI', 'MODERATOR', 'SYSTEM', 'TRUSTED_FLAGGER')
        ),

        -- Report details
        violation_categories VARCHAR(50)[] NOT NULL DEFAULT '{}',
        primary_violation_category VARCHAR(50) NOT NULL,
        report_reason TEXT,
        additional_context TEXT,

        -- Anonymity settings
        is_anonymous BOOLEAN DEFAULT TRUE,
        allow_contact BOOLEAN DEFAULT FALSE,

        -- Review workflow
        review_status VARCHAR(20) DEFAULT 'PENDING' CHECK (
            review_status IN ('PENDING', 'UNDER_REVIEW', 'RESOLVED', 'DISMISSED', 'ESCALATED', 'DUPLICATE')
        ),
        assigned_moderator_id UUID,
        assigned_at TIMESTAMP WITH TIME ZONE,
        review_priority INTEGER DEFAULT 3 CHECK (review_priority >= 1 AND review_priority <= 5),

        -- Resolution details
        resolution_status VARCHAR(20) CHECK (
            resolution_status IN ('VIOLATION_FOUND', 'NO_VIOLATION', 'EDITED', 'WARNING_ISSUED', 'REMOVED', 'SUSPENDED', 'BANNED')
        ),
        resolved_at TIMESTAMP WITH TIME ZONE,
        resolved_by UUID,
        resolution_notes TEXT,
        action_taken VARCHAR(100),

        -- Reporter feedback
        feedback_provided BOOLEAN DEFAULT FALSE,
        reporter_satisfaction_score INTEGER CHECK (reporter_satisfaction_score >= 1 AND reporter_satisfaction_score <= 5),
        reporter_feedback_comment TEXT,

        -- Abuse detection
        reporter_trust_score NUMERIC(5,2) DEFAULT 50.0 CHECK (reporter_trust_score >= 0 AND reporter_trust_score <= 100),
        is_abusive_flagging BOOLEAN DEFAULT FALSE,
        abusive_flagging_reason VARCHAR(200),

        -- Duplicate detection
        duplicate_flag_id UUID,
        duplicate_group_id UUID,
        duplicate_count INTEGER DEFAULT 0 CHECK (duplicate_count >= 0),

        -- Severity assessment
        severity_assessment socialcandor_schema.moderation_severity DEFAULT 'MEDIUM',
        impact_score NUMERIC(5,2) DEFAULT 0.0 CHECK (impact_score >= 0 AND impact_score <= 100),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_flagged_content_owner FOREIGN KEY (content_owner_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_flagged_content_reporter FOREIGN KEY (reporter_user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_flagged_content_moderator FOREIGN KEY (assigned_moderator_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
        CONSTRAINT fk_flagged_content_resolver FOREIGN KEY (resolved_by)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
        CONSTRAINT fk_flagged_content_duplicate FOREIGN KEY (duplicate_flag_id)
            REFERENCES socialcandor_schema.flagged_content(flag_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT uk_content_reporter UNIQUE (content_type, content_id, reporter_user_id) DEFERRABLE INITIALLY DEFERRED,
        CONSTRAINT chk_review_timeline CHECK (
            (assigned_at IS NULL OR assigned_at >= reported_at) AND
            (resolved_at IS NULL OR resolved_at >= assigned_at)
        ),
        CONSTRAINT chk_reporter_not_owner CHECK (
            reporter_user_id != content_owner_id
        ),
        CONSTRAINT chk_anonymous_settings CHECK (
            (is_anonymous = FALSE AND allow_contact = TRUE) OR
            (is_anonymous = TRUE AND allow_contact = FALSE) OR
            (is_anonymous = TRUE AND allow_contact = TRUE)
        )
    );

    COMMENT ON TABLE socialcandor_schema.flagged_content IS 'User-reported content tracking with review workflow and abuse detection';
    COMMENT ON COLUMN socialcandor_schema.flagged_content.reporter_trust_score IS 'Trust score based on reporter accuracy and history';

    -- Indexes for flagged_content
    CREATE INDEX IF NOT EXISTS idx_flagged_content_content ON socialcandor_schema.flagged_content(content_type, content_id);
    CREATE INDEX IF NOT EXISTS idx_flagged_content_owner ON socialcandor_schema.flagged_content(content_owner_id);
    CREATE INDEX IF NOT EXISTS idx_flagged_content_reporter ON socialcandor_schema.flagged_content(reporter_user_id);
    CREATE INDEX IF NOT EXISTS idx_flagged_content_status ON socialcandor_schema.flagged_content(review_status);
    CREATE INDEX IF NOT EXISTS idx_flagged_content_priority ON socialcandor_schema.flagged_content(review_priority, reported_at);
    CREATE INDEX IF NOT EXISTS idx_flagged_content_severity ON socialcandor_schema.flagged_content(severity_assessment);
    CREATE INDEX IF NOT EXISTS idx_flagged_content_duplicate ON socialcandor_schema.flagged_content(duplicate_group_id) WHERE duplicate_group_id IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_flagged_content_pending ON socialcandor_schema.flagged_content(assigned_moderator_id) WHERE review_status = 'PENDING';

    -- Trigger for duplicate detection
    CREATE OR REPLACE FUNCTION socialcandor_schema.detect_duplicate_flags()
    RETURNS TRIGGER AS $$
    DECLARE
        v_duplicate_group_id UUID;
        v_duplicate_count INTEGER;
    BEGIN
        -- Check for existing flags for same content within last 24 hours
        SELECT duplicate_group_id, COUNT(*)
        INTO v_duplicate_group_id, v_duplicate_count
        FROM socialcandor_schema.flagged_content
        WHERE content_type = NEW.content_type
        AND content_id = NEW.content_id
        AND reported_at >= CURRENT_TIMESTAMP - INTERVAL '24 hours'
        AND duplicate_group_id IS NOT NULL
        GROUP BY duplicate_group_id
        ORDER BY COUNT(*) DESC
        LIMIT 1;

        IF v_duplicate_group_id IS NOT NULL THEN
            NEW.duplicate_group_id := v_duplicate_group_id;
            NEW.duplicate_count := v_duplicate_count + 1;
            NEW.review_priority := LEAST(5, NEW.review_priority + 1); -- Increase priority with duplicates
        ELSE
            -- Create new duplicate group
            NEW.duplicate_group_id := uuid_generate_v4();
            NEW.duplicate_count := 0;
        END IF;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_flagged_content_duplicate_detection
        BEFORE INSERT ON socialcandor_schema.flagged_content
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.detect_duplicate_flags();

    -- Trigger for updated_at
    CREATE TRIGGER trg_flagged_content_updated_at
        BEFORE UPDATE ON socialcandor_schema.flagged_content
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

CREATE TABLE IF NOT EXISTS socialcandor_schema.developer_apps (
    client_id UUID PRIMARY KEY,
    client_name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Then create the api_logs table with the original foreign keys
-- (Use the original CREATE TABLE statement with foreign keys)


    ------------------------------------------------------------------------------------------------
    -- Table: 113 - api_logs
    -- Description: API request auditing with performance metrics
    -- Business Case: Enables API abuse detection and rate limiting while supporting
    -- developer relations through usage analytics for third-party integrations.
    -- Provides comprehensive monitoring for API health, performance, and security.
    -- Feature Reference: API01 (API Monitoring), SEC06 (API Security), DEV02 (Developer Analytics)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.api_logs (
        api_log_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Request identification
        request_id VARCHAR(100) UNIQUE NOT NULL,
        api_version VARCHAR(10) NOT NULL,
        endpoint_path VARCHAR(500) NOT NULL,
        http_method VARCHAR(10) NOT NULL CHECK (
            http_method IN ('GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS')
        ),

        -- Client information
        client_id UUID,
        client_name VARCHAR(100),
        client_type VARCHAR(20) CHECK (
            client_type IN ('WEB', 'MOBILE', 'DESKTOP', 'SERVER', 'BOT', 'INTEGRATION')
        ),
        user_agent TEXT,

        -- User context
        user_id UUID,
        user_ip INET NOT NULL,
        user_country VARCHAR(3),

        -- Request details
        request_headers JSONB DEFAULT '{}',
        request_query_params JSONB DEFAULT '{}',
        request_body_size_bytes INTEGER CHECK (request_body_size_bytes >= 0),
        request_body_hash VARCHAR(64),

        -- Response details
        response_status_code INTEGER NOT NULL CHECK (response_status_code >= 100 AND response_status_code <= 599),
        response_headers JSONB DEFAULT '{}',
        response_body_size_bytes INTEGER CHECK (response_body_size_bytes >= 0),
        response_time_ms INTEGER NOT NULL CHECK (response_time_ms >= 0),

        -- Performance metrics
        database_time_ms INTEGER CHECK (database_time_ms >= 0),
        cache_time_ms INTEGER CHECK (cache_time_ms >= 0),
        external_api_time_ms INTEGER CHECK (external_api_time_ms >= 0),
        processing_time_ms INTEGER CHECK (processing_time_ms >= 0),

        -- Error tracking
        error_code VARCHAR(50),
        error_message TEXT,
        error_stack_trace TEXT,
        error_category VARCHAR(50) CHECK (
            error_category IN ('VALIDATION', 'AUTHENTICATION', 'AUTHORIZATION', 'RATE_LIMIT', 'SERVER_ERROR', 'EXTERNAL_SERVICE')
        ),

        -- Rate limiting
        rate_limit_key VARCHAR(255),
        rate_limit_remaining INTEGER CHECK (rate_limit_remaining >= 0),
        rate_limit_reset TIMESTAMP WITH TIME ZONE,

        -- Security flags
        is_suspicious BOOLEAN DEFAULT FALSE,
        suspicious_reason VARCHAR(200),
        threat_score NUMERIC(5,2) DEFAULT 0.0 CHECK (threat_score >= 0 AND threat_score <= 100),

        -- Business context
        feature_name VARCHAR(100),
        business_unit VARCHAR(50),
        cost_center VARCHAR(50),

        -- Audit trail
        request_received_at TIMESTAMP WITH TIME ZONE NOT NULL,
        response_sent_at TIMESTAMP WITH TIME ZONE NOT NULL,

        -- Additional metadata
        additional_metadata JSONB DEFAULT '{}',
        tags VARCHAR(50)[] DEFAULT '{}',

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_api_logs_client FOREIGN KEY (client_id)
            REFERENCES socialcandor_schema.developer_apps(client_id) ON DELETE SET NULL,
        CONSTRAINT fk_api_logs_user FOREIGN KEY (user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_response_timing CHECK (
            response_sent_at >= request_received_at AND
            response_time_ms = EXTRACT(EPOCH FROM (response_sent_at - request_received_at)) * 1000
        ),
        CONSTRAINT chk_performance_breakdown CHECK (
            response_time_ms >= COALESCE(database_time_ms, 0) + COALESCE(cache_time_ms, 0) +
                               COALESCE(external_api_time_ms, 0) + COALESCE(processing_time_ms, 0)
        )
    );

    COMMENT ON TABLE socialcandor_schema.api_logs IS 'API request auditing with performance metrics, error tracking, and security monitoring';
    COMMENT ON COLUMN socialcandor_schema.api_logs.request_body_hash IS 'SHA-256 hash of request body for deduplication and debugging';

    -- Indexes for api_logs
    CREATE INDEX IF NOT EXISTS idx_api_logs_endpoint ON socialcandor_schema.api_logs(endpoint_path, http_method);
    CREATE INDEX IF NOT EXISTS idx_api_logs_user ON socialcandor_schema.api_logs(user_id);
    CREATE INDEX IF NOT EXISTS idx_api_logs_client ON socialcandor_schema.api_logs(client_id);
    CREATE INDEX IF NOT EXISTS idx_api_logs_status ON socialcandor_schema.api_logs(response_status_code);
    CREATE INDEX IF NOT EXISTS idx_api_logs_time ON socialcandor_schema.api_logs(request_received_at DESC);
    CREATE INDEX IF NOT EXISTS idx_api_logs_response_time ON socialcandor_schema.api_logs(response_time_ms DESC);
    CREATE INDEX IF NOT EXISTS idx_api_logs_error ON socialcandor_schema.api_logs(error_code) WHERE error_code IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_api_logs_suspicious ON socialcandor_schema.api_logs(is_suspicious) WHERE is_suspicious = TRUE;
    CREATE INDEX IF NOT EXISTS idx_api_logs_ip ON socialcandor_schema.api_logs(user_ip);


-- -- Add foreign key constraints after tables are created
-- ALTER TABLE socialcandor_schema.api_logs 
--     ADD CONSTRAINT fk_api_logs_client 
--     FOREIGN KEY (client_id) 
--     REFERENCES socialcandor_schema.developer_apps(client_id) 
--     ON DELETE SET NULL;

-- ALTER TABLE socialcandor_schema.api_logs 
--     ADD CONSTRAINT fk_api_logs_user 
--     FOREIGN KEY (user_id) 
--     REFERENCES socialcandor_schema.users(user_id) 
--     ON DELETE SET NULL;

    -- Time-series partitioning (if using TimescaleDB)
    -- SELECT create_hypertable('socialcandor_schema.api_logs', 'request_received_at');

    -- Materialized view for API performance summary
    CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_api_performance_summary AS
    SELECT
        endpoint_path,
        http_method,
        api_version,
        COUNT(*) AS total_requests,
        COUNT(*) FILTER (WHERE response_status_code >= 200 AND response_status_code < 300) AS successful_requests,
        COUNT(*) FILTER (WHERE response_status_code >= 400 AND response_status_code < 500) AS client_errors,
        COUNT(*) FILTER (WHERE response_status_code >= 500) AS server_errors,
        AVG(response_time_ms) AS avg_response_time,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY response_time_ms) AS p95_response_time,
        PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY response_time_ms) AS p99_response_time,
        MIN(request_received_at) AS first_request,
        MAX(request_received_at) AS last_request
    FROM socialcandor_schema.api_logs
    WHERE request_received_at >= CURRENT_TIMESTAMP - INTERVAL '24 hours'
    GROUP BY endpoint_path, http_method, api_version
    WITH DATA;

    CREATE UNIQUE INDEX idx_mv_api_performance_endpoint ON socialcandor_schema.mv_api_performance_summary(endpoint_path, http_method, api_version);

    -- Trigger for updated_at
    CREATE TRIGGER trg_api_logs_updated_at
        BEFORE UPDATE ON socialcandor_schema.api_logs
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 114 - data_profiling_log
    -- Description: Historical data quality profiling results for drift detection
    -- Business Case: Enables proactive data pipeline monitoring while supporting
    -- regulatory compliance through documented data quality assurance processes.
    -- Detects data anomalies, schema drift, and quality degradation over time.
    -- Feature Reference: DQ03 (Data Profiling), MON04 (Data Monitoring), COMP05 (Data Compliance)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.data_profiling_log (
        profiling_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Profiling context
        table_name VARCHAR(200) NOT NULL,
        schema_name VARCHAR(100) NOT NULL DEFAULT 'social',
        profiling_type VARCHAR(50) NOT NULL CHECK (
            profiling_type IN ('FULL', 'INCREMENTAL', 'TARGETED', 'SCHEDULED', 'ON_DEMAND')
        ),

        -- Timing information
        profiling_started_at TIMESTAMP WITH TIME ZONE NOT NULL,
        profiling_completed_at TIMESTAMP WITH TIME ZONE NOT NULL,
        profiling_duration_seconds INTEGER GENERATED ALWAYS AS (
            EXTRACT(EPOCH FROM (profiling_completed_at - profiling_started_at))
        ) STORED,

        -- Table statistics
        total_row_count BIGINT NOT NULL CHECK (total_row_count >= 0),
        total_column_count INTEGER NOT NULL CHECK (total_column_count >= 1),
        table_size_bytes BIGINT CHECK (table_size_bytes >= 0),
        index_size_bytes BIGINT CHECK (index_size_bytes >= 0),

        -- Column statistics (aggregated)
        numeric_column_count INTEGER CHECK (numeric_column_count >= 0),
        text_column_count INTEGER CHECK (text_column_count >= 0),
        date_column_count INTEGER CHECK (date_column_count >= 0),
        json_column_count INTEGER CHECK (json_column_count >= 0),

        -- Data quality metrics
        overall_quality_score NUMERIC(5,2) CHECK (overall_quality_score >= 0 AND overall_quality_score <= 100),
        completeness_score NUMERIC(5,2) CHECK (completeness_score >= 0 AND completeness_score <= 100),
        accuracy_score NUMERIC(5,2) CHECK (accuracy_score >= 0 AND accuracy_score <= 100),
        consistency_score NUMERIC(5,2) CHECK (consistency_score >= 0 AND consistency_score <= 100),
        timeliness_score NUMERIC(5,2) CHECK (timeliness_score >= 0 AND timeliness_score <= 100),

        -- Anomaly detection
        anomaly_count INTEGER DEFAULT 0 CHECK (anomaly_count >= 0),
        critical_anomaly_count INTEGER DEFAULT 0 CHECK (critical_anomaly_count >= 0),
        anomaly_types VARCHAR(50)[] DEFAULT '{}',

        -- Drift detection
        schema_drift_detected BOOLEAN DEFAULT FALSE,
        data_drift_detected BOOLEAN DEFAULT FALSE,
        drift_metrics JSONB DEFAULT '{}',

        -- Performance metrics
        profiling_success_rate NUMERIC(5,2) CHECK (profiling_success_rate >= 0 AND profiling_success_rate <= 100),
        memory_usage_mb INTEGER CHECK (memory_usage_mb >= 0),
        cpu_usage_percent NUMERIC(5,2) CHECK (cpu_usage_percent >= 0 AND cpu_usage_percent <= 100),

        -- Detailed findings
        column_profiles JSONB DEFAULT '{}',
        constraint_violations JSONB DEFAULT '{}',
        pattern_violations JSONB DEFAULT '{}',
        outlier_detections JSONB DEFAULT '{}',

        -- Comparison with baseline
        baseline_profiling_id UUID,
        comparison_metrics JSONB DEFAULT '{}',
        change_percentage NUMERIC(10,6),

        -- Alerting and notification
        alert_generated BOOLEAN DEFAULT FALSE,
        alert_severity socialcandor_schema.moderation_severity,
        alert_message TEXT,

        -- Execution context
        execution_environment VARCHAR(50) CHECK (
            execution_environment IN ('PRODUCTION', 'STAGING', 'DEVELOPMENT', 'TEST')
        ),
        profiling_tool_version VARCHAR(50),

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_data_profiling_baseline FOREIGN KEY (baseline_profiling_id)
            REFERENCES socialcandor_schema.data_profiling_log(profiling_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_profiling_timing CHECK (
            profiling_completed_at > profiling_started_at AND
            profiling_started_at >= created_at
        ),
        CONSTRAINT chk_quality_scores CHECK (
            overall_quality_score = (completeness_score + accuracy_score + consistency_score + timeliness_score) / 4 OR
            overall_quality_score IS NULL
        ),
        CONSTRAINT chk_anomaly_counts CHECK (
            critical_anomaly_count <= anomaly_count
        )
    );

    COMMENT ON TABLE socialcandor_schema.data_profiling_log IS 'Historical data quality profiling results for drift detection and monitoring';
    COMMENT ON COLUMN socialcandor_schema.data_profiling_log.drift_metrics IS 'Metrics quantifying data distribution changes over time';

    -- Indexes for data_profiling_log
    CREATE INDEX IF NOT EXISTS idx_data_profiling_table ON socialcandor_schema.data_profiling_log(table_name, profiling_started_at DESC);
    CREATE INDEX IF NOT EXISTS idx_data_profiling_timing ON socialcandor_schema.data_profiling_log(profiling_started_at DESC);
    CREATE INDEX IF NOT EXISTS idx_data_profiling_quality ON socialcandor_schema.data_profiling_log(overall_quality_score);
    CREATE INDEX IF NOT EXISTS idx_data_profiling_anomaly ON socialcandor_schema.data_profiling_log(anomaly_count DESC);
    CREATE INDEX IF NOT EXISTS idx_data_profiling_drift ON socialcandor_schema.data_profiling_log(data_drift_detected) WHERE data_drift_detected = TRUE;
    CREATE INDEX IF NOT EXISTS idx_data_profiling_alert ON socialcandor_schema.data_profiling_log(alert_generated) WHERE alert_generated = TRUE;
    CREATE INDEX IF NOT EXISTS idx_data_profiling_baseline ON socialcandor_schema.data_profiling_log(baseline_profiling_id) WHERE baseline_profiling_id IS NOT NULL;

    -- Trigger for updated_at
    CREATE TRIGGER trg_data_profiling_log_updated_at
        BEFORE UPDATE ON socialcandor_schema.data_profiling_log
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 115 - content_moderation_audit_log
    -- Description: Immutable moderation decision audit trail with context snapshots
    -- Business Case: Meets EU Digital Services Act transparency requirements while enabling
    -- moderator training through decision pattern analysis and bias detection. Provides
    -- defensible audit trail for regulatory compliance and user appeals.
    -- Feature Reference: MOD06 (Audit Trail), COMP06 (Regulatory Compliance), TRN01 (Moderator Training)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.content_moderation_audit_log (
        audit_log_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

        -- Content reference
        content_type VARCHAR(50) NOT NULL CHECK (
            content_type IN ('POST', 'COMMENT', 'MESSAGE', 'PROFILE', 'GROUP', 'PAGE', 'MEDIA', 'USER')
        ),
        content_id UUID NOT NULL,
        content_owner_id UUID NOT NULL,

        -- Moderation action
        action_type VARCHAR(50) NOT NULL CHECK (
            action_type IN ('APPROVE', 'REJECT', 'REMOVE', 'WARN', 'SUSPEND', 'BAN', 'EDIT', 'ESCALATE', 'OVERRIDE')
        ),
        action_taken_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,

        -- Decision maker
        moderator_user_id UUID NOT NULL,
        moderator_role VARCHAR(50) CHECK (
            moderator_role IN ('HUMAN_MODERATOR', 'AI_MODERATOR', 'ADMIN', 'TRUSTED_FLAGGER', 'SYSTEM')
        ),
        is_automated_action BOOLEAN DEFAULT FALSE,

        -- Decision context
        decision_reason TEXT NOT NULL,
        violation_categories VARCHAR(50)[] DEFAULT '{}',
        severity_assessment socialcandor_schema.moderation_severity,
        confidence_score NUMERIC(5,2) CHECK (confidence_score >= 0 AND confidence_score <= 100),

        -- Content snapshot
        content_snapshot JSONB NOT NULL,
        content_metadata JSONB DEFAULT '{}',
        context_snapshot JSONB DEFAULT '{}',

        -- Policy reference
        policy_version VARCHAR(50) NOT NULL,
        policy_section VARCHAR(100),
        guideline_references VARCHAR(100)[] DEFAULT '{}',

        -- Appeal information
        appeal_status VARCHAR(20) DEFAULT 'NONE' CHECK (
            appeal_status IN ('NONE', 'PENDING', 'UNDER_REVIEW', 'GRANTED', 'DENIED')
        ),
        appeal_reference_id UUID,

        -- Override information
        is_override BOOLEAN DEFAULT FALSE,
        overridden_decision_id UUID,
        override_reason TEXT,

        -- Impact assessment
        impact_score NUMERIC(5,2) CHECK (impact_score >= 0 AND impact_score <= 100),
        affected_users_count INTEGER CHECK (affected_users_count >= 0),
        visibility_change VARCHAR(20) CHECK (
            visibility_change IN ('NONE', 'REDUCED', 'REMOVED', 'RESTRICTED', 'AMPLIFIED')
        ),

        -- Quality assurance
        quality_check_passed BOOLEAN,
        quality_checker_id UUID,
        quality_check_notes TEXT,

        -- Training data
        is_training_example BOOLEAN DEFAULT FALSE,
        training_feedback TEXT,

        -- System metadata
        session_id VARCHAR(100),
        ip_address INET,
        user_agent TEXT,

        -- Hash for integrity verification
        integrity_hash VARCHAR(64) NOT NULL,
        previous_hash VARCHAR(64),

        -- Immutable audit trail
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraints
        CONSTRAINT fk_moderation_audit_owner FOREIGN KEY (content_owner_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE CASCADE,
        CONSTRAINT fk_moderation_audit_moderator FOREIGN KEY (moderator_user_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE RESTRICT,
        CONSTRAINT fk_moderation_audit_quality_checker FOREIGN KEY (quality_checker_id)
            REFERENCES socialcandor_schema.users(user_id) ON DELETE SET NULL,
        CONSTRAINT fk_moderation_audit_override FOREIGN KEY (overridden_decision_id)
            REFERENCES socialcandor_schema.content_moderation_audit_log(audit_log_id) ON DELETE SET NULL,

        -- Constraints
        CONSTRAINT chk_integrity_hash CHECK (
            integrity_hash = encode(
                digest(
                    content_type || content_id || action_type || moderator_user_id || decision_reason || content_snapshot::text || previous_hash,
                    'sha256'
                ),
                'hex'
            )
        ),
        CONSTRAINT chk_automated_confidence CHECK (
            (is_automated_action = FALSE AND confidence_score IS NULL) OR
            (is_automated_action = TRUE AND confidence_score IS NOT NULL)
        ),
        CONSTRAINT chk_appeal_reference CHECK (
            (appeal_status = 'NONE' AND appeal_reference_id IS NULL) OR
            (appeal_status != 'NONE' AND appeal_reference_id IS NOT NULL)
        )
    );

    COMMENT ON TABLE socialcandor_schema.content_moderation_audit_log IS 'Immutable moderation decision audit trail with context snapshots and integrity verification';
    COMMENT ON COLUMN socialcandor_schema.content_moderation_audit_log.integrity_hash IS 'SHA-256 hash for blockchain-like integrity verification';

    -- Indexes for content_moderation_audit_log
    CREATE INDEX IF NOT EXISTS idx_moderation_audit_content ON socialcandor_schema.content_moderation_audit_log(content_type, content_id);
    CREATE INDEX IF NOT EXISTS idx_moderation_audit_owner ON socialcandor_schema.content_moderation_audit_log(content_owner_id);
    CREATE INDEX IF NOT EXISTS idx_moderation_audit_moderator ON socialcandor_schema.content_moderation_audit_log(moderator_user_id);
    CREATE INDEX IF NOT EXISTS idx_moderation_audit_action ON socialcandor_schema.content_moderation_audit_log(action_type, action_taken_at DESC);
    CREATE INDEX IF NOT EXISTS idx_moderation_audit_severity ON socialcandor_schema.content_moderation_audit_log(severity_assessment);
    CREATE INDEX IF NOT EXISTS idx_moderation_audit_appeal ON socialcandor_schema.content_moderation_audit_log(appeal_status);
    CREATE INDEX IF NOT EXISTS idx_moderation_audit_override ON socialcandor_schema.content_moderation_audit_log(is_override) WHERE is_override = TRUE;
    CREATE INDEX IF NOT EXISTS idx_moderation_audit_training ON socialcandor_schema.content_moderation_audit_log(is_training_example) WHERE is_training_example = TRUE;

    -- Trigger for integrity hash calculation
    CREATE OR REPLACE FUNCTION socialcandor_schema.calculate_moderation_audit_hash()
    RETURNS TRIGGER AS $$
    DECLARE
        v_previous_hash VARCHAR(64);
    BEGIN
        -- Get previous hash for this content
        SELECT integrity_hash INTO v_previous_hash
        FROM socialcandor_schema.content_moderation_audit_log
        WHERE content_type = NEW.content_type
        AND content_id = NEW.content_id
        ORDER BY action_taken_at DESC
        LIMIT 1;

        NEW.previous_hash := v_previous_hash;

        -- Calculate new integrity hash
        NEW.integrity_hash := encode(
            digest(
                NEW.content_type || NEW.content_id || NEW.action_type ||
                NEW.moderator_user_id || NEW.decision_reason ||
                NEW.content_snapshot::text || COALESCE(v_previous_hash, ''),
                'sha256'
            ),
            'hex'
        );

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER trg_moderation_audit_hash
        BEFORE INSERT ON socialcandor_schema.content_moderation_audit_log
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.calculate_moderation_audit_hash();

    -- Trigger for updated_at
    CREATE TRIGGER trg_content_moderation_audit_log_updated_at
        BEFORE UPDATE ON socialcandor_schema.content_moderation_audit_log
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();

    ------------------------------------------------------------------------------------------------
    -- Table: 116 - post_metrics
    -- Description: Normalized engagement counters decoupled from posts table
    -- Business Case: Enables high-velocity counter updates without post table locking
    -- while supporting eventual consistency patterns for engagement metrics during
    -- traffic spikes. Improves write performance and scalability for engagement tracking.
    -- Feature Reference: ENG08 (Performance Optimization), SCAL01 (Scalability), PERF07 (High-Velocity Writes)
    ------------------------------------------------------------------------------------------------
    CREATE TABLE IF NOT EXISTS socialcandor_schema.post_metrics (
        post_metric_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        post_id UUID NOT NULL,

        -- Timing information
        metric_date DATE NOT NULL DEFAULT CURRENT_DATE,
        metric_hour INTEGER CHECK (metric_hour >= 0 AND metric_hour <= 23),
        aggregation_window VARCHAR(20) DEFAULT 'HOURLY' CHECK (
            aggregation_window IN ('HOURLY', 'DAILY', 'WEEKLY', 'MONTHLY', 'REALTIME')
        ),

        -- Core engagement metrics
        view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
        unique_view_count INTEGER DEFAULT 0 CHECK (unique_view_count >= 0),
        like_count INTEGER DEFAULT 0 CHECK (like_count >= 0),
        unique_like_count INTEGER DEFAULT 0 CHECK (unique_like_count >= 0),
        comment_count INTEGER DEFAULT 0 CHECK (comment_count >= 0),
        unique_comment_count INTEGER DEFAULT 0 CHECK (unique_comment_count >= 0),
        share_count INTEGER DEFAULT 0 CHECK (share_count >= 0),
        unique_share_count INTEGER DEFAULT 0 CHECK (unique_share_count >= 0),
        save_count INTEGER DEFAULT 0 CHECK (save_count >= 0),
        unique_save_count INTEGER DEFAULT 0 CHECK (unique_save_count >= 0),

        -- Derived metrics
        engagement_rate NUMERIC(10,6) DEFAULT 0.0 CHECK (engagement_rate >= 0 AND engagement_rate <= 1),
        viral_coefficient NUMERIC(10,6) DEFAULT 0.0,
        amplification_rate NUMERIC(10,6) DEFAULT 0.0,

        -- User engagement distribution
        engaged_users_count INTEGER DEFAULT 0 CHECK (engaged_users_count >= 0),
        new_engagers_count INTEGER DEFAULT 0 CHECK (new_engagers_count >= 0),
        returning_engagers_count INTEGER DEFAULT 0 CHECK (returning_engagers_count >= 0),

        -- Time-based metrics
        avg_time_spent_seconds NUMERIC(10,2) CHECK (avg_time_spent_seconds >= 0),
        completion_rate NUMERIC(5,2) CHECK (completion_rate >= 0 AND completion_rate <= 100),
        bounce_rate NUMERIC(5,2) CHECK (bounce_rate >= 0 AND bounce_rate <= 100),

        -- Geographic distribution
        countries_engaged JSONB DEFAULT '{}',
        cities_engaged JSONB DEFAULT '{}',
        top_country VARCHAR(3),
        top_city VARCHAR(100),

        -- Device distribution
        devices_engaged JSONB DEFAULT '{}',
        top_device_type VARCHAR(50),
        mobile_engagement_percentage NUMERIC(5,2) CHECK (mobile_engagement_percentage >= 0 AND mobile_engagement_percentage <= 100),

        -- Source distribution
        sources_engaged JSONB DEFAULT '{}',
        top_source VARCHAR(50),
        organic_engagement_percentage NUMERIC(5,2) CHECK (organic_engagement_percentage >= 0 AND organic_engagement_percentage <= 100),

        -- Quality metrics
        spam_engagement_count INTEGER DEFAULT 0 CHECK (spam_engagement_count >= 0),
        fake_engagement_count INTEGER DEFAULT 0 CHECK (fake_engagement_count >= 0),
        quality_engagement_score NUMERIC(5,2) DEFAULT 0.0 CHECK (quality_engagement_score >= 0 AND quality_engagement_score <= 100),

        -- Trend indicators
        engagement_velocity NUMERIC(10,2) DEFAULT 0.0,
        acceleration NUMERIC(10,2) DEFAULT 0.0,
        trend_direction VARCHAR(20) CHECK (trend_direction IN ('UP', 'DOWN', 'STABLE', 'ACCELERATING', 'DECELERATING')),

        -- Update tracking
        last_updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updates_count INTEGER DEFAULT 0 CHECK (updates_count >= 0),
        is_consolidated BOOLEAN DEFAULT FALSE,

        -- Audit and metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        created_by UUID NOT NULL,
        updated_by UUID DEFAULT uuid_nil(),

        -- Foreign key constraint
        CONSTRAINT fk_post_metrics_post FOREIGN KEY (post_id)
            REFERENCES socialcandor_schema.posts(post_id) ON DELETE CASCADE,

        -- Constraints
        CONSTRAINT uk_post_metrics_window UNIQUE (post_id, metric_date, metric_hour, aggregation_window),
        CONSTRAINT chk_unique_counts CHECK (
            unique_view_count <= view_count AND
            unique_like_count <= like_count AND
            unique_comment_count <= comment_count AND
            unique_share_count <= share_count AND
            unique_save_count <= save_count
        ),
        CONSTRAINT chk_engagement_calculation CHECK (
            engaged_users_count >= new_engagers_count + returning_engagers_count
        ),
        CONSTRAINT chk_quality_metrics CHECK (
            quality_engagement_score = 100 - ((spam_engagement_count + fake_engagement_count) / GREATEST(engaged_users_count, 1) * 100) OR
            quality_engagement_score = 0
        )
    );

    COMMENT ON TABLE socialcandor_schema.post_metrics IS 'Normalized engagement counters decoupled from posts table for high-velocity updates';
    COMMENT ON COLUMN socialcandor_schema.post_metrics.quality_engagement_score IS 'Score (0-100) measuring engagement quality after spam/fake filtering';

    -- Indexes for post_metrics
    CREATE INDEX IF NOT EXISTS idx_post_metrics_post ON socialcandor_schema.post_metrics(post_id);
    CREATE INDEX IF NOT EXISTS idx_post_metrics_date ON socialcandor_schema.post_metrics(metric_date DESC, metric_hour DESC);
    CREATE INDEX IF NOT EXISTS idx_post_metrics_window ON socialcandor_schema.post_metrics(aggregation_window);
    CREATE INDEX IF NOT EXISTS idx_post_metrics_engagement ON socialcandor_schema.post_metrics(engagement_rate DESC);
    CREATE INDEX IF NOT EXISTS idx_post_metrics_velocity ON socialcandor_schema.post_metrics(engagement_velocity DESC);
    CREATE INDEX IF NOT EXISTS idx_post_metrics_consolidated ON socialcandor_schema.post_metrics(is_consolidated) WHERE is_consolidated = FALSE;
    CREATE INDEX IF NOT EXISTS idx_post_metrics_composite ON socialcandor_schema.post_metrics(post_id, metric_date DESC, engagement_rate DESC);

    -- Partition by date for time-series optimization
    -- CREATE TABLE socialcandor_schema.post_metrics_y2023 PARTITION OF socialcandor_schema.post_metrics
    -- FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');

    -- Materialized view for daily aggregated metrics
    CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_post_daily_metrics AS
    SELECT
        post_id,
        metric_date,
        SUM(view_count) AS total_views,
        SUM(unique_view_count) AS total_unique_views,
        SUM(like_count) AS total_likes,
        SUM(unique_like_count) AS total_unique_likes,
        SUM(comment_count) AS total_comments,
        SUM(unique_comment_count) AS total_unique_comments,
        SUM(share_count) AS total_shares,
        SUM(unique_share_count) AS total_unique_shares,
        AVG(engagement_rate) AS avg_engagement_rate,
        MAX(engagement_velocity) AS peak_engagement_velocity,
        COUNT(*) AS hourly_metrics_count
    FROM socialcandor_schema.post_metrics
    WHERE aggregation_window = 'HOURLY'
    AND metric_date >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY post_id, metric_date
    WITH DATA;

    CREATE UNIQUE INDEX idx_mv_post_daily_metrics_post_date ON socialcandor_schema.mv_post_daily_metrics(post_id, metric_date);

    -- Trigger for consolidating hourly to daily metrics
    CREATE OR REPLACE FUNCTION socialcandor_schema.consolidate_post_metrics()
    RETURNS TRIGGER AS $$
    BEGIN
        -- Mark hourly metrics as consolidated when daily aggregation is created
        UPDATE socialcandor_schema.post_metrics
        SET is_consolidated = TRUE,
            updated_at = CURRENT_TIMESTAMP
        WHERE post_id = NEW.post_id
        AND metric_date = NEW.metric_date
        AND aggregation_window = 'HOURLY'
        AND is_consolidated = FALSE;

        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Trigger for updated_at
    CREATE TRIGGER trg_post_metrics_updated_at
        BEFORE UPDATE ON socialcandor_schema.post_metrics
        FOR EACH ROW
        EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();



------------------------------------------------------------------------------------------------
-- View: 117 - vw_user_profiles
-- Description: Unified user profile presentation with aggregated statistics
-- Business Case: Eliminates N+1 query problems in profile rendering while maintaining
-- real-time accuracy. Provides comprehensive user profile view with friend counts,
-- post counts, and engagement metrics for fast profile page rendering.
-- Feature Reference: US02 (Profile Management), PERF01 (Performance Optimization)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE VIEW socialcandor_schema.vw_user_profiles AS
SELECT
    u.user_id,
    u.username,
    u.email,
    u.display_name,
    u.first_name,
    u.last_name,
    u.full_name,
    u.profile_image_url,
    u.cover_image_url,
    u.bio,
    u.website,
    u.date_of_birth,
    u.gender,
    u.preferred_language,
    u.timezone,
    u.status,
    u.verified,
    u.verification_level,
    u.trust_score,
    u.is_premium_user,
    u.premium_expires_at,
    u.created_at,
    u.last_active_at,
    
    -- Account age calculation
    DATE_PART('day', CURRENT_TIMESTAMP - u.created_at)::INTEGER AS account_age_days,

    -- Aggregated statistics
    COALESCE(f.friend_count, 0) AS friend_count,
    COALESCE(fl_followers.follower_count, 0) AS follower_count,
    COALESCE(fl_following.following_count, 0) AS following_count,
    COALESCE(p.post_count, 0) AS post_count,
    COALESCE(p.total_likes_received, 0) AS total_likes_received,
    COALESCE(p.total_comments_received, 0) AS total_comments_received,
    COALESCE(g.group_count, 0) AS group_count,
    COALESCE(pa.page_count, 0) AS page_count,

    -- Engagement metrics
    CASE
        WHEN DATE_PART('day', CURRENT_TIMESTAMP - u.created_at) > 0
        THEN ROUND((COALESCE(p.post_count, 0)::NUMERIC / DATE_PART('day', CURRENT_TIMESTAMP - u.created_at))::NUMERIC, 2)
        ELSE 0
    END AS avg_posts_per_day,

    CASE
        WHEN COALESCE(p.post_count, 0) > 0
        THEN ROUND((COALESCE(p.total_likes_received, 0)::NUMERIC / COALESCE(p.post_count, 1)::NUMERIC)::NUMERIC, 2)
        ELSE 0
    END AS avg_likes_per_post,

    -- Activity indicators
    CASE
        WHEN u.last_active_at >= CURRENT_TIMESTAMP - INTERVAL '1 hour' THEN 'ONLINE'
        WHEN u.last_active_at >= CURRENT_TIMESTAMP - INTERVAL '1 day' THEN 'RECENT'
        WHEN u.last_active_at >= CURRENT_TIMESTAMP - INTERVAL '7 days' THEN 'ACTIVE'
        WHEN u.last_active_at >= CURRENT_TIMESTAMP - INTERVAL '30 days' THEN 'OCCASIONAL'
        ELSE 'INACTIVE'
    END AS activity_status,

    -- Trust indicators
    CASE
        WHEN u.trust_score >= 90 THEN 'VERY_HIGH'
        WHEN u.trust_score >= 75 THEN 'HIGH'
        WHEN u.trust_score >= 50 THEN 'MEDIUM'
        WHEN u.trust_score >= 25 THEN 'LOW'
        ELSE 'VERY_LOW'
    END AS trust_level

FROM socialcandor_schema.users u

-- Friend count subquery
LEFT JOIN (
    SELECT
        user_id,
        COUNT(*) AS friend_count
    FROM socialcandor_schema.friends
    WHERE status = 'ACCEPTED' AND is_mutual = TRUE
    GROUP BY user_id
) f ON u.user_id = f.user_id

-- Following count subquery (users this user is following)
LEFT JOIN (
    SELECT
        follower_user_id AS user_id,
        COUNT(*) AS following_count
    FROM socialcandor_schema.followings
    WHERE is_active = TRUE
    GROUP BY follower_user_id
) fl_following ON u.user_id = fl_following.user_id

-- Follower count subquery (users following this user)
LEFT JOIN (
    SELECT
        following_user_id AS user_id,
        COUNT(*) AS follower_count
    FROM socialcandor_schema.followings
    WHERE is_active = TRUE
    GROUP BY following_user_id
) fl_followers ON u.user_id = fl_followers.user_id

-- Post statistics subquery
LEFT JOIN (
    SELECT
        user_id,
        COUNT(*) AS post_count,
        SUM(like_count) AS total_likes_received,
        SUM(comment_count) AS total_comments_received
    FROM socialcandor_schema.posts
    WHERE moderation_status = 'APPROVED'
    GROUP BY user_id
) p ON u.user_id = p.user_id

-- Group membership subquery
LEFT JOIN (
    SELECT
        user_id,
        COUNT(*) AS group_count
    FROM socialcandor_schema.groups_members
    WHERE membership_status = 'APPROVED'
    GROUP BY user_id
) g ON u.user_id = g.user_id

-- Page ownership subquery
LEFT JOIN (
    SELECT
        owner_user_id AS user_id,
        COUNT(*) AS page_count
    FROM socialcandor_schema.pages
    WHERE is_active = TRUE
    GROUP BY owner_user_id
) pa ON u.user_id = pa.user_id;

COMMENT ON VIEW socialcandor_schema.vw_user_profiles IS 'Unified user profile presentation with aggregated statistics for fast rendering';
COMMENT ON COLUMN socialcandor_schema.vw_user_profiles.account_age_days IS 'Number of days since account creation';
COMMENT ON COLUMN socialcandor_schema.vw_user_profiles.friend_count IS 'Number of mutual accepted friends';
COMMENT ON COLUMN socialcandor_schema.vw_user_profiles.follower_count IS 'Number of users following this user';
COMMENT ON COLUMN socialcandor_schema.vw_user_profiles.following_count IS 'Number of users this user is following';
COMMENT ON COLUMN socialcandor_schema.vw_user_profiles.post_count IS 'Number of approved posts';
COMMENT ON COLUMN socialcandor_schema.vw_user_profiles.activity_status IS 'User activity level based on last_active_at';
COMMENT ON COLUMN socialcandor_schema.vw_user_profiles.trust_level IS 'Trust level based on trust_score';


------------------------------------------------------------------------------------------------
-- View: 118 - vw_post_engagement
-- Description: Normalized engagement scoring across content types
-- Business Case: Enables fair content comparison in algorithmic feeds while supporting
-- engagement-based monetization (creator payouts proportional to engagement quality,
-- not just quantity). Calculates weighted engagement scores considering different
-- interaction types and time decay for trending content ranking.
-- Feature Reference: ENG01 (Engagement Analytics), REC01 (Recommendation System), MON01 (Monetization)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE VIEW socialcandor_schema.vw_post_engagement AS
WITH engagement_metrics AS (
    SELECT
        p.post_id,
        p.user_id,
        p.content_type,
        p.created_at,
        p.visibility,
        p.language_code,

        -- Raw engagement counts
        p.like_count,
        p.comment_count,
        p.share_count,
        p.view_count,
        p.save_count,
        p.tip_amount_total,

        -- Weighted engagement score
        -- Likes: 1 point, Comments: 3 points, Shares: 5 points, Saves: 2 points, Views: 0.01 points
        (p.like_count * 1.0) +
        (p.comment_count * 3.0) +
        (p.share_count * 5.0) +
        (p.save_count * 2.0) +
        (p.view_count * 0.01) AS raw_engagement_score,

        -- Engagement velocity (engagement per hour)
        CASE
            WHEN EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - p.created_at)) / 3600 > 0
            THEN ((p.like_count * 1.0) + (p.comment_count * 3.0) + (p.share_count * 5.0)) /
                 (EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - p.created_at)) / 3600)
            ELSE 0
        END AS engagement_velocity,

        -- Engagement rate (engagement per view)
        CASE
            WHEN p.view_count > 0
            THEN ((p.like_count + p.comment_count + p.share_count)::NUMERIC / p.view_count) * 100
            ELSE 0
        END AS engagement_rate_percent,

        -- Viral coefficient (shares per view)
        CASE
            WHEN p.view_count > 0
            THEN p.share_count::NUMERIC / p.view_count
            ELSE 0
        END AS viral_coefficient,

        -- Quality-adjusted engagement
        (p.like_count * 1.0 * COALESCE(p.quality_score, 50) / 100) +
        (p.comment_count * 3.0 * COALESCE(p.quality_score, 50) / 100) +
        (p.share_count * 5.0 * COALESCE(p.quality_score, 50) / 100) AS quality_adjusted_score

    FROM socialcandor_schema.posts p
    WHERE p.moderation_status = 'APPROVED'
    AND p.visibility IN ('PUBLIC', 'FRIENDS')
),
user_metrics AS (
    SELECT
        user_id,
        COUNT(*) as total_posts,
        AVG(like_count) as avg_likes_per_post,
        AVG(comment_count) as avg_comments_per_post,
        AVG(engagement_rate_percent) as avg_engagement_rate
    FROM engagement_metrics
    GROUP BY user_id
),
content_type_metrics AS (
    SELECT
        content_type,
        COUNT(*) as total_posts,
        AVG(raw_engagement_score) as avg_engagement_score,
        AVG(engagement_rate_percent) as avg_engagement_rate,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY raw_engagement_score) as median_engagement_score
    FROM engagement_metrics
    GROUP BY content_type
)
SELECT
    e.*,
    u.total_posts as user_total_posts,
    u.avg_likes_per_post as user_avg_likes,
    u.avg_comments_per_post as user_avg_comments,
    u.avg_engagement_rate as user_avg_engagement_rate,
    c.avg_engagement_score as content_type_avg_score,
    c.avg_engagement_rate as content_type_avg_rate,
    c.median_engagement_score as content_type_median_score,

    -- Normalized scores (0-100)
    CASE
        WHEN c.avg_engagement_score > 0
        THEN LEAST(100, (e.raw_engagement_score / c.avg_engagement_score) * 50)
        ELSE 0
    END AS normalized_engagement_score,

    -- Performance percentile within content type
    PERCENT_RANK() OVER (
        PARTITION BY e.content_type
        ORDER BY e.raw_engagement_score
    ) * 100 as content_type_percentile,

    -- Performance percentile within user's posts
    PERCENT_RANK() OVER (
        PARTITION BY e.user_id
        ORDER BY e.raw_engagement_score
    ) * 100 as user_percentile,

    -- Monetization potential score
    CASE
        WHEN e.engagement_rate_percent > 5 AND e.viral_coefficient > 0.1
        THEN 'HIGH'
        WHEN e.engagement_rate_percent > 2 AND e.viral_coefficient > 0.05
        THEN 'MEDIUM'
        ELSE 'LOW'
    END as monetization_potential,

    -- Trending indicator
    CASE
        WHEN e.engagement_velocity > 10 AND e.engagement_rate_percent > 5
        THEN 'TRENDING'
        WHEN e.engagement_velocity > 5 AND e.engagement_rate_percent > 2
        THEN 'POPULAR'
        WHEN e.engagement_velocity > 1
        THEN 'ACTIVE'
        ELSE 'NORMAL'
    END as engagement_status

FROM engagement_metrics e
LEFT JOIN user_metrics u ON e.user_id = u.user_id
LEFT JOIN content_type_metrics c ON e.content_type = c.content_type;

COMMENT ON VIEW socialcandor_schema.vw_post_engagement IS 'Normalized engagement scoring across content types for algorithmic feeds and monetization';

------------------------------------------------------------------------------------------------
-- View: 119 - vw_daily_active_users
-- Description: DAU calculation with 30-day rolling window
-- Business Case: Powers executive dashboards and growth team reporting while enabling
-- cohort-based DAU analysis through parameterized date ranges. Tracks platform health
-- and user retention metrics with advanced filtering for geographic and demographic
-- segmentation. Supports A/B testing impact measurement on user activity.
-- Feature Reference: ANL02 (User Analytics), GRO01 (Growth Metrics), EXEC01 (Executive Reporting)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE VIEW socialcandor_schema.vw_daily_active_users AS
WITH daily_activity AS (
    SELECT
        DATE(ual.created_at) as activity_date,
        ual.user_id,
        u.registration_country,
        u.preferred_language,
        u.is_premium_user,
        u.trust_score,
        COUNT(DISTINCT ual.session_id) as session_count,
        COUNT(*) as activity_count,
        COUNT(DISTINCT ual.action_name) as unique_action_types,  -- Changed from action_type to action_name
        MAX(ual.created_at) as last_activity_time,
        MIN(ual.created_at) as first_activity_time,
        SUM(CASE WHEN ual.action_name IN ('POST_CREATE', 'COMMENT_CREATE') THEN 1 ELSE 0 END) as content_creation_count,  -- Changed from action_type to action_name
        SUM(CASE WHEN ual.action_name IN ('LIKE', 'SHARE', 'SAVE') THEN 1 ELSE 0 END) as engagement_count,  -- Changed from action_type to action_name
        SUM(CASE WHEN ual.action_name = 'LOGIN' THEN 1 ELSE 0 END) as login_count  -- Changed from action_type to action_name
    FROM socialcandor_schema.user_activity_logs ual
    JOIN socialcandor_schema.users u ON ual.user_id = u.user_id
    WHERE u.status = 'ACTIVE'
    AND ual.created_at >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY DATE(ual.created_at), ual.user_id, u.registration_country,
             u.preferred_language, u.is_premium_user, u.trust_score
),
daily_aggregates AS (
    SELECT
        activity_date,
        registration_country,
        preferred_language,

        -- Core DAU metrics
        COUNT(DISTINCT user_id) as dau,
        COUNT(DISTINCT user_id) FILTER (WHERE session_count >= 2) as multi_session_dau,
        COUNT(DISTINCT user_id) FILTER (WHERE content_creation_count > 0) as content_creators,
        COUNT(DISTINCT user_id) FILTER (WHERE engagement_count > 5) as highly_engaged_users,

        -- Activity metrics
        SUM(session_count) as total_sessions,
        SUM(activity_count) as total_activities,
        AVG(session_count) as avg_sessions_per_user,
        AVG(activity_count) as avg_activities_per_user,

        -- Session duration (estimated)
        AVG(EXTRACT(EPOCH FROM (last_activity_time - first_activity_time))) as avg_session_duration_seconds,

        -- Demographic breakdown
        COUNT(DISTINCT user_id) FILTER (WHERE is_premium_user = TRUE) as premium_dau,
        COUNT(DISTINCT user_id) FILTER (WHERE trust_score > 75) as high_trust_dau,

        -- Activity composition
        SUM(content_creation_count) as total_content_created,
        SUM(engagement_count) as total_engagements,
        SUM(login_count) as total_logins

    FROM daily_activity
    GROUP BY activity_date, registration_country, preferred_language
),
windowed_user_counts AS (
    SELECT
        da.activity_date,
        da.dau,
        da.multi_session_dau,
        da.content_creators,
        da.highly_engaged_users,
        da.total_sessions,
        da.total_activities,
        da.avg_sessions_per_user,
        da.avg_activities_per_user,
        da.avg_session_duration_seconds,
        da.premium_dau,
        da.high_trust_dau,
        da.registration_country,
        da.preferred_language,
        da.total_content_created,
        da.total_engagements,
        da.total_logins,
        
        -- 7-day rolling averages
        AVG(da.dau) OVER (
            ORDER BY da.activity_date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) as dau_7d_avg,
        
        AVG(da.multi_session_dau) OVER (
            ORDER BY da.activity_date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) as multi_session_dau_7d_avg,
        
        AVG(da.content_creators) OVER (
            ORDER BY da.activity_date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) as content_creators_7d_avg,
        
        -- 30-day rolling averages
        AVG(da.dau) OVER (
            ORDER BY da.activity_date
            ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
        ) as dau_30d_avg,
        
        -- Growth metrics
        da.dau - LAG(da.dau, 1) OVER (ORDER BY da.activity_date) as dau_daily_change,
        CASE
            WHEN LAG(da.dau, 1) OVER (ORDER BY da.activity_date) > 0
            THEN ((da.dau - LAG(da.dau, 1) OVER (ORDER BY da.activity_date))::NUMERIC /
                  LAG(da.dau, 1) OVER (ORDER BY da.activity_date)) * 100
            ELSE NULL
        END as dau_daily_growth_percent
        
    FROM daily_aggregates da
),
mau_calculation AS (
    SELECT
        activity_date,
        COUNT(DISTINCT user_id) as mau_30d
    FROM daily_activity
    GROUP BY activity_date
),
wau_calculation AS (
    SELECT
        DATE_TRUNC('week', activity_date) as week_start,
        activity_date,
        COUNT(DISTINCT user_id) as wau
    FROM daily_activity
    GROUP BY DATE_TRUNC('week', activity_date), activity_date
),
combined_metrics AS (
    SELECT
        wuc.activity_date,
        wuc.dau,
        wuc.multi_session_dau,
        wuc.content_creators,
        wuc.highly_engaged_users,
        wuc.total_sessions,
        wuc.total_activities,
        wuc.avg_sessions_per_user,
        wuc.avg_activities_per_user,
        wuc.avg_session_duration_seconds,
        wuc.premium_dau,
        wuc.high_trust_dau,
        wuc.registration_country,
        wuc.preferred_language,
        wuc.total_content_created,
        wuc.total_engagements,
        wuc.total_logins,
        wuc.dau_7d_avg,
        wuc.multi_session_dau_7d_avg,
        wuc.content_creators_7d_avg,
        wuc.dau_30d_avg,
        wuc.dau_daily_change,
        wuc.dau_daily_growth_percent,
        
        -- WAU (Weekly Active Users)
        wc.wau,
        
        -- MAU (Monthly Active Users) - trailing 30 days
        mc.mau_30d,
        
        -- Stickiness (DAU/MAU ratio)
        CASE
            WHEN mc.mau_30d > 0
            THEN (wuc.dau::NUMERIC / mc.mau_30d) * 100
            ELSE 0
        END as stickiness_percent,
        
        -- Day of week effects
        EXTRACT(DOW FROM wuc.activity_date) as day_of_week,
        EXTRACT(MONTH FROM wuc.activity_date) as month,
        EXTRACT(YEAR FROM wuc.activity_date) as year
        
    FROM windowed_user_counts wuc
    LEFT JOIN mau_calculation mc ON wuc.activity_date = mc.activity_date
    LEFT JOIN wau_calculation wc ON wuc.activity_date = wc.activity_date
)
SELECT
    *,
    
    -- Health indicators
    CASE
        WHEN stickiness_percent > 20 THEN 'EXCELLENT'
        WHEN stickiness_percent > 15 THEN 'GOOD'
        WHEN stickiness_percent > 10 THEN 'FAIR'
        ELSE 'POOR'
    END as stickiness_health,
    
    CASE
        WHEN dau_daily_growth_percent > 5 THEN 'HIGH_GROWTH'
        WHEN dau_daily_growth_percent > 0 THEN 'GROWING'
        WHEN dau_daily_growth_percent = 0 THEN 'STABLE'
        ELSE 'DECLINING'
    END as growth_trend,
    
    -- Premium user penetration
    CASE
        WHEN dau > 0
        THEN ROUND((premium_dau::NUMERIC / dau) * 100, 2)
        ELSE 0
    END as premium_penetration_percent,
    
    -- Engagement depth
    CASE
        WHEN dau > 0
        THEN ROUND((highly_engaged_users::NUMERIC / dau) * 100, 2)
        ELSE 0
    END as high_engagement_percent,
    
    -- Content creation rate
    CASE
        WHEN dau > 0
        THEN ROUND((content_creators::NUMERIC / dau) * 100, 2)
        ELSE 0
    END as content_creation_percent
    
FROM combined_metrics
ORDER BY activity_date DESC;

COMMENT ON VIEW socialcandor_schema.vw_daily_active_users IS 'DAU calculation with 30-day rolling window and growth metrics';

------------------------------------------------------------------------------------------------
-- View: 120 - vw_content_performance
-- Description: Cross-content-type performance benchmarking
-- Business Case: Enables data-driven content strategy guidance for creators while identifying
-- underperforming content formats for product team optimization. Provides comparative
-- analytics across content categories, formats, and time periods to inform platform
-- development and creator monetization strategies.
-- Feature Reference: CNT04 (Content Analytics), CRE02 (Creator Insights), PROD01 (Product Development)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE VIEW socialcandor_schema.vw_content_performance AS
WITH content_base AS (
    SELECT
        p.post_id,
        p.user_id,
        p.content_type,
        p.created_at,
        DATE(p.created_at) as post_date,
        EXTRACT(HOUR FROM p.created_at) as post_hour,
        EXTRACT(DOW FROM p.created_at) as post_day_of_week,
        p.language_code,
        p.visibility,
        -- Removed p.location_country as it doesn't exist in the posts table
        
        -- Engagement metrics
        p.like_count,
        p.comment_count,
        p.share_count,
        p.view_count,
        p.save_count,
        p.tip_amount_total,

        -- Quality and algorithmic metrics
        p.trending_score,
        p.quality_score,
        p.engagement_velocity,
        p.viral_coefficient,
        p.moderation_score,

        -- Media metadata
        pm.media_type,
        pm.duration_seconds,
        pm.width_pixels,
        pm.height_pixels,
        pm.file_size_bytes

    FROM socialcandor_schema.posts p
    LEFT JOIN socialcandor_schema.posts_media pm ON p.post_id = pm.post_id
    WHERE p.moderation_status = 'APPROVED'
    AND p.created_at >= CURRENT_DATE - INTERVAL '90 days'
),
engagement_metrics AS (
    SELECT
        post_id,

        -- Raw engagement
        like_count,
        comment_count,
        share_count,
        view_count,
        save_count,
        tip_amount_total,

        -- Composite scores
        (like_count * 1.0) + (comment_count * 3.0) + (share_count * 5.0) + (save_count * 2.0) as engagement_score,

        -- Engagement rates
        CASE
            WHEN view_count > 0
            THEN ((like_count + comment_count + share_count)::NUMERIC / view_count) * 100
            ELSE 0
        END as engagement_rate_percent,

        -- Viral metrics
        CASE
            WHEN view_count > 0
            THEN share_count::NUMERIC / view_count
            ELSE 0
        END as share_rate,

        -- Monetization metrics
        CASE
            WHEN view_count > 0
            THEN tip_amount_total::NUMERIC / view_count
            ELSE 0
        END as revenue_per_view

    FROM content_base
),
content_type_benchmarks AS (
    SELECT
        cb.content_type,
        cb.media_type,
        COUNT(*) as total_posts,
        AVG(cb.like_count) as avg_likes,
        AVG(cb.comment_count) as avg_comments,
        AVG(cb.share_count) as avg_shares,
        AVG(cb.view_count) as avg_views,
        AVG(em.engagement_rate_percent) as avg_engagement_rate,
        AVG(em.share_rate) as avg_share_rate,
        AVG(cb.trending_score) as avg_trending_score,
        AVG(cb.quality_score) as avg_quality_score,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY em.engagement_score) as median_engagement_score,
        PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY em.engagement_score) as p90_engagement_score

    FROM content_base cb
    JOIN engagement_metrics em ON cb.post_id = em.post_id
    GROUP BY cb.content_type, cb.media_type
),
time_performance AS (
    SELECT
        cb.post_hour,
        cb.post_day_of_week,
        COUNT(*) as posts_count,
        AVG(em.engagement_score) as avg_engagement_score,
        AVG(em.engagement_rate_percent) as avg_engagement_rate,
        AVG(cb.view_count) as avg_views

    FROM content_base cb
    JOIN engagement_metrics em ON cb.post_id = em.post_id
    GROUP BY cb.post_hour, cb.post_day_of_week
),
user_performance AS (
    SELECT
        cb.user_id,
        COUNT(*) as total_posts,
        AVG(em.engagement_score) as avg_engagement_score,
        AVG(em.engagement_rate_percent) as avg_engagement_rate,
        SUM(cb.view_count) as total_views,
        SUM(cb.tip_amount_total) as total_revenue,
        PERCENT_RANK() OVER (ORDER BY AVG(em.engagement_score) DESC) * 100 as creator_percentile

    FROM content_base cb
    JOIN engagement_metrics em ON cb.post_id = em.post_id
    GROUP BY cb.user_id
)
SELECT
    cb.*,
    em.engagement_score,
    em.engagement_rate_percent,
    em.share_rate,
    em.revenue_per_view,

    -- Benchmark comparisons
    ctb.total_posts as content_type_total_posts,
    ctb.avg_likes as content_type_avg_likes,
    ctb.avg_comments as content_type_avg_comments,
    ctb.avg_shares as content_type_avg_shares,
    ctb.avg_views as content_type_avg_views,
    ctb.avg_engagement_rate as content_type_avg_engagement_rate,
    ctb.avg_share_rate as content_type_avg_share_rate,
    ctb.median_engagement_score as content_type_median_score,
    ctb.p90_engagement_score as content_type_p90_score,

    -- Performance relative to benchmarks
    CASE
        WHEN ctb.avg_likes > 0
        THEN ROUND((cb.like_count / ctb.avg_likes) * 100, 2)
        ELSE 0
    END as likes_vs_benchmark_percent,

    CASE
        WHEN ctb.avg_engagement_rate > 0
        THEN ROUND((em.engagement_rate_percent / ctb.avg_engagement_rate) * 100, 2)
        ELSE 0
    END as engagement_rate_vs_benchmark_percent,

    -- Time performance insights
    tp.posts_count as hour_day_posts_count,
    tp.avg_engagement_score as hour_day_avg_score,
    tp.avg_engagement_rate as hour_day_avg_rate,
    tp.avg_views as hour_day_avg_views,

    -- User performance context
    up.total_posts as user_total_posts,
    up.avg_engagement_score as user_avg_engagement_score,
    up.avg_engagement_rate as user_avg_engagement_rate,
    up.total_views as user_total_views,
    up.total_revenue as user_total_revenue,
    up.creator_percentile as user_percentile,

    -- Performance classification
    CASE
        WHEN em.engagement_score > ctb.p90_engagement_score THEN 'TOP_10_PERCENT'
        WHEN em.engagement_score > ctb.median_engagement_score THEN 'ABOVE_MEDIAN'
        WHEN em.engagement_score = ctb.median_engagement_score THEN 'MEDIAN'
        ELSE 'BELOW_MEDIAN'
    END as performance_tier,

    -- Optimization recommendations
    CASE
        WHEN em.engagement_rate_percent < 1 AND cb.view_count > 1000 THEN 'HIGH_VIEWS_LOW_ENGAGEMENT'
        WHEN em.share_rate > 0.1 AND cb.view_count > 500 THEN 'VIRAL_POTENTIAL'
        WHEN em.engagement_rate_percent > 10 AND cb.view_count < 100 THEN 'UNDEREXPOSED_HIGH_QUALITY'
        WHEN cb.trending_score > 50 AND cb.engagement_velocity > 5 THEN 'TRENDING_CONTENT'
        ELSE 'TYPICAL_PERFORMANCE'
    END as performance_insight,

    -- Monetization potential
    CASE
        WHEN em.engagement_rate_percent > 5 AND em.share_rate > 0.05 AND cb.view_count > 1000
        THEN 'HIGH_MONETIZATION_POTENTIAL'
        WHEN em.engagement_rate_percent > 2 AND cb.view_count > 500
        THEN 'MEDIUM_MONETIZATION_POTENTIAL'
        ELSE 'LOW_MONETIZATION_POTENTIAL'
    END as monetization_potential

FROM content_base cb
JOIN engagement_metrics em ON cb.post_id = em.post_id
LEFT JOIN content_type_benchmarks ctb ON cb.content_type = ctb.content_type
    AND cb.media_type = ctb.media_type
LEFT JOIN time_performance tp ON cb.post_hour = tp.post_hour
    AND cb.post_day_of_week = tp.post_day_of_week
LEFT JOIN user_performance up ON cb.user_id = up.user_id;

COMMENT ON VIEW socialcandor_schema.vw_content_performance IS 'Cross-content-type performance benchmarking with optimization insights';
------------------------------------------------------------------------------------------------
-- View: 121 - vw_user_activity_summary
-- Description: 30-day user engagement summary for support/CSAT workflows
-- Business Case: Enables support agents to understand user context during tickets while
-- powering re-engagement campaigns for dormant high-value users. Provides comprehensive
-- behavioral insights including content consumption patterns, social interactions,
-- and platform feature adoption for personalized support and retention strategies.
-- Feature Reference: SUPP01 (Support Analytics), RET01 (Retention), CSAT01 (Customer Satisfaction)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE VIEW socialcandor_schema.vw_user_activity_summary AS
WITH user_base AS (
    SELECT
        u.user_id,
        u.username,
        u.email,
        u.display_name,
        u.status,
        u.trust_score,
        u.is_premium_user,
        u.premium_expires_at,
        u.created_at as registration_date,
        u.last_active_at,
        u.last_login_at,
        -- Calculate account age in days
        EXTRACT(DAY FROM (CURRENT_TIMESTAMP - u.created_at))::INTEGER as account_age_days,
        u.registration_country,
        u.preferred_language
    FROM socialcandor_schema.users u
    WHERE u.status = 'ACTIVE'
),
activity_window AS (
    SELECT
        user_id,
        MIN(created_at) as first_activity,
        MAX(created_at) as last_activity,
        COUNT(*) as total_activities,
        COUNT(DISTINCT DATE(created_at)) as active_days,
        COUNT(DISTINCT action_name) as unique_action_types,

        -- Content creation activities
        SUM(CASE WHEN action_name IN ('POST_CREATE', 'STORY_CREATE', 'LIVE_STREAM_START') THEN 1 ELSE 0 END) as content_creation_count,
        SUM(CASE WHEN action_name = 'COMMENT_CREATE' THEN 1 ELSE 0 END) as comment_count,

        -- Engagement activities
        SUM(CASE WHEN action_name = 'LIKE' THEN 1 ELSE 0 END) as like_count,
        SUM(CASE WHEN action_name = 'SHARE' THEN 1 ELSE 0 END) as share_count,
        SUM(CASE WHEN action_name = 'SAVE' THEN 1 ELSE 0 END) as save_count,

        -- Social activities
        SUM(CASE WHEN action_name = 'FRIEND_REQUEST' THEN 1 ELSE 0 END) as friend_request_count,
        SUM(CASE WHEN action_name = 'FOLLOW' THEN 1 ELSE 0 END) as follow_count,

        -- Messaging activities
        SUM(CASE WHEN action_name = 'MESSAGE_SEND' THEN 1 ELSE 0 END) as message_send_count,
        SUM(CASE WHEN action_name = 'MESSAGE_READ' THEN 1 ELSE 0 END) as message_read_count,

        -- Login and session activities
        SUM(CASE WHEN action_name = 'LOGIN' THEN 1 ELSE 0 END) as login_count,
        COUNT(DISTINCT session_id) as session_count

    FROM socialcandor_schema.user_activity_logs
    WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY user_id
),
content_stats AS (
    SELECT
        user_id,
        COUNT(*) as post_count,
        SUM(like_count) as post_likes_received,
        SUM(comment_count) as post_comments_received,
        SUM(view_count) as post_views_received,
        SUM(tip_amount_total) as post_tips_received,
        AVG(trending_score) as avg_post_trending_score,
        AVG(quality_score) as avg_post_quality_score

    FROM socialcandor_schema.posts
    WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
    AND moderation_status = 'APPROVED'
    GROUP BY user_id
),
social_stats AS (
    SELECT
        user_id,
        'friend' as stat_type,
        COUNT(*) as count
    FROM socialcandor_schema.friends
    WHERE status = 'ACCEPTED'
    AND is_mutual = TRUE
    GROUP BY user_id

    UNION ALL

    SELECT
        follower_user_id as user_id,
        'follower' as stat_type,
        COUNT(*) as count
    FROM socialcandor_schema.followings
    WHERE is_active = TRUE
    GROUP BY follower_user_id

    UNION ALL

    SELECT
        following_user_id as user_id,
        'following' as stat_type,
        COUNT(*) as count
    FROM socialcandor_schema.followings
    WHERE is_active = TRUE
    GROUP BY following_user_id
),
aggregated_social AS (
    SELECT
        user_id,
        SUM(CASE WHEN stat_type = 'friend' THEN count ELSE 0 END) as friend_count,
        SUM(CASE WHEN stat_type = 'follower' THEN count ELSE 0 END) as follower_count,
        SUM(CASE WHEN stat_type = 'following' THEN count ELSE 0 END) as following_count
    FROM social_stats
    GROUP BY user_id
),
revenue_stats AS (
    SELECT
        user_id,
        COUNT(*) as transaction_count,
        SUM(amount) as total_spent,
        SUM(CASE WHEN transaction_type = 'TIP' THEN amount ELSE 0 END) as total_tips_sent,
        SUM(CASE WHEN transaction_type = 'SUBSCRIPTION' THEN amount ELSE 0 END) as total_subscription_spent,
        MAX(created_at) as last_transaction_date

    FROM socialcandor_schema.wallet_transactions
    WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
    -- Removed status filter since column doesn't exist
    GROUP BY user_id
)
SELECT
    ub.*,

    -- Activity metrics
    COALESCE(aw.first_activity, ub.last_active_at) as period_first_activity,
    COALESCE(aw.last_activity, ub.last_active_at) as period_last_activity,
    COALESCE(aw.total_activities, 0) as total_activities,
    COALESCE(aw.active_days, 0) as active_days,
    COALESCE(aw.unique_action_types, 0) as unique_action_types,
    COALESCE(aw.content_creation_count, 0) as content_creation_count,
    COALESCE(aw.comment_count, 0) as comment_count,
    COALESCE(aw.like_count, 0) as like_count,
    COALESCE(aw.share_count, 0) as share_count,
    COALESCE(aw.save_count, 0) as save_count,
    COALESCE(aw.friend_request_count, 0) as friend_request_count,
    COALESCE(aw.follow_count, 0) as follow_count,
    COALESCE(aw.message_send_count, 0) as message_send_count,
    COALESCE(aw.message_read_count, 0) as message_read_count,
    COALESCE(aw.login_count, 0) as login_count,
    COALESCE(aw.session_count, 0) as session_count,

    -- Content statistics
    COALESCE(cs.post_count, 0) as post_count,
    COALESCE(cs.post_likes_received, 0) as post_likes_received,
    COALESCE(cs.post_comments_received, 0) as post_comments_received,
    COALESCE(cs.post_views_received, 0) as post_views_received,
    COALESCE(cs.post_tips_received, 0) as post_tips_received,
    COALESCE(cs.avg_post_trending_score, 0) as avg_post_trending_score,
    COALESCE(cs.avg_post_quality_score, 0) as avg_post_quality_score,

    -- Social statistics
    COALESCE(asoc.friend_count, 0) as friend_count,
    COALESCE(asoc.follower_count, 0) as follower_count,
    COALESCE(asoc.following_count, 0) as following_count,

    -- Revenue statistics
    COALESCE(rs.transaction_count, 0) as transaction_count,
    COALESCE(rs.total_spent, 0) as total_spent,
    COALESCE(rs.total_tips_sent, 0) as total_tips_sent,
    COALESCE(rs.total_subscription_spent, 0) as total_subscription_spent,
    rs.last_transaction_date,

    -- Calculated metrics
    CASE
        WHEN COALESCE(aw.active_days, 0) > 0
        THEN ROUND(COALESCE(aw.total_activities, 0)::NUMERIC / aw.active_days, 2)
        ELSE 0
    END as avg_daily_activities,

    CASE
        WHEN COALESCE(aw.content_creation_count, 0) > 0
        THEN ROUND(COALESCE(cs.post_likes_received, 0)::NUMERIC / aw.content_creation_count, 2)
        ELSE 0
    END as avg_likes_per_content,

    CASE
        WHEN COALESCE(aw.active_days, 0) > 0
        THEN ROUND(aw.active_days::NUMERIC / 30 * 100, 2)
        ELSE 0
    END as activity_frequency_percent,

    -- User segmentation for support
    CASE
        WHEN ub.is_premium_user = TRUE AND COALESCE(rs.total_spent, 0) > 100 THEN 'HIGH_VALUE_PREMIUM'
        WHEN ub.is_premium_user = TRUE THEN 'PREMIUM'
        WHEN COALESCE(rs.total_spent, 0) > 50 THEN 'HIGH_VALUE_FREE'
        WHEN COALESCE(aw.active_days, 0) >= 20 THEN 'ACTIVE_FREE'
        WHEN COALESCE(aw.active_days, 0) >= 10 THEN 'REGULAR_FREE'
        WHEN COALESCE(aw.active_days, 0) >= 1 THEN 'OCCASIONAL_FREE'
        ELSE 'INACTIVE'
    END as user_segment,

    -- Support priority (modified to remove support ticket references)
    CASE
        WHEN ub.is_premium_user = TRUE AND COALESCE(rs.total_spent, 0) > 100 THEN 'HIGH_PRIORITY'
        WHEN COALESCE(aw.active_days, 0) >= 20 AND COALESCE(cs.post_count, 0) > 10 THEN 'ACTIVE_CREATOR'
        ELSE 'STANDARD'
    END as support_priority,

    -- Risk indicators (modified to remove support ticket references)
    CASE
        WHEN COALESCE(aw.active_days, 0) < 5 AND ub.account_age_days > 60 THEN 'INACTIVITY_RISK'
        WHEN COALESCE(cs.post_count, 0) > 0 AND COALESCE(cs.post_likes_received, 0) = 0 THEN 'LOW_ENGAGEMENT_RISK'
        ELSE 'LOW_RISK'
    END as risk_indicator,

    -- Recommended actions (modified to remove support ticket references)
    CASE
        WHEN COALESCE(aw.active_days, 0) = 0 AND ub.account_age_days > 7 THEN 'RE_ENGAGEMENT_CAMPAIGN'
        WHEN COALESCE(cs.post_count, 0) > 0 AND COALESCE(cs.post_likes_received, 0) = 0 THEN 'CONTENT_QUALITY_GUIDANCE'
        WHEN ub.is_premium_user = FALSE AND COALESCE(rs.total_spent, 0) > 0 THEN 'PREMIUM_UPSELL'
        WHEN COALESCE(aw.active_days, 0) >= 20 AND COALESCE(cs.post_count, 0) = 0 THEN 'CONTENT_CREATION_NUDGE'
        ELSE 'MONITOR'
    END as recommended_action

FROM user_base ub
LEFT JOIN activity_window aw ON ub.user_id = aw.user_id
LEFT JOIN content_stats cs ON ub.user_id = cs.user_id
LEFT JOIN aggregated_social asoc ON ub.user_id = asoc.user_id
LEFT JOIN revenue_stats rs ON ub.user_id = rs.user_id;

COMMENT ON VIEW socialcandor_schema.vw_user_activity_summary IS '30-day user engagement summary for support workflows and re-engagement campaigns';


------------------------------------------------------------------------------------------------
-- View: 123 - content_heatmap
-- Description: Temporal content engagement patterns by hour/day
-- Business Case: Enables optimal content scheduling recommendations for creators while
-- identifying platform-wide engagement peaks for infrastructure capacity planning.
-- Analyzes time-based engagement patterns across timezones, content types, and
-- user segments to inform content strategy and resource allocation.
-- Feature Reference: CNT05 (Content Strategy), INF01 (Infrastructure Planning), CRE03 (Creator Tools)
------------------------------------------------------------------------------------------------
CREATE OR REPLACE VIEW socialcandor_schema.content_heatmap AS
WITH time_engagement AS (
    SELECT
        -- Time dimensions
        DATE(p.created_at) as content_date,
        EXTRACT(HOUR FROM p.created_at) as content_hour,
        EXTRACT(DOW FROM p.created_at) as content_day_of_week,
        EXTRACT(MONTH FROM p.created_at) as content_month,

        -- Content dimensions
        p.content_type,
        p.language_code,
        p.visibility,
        u.registration_country,

        -- Engagement metrics
        COUNT(*) as post_count,
        SUM(p.like_count) as total_likes,
        SUM(p.comment_count) as total_comments,
        SUM(p.share_count) as total_shares,
        SUM(p.view_count) as total_views,
        SUM(p.save_count) as total_saves,
        SUM(p.tip_amount_total) as total_tips,

        -- Performance metrics
        AVG(p.trending_score) as avg_trending_score,
        AVG(p.quality_score) as avg_quality_score,
        AVG(p.engagement_velocity) as avg_engagement_velocity,

        -- User metrics
        COUNT(DISTINCT p.user_id) as unique_creators,
        AVG(u.trust_score) as avg_creator_trust_score

    FROM socialcandor_schema.posts p
    JOIN socialcandor_schema.users u ON p.user_id = u.user_id
    WHERE p.created_at >= CURRENT_DATE - INTERVAL '90 days'
    AND p.moderation_status = 'APPROVED'
    GROUP BY
        DATE(p.created_at),
        EXTRACT(HOUR FROM p.created_at),
        EXTRACT(DOW FROM p.created_at),
        EXTRACT(MONTH FROM p.created_at),
        p.content_type,
        p.language_code,
        p.visibility,
        u.registration_country
),
time_aggregates AS (
    SELECT
        content_hour,
        content_day_of_week,
        content_month,
        content_type,
        language_code,
        registration_country,

        -- Aggregate metrics
        SUM(post_count) as total_posts,
        SUM(total_likes) as total_likes,
        SUM(total_comments) as total_comments,
        SUM(total_shares) as total_shares,
        SUM(total_views) as total_views,
        SUM(total_saves) as total_saves,
        SUM(total_tips) as total_tips,

        -- Average performance
        AVG(avg_trending_score) as avg_trending_score,
        AVG(avg_quality_score) as avg_quality_score,
        AVG(avg_engagement_velocity) as avg_engagement_velocity,

        -- Creator metrics
        SUM(unique_creators) as total_creators,
        AVG(avg_creator_trust_score) as avg_creator_trust_score,

        -- Engagement rates
        CASE
            WHEN SUM(total_views) > 0
            THEN (SUM(total_likes + total_comments + total_shares)::NUMERIC / SUM(total_views)) * 100
            ELSE 0
        END as engagement_rate_percent,

        -- Share rate
        CASE
            WHEN SUM(total_views) > 0
            THEN SUM(total_shares)::NUMERIC / SUM(total_views)
            ELSE 0
        END as share_rate,

        -- Revenue per view
        CASE
            WHEN SUM(total_views) > 0
            THEN SUM(total_tips)::NUMERIC / SUM(total_views)
            ELSE 0
        END as revenue_per_view

    FROM time_engagement
    GROUP BY
        content_hour,
        content_day_of_week,
        content_month,
        content_type,
        language_code,
        registration_country
),
hourly_patterns AS (
    SELECT
        content_hour,

        -- Overall hourly patterns
        SUM(total_posts) as hourly_posts,
        SUM(total_views) as hourly_views,
        SUM(total_likes) as hourly_likes,
        SUM(total_comments) as hourly_comments,
        SUM(total_shares) as hourly_shares,

        -- Hourly engagement rates
        CASE
            WHEN SUM(total_views) > 0
            THEN (SUM(total_likes + total_comments + total_shares)::NUMERIC / SUM(total_views)) * 100
            ELSE 0
        END as hourly_engagement_rate,

        -- Hourly performance
        AVG(avg_trending_score) as hourly_avg_trending_score,
        AVG(avg_quality_score) as hourly_avg_quality_score,

        -- Peak detection
        PERCENT_RANK() OVER (ORDER BY SUM(total_posts) DESC) as post_volume_percentile,
        PERCENT_RANK() OVER (ORDER BY AVG(avg_trending_score) DESC) as trending_percentile,
        PERCENT_RANK() OVER (ORDER BY AVG(engagement_rate_percent) DESC) as engagement_percentile

    FROM time_aggregates
    GROUP BY content_hour
),
daily_patterns AS (
    SELECT
        content_day_of_week,

        -- Overall daily patterns
        SUM(total_posts) as daily_posts,
        SUM(total_views) as daily_views,
        SUM(total_likes) as daily_likes,
        SUM(total_comments) as daily_comments,
        SUM(total_shares) as daily_shares,

        -- Daily engagement rates
        CASE
            WHEN SUM(total_views) > 0
            THEN (SUM(total_likes + total_comments + total_shares)::NUMERIC / SUM(total_views)) * 100
            ELSE 0
        END as daily_engagement_rate,

        -- Daily performance
        AVG(avg_trending_score) as daily_avg_trending_score,
        AVG(avg_quality_score) as daily_avg_quality_score,

        -- Day ranking
        PERCENT_RANK() OVER (ORDER BY SUM(total_posts) DESC) as daily_post_percentile,
        PERCENT_RANK() OVER (ORDER BY AVG(engagement_rate_percent) DESC) as daily_engagement_percentile

    FROM time_aggregates
    GROUP BY content_day_of_week
)
SELECT
    ta.*,

    -- Hourly context
    hp.hourly_posts,
    hp.hourly_views,
    hp.hourly_likes,
    hp.hourly_comments,
    hp.hourly_shares,
    hp.hourly_engagement_rate,
    hp.hourly_avg_trending_score,
    hp.hourly_avg_quality_score,
    hp.post_volume_percentile as hour_post_volume_percentile,
    hp.trending_percentile as hour_trending_percentile,
    hp.engagement_percentile as hour_engagement_percentile,

    -- Daily context
    dp.daily_posts,
    dp.daily_views,
    dp.daily_likes,
    dp.daily_comments,
    dp.daily_shares,
    dp.daily_engagement_rate,
    dp.daily_avg_trending_score,
    dp.daily_avg_quality_score,
    dp.daily_post_percentile as day_post_percentile,
    dp.daily_engagement_percentile as day_engagement_percentile,

    -- Time slot classification
    CASE
        WHEN ta.content_hour BETWEEN 6 AND 9 THEN 'MORNING_PEAK'
        WHEN ta.content_hour BETWEEN 12 AND 14 THEN 'LUNCH_PEAK'
        WHEN ta.content_hour BETWEEN 17 AND 20 THEN 'EVENING_PEAK'
        WHEN ta.content_hour BETWEEN 21 AND 23 THEN 'NIGHT_PEAK'
        ELSE 'OFF_PEAK'
    END as time_slot_category,

    -- Day classification
    CASE
        WHEN ta.content_day_of_week IN (0, 6) THEN 'WEEKEND'
        ELSE 'WEEKDAY'
    END as day_category,

    -- Performance classification
    CASE
        WHEN hp.post_volume_percentile > 0.8 AND hp.engagement_percentile > 0.8 THEN 'HIGH_VOLUME_HIGH_ENGAGEMENT'
        WHEN hp.post_volume_percentile > 0.8 AND hp.engagement_percentile <= 0.8 THEN 'HIGH_VOLUME_LOW_ENGAGEMENT'
        WHEN hp.post_volume_percentile <= 0.8 AND hp.engagement_percentile > 0.8 THEN 'LOW_VOLUME_HIGH_ENGAGEMENT'
        ELSE 'LOW_VOLUME_LOW_ENGAGEMENT'
    END as performance_quadrant,

    -- Optimal posting recommendation
    CASE
        WHEN hp.post_volume_percentile < 0.3 AND hp.engagement_percentile > 0.7 THEN 'UNDERSERVED_OPPORTUNITY'
        WHEN hp.post_volume_percentile > 0.7 AND hp.engagement_percentile > 0.7 THEN 'COMPETITIVE_PEAK'
        WHEN hp.post_volume_percentile < 0.3 AND hp.engagement_percentile < 0.3 THEN 'LOW_OPPORTUNITY'
        ELSE 'MODERATE_OPPORTUNITY'
    END as opportunity_analysis,

    -- Content type suitability
    CASE
        WHEN ta.content_type = 'TEXT' AND hp.engagement_percentile > 0.7 THEN 'OPTIMAL_FOR_TEXT'
        WHEN ta.content_type = 'IMAGE' AND hp.engagement_percentile > 0.7 THEN 'OPTIMAL_FOR_IMAGES'
        WHEN ta.content_type = 'VIDEO' AND hp.engagement_percentile > 0.7 THEN 'OPTIMAL_FOR_VIDEO'
        WHEN ta.content_type = 'LIVE' AND hp.post_volume_percentile > 0.8 THEN 'OPTIMAL_FOR_LIVE'
        ELSE 'STANDARD_PERFORMANCE'
    END as content_type_suitability,

    -- Infrastructure planning indicators
    CASE
        WHEN hp.post_volume_percentile > 0.9 THEN 'HIGH_LOAD_PERIOD'
        WHEN hp.post_volume_percentile > 0.7 THEN 'MEDIUM_LOAD_PERIOD'
        ELSE 'LOW_LOAD_PERIOD'
    END as infrastructure_load,

    -- Creator recommendation
    CASE
        WHEN hp.post_volume_percentile < 0.4 AND hp.engagement_percentile > 0.6 THEN 'RECOMMEND_POSTING'
        WHEN hp.post_volume_percentile > 0.8 AND hp.engagement_percentile < 0.4 THEN 'RECOMMEND_AVOIDING'
        ELSE 'NEUTRAL'
    END as posting_recommendation

FROM time_aggregates ta
LEFT JOIN hourly_patterns hp ON ta.content_hour = hp.content_hour
LEFT JOIN daily_patterns dp ON ta.content_day_of_week = dp.content_day_of_week
ORDER BY ta.content_hour, ta.content_day_of_week;

COMMENT ON VIEW socialcandor_schema.content_heatmap IS 'Temporal content engagement patterns for scheduling recommendations and capacity planning';



------------------------------------------------------------------------------------------------
-- Table: 155 - sp_end_visitor_session (Creating Table: kpi_metrics)
-- Description: Centralized storage of calculated business metrics with dimensional attributes
-- Business Case: Ensures metric definition consistency across teams (sales vs. product vs. finance)
-- while enabling historical trend analysis without expensive recomputation of complex aggregations.
-- Supports data-driven decision making and single source of truth for KPIs.
-- Feature Reference: KPI02 (Business Metrics), EXEC01 (Executive Reporting), CONS01 (Consistency)
------------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS socialcandor_schema.kpi_metrics (
    kpi_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- KPI identification
    kpi_name VARCHAR(200) NOT NULL,
    kpi_code VARCHAR(100) UNIQUE NOT NULL,
    kpi_description TEXT,

    -- Business context
    business_domain VARCHAR(100) NOT NULL CHECK (
        business_domain IN (
            'USER_GROWTH', 'ENGAGEMENT', 'RETENTION', 'REVENUE',
            'CONTENT', 'COMMUNITY', 'MODERATION', 'TECHNICAL',
            'MARKETING', 'CUSTOMER_SUPPORT', 'FINANCIAL', 'OPERATIONAL'
        )
    ),
    department_owner VARCHAR(100),
    product_area VARCHAR(100),

    -- Calculation definition
    calculation_method VARCHAR(50) NOT NULL CHECK (
        calculation_method IN ('SUM', 'AVG', 'COUNT', 'MEDIAN', 'PERCENTILE', 'RATIO', 'COMPLEX')
    ),
    calculation_formula TEXT NOT NULL,
    data_source VARCHAR(500),
    refresh_frequency VARCHAR(20) NOT NULL CHECK (
        refresh_frequency IN ('REALTIME', 'HOURLY', 'DAILY', 'WEEKLY', 'MONTHLY', 'QUARTERLY')
    ),

    -- Measurement details
    measurement_unit VARCHAR(50) NOT NULL,
    decimal_places INTEGER DEFAULT 2 CHECK (decimal_places >= 0 AND decimal_places <= 10),
    is_cumulative BOOLEAN DEFAULT FALSE,
    is_percentage BOOLEAN DEFAULT FALSE,

    -- Time dimensions
    time_granularity VARCHAR(20) NOT NULL CHECK (
        time_granularity IN ('HOURLY', 'DAILY', 'WEEKLY', 'MONTHLY', 'QUARTERLY', 'YEARLY')
    ),
    applicable_from TIMESTAMP WITH TIME ZONE NOT NULL,
    applicable_to TIMESTAMP WITH TIME ZONE,

    -- Target and thresholds
    target_value NUMERIC(30,10),
    target_type VARCHAR(20) CHECK (
        target_type IN ('MINIMUM', 'MAXIMUM', 'RANGE', 'EXACT', 'TREND')
    ),
    warning_threshold NUMERIC(30,10),
    critical_threshold NUMERIC(30,10),
    stretch_target NUMERIC(30,10),

    -- Historical values
    current_value NUMERIC(30,10),
    previous_period_value NUMERIC(30,10),
    year_over_year_value NUMERIC(30,10),
    historical_average NUMERIC(30,10),

    -- Trend analysis
    trend_direction VARCHAR(10) CHECK (trend_direction IN ('UP', 'DOWN', 'STABLE', 'VOLATILE')),
    trend_velocity NUMERIC(10,2),
    momentum_score NUMERIC(10,2),
    seasonality_factor NUMERIC(10,4),

    -- Performance classification
    performance_status VARCHAR(20) CHECK (
        performance_status IN ('CRITICAL', 'POOR', 'FAIR', 'GOOD', 'EXCELLENT')
    ),
    status_color VARCHAR(20) CHECK (
        status_color IN ('RED', 'ORANGE', 'YELLOW', 'GREEN', 'BLUE', 'GRAY')
    ),

    -- Benchmarking
    industry_benchmark NUMERIC(30,10),
    competitor_benchmark NUMERIC(30,10),
    percentile_rank NUMERIC(5,2) CHECK (percentile_rank >= 0 AND percentile_rank <= 100),

    -- Quality indicators
    data_quality_score NUMERIC(5,2) DEFAULT 100 CHECK (data_quality_score >= 0 AND data_quality_score <= 100),
    confidence_level NUMERIC(5,2) DEFAULT 100 CHECK (confidence_level >= 0 AND confidence_level <= 100),
    last_validation_at TIMESTAMP WITH TIME ZONE,

    -- Alerting configuration
    alert_enabled BOOLEAN DEFAULT FALSE,
    alert_conditions JSONB DEFAULT '{}',
    notification_channels VARCHAR(50)[] DEFAULT ARRAY['EMAIL']::VARCHAR(50)[],
    escalation_policy VARCHAR(100),

    -- Visualization settings
    chart_type VARCHAR(50) CHECK (
        chart_type IN ('LINE', 'BAR', 'AREA', 'PIE', 'GAUGE', 'SCATTER', 'HEATMAP', 'TABLE')
    ),
    display_format VARCHAR(50),
    sort_order INTEGER DEFAULT 0,
    is_visible_in_dashboard BOOLEAN DEFAULT TRUE,

    -- Dependencies and relationships
    parent_kpi_id UUID,
    related_kpis UUID[] DEFAULT '{}',
    calculated_from_kpis UUID[] DEFAULT '{}',

    -- Version management
    version_number INTEGER DEFAULT 1 CHECK (version_number >= 1),
    is_current_version BOOLEAN DEFAULT TRUE,
    previous_version_id UUID,
    change_reason TEXT,

    -- Access control
    visibility_level VARCHAR(20) DEFAULT 'PUBLIC' CHECK (
        visibility_level IN ('PUBLIC', 'INTERNAL', 'RESTRICTED', 'CONFIDENTIAL')
    ),
    allowed_roles VARCHAR(100)[] DEFAULT '{}',

    -- Audit and metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID NOT NULL,
    updated_by UUID DEFAULT uuid_nil(),
    last_calculated_at TIMESTAMP WITH TIME ZONE,

    -- Foreign key constraint
    CONSTRAINT fk_kpi_metrics_parent FOREIGN KEY (parent_kpi_id)
        REFERENCES socialcandor_schema.kpi_metrics(kpi_id) ON DELETE SET NULL,

    -- Constraints
    CONSTRAINT uk_kpi_version UNIQUE (kpi_code, version_number),
    CONSTRAINT chk_targets CHECK (
        (warning_threshold IS NULL OR critical_threshold IS NULL) OR
        (warning_threshold <= critical_threshold)
    ),
    CONSTRAINT chk_dates CHECK (applicable_to IS NULL OR applicable_to > applicable_from)
);

COMMENT ON TABLE socialcandor_schema.kpi_metrics IS 'Centralized storage of calculated business metrics with dimensional attributes for consistent reporting';
COMMENT ON COLUMN socialcandor_schema.kpi_metrics.confidence_level IS 'Statistical confidence in the accuracy of the KPI calculation';

-- Indexes for kpi_metrics
CREATE INDEX IF NOT EXISTS idx_kpi_metrics_code ON socialcandor_schema.kpi_metrics(kpi_code);
CREATE INDEX IF NOT EXISTS idx_kpi_metrics_domain ON socialcandor_schema.kpi_metrics(business_domain);
CREATE INDEX IF NOT EXISTS idx_kpi_metrics_status ON socialcandor_schema.kpi_metrics(performance_status);
CREATE INDEX IF NOT EXISTS idx_kpi_metrics_current ON socialcandor_schema.kpi_metrics(is_current_version) WHERE is_current_version = TRUE;
CREATE INDEX IF NOT EXISTS idx_kpi_metrics_parent ON socialcandor_schema.kpi_metrics(parent_kpi_id) WHERE parent_kpi_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_kpi_metrics_visibility ON socialcandor_schema.kpi_metrics(visibility_level);

-- Materialized view for KPI performance dashboard
CREATE MATERIALIZED VIEW IF NOT EXISTS socialcandor_schema.mv_kpi_performance_dashboard AS
SELECT
    business_domain,
    kpi_name,
    kpi_code,
    current_value,
    target_value,
    performance_status,
    status_color,
    trend_direction,
    ROUND(
        CASE
            WHEN target_value IS NOT NULL AND target_value != 0
            THEN (current_value - target_value) / target_value * 100
            ELSE 0
        END, 2
    ) AS vs_target_percentage,
    last_calculated_at,
    data_quality_score
FROM socialcandor_schema.kpi_metrics
WHERE is_current_version = TRUE
AND is_visible_in_dashboard = TRUE
AND visibility_level IN ('PUBLIC', 'INTERNAL')
WITH DATA;

CREATE UNIQUE INDEX idx_mv_kpi_performance_dashboard_key
ON socialcandor_schema.mv_kpi_performance_dashboard(kpi_code);

-- Trigger for KPI version management
CREATE OR REPLACE FUNCTION socialcandor_schema.manage_kpi_version()
RETURNS TRIGGER AS $$
BEGIN
    -- When updating a KPI, create a new version and mark old as not current
    IF TG_OP = 'UPDATE' AND NEW.version_number = OLD.version_number THEN
        -- Mark old version as not current
        UPDATE socialcandor_schema.kpi_metrics
        SET is_current_version = FALSE,
            updated_at = CURRENT_TIMESTAMP
        WHERE kpi_id = OLD.kpi_id;

        -- Create new version
        NEW.kpi_id := uuid_generate_v4();
        NEW.version_number := OLD.version_number + 1;
        NEW.previous_version_id := OLD.kpi_id;
        NEW.is_current_version := TRUE;
        NEW.created_at := CURRENT_TIMESTAMP;
        NEW.created_by := NEW.updated_by;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_kpi_metrics_version
    BEFORE UPDATE ON socialcandor_schema.kpi_metrics
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.manage_kpi_version();

-- Trigger for updated_at
CREATE TRIGGER trg_kpi_metrics_updated_at
    BEFORE UPDATE ON socialcandor_schema.kpi_metrics
    FOR EACH ROW
    EXECUTE FUNCTION socialcandor_schema.update_updated_at_column();


